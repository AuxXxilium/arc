/* Copyright (c) 2025 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.AdminCenter.Module",{constructor:Ext.emptyFn,activate:Ext.emptyFn,deactivate:function(){return!0},focus:Ext.emptyFn,confirmCallback:function(e){},confirmLostChangeSave:function(){},confirmLostChangeDontSave:function(){},confirmLostChangeCancel:function(){},getVuePanel:function(){},getPanel:function(){return null},getAbsoluteURL:function(e){return String.format("{0}/{1}",this.jsConfig.jsBaseURL,e)},getHelpParam:Ext.emptyFn,getHelpTopic:Ext.emptyFn}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.NFSRuleDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.module=e.module,this.blKerberosEnabled=e.blKerberosEnabled,this.blKerberosSupport=e.blKerberosSupport,this.blShareReadOnly=Ext.isDefined(e.owner.share.get("force_readonly_reason"))&&""!==e.owner.share.get("force_readonly_reason"),this.record=e.record?e.record:null,this.menu=this.createMenu(),this.panel=this.createPanel();var t=this.fillConfig(e);this.callParent([t]),this.record?this.initEditRule():this.initAddRule(),this.addTip()},fillConfig:function(e){var t={width:550,height:400,minWidth:550,minHeight:400,title:"",layout:"fit",items:[this.panel],buttons:[{text:_T("common","cancel"),scope:this,handler:this.close},{text:_T("common","save"),scope:this,btnStyle:"blue",handler:this.applyHandler}]};return Ext.apply(t,e),t},createMenu:function(){var e={fieldLabel:_T("nfs","nfs_security"),indent:0,hidden:!this.blKerberosSupport,allowBlank:!1,editable:!1,items:[{xtype:"menucheckitem",itemId:"nfs_auth_sys",text:"AUTH_SYS",hideOnClick:!1},"-",{xtype:"menucheckitem",itemId:"nfs_krb5",text:_T("nfs","nfs_kerberos_authentication"),hideOnClick:!1},{xtype:"menucheckitem",itemId:"nfs_krb5i",text:_T("nfs","nfs_kerberos_integrity"),hideOnClick:!1},{xtype:"menucheckitem",itemId:"nfs_krb5p",text:_T("nfs","nfs_kerberos_privacy"),hideOnClick:!1}]};return new SYNO.SDS.AdminCenter.Share.NFSRuleDialog.CheckItemsMenu(e)},createPanel:function(){var e=new Ext.data.ArrayStore({autoDestroy:!0,fields:["value","display"],data:[["root",_T("nfs","nfs_mapping_no")],["admin",String.format(_T("nfs","nfs_mapping_yes"),"admin")],["guest",String.format(_T("nfs","nfs_mapping_yes"),"guest")],["all_admin",_T("nfs","nfs_mapping_all")],["all_guest",_T("nfs","nfs_mapping_all_guest")]]}),t={title:_T("nfs","nfs_tab_title"),trackResetOnLoad:!0,padding:0,items:[{xtype:"syno_textfield",name:"client",maxlength:1024,fieldLabel:_T("nfs","nfs_host"),"aria-label":_T("nfs","nfs_host"),allowBlank:!1,blankText:_T("nfs","nfs_error_nohost"),renderer:Ext.util.Format.htmlEncode,validator:this.nfsClientNameValid},{xtype:"syno_combobox",name:"privilege",disabled:this.blShareReadOnly,fieldLabel:_T("nfs","nfs_privilege"),store:[["ro",_T("nfs","nfs_read_only")],["rw",this.blShareReadOnly?_T("nfs","nfs_read_only"):_T("nfs","nfs_read_write")]]},{xtype:"syno_combobox",name:"root_squash",fieldLabel:_T("nfs","nfs_mapping"),tpl:'<tpl for="."><div ext:qtip="{display}" aria-label="{display}" role="option" class="x-combo-list-item">{display}</div></tpl>',displayField:"display",valueField:"value",store:e},this.menu]};return"yes"!==_D("support_hyper_converged")?(t.items.push({xtype:"syno_checkbox",name:"async",boxLabel:_T("nfs","nfs_async_enable")}),t.items.push({xtype:"syno_checkbox",name:"insecure",boxLabel:_T("nfs","nfs_insecure_port_desc")}),t.items.push({xtype:"syno_checkbox",name:"crossmnt",boxLabel:_T("nfs","nfs_crossmnt_desc")})):t.items.push({xtype:"syno_checkbox",name:"insecure",boxLabel:_T("nfs","nfs_insecure_port_desc")}),t.items.push({xtype:"syno_displayfield",name:"faq",htmlEncode:!1,indent:0,style:{marginTop:"18px"},value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("nfs","nfs_refer_faq")}),SYNO.LayoutConfig.fill(t),new SYNO.SDS.Utils.FormPanel(t)},addTip:function(){SYNO.ux.AddTip(this.panel.getForm().findField("client").getEl(),[_T("nfs","nfs_hint_host"),_T("common","colon"),'<ul style="list-style: disc inside; margin-left: 1em; padding-left: 0;">',String.format("<li>{0}</li>",_T("nfs","nfs_fieldtitle_host")),String.format("<li>{0}{1}{2}</li>",_T("nfs","nfs_fieldtitle_wildcard"),_T("common","colon"),"   *, *.synology.com"),String.format("<li>{0}{1}{2}</li>",_T("nfs","nfs_fieldtitle_netmask"),_T("common","colon"),"    203.74.205.32/255.255.255.0, 203.74.205.32/24"),"</ul>"].join(""))},nfsClientNameValid:function(e){var t=/^\*$/;if(e.match(t))return!0;if(Ext.form.VTypes.loosev4ip(e))return!0;if(Ext.form.VTypes.FQDN(e))return!0;if(Ext.form.VTypes.loosev6ip(e))return!0;if(t=/[\s`=~!#$%&()_+{}|;'",<>?]/,e.match(t))return!1;if(t=/\/$/,e.match(t))return!1;t=/^([^\/]+)\/([^\/]+)$/;var i=e.match(t);if(i&&Ext.form.VTypes.loosev4ip(i[1])){if(Ext.form.VTypes.netmask(i[2]))return!0;if(i[2].match(/^[1-3]?[0-9]$/))if(32>=parseInt(i[2],10))return!0;return _T("common","error_badmask")}return i&&Ext.form.VTypes.loosev6ip(i[1])?!!Ext.form.VTypes.v6prefixLeng(i[2])||_T("common","error_badmask"):(t=/^\d{1,3}(\.\d{1,3}|\.\*){2}\.\*$/,e.match(t)?_T("nfs","nfs_rule_wildcard_misuse_error"):(t=/^\[[^:]*:+[^:]*\]$/,!e.match(t)||_T("nfs","nfs_rule_wildcard_misuse_error")))},initAddRule:function(){this.setTitle(_T("nfs","nfs_new_rule")),this.panel.getForm().setValues({client:"",privilege:"rw",root_squash:"root",async:!0,insecure:!1,crossmnt:!1}),this.menu.setDefaultSec(),this.panel.getForm().clearInvalid()},initEditRule:function(){this.setTitle(_T("nfs","nfs_edit_rule")),this.panel.getForm().setValues(this.record.data),"object"==typeof this.record.get("security_flavor")?this.menu.setSecurityPolicy(this.record):this.menu.setDefaultSec()},isKerberosConfirmShow:function(e){return!(!this.blKerberosSupport||this.blKerberosEnabled||!(e.security_flavor.kerberos||e.security_flavor.kerberos_integrity||e.security_flavor.kerberos_privacy))},applyHandler:function(){var e=this.panel.getForm(),t=e.getValues();if(e.isValid()){if(Ext.isDefined(t.privilege)||(t.privilege=e.findField("privilege").getValue()),t.security_flavor={kerberos:this.menu.getItemValue("nfs_krb5"),kerberos_integrity:this.menu.getItemValue("nfs_krb5i"),kerberos_privacy:this.menu.getItemValue("nfs_krb5p"),sys:this.menu.getItemValue("nfs_auth_sys")},this.record){if(t.client!==this.record.get("client")&&this.isHostExist(t.client))return;var i=this.getFirstSelection();i.set("client",t.client),i.set("privilege",t.privilege),i.set("root_squash",t.root_squash),i.set("async",t.async),i.set("insecure",t.insecure),i.set("crossmnt",t.crossmnt),i.set("security_flavor",t.security_flavor)}else{if(this.isHostExist(t.client))return;this.addRecord(t)}this.isKerberosConfirmShow(t)?this.getMsgBox().confirm(this.title,_T("nfs","nfs_kerberos_disabled_desc"),(function(e){(this.close(),"yes"===e)&&new SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.MainDialog({module:this.module,owner:this.module.appWin}).open()}),this):this.close()}},addRecord:function(e){var t=new(Ext.data.Record.create([{name:"client"},{name:"privilege"},{name:"root_squash"},{name:"async"},{name:"insecure"},{name:"crossmnt"},{name:"security_flavor"}]))(e);this.ownerGrid.store.add(t)},getFirstSelection:function(){return this.ownerGrid.getSelectionModel().getSelected()},isRuleExist:function(e,t){var i=this.ownerGrid.store,s=!1;return i.each((function(i){if(i.get(e)===t)return s=!0,!1}),this),s},isHostExist:function(e){return!!this.isRuleExist("client",e)&&(this.module.appWin.getMsgBox().alert(this.title,_T("nfs","nfs_rule_host_exist")),!0)}}),SYNO.SDS.AdminCenter.Share.NFSRuleDialog.ItemMenu=Ext.extend(SYNO.ux.Menu,{shadow:!1,useARIA:!0,constructor:function(e){SYNO.SDS.AdminCenter.Share.NFSRuleDialog.ItemMenu.superclass.constructor.call(this,e)},onRender:function(e,t){SYNO.SDS.AdminCenter.Share.NFSRuleDialog.ItemMenu.superclass.onRender.call(this,e,t),this.keyNav.destroy(),this.keyNav=null,this.keyNav=new SYNO.ux.ScheduleMenuNav(this)}}),Ext.define("SYNO.SDS.AdminCenter.Share.NFSRuleDialog.CheckItemsMenu",{extend:"Ext.form.TriggerField",overCls:"syno-ux-triggerfield-hover",triggerClass:"syno-ux-triggerfield-trigger",constructor:function(e){var t={cls:"syno-ux-menu",autoDestroy:!0,defaults:{width:190},items:e.items};this.menu=new SYNO.SDS.AdminCenter.Share.NFSRuleDialog.ItemMenu(t),this.menu.mon(this.menu,"hide",this.onHide,this),this.menu.mon(this.menu,"click",this.setSecurityText,this),this.callParent([e]),this.mon(this,"afterrender",(function(){this.setSecurityText(),this.keyNav||(this.keyNav=new Ext.KeyNav(this.el,{down:function(e){this.menu.isVisible()||this.onTriggerClick()},scope:this}))}),this),this.addClass("syno-ux-triggerfield"),this.addManagedComponent(this.menu)},onTriggerClick:function(){this.menu.show(this.el)},onHide:function(){this.setSecurityText(),this.focus()},setDefaultSec:function(){this.menu.getComponent("nfs_auth_sys").setChecked(!0),this.setSecurityText()},onMouseover:function(){this.addClass("syno-ux-triggerfield-hover"),this.trigger.addClass("x-form-trigger-over")},onMouseout:function(){this.removeClass("syno-ux-triggerfield-hover"),this.trigger.removeClass("x-form-trigger-over")},markInvalid:function(e){this.callParent(arguments),this.trigger.addClass("syno-ux-trigger-invalid")},clearInvalid:function(){this.callParent(arguments),this.trigger.removeClass("syno-ux-trigger-invalid")},setSecurityPolicy:function(e){this.setItemValue("nfs_auth_sys",e.get("security_flavor").sys),this.setItemValue("nfs_krb5",e.get("security_flavor").kerberos),this.setItemValue("nfs_krb5i",e.get("security_flavor").kerberos_integrity),this.setItemValue("nfs_krb5p",e.get("security_flavor").kerberos_privacy),this.setSecurityText()},setSecurityText:function(){var e,t=[];!0===this.getItemValue("nfs_auth_sys")&&t.push("sys"),!0===this.getItemValue("nfs_krb5")&&t.push("krb5"),!0===this.getItemValue("nfs_krb5i")&&t.push("krb5i"),!0===this.getItemValue("nfs_krb5p")&&t.push("krb5p"),e=t.join(","),SYNO.SDS.AdminCenter.Share.NFSRuleDialog.CheckItemsMenu.superclass.setValue.call(this,e)},getItemValue:function(e){return this.menu.getComponent(e).checked},setItemValue:function(e,t){this.menu.getComponent(e).setChecked(t)},onRender:function(e,t){this.callParent(arguments),this.label&&this.label.addClass("syno-ux-item-label"),SYNO.ux.Utils.setFormItemIndent(this),SYNO.ux.Utils.setFormFieldWidth(this)},onDestroy:function(){this.keyNav.destroy()}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),SYNO.SDS.AdminCenter.Share.onClickNfsSetting=function(e){var t=Ext.getCmp(e);t.owner.close(),SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",Ext.apply(t.findAppWindow().openConfig||{},{fn:"SYNO.SDS.AdminCenter.FileService.Main",tab:"nfs"}))},Ext.define("SYNO.SDS.AdminCenter.Share.NFSGridPanel",{extend:"SYNO.ux.DDGridPanel",constructor:function(e){this.owner=e.owner,this.module=e.module,this.store=this.createStore(),this.colModel=this.createColModel(e),this.dataModified=0,this.actionGroup=this.createActionGroup(),this.blKerberosEnabled=e.blKerberosEnabled;var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"deactivate",(function(){this.getEl().unmask()}),this)},fillConfig:function(e){var t="";t=!0===this.owner.share.get("is_usb_share")?this.owner.share.get("vol_path"):"yes"===_D("usbstation")?this.owner.share.get("vol_path")+"/@sharebin/"+this.owner.share.get("name"):this.owner.share.get("vol_path")+"/"+this.owner.share.get("name");var i={title:_T("nfs","nfs_privilege_setup"),cls:"without-dirty-red-grid",store:this.store,colModel:this.colModel,autoExpandColumn:"client",viewConfig:{markDirty:!1,ddGroup:"NFSRulesDD"},enableDragDrop:!0,enableColumnMove:!1,enableHdMenu:!1,monitorWindowResize:!0,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{scope:this,selectionchange:this.chgNFSButtonStatus}}),tbar:{defaultType:"syno_button",items:[{xtype:"syno_button",text:_T("common","create"),itemId:"addBtn",scope:this,handler:this.addRule},this.actionGroup.getArray()]},bbar:{style:{paddingTop:"6px",height:"28px",paddingBottom:"0px"},items:[{xtype:"tbtext",itemId:"mntpath",style:{lineHeight:"28px"},text:String.format('{0}{1}<span class="blue-status {3}">{2}</span>',_T("nfs","nfs_mount_path"),_T("common","colon"),t,SYNO.SDS.Utils.SelectableCLS)}]},listeners:{scope:this,activate:this.onActivate,beforedestroy:this.onBeforeDestroy,rowcontextmenu:{scope:this,fn:this.onRowContextMenu},rowdblclick:{scope:this,fn:this.onRowDblClick},afterDrop:{scope:this,fn:this.onAfterDrag}}};return Ext.apply(i,e),i},createStore:function(){return new SYNO.API.JsonStore({api:"SYNO.Core.FileServ.NFS.SharePrivilege",method:"load",version:"1",baseParams:{share_name:this.owner.share.get("name")},appWindow:this.findAppWindow(),root:"rule",idProperty:"client",fields:["client","privilege","root_squash","async","insecure","crossmnt","security_flavor"],autoDestroy:!0,listeners:{scope:this,beforeload:this.onBeforeLoad,load:this.onLoad,exception:this.onException,add:this.onStoreAdd,update:this.onStoreUpdate,remove:this.onStoreRemove}})},createColModel:function(e){var t=Ext.isDefined(e.owner.share.get("force_readonly_reason"))&&""!==e.owner.share.get("force_readonly_reason"),i=function(e){return!0===e?_T("nfs","nfs_nonprivileged_port_allow"):_T("nfs","nfs_nonprivileged_port_deny")};return new Ext.grid.ColumnModel({columns:[{id:"client",header:_T("nfs","nfs_host_position"),dataIndex:"client",width:100,renderer:Ext.util.Format.htmlEncode},{id:"privilege",header:_T("nfs","nfs_access_right"),dataIndex:"privilege",renderer:function(e){return t||"ro"===e?_T("nfs","nfs_read_only"):"rw"===e?_T("nfs","nfs_read_write"):""},align:"center",width:120},{id:"root_squash",header:_T("nfs","nfs_mapping"),dataIndex:"root_squash",renderer:function(e){var t="";switch(e){case"all_admin":t=_T("nfs","nfs_mapping_all");break;case"all_guest":t=_T("nfs","nfs_mapping_all_guest");break;case"root":t=_T("nfs","nfs_mapping_no");break;case"admin":t=String.format(_T("nfs","nfs_mapping_yes"),"admin");break;case"guest":t=String.format(_T("nfs","nfs_mapping_yes"),"guest")}return'<div ext:qtip="'+t+'">'+t+"</div>"},align:"center",width:120},{id:"async",header:_T("nfs","nfs_async"),dataIndex:"async",renderer:function(e){return!0===e?_T("common","yes"):_T("common","no")},align:"center",width:100},{name:"insecure",header:_T("nfs","nfs_insecure_port"),dataIndex:"insecure",renderer:i,align:"center",width:100},{name:"crossmnt",header:_T("nfs","nfs_crossmnt"),dataIndex:"crossmnt",renderer:i,align:"center",width:100},{name:"security_flavor",header:_T("nfs","nfs_security"),dataIndex:"security_flavor",renderer:function(e){var t=[];return e.sys&&t.push("sys"),e.kerberos&&t.push("krb5"),e.kerberos_integrity&&t.push("krb5i"),e.kerberos_privacy&&t.push("krb5p"),t.join()},hidden:!0,width:150}]})},createActionGroup:function(){var e=new Ext.Action({text:_T("common","alt_edit"),itemId:"editRule",scope:this,handler:this.editRule}),t=new Ext.Action({text:_T("common","delete"),itemId:"delRule",scope:this,handler:this.delRule});return new SYNO.ux.Utils.ActionGroup([e,t])},onActivate:function(){if(!this.blNfsEnabled){this.gotoNfsSettingId||(this.gotoNfsSettingId=Ext.id());var e=_T("share","nfs_not_enabled"),t='<a href="" class="link-font" id="'+this.gotoNfsSettingId+'">'+_T("nfs","nfs_title")+"</a>",i=this.getTopToolbar();this.mask(String.format(e,t),"syno-ux-mask-info"),i.getComponent("addBtn").btnEl.set({tabIndex:-1}),i.getComponent("editRule").btnEl.set({tabIndex:-1}),i.getComponent("delRule").btnEl.set({tabIndex:-1});var s=Ext.get(this.gotoNfsSettingId);Ext.isObject(s)&&s.on("click",this.onClickNfsSetting,this)}},onBeforeDestroy:function(e){var t=Ext.get(this.gotoNfsSettingId);Ext.isObject(t)&&t.un("click",this.onClickNfsSetting,this)},onBeforeLoad:function(e,t){return this.owner.setStatusBusy({text:_T("common","msg_waiting")}),!0},onLoad:function(e,t,i){this.blKerberosSupport&&this.colModel.setHidden(5,!1),t.length>0&&this.getSelectionModel().selectFirstRow(),this.storeDataCached(e),this.owner.clearStatusBusy(),this.chgNFSButtonStatus()},storeDataCached:function(e){var t=0;this.cachedStoreData=[],e.each((function(e){this.cachedStoreData.push(JSON.stringify(e.data)),t++}),this),this.cachedStoreData.size=t},storeDataCompare:function(e){if(this.dataModified=0,this.cachedStoreData.size==e.data.length){var t=0;e.each((function(e){this.cachedStoreData[t++]==JSON.stringify(e.data)||(this.dataModified=1)}),this)}else this.dataModified=1},onException:function(e,t,i,s,n,o){var a=_T("nfs","nfs_fail_load_rules");this.owner.clearStatusBusy(),this.owner.getMsgBox().alert(this.title,a,this.close,this)},onStoreAdd:function(e,t,i){this.storeDataCompare(e)},onStoreUpdate:function(e,t,i){this.storeDataCompare(e)},onStoreRemove:function(e,t,i){this.storeDataCompare(e)},chgNFSButtonStatus:function(){var e=this.getSelectionModel().getSelections().length,t=this.actionGroup;1!=e?t.disable("editRule"):t.enable("editRule"),0>=e?t.disable("delRule"):t.enable("delRule")},addRule:function(){new SYNO.SDS.AdminCenter.Share.NFSRuleDialog({owner:this.owner,module:this.module,ownerGrid:this,blKerberosSupport:this.blKerberosSupport,blKerberosEnabled:this.blKerberosEnabled}).open()},editRule:function(){var e=this.getSelectionModel().getSelected();new SYNO.SDS.AdminCenter.Share.NFSRuleDialog({owner:this.owner,module:this.module,ownerGrid:this,blKerberosSupport:this.blKerberosSupport,blKerberosEnabled:this.blKerberosEnabled,record:e}).open()},delRule:function(){var e=this.getSelectionModel().getSelections();Ext.each(e,(function(e,t,i){this.store.remove(e)}),this),this.chgNFSButtonStatus()},onMoveRow:function(e){var t=this.store,i=this.getSelectionModel().getSelected(),s=t.indexOf(i),n=s+(e?-1:1);n<0||n>t.getCount()-1?this.getView().focusRow(s):(t.remove(i),t.insert(n,i),this.getSelectionModel().selectRecords([i]),this.getView().focusRow(n))},onRowContextMenu:function(e,t,i){var s=new SYNO.ux.Menu({autoDestroy:!0,items:[this.actionGroup.getArray(),{text:_T("common","up"),scope:this,handler:function(){this.onMoveRow(!0)}},{text:_T("common","down"),scope:this,handler:function(){this.onMoveRow(!1)}}]}),n=e.getSelectionModel();n.selectRow(t,n.isSelected(t)),s.showAt(i.getXY()),i.preventDefault()},onRowDblClick:function(e,t,i){var s=e.getStore().getAt(t);this.editRule(s)},onAfterDrag:function(){this.storeDataCompare(this.store)},enumNFSRules:function(){var e=[];return this.store.each((function(t){e.push({client:t.get("client"),privilege:t.get("privilege"),root_squash:t.get("root_squash"),async:t.get("async"),insecure:t.get("insecure"),crossmnt:t.get("crossmnt"),security_flavor:t.get("security_flavor")})}),this),e},hasKerboerosSecurity:function(){var e=!1,t={};return this.store.each((function(i){!0!==(t=i.get("security_flavor")).kerberos&&!0!==t.kerberos_integrity&&!0!==t.kerberos_privacy||(e=!0)}),this),e},onRuleCheck:function(){var e=!0;return this.owner.getIsSnapshotBrowsing()&&this.store.each((function(t){t.get("crossmnt")||(e=!1)}),this),e},applyCrossMnt:function(){this.store.each((function(e){e.set("crossmnt",!0)}))},onClickNfsSetting:function(e){e.preventDefault(),SYNO.SDS.AdminCenter.Share.onClickNfsSetting(this.getId())},getWebAPI:function(){return 0===this.dataModified?[]:[{api:"SYNO.Core.FileServ.NFS.SharePrivilege",method:"save",version:"1",params:{share_name:this.owner.share.get("name"),rule:this.enumNFSRules()}}]}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.MessageComboBox",{extend:"SYNO.ux.ComboBox",listClass:"syno-ux-combobox-list syno-ux-message-combobox-list",constructor:function(e){var t,i;this.displayField=e.displayField||"display",this.descriptionField=e.descriptionField||"description",this.tooltip=e.tooltip||"tooltip",this.tooltip&&(i='ext:qtip="{'+this.tooltip+':htmlEncode}"'),t={tpl:new Ext.XTemplate('<tpl for=".">',"<div "+i+' class="x-combo-list-item" role="option" aria-label="{'+this.displayField+':htmlEncode}" id="{[Ext.id()]}" style="height: 52px">',"<div "+i+' class="sds-combo-list-item-name">{'+this.displayField+":htmlEncode}</div>","<div "+i+' class="sds-combo-list-item-description">{'+this.descriptionField+":htmlEncode}</div>","</div>","</tpl>")},this.callParent([Ext.apply(t,e)])}}),Ext.reg("syno_share_combobox",SYNO.SDS.AdminCenter.Share.MessageComboBox),Ext.define("SYNO.SDS.AdminCenter.Share.Dialog",{extend:"SYNO.SDS.ModalWindow",moveShareMsg:_T("share","init_status"),constructor:function(e){this.module=e.module,this.owner=e.owner,this.share=e.share,this.mode=e.mode,this.supportBtrfs="yes"===_D("support_btrfs","no")&&!this.isHCM(),this.supportShareQuota="yes"===_D("support_share_quota","no"),this.share&&this.share.get("is_cluster_share")&&(this.supportBtrfs=!1,this.supportShareQuota=!1),this.snapshot=e.snapshot,this.blKeyManagerEnabled=e.blKeyManagerEnabled,this.rgQuotaUnit=[["TB","TB"],["GB","GB"],["MB","MB"]],this.defineGrid();var t=this.fillTabPanelConfig(e);this.callParent([t]),this.panel=this.getComponent("tab"),this.shareTab=this.panel.getComponent("shareForm"),this.encryptTab=this.panel.getComponent("encryptForm"),this.wormTab=this.panel.getComponent("wormForm"),this.advancedTab=this.panel.getComponent("advancedForm"),this.gridPanel=this.panel.getComponent("sharegrid"),this.formPanel=this.panel.getComponent("advperm"),this.encryptTabEl=this.panel.getTabEl("encryptForm"),this.wormTabEl=this.panel.getTabEl("wormForm"),this.shareForm=this.shareTab.getForm(),this.encryptForm=this.encryptTab.getForm(),this.wormForm=this.wormTab.getForm(),this.advancedForm=this.advancedTab.getForm(),this.hideUnreadableTooltip=SYNO.ux.AddTip(this.shareForm.findField("hide_unreadable").getEl(),_T("share","tip_hide_nonprivileged_folder")),this.supportBtrfs&&(this.dataIntegrityTooltip=SYNO.ux.AddTip(this.advancedTab.getForm().findField("enable_share_cow").getEl(),_T("share","share_integrity_protection_tip"))),this.share&&"homes"===this.share.get("name").toLowerCase()&&SYNO.ux.AddTip(this.shareForm.findField("enable_recycle_bin").getEl(),_T("share","enable_homes_recycle_tip")),this.isWormSupported()&&(SYNO.ux.AddTip(this.wormForm.findField("share_worm_def_lock_duration_unit").getEl(),_T("share","share_worm_def_lock_duration_tooltip")),SYNO.ux.AddTip(this.wormForm.findField("share_worm_def_lock_mode_combobox").getEl(),this.getDefLockModeTooltip())),this.setupTabs(),this.loadData(),"yes"===_D("supportNFS","no")&&_S("is_admin")&&(this.nfsPanel=this.panel.getComponent("nfsgrid"),this.nfsPanel&&this.nfsPanel.getStore()&&this.nfsPanel.getStore().load()),this.mon(this,"afterlayout",(function(e,t){this.blKeyManagerEnabled?(this.enableGroupDummy1=new SYNO.ux.Utils.EnableCheckGroup(this.encryptForm,"encryption",["enc_passwd","enc_passwd2","add_to_keymanager"],[]),this.ckg_keymanager=new SYNO.ux.Utils.EnableCheckGroup(this.encryptForm,"add_to_keymanager",["keymanager_cypher","keymanager_passphrase"],[])):this.enableGroupDummy1=new SYNO.ux.Utils.EnableCheckGroup(this.encryptForm,"encryption",["enc_passwd","enc_passwd2","add_to_keymanager"],[]),this.enableGroupDummy2=new SYNO.ux.Utils.EnableCheckGroup(this.shareForm,"enable_recycle_bin",["recycle_bin_admin_only"],[],{disable_group:!0}),this.wormAutoLockGroup=new SYNO.ux.Utils.EnableCheckGroup(this.wormForm,"share_worm_enable_auto_lock",["share_worm_lock_wait_time","share_worm_lock_wait_time_radio","share_worm_lock_wait_time_number","share_worm_lock_wait_time_unit","share_worm_def_lock_duration","share_worm_def_lock_duration_radio","share_worm_def_lock_duration_number","share_worm_def_lock_duration_unit","share_worm_def_lock_mode","share_worm_def_lock_mode_combobox","share_worm_note"],[]),new SYNO.ux.Utils.EnableRadioGroup(this.wormForm,"share_worm_lock_wait_time_radio",{period:["share_worm_lock_wait_time_number","share_worm_lock_wait_time_unit"],immediately:[]}),new SYNO.ux.Utils.EnableRadioGroup(this.wormForm,"share_worm_def_lock_duration_radio",{period:["share_worm_def_lock_duration_number","share_worm_def_lock_duration_unit"],forever:[]}),this.startTabId&&this.panel.setActiveTab(this.startTabId)}),this,{single:!0}),this.mon(this,"deactivate",this.deactivate,this),this.mon(this.shareForm.findField("vol_path"),"collapse",this.onLocationChange,this)},fillTabPanelConfig:function(e){var t=this.fillShareFormConfig(e),i=this.fillEncryptFormConfig(e),s=this.fillWormFormConfig(e),n=this.fillAdvancedFormConfig(e),o="";"clone"===this.mode?(o=_T("share","share_clone"),o=String.format(o,this.share.get("name"))):"create"===this.mode?o=_T("share","share_add"):(o=_T("share","share_edit_title"),o=String.format(o,this.share.get("name")));var a=[t,i,s,n];if("edit"===this.mode){var r=this.share.get("encryption"),l=!this.share.get("is_aclmode")&&"homes"===this.share.get("name").toLowerCase();a.push(new SYNO.SDS.Share.PermissionGrid({module:this.module,owner:this,itemId:"sharegrid",disabled:(1===r||this.isClusterShareDisable())&&!0===this.share.get("is_aclmode"),hidden:1===r&&!0===this.share.get("is_aclmode"),hideCustomColumn:!SYNO.SDS.ControlPanel.Share.isCustomizable(this.share.data)})),a.push(new SYNO.SDS.Share.AdvanceForm({module:this.module,owner:this,disabled:(1===r||this.isClusterShareDisable())&&!0===this.share.get("is_aclmode")||l,itemId:"advperm"})),"yes"===_D("supportNFS","no")&&_S("is_admin")&&a.push(new SYNO.SDS.AdminCenter.Share.NFSGridPanel({module:this.module,owner:this,itemId:"nfsgrid",disabled:this.isNfsGridDisabled(e,r),blNfsEnabled:e.blNfsEnabled,blKerberosSupport:e.blKerberosSupport,blKerberosEnabled:e.blKerberosEnabled}))}var d=new SYNO.SDS.Utils.TabPanel({itemId:"tab",activeTab:0,deferredRender:!1,useDefaultBtn:!1,items:a}),c={title:o,width:860,height:590,layout:"fit",buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","save"),btnStyle:"blue",scope:this,handler:this.onApply}],closeAction:"onCancel",items:d};return Ext.apply(c,e),c},onApply:function(){"edit"===this.mode?this.editHandler():this.createHandler()},defineGrid:function(){SYNO.SDS.Share.PermissionGrid||Ext.define("SYNO.SDS.Share.PermissionGrid",{extend:"SYNO.SDS.Share.ShareGrid",constructor:function(e){var t=e.hideCustomColumn;_S("is_admin")||(t=!0),this.colCu=new SYNO.SDS.Share.CustomColumn({module:e.module,owner:e.owner,ownerGrid:this,dataIndex:"is_custom",id:"is_custom",hidden:t,applyCallback:function(){this.store.load()},applyTarget:this}),e.colCu=this.colCu,e.isShowPreview=!0,this.callParent([e])}})},isNfsGridDisabled:function(e,t){return this.isDisableNFS()||_S("demo_mode")||1===t||2===t&&0===e.blNfsEncryptShareSupport||this.share.get("is_usb_share")&&this.share.get("is_exfat_share")},getEncWarnMsgList:function(){var e=[_T("share","share_encryption_warning_desc"),'<table border="0" cellpadding="0" cellspacing="3" role="presentation">','<tr><td valign="top">1.</td><td class="red-status">',_T("share","share_encryption_warning_savekey"),"</td></tr>",'<tr><td valign="top">2.</td><td>',_T("share","share_encryption_warning_perf"),"</td></tr>",'<tr><td valign="top">3.</td><td>',_T("share","share_encryption_warning_length"),"</td></tr>","</table>","<br>",_T("common","ask_cont")];return"yes"===_D("supportNFS","no")&&_S("is_admin")&&(e=[_T("share","share_encryption_warning_desc"),'<table border="0" cellpadding="0" cellspacing="3" role="presentation">','<tr><td valign="top">1.</td><td class="red-status">',_T("share","share_encryption_warning_savekey"),"</td></tr>",'<tr><td valign="top">2.</td><td>',_T("share","share_encryption_warning_perf"),"</td></tr>",'<tr><td valign="top">3.</td><td>',_T("share","share_encryption_warning_length"),"</td></tr>","</table>","<br>",_T("common","ask_cont")]),e},confirm_encryption:function(e,t){this.getMsgBox().confirm("",_T("share","share_encryption_key_download"),(function(i,s,n){"yes"===i&&t.call(this,e)}),this,{yes:{text:_T("common","ok"),btnStyle:"blue"}});var i=this.getMsgBox().getDialog();i.setWidth(600),i.setPosition([this.getPosition()[0]+(this.getWidth()-i.getWidth())/2,this.getPosition()[1]+(this.getHeight()-i.getHeight())/2-20])},getWormParam:function(){let e={},t=this.wormForm.findField("share_worm_mode_combobox"),i=this.wormForm.findField("share_worm_enable_auto_lock"),s=this.wormForm.findField("share_worm_lock_wait_time_radio"),n=this.wormForm.findField("share_worm_lock_wait_time_number"),o=this.wormForm.findField("share_worm_lock_wait_time_unit"),a=this.wormForm.findField("share_worm_def_lock_duration_radio"),r=this.wormForm.findField("share_worm_def_lock_duration_number"),l=this.wormForm.findField("share_worm_def_lock_duration_unit"),d=this.wormForm.findField("share_worm_def_lock_mode_combobox");return e.subvol_mode=t.isDirty()||"create"===this.mode?t.getValue():"no_change",e.def_lock_mode=i.getValue()?d.getValue():"manual","period"===s.getGroupValue()?("hours"===o.getValue()&&(e.lock_wait_time=3600*n.getValue()),"days"===o.getValue()&&(e.lock_wait_time=86400*n.getValue())):e.lock_wait_time=0,"period"===a.getGroupValue()?("days"===l.getValue()&&(e.def_lock_duration=86400*r.getValue()),"years"===l.getValue()&&(e.def_lock_duration=31536e3*r.getValue())):e.def_lock_duration=315328464e3,e},createHandler:function(){var e,t=this,i=this.shareForm.findField("name").getValue(),s=this.getFsType("vol_path"),n=this.encryptForm.findField("add_to_keymanager").getValue(),o=this.encryptForm.findField("keymanager_passphrase").getValue(),a=this.wormForm.findField("share_worm_mode_combobox").getValue(),r={};if(!this.shareForm.isValid())return this.panel.setActiveTab("shareForm"),void this.setStatusError({text:_T("error","error_bad_field"),clear:!0});if(this.isShowBtrfsOption()&&!this.advancedForm.isValid())return this.panel.setActiveTab("advancedForm"),void this.setStatusError({text:_T("error","error_bad_field"),clear:!0});if("yes"!==_D("usbstation","no")||"web"!==i.toLowerCase()||"ext4"===s)switch(e="create"===this.mode&&this.dataProtectionForm?this.dataProtectionForm.findField("share_data_protection_radio").getGroupValue():this.isWormShare()?"worm":"skip",r.name=i,r.shareinfo=this.getParamShareForm(),r.shareinfo.name_org=this.shareForm.findField("name_org").getValue(),e){case"encryption":n?(this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Store",method:"verify",params:{passphrase:o},encryption:["passphrase"],version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),e)this.confirm_encryption(r,this.submitCreateShareInfo);else{var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("keymanager","error_invalid_passphrase");this.getMsgBox().alert("",n)}}})):this.confirm_encryption(r,this.submitCreateShareInfo);break;case"worm":"create"===this.mode?(r.shareinfo.worm=this.getWormParam(),"compliance"===a?new SYNO.SDS.AdminCenter.Share.ConfirmDialog({owner:this,confirm_message:_T("share","share_worm_compliance_confirm_msg"),checkbox_message:_T("share","share_worm_compliance_checkbox_msg"),callback:function(e){"continue"===e&&t.submitCreateShareInfo(r)}}).open():this.submitCreateShareInfo(r)):"clone"!==this.mode||this.wormTab.isVisible()?this.submitCreateShareInfo(r):this.getMsgBox().alert("",_T("share","share_worm_clone_alert_msg"),(function(){this.submitCreateShareInfo(r)}),this);break;default:this.submitCreateShareInfo(r)}else this.getMsgBox().alert("",String.format(_T("service","no_ext4_external_devices"),i))},getParamShareForm:function(){var e={},t=this.advancedForm,i=this.wormForm;return Ext.each(["name","vol_path","desc"],(function(t,i,s){e[t]=this.shareForm.findField(t).getValue()}),this),Ext.each(["hidden","enable_recycle_bin","recycle_bin_admin_only","hide_unreadable"],(function(t,i,s){this.shareForm.findField(t).isDirty()&&(e[t]=this.shareForm.findField(t).getValue())}),this),Ext.each(["encryption","enc_passwd"],(function(t,i,s){this.encryptForm.findField(t).isDirty()&&(e[t]=this.encryptForm.findField(t).getValue())}),this),this.isShowBtrfsOption()&&(this.isBtrfsShare("vol_path")&&(e.enable_share_cow=t.findField("enable_share_cow").getValue(),e.enable_share_compress=t.findField("enable_share_compress").getValue()),this.supportShareQuota&&(t.findField("enable_share_quota").isDirty()||t.findField("quota_unit").isDirty()||t.findField("quota_value").isDirty())&&(t.findField("enable_share_quota").getValue()?e.share_quota=this.getQuotaInMB():e.share_quota="0")),i&&i.isDirty()&&"edit"===this.mode&&(e.worm=this.getWormParam()),e},submitCreateShareInfo:function(e){"clone"===this.mode&&this.snapshot&&(e.snapshot=this.snapshot),this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share",method:this.mode,params:e,encryption:["shareinfo"],version:1,scope:this,callback:function(t,i,s){this.clearStatusBusy();var n="";if(!t){var o=SYNO.API.Response.GetFirstError(i);if(n=SYNO.API.Errors.core[o.code]||_T("common","error_system"),3309===o.code)n=String.format(n,_D("maxshares"));else if(3343===o.code&&o.errors&&o.errors.hard){var a="clone"===this.mode?o.errors.hard[e.shareinfo.name_org]:o.errors.hard[e.name];n=_T("volume","hard_check_fail"),n+="<br><b>"+SYNO.SDS.Utils.GetFeasibilityCheckMsgJoin(a)+"</b>"}return this.getMsgBox().alert("",n),!1}if(e.shareinfo.name=i.name,e.shareinfo.encryption&&this.exportEncryptionKey(e.name,e.shareinfo.enc_passwd),!this.encryptForm.findField("add_to_keymanager").getValue())return this.updateAndNotify(e),!0;this.initKeyManagerRequest(),this.addKeyToKeyManager(this.updateAndNotify,e)}})},addKeyToKeyManager:function(e,t){var i=this.KeyManager.name,s=this.KeyManager.password,n=this.KeyManager.cypher,o=this.KeyManager.passphrase;this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Key",method:"add",params:{share_name:i,share_cypher:n,share_password:s,passphrase:o},encryption:["share_password","passphrase"],version:1,scope:this,callback:function(i,s,n){if(this.clearStatusBusy(),!i){var o=SYNO.API.Response.GetFirstError(s),a=SYNO.API.Errors.core[o.code]||_T("common","error_system");return this.getMsgBox().alert("",a),!1}e.call(this,t)}})},updateAndNotify:function(e){this.module.getPanel().fireEvent("sharefolderchanged",e.shareinfo.name),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission"),this.newShareInfo=Ext.apply({is_aclmode:!0,encryption:!0===e.shareinfo.encryption?2:0},e.shareinfo),"create"===this.mode?this.loadPermissionData(this.getCreateResult()):this.close()},getCreateResult:function(){return Ext.isObject(this.newShareInfo)?new Ext.data.Record(this.newShareInfo):null},onCancel:function(){this.isAnyFormDirty()?this.confirmLostChangePromise({dontSave:function(){this.close()},cancel:function(){return!1},save:this.onApply},this):this.close()},fillShareFormConfig:function(e){var t=new Ext.data.JsonStore({idProperty:"value",fields:["value","display","size_total_mb","vol_name","desc","tooltip","volume_quota_status"],data:[[0,0]]}),i={title:_T("share","share_subject"),itemId:"shareForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:350,trackResetOnLoad:!0,items:[{validationEvent:"keyup",xtype:"syno_textfield",name:"name",maxlength:32,fieldLabel:_T("share","share_name")+' <font class="red-status">'+_T("common","star")+"</font>",labelHtmlEncode:!1,allowBlank:!1,blankText:_T("share","error_noname"),width:350,vtype:"sharename"},{xtype:"hidden",name:"name_org"},{xtype:"syno_textfield",name:"desc",maxlength:64,width:350,fieldLabel:_T("share","share_comment")},{xtype:"syno_share_combobox",name:"vol_path",fieldLabel:_T("volume","volume_share_position"),store:t,displayField:"display",descriptionField:"desc",tooltip:"tooltip",valueField:"value",disabled:"clone"===this.mode,allowBlank:!1,width:350},{xtype:"hidden",name:"vol_orig"},{xtype:"syno_displayfield",name:"my_vol_status",fieldLabel:_T("volume","volume_share_position")},{xtype:"syno_checkbox",name:"hidden",boxLabel:_T("share","share_hide")},{xtype:"syno_checkbox",name:"hide_unreadable",boxLabel:_T("share","share_hide_unreadable"),hideLabel:!0},{xtype:"syno_checkbox",name:"enable_recycle_bin",hidden:!_S("is_admin"),boxLabel:_T("share","share_enable_recycle_bin"),hideLabel:!0},{xtype:"syno_checkbox",name:"recycle_bin_admin_only",hidden:!_S("is_admin"),boxLabel:_T("network","cifs_safe_recycle_bin"),width:500,indent:1},{xtype:"syno_button",indent:1,width:"auto",id:this.cleanBinBtnId=Ext.id(),text:_T("share","share_clean_recycle_bin"),scope:this,handler:this.onCleanBinBtnClick,hidden:"edit"!==this.mode||!_S("is_admin")},{xtype:"syno_displayfield",indent:1,tabIndex:-1,htmlEncode:!1,hidden:!_S("is_admin"),value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+' </span><a id="'+Ext.id()+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">'+_T("network","cifs_recycle_bin_help_link")+"</a>",listeners:{afterrender:SYNO.SDS.AdminCenter.Share.Utils.ShowHelpCallback(SYNO.SDS.AdminCenter.TaskScheduler.Main.prototype.getHelpParam()),scope:this}},{xtype:"syno_displayfield",tabIndex:-1,htmlEncode:!1,value:['<font class="red-status">'+_T("common","star")+"</font> "+_T("firewall","firewall_field_blank_alert")]}]};return Ext.apply(i,e),new SYNO.SDS.Utils.FormPanel(i)},fillDataProtectionFormConfig:function(e){var t={title:_T("share","share_data_protection_tab_title"),itemId:"dataProtectionForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:350,trackResetOnLoad:!0,items:[{xtype:"syno_radio",name:"share_data_protection_radio",inputValue:"skip",boxLabel:_T("common","skip"),checked:!0},{xtype:"syno_radio",name:"share_data_protection_radio",inputValue:"encryption",boxLabel:_T("share","share_data_protection_encryption")},{xtype:"syno_displayfield",name:"share_data_protection_encryption_desc",value:_T("share","share_data_protection_encryption_desc"),indent:1,htmlEncode:!1},{xtype:"syno_radio",name:"share_data_protection_radio",inputValue:"worm",boxLabel:_T("share","share_data_protection_worm"),hidden:!this.isWormSupported()},{xtype:"syno_displayfield",name:"share_data_protection_worm_desc",value:_T("share","share_data_protection_worm_desc"),indent:1,htmlEncode:!1,hidden:!this.isWormSupported()}]};return Ext.apply(t,e),new SYNO.SDS.Utils.FormPanel(t)},isHCM:function(){return"yes"===_D("support_hyper_converged","no")},isEncrytSupported:function(){return _S("is_admin")&&"yes"===_D("support_share_encryption","no")},addCompressionTooltip:function(e){if(this.supportBtrfs){let t=this.advancedForm.findField("enable_share_compress").getEl();this.compressionTooltip&&this.compressionTooltip.remove(),e?this.compressionTooltip=SYNO.ux.AddTip(t,_T("share","share_compress_disabled_when_enc_is_on_tooltip")):"yes"===_D("support_online_compr_switch","no")?this.compressionTooltip=SYNO.ux.AddTip(t,_T("share","share_compress_tip")):this.compressionTooltip=SYNO.ux.AddTip(t,_T("share","enable_share_compress_help"))}},fillEncryptFormConfig:function(e){var t=[{xtype:"syno_checkbox",name:"encryption",boxLabel:_T("share","share_encryption_enable"),hidden:"create"===this.mode,listeners:{scope:this,check:function(e,t){if(this.supportBtrfs){var i=this.advancedForm.findField("enable_share_cow"),s=this.advancedForm.findField("enable_share_compress");t?"create"!==this.mode&&s.getValue()?this.getMsgBox().confirm("",_T("share","share_compress_to_encrypt_confirm"),(function(t){"yes"===t?(s.setValue(!1),s.disable(),this.addCompressionTooltip(!0)):e.setValue(!1)}),this,{no:{text:_T("common","no")},yes:{text:_T("common","yes"),btnStyle:"blue"}}):(s.setValue(!1),s.disable(),this.addCompressionTooltip(!0)):(i.getValue()&&s.enable(),this.addCompressionTooltip(!1))}}}},{xtype:"syno_textfield",textType:"password",name:"enc_passwd",minLength:8,maxLength:64,width:180,allowBlank:!1,fieldLabel:_T("share","share_encryption_key"),validator:function(e){return-1===e.indexOf("=")&&-1===e.indexOf(",")&&-1===e.indexOf(":")||_T("share","encryption_password_invalid")},disabled:"create"!==this.mode,indent:"create"===this.mode?0:1},{xtype:"syno_textfield",textType:"password_confirm",name:"enc_passwd2",confirmFor:"enc_passwd",confirmFailedText:_T("share","share_encryption_key_confirm_mismatch"),maxlength:64,width:180,allowBlank:!1,fieldLabel:_T("share","share_encryption_key_confirm"),disabled:"create"!==this.mode,indent:"create"===this.mode?0:1},{xtype:"syno_displayfield",name:"no_encryption_reason",hidden:!0,htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+' </span><a id="'+Ext.id()+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">'+String.format(_T("share","no_encryption_reason"),_T("common","here"))+"</a>",listeners:{afterrender:SYNO.SDS.AdminCenter.Share.Utils.ShowHelpCallback("AdminCenter/file_share_create.html"),scope:this}}],i=[{xtype:"syno_checkbox",name:"add_to_keymanager",boxLabel:_T("share","share_encryption_add_to_keymanager"),disabled:"create"!==this.mode,indent:"create"===this.mode?0:1,listeners:{check:function(e,t){t&&!this.blKeyManagerEnabled&&this.getMsgBox().confirm("",_T("keymanager","init_dialog_msg"),(function(t){if("yes"===t){var i=new SYNO.SDS.AdminCenter.Share.InitStore({share_module:this.module.panel,share_dialog:this,module:this.module,owner:this.owner,shares:this.module.panel.store.data.items});i.open(),this.mon(i,"close",(function(){this.blKeyManagerEnabled||e.setValue(!1)}),this)}else e.setValue(!1)}),this,{no:{text:_T("common","no")},yes:{text:_T("keymanager","init_dialog_confirm"),btnStyle:"blue"}})},scope:this}},{xtype:"syno_textfield",name:"keymanager_passphrase",fieldLabel:_T("keymanager","common_passphrase"),textType:"password",minLength:8,maxLength:64,width:180,allowBlank:!1,indent:"create"===this.mode?1:2,disabled:!0,hidden:!0},{xtype:"syno_combobox",name:"keymanager_cypher",fieldLabel:_T("keymanager","common_cypher"),displayField:"display",valueField:"value",store:new Ext.data.ArrayStore({fields:["value","display"],data:[[0,_T("keymanager","common_passphrase")],[1,_T("keymanager","common_machinekey")]]}),value:1,indent:"create"===this.mode?1:2,disabled:!0,hidden:!0}],s=[{xtype:"syno_checkbox",name:"enc_auto_mount",boxLabel:_T("share","share_encryption_autodecrypt"),indent:"create"===this.mode?0:1,disable:!0,hidden:!0}],n=[{xtype:"syno_displayfield",name:"encryption_desc",htmlEncode:!1,indent:"create"===this.mode?0:1,style:{marginTop:"12px"},value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+' </span><br><ul style="list-style-type: disc; list-style-position: inside;"><li>'+_T("share","share_encryption_warning_perf")+"</li><li>"+_T("share","share_encryption_warning_length")+"</li></ul>"}],o={title:_T("share","share_tab_encryption"),itemId:"encryptForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:350,trackResetOnLoad:!0,items:[t,i,s,n],owner:this};return Ext.apply(o,e),new SYNO.SDS.Utils.FormPanel(o)},updateKeyManagerUI:function(){var e=this.encryptForm,t=e.findField("add_to_keymanager"),i=e.findField("keymanager_passphrase"),s=e.findField("keymanager_cypher"),n=e.findField("enc_auto_mount");"edit"===this.mode&&this.share.get("enc_auto_mount")?(t.hide(),i.hide(),i.setValue("2PassValidation"),s.hide(),n.show()):"edit"===this.mode&&0!==this.share.get("encryption")?(t.hide(),i.hide(),i.setValue("2PassValidation"),s.hide(),n.hide()):this.blKeyManagerEnabled?(SYNO.SDS.AdminCenter.Share.LocalStore===this.keyManagerLocation?(t.show(),i.hide(),i.setValue("2PassValidation"),s.hide()):(t.show(),i.show(),i.setValue(""),s.show()),n.hide()):(t.hide(),i.hide(),i.setValue("2PassValidation"),s.hide(),n.hide()),!_S("is_admin")&&SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main")&&t.hide()},isWormSupported:function(){return _S("is_admin")&&"yes"===_D("support_worm","no")},isHaSupportWorm:function(){return _S("ha_support_worm")},getWormModeDesc:function(e){return"enterprise"===e?_T("share","share_worm_mode_desc_enterprise"):"compliance"===e?_T("share","share_worm_mode_desc_compliance"):void 0},isWormAutoLockDisabled:function(){return"manual"===this.share.get("worm_def_lock_mode")},getLockWaitTimeUnit:function(){let e=this.share.get("worm_lock_wait_time");return e<=0?"":e%86400?"hours":"days"},getLockWaitTimeNumber:function(){let e=this.share.get("worm_lock_wait_time");return e<=0?"":e%86400?Math.ceil(e/3600):e/86400},getDefLockDurationUnit:function(){let e=this.share.get("worm_def_lock_duration");return e>31536e5?"":e%31536e3?"days":"years"},getDefLockDurationNumber:function(){let e=this.share.get("worm_def_lock_duration");return e<=0||e>31536e5?"":e%31536e3?Math.ceil(e/86400):e/31536e3},getDefLockModeTooltip:function(){return'<div style="margin-top: 4px; margin-bottom: 6px">'+_T("share","share_worm_def_lock_mode_tooltip_desc")+'</div><ul style="list-style-type: disc; list-style-position: inside; text-indent: -1.4em; padding-left: 1.4em; margin-bottom: 4px"><li style="margin-bottom: 6px"><b>'+_T("share","share_worm_immutable")+"</b><br/>"+_T("share","share_worm_def_lock_mode_tooltip_immutable")+"</li><li><b>"+_T("share","share_worm_appendable")+"</b><br/>"+_T("share","share_worm_def_lock_mode_tooltip_appendable")+"</li></ul>"},validateLockWaitTime:function(){let e,t,i=this.wormForm;return!i||(e=i.findField("share_worm_lock_wait_time_number").getValue(),t=i.findField("share_worm_lock_wait_time_unit").getValue(),e*="hours"===t?3600:86400,e<3600?_T("share","share_worm_lock_wait_time_too_low"):!(e>604800)||_T("share","share_worm_lock_wait_time_too_much"))},validateDefLockDuration:function(){let e,t,i=this.wormForm;return!i||(e=i.findField("share_worm_def_lock_duration_number").getValue(),t=i.findField("share_worm_def_lock_duration_unit").getValue(),e*="days"===t?86400:31536e3,e<86400?_T("share","share_worm_def_lock_duration_too_low"):!(e>31536e5)||_T("share","share_worm_def_lock_duration_too_much"))},getWormNote:function(){return'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+"</span>"+("create"===this.mode?_T("share","share_worm_note2"):'<br><ul style="list-style-type: disc; list-style-position: inside;"><li>'+_T("share","share_worm_note1")+"</li><li>"+_T("share","share_worm_note2")+"</li></ul>")},fillWormFormConfig:function(e){var t=this,i={title:_T("share","share_worm_title"),itemId:"wormForm",trackResetOnLoad:!0,listeners:{afterlayout:function(e){if(e.isVisible())if("create"===t.mode){e.updateFleXcroll();var i=e.getContentTarget().dom.fleXdata.cntSize[1];e.setHeight(i)}else e.setHeight(430),"clone"===t.mode&&e.getEl().mask(_T("share","share_worm_not_support_clone"),"syno-ux-mask-info")},deactivate:function(e){"clone"===t.mode&&e.getEl().unmask()}},items:[{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_displayfield",name:"share_worm_mode",value:_T("share","share_worm_mode")+_T("common","colon"),width:208,maxLength:64},{xtype:"container",layout:"column",hideLabel:!0,width:500,items:[{xtype:"syno_combobox",name:"share_worm_mode_combobox",width:500,valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["enterprise",_T("share","share_worm_mode_enterprise")],["compliance",_T("share","share_worm_mode_compliance")]]}),listeners:{select:function(e,i){t.wormForm.findField("share_worm_mode_desc").setValue(t.getWormModeDesc(i.data.value))}}},{xtype:"syno_displayfield",name:"share_worm_mode_desc",width:500,htmlEncode:!1,style:{color:"rgba(65, 75, 85, 0.6)",fontSize:"12px"}}]}]},{xtype:"syno_checkbox",name:"share_worm_enable_auto_lock",boxLabel:_T("share","share_worm_enable_auto_lock")},{xtype:"syno_displayfield",name:"share_worm_auto_lock_desc",value:_T("share","share_worm_auto_lock_desc"),indent:1,htmlEncode:!1,style:{marginBottom:"6px"}},{xtype:"syno_compositefield",hideLabel:!0,indent:1,items:[{xtype:"syno_displayfield",name:"share_worm_lock_wait_time",value:_T("share","share_worm_lock_wait_time")+_T("common","colon"),width:180,maxLength:64},{xtype:"syno_radio",name:"share_worm_lock_wait_time_radio",inputValue:"period",boxLabel:_T("share","share_worm_period")}]},{xtype:"syno_compositefield",hideLabel:!0,indent:1,items:[{xtype:"syno_displayfield",width:180},{xtype:"syno_numberfield",name:"share_worm_lock_wait_time_number",vtype:"number",indent:1,width:110,maxLength:10,validator:function(){return t.validateLockWaitTime()}},{xtype:"syno_combobox",name:"share_worm_lock_wait_time_unit",indent:1,width:130,valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["hours",_T("common","time_hours")],["days",_T("common","time_days")]]}),listeners:{enable:function(){t.wormForm.findField("share_worm_lock_wait_time_number").validate()},select:function(){t.wormForm.findField("share_worm_lock_wait_time_number").validate()}}}]},{xtype:"syno_compositefield",hideLabel:!0,indent:1,style:{marginBottom:"6px"},items:[{xtype:"syno_displayfield",width:180},{xtype:"syno_radio",name:"share_worm_lock_wait_time_radio",inputValue:"immediately",boxLabel:_T("share","share_worm_lock_wait_time_immediately")}]},{xtype:"syno_compositefield",hideLabel:!0,indent:1,items:[{xtype:"syno_displayfield",name:"share_worm_def_lock_duration",value:_T("share","share_worm_def_lock_duration")+_T("common","colon"),width:180,maxLength:64},{xtype:"syno_radio",name:"share_worm_def_lock_duration_radio",inputValue:"period",boxLabel:_T("share","share_worm_period")}]},{xtype:"syno_compositefield",hideLabel:!0,indent:1,items:[{xtype:"syno_displayfield",width:180},{xtype:"syno_numberfield",vtype:"number",name:"share_worm_def_lock_duration_number",indent:1,width:110,maxLength:10,validator:function(){return t.validateDefLockDuration()}},{xtype:"syno_combobox",name:"share_worm_def_lock_duration_unit",indent:1,width:130,valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["days",_T("common","time_days")],["years",_T("common","time_years")]]}),listeners:{enable:function(){t.wormForm.findField("share_worm_def_lock_duration_number").validate()},select:function(){t.wormForm.findField("share_worm_def_lock_duration_number").validate()}}}]},{xtype:"syno_compositefield",hideLabel:!0,indent:1,style:{marginBottom:"6px"},items:[{xtype:"syno_displayfield",width:180},{xtype:"syno_radio",name:"share_worm_def_lock_duration_radio",inputValue:"forever",boxLabel:_T("share","share_worm_def_lock_duration_forever")}]},{xtype:"syno_compositefield",hideLabel:!0,indent:1,style:{marginBottom:"6px"},items:[{xtype:"syno_displayfield",name:"share_worm_def_lock_mode",value:_T("share","share_worm_def_lock_mode")+_T("common","colon"),width:180,maxLength:64},{xtype:"syno_combobox",name:"share_worm_def_lock_mode_combobox",width:274,valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["immutable",_T("share","share_worm_immutable")],["appendable",_T("share","share_worm_appendable")]]})}]},{xtype:"syno_displayfield",name:"share_worm_note",indent:1,htmlEncode:!1,value:t.getWormNote()}]};return Ext.apply(i,e),new SYNO.SDS.Utils.FormPanel(i)},fillAdvancedFormConfig:function(e){var t=this,i={title:this.isHCM()?_T("share","create_wizard_quota"):_T("share","share_advance_privileges"),itemId:"advancedForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:350,trackResetOnLoad:!0,listeners:{afterlayout:function(e){if(e.isVisible()&&t.isBtrfsShare("vol_path")&&"create"===t.mode){let e=t.dataProtectionForm.findField("share_data_protection_radio").getGroupValue(),i=t.wormForm.findField("share_worm_mode_combobox").getValue(),s=t.advancedForm.findField("enable_share_cow");"worm"===e&&"compliance"===i?(s.disable(),s.setValue(!0),t.dataIntegrityTooltip.remove(),t.dataIntegrityTooltip=SYNO.ux.AddTip(t.advancedTab.getForm().findField("enable_share_cow").getEl(),_T("share","share_compliant_worm_always_enable_cow"))):(s.enable(),t.dataIntegrityTooltip.remove(),t.dataIntegrityTooltip=SYNO.ux.AddTip(t.advancedTab.getForm().findField("enable_share_cow").getEl(),_T("share","share_integrity_protection_tip")))}}},items:[{xtype:"syno_checkbox",name:"enable_snapshot_browsing",hidden:!0},{xtype:"syno_checkbox",name:"enable_share_cow",hidden:!t.supportBtrfs,checked:!1,boxLabel:_T("share","share_integrity_protection_enable"),listeners:{enable:function(){t.restoreValue("enable_share_cow"),t.advancedForm.findField("enable_share_cow_desc").enable()},disable:function(){t.storeValue("enable_share_cow"),t.advancedForm.findField("enable_share_cow_desc").disable()},check:function(e,i){var s=t.shareForm.findField("vol_path").getValue(),n=t.volumeAttrMap[s],o=t.advancedForm,a=t.encryptForm.findField("encryption");i&&"generic"===n&&!a.getValue()?o.findField("enable_share_compress").enable():o.findField("enable_share_compress").disable()}}},{xtype:"syno_displayfield",name:"enable_share_cow_desc",hidden:!t.supportBtrfs,indent:1,value:_T("share","share_integrity_protection_enable_desc")},{xtype:"syno_checkbox",name:"enable_share_compress",hidden:!t.supportBtrfs,indent:1,boxLabel:_T("share","share_compress_enable"),listeners:{scope:t,enable:function(){t.restoreValue("enable_share_compress"),t.advancedForm.findField("enable_share_compr_desc").enable()},disable:function(){t.storeValue("enable_share_compress"),t.advancedForm.findField("enable_share_compr_desc").disable()}}},{xtype:"syno_displayfield",name:"enable_share_compr_desc",hidden:!t.supportBtrfs||"edit"!==t.mode,indent:2,value:_T("share","share_compress_edit_desc")},{xtype:"syno_displayfield",name:"enable_share_compr_desc",hidden:!t.supportShareQuota||!this.isHCM(),value:_T("share","enable_share_quota_desc")},{xtype:"syno_compositefield",hideLabel:!0,hidden:!t.supportShareQuota,items:[{xtype:"syno_checkbox",name:"enable_share_quota",boxLabel:_T("share","share_quota_enable"),listeners:{scope:t,check:{fn:t.onEnableShareQuota},disable:function(){var e=t.advancedForm;t.storeValue("enable_share_quota"),e.findField("quota_unit").disable(),e.findField("quota_value").disable()},enable:function(){var e=t.advancedForm;t.restoreValue("enable_share_quota"),e.findField("enable_share_quota").getValue()&&(e.findField("quota_value").enable(),e.findField("quota_unit").enable())}}},{xtype:"syno_displayfield",htmlEncode:!1,name:"share_quota_used"},{xtype:"syno_displayfield",name:"share_quota_status",hidden:!0}],fieldLabel:_T("share","share_quota_enable")},{xtype:"syno_compositefield",indent:1,hideLabel:!0,hidden:!t.supportShareQuota,items:[{xtype:"syno_numberfield",width:90,disabled:!0,value:0,name:"quota_value",vtype:"number",listeners:{scope:t,disable:function(){t.storeValue("quota_value")},enable:function(){t.restoreValue("quota_value")}},validator:function(e){var i=t.advancedForm,s=t.shareForm.findField("vol_path").getValue(),n=t.shareForm.findField("vol_path").getStore().getById(s).data,o=i.findField("quota_unit").getValue(),a=i.findField("quota_value").getValue();return"GB"===o?a*=1024:"TB"===o&&(a*=1048576),!(n.size_total_mb<=a)||String.format(_T("user","user_quota_limit_max_vol"),n.vol_name,(n.size_total_mb/1024).toFixed(2))}},{xtype:"syno_combobox",name:"quota_unit",width:60,displayField:"display",valueField:"value",disabled:!0,value:t.rgQuotaUnit[1][0],store:new Ext.data.ArrayStore({fields:["value","display"],data:t.rgQuotaUnit})}]},{xtype:"syno_displayfield",name:"share_cow_desc",htmlEncode:!1,indent:1,hidden:!t.supportBtrfs,style:{marginTop:"18px"},value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("share","share_cow_desc1")+'<br/><ul style="list-style-type: disc; list-style-position: inside;"><li>'+_T("share","share_cow_desc2")+"</li><li>"+_T("share","share_cow_desc3")+"</li>"+("create"===t.mode?"<li>"+_T("share","share_cow_desc5")+"</li>":"")+"</ul>"}]};return Ext.apply(i,e),new SYNO.SDS.Utils.FormPanel(i)},isWormShareInfo:function(e){return!!(e&&e.hasOwnProperty("worm_subvol_mode")&&e.hasOwnProperty("worm_def_lock_mode")&&e.hasOwnProperty("worm_lock_wait_time")&&e.hasOwnProperty("worm_def_lock_duration"))&&("compliance"===e.worm_subvol_mode||"enterprise"===e.worm_subvol_mode||"manual"===e.worm_subvol_mode)},isWormShare:function(){return!!this.share&&this.isWormShareInfo(this.share.data)},setupTabs:function(){return"create"===this.mode||(this.share?("clone"===this.mode?(this.panel.hideTabStripItem("encryptForm"),this.isWormSupported()&&this.isWormShare()||this.panel.hideTabStripItem("wormForm")):"edit"===this.mode&&(this.isEncrytSupported()&&!this.isWormShare()||this.panel.hideTabStripItem("encryptForm"),this.isWormSupported()&&this.isWormShare()||this.panel.hideTabStripItem("wormForm")),"yes"===_D("usbstation")&&(this.panel.hideTabStripItem("advancedForm"),this.panel.hideTabStripItem("advperm")),void(this.isShowBtrfsOption()||this.panel.hideTabStripItem("advancedForm"))):(this.setStatusError({text:_T("common","error_system"),clear:!0}),!1))},loadData:function(){var e=[{api:"SYNO.Core.Storage.Volume",method:"list",params:{limit:-1,offset:0,location:""===_D("usbstation")?"internal":"external",option:"include_cold_storage"},version:1}];if(this.setStatusBusy({text:_T("common","msg_waiting")}),"create"!==this.mode){var t=["encryption"];"clone"!==this.mode&&(t=t.concat(["hidden","recyclebin","advance_setting","is_cluster_share","is_cold_storage_share"]),this.supportBtrfs&&(t=t.concat(["enable_snapshot_browsing"])),this.supportShareQuota&&(t=t.concat(["share_quota"]))),this.isWormSupported()&&(t=t.concat(["load_worm_attr"])),t=(t=t.concat(["enable_share_cow","enable_share_compress"])).concat(["is_tiering_bucket"]),e=e.concat([{api:"SYNO.Core.Share",method:"get",params:{name:this.share.get("name"),additional:t},version:1}])}this.sendWebAPI({params:{},compound:{stopwhenerror:!0,params:e},timeout:36e4,scope:this,callback:function(e,t,i){if(!0===t.isTimeout||!0===t.has_fail){this.clearStatusBusy();var s=_T("common","error_system");return t.result[1].error&&(s=SYNO.API.Errors.core[t.result[1].error.code]||_T("common","error_system")),this.getMsgBox().alert("",s,(function(){this.close()}),this),this.setStatusError({text:s,clear:!0}),!1}if(SYNO.ux.Utils.displayFormField(this.shareForm,"my_vol_status",!1),"clone"===this.mode)this.setCloneHandler(t);else if("create"===this.mode){if(!1===this.setCreateHandler(t))return!1}else this.setEditHandler(t)&&SYNO.SDS.Share.PermissionDialog.prototype.loadPermissionData.call(this,this.share);return this.clearStatusBusy(),!1!==this.hasWritableVol||"clone"!==this.mode&&"create"!==this.mode?(this.onLocationChange(this.shareForm.findField("vol_path")),!0):(this.getMsgBox().alert("",_T("share","create_wizard_no_volume"),(function(){this.close()}),this),!1)}})},getVolumeList:function(e){return SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Storage.Volume","list","volumes")},launchStoargeManager:async function(){let e="",t=await SYNO.SDS.AdminCenter.Share.GetPoolList(this);e="yes"===_D("usbstation","no")?_T("volume","volume_share_noexternal"):0===t.length?_T("volume","volume_share_pool_create"):_T("volume","volume_share_volume_create"),this.getMsgBox().alert("",e,(function(){if("SYNO.SDS.CMS.Application"!==this.module.appWin.getOpenConfig("className")){var e=_T("volume","create_volume"),i="volume";0===t.length&&(e=_T("volume","volume_raid_creation_title"),i="both"),SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance",{fn:"SYNO.SDS.StorageManager.Pool.Main",vueWizard:"CreateWizard",modalParam:{width:820,height:560,title:e,mode:i}})}this.close()}),this)},isUsbStation:function(){return"yes"===_D("usbstation","no")},checkVolumes:function(e,t){return!!(Ext.isArray(e)&&e.length>0)||(!(this.isUsbStation()||!Ext.isObject(t)||!t.is_usb_share)||(this.launchStoargeManager(),!1))},pushVolumeList:function(e,t,i){var s=this.shareForm.findField("vol_path").getStore(),n=Ext.isObject(i)?i.name.toLowerCase():"",o=Ext.isObject(i)&&0!==i.encryption;if(!this.checkVolumes(t,i))return!1;this.volumeFsMap={},this.volumeAttrMap={},this.dedupedVolume=[],this.hasWritableVol=!1;var a=[],r=!1;if(Ext.each(t,(function(t,i,s){if(this.volumeFsMap[t.volume_path]=t.fs_type,this.volumeAttrMap[t.volume_path]=t.volume_attribute,!0===t.deduped&&this.dedupedVolume.push(t.volume_path),e===t.volume_path&&t.fs_type,t.readonly){if(t.volume_path===e)return this.getMsgBox().alert("",_T("error","error_volume_ro"),(function(){this.close()}),this),r=!0,!1}else{if("yes"===_D("usbstation","no")){if(o&&"ext3"!==t.fs_type&&"ext4"!==t.fs_type)return;if(("homes"===n||"web"==n)&&"ext4"!==t.fs_type)return}var l,d,c,h;h="btrfs"===t.fs_type?"generic"===t.volume_attribute?String.format("{0}",_T("volume","volume_add_fs_btrfs_type")):String.format("{0}",_T("volume","volume_add_fs_btrfs_peta_type")):String.format("{0}",t.fs_type),l=this.isHCM()?String.format("{0}",SYNO.SDS.Utils.StorageUtils.VolumeNameRenderer(t)):String.format("{0}{1} {2}",SYNO.SDS.Utils.StorageUtils.VolumeNameRenderer(t),_T("common","colon"),h),t.is_encrypted&&(l+=_T("common","comma")+_T("share","volume_encrypted_desc")),d=String.format("{0}{1} {2}",_T("volume","volume_freesize"),_T("common","colon"),SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SizeRender(t.size_free_byte)),""!==t.description&&(c=Ext.util.Format.htmlEncode(t.description)),a.push([t.volume_path,l,t.size_total_byte/1024/1024,t.display_name,d,t.volume_id,c,t.volume_quota_status]),this.hasWritableVol=!0}}),this),r)return!1;if(0===a.length)return!0;a.sort((function(e,t){return e[5]-t[5]}));var l=[];return Ext.each(a,(function(e,t,i){l=l.concat({value:e[0],display:e[1],size_total_mb:e[2],vol_name:e[3],desc:Ext.util.Format.htmlEncode(e[4]),tooltip:e[6],volume_quota_status:e[7]})})),s.loadData(l),e||(e=a[0][0],a[0][2]),this.shareForm.setValues({vol_path:e,vol_orig:e}),!0},loadWormFormValues:function(e){let t=this.wormForm.findField("share_worm_mode_combobox"),i=this.wormForm.findField("share_worm_mode_desc"),s=this.wormForm.findField("share_worm_enable_auto_lock"),n=this.wormForm.findField("share_worm_lock_wait_time_radio"),o=this.wormForm.findField("share_worm_lock_wait_time_number"),a=this.wormForm.findField("share_worm_lock_wait_time_unit"),r=this.wormForm.findField("share_worm_def_lock_duration_radio"),l=this.wormForm.findField("share_worm_def_lock_duration_number"),d=this.wormForm.findField("share_worm_def_lock_duration_unit"),c=this.wormForm.findField("share_worm_def_lock_mode_combobox");t.setValue(e?"enterprise":this.share.get("worm_subvol_mode")).initValue(),e||"create"===this.mode||t.disable(),i.setValue(this.getWormModeDesc(e?"enterprise":this.share.get("worm_subvol_mode"))),i.initValue(),s.setValue(!e&&!this.isWormAutoLockDisabled()).initValue(),s.getValue()?(0===this.share.get("worm_lock_wait_time")?(n.setValue("immediately").initValue(),a.setValue("hours").initValue(),o.setValue(2).initValue()):(n.setValue("period").initValue(),a.setValue(this.getLockWaitTimeUnit()).initValue(),o.setValue(this.getLockWaitTimeNumber()).initValue()),this.share.get("worm_def_lock_duration")>31536e5?(r.setValue("forever").initValue(),d.setValue("years").initValue(),l.setValue(3).initValue()):(r.setValue("period").initValue(),d.setValue(this.getDefLockDurationUnit()).initValue(),l.setValue(this.getDefLockDurationNumber()).initValue()),c.setValue(this.share.get("worm_def_lock_mode")).initValue()):(n.setValue("period").initValue(),a.setValue("hours").initValue(),o.setValue(2).initValue(),r.setValue("period").initValue(),d.setValue("years").initValue(),l.setValue(3).initValue(),c.setValue("appendable").initValue(),a.disable(),o.disable(),d.disable(),l.disable()),this.wormForm.findFields("share_worm_lock_wait_time_radio").forEach((e=>e.initValue())),this.wormForm.findFields("share_worm_def_lock_duration_radio").forEach((e=>e.initValue()))},setCloneHandler:function(e){var t=e.result[1].data,i=t.vol_path,s=this.advancedForm,n=(this.encryptForm.findField("encryption"),this.advancedForm.findField("enable_share_compress"));this.panel.hideTabStripItem("encryptForm"),this.isWormSupported()&&this.isWormShareInfo(t)?this.panel.unhideTabStripItem("wormForm"):this.panel.hideTabStripItem("wormForm"),this.pushVolumeList(i,this.getVolumeList(e)),this.shareForm.setValues({name_org:t.name}),this.shareForm.findField("enable_recycle_bin").setValue(!0),this.shareForm.findField("recycle_bin_admin_only").setValue(!0),this.isWormShareInfo(t)&&(this.share.set("worm_subvol_mode",t.worm_subvol_mode),this.share.set("worm_def_lock_mode",t.worm_def_lock_mode),this.share.set("worm_lock_wait_time",t.worm_lock_wait_time),this.share.set("worm_def_lock_duration",t.worm_def_lock_duration),this.loadWormFormValues(!1)),this.supportBtrfs&&(s.findField("enable_share_cow").initValue=t.enable_share_cow,s.findField("enable_share_compress").initValue=t.enable_share_compress,0!==t.encryption&&(n.setValue(!1),n.disable()),this.addCompressionTooltip(0!==t.encryption))},setCreateHandler:function(e){return!1!==this.pushVolumeList(null,this.getVolumeList(e),null)&&(this.shareForm.findField("enable_recycle_bin").setValue(!0),this.shareForm.findField("recycle_bin_admin_only").setValue(!0),this.loadWormFormValues(!0),this.addCompressionTooltip(!1),!0)},setEditHandler:function(e){var t=e.result[1].data,i=t.vol_path,s=t.name.toLowerCase();switch(!this.isEncrytSupported()||this.isWormShareInfo(t)?this.panel.hideTabStripItem("encryptForm"):this.panel.unhideTabStripItem("encryptForm"),this.isWormSupported()&&this.isWormShareInfo(t)?this.panel.unhideTabStripItem("wormForm"):this.panel.hideTabStripItem("wormForm"),"homes"!==s&&-1===i.indexOf("SATA")||this.shareForm.findField("name").disable(),t.enable_recycle_bin||Ext.getCmp(this.cleanBinBtnId).disable(),this.shareForm.setValues({name_org:t.name}),this.shareForm.setValues(t),t.encryption){case 0:var n=this.encryptForm.findField("encryption").getEl();if(n){var o=_T("share","no_encryption_help_link"),a=_T("common","here"),r=String.format(_T("share","no_encryption_reason"),`<a href="${o}" target="_blank"><font class="link-font">${a}</font></a>`);SYNO.ux.AddTip(n,r)}SYNO.ux.Utils.displayFormField(this.encryptForm,"no_encryption_reason",!1);break;case 1:this.shareForm.findField("enable_recycle_bin").disable(),Ext.getCmp(this.cleanBinBtnId).disable(),this.encryptTabEl.hidden||(this.encryptForm.setValues({encryption:!0}),this.encryptForm.findField("encryption").disable(),this.encryptForm.findField("enc_passwd").disable(),this.encryptForm.findField("enc_passwd2").disable(),this.enableGroupDummy1.enable_fields=[]),this.advancedForm.findField("enable_share_compress").disable();break;case 2:this.shareForm.findField("name").disable(),this.shareForm.findField("vol_path").disable(),SYNO.ux.AddTip(this.shareForm.findField("vol_path").getEl(),_T("share","share_move_encryption_tip")),this.encryptTabEl.hidden||(this.encryptForm.setValues({encryption:!0}),this.encryptForm.findField("enc_passwd").disable(),this.encryptForm.findField("enc_passwd2").disable(),this.enableGroupDummy1.enable_fields=[]);break;default:var l="Error: unknown encryption = "+this.shareInfo.encryption;this.getMsgBox().alert("",l)}if(this.updateKeyManagerUI(),this.isWormShareInfo(t)&&(this.shareForm.findField("name").disable(),this.shareForm.findField("vol_path").disable(),this.shareForm.findField("enable_recycle_bin").disable(),this.share.set("worm_subvol_mode",t.worm_subvol_mode),this.share.set("worm_def_lock_mode",t.worm_def_lock_mode),this.share.set("worm_lock_wait_time",t.worm_lock_wait_time),this.share.set("worm_def_lock_duration",t.worm_def_lock_duration),this.loadWormFormValues(!1)),this.isClusterShareDisable(t)&&(this.shareForm.findField("enable_recycle_bin").disable(),Ext.getCmp(this.cleanBinBtnId).disable()),this.isClusterShare(t)&&(this.encryptForm.findField("encryption").disable(),this.encryptForm.findField("enc_passwd").disable(),this.encryptForm.findField("enc_passwd2").disable()),this.isColdStorageShare(t)&&(this.encryptForm.findField("encryption").disable(),this.encryptForm.findField("enc_passwd").disable(),this.encryptForm.findField("enc_passwd2").disable()),!1===this.pushVolumeList(i,this.getVolumeList(e),t))return!1;if(t.is_usb_share){var d="-";-1!==t.vol_path.indexOf("USB")?d="SDCARD"===t.external_dev_type?_T("tree","leaf_sdcard"):_T("status","status_usb"):-1!==t.vol_path.indexOf("sata")&&(d=_T("status","status_sata")),this.shareForm.setValues({my_vol_status:d}),this.formPanel.disable(),SYNO.ux.Utils.displayFormField(this.shareForm,"my_vol_status",!0),SYNO.ux.Utils.displayFormField(this.shareForm,"vol_path",!1),this.encryptForm.findField("encryption").disable(),this.encryptForm.findField("enc_passwd").disable(),this.encryptForm.findField("enc_passwd2").disable()}else this.isShowBtrfsOption()&&this.setEditAdvancedTab(t);return this.isShowVolume()||(SYNO.ux.Utils.displayFormField(this.shareForm,"vol_path",!1),SYNO.ux.Utils.displayFormField(this.shareForm,"my_vol_status",!1)),this.isCanRename()||this.shareForm.findField("name").disable(),this.isTieringBucketShare(t)&&(this.shareForm.findField("vol_path").disable(),SYNO.ux.AddTip(this.shareForm.findField("vol_path").getEl(),_T("share","share_move_tiering_bucket_tip")),this.shareForm.findField("hidden").disable(),SYNO.ux.AddTip(this.shareForm.findField("hidden").getEl(),_T("share","share_hidden_tiering_bucket_tip")),this.shareForm.findField("hide_unreadable").disable(),this.hideUnreadableTooltip.remove(),this.hideUnreadableTooltip=SYNO.ux.AddTip(this.shareForm.findField("hide_unreadable").getEl(),_T("share","share_hide_unreadable_tiering_bucket_tip"))),!0},getQuotaStatus:function(){const e=this.shareForm.findField("vol_path").getValue(),t=this.shareForm.findField("vol_path").getStore().getById(e);return t?t.data.volume_quota_status:"unknown"},needDisableQuotaUsed(e){return"incompatible"===this.getQuotaStatus()},setEditAdvancedTab:function(e){var t=this.advancedForm,i=this.encryptForm.findField("encryption"),s=this.advancedForm.findField("enable_share_compress");if(delete e.encryption,t.setValues(e),i.getValue()&&(s.setValue(!1),s.disable()),this.addCompressionTooltip(i.getValue()),this.supportShareQuota&&e.hasOwnProperty("quota_value")&&e.quota_value>0){t.setValues({enable_share_quota:!0});var n=e.quota_value;n/1024/1024==Math.floor(n/1024/1024)?(t.setValues({quota_unit:"TB"}),t.setValues({quota_value:n/1024/1024})):n/1024==Math.floor(n/1024)?(t.setValues({quota_unit:"GB"}),t.setValues({quota_value:n/1024})):(t.setValues({quota_unit:"MB"}),t.setValues({quota_value:n}))}if(t.findField("share_quota_status").initValue=this.supportShareQuota?e.share_quota_status:void 0,this.needDisableQuotaUsed(e))t.setValues({share_quota_used:""});else if(this.supportShareQuota&&e.hasOwnProperty("share_quota_used")){var o,a=SYNO.SDS.Utils.CapacityRender(e.share_quota_used,2);o=String.format(_T("share","share_used"),'<span style="color:#0086E5">'+a+"</span>"),t.setValues({share_quota_used:o})}t.findField("enable_share_cow").initValue=e.enable_share_cow,t.findField("enable_share_compress").initValue=e.enable_share_compress},editHandler:function(){var e=this.shareForm.findField("name").getValue(),t=this.getFsType("vol_path");if(!this.shareForm.isValid())return this.panel.setActiveTab("shareForm"),void this.setStatusError({text:_T("error","error_bad_field"),clear:!0});if(!this.encryptTabEl.hidden&&!this.encryptForm.isValid())return this.panel.setActiveTab("encryptForm"),void this.setStatusError({text:_T("error","error_bad_field"),clear:!0});if(!this.wormTabEl.hidden&&!this.wormForm.isValid())return this.panel.setActiveTab("wormForm"),void this.setStatusError({text:_T("error","error_bad_field"),clear:!0});if(this.isShowBtrfsOption()&&!this.advancedForm.isValid())return this.panel.setActiveTab("advancedForm"),void this.setStatusError({text:_T("error","error_bad_field"),clear:!0});if(this.isAnyFormDirty())if("yes"!==_D("usbstation","no")||"web"!==e.toLowerCase()||"ext4"===t){if(!0===this.share.get("is_aclmode"))if("surveillance"===this.shareForm.findField("name").getValue().toLowerCase())return void this.getMsgBox().alert("",_T("share","share_acl_share_not_support"));var i=this.formPanel.getForm().findField("unite_permission");i.isDirty()&&!0===i.getValue()?this.getMsgBox().alert("",_T("share","warn_enable_advanced_permission"),(function(){this.confirmPolling()}),this):this.confirmPolling()}else this.getMsgBox().alert("",String.format(_T("service","no_ext4_external_devices"),e));else this.close()},setItemUnchecked:function(e){e.setValue(!1)},confirmPolling:function(){var e={},t=this.shareForm.findField("vol_path"),i=this.encryptForm.findField("encryption"),s=this.advancedForm.findField("enable_share_cow"),n=this.advancedForm.findField("enable_share_compress"),o="yes"===_D("support_online_compr_switch","no");e.name=this.shareForm.findField("name_org").getValue(),e.shareinfo=this.getParamShareForm(),e.shareinfo.encryption=this.encryptForm.findField("encryption").getValue(),e.shareinfo.enc_passwd=this.encryptForm.findField("enc_passwd").getValue(),this.shareActionPolling=t.isDirty()||i.isDirty()||s.isDirty()||n.isDirty(),this.doShareMove=t.isDirty()||i.isDirty()||s.isDirty()||n.isDirty()&&!o,this.shareActionPolling&&this.doShareMove&&this.isShowBtrfsOption()&&this.advancedForm.findField("enable_share_quota").getValue()&&(e.shareinfo.share_quota=this.getQuotaInMB()),this.verifyPassphrase(e)},verifyPassphrase:function(e){var t=this.encryptForm.findField("add_to_keymanager").getValue(),i=this.encryptForm.findField("keymanager_passphrase").getValue();t?(this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Store",method:"verify",params:{passphrase:i},encryption:["passphrase"],version:1,scope:this,callback:function(t,i,s){if(this.clearStatusBusy(),t)this.submitValidShareInfo(e);else{var n=SYNO.API.Response.GetFirstError(i),o=SYNO.API.Errors.core[n.code]||_T("keymanager","error_invalid_passphrase");this.getMsgBox().alert("",o)}}})):this.submitValidShareInfo(e)},addAlignedBullet:function(e){return String.format('<div style="display:inline-flex; line-height:20px; margin-top:8px;"><div>&#8226;</div><div style="padding-left:8px;">{0}</div></div>',e)},submitValidShareInfo:function(e){this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share",method:"validate_set",params:e,encryption:["shareinfo"],version:1,scope:this,callback:function(t,i,s){var n=[],o="",a="",r=[];if(this.clearStatusBusy(),!t){if(i&&i.errors&&i.errors.warning_package){for(var l=[],d=0;d<i.errors.warning_package.length;d++)l.push(SYNO.SDS.AdminCenter.Share.Utils.GetPackageName(i.errors.warning_package[d]));a=_T("share","share_cannot_rename_since_service_enable"),a+=l.join(", ")}else{var c=SYNO.API.Response.GetFirstError(i);a=SYNO.API.Errors.core[c.code]||_T("common","error_system")}return this.getMsgBox().alert("",a),!1}if(this.shareActionPolling&&this.doShareMove){var h=_T("share","share_move_desc_time_spent")+"<br>";const e=this.isVolDedup("vol_path"),t="v1"===this.getQuotaStatus(),i=this.advancedForm.findField("enable_share_quota").getValue();h+=_T("share","share_move_please_note")+_T("common","colon")+"<br>",h+=this.addAlignedBullet(_T("share","share_move_serivce_stopped")),this.isBtrfsShare("vol_orig")&&(h+=this.addAlignedBullet(_T("share","share_move_snapshot_lost_warning")),this.isBtrfsShare("vol_path")||(h+=this.addAlignedBullet(_T("share","share_move_quota_lost_warning"))),e&&t&&i&&(h+=this.addAlignedBullet(_T("share","share_move_dedup_quota_lost_warning")))),"homes"===this.share.get("name").toLowerCase()&&(h+=this.addAlignedBullet(_T("user","home_volume_change"))),h+="<br>",h+="<br>"+_T("common","ask_cont");var u=_T("common","continue"),p=this.encryptForm.findField("encryption");p.isDirty()&&(u=p.getValue()?_T("share","btn_encrypt_share"):_T("share","btn_decrypt_share")),r.push({custom:!0,style:this.isBtrfsShare("vol_orig")?"warning":"normal",btn:u,text:h})}if(i&&i.hasOwnProperty("warning_pause_service")&&(Ext.each(i.warning_pause_service,(function(e){n.push(SYNO.SDS.AdminCenter.Share.Utils.GetServiceI18N(e))})),o="<b>"+n.join(", ")+"</b><br>",r.push({text:String.format(_T("share","share_service_pause_confirm"),o)})),"yes"===_D("supportNFS","no")&&_S("is_admin")&&this.supportBtrfs){var _=this.getIsSnapshotBrowsing(),m=!!this.nfsPanel.disabled||this.nfsPanel.onRuleCheck();_&&!m&&this.nfsPanel.dataModified&&r.push({text:_T("share","share_nfs_crossmnt_apply_confirm"),callback:function(t){"yes"===t&&this.nfsPanel.applyCrossMnt(),this.showConfirmMsg(r,e,i)}})}this.showConfirmMsg(r,e,i)}})},showFeasibilityCheckMsg:function(e,t){var i;t&&t.hard?(i=_T("share","edit_hard_check_fail"),i+="<br><b>"+SYNO.SDS.Utils.GetFeasibilityCheckMsgJoin(t.hard[e.name])+"</b>",this.getMsgBox().alert("",i)):t&&t.soft?(i=_T("share","edit_soft_check_fail"),i+="<br><b>"+SYNO.SDS.Utils.GetFeasibilityCheckMsgJoin(t.soft[e.name])+"</b>",this.getMsgBox().confirm("",i,(function(t){"yes"===t&&this.showEncryptWarnMsg(e)}),this)):this.showEncryptWarnMsg(e)},showEncryptWarnMsg:function(e){this.IsToEncrypt()?this.confirm_encryption(e,this.submitEditShareInfo):this.submitEditShareInfo(e)},IsToEncrypt:function(){let e=this.encryptForm.findField("encryption");return e.isDirty()&&!0===e.getValue()},showConfirmMsg:function(e,t,i){var s;if(i&&i.hard||0===e.length)this.showFeasibilityCheckMsg(t,i);else if((s=e.pop()).custom||"warning"==s.style){var n=new SYNO.SDS.AdminCenter.Share.Move({owner:this,module:this.module,appWin:this.appWin,msg:s,scope:this,callback:function(s){"yes"===s&&this.showConfirmMsg(e,t,i)}});n.loadMessage(s.text),n.open()}else{this.getMsgBox().confirm("",s.text,(function(n){s.callback?s.callback.call(this,n):"yes"===n&&this.showConfirmMsg(e,t,i)}),this);var o=this.getMsgBox().getDialog();o.setWidth(600),o.setPosition([this.getPosition()[0]+(this.getWidth()-o.getWidth())/2,this.getPosition()[1]+(this.getHeight()-o.getHeight())/2-20])}},submitEditShareInfo:function(e){var t=!0,i=this.gridPanel.disabled?[]:this.gridPanel.getWebAPI(),s=this.formPanel.disabled?[]:this.formPanel.getWebAPI(),n=i.concat(s);if("yes"===_D("supportNFS","no")&&_S("is_admin")){var o=this.nfsPanel.disabled?[]:this.nfsPanel.getWebAPI();n=n.concat(o)}for(var a=0;a<n.length;a++){var r=n[a];if("SYNO.Core.Share"===r.api&&"set"===r.method){Ext.apply(e.shareinfo,{advanceperm:r.params.shareinfo.advanceperm,unite_permission:r.params.shareinfo.unite_permission}),r.params=e,r.version=1,t=!1;break}}t&&n.push({api:"SYNO.Core.Share",method:"set",params:e,encryption:["shareinfo"],version:1}),this.initKeyManagerRequest();var l={name:this.share.get("name"),is_sync_share:this.share.get("is_sync_share"),permissions:[],no_check_permission:!1};this.gridPanel.disabled||(l.permissions=this.gridPanel.getModifiedPermissions()),!this.formPanel.disabled&&this.formPanel.isAdvPermissionDisabled()&&(l.no_check_permission=!0),SYNO.SDS.Utils.S2S.confirmIfSyncShareAffected(!1,l,{dialogTitle:this.title,dialogMsg:_T("s2s","s2s_warn_share_change_priv"),dialogOwner:this,continueHandler:function(){this.sendApplyRequest(n)},abortHandler:function(){this.clearStatusBusy()},scope:this})},initKeyManagerRequest:function(){this.KeyManager={},this.KeyManager.name=this.shareForm.findField("name").getValue(),this.KeyManager.enable=this.encryptForm.findField("add_to_keymanager").getValue(),this.KeyManager.encryption=this.encryptForm.findField("encryption").getValue(),this.KeyManager.password=this.encryptForm.findField("enc_passwd").getValue(),this.KeyManager.passphrase=this.encryptForm.findField("keymanager_passphrase").getValue(),this.KeyManager.cypher=this.encryptForm.findField("keymanager_cypher").getValue()},sendApplyRequest:function(e){this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({params:{},compound:{stopwhenerror:!0,params:e},encryption:["shareinfo"],scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),!e||t.has_fail){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return 3309===s.code&&(n=String.format(n,_D("maxshares"))),void this.getMsgBox().alert("",n)}var o=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Share.Permission","set"),a=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Share","set");this.share_name=a.name,this.shareActionPolling?this.startShareMovePolling(a,o):(!o&&t.result[0]&&t.result[0].data&&(o=t.result[0].data),this.applyDone(o))}})},exportEncryptionKey:function(e,t){synowebapi.download({api:"SYNO.Core.Share.Crypto.Key",method:"export",version:1,params:{name:e,password:t},encryption:["password"]})},applyDone:function(e){this.KeyManager.encryption&&this.KeyManager.password&&this.exportEncryptionKey(this.KeyManager.name,this.KeyManager.password),this.module.getPanel().fireEvent("sharefolderchanged",this.share_name),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission"),this.isDestroyed||(this.clearStatusBusy(),e&&e.is_ftp_anonymous_chroot_conflict?this.gridPanel.confirmToShowFTPAdvancedSetting({closeDialog:!0}):this.close())},cleanHomesBin:function(){new SYNO.SDS.AdminCenter.Share.CleanHomeRecycleDialog({module:this.module,owner:this,callback:this.confirmClean}).open()},onCleanBinBtnClick:function(e,t){var i,s=this.shareTab.getForm();let n="homes"===this.share.get("name").toLowerCase();_S("demo_mode")?this.findAppWindow().getMsgBox().alert("",_JSLIBSTR("uicommon","error_demo")):n?this.cleanHomesBin():(i=[{id:s.findField("name_org").getValue()}],this.confirmClean(i))},confirmClean:function(e){let t={yes:{text:Ext.MessageBox.buttonText.yes,btnStyle:"red"},no:{text:Ext.MessageBox.buttonText.no}};this.getMsgBox().confirmDelete(_T("share","share_clean_recycle_bin"),_T("share","share_recycle_bin_clean_warn"),(function(t){"yes"===t&&e.forEach((e=>{this.sendWebAPI({api:"SYNO.Core.RecycleBin",method:"start",version:1,params:e,scope:this})}))}),this,t)},restoreValue:function(e){var t=this.advancedForm.findField(e);t.hasSetOriginValue&&(t.setValue(t.originValue),t.hasSetOriginValue=!1)},storeValue:function(e){var t=this.advancedForm.findField(e);t.hasSetOriginValue||(t.originValue=t.getValue(),t.hasSetOriginValue=!0),"syno_checkbox"===t.xtype?t.setValue(!1):"syno_numberfield"===t.xtype&&(t.setValue(0),t.clearInvalid())},adjustQuotaTip:function(e){let t;const i=e=>SYNO.ux.AddTip(this.advancedForm.findField("share_quota_used").getEl(),e).id;e&&(t=Ext.util.Format.htmlEncode(_T("share","share_quota_unsupported_desc"))),t?(this.quotaTipID?Ext.getCmp(this.quotaTipID).show():this.quotaTipID=i(""),Ext.getCmp(this.quotaTipID).el.set({"ext:wtip":t})):this.quotaTipID&&Ext.getCmp(this.quotaTipID).hide()},onLocationChange:function(e){var t=this.getFsType("vol_path"),i=this.getVolAttr("vol_path");this.isVolDedup("vol_path");if("yes"===_D("usbstation","no")&&"clone"!==this.mode&&("ext3"===t||"ext4"===t?this.encryptForm.findField("encryption").enable():(!0===this.encryptForm.findField("encryption").getValue()&&this.getMsgBox().alert("",_T("share","share_enc_ext4_only")),this.encryptForm.setValues({encryption:!1,enc_passwd:"",enc_passwd2:""}),this.encryptForm.findField("encryption").disable())),"create"===this.mode&&this.dataProtectionForm){var s,n=this.dataProtectionForm.findField("share_data_protection_worm_desc"),o=this.dataProtectionForm.findField("share_data_protection_radio");this.dataProtectionForm.findFields("share_data_protection_radio").forEach((function(e){"worm"===e.inputValue&&(s=e)})),"btrfs"===t&&this.isHaSupportWorm()?(s.enable(),n.enable()):(s.disable(),n.disable(),"worm"===o.getGroupValue()&&o.setValue("skip"))}if("create"===this.mode&&"btrfs"===t&&("generic"===i?this.encryptForm.findField("encryption").enable():this.encryptForm.findField("encryption").disable()),this.isShowBtrfsOption()){var a=this.advancedForm;const s="incompatible"===this.getQuotaStatus();if(this.supportShareQuota&&("btrfs"!==t||s?(a.findField("enable_share_quota").disable(),a.findField("share_quota_used").disable()):(a.findField("enable_share_quota").enable(),a.findField("share_quota_used").enable(),a.findField("quota_value").validate()),this.adjustQuotaTip(s)),"btrfs"===t){var r=a.findField("enable_share_cow"),l=a.findField("enable_share_compress"),d=this.encryptForm.findField("encryption");"create"===this.mode?(r.enable(),r.getValue()&&"generic"===i&&!d.getValue()?l.enable():l.disable()):(e.getValue()===this.shareForm.findField("vol_orig").getValue()?(r.disable(),r.setValue(r.initValue),l.setValue(l.initValue)):r.enable(),!1===r.getValue()||0!==this.share.data.encryption||"generic"!==i?l.disable():l.enable())}else a.findField("enable_share_cow").disable(),a.findField("enable_share_compress").disable()}},startShareMovePolling:function(e,t){var i={ok:_T("common","hide"),cancel:_T("common","cancel")};this.getMsgBox().show({width:300,progress:!0,closable:!1,buttons:i,fn:function(t,i,s){"ok"===t?this.onCloseMsgBox():"cancel"===t&&this.onCancelMoveJob(e)}.createDelegate(this),msg:this.moveShareMsg,scope:this}),this.module.panel.share_move_pollingId=this.pollReg({webapi:{api:"SYNO.Core.Share",method:"move_status",version:1,params:{task_id:e.task_id}},interval:5,immediate:!0,scope:this,status_callback:function(i,s,n,o){var a=s.data;if(!i){this.stopShareMovePolling();var r=SYNO.API.Response.GetFirstError(s),l=SYNO.API.Errors.core[r.code]||_T("common","error_system");if(5608==r.code)if(r.errors&&r.errors.error&&r.errors.error.errors&&r.errors.error.errors.invalid_list)l=l+"<br><b>"+r.errors.error.errors.invalid_list.slice(0,5).join(", <br>")+"</b>";return this.getMsgBox().alert("",l),this.sendWebAPI({webapi:{api:"SYNO.Core.Share",version:1,method:"stop_move",params:{task_id:e.task_id,bg_taskid:e.bg_taskid},scope:this}}),!1}if(i&&void 0!==a)if("success"===a.status)this.sendWebAPI({webapi:{api:"SYNO.Core.Share",version:1,method:"stop_move",params:{task_id:e.task_id,bg_taskid:e.bg_taskid},scope:this}}),this.stopShareMovePolling(),this.getMsgBox().hide(),this.KeyManager.enable?this.addKeyToKeyManager(this.applyDone,t):this.applyDone(t);else if("cancelled"===a.status)this.stopShareMovePolling(),this.onCloseMsgBox();else if("checking"===a.status)this.moveShareMsg=_T("share","enough_space_check"),this.getMsgBox().updateProgress(0,"",this.moveShareMsg);else{var d,c=(100*a.processed_size/a.total).toFixed(2),h=this.getRemainTimeStr(a),u=Ext.util.Format.fileSize(a.transfer_rate.toFixed(2))+"/s";!0===a.data_transfer_mode?(this.moveShareMsg=String.format('{0}<span class="syno-mb-progress-status">{1}&nbsp;&#37;</span>',_T("share","share_move_progress"),c),d=String.format('<div>{0}:&nbsp;{1}&nbsp;({2}&nbsp;/&nbsp;{3})</div><div style="padding-top: 6px;">{4}:&nbsp;{5}</div>',_T("rsrcmonitor","transfer_rate"),u,Ext.util.Format.fileSize(a.processed_size||0),Ext.util.Format.fileSize(a.total),_T("download","download_time_left"),h)):(this.moveShareMsg=String.format('{0}<span class="syno-mb-progress-status">{1}&nbsp;&#37;</span>',_T("common","applying_settings")+"...",c),d=String.format("<div>{0}:&nbsp;{1}</div>",_T("download","download_time_left"),h)),this.getMsgBox().updateProgress(c/100,d,this.moveShareMsg,!0),this.getMsgBox().getDialog().progressStatus.removeClass("syno-mb-progress-status")}}})},getRemainTimeStr:function(e){return e?((t=(e.total-e.processed_size)/e.transfer_rate)/86400>1?n=_T("common","time_greater_day"):(n="",i=parseInt(t/3600,10),s=parseInt(t/60-60*i,10),parseInt(t-60*s-3600*i,10),n+=i>=1?i+" "+_T("status","status_hour")+", ":"",""===(n+=s>=1?s+" "+_T("status","status_minute"):"")&&(n=_T("common","time_less_min"))),n):_T("common","unknown");var t,i,s,n},onCloseMsgBox:function(){this.getMsgBox().getDialog().doClose(),this.applyDone()},onCancelMoveJob:function(e){this.stopShareMovePolling(),this.sendWebAPI({webapi:{api:"SYNO.Core.Share",version:1,method:"stop_move",params:{task_id:e.task_id,bg_taskid:e.bg_taskid},scope:this}}),this.onCloseMsgBox()},stopShareMovePolling:function(){this.module.panel.stopShareMovePolling()},deactivate:function(){return!0},getQuotaInMB:function(){var e=this.advancedForm,t=e.findField("quota_value").getValue(),i=e.findField("quota_unit").getValue();return"TB"===i?t=1024*t*1024:"GB"===i&&(t*=1024),t},confirmQuotaUpdate:function(e){const t=this.getVolumeName(),i=String.format(_T("share","share_quota_recalculate_warn"),t);this.getMsgBox().confirm("",i,(t=>{e&&e.setValue("yes"===t),"yes"===t&&this.enableShareQuota(!0)}))},getVolumeName:function(){const e=this.shareForm.findField("vol_path").getValue();return this.shareForm.findField("vol_path").getStore().getById(e).data.vol_name},onEnableShareQuota:function(){this.enableShareQuota()},enableShareQuota:function(e){var t=this.advancedForm,i=t.findField("enable_share_quota").getValue();let s=t.findField("quota_value").getValue();if(i&&0===s&&!0!==e){const e=this.shareForm.findField("vol_path").isDirty()&&"edit"===this.mode,i=this.isVolDedup("vol_path"),s="v1"===this.getQuotaStatus();if(i&&s&&!e)return void this.confirmQuotaUpdate(t.findField("enable_share_quota"))}i?(t.findField("quota_value").enable(),t.findField("quota_unit").enable(),0===t.findField("quota_value").getValue()&&t.setValues({quota_value:10})):(t.findField("quota_value").disable(),t.findField("quota_unit").disable(),t.setValues({quota_value:0}))},getIsSnapshotBrowsing:function(){var e=this.advancedForm.findField("enable_snapshot_browsing");return!(!this.supportBtrfs||e.disabled)&&e.getValue()},isBtrfsShare:function(e){return"btrfs"===this.getFsType(e)},getFsType:function(e){var t=this.shareForm.findField(e).getValue();return this.volumeFsMap[t]},getVolAttr:function(e){var t=this.shareForm.findField(e).getValue();return this.volumeAttrMap[t]},isVolDedup:function(e){let t=this.shareForm.findField(e).getValue();return this.dedupedVolume.includes(t)},isAnyFormDirty:function(){var e=this.shareTab.isFormDirty(),t=this.encryptTab.isFormDirty(),i=this.wormTab.isFormDirty(),s=this.advancedTab.isFormDirty(),n="edit"===this.mode&&SYNO.SDS.Share.PermissionDialog.prototype.isChanged.call(this),o="edit"===this.mode&&this.nfsPanel&&0!==this.nfsPanel.dataModified;return e||t||i||s||n||o},isShowBtrfsOption:function(){return this.supportBtrfs||this.supportShareQuota},isShowVolume:function(){return!this.share||!this.share.get("is_cluster_share")},isCanRename:function(){return!this.share||!this.share.get("is_cluster_share")},isColdStorageShare:function(e){return!(!e||!e.is_cold_storage_share)||!(e||!this.share||!this.share.get("is_cold_storage_share"))},isClusterShare:function(e){return!(!e||!e.is_cluster_share)||!(e||!this.share||!this.share.get("is_cluster_share"))},isClusterShareDisable:function(e){return!!this.isClusterShare(e)&&(!(!e||e.cluster_share_mount)||!(e||!this.share||this.share.get("cluster_share_mount")))},isDisableNFS:function(){return!(!this.share||!this.share.get("is_cluster_share"))},isTieringBucketShare:function(e){return!(!e||!e.is_tiering_bucket)||!(e||!this.share||!this.share.get("is_tiering_bucket"))}}),Ext.define("SYNO.SDS.AdminCenter.Share.CreateWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){this.applyShareDialogFunctions(),this.module=e.module,this.owner=e.owner,this.share=e.share,this.store=e.store,this.mode="create",this.supportBtrfs="yes"===_D("support_btrfs","no")&&!this.isHCM(),this.supportShareQuota="yes"===_D("support_share_quota","no"),this.share&&this.share.get("is_cluster_share")&&(this.supportBtrfs=!1,this.supportShareQuota=!1),this.snapshot=e.snapshot,this.blKeyManagerEnabled=e.blKeyManagerEnabled,this.rgQuotaUnit=[["TB","TB"],["GB","GB"],["MB","MB"]],this.defineGrid();var t=Ext.apply({},e);delete t.owner,this.shareTab=this.fillShareFormConfig(Ext.apply({headline:_T("share","create_wizard_basic_info"),itemId:"basic_info",nextId:this.isEncrytSupported()?"data_protection":this.isShowBtrfsOption()?"adv_setting":"summary",getNext:function(){var e=this.getForm().findField("name").getValue(),t=!1;return this.module.panel.store.each((function(i){if(e.toLowerCase()===i.get("name").toLowerCase())return t=!0,!1})),t?(this.getForm().findField("name").markInvalid(_T("share","share_already_exist")),!1):!!this.getForm().isValid()&&this.nextId}},t)),this.dataProtectionTab=this.fillDataProtectionFormConfig(Ext.apply({headline:_T("share","share_data_protection_tab_title"),itemId:"data_protection",nextId:"enc_setting",owner:this,getNext:function(){var e=this.getForm().findField("share_data_protection_radio").getGroupValue();if("skip"===e)return this.owner.encryptForm.findField("encryption").setValue(!1),this.owner.isShowBtrfsOption()?"adv_setting":"summary";if("encryption"===e)return this.owner.encryptForm.findField("encryption").setValue(!0),"enc_setting";if("worm"===e){let e=this.owner.shareTab.getForm().findField("enable_recycle_bin");return e.getValue()?(this.owner.getMsgBox().confirm("",_T("share","share_worm_share_disable_recycle_bin"),(function(t){"yes"===t&&(e.setValue(!1),this.owner.encryptTab.getForm().findField("encryption").setValue(!1),this.owner.goNext("worm_setting"))}),this,{no:{text:_T("common","no")},yes:{text:_T("common","yes"),btnStyle:"blue"}}),!1):(this.owner.encryptTab.getForm().findField("encryption").setValue(!1),"worm_setting")}return!1}},t)),this.encryptTab=this.fillEncryptFormConfig(Ext.apply({headline:_T("share","share_tab_encryption"),itemId:"enc_setting",nextId:this.isShowBtrfsOption()?"adv_setting":"summary",getNext:function(){return!!this.getForm().isValid()&&this.nextId}},t)),this.wormTab=this.fillWormFormConfig(Ext.apply({headline:_T("share","share_worm_title"),itemId:"worm_setting",nextId:this.isShowBtrfsOption()?"adv_setting":"summary",getNext:function(){return!!this.getForm().isValid()&&this.nextId}},t)),this.advancedTab=this.fillAdvancedFormConfig(Ext.apply({headline:this.isHCM()?_T("share","create_wizard_quota"):_T("share","create_wizard_adv_setting"),itemId:"adv_setting",nextId:"summary",getNext:function(){return!!this.getForm().isValid()&&this.nextId}},t)),this.summary=new SYNO.SDS.AdminCenter.Share.CreateShareSummaryStep({headline:_T("share","create_wizard_confirm_setting"),description:"",module:this.module,owner:this,itemId:"summary",nextId:"sharegrid",getNext:function(){return this.owner.onApply(),!1}}),this.shareForm=this.shareTab.getForm(),this.dataProtectionForm=this.dataProtectionTab.getForm(),this.encryptForm=this.encryptTab.getForm(),this.wormForm=this.wormTab.getForm(),this.advancedForm=this.advancedTab.getForm(),this.gridPanel=new SYNO.SDS.Share.PermissionGrid({module:this.module,owner:this,itemId:"sharegrid",disabled:!1,hidden:!1,hideCustomColumn:!1,height:404,bwrapCfg:{cls:"x-panel-bwrap",style:"padding-top: 0px; padding-bottom: 0px;"},headline:_T("share","create_wizard_perm_setting"),description:"",getNext:function(){return this.owner.onPermissionWizardApply(),!1},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments),this.owner.getButton("back").hide(),this.owner.getButton("next").setText(_T("common","commit"))}}),this.formPanel=new SYNO.SDS.Share.AdvanceForm({module:this.module,owner:this,itemId:"advperm"});var i,s=function(e){return new Ext.Container({headline:e.headline,itemId:e.itemId,nextId:e.nextId,getNext:e.getNext.createDelegate(e),items:e})},n=Ext.apply({title:_T("share","create_wizard_title"),resizable:!1,width:800,height:585,cls:"syno-admincenter-share-create-wizard",steps:[this.shareTab,s(this.dataProtectionTab),s(this.encryptTab),s(this.wormTab),s(this.advancedTab),this.summary,(i=this.gridPanel,new SYNO.ux.Panel({headline:i.headline,itemId:i.itemId,nextId:i.nextId,getNext:i.getNext.createDelegate(i),checkState:i.checkState.createDelegate(i),items:i}))]},e);this.callParent([n]),SYNO.ux.AddTip(this.shareForm.findField("hide_unreadable").getEl(),_T("share","tip_hide_nonprivileged_folder")),this.dataProtectionForm.findFields("share_data_protection_radio").forEach((function(e){"worm"===e.inputValue&&SYNO.ux.AddTip(e.getEl(),_T("share","share_worm_disabled_tooltip"))})),this.isWormSupported()&&(SYNO.ux.AddTip(this.wormForm.findField("share_worm_def_lock_duration_unit").getEl(),_T("share","share_worm_def_lock_duration_tooltip")),SYNO.ux.AddTip(this.wormForm.findField("share_worm_def_lock_mode_combobox").getEl(),this.getDefLockModeTooltip())),this.supportBtrfs&&(this.dataIntegrityTooltip=SYNO.ux.AddTip(this.advancedTab.getForm().findField("enable_share_cow").getEl(),_T("share","share_integrity_protection_tip"))),this.loadData(),this.mon(this,"afterlayout",(function(e,t){this.blKeyManagerEnabled?(this.enableGroupDummy1=new SYNO.ux.Utils.EnableCheckGroup(this.encryptForm,"encryption",["enc_passwd","enc_passwd2","add_to_keymanager"],[]),this.ckg_keymanager=new SYNO.ux.Utils.EnableCheckGroup(this.encryptForm,"add_to_keymanager",["keymanager_cypher","keymanager_passphrase"],[])):this.enableGroupDummy1=new SYNO.ux.Utils.EnableCheckGroup(this.encryptForm,"encryption",["enc_passwd","enc_passwd2","add_to_keymanager"],[]),this.enableGroupDummy2=new SYNO.ux.Utils.EnableCheckGroup(this.shareForm,"enable_recycle_bin",["recycle_bin_admin_only"],[],{disable_group:!0}),this.wormAutoLockGroup=new SYNO.ux.Utils.EnableCheckGroup(this.wormForm,"share_worm_enable_auto_lock",["share_worm_lock_wait_time","share_worm_lock_wait_time_radio","share_worm_lock_wait_time_number","share_worm_lock_wait_time_unit","share_worm_def_lock_duration","share_worm_def_lock_duration_radio","share_worm_def_lock_duration_number","share_worm_def_lock_duration_unit","share_worm_def_lock_mode","share_worm_def_lock_mode_combobox","share_worm_note"],[]),new SYNO.ux.Utils.EnableRadioGroup(this.wormForm,"share_worm_lock_wait_time_radio",{period:["share_worm_lock_wait_time_number","share_worm_lock_wait_time_unit"],immediately:[]}),new SYNO.ux.Utils.EnableRadioGroup(this.wormForm,"share_worm_def_lock_duration_radio",{period:["share_worm_def_lock_duration_number","share_worm_def_lock_duration_unit"],forever:[]})}),this,{single:!0}),this.updateKeyManagerUI(),this.mon(this,"deactivate",this.deactivate,this),this.mon(this.shareForm.findField("vol_path"),"collapse",this.onLocationChange,this)},applyShareDialogFunctions:function(){var e=SYNO.SDS.AdminCenter.Share.Dialog.prototype;for(var t in e)e.hasOwnProperty(t)&&Ext.isFunction(e[t])&&!this.hasOwnProperty(t)&&(this[t]=e[t].createDelegate(this))},loadPermissionData:function(e){var t=e.get("vol_path")||e.get("real_path"),i=0===(t=t.toLowerCase()).indexOf("/volumeusb")||0===t.indexOf("/volumesd")||0===t.indexOf("/volumesata"),s=e.get("vol_path");s||(i?(s=e.get("real_path"),"yes"===_D("usbstation","no")&&(s=s.replace(/\/@sharebin\/.*/,""))):s=e.get("real_path").replace(e.get("path"),""),e.set("vol_path",s));var n=[{api:"SYNO.Core.Directory.LDAP",method:"get",version:1},{api:"SYNO.Core.Share",method:"get",version:1,params:{name:e.get("name"),additional:["disable_list","disable_modify","disable_download","unite_permission","is_aclmode"]}},{api:"SYNO.Core.Storage.Volume",method:"get",version:1,params:{volume_path:s}}];SYNO.API.GetKnownAPI("SYNO.Core.Directory.Domain")&&(n.push({api:"SYNO.Core.Directory.Domain",method:"get",version:1}),n.push({api:"SYNO.Core.Directory.Domain",method:"test_dc",version:1}),"yes"===_D("supportdomain")&&n.push({api:"SYNO.Core.Directory.Domain",method:"get_domain_list",version:2})),this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:n},scope:this,callback:function(t,i,s){if(this.clearStatusBusy(),t&&!i.has_fail){var n=SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Directory.Domain","get","enable_domain"),o=SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Directory.Domain","test_dc","test_join_success");n&&!o&&this.getMsgBox().alert("",_T("share","warning_directory_service_offline"));var a=SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Storage.Volume","get").volume;e.set("share_path",a.volume_path+"/"+e.get("name")),e.set("readonly",a.readonly),e.set("is_aclmode",SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Share","get","is_aclmode")),e.set("is_sync_share",SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Share","get","is_sync_share")),this.gridPanel.loadPermissions(e,i),this.goNext("sharegrid"),this.gridPanel.getTopToolbar().getComponent("search").updateElSize()}else{var r=SYNO.API.Response.GetFirstError(i);this.getMsgBox().alert("",SYNO.API.Errors.core[r.code]||_T("common","commfail"))}}})},onPermissionWizardApply:function(){if(this.gridPanel.isChanged()){var e=this.gridPanel.getWebAPI();SYNO.SDS.Share.PermissionDialog.prototype.sendApplyRequest.call(this,e)}else this.close()}}),Ext.define("SYNO.SDS.AdminCenter.Share.CreateShareSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(e){this.override({descRenderer:function(e,t,i,s,n,o){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"','<span class="wizard-summary-desc">'+e+"</span>"}}),this.callParent(arguments)},activate:function(){this.genSummary.call(this.owner,this.getStore()),this.getView().syncFocusEl(0),this.getView().refresh()},genSummary:function(e){var t=this,i=function(e){return t.shareForm.findField(e).getValue()},s=function(e){return t.wormForm.findField(e).getValue()},n=function(e){return t.wormForm.findField(e).getGroupValue()},o=function(e){return t.advancedForm.findField(e).getValue()},a=function(e){return e?_T("share","create_wizard_enabled"):""};e.removeAll(!0),e.append(_T("share","share_name"),i("name")),e.append(_T("share","share_comment"),Ext.util.Format.htmlEncode(i("desc")));var r=i("vol_path"),l=t.shareForm.findField("vol_path").getStore().getById(r).get("display");e.append(_T("volume","volume_share_position"),l);var d=i("hidden"),c=i("hide_unreadable"),h="";d&&c?h=_T("share","share_hide_in_windows")+"; "+_T("share","share_hide_without_perm"):(h+=d?_T("share","share_hide_in_windows"):"",h+=c?_T("share","share_hide_without_perm"):""),e.append(_T("share","share_visibility"),h);var u,p,_,m="";switch(i("enable_recycle_bin")&&(m=i("recycle_bin_admin_only")?_T("share","recycle_bin_enabled_admin_only"):_T("share","create_wizard_enabled")),e.append(_T("share","recycle_bin"),m),this.dataProtectionForm.findField("share_data_protection_radio").getGroupValue()){case"encryption":e.append(_T("share","share_encryption"),_T("common","enabled"));break;case"worm":var f=s("share_worm_enable_auto_lock"),S=String.format('<table border="0" cellspacing="0"><tr><td style="width:180px; padding: 8px 0px 8px 0px">{0}</td><td style="padding: 8px 0px 8px 0px">{1}</td></tr><tr><td style="width:180px; padding: 8px 0px 8px 0px">{2}</td><td style="padding: 8px 0px 8px 0px">{3}</td></tr>',_T("share","share_worm_mode")+_T("common","colon"),_T("share","share_worm_mode_"+s("share_worm_mode_combobox")),_T("share","share_worm_summary_auto_lock")+_T("common","colon"),f?(u=n("share_worm_lock_wait_time_radio"),p=s("share_worm_lock_wait_time_number"),_=s("share_worm_lock_wait_time_unit"),"immediately"===u?_T("share","share_worm_lock_wait_time_immediately"):"hours"===_?1===p?_T("share","share_worm_summary_wait_time_one_hour"):String.format(_T("share","share_worm_summary_wait_time_many_hours"),p):"days"===_?1===p?_T("share","share_worm_summary_wait_time_one_day"):String.format(_T("share","share_worm_summary_wait_time_many_days"),p):""):_T("common","disabled"));S+=f?String.format('<tr><td style="width:180px; padding: 8px 0px 8px 0px">{0}</td><td style="padding: 8px 0px 8px 0px">{1}</td></tr><tr><td style="width:180px; padding: 8px 0px 8px 0px">{2}</td><td style="padding: 8px 0px 8px 0px">{3}</td></tr></table>',_T("share","share_worm_def_lock_duration")+_T("common","colon"),function(e,t,i){return"forever"===e?_T("share","share_worm_def_lock_duration_forever"):"days"===i?1===t?_T("share","share_worm_summary_duration_one_day"):String.format(_T("share","share_worm_summary_duration_many_days"),t):"years"===i?1===t?_T("share","share_worm_summary_duration_one_year"):String.format(_T("share","share_worm_summary_duration_many_years"),t):""}(n("share_worm_def_lock_duration_radio"),s("share_worm_def_lock_duration_number"),s("share_worm_def_lock_duration_unit")),_T("share","share_worm_def_lock_mode")+_T("common","colon"),_T("share","share_worm_"+s("share_worm_def_lock_mode_combobox"))):"</table>",e.append(_T("share","share_worm_title"),S)}if(t.supportBtrfs&&(e.append(_T("share","share_cow"),a(o("enable_share_cow"))),e.append(_T("share","share_compression"),a(o("enable_share_compress")))),t.supportShareQuota){var g=o("enable_share_quota")?o("quota_value")+" "+o("quota_unit"):"";e.append(_T("share","create_wizard_quota"),g)}}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.Delete",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={cls:"x-window-dlg",padding:"24px 30px 0 30px",closable:!1,width:640,resizable:!1,draggable:!1,layout:"fit",elements:"body",autoHeight:!0,fbar:["->",{xtype:"syno_button",itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.close},{xtype:"syno_button",text:_T("common","delete"),itemId:"apply",btnStyle:"red",disabled:!0,scope:this,handler:this.onClickDelete}],items:[{xtype:"syno_formpanel",itemId:"deleteFormPanel",padding:"0px",autoHeight:!0,items:[{xtype:"syno_displayfield",name:"title",value:_T("share","share_delete"),itemCls:"share-delete-title",htmlEncode:!1},{xtype:"syno_displayfield",name:"message",htmlEncode:!1},{xtype:"syno_displayfield",name:"shares",htmlEncode:!1},{xtype:"syno_displayfield",name:"feasibility"},this.grid=new SYNO.SDS.Wizard.SummaryStep({layout:"fit",autoHeight:!0,columns:[{width:150,header:_T("share","share"),dataIndex:"key",renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',"<b>"+e+"</b>"}},{id:"value",autoExpand:!0,header:_T("common","action"),dataIndex:"value",scope:this,renderer:function(e,t,i,s,n,o){var a=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+a+'"',a}}]}),{xtype:"syno_checkbox",boxLabel:String.format('<span class="red-status">{0}</span>',e.alert_message?e.alert_message:_T("share","share_delete_confirm")),htmlEncode:!1,name:"confirm",listeners:{check:{scope:this,fn:this.onCheckboxCheck}}}]}]};return Ext.apply(t,e),t},updateGridCheckMsg:function(e,t){var i,s,n=this.grid.getStore();for(i=0;i<t.length;++i)s=SYNO.SDS.Utils.GetFeasibilityCheckMsg(t[i]),0===i?n.appendSub(e,s):n.appendSub("",s)},loadShareName:function(e,t){var i,s,n=this.getComponent("deleteFormPanel").getForm(),o=n.findField("message"),a=n.findField("feasibility"),r=this.shares.normal.concat(this.shares.c2),l=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Share","validate_delete"),d=SYNO.API.Response.GetValByAPI(t,"SYNO.C2FS.Share","validate_delete"),c={hard:{},soft:{}};if(r.length>5?(e=String.format(_T("share","share_cfrmrmv_num"),r.length),n.findField("shares").hide()):r.length>1?(e=_T("share","share_cfrmrmv_multiple"),n.findField("shares").setValue(String.format("<b>{0}</b>",Ext.util.Format.htmlEncode(r.join(", "))))):n.findField("shares").setValue(String.format("<b>{0}</b>",Ext.util.Format.htmlEncode(r.join(", ")))),o.setValue(e),!(l&&(l.hard||l.soft)&&void 0!==l||d&&(d.hard||d.soft)&&void 0!==d))return a.hide(),void this.grid.hide();for(s in l&&l.hard&&Object.keys(l.hard).forEach((function(e){c.hard[e]=l.hard[e]})),l&&l.soft&&Object.keys(l.soft).forEach((function(e){c.soft[e]=l.soft[e]})),d&&d.hard&&Object.keys(d.hard).forEach((function(e){c.hard[e]=d.hard[e]})),d&&d.soft&&Object.keys(d.soft).forEach((function(e){c.soft[e]=d.soft[e]})),0<Object.keys(c.hard).length?(a.setValue(_T("share","del_hard_check_fail")),i=c.hard,n.findField("message").hide(),n.findField("shares").hide(),n.findField("confirm").hide()):0<Object.keys(c.soft).length&&(a.setValue(_T("share","del_soft_check_fail")),i=c.soft),i)i.hasOwnProperty(s)&&this.updateGridCheckMsg(s,i[s])},onCheckboxCheck:function(e,t){this.getFooterToolbar().getComponent("apply").setDisabled(!t)},onClickDelete:function(){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.applySetting)},applySetting:function(){this.close(),this.submitDeleteShare()},filterOutTieringInNormal:function(){this.shares.normal=this.shares.normal.filter((function(e){return-1===this.shares.tiering.indexOf(e)}),this)},submitDeleteShare:function(){this.filterOutTieringInNormal(),this.module.appWin.setStatusBusy(null,_T("common","msg_waiting"));var e=[];0<this.shares.normal.length&&e.push({api:"SYNO.Core.Share",method:"delete",version:1,params:{name:this.shares.normal}}),0<this.shares.c2.length&&e.push({api:"SYNO.C2FS.Share",method:"delete",params:{name:this.shares.c2}}),0<this.shares.tiering.length&&e.push({api:"SYNO.Tiering.Share",method:"delete",version:1,params:{name:this.shares.tiering}}),this.sendWebAPI({compound:{mode:"parallel",params:e},timeout:6e5,version:1,scope:this,callback:this.afterDeleteShare})},afterDeleteShare:function(e,t,i){var s=[];this.module.appWin.clearStatus();var n=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Share","delete"),o=SYNO.API.Response.GetValByAPI(t,"SYNO.C2FS.Share","delete");if(t.has_fail&&n&&n.code)this.module.appWin.getMsgBox().alert("",SYNO.API.getErrorString(n.code));else{if(SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","delete"),this.module.store.load(),!n&&!o)return!0;var a={},r=n||{},l=o&&o.errors?o.errors:{};if(Object.keys(r).forEach((function(e){Array.isArray(r[e])&&(a[e]=r[e].concat(l[e]))})),Object.keys(l).forEach((function(e){Array.isArray(l[e])&&!a.hasOwnProperty(e)&&(a[e]=l[e])})),Object.keys(a).forEach((function(e){a[e]=a[e].filter((function(e){return e}))})),a.hasOwnProperty("warning_external")){var d=String.format("{0}<br><b>{1}</b><br>",_T("share","share_cannot_delete_for_reserved"),a.warning_external.join(", "));s.push(d)}if(a.hasOwnProperty("warning_mount_point")){var c=String.format("{0}<br><b>{1}</b><br>",_T("share","error_mount_point_delete"),a.warning_mount_point.join(", "));s.push(c)}if(a.hasOwnProperty("warning_volume_readonly")){const e=String.format("{0}<br><b>{1}</b><br>",_T("share","error_volume_read_only"),a.warning_volume_readonly.join(", "));s.push(e)}if(a.hasOwnProperty("warning_worm_snapshot")){var h=String.format("{0}<br><b>{1}</b><br>",_T("share","error_worm_snapshot"),a.warning_worm_snapshot.join(", "));s.push(h)}try{SYNO.SDS.C2FS.UtilForDSM.exclusiveDeleteErrorMsg(o).forEach((function(e){s.push(e)}))}catch(e){}0<s.length&&this.module.appWin.getMsgBox().alert("",s.join(""))}}}),Ext.define("SYNO.SDS.AdminCenter.Share.Move",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.formPanel=this.createFormPanel(e);var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={cls:"x-window-dlg",padding:"24px 30px 0",width:640,header:!1,autoHeight:!0,resizable:!1,draggable:!1,elements:"body",items:this.formPanel,fbar:["->",{xtype:"syno_button",text:_T("common","cancel"),itemId:"no",scope:this,handler:this.close},{xtype:"syno_button",text:e.msg.btn?e.msg.btn:_T("common","continue"),itemId:"yes",btnStyle:"warning"==e.msg.style?"red":"blue",disabled:!0,scope:this,handler:this.onClickMove}]};return Ext.apply(t,e),t},createFormPanel:function(e){var t={header:!1,trackResetOnLoad:!0,autoScroll:!0,autoHeight:!0,items:[{xtype:"syno_displayfield",name:"warning_msg",htmlEncode:!1},{xtype:"syno_checkbox",boxLabel:String.format('<span class="red-status">{0}</span>',_T("share","share_move_confirm")),htmlEncode:!1,name:"confirm",listeners:{check:{scope:this,fn:this.onCheckboxCheck}}}]};return new SYNO.SDS.Utils.FormPanel(t)},loadMessage:function(e){this.formPanel.getForm().findField("warning_msg").setValue(e)},onCheckboxCheck:function(e,t){this.getFooterToolbar().getComponent("yes").setDisabled(!t)},onClickMove:function(){this.callback.call(this.scope||window,"yes"),this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.Decrypt",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.shares=e.share,this.decrypt_by_km=e.decrypt_by_km,this.km_location=e.km_location;var t=this.fillConfig(e);this.callParent([t]),this.panel=this.getComponent("formpanel"),this.DefineBehaviors()},isStoreInRoot:function(){return this.km_location===SYNO.SDS.AdminCenter.Share.LocalStore},fillConfig:function(e){var t=this.isStoreInRoot()?[{xtype:"syno_radio",name:"decrypt_method",width:400,inputValue:"keymanager",boxLabel:_T("share","share_encryption_decrypt_by_keymanager_system_partition")},{xtype:"syno_textfield",textType:"password",name:"passphrase",maxLength:64,allowBlank:!0,hidden:!0}]:[{xtype:"syno_radio",name:"decrypt_method",width:200,inputValue:"keymanager",boxLabel:_T("share","share_encryption_decrypt_by_keymanager")+_T("common","colon")},{xtype:"syno_textfield",textType:"password",name:"passphrase",maxLength:64,allowBlank:!1}],i=new SYNO.SDS.Utils.FormPanel({itemId:"formpanel",trackResetOnLoad:!0,fileUpload:!0,webapi:{api:"SYNO.Core.Share.CryptoFile",method:"decrypt",version:1,scope:this},items:[{xtype:"container",layout:"column",hideLabel:!0,hidden:this.shares.length>1,items:[{xtype:"syno_radio",name:"decrypt_method",width:200,inputValue:"manual",boxLabel:_T("share","share_encryption_keyinput")+_T("common","colon"),checked:!0},{xtype:"syno_textfield",textType:"password",name:"passwd",maxLength:64,allowBlank:!1}]},{xtype:"syno_displayfield"},{xtype:"container",layout:"column",hideLabel:!0,hidden:this.shares.length>1,items:[{xtype:"syno_radio",name:"decrypt_method",width:200,inputValue:"keyfile",boxLabel:_T("share","share_encryption_importfrom")},{xtype:"syno_filebutton",allowBlank:!1,name:"password_file",textConfig:{width:192}}]},{xtype:"syno_displayfield"},{xtype:"container",layout:"column",hideLabel:!0,hidden:!this.decrypt_by_km,items:t},{xtype:"hidden",name:"name",value:this.shares[0].id}],onApiSuccess:this.onActionComplete,onApiFailure:this.onFormFailed}),s={width:600,height:260,minWidth:600,minHeight:230,title:_T("share","share_encryption_decrypt"),layout:"fit",items:i,keys:[{key:Ext.EventObject.ENTER,scope:this,handler:this.onSubmit}],buttons:[{itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.close},{itemId:"apply",btnStyle:"blue",text:_T("common","apply"),scope:this,handler:this.onSubmit}]};return Ext.apply(s,e),s},DefineBehaviors:function(){this.mon(this,"afterlayout",(function(e,t){var i=this.panel.getForm();new SYNO.ux.Utils.EnableRadioGroup(i,"decrypt_method",{manual:["passwd"],keyfile:["password_file"],keymanager:["passphrase"]})}),this,{single:!0})},onOpen:function(){this.callParent(arguments),this.panel.getForm().findField("passwd").focus(!1,100)},onSubmit:function(){var e=this.panel.getForm();if(e.isValid()){this.setStatusBusy({text:_T("common","msg_waiting")});var t=e.findField("decrypt_method").getGroupValue();if("keyfile"===t){if(!e.findField("password_file").getValue())return;this.get("formpanel").upload()}else if("manual"===t){var i=e.findField("passwd").getValue();if(!i)return;this.doSubmitEncryption(t,i)}else{var s=e.findField("passphrase").getValue();if(!s&&!this.isStoreInRoot())return;this.doSubmitByKeyManager(s)}}},doSubmitByKeyManager:function(e){for(var t=[],i=0;i<this.shares.length;i++)t.push(this.shares[i].json.uuid);this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Key",method:"mount",params:{uuid_array:t,passphrase:e},encryption:["passphrase"],version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.owner.getMsgBox().alert("",n),!1}this.module.getPanel().store.load(),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission"),this.close()}})},doSubmitEncryption:function(e,t){this.sendWebAPI({api:"SYNO.Core.Share.Crypto",method:"decrypt",params:{name:this.shares[0].id,password:t},encryption:["password"],version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.getMsgBox().alert("",n),!1}this.module.getPanel().store.load(),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission"),this.close()}})},onActionComplete:function(e,t,i){this.ownerCt.clearStatusBusy(),this.ownerCt.module.getPanel().store.load(),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission"),this.ownerCt.close()},onFormFailed:function(e,t,i){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.ownerCt.clearStatusBusy(),this.ownerCt.getMsgBox().alert("",n),!1}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.Export",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.share=e.share;var t=this.fillConfig(e);this.callParent([t]),this.panel=this.getComponent("formpanel")},fillConfig:function(e){var t=new SYNO.SDS.Utils.FormPanel({itemId:"formpanel",items:[{xtype:"syno_textfield",textType:"password",name:"passwd",width:200,minLength:8,maxLength:64,allowBlank:!1,fieldLabel:_T("share","share_encryption_keyinput"),validator:function(e){return-1===e.indexOf("=")&&-1===e.indexOf(",")||_T("share","encryption_password_invalid")}}]}),i={width:500,height:200,minWidth:500,minHeight:200,title:_T("share","share_encryption_exportkey"),layout:"fit",items:t,buttons:[{itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.close},{itemId:"apply",text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onSubmit}]};return Ext.apply(i,e),i},startDownload:function(){var e=this.panel.getForm();synowebapi.download({api:"SYNO.Core.Share.Crypto.Key",method:"export",version:1,params:{name:this.share.id,password:e.findField("passwd").getValue()},encryption:["password"]}),this.close.defer(4e3,this)},onSubmit:function(){var e=this.panel.getForm();e.isValid()&&(this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.Crypto.Key",method:"verify",version:1,params:{name:this.share.id,password:e.findField("passwd").getValue()},encryption:["password"],callback:function(e,t,i){e?this.startDownload():(this.clearStatusBusy(),this.setStatusError({text:SYNO.API.getErrorString(t),clear:!0}))},scope:this}))}}),Ext.ns("SYNO.SDS.AdminCenter.Share.Utils"),SYNO.SDS.AdminCenter.Share.Utils.GetServiceI18N=function(e){var t=[];return-1!=e.lastIndexOf(":")?(t=e.split(":"),_T(t[0],t[1])):e},SYNO.SDS.AdminCenter.Share.Utils.convertBoolPermissions=function(e){return e.data.is_deny?"na":e.data.is_custom?"cu":e.data.is_writable?"rw":e.data.is_readonly?"ro":"-"},SYNO.SDS.AdminCenter.Share.Utils.colorizePermission=function(e){var t=function(e,t){return String.format("<font class='{0}-status'><p>{1}</p></font>",e,t)};switch(e){case"cu":return t("black",_T("share","share_permission_custom")||"Custom");case"na":return t("red",_T("share","share_permission_none"));case"rw":return t("orange",_T("share","share_permission_writable"));case"ro":return t("blue",_T("share","share_permission_readonly"));case"default":return t("black",_T("common","default"));default:return e}},SYNO.SDS.AdminCenter.Share.Utils.GetPackageName=function(e){return"media"===e?_T("welcome","welcome_package_mediaserver"):"audio"===e?_T("welcome","welcome_package_audio"):"itune"===e?_T("firewall","firewall_service_desc_itunes"):"photo"===e?_T("welcome","welcome_package_photo"):"surveillance"===e?_T("tree","leaf_surveillance"):"web"===e?_T("tree","leaf_web"):"netbackup"===e?_T("service","service_rsync"):e},SYNO.SDS.AdminCenter.Share.Utils.ShowHelpCallback=function(e){return function(t){var i=t.el.query("a");if(i[0]){var s=Ext.fly(i[0]),n=function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:String.format("SYNO.SDS.AdminCenter.Application:{0}",e)},!1)};s.addKeyListener(Ext.EventObject.SPACE,n,this),s.addKeyListener(Ext.EventObject.ENTER,n,this),this.mon(s,"click",n,this)}}},SYNO.SDS.AdminCenter.Share.Utils.LinkRender=function(e,t){const i='<span id="'+e+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">';return String.format(t,i,"</span>")},Ext.define("SYNO.SDS.AdminCenter.Share.Utils.PermissionColumn",{extend:"Ext.grid.Column",constructor:function(e){var t=Ext.apply({width:120,align:"center",renderer:this.colorize},e);this.callParent([t])},colorize:function(e,t,i,s,n,o){return SYNO.SDS.AdminCenter.Share.Utils.colorizePermission(Ext.isFunction(this.convert)?this.convert(i):e)}}),Ext.namespace("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.SortButton",{extend:"SYNO.ux.Button",constructor:function(e){var t,i=this;i.appWin=e.appWin,i.owner=e.owner,t={itemId:"sort",tooltip:_T("pkgmgr","sort"),iconCls:"syno-sm-sort-btn",menu:{defaults:{checked:!1},cls:"syno-ux-check-menu",items:e.menuItems,show:function(e,t,s){var n=i.owner.store.getSortState();this.floating?(this.parentMenu=s,this.el||(this.render(),this.doLayout(!1,!0)),this.items.each((function(e){e.setChecked(e.sortField===n.field)}),this),this.showAt(this.el.getAlignToXY(e,t||this.defaultAlign,this.defaultOffsets),s)):Ext.menu.Menu.superclass.show.call(this)}},listeners:{menuhide:function(){i.focus()}}},i.callParent([t])},getMenuClass:function(){return""}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.ListView",{extend:"SYNO.ux.ExpandableListView",constructor:function(e){var t;t={innerTpl:this.createInnerTpl(),useARIA:!0,trackResetOnLoad:!1,cls:"syno-admincenter-share-listview"},this.callParent([Ext.apply(t,e)])},defaultC2ShareTpl:function(){return(new Ext.XTemplate).html},defaultC2ShareInnerTpl:function(){return(new Ext.XTemplate).html},reloadTpl:function(){this.innerTpl=this.createInnerTpl(),this.tpl=this.createTpl({}),this.refresh()},createTpl:function(e){var t=e.toggleWrapCls||this.toggleWrapCls;return new Ext.XTemplate('<tpl for=".">','<div class="item-wrap {cls}" role="option" aria-expanded="false" id={[Ext.id()]} aria-label="{ariaInfo}">','<div class="item-summary">','<div class="item-icon {iconCls}"></div>','<div class="sm-list-status-icon {statusIconCls}"></div>',"<div>",'<span class="item-title {titleCls}">{title}</span>','<span class="{tagCls}">{tag}</span>','<tpl if="0 !== condition.length">',' - <span class="{conditionCls}">{condition}</span>',"</tpl>","<div>",'<span class="item-status {statusCls}">{status}</span>','<tpl if="true === is_c2_share">',SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.C2FS.Application")&&SYNO.SDS.C2FS&&SYNO.SDS.C2FS.UtilForDSM&&Ext.isFunction(SYNO.SDS.C2FS.UtilForDSM.c2ShareTpl)?SYNO.SDS.C2FS.UtilForDSM.c2ShareTpl():this.defaultC2ShareTpl(),"</tpl>","</div>","</div>",this.innerTpl?'<div class="'+t+'"><div class="item-toggle-img"></div></div>':"","</div>",'<div class="item-detail" style="display:none">',this.innerTpl?this.innerTpl.html:"","</div>","</div>","</tpl>",'<div class="x-clear"></div>')},createInnerTpl:function(){var e='<dt class="share-info share-info-title">{0}</dt>',t='<dt class="share-info share-info-value">{0}</dt>';return new Ext.XTemplate('<tpl for=".">',"<dl>",String.format(e,_T("share","share_comment")+_T("common","colon")),String.format(t,"{desc:htmlEncode}"),"</dl>",'<div class="x-clear"></div>','<tpl if="true === is_c2_share">',SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.C2FS.Application")&&SYNO.SDS.C2FS&&SYNO.SDS.C2FS.UtilForDSM&&Ext.isFunction(SYNO.SDS.C2FS.UtilForDSM.c2ShareInnerTpl)?SYNO.SDS.C2FS.UtilForDSM.c2ShareInnerTpl():this.defaultC2ShareInnerTpl(),"</tpl>",'<tpl if="false === is_c2_share">','<div class="x-clear"></div>',"<dl>",String.format(e,_T("share","share_advance_permissions")+_T("common","colon")),String.format(t,"{unite_permission}"),"</dl>",'<div class="x-clear"></div>',"<dl>",String.format(e,_T("share","recycle_bin")+_T("common","colon")),String.format(t,"{enable_recycle_bin}"),"</dl>",'<div class="x-clear"></div>','<tpl if="true == is_support_quota">',"<dl>",String.format(e,_T("share","share_quota")+_T("common","colon")),String.format(t,"{quota_value}"),"</dl>",'<div class="x-clear"></div>',"<dl>",String.format(e,_T("share","share_size")+_T("common","colon")),String.format(t,"{share_quota_used}"),"</dl>",'<div class="x-clear"></div>',"</tpl>",'<tpl if="true == is_enc_share">',"<dl>",String.format(e,_T("share","share_encryption")+_T("common","colon")),String.format(t,"{enable_encryption}"),"</dl>",'<div class="x-clear"></div>',"</tpl>",'<tpl if="true == is_worm_share">',"<dl>",String.format(e,_T("share","share_worm_title")+_T("common","colon")),String.format(t,"{enable_worm}"),"</dl>",'<div class="x-clear"></div>',"</tpl>",'<tpl if="true == is_btrfs_share">',"<dl>",String.format(e,_T("share","share_compression")+_T("common","colon")),String.format(t,"{enable_share_compress}"),"</dl>",'<div class="x-clear"></div>',"<dl>",String.format(e,_T("share","share_cow")+_T("common","colon")),String.format(t,"{enable_share_cow}"),"</dl>",'<div class="x-clear"></div>',"</tpl>",'<tpl if="true == is_force_readonly">',"<dl>",String.format(e,_T("common","readonly")+_T("common","colon")),String.format(t,"{force_readonly_reason}"),"</dl>",'<div class="x-clear"></div>',"</tpl>",'<tpl if="true == is_tierfs_share">',"<dl>",String.format(e,_T("share","share_tiering")+_T("common","colon")),String.format(t,"{enable_share_tiering}"),"</dl>",'<div class="x-clear"></div>',"</tpl>","</tpl>","</tpl>")}}),Ext.namespace("SYNO.SDS.AdminCenter.Share.Migrate"),Ext.define("SYNO.SDS.AdminCenter.Share.Migrate.WelcomePanel",{extend:"SYNO.SDS.Wizard.WelcomeStep",targetShare:[],originShare:[],callbacks:null,constructor:function(e){var t=Ext.apply({headline:_T("sharemigrate","welcome_title"),description:_T("sharemigrate","welcome_desc")},e);SYNO.LayoutConfig.fill(t),this.callParent([t]),this.originShare=this.callbacks.getTargetShare().slice(0)},activate:function(){SYNO.SDS.Wizard.WelcomeStep.prototype.activate.apply(this,arguments),this.targetShare=this.originShare.slice(0)},getNext:function(){return this.owner.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Share.Migration",version:1,method:"check",params:{shares:this.originShare},scope:this,callback:function(e,t,i,s){if(this.owner.clearStatusBusy(),!1===e&&t&&t.errors){var n=t.errors.fail_shares,o=t.errors.migrated_before,a=t.errors.acl_exceed,r=t.errors.not_support,l=t.errors.cifs_share,d=t.errors.service_share,c=t.errors.umount_enc,h="";h=o?_T("sharemigrate","migrated_share"):a?String.format("{0} ({1})",_T("sharemigrate","acl_exceed"),_T("acl_editor","acl_rules_reach_limit_report").split("/")[1].trim().replace("_maxCount_","200")):r?_T("sharemigrate","not_support"):l?_T("sharemigrate","cifs_share"):d?_T("sharemigrate","unsupport_service_share"):c?_T("sharemigrate","umount_enc"):_T("sharemigrate","unknown_error"),this.owner.getMsgBox().alert(_T("sharemigrate","title"),h),this.removeFailShare(n)}this.callbacks.setTargetShare(this.targetShare),0<this.targetShare.length&&this.owner.goNext(this.nextId),this.targetShare=this.originShare.slice(0)}}),!1},removeFailShare:function(e){Ext.each(e,(function(e,t,i){var s=this.targetShare.indexOf(e);-1<t&&this.targetShare.splice(s,1)}),this)}}),Ext.define("SYNO.SDS.AdminCenter.Share.Migrate.SelectMethodPanel",{extend:"SYNO.ux.FormPanel",targetShare:[],pollingTaskId:null,suggestionTaskId:null,pBar:null,constructor:function(e){var t,i;this.pBar=new Ext.ProgressBar(Ext.apply({xtype:"progress",name:"progress_bar",value:0},e)),this.targetShare=e.callbacks.getTargetShare(),i=_T("sharemigrate","recommand_yes")+"<p>"+_T("sharemigrate","description_yes")+"</p>",t=Ext.apply({height:300,headline:_T("sharemigrate","replace_all"),items:[this.pBar,{xtype:"syno_radio",htmlEncode:!1,boxLabel:i,name:"mode",hidden:!0,itemId:"replace_yes",inputValue:0},{xtype:"syno_radio",htmlEncode:!1,boxLabel:_T("sharemigrate","recommand_no")+"<p>"+_T("sharemigrate","description_no")+"</p>",name:"mode",hidden:!0,itemId:"replace_no",inputValue:1},{xtype:"syno_checkbox",itemId:"confirm_migrate",htmlEncode:!1,boxLabel:'<div style="color: red;">'+_T("sharemigrate","caution")+"</div>",hideLabel:!0,listeners:{check:{scope:this,fn:this.onCheckboxCheck}}}]},e),SYNO.LayoutConfig.fill(t),this.callParent([t])},onCheckboxCheck:function(e,t){this.owner.getButton("next").setDisabled(!t)},activate:function(){this.beforeSuggestion(),this.pBar.progressBar.setStyle({height:this.pBar.getHeight().toString()+"px"}),this.pBar.textEl.setStyle({height:this.pBar.getHeight().toString()+"px",width:this.pBar.getWidth().toString()+"px"})},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments),this.owner.getButton("next").setText(_T("common","alt_start")),1==this.targetShare.length&&"web"===this.targetShare[0]?(this.items.get("replace_yes").disable(),this.items.get("replace_no").setValue(!0),this.afterSuggestion()):this.checkSuggestion()},beforeSuggestion:function(){this.pBar&&this.items&&(this.pBar.show(),this.items.get("replace_yes").hide(),this.items.get("replace_no").hide(),this.items.get("confirm_migrate").hide())},afterSuggestion:function(){this.pBar&&this.items&&(this.pBar.hide(),this.items.get("replace_yes").show(),this.items.get("replace_no").show(),this.items.get("confirm_migrate").show())},checkSuggestion:function(){this.owner.getButton("back").disable(),this.owner.getButton("next").disable(),this.sendWebAPI({webapi:{api:"SYNO.Core.Share.Migration",version:1,method:"start",scope:this,params:{polling:"suggestion",shares:this.callbacks.getTargetShare()},callback:function(e,t,i,s){if(!e||!t||!t.task_id)return this.owner.getMsgBox().alert(_T("sharemigrate","title"),_T("common","error_system")),this.owner.getButton("back").enable(),!1;this.suggestionTaskId=t.task_id,this.pollingTaskId=this.pollReg({interval:1,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Share.Migration",method:"status",version:1,params:{polling:"suggestion",task_id:this.suggestionTaskId}},status_callback:this.pollingSuggestion})}}})},pollingSuggestion:function(e,t,i,s){var n=1,o=0,a=0,r=0,l="",d=null;return e&&t?(t.data&&((d=t.data).total&&d.done&&d.share&&(n=d.total,o=d.done),r=100*o/n,l=String.format('<div style="text-align: center;"> {0} {1} % </div>',_T("usb","usb_st_fsck"),Math.round(r)),this.pBar.updateProgress(o/n,l)),t.finish?(t.data&&void 0!==t.data.suggestion&&this.items&&(this.pBar.hide(),0===(a=t.data.suggestion)?(this.items.get("replace_yes").setValue(!0),this.afterSuggestion()):1===a&&(this.items.get("replace_no").setValue(!0),this.afterSuggestion())),this.pollUnreg(this.pollingTaskId),this.stopPolling(),this.owner.getButton("back").enable(),void this.owner.doLayout()):void 0):(this.pollUnreg(this.pollingTaskId),this.owner.getButton("back").enable(),!1)},stopPolling:function(){this.sendWebAPI({webapi:{api:"SYNO.Core.Share.Migration",version:1,method:"stop",scope:this,params:{polling:"suggestion"}}})},migrateStart:function(){var e=parseInt(this.getForm().getValues().mode,10);this.sendWebAPI({webapi:{api:"SYNO.Core.Share.Migration",version:1,method:"start",scope:this,params:{polling:"migrate",shares:this.callbacks.getTargetShare(),migrate_method:e},callback:function(e,t,i,s){if(this.owner.clearStatusBusy(),!e||!t||!t.task_id)return this.owner.getMsgBox().alert(_T("sharemigrate","title"),_T("common","error_system")),!1;this.callbacks.setTaskId(t.task_id),this.callbacks.setMigrating(!0),this.owner.goNext(this.nextId)}}})},getNext:function(){return this.owner.setStatusBusy(),this.sendWebAPI({webapi:{api:"SYNO.Core.Share.Migration.Task",version:1,method:"list",scope:this,params:{polling:"migrate"},callback:function(e,t,i,s){return e?t&&t.admin?(this.owner.getMsgBox().alert(_T("sharemigrate","title"),_T("sharemigrate","wait_migrate")),this.owner.clearStatusBusy(),!1):void this.migrateStart():(this.owner.clearStatusBusy(),!1)}}}),!1}}),Ext.define("SYNO.SDS.AdminCenter.Share.Migrate.ProgressPanel",{extend:"SYNO.ux.FormPanel",pBar:null,pollingTaskId:null,callbacks:null,constructor:function(e){var t;this.pBar=new Ext.ProgressBar(Ext.apply({xtype:"progress",name:"progress_bar",height:20},e)),t=Ext.apply({headline:_T("sharemigrate","progress_headline"),height:300,items:[this.pBar]},e),SYNO.LayoutConfig.fill(t),this.callParent([t])},activate:function(){this.pBar.progressBar.setStyle({height:this.pBar.getHeight().toString()+"px"}),this.pBar.textEl.setStyle({height:this.pBar.getHeight().toString()+"px",width:this.pBar.getWidth().toString()+"px"}),this.pollingTaskId=this.pollReg({interval:1,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Share.Migration",method:"status",version:1,params:{polling:"migrate",task_id:this.callbacks.getTaskId()}},status_callback:this.pollingUpdate})},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments),this.owner.getButton("back").hide(),this.owner.getButton("next").disable(),this.owner.getButton("next").setText(_T("common","finish"))},pollingUpdate:function(e,t,i,s){var n=1,o=0,a="",r=null;return e&&t?(t.data&&((r=t.data).total&&r.done&&r.share&&(n=r.total,o=r.done),a=r.path?Ext.util.Format.ellipsis(r.path,55):"",this.pBar.updateProgress(o/n,a)),t.finish?(this.pollUnreg(this.pollingTaskId),this.pBar.updateProgress(100,_T("common","finish")),this.owner.getButton("next").enable(),this.callbacks.setMigrating(!1),this.callbacks.setFinish(!0),void this.stopPolling()):void 0):(this.pollUnreg(this.pollingTaskId),this.owner.getMsgBox().alert(_T("sharemigrate","title"),_T("sharemigrate","fail")),this.callbacks.setMigrating(!1),!1)},stopPolling:function(){this.sendWebAPI({webapi:{api:"SYNO.Core.Share.Migration",version:1,method:"stop",scope:this,params:{polling:"migrate"}}})},getNext:function(){return this.nextId}}),Ext.define("SYNO.SDS.AdminCenter.Share.Migrate.Wizard",{extend:"SYNO.SDS.Wizard.ModalWindow",targetShare:[],panelWelcome:null,panelSelectMethod:null,panelProgress:null,taskId:null,caller:null,migrating:!1,finish:!1,constructor:function(e){var t=this;this.owner=e.owner,this.module=e.module,this.targetShare=e.targetShare,this.caller=e.caller,this.panelWelcome=new SYNO.SDS.AdminCenter.Share.Migrate.WelcomePanel({itemId:"welcome",owner:this,callbacks:{getTargetShare:function(){return t.getTargetShare()},setTargetShare:function(e){return t.setTargetShare(e)}},nextId:"select"}),this.panelSelectMethod=new SYNO.SDS.AdminCenter.Share.Migrate.SelectMethodPanel({itemId:"select",owner:this,callbacks:{setTaskId:function(e){return t.setTaskId(e)},getTargetShare:function(){return t.getTargetShare()},setMigrating:function(e){return t.setMigrating(e)}},nextId:"progress"}),this.panelProgress=new SYNO.SDS.AdminCenter.Share.Migrate.ProgressPanel({itemId:"progress",owner:this,callbacks:{getTargetShare:function(){return t.getTargetShare()},getTaskId:function(){return t.getTaskId()},setMigrating:function(e){return t.setMigrating(e)},setFinish:function(e){return t.setFinish(e)}},nextId:null});var i=[this.panelWelcome,this.panelSelectMethod,this.panelProgress],s=Ext.apply({title:_T("sharemigrate","title"),dd:!0,width:600,height:500,resizable:!0,steps:i},e);this.callParent([s]),this.setStatusBusy(),this.sendWebAPI({webapi:{api:"SYNO.Core.Share.Migration.Task",version:1,method:"list",scope:this,params:{polling:"migrate"},callback:function(e,t,i,s){if(this.clearStatusBusy(),!e)return!1;t&&(t.data&&t.data.shares&&this.setTargetShare(t.data.shares),t.admin&&(this.owner.getMsgBox().alert(_T("sharemigrate","title"),_T("sharemigrate","go_migrate")),this.setTaskId(t.admin),this.goNext("progress")))}}})},getTaskId:function(){return this.taskId},setTaskId:function(e){return this.taskId=e,!0},getTargetShare:function(){return this.targetShare},setTargetShare:function(e){return this.targetShare=e,!0},setMigrating:function(e){return this.migrating=e,!0},setFinish:function(e){return this.finish=e,!0},onClose:function(){return!this.migrating&&(!0===this.finish&&this.caller.store.load(),SYNO.SDS.AdminCenter.Share.Migrate.Wizard.superclass.onClose.apply(this,arguments))}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.KeyManagerGrid",{extend:"SYNO.ux.EditorGridPanel",passphrase:"",constructor:function(e){var t={title:_T("keymanager","app_title"),module:this,header:!1,border:!1,height:404,width:750,ds:this.createStore(e),cm:this.createColumnModel(),selModel:new Ext.grid.RowSelectionModel({singleSelect:!1}),autoExpandColumn:"description",tbar:this.createTBar(),plugins:[this.enableColumn]};Ext.apply(t,e),this.callParent([t]),this.defineBehaviors()},onSelectionChange:function(){0===this.getSelectionModel().getSelections().length?(this.actionGroup.disable("export"),this.actionGroup.disable("encryption"),this.actionGroup.disable("delete")):(this.actionGroup.enable("export"),this.actionGroup.enable("encryption"),this.actionGroup.enable("delete"))},defineBehaviors:function(){this.mon(this.getSelectionModel(),"selectionchange",this.onSelectionChange,this)},createColumnModel:function(){this.enableColumn=new SYNO.ux.EnableColumn({header:_T("share","common_automount"),dataIndex:"auto_mount",enableFastSelectAll:!0,renderer:function(e,t,i){return 1===i.get("encrypt_type")?SYNO.ux.EnableColumn.prototype.renderer.call(this,e,t,i):SYNO.SDS.Share.renderCheckBox.call(this,"disabled",t,i)},isIgnore:function(e,t){return 1!==t.get("encrypt_type")}});var e=[{header:_T("share","share"),dataIndex:"share_name",id:"share_name"},{header:_T("keymanager","common_status"),dataIndex:"share_status",id:"share_status",renderer:function(e,t,i){return"mount"===e?_T("share","share_encryption_decrypt"):"umount"===e?_T("share","share_encryption_encrypt"):"unencrypted"===e?_T("keymanager","common_unencrypted"):_T("keymanager","common_unknown")}},{header:_T("share","share_comment"),dataIndex:"description",id:"description",editor:new SYNO.ux.TextField({allowBlank:!0})},{header:_T("keymanager","common_cypher"),dataIndex:"encrypt_type",id:"encrypt_type",renderer:function(e,t,i){return 0===e?_T("keymanager","common_passphrase"):1===e?_T("keymanager","common_machinekey"):_T("keymanager","common_unknown_cypher")}},this.enableColumn];return new Ext.grid.ColumnModel({defaults:{sortable:!1,width:150},columns:e})},createStore:function(e){var t={api:"SYNO.Core.Share.KeyManager.Key",method:"list",version:1,appWindow:e.owner,baseParams:{},listeners:{scope:this,beforeload:function(){this.owner.setStatusBusy({text:_T("common","loading")})},load:function(){this.onSelectionChange(),this.owner.clearStatusBusy()},exception:function(e,t,i,s,n,o){this.owner.clearStatusBusy(),SYNO.Debug("Store exception: ",e,t,i,s,n,o)}},root:"keys",totalProperty:"total",id:"share_name",fields:["share_name","share_status","description","encrypt_type","auto_mount"],remoteSort:!1,defaultSortable:!0,pruneModifiedRecords:!0,scope:this};return new SYNO.API.JsonStore(t)},isSHA:function(){return _S("ha_running")},isAHA:function(){return"yes"===_D("support_dual_head","no")},createTBar:function(){var e=new Ext.Action({text:_T("common","add"),itemId:"add",scope:this,handler:this.addHandler}),t=new Ext.Action({text:_T("share","share_encryption_exportkey"),itemId:"export",scope:this,handler:this.confirmExport}),i=new Ext.Action({text:_T("share","share_encryption_decrypt"),itemId:"mount",scope:this,handler:this.mountHandler}),s=new Ext.Action({text:_T("share","share_encryption_encrypt"),itemId:"umount",scope:this,handler:this.umountHandler}),n=new SYNO.ux.SplitButton({text:_T("share","share_encryption"),itemId:"encryption",scope:this,handler:this.mountHandler,menu:{items:[i,s]}}),o=new Ext.Action({text:_T("common","delete"),itemId:"delete",scope:this,handler:this.deleteHandler}),a=new Ext.Action({text:_T("common","configure"),itemId:"configure",scope:this,handler:this.configureHandler}),r=this.isSHA()||this.isAHA(),l=new Ext.Action({text:_T("iscsilun","clone"),itemId:"clone",scope:this,hidden:!r,handler:this.cloneHandler});return this.actionGroup=new SYNO.ux.Utils.ActionGroup([e,t,n,o,a,l]),new Ext.Toolbar({defaultType:"syno_button",items:[this.actionGroup.getArray()]})},addHandler:function(){new SYNO.SDS.AdminCenter.Share.AddKey({keys:this.getStore().data.keys,module:this.module,owner:this.owner,shares:this.shares,passphrase:this.passphrase,storeInRoot:this.storeInRoot}).open()},configureHandler:function(){new SYNO.SDS.AdminCenter.Share.StoreConfig({module:this.module,owner:this.owner,shares:this.shares,passphrase:this.passphrase,storeInRoot:this.storeInRoot}).open()},multiSelHandler:function(e){var t=this.getSelectionModel().getSelections();if(0!==t.length){for(var i=[],s=0;s<t.length;s++)"mount"==e?"umount"==t[s].json.share_status&&i.push(t[s].json.share_uuid):"umount"==e?"mount"==t[s].json.share_status&&i.push(t[s].json.share_uuid):i.push(t[s].json.share_uuid);0!==i.length&&(this.owner.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Key",method:e,params:{uuid_array:i,passphrase:this.passphrase},encryption:["passphrase"],version:1,scope:this,callback:function(e,t,i){if(this.owner.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.owner.getMsgBox().alert("",n),!1}this.getStore().load()}}))}},deleteHandler:function(){this.multiSelHandler("delete")},mountHandler:function(){this.multiSelHandler("mount")},umountHandler:function(){this.multiSelHandler("umount")},confirmExport:function(){this.owner.getMsgBox().confirm("",_T("keymanager","warning_wait_for_key_export"),(function(e){"yes"===e&&this.exportHandler()}),this)},exportHandler:function(){var e=this.getSelectionModel().getSelections();if(0!==e.length){for(var t=[],i=0;i<e.length;i++)t.push(e[i].json.share_uuid);synowebapi.download({api:"SYNO.Core.Share.KeyManager.Key",method:"export",version:1,params:{uuid_array:t,passphrase:this.passphrase},encryption:["passphrase"]})}},cloneDialog:function(e,t){new SYNO.SDS.AdminCenter.Share.CloneStore({module:this.module,owner:this.owner,shares:this.shares,storeShare:this.storeShare,passphrase:this.passphrase,machineUuid:t,machineKey:e}).open()},replaceWebapi:function(e){var t={remote_api:e.api,remote_method:e.method,remote_version:e.version,remote_params:e.params};return e.api="SYNO.SHA.Util",e.method="send_remote_webapi",e.version=1,e.params=t,e},cloneHandler:function(){if(!this.isSHA()&&!this.isAHA())return!1;var e={api:"SYNO.Core.Share.KeyManager.MachineKey",method:"get",version:1,scope:this,callback:function(e,t,i){if(this.owner.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.getMsgBox().alert("",n),!1}this.cloneDialog(t.public_key,t.machine_uuid)}};this.owner.setStatusBusy({text:_T("common","msg_waiting")}),this.isSHA()?this.sendWebAPI(this.replaceWebapi(e)):this.sendWebAPI(e)}}),Ext.define("SYNO.SDS.AdminCenter.Share.KeyManager",{extend:"SYNO.SDS.ModalWindow",passphrase:"",constructor:function(e){this.module=e.module,this.owner=e.owner,this.shares=e.shares;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.gridKeyManager=new SYNO.SDS.AdminCenter.Share.KeyManagerGrid({module:this.module,owner:this,appWin:this,shares:this.shares});var t={width:700,height:500,minWidth:500,minHeight:200,title:_T("keymanager","app_title"),layout:"fit",items:this.gridKeyManager,buttons:[{itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.onCancel},{itemId:"apply",text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onSubmit}],closeAction:"onCancel"};return Ext.apply(t,e),t},hasModification:function(){return 0!==this.gridKeyManager.getStore().getModifiedRecords().length},onSendWebAPI:function(e){this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Key",method:"set",version:1,params:{key_array:e,passphrase:this.passphrase},encryption:["passphrase"],callback:function(e,t,i){this.clearStatusBusy(),e?this.close():this.setStatusError({text:SYNO.API.getErrorString(t),clear:!0})},scope:this})},onSubmit:function(){var e=this.gridKeyManager.getStore().getModifiedRecords();if(0!==e.length){for(var t=[],i=!1,s=0;s<e.length;s++){var n=e[s].data;n.share_uuid=e[s].json.share_uuid,n.auto_mount&&(i=!0),t.push(n)}!this.storeInRoot&&i?this.getMsgBox().confirm("",_T("share","notice_service_dependency"),(function(e){"yes"===e&&this.onSendWebAPI(t)}),this):this.onSendWebAPI(t)}else this.close()},onCancel:function(){this.hasModification()?(this.isClosing=!0,this.getMsgBox().confirm("",_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this)):this.close()},updatePassphrase:function(){void 0===this.passphrase||""===this.passphrase?(this.gridKeyManager.mask(),this.close()):(this.gridKeyManager.passphrase=this.passphrase,this.gridKeyManager.storeShare=this.storeShare,this.gridKeyManager.getStore().load())},launchPassphraseVerify:function(){var e=new SYNO.SDS.AdminCenter.Share.KeyManagerVerify({owner:this});this.mon(e,"close",this.updatePassphrase,this,{single:!0}),e.open()},onActivate:function(){this.callParent(arguments),this.isClosing?this.isClosing=!1:this.passphrase||this.poped||this.storeInRoot?(this.gridKeyManager.getStore().load(),this.gridKeyManager.storeInRoot=this.storeInRoot):(this.launchPassphraseVerify(),this.poped=!0)}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.KeyManagerVerify",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.panelPassphraseVerify=this.createPanel(e);var t={width:500,height:200,minWidth:500,minHeight:200,title:_T("keymanager","win_title_passphrase_verify"),layout:"fit",items:this.panelPassphraseVerify,buttons:[{itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.onCancel},{itemId:"apply",text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onSubmit}],closeAction:"onCancel"};return Ext.apply(t,e),t},createPanel:function(e){var t={title:_T("keymanager","win_title_passphrase_verify"),itemId:"passphraseForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:350,trackResetOnLoad:!0,items:[{xtype:"syno_textfield",name:"passphrase",fieldLabel:_T("keymanager","common_passphrase"),textType:"password",minLength:8,maxLength:64,width:180,allowBlank:!1}]};return Ext.apply(t,e),new SYNO.SDS.Utils.FormPanel(t)},onActivate:function(){this.callParent(arguments),function(){var e=this.panelPassphraseVerify.getForm();e.clearInvalid(),e.findField("passphrase").focus()}.defer(300,this)},onSubmit:function(){var e=this.panelPassphraseVerify.getForm().findField("passphrase").getValue();this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Store",method:"verify",params:{passphrase:e},encryption:["passphrase"],version:1,scope:this,callback:function(t,i,s){if(this.clearStatusBusy(),t)this.owner.storeShare=i.store_share,this.owner.passphrase=e,this.close();else{var n=SYNO.API.Response.GetFirstError(i),o=SYNO.API.Errors.core[n.code]||_T("keymanager","error_invalid_passphrase");this.getMsgBox().alert("",o)}}})},onCancel:function(){this.owner.isClosing=!0,this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.AddKey",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.shares=e.shares,this.passphrase=e.passphrase,this.storeInRoot=e.storeInRoot,this.keys=e.keys;var t=this.fillConfig(e);this.callParent([t]),this.DefineBehaviors()},fillConfig:function(e){this.panelNewKey=this.createPanel(e);var t={width:600,height:450,minWidth:500,minHeight:200,title:_T("keymanager","win_title_new_key"),layout:"fit",items:this.panelNewKey,buttons:[{itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.close},{itemId:"apply",text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onSubmit}]};return Ext.apply(t,e),t},createPanel:function(e){for(var t=[],i=0;i<this.shares.length;i++){var s=this.shares[i].data,n=this.keys.indexOf(s.name)>=0;s.encryption&&!n&&t.push([s.name,s.name])}var o=new Ext.data.ArrayStore({fields:["value","display"],data:t}),a={xtype:"syno_fieldset",title:_T("keymanager","fs_encryption_share"),collapsible:!1,items:[{xtype:"syno_combobox",name:"share_name",fieldLabel:_T("share","share"),labelWidth:200,displayField:"display",valueField:"value",store:o,value:0!==t.length?t[0][0]:"",allowBlank:!1},{xtype:"hidden",name:"__cIpHeRtExT"}]},r={xtype:"syno_fieldset",title:_T("keymanager","fs_encryption_key"),collapsible:!1,items:[{xtype:"container",layout:"column",hideLabel:!0,items:[{xtype:"syno_radio",name:"decrypt_method",width:200,inputValue:"manual",boxLabel:_T("share","share_encryption_keyinput")+_T("common","colon"),checked:!0},{xtype:"syno_textfield",textType:"password",name:"share_password",minLength:8,maxLength:64,allowBlank:!1,validator:function(e){return-1===e.indexOf("=")&&-1===e.indexOf(",")||_T("share","encryption_password_invalid")}}]},{xtype:"syno_displayfield"},{xtype:"container",layout:"column",hideLabel:!0,items:[{xtype:"syno_radio",name:"decrypt_method",width:200,inputValue:"keyfile",boxLabel:_T("share","share_encryption_importfrom")},{xtype:"syno_filebutton",allowBlank:!1,name:"share_password_file",textConfig:{width:184}}]}]},l=new Ext.data.ArrayStore({fields:["value","display"],data:this.storeInRoot?[[1,_T("keymanager","common_machinekey")]]:[[0,_T("keymanager","common_passphrase")],[1,_T("keymanager","common_machinekey")]]}),d={xtype:"syno_fieldset",title:_T("keymanager","fs_encryption_cypher"),collapsible:!1,items:[{xtype:"syno_combobox",name:"share_cypher",fieldLabel:_T("keymanager","common_cypher"),labelWidth:200,displayField:"display",valueField:"value",store:l,value:1}]},c={title:_T("keymanager","win_title_new_key"),itemId:"newkeyForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:350,trackResetOnLoad:!0,fileUpload:!0,webapi:{api:"SYNO.Core.Share.KeyManager.Key",method:"add_by_file",version:1,scope:this},onApiSuccess:this.onActionComplete,onApiFailure:this.onFormFailed,items:[a,d,r]};return Ext.apply(c,e),new SYNO.SDS.Utils.FormPanel(c)},DefineBehaviors:function(){this.mon(this,"afterlayout",(function(e,t){var i=this.panelNewKey.getForm();new SYNO.ux.Utils.EnableRadioGroup(i,"decrypt_method",{manual:["share_password"],keyfile:["share_password_file"]}),SYNO.ux.AddTip(this.panelNewKey.getForm().findField("share_cypher").getEl(),_T("keymanager","tip_cypher"))}),this,{single:!0})},onSubmit:function(){var e=this.panelNewKey.getForm();if(e.isValid()){var t=e.findField("share_name").getValue(),i=e.findField("decrypt_method").getGroupValue();if("keyfile"===i){if(!e.findField("share_password_file").getValue())return;this.encryptPassphrase()}else{var s=e.findField("share_cypher").getValue(),n=e.findField("share_password").getValue();if(!n)return;this.doSubmitEncryption(t,s,i,n)}}},encryptPassphrase:function(){SYNO.API.currentManager.requestAPI("SYNO.API.Encryption","getinfo",1,{format:"module"},this.onEncryptData,this)},onEncryptData:function(e,t,i){e&&(SYNO.Encryption.CipherKey=t.cipherkey,SYNO.Encryption.RSAModulus=t.public_key,SYNO.Encryption.CipherToken=t.ciphertoken,SYNO.Encryption.TimeBias=t.server_time-Math.floor(+new Date/1e3));var s={passphrase:JSON.stringify(this.passphrase)},n=SYNO.Encryption.EncryptParam(s),o=this.get("newkeyForm"),a=n[t.cipherkey]||"";o.getForm().findField("__cIpHeRtExT").setValue(a),o.upload()},doSubmitEncryption:function(e,t,i,s){this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Key",method:"add",params:{share_name:e,share_cypher:t,share_password:s,passphrase:this.passphrase},encryption:["share_password","passphrase"],version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.getMsgBox().alert("",n),!1}this.close()}})},onActionComplete:function(e,t,i){this.ownerCt.clearStatusBusy(),this.ownerCt.module.getPanel().store.load(),this.ownerCt.close()},onFormFailed:function(e,t,i){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.ownerCt.clearStatusBusy(),this.ownerCt.getMsgBox().alert("",n),!1}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.KeyMigrateGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){var t={module:this,header:!1,border:!1,height:250,padding:0,ds:this.createStore(e),cm:this.createColumnModel(),autoExpandColumn:"share_status"};Ext.apply(t,e),this.callParent([t])},createColumnModel:function(){var e=[{header:_T("share","share"),dataIndex:"share_name",id:"share_name"},{header:_T("common","status"),dataIndex:"share_status",id:"share_status"}];return new Ext.grid.ColumnModel({defaults:{sortable:!1,width:150},columns:e})},createStore:function(e){var t={api:"SYNO.Core.Share.KeyManager.AutoKey",method:"list",version:1,appWindow:e.owner,baseParams:{},listeners:{scope:this,beforeload:function(){this.owner.setStatusBusy({text:_T("common","loading")})},load:function(){this.owner.clearStatusBusy()},exception:function(e,t,i,s,n,o){this.owner.clearStatusBusy(),SYNO.Debug("Store exception: ",e,t,i,s,n,o)}},root:"keys",id:"share_name",fields:["share_name","share_status"],remoteSort:!1,defaultSortable:!0,scope:this};return new SYNO.API.JsonStore(t)}}),Ext.define("SYNO.SDS.AdminCenter.Share.KeyMigrate",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner;var t=this.fillConfig(e);this.callParent([t])},createPanel:function(e){this.gridMigrate=new SYNO.SDS.AdminCenter.Share.KeyMigrateGrid({module:this.module,owner:this,appWin:this});var t={border:!1,frame:!1,autoScroll:!0,header:!1,height:250,trackResetOnLoad:!0,padding:0,items:[{xtype:"syno_checkbox",name:"overwrite",boxLabel:_T("keymanager","ckbox_conflict_policy")},this.gridMigrate]};return Ext.apply(t,e),new SYNO.SDS.Utils.FormPanel(t)},fillConfig:function(e){this.panel=this.createPanel(e);var t={width:600,height:400,minWidth:500,minHeight:200,title:_T("keymanager","title_automount_migration"),layout:"fit",items:[this.panel],buttons:[{itemId:"cancel",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{itemId:"apply",text:_T("common","alt_apply"),scope:this,btnStyle:"blue",handler:this.onSubmit}]};return Ext.apply(t,e),t},onSubmit:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.AutoKey",method:"migrate",params:{overwrite:this.panel.getForm().findField("overwrite").getValue()},version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.getMsgBox().alert("",n),!1}this.close()}})},onCancel:function(){this.close()},onActivate:function(){this.callParent(),this.gridMigrate.getStore().load()}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.StoreConfig",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.shares=e.shares,this.storeInRoot=e.storeInRoot,this.passphrase=e.passphrase,this.shareList=[[SYNO.SDS.AdminCenter.Share.LocalStore,_T("system","system_volume")]];for(var t=0;t<this.shares.length;t++){var i=this.shares[t].data;"USB"!==i.external_dev_type&&"ESATA"!==i.external_dev_type&&"SDCARD"!==i.external_dev_type||this.shareList.push([i.vol_path,i.name])}var s=this.fillConfig(e);this.callParent([s]),this.DefineBehaviors()},fillConfig:function(e){this.panelStoreConfig=this.createPanel(e);var t={width:600,height:500,minWidth:500,minHeight:200,title:_T("keymanager","win_title_config"),layout:"fit",items:this.panelStoreConfig};return Ext.apply(t,e),t},createPanel:function(e){var t=new Ext.data.ArrayStore({fields:["value","display"],data:this.shareList}),i={xtype:"syno_fieldset",title:_T("common","common_settings"),collapsible:!1,items:[{xtype:"syno_combobox",name:"keystore_path",labelWidth:200,fieldLabel:_T("keymanager","store_location"),displayField:"display",valueField:"value",store:t,value:0!==this.shareList.length?this.shareList[0][0]:""},{xtype:"syno_checkbox",name:"eject_after_boot",boxLabel:_T("keymanager","eject_after_boot")},{xtype:"syno_checkbox",name:"change_passphrase",boxLabel:_T("keymanager","ckbox_change_passphrase")},{xtype:"syno_textfield",name:"passphrase",fieldLabel:_T("keymanager","common_new_passphrase"),textType:"password",minLength:8,maxLength:64,labelWidth:200,width:200,allowBlank:!1,indent:1},{xtype:"syno_textfield",name:"passphrase2",fieldLabel:_T("keymanager","common_new_passphrase_confirm"),textType:"password_confirm",confirmFor:"passphrase",maxlength:64,labelWidth:200,width:200,allowBlank:!1,indent:1}]},s={xtype:"syno_fieldset",title:_T("keymanager","fs_autokey_migrate"),itemId:"fs_migrate",hidden:!0,collapsible:!1,items:[{xtype:"syno_displayfield",value:_T("keymanager","ckbox_automount_migration")},{xtype:"syno_button",text:_T("keymanager","common_migrate"),scope:this,handler:this.onMigrate}]},n={title:_T("keymanager","win_title_config"),itemId:"storeconfigForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:300,trackResetOnLoad:!0,webapi:{api:"SYNO.Core.Share.KeyManager.Store",methods:{get:"get",set:"set"},version:1},processReturnData:function(e,t,i){var s=this.getForm();i&&Ext.isArray(i.compound)&&s.loadRecords(t.result,i.compound);var n=SYNO.SDS.AdminCenter.Share.LocalStore===s.findField("keystore_path").getValue();s.findField("eject_after_boot").setDisabled(n),s.findField("change_passphrase").setDisabled(n)},items:[i,s],buttons:[{xtype:"syno_button",btnStyle:"grey",itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",btnStyle:"blue",itemId:"apply",text:_T("common","apply"),scope:this,handler:this.onSubmit}],closeAction:"onCancel"};return Ext.apply(n,e),new SYNO.SDS.Utils.FormPanel(n)},DefineBehaviors:function(){this.mon(this,"afterlayout",(function(e,t){this.panelStoreConfig.getForm().findField("keystore_path").on("select",(function(){var e=this.panelStoreConfig.getForm(),t=SYNO.SDS.AdminCenter.Share.LocalStore===e.findField("keystore_path").getValue();e.findField("eject_after_boot").setDisabled(t),e.findField("change_passphrase").setDisabled(t),e.findField("change_passphrase").setValue(!t)}),this),this.dummy=new SYNO.ux.Utils.EnableCheckGroup(this.panelStoreConfig.getForm(),"change_passphrase",["passphrase","passphrase2"],[])}),this,{single:!0}),this.showLegacyAutoKeyMigrate()},showLegacyAutoKeyMigrate:function(){this.panelStoreConfig.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.AutoKey",method:"list",version:1,scope:this,callback:(e,t)=>{this.panelStoreConfig.clearStatusBusy();const i=this.panelStoreConfig.getComponent("fs_migrate");e&&i&&t.keys.length>0&&i.show()}})},onSubmit:function(){var e=this.panelStoreConfig.getForm();if(e.isDirty()){if(!e.isValid())return this.panelStoreConfig.setStatusError({text:_T("common","forminvalid"),clear:!1}),!1;if(this.storeInRoot&&SYNO.SDS.AdminCenter.Share.LocalStore!==e.findField("keystore_path").getValue()&&!1===e.findField("change_passphrase").getValue())return this.panelStoreConfig.setStatusError({text:_T("share","share_encryption_decrypt_by_keymanager"),clear:!1}),!1;var t=e.findField("passphrase").getValue(),i=e.findField("change_passphrase").getValue(),s={api:"SYNO.Core.Share.KeyManager.Store",method:"set",params:{eject_after_boot:e.findField("eject_after_boot").getValue()}},n={api:"SYNO.Core.Share.KeyManager.Store",method:"change_passphrase",params:{old_passphrase:this.passphrase,new_passphrase:t}},o={api:"SYNO.Core.Share.KeyManager.Store",method:"change_location",params:{old_passphrase:this.passphrase,new_passphrase:i?t:this.passphrase,old_location:this.location,new_location:e.findField("keystore_path").getValue()}},a=[s];e.findField("keystore_path").isDirty()?a.push(o):e.findField("change_passphrase").getValue()&&a.push(n),this.setStatusBusy(),this.sendWebAPI({compound:{mode:"sequential",stopwhenerror:!1,params:a},encryption:["old_passphrase","new_passphrase"],scope:this,callback:function(e,t,i,s){if(this.clearStatusBusy(),!e||t.has_fail){var n=SYNO.API.Response.GetFirstError(t),o=SYNO.API.Errors.core[n.code]||_T("common","error_system");return this.owner.getMsgBox().alert("",o),!1}for(var a=!1,r=0;r<i.compound.length;r++)if("SYNO.Core.Share.KeyManager.Store"===i.compound[r].api&&("change_passphrase"===i.compound[r].method||"change_location"===i.compound[r].method)){a=!0;break}a?this.getMsgBox().alert("",_T("keymanager","info_launch_keymanager"),(function(){this.owner.close()}),this):this.close()}})}else this.close()},onCancel:function(){this.panelStoreConfig.form.isDirty()?this.getMsgBox().confirm("",_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this):this.close()},onMigrate:function(){new SYNO.SDS.AdminCenter.Share.KeyMigrate({owner:this}).open()},onOpen:function(){this.callParent(),this.panelStoreConfig.loadForm()}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.InitStore",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.shares=e.shares,this.share_module=e.share_module,this.share_dialog=e.share_dialog,this.shareList=[];for(var t=0;t<this.shares.length;t++){var i=this.shares[t].data;"USB"!==i.external_dev_type&&"ESATA"!==i.external_dev_type&&"SDCARD"!==i.external_dev_type||this.shareList.push([i.vol_path,i.name])}var s=this.fillConfig(e);this.callParent([s]),this.showLegacyAutoKeyMigrate()},fillConfig:function(e){this.panelInitStore=this.createPanel(e);var t={width:600,height:450,minWidth:500,minHeight:200,title:_T("keymanager","win_title_init"),layout:"fit",items:this.panelInitStore,buttons:[{itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.onCloseWindow},{itemId:"apply",text:_T("keymanager","common_initialize"),scope:this,btnStyle:"blue",handler:this.onSubmit}],closeAction:"onCloseWindow"};return Ext.apply(t,e),t},showLegacyAutoKeyMigrate:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.AutoKey",method:"list",version:1,scope:this,callback:(e,t)=>{this.clearStatusBusy();const i=this.panelInitStore.getForm();e&&i&&t.keys.length>0&&i.findField("autokey_migrate").show()}})},onLocationClick:function(e,t){if(e.checked){var i=this.panelInitStore.getForm(),s="system"===e.value;i.findField("share").setDisabled(s),i.findField("passphrase").setDisabled(s),i.findField("passphrase2").setDisabled(s)}},createPanel:function(e){var t=new Ext.data.ArrayStore({fields:["value","display"],data:this.shareList}),i="yes"==_D("support_xa"),s={title:_T("keymanager","win_title_init"),itemId:"initstoreForm",border:!1,frame:!1,autoScroll:!0,header:!1,padding:"0px 0px 0px 0px",trackResetOnLoad:!0,items:[{xtype:"syno_displayfield",value:_T("keymanager","initialization_desc")},{xtype:"syno_displayfield",value:_T("keymanager","initialization_recommend_desc"),htmlEncode:!1,hidden:i},{xtype:"syno_displayfield",value:""},{xtype:"syno_displayfield",value:_T("keymanager","fs_store_location"),hidden:i},{xtype:"syno_radio",name:"key_store_location",width:420,inputValue:"external",boxLabel:_T("helptoc","device")+" ("+_T("common","recommend")+")",disabled:0===this.shareList.length,checked:0!==this.shareList.length,indent:1,handler:this.onLocationClick,scope:this,hidden:i},{xtype:"syno_combobox",name:"share",fieldLabel:_T("usb","usb_shname"),displayField:"display",valueField:"value",store:t,labelWidth:256,width:180,value:0!==this.shareList.length?this.shareList[0][0]:"",disabled:0===this.shareList.length,indent:2,hidden:i},{xtype:"syno_textfield",name:"passphrase",fieldLabel:_T("keymanager","common_passphrase"),textType:"password",minLength:8,maxLength:64,labelWidth:256,width:180,allowBlank:!1,disabled:0===this.shareList.length,indent:2,hidden:i},{xtype:"syno_textfield",name:"passphrase2",fieldLabel:_T("keymanager","common_passphrase_confirm"),textType:"password_confirm",confirmFor:"passphrase",maxlength:64,labelWidth:256,width:180,allowBlank:!1,disabled:0===this.shareList.length,indent:2,hidden:i},{xtype:"syno_radio",name:"key_store_location",width:420,inputValue:"system",boxLabel:_T("system","system_volume"),disabled:!1,checked:0===this.shareList.length,indent:1,handler:this.onLocationClick,scope:this,hidden:i},{xtype:"syno_checkbox",boxLabel:_T("keymanager","ckbox_automount_migration"),name:"autokey_migrate",hidden:!0,checked:!0}]};return Ext.apply(s,e),new SYNO.SDS.Utils.FormPanel(s)},doMigrate:function(){this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.AutoKey",method:"migrate",params:{overwrite:!0},version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.getMsgBox().alert("",n),!1}this.close()}})},onSubmit:function(){var e=this.panelInitStore.getForm();if(!e.isValid())return this.setStatusError({text:_T("common","forminvalid"),clear:!1}),!1;var t=e.findField("share").getValue();"system"===e.findField("key_store_location").getGroupValue()&&(t=SYNO.SDS.AdminCenter.Share.LocalStore);var i=e.findField("passphrase").getValue(),s=e.findField("autokey_migrate").getValue();this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Store",method:"init",params:{share_path:t,passphrase:i},encryption:["passphrase"],version:2,scope:this,callback:function(e,i,n){if(!e){this.clearStatusBusy();var o=SYNO.API.Response.GetFirstError(i),a=SYNO.API.Errors.core[o.code]||_T("common","error_system");return this.getMsgBox().alert("",a),!1}this.share_module.keyManagerEnabled=!0,this.share_module.keyManagerLocation=t,this.share_dialog&&(this.share_dialog.blKeyManagerEnabled=!0),s?this.doMigrate():(this.clearStatusBusy(),this.close())}})},onCloseWindow:function(){this.share_module.keyManagerEnabled=!1,this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.CloneStore",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.shares=e.shares,this.passphrase=e.passphrase,this.storeShare=e.storeShare,this.shareList=[];for(var t=0;t<this.shares.length;t++){var i=this.shares[t].data;("USB"===i.external_dev_type||"ESATA"===i.external_dev_type||"SDCARD"===i.external_dev_type)&&this.storeShare!==i.name&&this.shareList.push([i.name,i.name])}var s=this.fillConfig(e);this.callParent([s])},fillConfig:function(e){this.panelInitStore=this.createPanel(e);var t={width:600,height:400,minWidth:500,minHeight:200,title:_T("keymanager","win_title_init"),layout:"fit",items:this.panelInitStore,buttons:[{itemId:"apply",text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onSubmit},{itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.close}]};return Ext.apply(t,e),t},createPanel:function(e){var t=new Ext.data.ArrayStore({fields:["value","display"],data:this.shareList}),i={xtype:"syno_fieldset",title:_T("keymanager","src_keystore"),collapsible:!1,items:[{xtype:"syno_displayfield",name:"src_share",fieldLabel:_T("share","share"),value:this.storeShare}]},s={xtype:"syno_fieldset",title:_T("keymanager","dst_keystore"),collapsible:!1,items:[{xtype:"syno_combobox",name:"dst_share",fieldLabel:_T("share","share"),displayField:"display",valueField:"value",store:t,value:0!==this.shareList.length?this.shareList[0][0]:""}]},n={title:_T("keymanager","win_title_init"),itemId:"initstoreForm",border:!1,frame:!1,autoScroll:!0,header:!1,height:350,trackResetOnLoad:!0,fileUpload:!0,items:[i,s]};return Ext.apply(n,e),new SYNO.SDS.Utils.FormPanel(n)},KeyDup:function(e,t){var i=this.panelInitStore.getForm(),s=i.findField("src_share").getValue(),n=i.findField("dst_share").getValue();this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Store",method:"clone",params:{src_share_name:s,dst_share_name:n,dst_machine_uuid:e,dst_public_key:t,passphrase:this.passphrase},encryption:["passphrase"],version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),!e){var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Errors.core[s.code]||_T("common","error_system");return this.getMsgBox().alert("",n),!1}this.close()}})},onSubmit:function(){this.KeyDup(this.machineUuid,this.machineKey)},onActivate:function(){0===this.shareList.length&&(this.panelInitStore.el.mask(_T("error","no_external_devices"),"syno-ux-mask-info"),this.getFooterToolbar().getComponent("apply").disable())}}),Ext.ns("SYNO.SDS.AdminCenter.Share.PermissionReport"),Ext.define("SYNO.SDS.AdminCenter.Share.PermissionReport.Dialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.callParent([this.fillConfig(e)]),this.getLastSavePath(),this.reportName="",this.reportSavePath.getEl().on("mouseup",this.selectPathHandler,this)},getLastSavePath:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Share.PermissionReport",version:1,method:"get_config",scope:this,callback:function(e,t,i){if(e){let e=t.last_save_path;e&&this.reportSavePath.setValue(e)}this.clearStatusBusy()}})},fillConfig:function(e){this.treePanel=new SYNO.SDS.AdminCenter.Share.PermissionReport.TreePanel(e);var t={title:_T("perm_report","export_report_title"),bodyStyle:"padding: 8px 20px 12px 20px",items:[{xtype:"syno_displayfield",value:_T("perm_report","export_folder_perm_title"),style:"font-weight:bold;"},{layout:"border",border:!1,style:"border: 1px solid rgba(198,212,224,0.50); border-radius: 4px; > .x-panel-bwrap { padding: 0 8px 8px 8px;}",flex:1,items:[this.treePanel]}],layout:{type:"vbox",align:"stretch",pack:"start"},height:500,width:600};return(t=Ext.apply(t,this.initFbar())).tbar=this.initToolbar(),Ext.apply(t,e)},onOpen:function(e){this.callParent(arguments),this.treePanel&&this.treePanel.load()},initToolbar:function(){return this.reportSavePath=new SYNO.ux.TextField({id:"syno-perm-report-save-path",fieldLabel:_T("common","folder"),width:365,readOnly:!0,allowBlank:!1,validateOnBlur:!0,blankText:_T("mediaservice","error_empty_path"),emptyText:_T("perm_report","save_path_placeholder")}),{xtype:"syno_toolbar",border:!1,style:{padding:"0 20px"},items:[{xtype:"syno_compositefield",items:[{xtype:"syno_displayfield",value:_T("perm_report","save_to")+_T("common","colon"),width:188},this.reportSavePath]}]}},selectPathHandler:function(){void 0===this.pathSelector&&(this.pathSelector=new SYNO.SDS.Utils.FileChooser.Chooser({parent:this,owner:this,closeOwnerWhenNoShare:!0,closeOwnerNumber:1,enumColdStorage:!0,enumC2Share:!0,needrw:!0,usage:{type:"chooseDir"},title:_T("mediaservice","select_folder"),folderToolbar:!0,listeners:{scope:this,choose:function(e,t,i){this.reportSavePath.setValue(t.fullpath),e.close()},close:function(){delete this.pathSelector}}})),this.pathSelector.show()},initFbar:function(){return{useStatusBar:!0,buttons:[{xtype:"syno_button",text:_T("common","cancel"),minWidth:80,autoHeight:!0,scope:this,handler:this.cancelHandler},{xtype:"syno_button",btnStyle:"blue",text:_T("autoblock","autoblock_export_ip_list"),minWidth:80,autoHeight:!0,scope:this,handler:this.applyHandler}]}},applyHandler:function(){if(!this.reportSavePath.isValid())return void this.setStatusError({text:_T("error","error_bad_field"),clear:!0});!1!==this.createReport()||this.setStatusError({text:_T("mediaservice","select_one"),clear:!0})},cancelHandler:function(){this.close()},createReport:function(){var e=[],t=this.reportSavePath.value;return this.treePanel.collectFolderList(e),0!==e.length&&(this.sendWebAPI({api:"SYNO.Core.Share.PermissionReport",version:1,method:"export",params:{folders:e,save_path:t},scope:this,callback:function(e,t,i){t.task_id&&t.bg_taskid&&e?(this.task_id=t.task_id,this.bg_taskid=t.bg_taskid,Ext.isDefined(t.filename)&&(this.reportName=t.filename),this.startExport()):this.showDebugMsgBox(_T("error","error_error_system"))}}),!0)},startExport:function(){this.getMsgBox().show({width:150,closable:!1,progress:!1,buttons:{ok:_T("common","hide"),cancel:_T("common","cancel")},fn:function(e,t,i){"ok"===e?(this.stopPermissionReportPolling(),this.closeMsgBox(),this.close()):this.stopExport()}.createDelegate(this),msg:_T("perm_report","exporting_desc"),scope:this}),this.module.panel.permission_report_export_pollingId=this.pollReg({webapi:{api:"SYNO.Core.Share.PermissionReport",method:"export_status",version:1,params:{task_id:this.task_id}},interval:2,immediate:!1,scope:this,status_callback:function(e,t,i,s){var n=t.data;if(e)if(t.finish||"success"===n.status)this.stopExport();else if("initializing"===n.status);else if("scanning"===n.status){let e=Ext.util.Format.number(n.output,"0,000"),t=String.format(_T("perm_report","export_progress_desc"),e),i=String.format("<div>{0}<br>{1}</div>",_T("perm_report","exporting_desc"),t);this.getMsgBox().updateProgress("","",i,!0)}else n.status,this.stopExport();else{let e=SYNO.API.getErrorString(t.code);this.getMsgBox().alert("",e,function(){this.stopExport()}.createDelegate(this))}}})},stopExport:function(){this.stopExportPermissionReport(),this.stopPermissionReportPolling(),this.closeMsgBox(),this.applyDone()},stopExportPermissionReport:function(){this.sendWebAPI({api:"SYNO.Core.Share.PermissionReport",version:1,method:"export_stop",params:{task_id:this.task_id,bg_taskid:this.bg_taskid},scope:this})},stopPermissionReportPolling:function(){this.module.panel.stopPermissionReportPolling()},closeMsgBox:function(){this.getMsgBox().getDialog().doClose()},applyDone:function(){this.close()},numberWithCommas:function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},showDebugMsgBox:function(e){this.getMsgBox().alert("",e,function(){this.closeMsgBox(),this.close()}.createDelegate(this))}}),Ext.define("SYNO.SDS.AdminCenter.Share.PermissionReport.TreePanel",{extend:"SYNO.ux.TreePanel",constructor:function(e){this.uiProvider=SYNO.SDS.AdminCenter.Share.PermissionReport.TreeNodeUI,this.callParent([this.fillConfig(e)]),this.mon(this,"checkchange",this.onCheckChange,this)},fillConfig:function(e){var t=new SYNO.SDS.AdminCenter.Share.PermissionReport.TreeLoader({owner:this,nodeUI:this.uiProvider}),i=Ext.apply({useArrows:!0,autoScroll:!0,border:!1,region:"center",containerScroll:!0,animate:!0,enableDD:!1,useGradient:!1,loader:t,rootVisible:!1,root:new Ext.tree.AsyncTreeNode({draggable:!1,id:"root"})},e);return Ext.apply(i,e)},load:function(){this.sendWebAPI({api:"SYNO.Core.File",method:"list",version:1,params:{needrw:!1,folder_path:"/",support_enum_cold_storage:!0,node:"fm_root"},callback:function(e,t,i){if(!e)return void this.getMsgBox().alert("",SYNO.API.getErrorString(t.code));let s=[];Ext.each(t,(function(e){Ext.isDefined(e.id)&&Ext.isDefined(e.path)&&s.push(e)}),this),this.createShareNode(s)},scope:this})},createShareNode:function(e){let t="fm_root_"+_S("hostname"),i=this.createTreeLoader(e);this.shareNode=t,this.root.appendChild({id:t,expanded:!0,leaf:!1,text:_S("hostname"),loader:i,checked:!1},this)},createTreeLoader:function(e){return new SYNO.SDS.AdminCenter.Share.PermissionReport.TreeLoader({owner:this,nodeData:e,nodeUI:this.uiProvider,sendWebAPI:this.sendWebAPI.createDelegate(this)})},onCheckChange:function(e){var t,i=e.getUI(),s=function(e){var t=0,i=0;return e.eachChild((function(e){var s=e.getUI()||{};s.checkbox&&Ext.isFunction(s.getCheckValue)&&(!1===s.getCheckValue()&&(i+=1),t+=1)})),0===t?e.getUI().getCheckValue():i!==t&&"gray"},n=function(e,t){e.eachChild((function(e){e.getUI().setCheckValue(t),n(e,t)}))};if(!1===(t=i.getCheckValue()))this.isShareNode(e)?i.setCheckValue("gray"):i.setCheckValue(!0),n(e,!0);else{if(!0!==t&&"gray"!==t)return void SYNO.Debug("Unexpected checked value: ",t);i.setCheckValue(!1),n(e,!1)}!function(e){for(var t,i,n,o=e.parentNode,a=!0;o&&(t=o.getUI())&&o.attributes&&o.attributes.hasOwnProperty("checked")&&(!0===(n=t.getCheckValue())||n===(i=s(o))?a=!1:(t.setCheckValue(i),o=o.parentNode),a););}(e)},isShareNode:function(e){return this.shareNode===e.id},collectFolderList:function(e){var t;t=this.getNodeById(this.shareNode),Ext.each(t.childNodes,(function(t){this.setFolderList(t,e)}),this)},setFolderList:function(e,t){var i;Ext.isDefined(e)&&Ext.isDefined(e.attributes)?(!0===e.attributes.checked&&(i=e.attributes.additional.real_path,i=e.expanded?i.concat("/"):i.concat("/*"),t.push(i)),("gray"===e.attributes.checked||!0===e.attributes.checked&&!0===e.expanded)&&Ext.each(e.childNodes,(function(e){this.setFolderList(e,t)}),this)):SYNO.Debug("In setFolderList, sth undefined: ",e)}}),Ext.define("SYNO.SDS.AdminCenter.Share.PermissionReport.TreeLoader",{extend:"Ext.tree.TreeLoader",constructor:function(e){this.dataUrl="dummy",this.callParent([e])},checkEncryption:function(e){if(Ext.isArray(e.encryption)&&!Ext.isEmpty(e.params))for(var t=e.encryption,i=0,s=t.length;i<s;i++)if(t[i]in e.params)return;delete e.encryption},requestData:function(e,t,i){if(this.nodeData&&-1!==this.owner.shareNode.indexOf(e.id))this.loadShareNode(e,this.nodeData,t,i);else if(Ext.isFunction(this.sendWebAPI)){var s={api:"SYNO.Core.File",method:"list",version:1,params:{filetype:"dir",folder_path:e.id.substr(e.id.indexOf("/")),needrw:!1,additional:["real_path","is_recycle_bin"],support_enum_cold_storage:!0,node:e.id,checked:e.getUI().getCheckValue()},argument:{callback:t,node:e,scope:i},callback:this.handleWebAPIResponse,scope:this};this.sendWebAPI(s)}else{if("root"===e.id)return;SYNO.Debug("Unexpected result in requestData of treeloader. nodeData: ",this.nodeData,", node ID: ",e.id,"not defined sendwebapi")}},loadShareNode:function(e,t,i,s){e.beginUpdate();for(var n=0,o=t.length;n<o;n++){var a=this.createNode(t[n]);a&&e.appendChild(a)}e.endUpdate(),this.runCallback(i,s||e,[e]),this.fireEvent("load",this,e,t)},handleWebAPIResponse:function(e,t,i,s){var n=s.argument,o=n.node,a={},r=!1;if(Ext.isDefined(t.files)&&(a=t.files),Ext.isDefined(i.checked)&&(r=i.checked),this.transId=!1,e){o.beginUpdate();for(var l=0,d=a.length;l<d;l++)if(!Ext.isDefined(a[l].additional)||!a[l].additional.is_recycle_bin){a[l].checked=r;var c=this.createNode(a[l]);c&&o.appendChild(c)}o.endUpdate(),this.runCallback(n.callback,n.scope||o,[o]),this.fireEvent("load",this,o,t)}else this.fireEvent("loadexception",this,o,t),this.runCallback(n.callback,n.scope||o,[o])},createNode:function(e){if(e.uiProvider||(e.uiProvider=this.nodeUI?this.nodeUI:"SYNO.SDS.AdminCenter.Share.PermissionReport.TreeNodeUI"),e.draggable=!1,e.leaf=!1,Ext.isDefined(e.text)&&e.text||(e.text=e.name),Ext.isDefined(e.additional)||(e.additional={},e.additional.real_path=e.path,e.additional.is_recycle_bin=!1),Ext.isDefined(e.id)||(e.id="remote"+e.path),Ext.isDefined(e.checked)||(e.checked=!1),!Ext.isFunction(this.createNodeFn)||!1!==this.createNodeFn.call(this.createNodeScope||this,e)){var t=this.callParent(arguments);return t}},onBeforeLoad:function(e,t,i){if(!0===t.disabled)return!1}}),Ext.define("SYNO.SDS.AdminCenter.Share.PermissionReport.TreeNodeUI",{extend:"Ext.tree.TreeNodeUI",renderElements:function(e,t,i,s){this.indentMarkup=e.parentNode?e.parentNode.ui.getChildIndent():"";var n,o=Ext.util.Format.htmlEncode,a=t.input,r=this.getHref(t.href),l=['<li class="x-tree-node syno-extended-tree-node"><div ext:tree-node-id="',o(e.id),'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',t.cls,'" unselectable="on">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img alt="" src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow" />','<img alt="" src="'+this.emptyIcon+'" class="syno-tree-node-cb syno-perm-report-tree-node-cb syno-ux-checkbox-icon" />','<img alt="" src="',t.icon||this.emptyIcon,'" class="x-tree-node-icon',t.icon?" x-tree-node-inline-icon":"",t.iconCls?" "+t.iconCls:"",'" unselectable="on" ',(t.icon||t.iconCls?"":'style="display: none;"')+"/>",'<a hidefocus="on" class="x-tree-node-anchor" href="',r,'" tabIndex="1" ',t.hrefTarget?' target="'+t.hrefTarget+'"':"",'><span unselectable="on">',o(e.text),"</span></a>","</div>",'<ul class="x-tree-node-ct" style="display:none;"></ul>',"</li>"].join("");!0!==s&&e.nextSibling&&(n=e.nextSibling.ui.getEl())?this.wrap=Ext.DomHelper.insertHtml("beforeBegin",n,l):this.wrap=Ext.DomHelper.insertHtml("beforeEnd",i,l),this.elNode=this.wrap.childNodes[0],this.ctNode=this.wrap.childNodes[1];var d=this.elNode.childNodes,c=0;this.indentNode=d[c++],this.ecNode=d[c++],this.checkbox=d[c++],this.iconNode=d[c++],(t.icon||t.iconCls)&&c++,this.anchor=d[c++],this.textNode=this.anchor.firstChild,a&&(this.createInputField(a,t,this.elNode),c++),this.syncCheckCssClass(),e.on("disabledchange",this.onDisabled,this)},onIdChange:function(e){var t=Ext.util.Format.htmlEncode;this.rendered&&this.elNode.setAttribute("ext:tree-node-id",t(e))},createInputField:function(e,t,i){var s=e;switch(Ext.isObject(e)?(this.inputConfig=Ext.apply({},e),s=e.xtype||"textfield",delete e.xtype):this.inputConfig={},Ext.isDefined(t.value)&&(this.inputConfig.value=t.value),this.inputConfig.renderTo=i,s){case"textfield":this.input=new SYNO.ux.TextField(this.inputConfig);break;case"numberfield":this.input=new SYNO.ux.NumberField(this.inputConfig)}},initEvents:function(){var e=this.callParent(arguments);return e},isDisabled:function(){return!0===this.node.disabled},onClick:function(e){if(!e.getTarget(".x-form-field"))return e.getTarget(".syno-tree-node-cb")&&this.toggleCheck(),this.callParent(arguments)},onDblClick:function(e){e.getTarget(".syno-tree-node-cb")||this.disabled||!1!==this.fireEvent("beforedblclick",this.node,e)&&(!this.animating&&this.node.isExpandable()&&this.node.toggle(),this.fireEvent("dblclick",this.node,e))},onDisabled:function(e,t){this.input&&(t?this.input.disable():this.input.enable()),this.checkbox&&(t?this.checkbox.classList.add("syno-ux-cb-disabled"):this.checkbox.classList.remove("syno-ux-cb-disabled"))},onCheckChange:function(){this.fireEvent("checkchange",this.node)},getExpanded:function(){return this.node.expanded},getCheckValue:function(){return this.node.attributes.checked},setCheckValue:function(e){this.node.disabled||e!==this.getCheckValue()&&(e="false"!==e&&"off"!==e&&"0"!==e&&("gray"===e?"gray":!!e),this.node.attributes.checked=e,this.syncCheckCssClass())},syncCheckCssClass:function(){var e=this.getCheckValue();this.checkbox&&(Ext.each(["checked","grayed","disabled"],(function(e){this.checkbox.classList.remove("syno-ux-cb-"+e)}),this),!0===e?this.checkbox.classList.add("syno-ux-cb-checked"):"gray"===e&&this.checkbox.classList.add("syno-ux-cb-grayed"),this.node.disabled&&this.checkbox.classList.add("syno-ux-cb-disabled"))}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.CleanHomeRecycleDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.panel=this.createFormPanel();let t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({title:_T("share","share_clean_recycle_bin"),autoDestroy:!0,width:500,height:250,resizable:!1,items:[this.panel],buttons:[{text:_T("common","cancel"),btnStyle:"grey",scope:this,handler:this.close},{btnStyle:"blue",itemId:"continue",text:_T("common","continue"),disabled:!0,scope:this,handler:this.apply}]},e)},createFormPanel:function(){let e={border:!1,autoHeight:!0,trackResetOnLoad:!0,items:[{xtype:"syno_displayfield",value:_T("share","clean_home_recycle_bin_select_desc")},{xtype:"syno_checkbox",name:"clean_homes_recycle_bin",boxLabel:_T("share","clean_homes_recycle_bin"),listeners:{check:{fn:this.onCheck,scope:this}}},{xtype:"syno_checkbox",name:"clean_home_recycle_bin",boxLabel:_T("share","clean_home_recycle_bin"),listeners:{check:{fn:this.onCheck,scope:this}}}]};return new SYNO.SDS.Utils.FormPanel(e)},onCheck:function(){let e=this.panel.getForm().findField("clean_home_recycle_bin").getValue()||this.panel.getForm().findField("clean_homes_recycle_bin").getValue();this.getFooterToolbar().getComponent("continue").setDisabled(!e)},apply:function(){let e=[];this.panel.getForm().findField("clean_home_recycle_bin").getValue()&&e.push({id:"home"}),this.panel.getForm().findField("clean_homes_recycle_bin").getValue()&&e.push({id:"homes"}),this.callback.call(this.owner,e),this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.Share.Snapshot"),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.ModalWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.customMask=e.customMask||!1,this.callParent(arguments)},setMaskMsgVisible:function(e){if(this.el.isMasked()){var t=Ext.Element.data(this.el,"maskMsg");t&&t.dom&&(t.setVisibilityMode(Ext.Element.VISIBILITY),t.setVisible(e))}},setMaskOpacity:function(e){SYNO.SDS.AppWindow.superclass.setMaskOpacity.call(this,e),this.setMaskMsgVisible(0!==e)},delayedMask:function(e,t,i,s){this.customMask||!this.getFooterToolbar()?(t=t||200,this.maskTask||(this.maskTask=new Ext.util.DelayedTask(this.setMaskOpacity,this,[e])),this.mask(0,i,s),this.setMaskMsgVisible(!1),this.maskTask.delay(t)):this.callParent(arguments)},setStatusBusy:function(e,t,i){this.customMask||!this.getFooterToolbar()?(e=e||{},Ext.applyIf(e,{text:_T("common","loading"),iconCls:"x-mask-loading"}),t=t||.4,i=i||400,this.delayedMask(t,i,e.text,e.iconCls),this.canClose=!1):this.callParent(arguments)},clearStatusBusy:function(e){this.customMask||!this.getFooterToolbar()?(this.unmask(),this.canClose=!0):this.callParent(arguments)}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.TakeSnapshot",{extend:"SYNO.SDS.AdminCenter.Share.Snapshot.ModalWindow",constructor:function(e){var t={width:450,height:250,resizable:!1,closeAction:"onCancel",buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{itemId:"btSave",xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:this,handler:this.onSave}],items:[this.createForm()]};this.callParent([Ext.apply(t,e)])},getForm:function(){return this.getComponent("snapshot").getForm()},onOpen:function(){this.callParent(arguments),this.initValues(),this.addTip()},addTip:function(){SYNO.ux.AddTip(this.getForm().findField("lock").getEl(),Ext.util.Format.htmlEncode(_T("iscsilun","snapshot_lock_notify")))},initValues:function(){this.isEditMode()&&this.getForm().setValues({desc:this.snapshot.get("desc"),lock:this.snapshot.get("lock")})},getShareSnapWebapiTpl:function(){return{api:"SYNO.Core.Share.Snapshot",version:1}},onSave:function(){var e={},t=[];if(this.getForm().isValid())if(!this.isEditMode()||this.getForm().isDirty()){e.desc=this.getForm().findField("desc").getValue(),e.lock=this.getForm().findField("lock").getValue(),this.setStatusBusy({text:_T("common","saving")}),this.getFooterToolbar().get("btSave")&&this.getFooterToolbar().get("btSave").disable();var i=e=>({snapinfo:e});if(this.isEditMode()){var s=i(e);s.name=this.shares.get("name"),s.snapshot=this.snapshot.get("time");var n=this.getShareSnapWebapiTpl();n.method="set",Ext.apply(n,s),t.push(n)}else this.isCreateMode()&&Ext.each(this.shares,(s=>{var n=i(e);Ext.apply(n,{name:s.get("name"),method:"create"});var o=this.getShareSnapWebapiTpl();Ext.apply(o,n),t.push(o)}));this.sendWebAPI({api:"SYNO.Entry.Request",version:2,method:"request",params:{mode:"parallel",compound:t},scope:this,callback:function(e,t,i){this.clearStatusBusy();if(!e||t.has_fail){var s=SYNO.SDS.AdminCenter.Share.Snapshot.Utils.checkShareSnapCompoundError(e,t,i),n=s.err_msg;s.err_target_names,this.owner.getMsgBox().alert(_T("snapmgr","app_title"),n),this.setStatusError({text:n,clear:!0})}else this.isCreateMode()&&i.compound&&i.compound.length>0&&this.fireEvent("take_snapshot_done",{num_share:i.compound.length});this.isDataChanged=!0,this.close()}})}else this.close()},onCancel:function(){this.getForm().isDirty()?this.getMsgBox().confirm(_T("iscsilun","take_snapshot"),_T("common","confirm_lostchange"),(e=>{"yes"===e&&this.close()}),this):this.close()},createForm:function(){return{xtype:"form",itemId:"snapshot",border:!1,trackResetOnLoad:!0,defaults:{width:250,labelWidth:150},items:[{xtype:"syno_textfield",name:"desc",itemId:"desc",maxlength:511,validator:function(e){return SYNO.SDS.AdminCenter.Share.Snapshot.Utils.ValidateByteCount(e,511)},fieldLabel:_T("share","share_comment")},{xtype:"syno_checkbox",name:"lock",itemId:"lock",boxLabel:_T("iscsilun","snapshot_lock"),checked:!0}]}},isCreateMode:function(){return"create"===this.mode},isEditMode:function(){return"edit"===this.mode}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.ManageSnapshot",{extend:"SYNO.SDS.AdminCenter.Share.Snapshot.ModalWindow",constructor:function(e){var t=this;t.appWin=e.appWin,t.owner=e.owner,t.share=e.share;var i={layout:"fit",items:[],minWidth:760,minHeight:450,width:760,height:450,closable:!0,border:!1,buttons:[{text:_T("common","close"),scope:this,handler:this.onCancel}]};t.callParent([Ext.apply(i,e)])},initComponent:function(){var e=this;e.items.push(e.createPanel()),e.callParent(arguments)},getGrid:function(){return this.get("snapshots")},getButton:function(e){return this.getGrid().getTopToolbar().get(e)},getSelections:function(){return this.getGrid().getSelectionModel().getSelections()},getSelected:function(){return this.getGrid().getSelectionModel().getSelected()},initEvents:function(){this.callParent(arguments),this.setLoadingMask(),this.getGrid().getStore().load({callback:function(){this.appOwner.clearLoadingMask()}})},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")}),this.loadingMask=!0},clearLoadingMask:function(){var e=this;!0===e.loadingMask&&(e.clearStatusBusy(),e.loadingMask=!1)},onSelectionChange:function(e){var t=this,i=e.getCount(),s=t.share.get("support_action"),n=t.share.get("volume_crashed");t.getButton("btDelete").disable(),t.getButton("btEdit").disable(),t.getButton("btBrowse").disable(),0!==i&&!n&&2&s&&t.getButton("btDelete").enable(),1===i&&(n?16&s&&t.share.get("enable_snapshot_browsing")&&t.getButton("btBrowse").enable():(t.getButton("btEdit").enable(),16&s&&t.getButton("btBrowse").enable()))},onCancel:function(){this.close()},createPanel:function(){var e=this,t=new SYNO.API.JsonStore({appWindow:e.appWin,appOwner:e,autoDestroy:!0,api:"SYNO.Core.Share.Snapshot",method:"list",version:2,baseParams:{name:e.share.get("name"),offset:0,limit:-1,filter:{attr:["!hide==true"]},additional:["desc","lock","schedule_snapshot"]},sortInfo:{field:"time",direction:"DESC"},fields:[{name:"time",sortType:function(e){return SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GetSnapTime({time:e},"share")}},"desc","lock","schedule_snapshot"],root:"snapshots",id:"time",listeners:{exception:{scope:e.owner,fn:function(t,i,s,n,o){var a=SYNO.SDS.AdminCenter.Share.Snapshot.ShareSnapGetErrMsg(o.code,this)||_T("common","error_system");e.getMsgBox().alert("Warning",a)}}}});e.store=t;var i=new Ext.grid.ColumnModel({defaults:{width:120,sortable:!1},columns:[{id:"time",header:_T("common","name"),dataIndex:"time"},{id:"time",header:_T("time","time_time"),dataIndex:"time",renderer:function(e,t,i){var s=new Date(SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GetSnapTime(i.data,"share"));return SYNO.SDS.DateTimeFormatter(s,{type:"datetimesec"})}},{id:"desc",header:_T("share","share_comment"),dataIndex:"desc",width:100,renderer:SYNO.SDS.AdminCenter.Share.Snapshot.Utils.TipRender},{id:"lock",header:_T("iscsilun","snapshot_lock"),width:60,dataIndex:"lock",renderer:SYNO.SDS.AdminCenter.Share.Snapshot.Utils.LockIconRenderer}]}),s=new Ext.Toolbar({defaultType:"syno_button",style:"padding: 8px 0px 8px 0px;",items:[{text:_T("download","upload_browse"),itemId:"btBrowse",handler:e.snapshotBrowse,disabled:!0,scope:e},{text:_T("common","remove"),itemId:"btDelete",handler:e.snapshotDelete,disabled:!0,scope:e},{text:_T("common","alt_edit"),itemId:"btEdit",handler:e.snapshotEdit,disabled:!0,scope:e},"->",new SYNO.ux.TextFilter({iconStyle:"search",itemId:"search",store:this.store,queryAction:"list",enumAction:"list",queryParam:"substr",pageSize:-1})]}),n=new SYNO.ux.PageLessToolbar({store:e.store,displayInfo:!0,showRefreshBtn:!0}),o={forceFit:!0,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(e){e.scrollTop=e.scroller.dom.scrollTop},refresh:function(e){e.scroller.dom.scrollTop=e.scrollTop}}};return{layout:"fit",xtype:"syno_gridpanel",itemId:"snapshots",style:{padding:"16px 20px 0px 20px"},tbar:s,bbar:n,store:t,colModel:i,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:e.onSelectionChange,scope:e}}),listeners:{scope:e,activate:e.onActivate,rowdblclick:{scope:e,fn:function(t,i,s){e.store.getAt(i)&&e.snapshotEdit()}}},enableHdMenu:!1,autoExpandColumn:"desc",viewConfig:o,enableColumnMove:!1,cls:"without-dirty-red-grid"}},snapshotBrowse:function(){var e=this,t=e.getSelected();e.setStatusBusy({text:_T("common","msg_waiting")}),e.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:"get_share_conf",version:1,params:{name:e.share.get("name"),sharesnapinfo:["enable_snapshot_browsing"]},callback:function(i,s,n){if(e.clearStatusBusy(),i){if(s.enable_snapshot_browsing)return void SYNO.SDS.AppLaunch("SYNO.SDS.App.FileStation3.Instance",{openfile:"/"+e.share.get("name")+"/#snapshot/"+t.get("time")+"/"});this.getMsgBox().confirm("Confirm",_T("sharesnap","snap_browse_msg"),(i=>{"yes"===i&&e.makeSnapshotBrowsable(t)}),e)}},scope:e})},makeSnapshotBrowsable:function(e){var t=this;t.setStatusBusy({text:_T("common","msg_waiting")}),t.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:"set_share_conf",version:1,params:{name:t.share.get("name"),sharesnapinfo:{enable_snapshot_browsing:!0}},callback:function(i,s,n){t.clearStatusBusy(),i&&SYNO.SDS.AppLaunch("SYNO.SDS.App.FileStation3.Instance",{openfile:"/"+t.share.get("name")+"/#snapshot/"+e.get("time")+"/"})},scope:t})},snapshotDelete:function(){var e=this,t=e.getSelections();if(!t)return;var i=[];const s=String.format("{0}<br>{1}",_T("common","remove_cfrmrmv"),_T("sharesanp","space_reclamation_warning"));t.forEach((e=>{i.push(e.get("time"))})),e.getMsgBox().confirmDelete(_T("common","remove"),s,(t=>{"yes"===t&&e.doSnapshotDelete(i)}),e)},doSnapshotDelete:function(e){var t=this;t.setStatusBusy({text:_T("common","msg_waiting")}),t.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:"delete",version:1,params:{name:t.share.get("name"),snapshots:e},timeout:Math.max(2e3*e.length,SYNO.SDS.AdminCenter.Share.Snapshot.WEBAPI_DEFAULT_TIMEOUT),callback:function(e,i,s){if(t.clearStatusBusy(),e){if(i&&0<i.length){new SYNO.SDS.AdminCenter.Share.Snapshot.MultiDeleteError({appWin:t.appWin,owner:t,title:_T("share","share_snapshot_delete_failed"),share:t.share,errorData:i}).open()}}else{var n=SYNO.SDS.AdminCenter.Share.Snapshot.ShareSnapGetErrMsg(i.code,this)||_T("common","error_system");t.getMsgBox().alert("warning_msg",n)}t.getGrid().getStore().load()},scope:t})},snapshotEdit:function(){var e=this.getSelected(),t=new SYNO.SDS.AdminCenter.Share.Snapshot.TakeSnapshot({appWin:this.appWin,owner:this,title:_T("common","alt_edit")+" - "+this.share.get("name"),mode:"edit",shares:this.share,snapshot:e});this.mon(t,"close",(()=>{t.isDataChanged&&(this.isDataChanged=!0,this.getGrid().getStore().load())}),this,{single:!0}),t.open()}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.Configure.Main",{extend:"SYNO.SDS.AdminCenter.Share.Snapshot.ModalWindow",constructor:function(e){var t=this;t.owner=e.owner,t.appWin=e.appWin;var i=[],s=!1,n=!1;t.isMultipleChoose=1<e.shares.length,i.push(new SYNO.SDS.AdminCenter.Share.Snapshot.Configure.Schedule({appWin:e.appWin,owner:t})),i.push(new SYNO.SDS.AdminCenter.Share.Snapshot.Configure.Retention({appWin:e.appWin,owner:t,showKeepAll:t.isMultipleChoose,isCreate:!1,hasBtrfsTarget:true})),i.push(new SYNO.SDS.AdminCenter.Share.Snapshot.Configure.AdvancedSettings.Share({appWin:e.appWin,owner:t,shares:e.shares})),t.tabPanel=new SYNO.SDS.Utils.TabPanel({appWin:e.appWin,owner:e.owner,activeTab:0,items:i});var o={items:[t.tabPanel],width:680,height:574,minWidth:680,minHeight:574,resizable:!1,buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:t,handler:t.onCancel},{xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:t,handler:t.onSave}]};t.callParent([Ext.apply(o,e)]),t.getSharedFolderScheData(),Ext.each(t.shares,(e=>{SYNO.SDS.AdminCenter.Share.Snapshot.Utils.IsShareDRSite(e)&&(s=!0),0!==e.get("encryption")&&(n=!0)}),t),s&&(t.tabPanel.get("scheduleSnapshot").setDisabled(!0),t.tabPanel.setActiveTab("retentionSnapshot")),s&&n&&t.tabPanel.get("advancedSettings").setDisabled(!0),e.selectTab&&t.tabPanel.setActiveTab(e.selectTab)},getForm:function(e){return this.tabPanel.getItem(e).getForm()},setTargetConf:function(){var e=this;e.setStatusBusy({text:_T("common","saving")}),e.setShareSchedulePromise().then(e.setAdvSettingsPromise.bind(e)).then(e.setRetentionPromise.bind(e)).then(e.updateShareListPanel.bind(e)).then((()=>{e.clearStatusBusy()}),(t=>{e.clearStatusBusy(),t&&0!==t.length&&e.getMsgBox().alert(_T("common","common_settings"),t)}))},onSave:function(){var e=this,t=e.tabPanel.get("retentionSnapshot");if(t.isValid()){var i=t.getRetention().policyType,s=e.getForm("scheduleSnapshot").findField("enable_schedule").getValue(),n=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_KEEP_ALL!==i&&SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ALL!==i,o=_T("common","common_settings"),a="";t.isDirty()?(a=_T("snapmgr","run_retention_immed"),e.getMsgBox().confirm(o,a,(t=>{"ok"===t&&e.setTargetConf()}),e,Ext.MessageBox.OKCANCEL)):s&&!n?(a=_T("snapmgr","ret_setting_remind"),e.getMsgBox().confirm(o,a,(t=>{"ok"===t?e.tabPanel.setActiveTab("retentionSnapshot"):e.setTargetConf()}),e,SYNO.SDS.AdminCenter.Share.Snapshot.MessageBox.OKSKIP)):e.setTargetConf()}else e.tabPanel.setActiveTab("retentionSnapshot")},genShareSetScheduleWebapi:function(e,t,i,s){return{api:"SYNO.Core.Share.Snapshot",method:"set_schedule",version:1,name:e,enable_snapshot_schedule:i,schedule:s,task_id:t}},setShareSchedulePromise:function(){var e=this;return new Promise(((t,i)=>{if(e.tabPanel.get("scheduleSnapshot").isDirty()){var s=e.getScheData(),n=e.getForm("scheduleSnapshot").findField("enable_schedule").getValue(),o=[];Ext.each(e.shares,(t=>{var i=t.get("name"),a=e.taskMap[i];o.push(e.genShareSetScheduleWebapi(i,a,n,s))}),e),e.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"sequential",compound:o},timeout:Math.max(2e3*o.length,SYNO.SDS.AdminCenter.Share.Snapshot.WEBAPI_DEFAULT_TIMEOUT),scope:e,callback:function(e,s,n){if(e&&!s.has_fail)t();else{const e=_T("snapmgr","err_set_sche");i(e)}}})}else t()}))},onCancel:function(){this.close()},genRetentionTaskMap:function(e,t){if(this.rttTaskMap={},e.result.length!==t.compound.length)return!1;for(var i=0;i<e.result.length;i++)this.rttTaskMap[t.compound[i].name]=e.result[i].data.tid;return!0},genShareTaskMap:function(e,t){if(this.taskMap={},e.result.length!==t.compound.length)return!1;for(var i=0;i<e.result.length;i++)this.taskMap[t.compound[i].name]=e.result[i].data.task_id;return!0},genGetScheduleWebapi:function(e){return{api:"SYNO.Core.Share.Snapshot",method:"get_schedule",version:1,name:e}},getSharedFolderScheData:function(){var e=this,t=[];Ext.each(e.shares,(i=>{t.push(e.genGetScheduleWebapi(i.get("name")))}),e),e.setStatusBusy({text:_T("common","msg_waiting")}),e.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"parallel",compound:t},scope:e,callback:function(t,i,s){if(!t||i.has_fail){const t=_T("snapmgr","err_get_sche");return e.clearStatusBusy(),e.getMsgBox().alert(_T("common","common_settings"),t,(()=>{e.close()}),e),void e.setStatusError({text:t,clear:!0})}e.tabPanel.items.each((e=>{1===s.compound.length?Ext.isFunction(e.updateScheData)&&e.updateScheData(i.result[0].data):Ext.isFunction(e.loadDefaultData)&&e.loadDefaultData()}),e),e.genShareTaskMap(i,s),e.getAdvancedSettings()}})},updateShareListPanel:function(){this.askNfsRuleApply(),this.close()},genSetRetentionWebapi:function(e,t){var i={api:"SYNO.DisasterRecovery.Retention",method:"set",version:1,type:"Share",name:e};return Ext.apply(i,t),Ext.apply(i,{tid:this.rttTaskMap[e]}),i},genSetRetentionWebapiPromise:function(e,t){var i=this;return new Promise(((s,n)=>{s(e.map((e=>i.genSetRetentionWebapi(e.data.name,t))))}))},setRetentionPromise:function(){var e=this,t=e.tabPanel.get("retentionSnapshot");return new Promise(((i,s)=>{if(t.isDirty()){var n=t.getRetention();e.genSetRetentionWebapiPromise(e.shares,n).then((t=>{e.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"sequential",compound:t},timeout:Math.max(2e3*t.length,SYNO.SDS.AdminCenter.Share.Snapshot.WEBAPI_DEFAULT_TIMEOUT),scope:e,callback:function(e,t,n){e&&!t.has_fail?i():s(_T("snapmgr","err_set_ret_policy"))}})}))}else i()}))},getRetention:function(){this.doGetRetention(this.shares)},genGetRetentionWebapi:function(e){return{api:"SYNO.DisasterRecovery.Retention",method:"get",version:1,type:"Share",name:e}},doGetRetention:function(){var e=this;let t=[];Ext.each(this.shares,(e=>{const i=e.data.name;t.push(this.genGetRetentionWebapi(i))}),this),e.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"parallel",compound:t},scope:e,callback:function(t,i,s){if(e.clearStatusBusy(),t&&!i.has_fail)e.tabPanel.items.each((e=>{Ext.isFunction(e.updateRetData)&&(1===s.compound.length?e.updateRetData(i.result[0].data):e.loadDefaultData())}),e),e.genRetentionTaskMap(i,s);else{const t=_T("snapmgr","err_get_ret_policy");e.getMsgBox().alert(_T("common","common_settings"),t,(()=>{e.close()}),e)}}})},setAdvSettingsPromise:function(){return this.tabPanel.getItem("advancedSettings").saveDataPromise()},getAdvancedSettings:function(){var e=this;e.tabPanel.getItem("advancedSettings").loadData(((t,i,s,n)=>{if(t)e.getRetention();else{e.clearStatusBusy();var o=SYNO.SDS.AdminCenter.Share.Snapshot.Utils.checkShareSnapCompoundError(t,i,s).err_msg;e.setStatusError(o)}}),e)},askNfsRuleApply:function(){this.tabPanel.getItem("advancedSettings").askNfsRuleApply()},getScheData:function(){return this.tabPanel.getItem("scheduleSnapshot").getScheduleData()}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.Configure.Schedule",{extend:"SYNO.SDS.TaskScheduler2.EditSchedulePanel",constructor:function(e){var t=this;t.isSnapshot=!0,t.more_option_val=99,t.loaded=!1,t.checkdLimitTip=!1,t.callParent(arguments),t.mon(t,"afterlayout",t.setEnableCheckGroup,t,{single:!0}),t.mon(t,"activate",t.showLimitTipIfNeeded,t),t.mon(t,"dataready",(()=>{t.loaded=!0,t.showLimitTipIfNeeded()}),t)},fillConfig:function(e){var t=this,i=[],s=[],n=0;for(n=0;n<24;++n)i.push([String.leftPad(String(n),2,"0"),n]);for(n=0;n<60;++n)s.push([String.leftPad(String(n),2,"0"),n]);var o=new Ext.data.ArrayStore({fields:["display","value"],data:i}),a=new Ext.data.ArrayStore({fields:["display","value"],data:s});t.addManagedComponent(o),t.addManagedComponent(a),t.repeat_hour_store=new Ext.data.ArrayStore({fields:["display","value"]}),t.addManagedComponent(t.repeat_hour_store),t.last_work_hour_store=new Ext.data.ArrayStore({fields:["display","value"]}),t.addManagedComponent(t.last_work_hour_store);var r={title:_T("common","schedule"),itemId:"scheduleSnapshot",border:!1,height:480,boxMinHeight:300,MinInterval:[5,15,30],HourInterval:[1,2,3,4,6,8,12],items:[{xtype:"syno_checkbox",name:"schedule_keep_all",id:t.schedule_keep_all_id=Ext.id(),boxLabel:_T("snapmgr","sche_keep_all"),checked:!1,hidden:!0},{xtype:"syno_checkbox",name:"enable_schedule",id:t.enable_schedule_id=Ext.id(),boxLabel:_T("iscsilun","snapshot_schedule_enable")},{xtype:"syno_compositefield",fieldLabel:_T("snapmgr","sche_exec_day"),labelWidth:180,width:200,indent:1,items:[{xtype:"syno_schedulefield",id:t.week_name_id=Ext.id(),hideLabel:!0,allowBlank:!1,editable:!1,width:200}]},{xtype:"syno_compositefield",fieldLabel:_T("schedule","run_time_first"),labelWidth:180,width:200,indent:1,defaults:{flex:1},items:[{xtype:"syno_combobox",store:o,displayField:"display",id:t.hour_id=Ext.id(),valueField:"value",triggerAction:"all",mode:"local",width:90,editable:!1,listeners:{select:{fn:function(){t.updateRepeatHourStore(),t.updateMinComboBox(),t.updateLastWorkTimeStore()},scope:t}}},{xtype:"syno_displayfield",value:":",style:{"text-align":"center"}},{xtype:"syno_combobox",store:a,displayField:"display",id:t.min_id=Ext.id(),valueField:"value",triggerAction:"all",mode:"local",width:90,editable:!1,listeners:{select:{fn:function(){t.updateRepeatHourStore(),t.updateLastWorkTimeStore()},scope:t}}}]},{xtype:"syno_combobox",store:t.repeat_hour_store,value:0,fieldLabel:_T("schedule","schedule_every"),labelWidth:180,displayField:"display",valueField:"value",id:t.repeat_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:!1,indent:1,listeners:{select:{fn:function(e,i){t.onSelectRepeatHour(i.get("value"))},scope:t},expand:{fn:function(e){t.repeat_hour>=100&&e.setValue(SYNO.SDS.AdminCenter.Share.Snapshot.Utils.LimitSnapshotSchedule()?0:t.more_option_val)},scope:t},collapse:{fn:function(e){t.setRepeatHour(t.repeat_hour)},scope:t},enable:{fn:function(){t.updateMinComboBox(),t.updateLastWorkHourComboBox()},scope:t,delay:5}}},{xtype:"syno_combobox",store:t.last_work_hour_store,value:0,labelWidth:180,fieldLabel:_T("schedule","last_run_time"),displayField:"display",valueField:"value",id:t.last_work_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:!1,indent:1}]};return Ext.apply(r,e),r},updateRepeatHourStoreWithMinInterval:function(e){var t=this,i=0,s=0,n=0,o=[],a=Ext.getCmp(this.hour_id).getValue();for(o.push([_T("schedule","schedule_every_once"),0]),i=23;i>=0;i--)if(i>a)for(n=i-a,s=0;s<t.HourInterval.length;s++)if(n===t.HourInterval[s]){var r=String.format(_T("schedule","every_x_hours"),n);o.push([r,n]);break}for(SYNO.SDS.AdminCenter.Share.Snapshot.Utils.LimitSnapshotSchedule()||o.push([_T("snapmgr","sched_more_option"),t.more_option_val]),t.minArr=[],i=e.length-1;i>=0;i--)t.minArr.push([String.format(_T("schedule","every_x_minutes"),e[i]),100*e[i]]);t.repeat_hour_store.loadData(o),t.repeat_hour>n&&t.setRepeatHour(0)},updateRepeatHourStore:function(){this.updateRepeatHourStoreWithMinInterval([5,15,30])},setRepeatHour:function(e){var t=this;if(t.repeat_hour=e,e<100)Ext.getCmp(t.repeat_hour_id).setValue(e);else for(var i=0;i<t.minArr.length;i++)if(t.minArr[i][1]==e){Ext.getCmp(t.repeat_hour_id).setValue(t.minArr[i][0]);break}},updateMinComboBox:function(){var e=this;Math.floor(e.repeat_hour/100)>0?(Ext.getCmp(e.min_id).setValue(0),Ext.getCmp(e.min_id).setDisabled(!0)):Ext.getCmp(e.min_id).setDisabled(!1)},updateLastWorkHourComboBox:function(){var e=this,t=Math.floor(e.repeat_hour/100),i=e.repeat_hour%100,s=0===t&&0===i,n=Ext.getCmp(e.repeat_hour_id).disabled;Ext.getCmp(e.last_work_hour_id).setDisabled(s||n)},onSelectMoreOption:function(){var e=this,t=new SYNO.SDS.AdminCenter.Share.Snapshot.Schedule.MoreOption({appWin:e.appWin,owner:e.owner,repeat_hour:e.repeat_hour,minArr:e.minArr});e.mon(t,"more_option_edited",e.onMoreOptionEdit,e,{single:!0}),t.open()},afterSelectRepeatHour:function(){this.updateMinComboBox(),this.updateLastWorkTimeStore()},onMoreOptionEdit:function(e){this.setRepeatHour(e.repeat_hour),this.afterSelectRepeatHour()},onSelectRepeatHour:function(e){var t=this;t.more_option_val!==e?(t.setRepeatHour(e),t.afterSelectRepeatHour()):t.onSelectMoreOption()},updateLastWorkTimeStore:function(){var e=this,t=-1,i=[],s=Ext.getCmp(e.hour_id).getValue(),n=Ext.getCmp(e.min_id).getValue(),o=Math.floor(e.repeat_hour/100),a=e.repeat_hour%100,r=Ext.getCmp(e.last_work_hour_id).getValue();o>0&&(a=1),e.updateLastWorkHourComboBox();for(var l=s;l<24;l+=a){var d=String.leftPad(String(l),2,"0")+":";if(d+=0<o?String.leftPad(String(60-o),2,"0"):String.leftPad(String(n),2,"0"),i.push([d,l]),l===r&&(t=l),0===a)break}e.last_work_hour_store.loadData(i),-1===t?Ext.getCmp(e.last_work_hour_id).setValue(i[i.length-1][1]):Ext.getCmp(e.last_work_hour_id).setValue(t),0<o&&Ext.getCmp(e.last_work_hour_id).setValue(i[i.length-1][1]),e.last_work_hour_store.totalLength>0&&Ext.getCmp(e.last_work_hour_id).setValue(e.last_work_hour_store.getAt(e.last_work_hour_store.totalLength-1).data.value)},loadDefaultData:function(){SYNO.Debug("[DEBUG] loadDefaultData");var e=this;Ext.getCmp(e.schedule_keep_all_id).show(),Ext.getCmp(e.schedule_keep_all_id).setValue(!0),e.updateScheData({enable_snapshot_schedule:!1,schedule:SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GetDailySchedule(0)})},setInitialValue:function(e,t){Ext.getCmp(e).setValue(t),Ext.getCmp(e).originalValue=t},updateScheData:function(e){SYNO.Debug("[DEBUG] calling updateScheData");var t=this,i=e.schedule;t.setInitialValue(t.week_name_id,i.week_name),t.setInitialValue(t.enable_schedule_id,e.enable_snapshot_schedule),t.setInitialValue(t.hour_id,i.hour),t.setInitialValue(t.min_id,i.min),t.updateRepeatHourStore(),t.setRepeatHour(i.repeat_hour+100*i.repeat_min),t.updateLastWorkTimeStore(),t.setInitialValue(t.last_work_hour_id,i.last_work_hour),t.fireEvent("dataready")},setEnableCheckGroup:function(){var e=this;e.dummy1=new SYNO.ux.Utils.EnableCheckGroup(e.form,"enable_schedule",[e.week_name_id,e.hour_id,e.min_id,e.repeat_hour_id,e.last_work_hour_id]),e.dummy2=new SYNO.ux.Utils.EnableCheckGroup(e.form,"schedule_keep_all",[],[e.enable_schedule_id])},showLimitTipIfNeeded:function(){var e=this,t=Ext.getCmp(e.repeat_hour_id).getEl();e.checkdLimitTip||e.loaded&&void 0!==t&&(SYNO.SDS.AdminCenter.Share.Snapshot.Utils.LimitSnapshotSchedule()&&e.repeat_hour>=100&&SYNO.ux.AddTip(t,Ext.util.Format.htmlEncode(_T("snapmgr","limit_snapshot_schedule_tip"))),e.checkdLimitTip=!0)},getScheduleData:function(){var e=this,t={date_type:0};return t.week_name=Ext.getCmp(e.week_name_id).getValue(),t.hour=Ext.getCmp(e.hour_id).getValue(),t.min=Ext.getCmp(e.min_id).getValue(),t.repeat_hour=e.repeat_hour%100,t.repeat_min=parseInt(e.repeat_hour/100,10),t.last_work_hour=Ext.getCmp(e.last_work_hour_id).getValue(),t},isScheduleEnabled:function(){return Ext.getCmp(this.enable_schedule_id).getValue()},isDirty:function(){var e=this;return Ext.getCmp(e.schedule_keep_all_id).isVisible()?!Ext.getCmp(e.schedule_keep_all_id).getValue():Ext.getCmp(e.enable_schedule_id).isDirty()||Ext.getCmp(e.week_name_id).isDirty()||Ext.getCmp(e.repeat_hour_id).isDirty()||Ext.getCmp(e.hour_id).isDirty()||Ext.getCmp(e.min_id).isDirty()||Ext.getCmp(e.last_work_hour_id).isDirty()},isDailySchedule:function(){var e=this.getScheduleData();return 0===e.repeat_min&&e.hour===e.last_work_hour},onDestroy:function(){Ext.destroy(this.dummy1),Ext.destroy(this.dummy2),this.callParent()}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.Schedule.MoreOption",{extend:"SYNO.SDS.AdminCenter.Share.Snapshot.ModalWindow",constructor:function(e){for(var t=this,i=e.minArr[0][1],s=1;s<e.minArr.length;s++)e.minArr[s][1]==e.repeat_hour&&(i=e.repeat_hour);t.repeat_hour_store=new Ext.data.ArrayStore({fields:["display","value"],data:e.minArr}),t.addManagedComponent(t.repeat_hour_store),t.org_repeat_hour=e.repeat_hour;var n=[{xtype:"syno_combobox",store:t.repeat_hour_store,value:i,fieldLabel:_T("snapmgr","sche_repeat_every"),labelWidth:150,displayField:"display",valueField:"value",id:t.repeat_hour_id=Ext.id(),triggerAction:"all",width:170,editable:!1}],o={xtype:"syno_panel",items:[{xtype:"syno_displayfield",htmlEncode:!1,value:SYNO.SDS.AdminCenter.Share.Snapshot.Utils.NoteRenderer(_T("snapmgr","sched_more_option_note"))}]},a={owner:e.owner,width:420,resizable:!1,title:_T("snapmgr","sched_more_option"),buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:t,handler:t.close},{itemId:"btApply",xtype:"syno_button",btnStyle:"blue",text:_T("common","apply"),scope:t,handler:t.onApply}],items:[{xtype:"syno_formpanel",border:!1,height:200,items:n,bbar:o}]};t.callParent([Ext.apply(a,e)])},onApply:function(){var e=this,t=Ext.getCmp(e.repeat_hour_id).getValue();e.org_repeat_hour!=t&&e.fireEvent("more_option_edited",{repeat_hour:t}),e.close()}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.Configure.Retention",{extend:"Ext.Container",constructor:function(e){var t,i=this;this.maxSnapshot=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_CFG_MAX,i.useTimeTrigger=e.appWin.useTimeTrigger,i.supportSpaceReclaim=e.appWin.supportSpaceReclaim,i.hasBtrfsTarget=e.hasBtrfsTarget,i.isAdvDirty=!1,Ext.apply(i,{MAX_RET_RECENTLY:i.maxSnapshot,MIN_RET_RECENTLY:1});var s=i.supportSpaceReclaim&&i.hasBtrfsTarget;this.note_msg=SYNO.SDS.AdminCenter.Share.Snapshot.Utils.NoteRenderer(_T("snapmgr","space_reclamation_warning")),e.isCreate?i.note_msg_sr=SYNO.SDS.AdminCenter.Share.Snapshot.Utils.NoteRenderer(String.format(_T("snapmgr","space_reclamation_warning_sr"),"","")):(i.storageManagerLinkId=Ext.id(),i.note_msg_sr=SYNO.SDS.AdminCenter.Share.Snapshot.Utils.NoteRenderer(String.format(_T("snapmgr","space_reclamation_warning_sr"),'<span id="'+i.storageManagerLinkId+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</span>"))),i.ret_trigger_time_store=new Ext.data.ArrayStore({fields:["display","value"]});var n,o=[];for(n=0;n<24;n++){var a=String.leftPad(String(n),2,"0")+":00",r=Date.parseDate(a,"H:i"),l=SYNO.SDS.DateTimeFormatter(r,{type:"time"});o.push([l,n])}o.push([_T("snapmgr","ret_trigger_after_snap"),-1]),i.ret_trigger_time_store.loadData(o);var d=[{xtype:"syno_displayfield",value:_T("snapmgr","retention_policy_description_sr")},{xtype:"syno_checkbox",name:"retention_keep_all",boxLabel:_T("snapmgr","ret_keep_all"),inputValue:SYNO.SDS.AdminCenter.Share.Snapshot.RTT_KEEP_ALL,checked:e.showKeepAll,hidden:!e.showKeepAll},{xtype:"syno_checkbox",name:"retention_enabled",checked:e.isCreate||e.showKeepAll,boxLabel:_T("snapmgr","enable_retention_policy")},{xtype:"syno_compositefield",hideLabel:!0,height:28,indent:1,items:[{xtype:"syno_radio",name:"policyType",boxLabel:_T("snapmgr","keep_versions_description"),checked:!0,inputValue:SYNO.SDS.AdminCenter.Share.Snapshot.RTT_DEL_OLD},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"recently",value:128<i.MAX_RET_RECENTLY?128:i.MAX_RET_RECENTLY,width:60,minValue:i.MIN_RET_RECENTLY,maxValue:i.MAX_RET_RECENTLY,maxLength:i.countDigitLength(i.MAX_RET_RECENTLY),listeners:{disable:e=>{e.setValue(e.originalValue)},scope:this}}]},{xtype:"syno_compositefield",hideLabel:!0,height:28,indent:1,items:[{xtype:"syno_radio",name:"policyType",boxLabel:_T("snapmgr","keep_days_description"),inputValue:SYNO.SDS.AdminCenter.Share.Snapshot.RTT_BY_DAY},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"retainDay",value:7,width:60,minValue:1,maxLength:4,listeners:{disable:e=>{e.setValue(e.originalValue)},scope:this}},{xtype:"syno_displayfield",name:"displayfield_days",value:_T("common","time_days")}]},{xtype:"syno_compositefield",hideLabel:!0,height:28,indent:1,items:[{xtype:"syno_radio",name:"policyType",boxLabel:_T("snapmgr","ret_adv"),inputValue:SYNO.SDS.AdminCenter.Share.Snapshot.RTT_BY_ADVANCE,ref:"../../policyByAdv"},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_button",text:_T("snapmgr","ret_set_rule"),disabled:!0,id:i.button_adv=Ext.id(),listeners:{disable:function(){i.isAdvDirty=!1}},scope:i,handler:i.onAdvance}]},{xtype:"syno_displayfield",name:"ret_trigger_time_title",id:i.ret_trigger_time_title=Ext.id(),hidden:!i.useTimeTrigger,indent:1,value:_T("snapmgr","snap_ret_trigger_time")},{xtype:"syno_combobox",store:i.ret_trigger_time_store,name:"ret_trigger_time",id:i.ret_trigger_time=Ext.id(),width:160,hideLabel:!0,editable:!1,displayField:"display",valueField:"value",value:i.useTimeTrigger?2:-1,disabled:!i.useTimeTrigger,hidden:!i.useTimeTrigger,mode:"local",triggerAction:"all",indent:1,listeners:{disable:function(){this.reset()},afterrender:function(e){var t=new Ext.util.TextMetrics.createInstance(e.getEl());e.setWidth(39+t.getWidth(_T("snapmgr","ret_trigger_after_snap")))}},scope:i},{id:i.ret_note=Ext.id(),xtype:"syno_displayfield",name:"ret_note",htmlEncode:!1,hidden:s,indent:1,value:i.note_msg},{id:i.ret_note_sr=Ext.id(),xtype:"syno_displayfield",htmlEncode:!1,hidden:!s,indent:1,listeners:{afterrender:i.addLinks,scope:i,single:!0,buffer:100},value:i.note_msg_sr}];const c={xtype:"syno_panel",padding:e.isCreate?"0px 8px 0px 0px":"0px 8px 12px 0px",items:[{cls:"syno-admincenter-share-snapshot-retention-descpanel",xtype:"syno_displayfield",value:String.format(_T("snapmgr","ret_desc_share"),this.maxSnapshot)}]};t={title:_T("snapmgr","ret_title"),trackResetOnLoad:!0,itemId:"retentionSnapshot",items:[{itemId:"retentionSnapshotPanel",xtype:"syno_formpanel",width:e.isCreate?630:640,height:e.isCreate?e.owner.height-156:436,minWidth:e.isCreate?630:640,minHeight:e.isCreate?e.owner.height-156:436,items:d,bbar:c,trackResetOnLoad:!0}]},i.callParent([Ext.apply(t,e)]),e.isCreate||i.mon(i,"activate",i.adjustPanelSize,i),i.mon(i,"afterlayout",(()=>{const e={};e[String(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_DEL_OLD)]=["recently"],e[String(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_BY_DAY)]=["retainDay"],e[String(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_BY_ADVANCE)]=[i.button_adv];new SYNO.ux.Utils.EnableRadioGroup(i.getForm(),"policyType",e),new SYNO.ux.Utils.EnableCheckGroup(i.getForm(),"retention_enabled",["policyType","displayfield_days","ret_trigger_time_title","ret_trigger_time","ret_note"]),new SYNO.ux.Utils.EnableCheckGroup(i.getForm(),"retention_keep_all",[],["retention_enabled"])}),i,{single:!0})},getForm:function(){return this.getComponent("retentionSnapshotPanel").getForm()},addLinks:function(e){SYNO.Debug();const t=this;void 0!==t.storageManagerLinkId&&e.el.query("span").forEach((e=>{var i,s;return e.id!==t.storageManagerLinkId||(s=function(){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance",{fn:"SYNO.SDS.StorageManager.Pool.Main",openSpaceReclaimWin:!0},!1)},(i=Ext.get(e)).addKeyListener(Ext.EventObject.SPACE,s,t),i.addKeyListener(Ext.EventObject.ENTER,s,t),t.mon(i,"click",s,t),!1)}))},adjustPanelSize:function(){this.setHeight(this.owner.getInnerHeight()-34)},showTimeTrigger:function(){Ext.getCmp(this.ret_trigger_time_title).show(),Ext.getCmp(this.ret_trigger_time).show()},hideTimeTrigger:function(){Ext.getCmp(this.ret_trigger_time_title).hide(),Ext.getCmp(this.ret_trigger_time).hide()},adjustUIComps:function(){const e=this,t=e.getForm().getValues();e.useTimeTrigger?(e.showTimeTrigger(),Ext.getCmp(e.ret_trigger_time).setDisabled("true"!==t.retention_enabled)):(e.hideTimeTrigger(),Ext.getCmp(e.ret_trigger_time).setDisabled(!0)),e.supportSpaceReclaim&&e.hasBtrfsTarget?(Ext.getCmp(e.ret_note).hide(),Ext.getCmp(e.ret_note_sr).show()):(Ext.getCmp(e.ret_note).show(),Ext.getCmp(e.ret_note_sr).hide())},isValid:function(){return this.getForm().isValid()},isDirty:function(){const e=this.getForm();return"true"!==e.getValues().retention_keep_all&&(e.isDirty()||this.isAdvDirty)},countDigitLength:function(e){return void 0===e||isNaN(e)?-1:e.toString().length},updateRetData:function(e){this.loadData(e)},getRetention:function(){const e=this,t=e.getForm(),i=t.getValues(),s={policyType:"true"===i.retention_enabled?parseInt(i.policyType,10):0,recently:t.findField("recently").getValue(),retainDay:t.findField("retainDay").getValue()};return e.useTimeTrigger&&-1<i.ret_trigger_time&&(s.policyType|=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_TRRIGER_BY_TIME,s.tid=-1,s.schedule=SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GetDailySchedule(i.ret_trigger_time)),Ext.apply(s,e.getAdvData()),s},loadData:function(e){const t=this,i=t.getForm().getValues(),s=e.policyType&~SYNO.SDS.AdminCenter.Share.Snapshot.RTT_TRRIGER_BY_TIME;i.recently=e.recently,i.retainDay=e.retainDay,i.retention_enabled=!!s,t.useTimeTrigger?SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ALL===s?i.ret_trigger_time=2:e.policyType&SYNO.SDS.AdminCenter.Share.Snapshot.RTT_TRRIGER_BY_TIME?i.ret_trigger_time=e.schedule.hour:i.ret_trigger_time=-1:i.ret_trigger_time=-1,i.policyType=s||SYNO.SDS.AdminCenter.Share.Snapshot.RTT_DEL_OLD,t.initAdvRetainDay=e.advRetainDay,t.initAdvHourly=e.advHourly,t.initAdvDaily=e.advDaily,t.initAdvWeekly=e.advWeekly,t.initAdvMonthly=e.advMonthly,t.initAdvYearly=e.advYearly,t.initAdvMinimum=e.advMinimum,t.initAdvPolicyType=e.advPolicyType,t.getForm().setValues(i)},loadDefaultData:function(){this.loadData({policyType:SYNO.SDS.AdminCenter.Share.Snapshot.RTT_DEL_OLD,recently:128,retainDay:7,advRetainDay:1,advHourly:24,advDaily:7,advWeekly:2,advMonthly:1,advYearly:1,advMinimum:5,advPolicyType:SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAY|SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_HOURLY|SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAILY|SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_WEEKLY|SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_MONTHLY|SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_YEARLY,tid:-1,schedule:SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GetDailySchedule(2)})},getAdvData:function(){const e=this,t={advRetainDay:e.isAdvDirty?e.advRetainDay:e.initAdvRetainDay,advHourly:e.isAdvDirty?e.advHourly:e.initAdvHourly,advDaily:e.isAdvDirty?e.advDaily:e.initAdvDaily,advWeekly:e.isAdvDirty?e.advWeekly:e.initAdvWeekly,advMonthly:e.isAdvDirty?e.advMonthly:e.initAdvMonthly,advYearly:e.isAdvDirty?e.advYearly:e.initAdvYearly,advMinimum:e.isAdvDirty?e.advMinimum:e.initAdvMinimum,advPolicyType:e.isAdvDirty?e.advPolicyType:e.initAdvPolicyType};return e.isHourlyFieldDisabled&&(t.advPolicyType&=~SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_HOURLY,t.advHourly=0),t},onAdvance:function(){var e=this,t={appWin:e.appWin,owner:e.owner,isCreate:e.isCreate,maxSnapshot:e.maxSnapshot,isHourlyFieldDisabled:e.isHourlyFieldDisabled};Ext.apply(t,e.getAdvData());var i=new SYNO.SDS.AdminCenter.Share.Snapshot.SmartRetention(t);e.mon(i,"ret_adv_edited",e.onAdvanceEdited,e,{single:!0}),i.open()},onAdvanceEdited:function(e){var t=this;t.isAdvDirty=!0,t=Ext.apply(t,e)},onDestroy:function(){Ext.destroy(this.dummy),this.callParent()}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.SmartRetention",{extend:"SYNO.SDS.AdminCenter.Share.Snapshot.ModalWindow",constructor:function(e){var t,i=this;(i=Ext.apply(i,e)).helpLinkId=Ext.id();const s=e=>{e.setValue(e.originalValue)};t=[{xtype:"syno_displayfield",htmlEncode:!1,value:SYNO.SDS.AdminCenter.Share.Utils.LinkRender(this.helpLinkId,_T("snapmgr","ret_pol_desc")),listeners:{afterrender:i.addLinks,scope:i,single:!0,buffer:100}},{xtype:"syno_compositefield",hideLabel:!0,height:28,ref:"../advDayComp",items:[{xtype:"syno_checkbox",name:"advPolicyByDay",boxLabel:_T("snapmgr","keep_days_description"),checked:!0,ref:"checkBox"},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"advRetainDay",value:1,width:60,minValue:1,maxLength:4},{xtype:"syno_displayfield",value:_T("common","time_days")}]},{xtype:"syno_compositefield",hideLabel:!0,height:28,ref:"../advHourlyComp",items:[{xtype:"syno_checkbox",name:"advPolicyByHourly",boxLabel:_T("snapmgr","gfs_hours_description"),checked:!0,ref:"checkBox"},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"advHourly",value:24,width:60,minValue:1,maxLength:5,ref:"numberfield",listeners:{disable:s,scope:this}},{xtype:"syno_displayfield",value:_T("common","time_hours"),ref:"tip"}]},{xtype:"syno_compositefield",hideLabel:!0,height:28,ref:"../advDailyComp",items:[{xtype:"syno_checkbox",name:"advPolicyByDaily",boxLabel:_T("snapmgr","gfs_days_description"),checked:!0,ref:"checkBox"},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"advDaily",value:7,width:60,minValue:1,maxLength:5,listeners:{disable:s,scope:this}},{xtype:"syno_displayfield",value:_T("common","time_days")}]},{xtype:"syno_compositefield",hideLabel:!0,height:28,ref:"../advWeeklyComp",items:[{xtype:"syno_checkbox",name:"advPolicyByWeekly",boxLabel:_T("snapmgr","gfs_weeks_description"),checked:!0,ref:"checkBox"},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"advWeekly",value:2,width:60,minValue:1,maxLength:4,listeners:{disable:s,scope:this}},{xtype:"syno_displayfield",value:_T("common","time_weeks")}]},{xtype:"syno_compositefield",hideLabel:!0,height:28,ref:"../advMonthlyComp",items:[{xtype:"syno_checkbox",name:"advPolicyByMonthly",boxLabel:_T("snapmgr","gfs_months_description"),checked:!0,ref:"checkBox"},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"advMonthly",value:1,width:60,minValue:1,maxLength:3,listeners:{disable:s,scope:this}},{xtype:"syno_displayfield",value:_T("common","time_months")}]},{xtype:"syno_compositefield",hideLabel:!0,height:28,ref:"../advYearlyComp",items:[{xtype:"syno_checkbox",name:"advPolicyByYearly",boxLabel:_T("snapmgr","gfs_years_description"),checked:!0,ref:"checkBox"},{xtype:"syno_displayfield",width:2,value:""},{xtype:"syno_numberfield",name:"advYearly",value:1,width:60,minValue:1,maxLength:2,listeners:{disable:s,scope:this}},{xtype:"syno_displayfield",value:_T("common","time_years")}]},{xtype:"syno_displayfield",value:_T("snapmgr","retained_latest_snapshots_desc")},{xtype:"syno_compositefield",hideLabel:!0,height:28,items:[{xtype:"syno_displayfield",value:_T("snapmgr","keep_versions_description"),ref:"../../advMinimumComp",isDirty:()=>!1},{xtype:"syno_numberfield",name:"advMinimum",value:5,width:60,minValue:1,maxValue:i.maxSnapshot,maxLength:i.countDigitLength(i.maxSnapshot)}]}];var n={width:660,height:460,resizable:!1,title:_T("snapmgr","ret_set_rule"),id:i.id=Ext.id(),layout:"fit",buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:i,handler:i.close},{itemId:"btApply",xtype:"syno_button",btnStyle:"blue",text:_T("common","apply"),scope:i,handler:i.onApply}],items:[{ref:"formpanel",xtype:"syno_formpanel",me:i,trackResetOnLoad:!0,items:t}]};i.callParent([Ext.apply(n,e)]),i.mon(i,"afterlayout",(()=>{const e=i.formpanel.getForm();new SYNO.ux.Utils.EnableCheckGroup(e,"advPolicyByDay",["advRetainDay"]),new SYNO.ux.Utils.EnableCheckGroup(e,"advPolicyByHourly",["advHourly"]),new SYNO.ux.Utils.EnableCheckGroup(e,"advPolicyByDaily",["advDaily"]),new SYNO.ux.Utils.EnableCheckGroup(e,"advPolicyByWeekly",["advWeekly"]),new SYNO.ux.Utils.EnableCheckGroup(e,"advPolicyByMonthly",["advMonthly"]),new SYNO.ux.Utils.EnableCheckGroup(e,"advPolicyByYearly",["advYearly"])}),i,{single:!0})},countDigitLength:function(e){return void 0===e||isNaN(e)?-1:e.toString().length},adjustLayout:function(){const e=this,t=["advDayComp","advHourlyComp","advDailyComp","advWeeklyComp","advMonthlyComp","advYearlyComp"],i=Math.max(e.advMinimumComp.getWidth(),...t.map((t=>e[t].checkBox.getWidth())))+1;t.forEach((t=>e[t].checkBox.setWidth(i))),e.advMinimumComp.setWidth(i)},onOpen:function(){const e=this;e.loadData(),e.isHourlyFieldDisabled&&e.addHourlyTip(),e.adjustLayout(),e.callParent()},loadData:function(){const e=this,t={};void 0!==e.advPolicyType&&(t.advPolicyByDay=!!(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAY&e.advPolicyType),t.advPolicyByHourly=!!(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_HOURLY&e.advPolicyType),t.advPolicyByDaily=!!(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAILY&e.advPolicyType),t.advPolicyByWeekly=!!(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_WEEKLY&e.advPolicyType),t.advPolicyByMonthly=!!(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_MONTHLY&e.advPolicyType),t.advPolicyByYearly=!!(SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_YEARLY&e.advPolicyType),t.advRetainDay=e.advRetainDay,t.advHourly=e.advHourly,t.advDaily=e.advDaily,t.advWeekly=e.advWeekly,t.advMonthly=e.advMonthly,t.advYearly=e.advYearly,t.advMinimum=e.advMinimum,e.formpanel.getForm().setValues(t))},addHourlyTip:function(){const e=this,t=_T("snapmgr","retention_hourly_tooltip");e.advHourlyComp.setDisabled(!0),e.advHourlyComp.checkBox.setValue(!1),e.advHourlyComp.numberfield.resetValue(0),SYNO.ux.AddTip(e.advHourlyComp.tip.getEl(),Ext.util.Format.htmlEncode(t))},addLinks:function(e){var t=this,i=e.el.query("span"),s=t.isCreate?"replication.html":"snapshots.html";SYNO.SDS.AdminCenter.Share.Snapshot.IsMultiController()&&(s="taipei_"+s),i.forEach((e=>{var i,n;return e.id!==t.helpLinkId||(n=()=>{SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.DisasterRecovery.Application:"+s,anchor:"smart_retention"},!1)},(i=Ext.get(e)).addKeyListener(Ext.EventObject.SPACE,n,t),i.addKeyListener(Ext.EventObject.ENTER,n,t),t.mon(i,"click",n,t),!1)}))},onApply:function(){const e=this,t=e.formpanel.getForm();if(t.isValid()){if(t.isDirty()){const i=t.getValues();if("false"===i.advPolicyByDay&&"false"===i.advPolicyByHourly&&"false"===i.advPolicyByDaily&&"false"===i.advPolicyByWeekly&&"false"===i.advPolicyByMonthly&&"false"===i.advPolicyByYearly)return void e.owner.getMsgBox().alert("",_T("snapmgr","ret_adv_at_least_one"));const s={advRetainDay:e.advRetainDay,advHourly:e.advHourly,advDaily:e.advDaily,advWeekly:e.advWeekly,advMonthly:e.advMonthly,advYearly:e.advYearly,advPolicyType:SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_MINIMUM};"true"===i.advPolicyByDay&&(s.advPolicyType|=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAY,s.advRetainDay=parseInt(i.advRetainDay,10)),"true"===i.advPolicyByHourly&&(s.advPolicyType|=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_HOURLY,s.advHourly=parseInt(i.advHourly,10)),"true"===i.advPolicyByDaily&&(s.advPolicyType|=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAILY,s.advDaily=parseInt(i.advDaily,10)),"true"===i.advPolicyByWeekly&&(s.advPolicyType|=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_WEEKLY,s.advWeekly=parseInt(i.advWeekly,10)),"true"===i.advPolicyByMonthly&&(s.advPolicyType|=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_MONTHLY,s.advMonthly=parseInt(i.advMonthly,10)),"true"===i.advPolicyByYearly&&(s.advPolicyType|=SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_YEARLY,s.advYearly=parseInt(i.advYearly,10)),s.advMinimum=parseInt(i.advMinimum,10),e.fireEvent("ret_adv_edited",s)}e.close()}}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.Configure.AdvancedSettings.Share",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t,i=this;i.shares=e.shares,i.needNfsCheckShares=[],i.nfsRules={},i.hasShareDRSite=!1,i.hasEncryption=!1,i.settingMap={},Ext.each(i.shares,(e=>{SYNO.SDS.AdminCenter.Share.Snapshot.Utils.IsShareDRSite(e)&&(i.hasShareDRSite=!0),0!==e.get("encryption")&&(i.hasEncryption=!0)}),i),t={title:_T("snapmgr","advanced_setting"),itemId:"advancedSettings",trackResetOnLoad:!0,items:[{xtype:"syno_checkbox",name:"advanced_keep_all",id:i.advanced_keep_all_id=Ext.id(),boxLabel:_T("snapmgr","advanced_keep_all"),checked:1!==i.shares.length,hidden:1===i.shares.length},{xtype:"syno_checkbox",name:"setSnapNameFormat",id:i.setSnapNameFormat_id=Ext.id(),boxLabel:_T("snapmgr","set_share_snap_format"),disabled:i.hasShareDRSite,htmlEncode:!1},{xtype:"syno_displayfield",name:"setSnapNameFormatDesc",id:i.setSnapNameFormatDesc_id=Ext.id(),value:SYNO.SDS.AdminCenter.Share.Snapshot.Utils.SharedConfigNotice(),indent:1,disabled:i.hasShareDRSite,htmlEncode:!1},{xtype:"syno_checkbox",name:"enable_snapshot_browsing",id:i.enable_snapshot_browsing_id=Ext.id(),boxLabel:_T("share","share_snapshot_browsing_enable"),disabled:i.hasEncryption},{xtype:"syno_displayfield",name:"enable_snapshot_browsing_desc",id:i.enable_snapshot_browsing_desc_id=Ext.id(),value:_T("share","share_snapshot_browsing_enable_desc"),indent:1,disabled:i.hasEncryption}]},i.callParent([Ext.apply(t,e)]),i.mon(i,"afterlayout",(()=>{i.setEnableCheckGroup(),SYNO.ux.AddTip(Ext.getCmp(i.enable_snapshot_browsing_id).getEl(),Ext.util.Format.htmlEncode(_T("snapmgr","encrypted_not_support_browse")))}),i,{single:!0})},isLocalTimeFormat:function(){return!this.form.findField("setSnapNameFormat").getValue()},getSnapshotBrowsing:function(){return this.form.findField("enable_snapshot_browsing").getValue()},fillForm:function(e){this.form.setValues({setSnapNameFormat:!e.snapshot_local_time_format}),delete e.snapshot_local_time_format,this.form.setValues(e)},genGetShareConfWebapi:function(e){return{api:"SYNO.Core.Share.Snapshot",method:"get_share_conf",version:1,name:e,sharesnapinfo:["snapshot_local_time_format","enable_snapshot_browsing"]}},loadData:function(e,t){var i=this;i.checkNfsRuleCrossMount();var s=[];Ext.each(i.shares,(e=>{s.push(i.genGetShareConfWebapi(e.get("name")))}),i),i.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"parallel",compound:s},scope:i,callback:function(s,n,o){s&&!n.has_fail&&(Ext.each(n.result,((e,t)=>{i.settingMap[o.compound[t].name]=e.data}),i),i.fillForm(n.result[0].data)),e&&t&&e.apply(t,arguments)}})},genCheckNfsRuleCorssMountWebapi:function(e){return{api:"SYNO.Core.FileServ.NFS.SharePrivilege",method:"load",version:"1",share_name:e}},checkNfsRuleCrossMount:function(){var e=this,t=[];Ext.each(e.shares,(i=>{t.push(e.genCheckNfsRuleCorssMountWebapi(i.get("name")))}),e),e.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"parallel",compound:t},scope:e,callback:function(t,i,s){t&&Ext.each(i.result,((t,i)=>{Ext.each(t.data.rule,(n=>{if(!n.crossmnt)return e.needAskNfsRuleApply=!0,e.needNfsCheckShares.push(s.compound[i].share_name),e.nfsRules[s.compound[i].share_name]=t.data.rule,!1}),e)}),e)}})},genSetShareConfWebapi:function(e){var t=this,i={api:"SYNO.Core.Share.Snapshot",method:"set_share_conf",version:1,name:e,sharesnapinfo:{snapshot_local_time_format:t.isLocalTimeFormat(),enable_snapshot_browsing:t.getSnapshotBrowsing()}},s=t.settingMap[e];return t.hasShareDRSite&&(i.sharesnapinfo.snapshot_local_time_format=s.snapshot_local_time_format),t.hasEncryption&&(i.sharesnapinfo.enable_snapshot_browsing=s.enable_snapshot_browsing),i},saveDataPromise:function(){var e=this;return new Promise(((t,i)=>{if(e.form.isDirty()&&!e.form.findField("advanced_keep_all").getValue()){var s=[];Ext.each(e.shares,(t=>{s.push(e.genSetShareConfWebapi(t.get("name")))}),e),e.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,scope:e,params:{mode:"parallel",compound:s},callback:function(e,s,n){if(!e||s&&s.has_fail){var o=SYNO.SDS.AdminCenter.Share.Snapshot.Utils.checkShareSnapCompoundError(e,s,n).err_msg;i(o)}else t()}})}else t()}))},askNfsRuleApply:function(){var e=this;if(e.form.findField("enable_snapshot_browsing").isDirty()&&!e.form.findField("advanced_keep_all").getValue()&&e.getSnapshotBrowsing()){var t;e.needAskNfsRuleApply&&(t=1<e.shares.length?_T("snapmgr","share_nfs_crossmnt_apply_multiple")+" "+e.needNfsCheckShares.join(", "):_T("snapmgr","share_nfs_crossmnt_apply_now_confirm"),e.appWin.getMsgBox().confirm(_T("common","common_settings"),t,(t=>{var i;"yes"===t&&(i=[],Ext.each(e.needNfsCheckShares,(t=>{var s=e.nfsRules[t];Ext.each(s,(e=>{e.crossmnt=!0})),i.push(((e,t)=>({api:"SYNO.Core.FileServ.NFS.SharePrivilege",method:"save",version:"1",share_name:e,rule:t}))(t,s))}),e),e.appWin.setStatusBusy(),e.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,scope:e,params:{mode:"parallel",compound:i},callback:function(t,i,s,n){i&&i.has_fail&&SYNO.SDS.AdminCenter.Share.Snapshot.Utils.ReportWebapiFailure(e,i),e.appWin.clearStatus()}}))})))}},setEnableCheckGroup:function(){var e=this,t=[];e.hasShareDRSite||(t=t.concat([e.setSnapNameFormat_id,e.setSnapNameFormatDesc_id])),e.hasEncryption||(t=t.concat([e.enable_snapshot_browsing_id,e.enable_snapshot_browsing_desc_id])),e.dummy1=new SYNO.ux.Utils.EnableCheckGroup(e.form,"advanced_keep_all",[],t)},onDestroy:function(){Ext.destroy(this.dummy1),this.callParent()}}),Ext.define("SYNO.SDS.AdminCenter.Share.Snapshot.MultiDeleteError",{extend:"SYNO.SDS.AdminCenter.Share.Snapshot.ModalWindow",constructor:function(e){var t=this;t.appWin=e.appWin,t.owner=e.owner,t.data=e.errorData;var i={layout:"fit",items:[],width:350,height:300,minHeight:200,buttons:[{text:_T("common","alt_close"),scope:t,handler:t.onCancel}]};t.callParent([Ext.apply(i,e)])},initComponent:function(){var e=this;e.items.push(e.createPanel()),e.callParent(arguments)},onCancel:function(){this.close()},initEvents:function(){this.callParent(arguments);var e=this,t=[],i=0;for(var s in e.data)if(Object.prototype.hasOwnProperty.call(e.data,s)){var n="",o="";for(var a in e.data[s])Object.prototype.hasOwnProperty.call(e.data[s],a)&&(n=a,o=e.data[s][a]);t[i]=[],t[i][0]=i,t[i][1]=String(n),t[i][2]=String(o),++i}e.store.loadData(t),e.setHeight(350)},createPanel:function(){var e,t=Ext.data.Record.create([{name:"idIndex"},{name:"name"},{name:"error"}]),i=new Ext.data.Store({appWindow:this.appWin,autoDestroy:!0,reader:new Ext.data.ArrayReader({idIndex:0},t)});this.store=i,e=_T("common","name");var s=new Ext.grid.ColumnModel({defaults:{width:120,sortable:!1},columns:[{id:"idIndex",header:_T("time","time_time"),dataIndex:"idIndex",hidden:!0},{id:"name",header:e,dataIndex:"name"},{id:"error",header:_T("error","error_error_reason"),dataIndex:"error",renderer:function(e,t,i){var s=parseInt(e,10);return SYNO.SDS.AdminCenter.Share.Snapshot.ShareSnapGetErrMsg(s,this)||_T("error","error_error_system")}}]}),n={forceFit:!0,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(e){e.scrollTop=e.scroller.dom.scrollTop},refresh:function(e){e.scroller.dom.scrollTop=e.scrollTop}}};return{layout:"fit",xtype:"syno_gridpanel",itemId:"snapshots",style:{padding:"0px 12px 0px 16px"},store:i,colModel:s,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1}),enableHdMenu:!1,viewConfig:n,enableColumnMove:!1,cls:"without-dirty-red-grid"}}}),Ext.ns("SYNO.SDS.AdminCenter.Share.Snapshot.Utils"),Ext.ns("SYNO.SDS.AdminCenter.Share.Snapshot"),SYNO.SDS.AdminCenter.Share.Snapshot.ROLE_UNKNOWN=0,SYNO.SDS.AdminCenter.Share.Snapshot.ROLE_MAINSITE=1,SYNO.SDS.AdminCenter.Share.Snapshot.ROLE_DRSITE=2,SYNO.SDS.AdminCenter.Share.Snapshot.WEBAPI_DEFAULT_TIMEOUT=12e4,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_KEEP_ALL=1<<31,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ALL=0,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_DEL_OLD=20,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_TRRIGER_BY_TIME=32,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_BY_DAY=64,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_BY_ADVANCE=128,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_MINIMUM=1,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_HOURLY=2,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAILY=4,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_WEEKLY=8,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_MONTHLY=16,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_YEARLY=32,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_ADV_POLICY_BY_DAY=64,SYNO.SDS.AdminCenter.Share.Snapshot.RTT_CFG_MAX=_D("max_snapshots_per_share","1024"),SYNO.SDS.AdminCenter.Share.Snapshot.IsMultiController=()=>"yes"===_D("support_ntbha","no"),SYNO.SDS.AdminCenter.Share.Snapshot.UniqArray=e=>e.filter(((e,t,i)=>t===i.indexOf(e))),SYNO.SDS.AdminCenter.Share.Snapshot.CheckSelected=function(e,t,i){var s=this.view.getSelectedRecords();if(0!==s.length){var n=e.call(this,s);if(0<n.length){Object.prototype.hasOwnProperty.call(n[0],"reasons")||(n=n.map((e=>({record:e,reasons:[]}))));var o=[];Ext.each(n,(e=>{var t=o.find((t=>e.record.get("name")===t.record.get("name")));t?t.reasons=t.reasons.concat(e.reasons):o.push(e)}));var a="",r="",l=s.length-n.length,d=!0;if(0===n[0].reasons.length)d=!1;else for(var c=o[0].reasons.toString(),h=1;h<o.length;++h)if(c!==o[h].reasons.toString()){d=!1;break}if(0===l&&d)r=SYNO.SDS.AdminCenter.Share.Snapshot.UniqArray(n[0].reasons).join(", "),this.module.appWin.getMsgBox().alert(a,r);else{var u=o.map((e=>e.record.get("name"))),p=u.join(", ");r=String.format("{0}<br><b>{1}</b>",_T("snapmgr","selected_targets_operation_deny"),p),0===l?this.module.appWin.getMsgBox().alert(a,r):(r=String.format("{0}<br><br>{1}",r,_T("snapmgr","continue_for_other_targets")),this.funcArgs=arguments,this.module.appWin.getMsgBox().confirm(a,r).then((e=>{if("confirm"===e){var t=n.map((e=>e.record));this.deselectRecords(t),SYNO.SDS.AdminCenter.Share.Snapshot.CheckSelected.apply(this,this.funcArgs)}})))}}else(t=t.bind(this,s))(Array.prototype.slice.call(arguments,2))}},SYNO.SDS.AdminCenter.Share.Snapshot.Utils.ValidateByteCount=(e,t)=>{var i=encodeURI(e).split(/%(?:u[0-9A-F]{2})?[0-9A-F]{2}|./).length-1;return!(i>t)||String.format(_T("snapmgr","byte_count_limit"),t,i)},SYNO.SDS.AdminCenter.Share.Snapshot.Utils.LockIconRenderer=e=>!0===e?'<div class="syno-admincenter-share-snapshot-lock"></div>':"",SYNO.SDS.AdminCenter.Share.Snapshot.Utils.NoteRenderer=e=>'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+e,SYNO.SDS.AdminCenter.Share.Snapshot.Utils.SharedConfigNotice=()=>SYNO.SDS.AdminCenter.Share.Snapshot.Utils.NoteRenderer(_T("snapmgr","shared_config_notice")),SYNO.SDS.AdminCenter.Share.Snapshot.Utils.TipRender=(e,t,i,s)=>{var n;i&&(n=i.get("qtip"));var o=void 0!==n&&n.length>0?n:e;return t.attr=!1===s?String.format('ext:qtip="{0}"',Ext.util.Format.htmlEncode(o)):String.format('ext:qtip="{0}"',Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(o))),Ext.util.Format.htmlEncode(e)},SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GetSnapTime=(e,t)=>{if(e&&t)return"share"===t?SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GMTToTimeStamp(e.time):1e3*e.time;SYNO.Debug("In GetSnapTime, invalid input (data, type): ",e,t)},SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GMTToTimeStamp=e=>{return e?(i=(t=(e=e.match(/^GMT(.*)-(.{19})$/))[2].split("-"))[0].split("."),s=t[1].split("."),n=new Date(Date.UTC(i[0],i[1]-1,i[2],s[0],s[1],s[2])),(o=e[1]).length>=3&&(n=n.add(Date.HOUR,-parseInt(o.substr(0,3),10))),5==o.length&&(n=n.add(Date.MINUTE,-parseInt(o[0]+o.substr(3,2),10))),n.getTime()):(SYNO.Debug("In GMTToTimeStamp, invalid input (time): ",e),null);var t,i,s,n,o},SYNO.SDS.AdminCenter.Share.Snapshot.Utils.LimitSnapshotSchedule=()=>"yes"===_D("limit_dr_snapshot_schedule","no"),SYNO.SDS.AdminCenter.Share.Snapshot.Utils.IsShareDRSite=e=>SYNO.SDS.AdminCenter.Share.Snapshot.Utils.IsRecordDRSite(e,e.get("name")),SYNO.SDS.AdminCenter.Share.Snapshot.Utils.IsRecordDRSite=function(e,t){var i=!1,s=e.get("plans");return s&&s.forEach((e=>{if(SYNO.SDS.AdminCenter.Share.Snapshot.ROLE_DRSITE===e.role&&e.target_id===t)return i=!0,!1}),this),i},SYNO.SDS.AdminCenter.Share.Snapshot.Utils.GetDailySchedule=e=>({week_name:"0,1,2,3,4,5,6",repeat_hour:0,repeat_min:0,hour:e,min:0,last_work_hour:e}),SYNO.SDS.AdminCenter.Share.Snapshot.Utils.checkShareSnapCompoundError=(e,t,i)=>SYNO.SDS.AdminCenter.Share.Snapshot.Utils.checkCompoundError(e,t,i,SYNO.SDS.AdminCenter.Share.Snapshot.ShareSnapGetErrMsg),SYNO.SDS.AdminCenter.Share.Snapshot.Utils.checkCompoundError=function(e,t,i,s){var n={},o=[];Ext.each(t.result,((e,t)=>{if(e.success)return!0;var a=i.compound[t].name;o.push(a);var r=s(e.error.code)||_T("common","error_system");Object.prototype.hasOwnProperty.call(n,r)?n[r].push(a):n[r]=[a]}),this);var a=_T("snapmgr","following_targets_failed")+"<br><br>";for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(a+=n[r].join(", ")+": "+r+"<br>");return{err_msg:a,err_target_names:o}},SYNO.SDS.AdminCenter.Share.Snapshot.MessageBox={OKSKIP:{ok:{text:Ext.MessageBox.buttonText.ok},cancel:{text:_T("common","skip")}}},SYNO.SDS.AdminCenter.Share.Snapshot.Utils.ReportWebapiFailure=(e,t)=>{var i;if(void 0!==t&&void 0!==e)if(i="string"==typeof t.text?t.text:t.errors?SYNO.SDS.Utils.StorageUtils.UiRenderHelper.getErrorMsg(t.errors):_T("error","error_subject"),e.getMsgBox)e.getMsgBox().alert(e.title,i);else{if(!e.owner.getMsgBox)throw Error("Not found 'getMsgBox'");e.owner.getMsgBox().alert(e.title,i)}},SYNO.SDS.AdminCenter.Share.Snapshot.ShareSnapGetErrMsg=e=>{var t;switch(e){case 3329:t=String.format(SYNO.API.Errors.core[e],SYNO.SDS.AdminCenter.Share.Snapshot.RTT_CFG_MAX,_D("max_btrfs_snapshots","65536"));break;case 402:case 3118:case 3328:case 3330:case 3331:case 3337:case 3340:case 3341:t=SYNO.API.Errors.core[e];break;case 3342:t=_T("snapmgr","err_volume_free_space_lessthan_reserved");break;case 5001:case 5002:t=SYNO.SDS.AdminCenter.Share.Snapshot.SnapUsageGetErrMsg(e)}return t},SYNO.SDS.AdminCenter.Share.Snapshot.SnapUsageGetErrMsg=e=>({5001:_T("snapmgr","calc_no_snapshot"),5002:_T("snapmgr","calc_share_calculating")}[e]),Ext.ns("SYNO.SDS.AdminCenter.Share"),SYNO.SDS.AdminCenter.Share.LocalStore="/usr/syno/etc/.encrypt",SYNO.SDS.AdminCenter.Share.GetPoolList=async function(){let e={};try{e=(await this.sendWebAPIPromise({api:"SYNO.Core.Storage.Pool",method:"list",params:{limit:-1,offset:0},version:1})).pools}catch(e){}return e},Ext.define("SYNO.SDS.AdminCenter.Share.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(),this.panel=new SYNO.SDS.AdminCenter.Share.Panel({module:this,appWin:e.appWin,app:e.app})},activate:function(e){return this.setActivateParams(e),this.panel.showHandler(),!0},focus:function(e){this.setActivateParams(e),this.panel.store.load()},getPanel:function(){return this.panel},getHelpParam:function(){return"AdminCenter/file_share_desc.html"},deactivate:function(){return!0},setActivateParams:function(e){e&&(e.c2share_name&&(this.toggleC2ShareOnLoad=e.c2share_name),"create"===e.dlg?this.panel.launchShareDialog({mode:"create",type:e.type}):"clone"===e.dlg?this.panel.launchShareDialog({mode:"clone",blNfsEnabled:e.params.blNfsEnabled,blNfsEncryptShareSupport:e.params.nfsEncryptShareSupport,blKerberosSupport:e.params.blKerberosSupport,blKerberosEnabled:e.params.blKerberosEnabled,share:e.params.share,snapshot:e.params.snapshot}):"edit"===e.dlg&&this.panel.launchShareDialog({mode:"edit",blNfsEnabled:e.params.blNfsEnabled,blNfsEncryptShareSupport:e.params.nfsEncryptShareSupport,blKerberosSupport:e.params.blKerberosSupport,blKerberosEnabled:e.params.blKerberosEnabled,share:e.params.share,startTabId:e.params.tabId}))}}),Ext.define("SYNO.SDS.AdminCenter.Share.Panel",{extend:"SYNO.ux.Panel",share_move_pollingId:void 0,quota_update_pollingId:void 0,cls:"syno-share-panel",constructor:function(e){this.module=e,this.appWin=e.appWin,this.app=e.app,this.nfsEnabled=!1,this.nfsKerberosSupport=!1,this.nfsKerberosEnabled=!1,this.nfsEncryptShareSupport=!1,this.supportShareSnapshot="yes"===_D("support_share_snapshot","no"),this.supportShareQuota="yes"===_D("support_share_quota","no"),this.supportBtrfs="yes"===_D("support_btrfs","no")&&!this.isHCM(),this.supportClone=!this.isHCM(),this.supportEnc="yes"===_D("support_share_encryption","no"),this.supportWorm="yes"===_D("support_worm","no"),this.isHCMAgent=this.isHCM()&&!_S("sofs_is_controller"),this.c2fsPkgName="SYNO.SDS.C2FS.Application",this.tierfsPkgName="SYNO.SDS.TierFS.AdminCenter.Instance",this.initC2Setting(),this.initWebAPI(),this.isTierPkgStatusStart=SYNO.SDS.StatusNotifier.isAppEnabled(this.tierfsPkgName);var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"sharefolderchanged",(function(e){this.scrollShareName=e,this.showHandler()}),this),this.mon(this.store,"load",this.checkShareMovePolling,this),this.mon(this.store,"load",this.checkQuotaUpdatePolling,this),this.mon(this,"afterrender",(function(){this.mon(this.el,"keydown",(function(e){e.getKey()==e.DELETE&&this.deleteHandler()}),this)}),this),this.initC2Event(),this.initTierEvent()},fillConfig:function(e){this.store=this.createStore(e),this.view=this.createView(this.store),this.actionGroup=this.createActionGroup(),this.tbar=this.createTBar();var t={tbar:this.tbar,layout:"fit",enableHdMenu:!1,bbar:new SYNO.ux.PageLessToolbar({store:this.store,pageSize:-1,displayInfo:!0,displayButtons:!1}),items:[this.view],listeners:{scope:this,rowdblclick:{scope:this,fn:function(e,t,i){var s=this.store.getAt(t);s&&-1===s.data.vol_path.indexOf("Gluster")&&this.launchShareDialog({share:s})}}}};return Ext.apply(t,e),t},initWebAPI:function(){this.webapiNfsGet={api:"SYNO.Core.FileServ.NFS",version:1,method:"get"},this.webapiNfsKerberosGet={api:"SYNO.Core.FileServ.NFS.Kerberos",version:1,method:"get"},this.webapiKeyManagerExplore={api:"SYNO.Core.Share.KeyManager.Store",version:1,method:"explore"},this.webapiKeyManagerKeyList={api:"SYNO.Core.Share.KeyManager.Key",version:1,method:"list"},this.webapiStorageGet={api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{limit:-1,offset:0,location:""===_D("usbstation")?"internal":"external",option:"include_cold_storage"}}},showHandler:function(){if(_S("is_admin")){var e=[];e.push(this.webapiNfsGet),e.push(this.webapiNfsKerberosGet),e.push(this.webapiKeyManagerExplore),e.push(this.webapiKeyManagerKeyList),e.push(this.webapiStorageGet),this.appWin.setStatusBusy(null,_T("common","msg_waiting")),SYNO.API.Request({compound:{stopwhenerror:!1,params:e},timeout:6e5,scope:this,callback:function(e,t,i){this.appWin.clearStatus(),e?this.afterLoad(t):this.appWin.getMsgBox().alert("",_T("common","error_system"))}})}else this.store.load()},appLaunchStorageManager:async function(){var e=_T("volume","volume_share_volume_create"),t=_T("volume","create_volume"),i="volume";0===(await SYNO.SDS.AdminCenter.Share.GetPoolList.call(this)).length&&(e=_T("volume","volume_share_pool_create"),t=_T("volume","volume_raid_creation_title"),i="both"),this.appWin.getMsgBox().alert("",e,(function(){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance",{fn:"SYNO.SDS.StorageManager.Pool.Main",vueWizard:"CreateWizard",modalParam:{width:820,height:560,title:t,mode:i}}),this.appWin.close()}),this)},afterLoad:function(e){if(e.result.forEach((function(e){if(!0===SYNO.ux.Utils.checkApiConsistency(this.webapiNfsGet,e))this.nfsEnabled=e.data.enable_nfs,this.nfsEncryptShareSupport=e.data.support_encrypt_share;else if(!0===SYNO.ux.Utils.checkApiConsistency(this.webapiNfsKerberosGet,e))this.nfsKerberosSupport=e.data.kerberos_support,this.nfsKerberosEnabled=0<e.data.kerberos_principal.length;else if(!0===SYNO.ux.Utils.checkApiConsistency(this.webapiKeyManagerExplore,e))this.keyManagerEnabled=e.data.stores.length>0,this.keyManagerLocation=e.data.stores[0];else if(!0===SYNO.ux.Utils.checkApiConsistency(this.webapiKeyManagerKeyList,e)){if(this.keyManagerKeyList={},e&&e.data&&e.data.keys)for(var t=0;t<e.data.keys.length;t++)this.keyManagerKeyList[e.data.keys[t].share_name]=e.data.keys[t].share_uuid}else!0===SYNO.ux.Utils.checkApiConsistency(this.webapiStorageGet,e)&&(this.volumes=e.data.volumes)}),this),0===this.volumes.length)return this.appLaunchStorageManager(),!1;this.store.load()},checkShareMovePolling:function(){var e,t=!1;this.share_move_pollingId||(this.store.data.items.forEach((function(i){if(i.get("is_share_moving")||i.get("is_applying_settings"))return t=!0,e=i,!1})),t&&(this.share_move_pollingId=this.pollReg({webapi:{api:"SYNO.Core.Share",method:"move_status",version:1,params:{task_id:e.get("task_id")}},interval:5,immediate:!0,scope:this,status_callback:function(t,i,s,n){var o=i.data;if(!t){this.stopShareMovePolling();var a=SYNO.API.Response.GetFirstError(o),r=SYNO.API.Errors.core[a.code]||_T("common","error_system");return SYNO.Debug("Error: "+r),this.fireEvent("sharefolderchanged",e.get("name")),void SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission")}t&&void 0!==o&&("success"===o.status?(this.sendWebAPI({webapi:{api:"SYNO.Core.Share",version:1,method:"stop_move",params:{task_id:e.get("task_id")},scope:this}}),this.stopShareMovePolling(),this.fireEvent("sharefolderchanged",e.get("name")),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission")):"cancelled"===o.status&&(this.stopShareMovePolling(),this.fireEvent("sharefolderchanged",e.get("name")),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission")))}})))},stopShareMovePolling:function(){this.share_move_pollingId&&(this.pollUnreg(this.share_move_pollingId),this.share_move_pollingId=void 0)},sharedFolderQuotaRenderer:function(e,t){return("v1"===e||"v2"===e)&&Ext.isNumber(t)&&0<t?SYNO.SDS.Utils.CapacityRender(t,2):_T("common","disabled")},makeWhiteTip:function(e){return`<span class="syno-ux-whitetip-icon" ext:wtip="${Ext.util.Format.htmlEncode(e)}"></span>`},sharedFolderSizeRenderer:function(e,t,i){return"updating"===e&&Ext.isNumber(t)?String.format("{0} ({1}%) {2}",_T("share","share_quota_status_calculating"),t.toFixed(1),this.makeWhiteTip(_T("share","share_quota_calculating_progress_desc"))):"incompatible"===e||"ready_to_update"===e?String.format("{0} {1}",_T("share","share_quota_status_unsupported"),this.makeWhiteTip(_T("share","unable_to_get_share_size"))):Ext.isNumber(i)?SYNO.SDS.Utils.CapacityRender(i,2):null},checkQuotaUpdatePolling:function(){var e=!1;this.quota_update_pollingId||(this.store.data.items.forEach((function(t){if("updating"===t.json.share_quota_status)return e=!0,!1})),e&&(this.quota_update_pollingId=this.pollReg({webapi:{api:"SYNO.Core.Share",method:"list",version:1,params:{additional:["share_quota"]}},interval:5,immediate:!0,scope:this,status_callback:function(e,t,i,s){let n=this,o=t.shares,a=!1;if(e&&void 0!==o&&Array.isArray(o)){let e={};o.forEach((function(t){void 0!==t.name&&(e[t.name]=t)})),this.store.data.items.forEach((function(t){let i=e[t.json.name];if(void 0===i)return!0;"updating"===i.share_quota_status&&(a=!0),t.set("quota_value",n.sharedFolderQuotaRenderer(i.share_quota_status,i.quota_value)),t.set("share_quota_used",n.sharedFolderSizeRenderer(i.share_quota_status,i.share_quota_update_progress,i.share_quota_used))})),a||this.stopQuotaUpdatePolling()}}})))},stopQuotaUpdatePolling:function(){this.quota_update_pollingId&&(this.pollUnreg(this.quota_update_pollingId),this.quota_update_pollingId=void 0)},stopPermissionReportPolling:function(){this.permission_report_export_pollingId&&(this.pollUnreg(this.permission_report_export_pollingId),this.permission_report_export_pollingId=void 0)},isSelectedShareInKeyManager:function(e){for(var t=!0,i=0;i<e.length;i++)if(1!==e[i].get("encryption")||!(e[i].get("name")in this.keyManagerKeyList)){t=!1;break}return t},isSelectedSharesContainTierfsShare:function(e){for(var t=0;t<e.length;t++)if(e[t].get("is_tierfs_share"))return!0;return!1},onSelectionChange:function(e,t){var i=this.view.getSelectionCount(),s=this.view.getSelectedRecords(),n=!1,o=!1,a=this.actionGroup,r=a.get("creation").initialConfig.menu.get("clone"),l=null,d=null,c=this.menuEncryption.get("encrypt"),h=this.menuEncryption.get("decrypt"),u=this.menuEncryption.get("exportkey"),p=a.get("action").initialConfig.menu.get("transform_to_c2share");if(a.get("action")&&a.get("action").initialConfig&&a.get("action").initialConfig.menu&&(a.get("action").initialConfig.menu.get("migrate")&&(l=a.get("action").initialConfig.menu.get("migrate")),a.get("action").initialConfig.menu.get("new_recycle_policy")&&(d=a.get("action").initialConfig.menu.get("new_recycle_policy"))),s.forEach((function(e){if(e&&(e.get("is_share_moving")||e.get("is_applying_settings")||e.get("is_missing_share")||e.get("is_offline_share")))return n=!0,!1})),s.forEach((function(e){if(e&&this.isWormShare(e.data))return o=!0,!1}),this),c.disable(),h.disable(),u.disable(),p.disable(),0===i)a.disableAll(),a.enable("add"),a.enable("creation"),r&&r.disable(),a.enable("action"),l&&l.disable(),d&&d.disable(),a.enable("encryption");else if(n)a.disableAll(),a.enable("add"),a.enable("creation"),a.enable("encryption");else if(a.enable("creation"),a.enable("delete"),a.enable("encryption"),a.enable("action"),r&&r.disable(),d&&(o?d.disable():d.enable()),1===i){var _=this.view.getSelectedRecords();if(!_[0])return;a.enable("edit");var m=_[0].get("is_aclmode"),f=_[0].get("is_support_acl"),S=_[0].get("encryption"),g=_[0].get("support_snapshot")||!1,y=_[0].get("is_usb_share"),b=_[0].get("is_tierfs_share"),v=0;!0===g&&(v=_[0].get("support_action")),1===S?h.enable():2===S&&(c.enable(),u.enable()),b&&(!0===this.isTierPkgStatusStart?a.enable("edit"):a.disable("edit"),a.disable("encryption")),r&&!0===g&&!y&&8&v&&r.enable(),!0!==g||y?a.disable("snapshots"):(a.enable("snapshots"),this.menuSnapshots.items.items.forEach((e=>{e.enable()}))),-1!==_[0].get("vol_path").indexOf("Gluster")&&a.disableAll(),l&&(!1===m&&!0===f?l.enable():l.disable()),this.canTransformToC2Share(_[0])&&p.enable()}else(function(){const e=this.view.getSelectedRecords(),t=this.actionGroup.get("snapshots"),i=this.menuSnapshots.get("snapshot_taking"),s=this.menuSnapshots.get("snapshot_management"),n=this.menuSnapshots.get("snapshot_setting");let o=!1;e.forEach((e=>{e.get("support_snapshot")&&(o=!0)})),o?(t.enable(),i.enable(),s.disable(),n.disable()):t.disable()}).bind(this)(),a.disable("edit"),l&&l.disable(),this.isSelectedShareInKeyManager(this.view.getSelectedRecords())&&h.enable(),this.isSelectedSharesContainTierfsShare(this.view.getSelectedRecords())&&a.disable("encryption")},createTBar:function(){var e=this.actionGroup.getArray();return new Ext.Toolbar({defaultType:"syno_button",items:[e,"->",new SYNO.ux.TextFilter({iconStyle:"filter",emptyText:_T("common","filter_label_text"),itemId:"search",localFilter:!0,localFilterField:["title","status"],tabIndex:-1,blOr:!0,store:this.store}),new Ext.Spacer({width:6}),new SYNO.SDS.AdminCenter.Share.SortButton({appWin:this.appWin,owner:this,menuItems:[{text:_T("pkgmgr","sort_by_name"),sortField:"title",handler:this.onSort,scope:this},{text:_T("volume","volume"),sortField:"vol_path",handler:this.onSort,scope:this}]})]})},onSort:function(e,t){var i=this.store.getSortState(),s="ASC";i.field===e.sortField&&(s="ASC"===i.direction?"DESC":"ASC"),this.store.sort(e.sortField,s)},initC2Setting:function(){this.isC2PkgStatusStart=SYNO.SDS.StatusNotifier.isAppEnabled(this.c2fsPkgName)},isHCM:function(){return"yes"===_D("support_hyper_converged","no")},isSupportC2:function(){return"yes"===_D("support_c2fs","no")&&"chs"!==_S("lang")},isSupportTransformToC2:function(){return this.isSupportC2()&&SYNO.SDS.C2FS&&SYNO.SDS.C2FS.UtilForDSM&&Ext.isFunction(SYNO.SDS.C2FS.UtilForDSM.canTransformToC2Share)&&Ext.isFunction(SYNO.SDS.C2FS.UtilForDSM.initTransformC2ShareWizard)},canTransformToC2Share:function(e){return!1===e.get("is_tierfs_share")&&!0===this.isC2PkgStatusStart&&SYNO.SDS.C2FS&&SYNO.SDS.C2FS.UtilForDSM&&Ext.isFunction(SYNO.SDS.C2FS.UtilForDSM.canTransformToC2Share)&&SYNO.SDS.C2FS.UtilForDSM.canTransformToC2Share(e)},initC2Event:function(){this.isSupportC2()&&(this.isC2PkgStatusStart&&SYNO.SDS.JSLoad(this.c2fsPkgName,function(){this.isSupportTransformToC2()&&this.actionGroup.get("action").initialConfig.menu.get("transform_to_c2share").show()}.bind(this)),this.mon(this,"beforedestroy",(function(){SYNO.SDS.Packages.unregisterPackageStatusChange(this.onC2PackageStatusChange,this)}),this),SYNO.SDS.Packages.registerPackageStatusChange(this.onC2PackageStatusChange,this,"HybridShare"))},initTierEvent:function(){this.isTierPkgStatusStart&&SYNO.SDS.JSLoad(this.tierfsPkgName,(function(){})),this.mon(this,"beforedestroy",(function(){SYNO.SDS.Packages.unregisterPackageStatusChange(this.loadTierInfo,this)}),this),SYNO.SDS.Packages.registerPackageStatusChange(this.loadTierInfo,this,"Tiering")},createActionGroup:function(){var e=this.supportClone&&this.supportShareSnapshot&&"yes"===_D("support_btrfs","no"),t=new Ext.Action({text:_T("common","create"),itemId:"add",scope:this,hidden:e||this.isHCMAgent,handler:function(){this.launchShareDialog({mode:"create"})}}),i=new SYNO.ux.Menu({items:[{text:this.isSupportC2()?_T("share","create_share"):_T("common","create"),itemId:"create",scope:this,handler:function(){this.launchShareDialog({mode:"create"})}},{text:_T("share","create_c2_share_folder"),itemId:"c2_share_folder",scope:this,hidden:!this.isSupportC2(),disabled:!this.isC2PkgStatusStart,handler:function(){if(this.isC2PkgStatusStart)try{this.launchShareDialog({mode:"create",type:"c2_share"})}catch(e){this.appWin.getMsgBox().alert("",_T("error","error_error_system"))}else this.appWin.getMsgBox().alert("",String.format(_T("share","c2_need_package"),"C2FS"))}},{text:_T("iscsilun","clone"),itemId:"clone",scope:this,handler:function(){var e=this.view.getSelectedRecords()[0];e&&this.launchShareDialog({share:e,mode:"clone"})}}]}),s=new Ext.Action({text:_T("common","create"),itemId:"creation",hidden:!e||this.isHCMAgent,scope:this,menu:i}),n=new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",scope:this,hidden:this.isHCMAgent,handler:function(){var e=this.view.getSelectedRecords();e&&e[0]&&this.launchShareDialog({share:e[0]})}}),o=new Ext.Action({text:_T("common","delete"),itemId:"delete",scope:this,hidden:this.isHCMAgent,handler:this.deleteHandler}),a=new Ext.Action({text:_T("keymanager","app_title"),itemId:"key_manager",scope:this,handler:this.keyManagerHandler});this.menuEncryption=new SYNO.ux.Menu({items:[{text:_T("share","share_encryption_encrypt"),itemId:"encrypt",scope:this,handler:this.unmountHandler},{text:_T("share","share_encryption_decrypt"),itemId:"decrypt",scope:this,handler:this.decryptHandler},{text:_T("share","share_encryption_exportkey"),itemId:"exportkey",scope:this,handler:this.exportKeyHandler},a]});var r=new Ext.Action({text:_T("share","share_encryption"),itemId:"encryption",hidden:"no"===_D("support_share_encryption","no")||!_S("is_admin"),scope:this,menu:this.menuEncryption}),l=new Ext.Action({text:_T("share","share_clean_all_recycle_bin"),scope:this,hidden:!1,handler:this.cleanRecycleHandler}),d=new Ext.Action({text:_T("network","cifs_recycle_bin_set_clean_policy"),itemId:"new_recycle_policy",scope:this,hidden:this.isHCM(),handler:this.newRecyclePolicyHandler}),c=new Ext.Action({text:_T("sharemigrate","button"),itemId:"migrate",hidden:"yes"!==_D("support_synoacl")||this.isHCM(),scope:this,handler:this.migrateHandler}),h=new Ext.Action({text:_T("perm_report","export_report_title"),itemId:"perm_report",hidden:"yes"!==_D("support_synoacl")||!_S("is_admin"),scope:this,handler:this.permissionReportHandler}),u=new Ext.Action({text:_T("share","c2_transform_to_c2share"),itemId:"transform_to_c2share",hidden:!0,disabled:!0,scope:this,handler:this.transformToC2Handler});this.menuOtherActions=new SYNO.ux.Menu({items:[l,d,c,h,u]});var p=new Ext.Action({text:_T("rcpower","action"),itemId:"action",hidden:!_S("is_admin")||this.isHCMAgent,scope:this,menu:this.menuOtherActions});this.menuSnapshots=new SYNO.ux.Menu({items:[{itemId:"snapshot_taking",text:_T("iscsilun","take_snapshot"),handler:this.onSnapshotTaking,hidden:this.isHCMAgent,scope:this},{itemId:"snapshot_management",text:_T("snapmgr","snap_list"),handler:this.onSnapshotManagement,scope:this},{itemId:"snapshot_setting",text:_T("common","common_settings"),handler:this.onSnapshotConfigure,hidden:this.isHCMAgent,scope:this}]});let _=new Ext.Action({text:_T("iscsilun","snapshot"),itemId:"snapshots",scope:this,hidden:!this.isHCM(),menu:this.menuSnapshots});return new SYNO.ux.Utils.ActionGroup([t,s,n,o,r,p,_])},deselectRecords:function(e){const t=this.view.getSelectedRecords();Ext.each(t,(t=>{e.find((e=>t.id===e.id))&&this.view.deselect(t)})),this.doLayout()},onTakeSnapshotDone:function(e){let t="[String] Taking snapshot for "+(e.num_share?e.num_share:1)+" shared folder(s) successfully";new SYNO.SDS.ToastBox({owner:this,delay:5e3,text:t})},onSnapshotTaking:function(e){SYNO.SDS.AdminCenter.Share.Snapshot.CheckSelected.call(this,(e=>{let t=[];return Ext.each(e,(e=>{var i=e.get("volume_crashed"),s=e.get("support_snapshot");!i&&s||t.push(e)}),this),t}),(e=>{const t=new SYNO.SDS.AdminCenter.Share.Snapshot.TakeSnapshot({appWin:this.appWin,owner:this.appWin,shares:e,title:_T("iscsilun","take_snapshot"),mode:"create"});this.mon(t,"take_snapshot_done",this.onTakeSnapshotDone,this),t.open()}))},onSnapshotManagement:function(){const e=this.view.getSelectedRecords();new SYNO.SDS.AdminCenter.Share.Snapshot.ManageSnapshot({appWin:this.appWin,owner:this.appWin,title:_T("snapmgr","snap_list")+" - "+e[0].get("name"),share:e[0]}).open()},onSnapshotConfigure:function(e){SYNO.SDS.AdminCenter.Share.Snapshot.CheckSelected.call(this,(e=>{var t=[];return Ext.each(e,(e=>{var i=e.get("volume_crashed"),s=e.get("support_snapshot");!i&&s||t.push(e)}),this),t}),(e=>{new SYNO.SDS.AdminCenter.Share.Snapshot.Configure.Main({appWin:this.appWin,owner:this.appWin,shares:e,title:_T("common","common_settings")}).open()}))},onContainerContextMenu:function(e,t){var i=this.view.getSelectedIndexes(),s=this.view.getSelectedNodes();this.onContextMenu(e,i[0],s[0],t)},onContextMenu:function(e,t,i,s){for(var n=this.view.getSelectedRecords(),o=0;o<n.length;++o)if(-1!==n[o].data.vol_path.indexOf("Gluster"))return;this.view.isSelected(t)||this.view.select(t);var a=this.actionGroup.getArray();new SYNO.ux.Menu({autoDestroy:!0,items:a}).showAt(s.getXY()),s.preventDefault()},isEncShare:function(e){return 1===e.encryption||2===e.encryption},isWormShare:function(e){return"enterprise"===e.worm_subvol_mode||"compliance"===e.worm_subvol_mode},tagRenderer:function(e){return""},tagClsRenderer:function(e){return this.isWormShare(e)?"tag-worm-img":""},conditionRenderer:function(e){if(e.is_volume_locked)return _T("share","share_temporarily_unavailable")+`<span class="syno-ux-whitetip-icon syno-admincenter-share-condition-tip" ext:wtip="${_T("share","share_on_locked_volume")}"></span>`;if(e.is_offline_share){if(e.is_volume_offline)return _T("share","share_temporarily_unavailable")+`<span class="syno-ux-whitetip-icon syno-admincenter-share-condition-tip" ext:wtip="${_T("share","share_offline_tip")}"></span>`;if(e.enable_share_tiering)return _T("share","share_temporarily_unavailable")+`<span class="syno-ux-whitetip-icon syno-admincenter-share-condition-tip" ext:wtip="${_T("share","tier_share_offline_tip")}"></span>`}return e.is_share_moving?_T("share","share_moving"):e.is_force_readonly?_T("common","readonly"):e.is_applying_settings?_T("common","applying_settings"):""},conditionClsRenderer:function(e){return e.is_offline_share?"item-status":e.is_share_moving||e.is_applying_settings?"blue-status":e.is_force_readonly?"orange-status":""},volumeRenderer:function(e){if(-1!==e.vol_path.indexOf("usb"))return!1===e.is_usb_share?e.display_vol_name:"SDCARD"===e.external_dev_type?_T("tree","leaf_sdcard"):_T("status","status_usb");if(-1!==e.vol_path.indexOf("sata"))return _T("status","status_sata");if(-1!==e.vol_path.indexOf("Gluster"))return _T("status","status_gluster");var t=this.volumes.find((function(t){return t.volume_path==e.vol_path})),i=e.vol_path.replace("/volume",""),s=Ext.util.Format.htmlEncode(Ext.isObject(t)?t.description:"");return Ext.isDefined(s)&&""!==s?String.format("{0} {1} ({2})",_T("volume","volume"),i,s):String.format("{0} {1}",_T("volume","volume"),i)},createStore:function(e){var t=this,i=["hidden","encryption","is_aclmode","unite_permission","is_support_acl","is_sync_share","is_force_readonly","force_readonly_reason","recyclebin","is_share_moving","is_cluster_share","is_exfat_share","is_c2_share","is_cold_storage_share","is_missing_share","is_offline_share"],s=[{name:"title",sortType:"asNaturalUCString",mapping:"name"},{name:"status",convert:function(e,i){return!0===i.is_missing_share?t.volumeRenderer(i)+" "+_T("volume","space_missing")+t.makeWhiteTip(_T("share","space_missing_tip")):!0===i.is_cluster_share?_T("share","peta_share_control_panel_vol_desc"):t.volumeRenderer(i)}},{name:"tag",convert:function(e,i){return t.tagRenderer(i)}},{name:"condition",convert:function(e,i){return t.conditionRenderer(i)}},{name:"iconCls",convert:function(e,t){return!0===t.is_missing_share||!0===t.is_offline_share?"item-icon-missing":""}},{name:"statusIconCls",convert:function(e,t){if(t.is_c2_share)return"syno-admincenter-c2share-icon";switch(t.encryption){case 0:return t.enable_share_compress?"syno-admincenter-share-compression":"default";case 1:return"syno-admincenter-share-lock";case 2:return"syno-admincenter-share-unlock";default:return"default"}}},{name:"tagCls",convert:function(e,i){return t.tagClsRenderer(i)}},{name:"conditionCls",convert:function(e,i){return t.conditionClsRenderer(i)}},{name:"unite_permission",convert:function(e,t){return e?_T("common","enabled"):_T("common","disabled")}},{name:"enable_recycle_bin",convert:function(e,t){return e?_T("common","enabled"):_T("common","disabled")}},{name:"force_readonly_reason",convert:function(e,t){return SYNO.SDS.Utils.GetFeasibilityCheckMsg(e)}},{name:"is_support_quota",convert:function(e,i){return t.supportShareQuota&&Ext.isDefined(i.share_quota_status)}},{name:"is_btrfs_share",convert:function(e,i){return t.supportBtrfs&&Ext.isDefined(i.enable_share_compress)&&Ext.isDefined(i.enable_share_cow)}},{name:"is_enc_share",convert:function(e,i){return t.supportEnc&&t.isEncShare(i)}},{name:"is_worm_share",convert:function(e,i){return t.supportWorm&&t.isWormShare(i)}},{name:"is_tierfs_share",convert:function(e,t){return t.enable_share_tiering}},"name","desc","hidden","vol_path","encryption","is_aclmode","is_support_acl","is_usb_share","is_sync_share","display_vol_name","external_dev_type","support_action","is_force_readonly","is_share_moving","is_applying_settings","task_id","is_cluster_share","is_exfat_share","cluster_share_mount","is_c2_share","is_cold_storage_share","is_missing_share","is_offline_share","worm_subvol_mode","worm_def_lock_mode","worm_lock_wait_time","worm_def_lock_duration"];return this.supportShareSnapshot&&(i=i.concat(["support_snapshot"]),s=s.concat(["support_snapshot"])),this.supportShareQuota&&(i=i.concat(["share_quota"]),s=s.concat([{name:"quota_value",convert:function(e,i){return t.sharedFolderQuotaRenderer(i.share_quota_status,e)}},{name:"share_quota_used",convert:function(e,i){return t.sharedFolderSizeRenderer(i.share_quota_status,i.share_quota_update_progress,e)}}])),this.supportEnc&&(s=s.concat([{name:"enable_encryption",convert:function(e,i){return t.isEncShare(i)?_T("common","enabled"):""}}])),this.supportWorm&&(s=s.concat([{name:"enable_worm",convert:function(e,t){return"enterprise"===t.worm_subvol_mode?_T("share","share_worm_mode_enterprise"):"compliance"===t.worm_subvol_mode?_T("share","share_worm_mode_compliance"):""}}])),this.supportBtrfs&&(i=i.concat(["enable_share_compress","enable_share_cow"]),s=s.concat([{name:"enable_share_compress",convert:function(e,i){var s=Math.max(i.share_quota_logical_size-i.share_quota_used,0),n=i.share_quota_logical_size?s/i.share_quota_logical_size*100:0;return e?i.support_compression_ratio?String.format("{0} {1} ({2}%)",_T("share","saved"),SYNO.SDS.Utils.CapacityRender(s,2),n.toFixed(1)):i.compression_ratio_tips?String.format("{0} {1}",_T("common","enabled"),t.makeWhiteTip(_T("share","share_compress_usage_enable_reminder"))):_T("common","enabled"):_T("common","disabled")}},{name:"enable_share_cow",convert:function(e,t){return e?_T("common","enabled"):_T("common","disabled")}}])),i=i.concat(["enable_share_tiering"]),s=s.concat([{name:"enable_share_tiering",convert:function(e,t){return e?_T("common","enabled"):_T("common","disabled")}}]),this.supportWorm&&(i=i.concat(["load_worm_attr"])),new SYNO.API.JsonStore({fields:s,api:"SYNO.Core.Share",method:"list",version:1,idProperty:"name",totalProperty:"total",remoteSort:!1,defaultSortable:!0,sortInfo:{field:"title",direction:"ASC"},baseParams:{additional:i.concat(["include_cold_storage_share","is_cold_storage_share","include_missing_share","is_missing_share","include_offline_share","is_offline_share","include_worm_share"]),shareType:"all"},root:"shares",appWindow:this.appWin,scope:this,listeners:{beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad},exception:{scope:this,fn:function(e,t,i,s,n,o){this.findAppWindow().getMsgBox().alert("",SYNO.API.getErrorString(n.code)),this.findAppWindow().clearStatus()}}}})},createView:function(e){var t=new SYNO.SDS.AdminCenter.Share.ListView({itemId:"listview",store:e});return t.mon(t,"selectionchange",this.onSelectionChange,this),t.mon(t,"containercontextmenu",this.onContainerContextMenu,this),t.mon(t,"contextmenu",this.onContextMenu,this),t},descRenderer:function(e,t,i){e=Ext.util.Format.htmlEncode(e);var s=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+s+'"',e},onBeforeLoad:function(){return Ext.isDefined(this.volumeInfoIsLatest)?(delete this.volumeInfoIsLatest,!0):(this.appWin.setStatusBusy(null,_T("common","msg_waiting")),SYNO.API.Request({api:"SYNO.Core.Storage.Volume",method:"list",version:1,scope:this,params:{limit:-1,offset:0,location:""===_D("usbstation")?"internal":"external"},callback:function(e,t,i){e?(this.volumes=t.volumes,this.volumeInfoIsLatest=!0,this.store.load()):(this.appWin.clearStatus(),this.appWin.getMsgBox().alert("",_T("common","error_system")))}}),!1)},onC2PackageStatusChange:function(e){(function(){return!1===this.isC2PkgStatusStart&&"start"===e||!0===this.isC2PkgStatusStart&&"start"!==e}).bind(this)()&&(this.isC2PkgStatusStart=SYNO.SDS.StatusNotifier.isAppEnabled(this.c2fsPkgName),this.isSupportTransformToC2()?this.actionGroup.get("action").initialConfig.menu.get("transform_to_c2share").show():this.actionGroup.get("action").initialConfig.menu.get("transform_to_c2share").hide(),this.isC2PkgStatusStart?this.actionGroup.get("creation").initialConfig.menu.get("c2_share_folder").enable():this.actionGroup.get("creation").initialConfig.menu.get("c2_share_folder").disable(),this.loadC2Info())},loadC2Info:function(){if(!this.isC2PkgStatusStart)return this.view.reloadTpl(),void this.store.each((function(e){!1!==e.get("is_c2_share")&&(e.set("condition",_T("share","c2_no_package_status")),e.set("conditionCls","red-status"))}));SYNO.SDS.JSLoad(this.c2fsPkgName,(function(){this.view.reloadTpl(),SYNO.SDS.C2FS.UtilForDSM.fetchInfoOfC2Share(this.store)}),this,(function(){this.view.reloadTpl(),this.store.each((function(e){!1!==e.get("is_c2_share")&&(e.set("condition",_T("share","c2_no_package_status")),e.set("conditionCls","red-status"))}))}))},loadTierInfo:function(){if(this.isTierPkgStatusStart=SYNO.SDS.StatusNotifier.isAppEnabled(this.tierfsPkgName),!this.isTierPkgStatusStart)return this.view.reloadTpl(),void this.store.each((function(e){!1!==e.get("is_tierfs_share")&&(e.set("condition",_T("share","tierfs_no_package_status")),e.set("conditionCls","red-status"))}));SYNO.SDS.JSLoad(this.tierfsPkgName,(function(){this.view.reloadTpl(),SYNO.SDS.TierFS.UtilForDSM.fetchInfoOfTierfsShare(this.store)}),this,(function(){this.view.reloadTpl(),this.store.each((function(e){!1!==e.get("is_tierfs_share")&&(e.set("condition",_T("share","tierfs_no_package_status")),e.set("conditionCls","red-status"))}))}))},onLoad:function(e,t,i){if(this.view.clearSelections(),this.loadC2Info(),this.loadTierInfo(),this.appWin.clearStatus(),this.onSelectionChange(),0===this.store.data.length){var s=this.actionGroup;s.disableAll();var n=s.get("creation").initialConfig.menu.get("clone");return s.enable("add"),s.enable("creation"),void n.disable()}if(void 0!==this.module.toggleC2ShareOnLoad){var o=this.module.toggleC2ShareOnLoad,a=e.indexOfId(o);if(-1===a)return;this.view.select(a),this.view.toggledItemIds.includes(o)||this.view.toggleSelectedItem(),delete this.module.toggleC2ShareOnLoad}if(Ext.isDefined(this.scrollShareName)){var r=this.scrollShareName;delete this.scrollShareName;var l=e.indexOfId(r);-1!==l&&(this.view.select(l),this.view.ensureVisible(l))}},launchShareDialog:function(e,t,i){if("clone"===e.mode||"create"===e.mode){var s=_D("maxshares");if(s<=this.store.getTotalCount())return void this.findAppWindow().getMsgBox().alert("",String.format(_T("share","error_toomanysh"),s))}var n,o,a=this.store.getTotalCount();if("clone"===e.mode)n=new SYNO.SDS.AdminCenter.Share.Dialog(Ext.apply({module:this.module,owner:this.module.appWin,blNfsEnabled:void 0!==e.blNfsEnabled?e.blNfsEnabled:this.nfsEnabled,blNfsEncryptShareSupport:void 0!==e.blNfsEncryptShareSupport?e.blNfsEncryptShareSupport:this.nfsEncryptShareSupport,blKerberosSupport:void 0!==e.blKerberosSupport?e.blKerberosSupport:this.nfsKerberosSupport,blKerberosEnabled:void 0!==e.blKerberosEnabled?e.blKerberosEnabled:this.nfsKerberosEnabled,blKeyManagerEnabled:this.keyManagerEnabled,keyManagerLocation:this.keyManagerLocation,mode:"clone"},e)),o=e.share.get("encryption");else if("create"===e.mode)if("c2_share"===e.type){var r=SYNO.SDS.C2FS.UtilForDSM.getAndCheckNotSupportReason();if(""!==r)return void this.appWin.getMsgBox().alert("",r);n=SYNO.SDS.C2FS.UtilForDSM.initCreateC2ShareWizard(Ext.apply({width:820,height:560,module:this.module,owner:this.appWin},e))}else n=new SYNO.SDS.AdminCenter.Share.CreateWizard(Ext.apply({module:this.module,owner:this.module.appWin,store:this.store,blNfsEnabled:this.nfsEnabled,blNfsEncryptShareSupport:this.nfsEncryptShareSupport,blKerberosSupport:this.nfsKerberosSupport,blKerberosEnabled:this.nfsKerberosEnabled,blKeyManagerEnabled:this.keyManagerEnabled,keyManagerLocation:this.keyManagerLocation,startTabId:t},e));else if(!0===e.share.get("is_c2_share")){if(!this.isC2PkgStatusStart)return void this.appWin.getMsgBox().alert("",String.format(_T("share","c2_need_package"),"C2FS"));n=SYNO.SDS.C2FS.UtilForDSM.initEditC2ShareWizard(Ext.apply({module:this.module,owner:this.module.appWin,blNfsEnabled:this.nfsEnabled,blNfsEncryptShareSupport:this.nfsEncryptShareSupport,blKerberosSupport:this.nfsKerberosSupport,blKerberosEnabled:this.nfsKerberosEnabled,blKeyManagerEnabled:this.keyManagerEnabled,keyManagerLocation:this.keyManagerLocation,startTabId:t,mode:"edit"},e))}else n=!0===e.share.get("is_tierfs_share")?SYNO.SDS.TierFS.UtilForDSM.initEditTierFsShareWizard(Ext.apply({module:this.module,owner:this.module.appWin,blNfsEnabled:this.nfsEnabled,blNfsEncryptShareSupport:this.nfsEncryptShareSupport,blKerberosSupport:this.nfsKerberosSupport,blKerberosEnabled:this.nfsKerberosEnabled,blKeyManagerEnabled:this.keyManagerEnabled,keyManagerLocation:this.keyManagerLocation,startTabId:t,mode:"edit"},e)):new SYNO.SDS.AdminCenter.Share.Dialog(Ext.apply({module:this.module,owner:this.module.appWin,blNfsEnabled:this.nfsEnabled,blNfsEncryptShareSupport:this.nfsEncryptShareSupport,blKerberosSupport:this.nfsKerberosSupport,blKerberosEnabled:this.nfsKerberosEnabled,blKeyManagerEnabled:this.keyManagerEnabled,keyManagerLocation:this.keyManagerLocation,startTabId:t,mode:"edit"},e));"clone"===e.mode&&0===o||"create"===e.mode?("clone"===e.mode&&0===o&&this.mon(n,"beforeclose",(function(){var e=n.getCreateResult();e&&this.launchShareDialog({share:e},"sharegrid")}),this,{single:!0}),a>=255?this.findAppWindow().getMsgBox().confirm("",_T("share","error_toomanyafpsh")+" "+_T("common","ask_cont"),(function(t){"yes"===t&&("create"===e.mode?n.onOpen():n.open())}),this):"create"===e.mode?n.onOpen():n.open()):n.open()},migrateHandler:function(e,t){var i,s=this.view.getSelectedRecords()[0],n=[];s&&s.data&&s.data.name&&(n.push(s.data.name),i=new SYNO.SDS.AdminCenter.Share.Migrate.Wizard({targetShare:n,caller:this,module:this.module,owner:this.module.appWin}),SYNO.SDS.Utils.S2S.confirmIfSyncShareAffected(!1,{name:s.data.name,is_sync_share:s.data.is_sync_share,no_check_permission:!0},{dialogTitle:"",dialogMsg:_T("s2s","s2s_warn_share_change_priv"),dialogOwner:this.module.appWin,continueHandler:function(){i.open()},abortHandler:Ext.emptyFn,scope:this}))},permissionReportHandler:function(e,t){new SYNO.SDS.AdminCenter.Share.PermissionReport.Dialog({module:this.module,owner:this.module.appWin}).open()},transformToC2Handler:function(e,t){var i=this.view.getSelectedRecords()[0];i&&i.data&&i.data.name&&SYNO.SDS.C2FS.UtilForDSM.initTransformC2ShareWizard({module:this.module,owner:this.appWin,share:i}).open()},launchKeyManager:function(){var e=new SYNO.SDS.AdminCenter.Share.KeyManager({module:this.module,owner:this.module.appWin,shares:this.store.data.items,storeInRoot:this.keyManagerLocation===SYNO.SDS.AdminCenter.Share.LocalStore});e.open(),this.mon(e,"close",(function(){this.showHandler()}),this)},keyManagerHandler:function(e,t){this.sendWebAPI({api:"SYNO.Core.Share.KeyManager.Store",method:"explore",version:1,params:{},scope:this,callback:function(e,t,i){if(e)if(0===t.stores.length){var s=new SYNO.SDS.AdminCenter.Share.InitStore({share_module:this,module:this.module,owner:this.module.appWin,shares:this.store.data.items});s.open(),this.mon(s,"close",(function(){this.keyManagerEnabled&&this.launchKeyManager()}),this)}else this.keyManagerLocation=t.stores[0],this.launchKeyManager();else{var n=SYNO.API.Response.GetFirstError(t),o=SYNO.API.Errors.core[n.code]||_T("common","error_system");this.getMsgBox().alert("",o)}}})},deleteHandler:function(){var e=this.view.getSelectedRecords();e&&this.deleteShare(e)},newRecyclePolicyHandler:function(){var e=this.view.getSelectedRecords();this.app.startModule("SYNO.SDS.AdminCenter.TaskScheduler.Main",{newRecycleBinPolicy:!0,share:e})},cleanRecycleHandler:function(){if(_S("demo_mode"))this.findAppWindow().getMsgBox().alert("",_JSLIBSTR("uicommon","error_demo"));else{var e={confirm:{text:Ext.MessageBox.buttonText.yes,btnStyle:"red"},cancel:{text:Ext.MessageBox.buttonText.no}};this.findAppWindow().getMsgBox().confirmDelete(_T("share","share_clean_recycle_bin"),_T("share","share_all_recycle_bin_clean_warn"),e).then((e=>{"confirm"===e&&this.sendWebAPI({api:"SYNO.Core.RecycleBin",method:"start",version:1,prams:{}})}))}},deleteShare:function(e){var t={normal:[],c2:[],tiering:[]},i=[],s=[],n=!1;if(Ext.each(e,(function(e,i,o){-1!==e.get("vol_path").indexOf("Gluster")?s.push(e.get("name")):!0===e.get("is_c2_share")?t.c2.push(e.get("name")):t.normal.push(e.get("name")),!0===e.get("is_btrfs_share")&&(n=!0),!0===e.get("is_tierfs_share")&&t.tiering.push(e.get("name"))}),this),0!==s.length)return this.errorGlusterMsg(s.join(", ")),!1;if(0!==t.normal.length||0!==t.c2.length){if(i.push({api:"SYNO.Core.Share",method:"validate_delete",params:{name:t.normal}}),0!==t.c2.length){if(!this.isC2PkgStatusStart)return void this.appWin.getMsgBox().alert("",String.format(_T("share","c2_need_package"),"C2FS"));i.push({api:"SYNO.C2FS.Share",method:"validate_delete",params:{name:t.c2}})}0==t.tiering.length||this.isTierPkgStatusStart?(this.module.appWin.setStatusBusy(null,_T("common","msg_waiting")),this.sendWebAPI({compound:{mode:"parallel",params:i},timeout:6e5,version:1,scope:this,callback:function(e,i,s){this.module.appWin.clearStatus();var o=SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Share","validate_delete"),a=SYNO.API.Response.GetValByAPI(i,"SYNO.C2FS.Share","validate_delete");if(i.has_fail){var r={},l=o&&o.errors?o.errors:{},d=a&&a.errors?a.errors:{};Object.keys(l).forEach((function(e){Array.isArray(l[e])&&(r[e]=l[e].concat(d[e]))})),Object.keys(d).forEach((function(e){Array.isArray(d[e])&&!r.hasOwnProperty(e)&&(r[e]=d[e])})),Object.keys(r).forEach((function(e){r[e]=r[e].filter((function(e){return e}))}));var c=this.combineWarningMsg(r);try{SYNO.SDS.C2FS.UtilForDSM.exclusiveValidateDeleteWarnMsg(a).forEach((function(e){c.push(e)}))}catch(e){}return 0===c.length&&c.push(_T("common","error_system")),this.module.appWin.getMsgBox().alert("",c.join(""),null,{useHtml:!0}),!1}o||a?this.warningConfirm(i,t,n):this.loadDeleteDialog(i,t,n)}})):this.appWin.getMsgBox().alert("",_T("share","tierfs_need_package"))}},errorGlusterMsg:function(e){var t;return t=_T("share","share_gluster_share")+e,this.module.appWin.getMsgBox().alert("",t),!1},warningConfirm:function(e,t,i){var s=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Share","validate_delete"),n=SYNO.API.Response.GetValByAPI(e,"SYNO.C2FS.Share","validate_delete"),o={warning_sd_destination:[],warning_usb_destination:[],warning_disable_service:[]};s&&(s.warning_sd_destination&&o.warning_sd_destination.push(s.warning_sd_destination),s.warning_usb_destination&&o.warning_usb_destination.push(s.warning_usb_destination),s.warning_disable_service&&o.warning_disable_service.push(s.warning_disable_service)),n&&(n.warning_sd_destination&&o.warning_sd_destination.push(n.warning_sd_destination),n.warning_usb_destination&&o.warning_usb_destination.push(n.warning_usb_destination),n.warning_disable_service&&o.warning_disable_service.push(n.warning_disable_service)),Object.keys(o).forEach((function(e){0!==o[e].length?o[e]=o[e].join(", "):delete o[e]}));var a=this.combineWarningConfirm(o);0!==a.length?this.module.appWin.getMsgBox().confirmDelete("",a,(function(s,n,o){if("yes"===s){if(0===t.normal.length&&0===t.c2.length)return;this.loadDeleteDialog(e,t,i)}}),this):this.loadDeleteDialog(e,t,i)},generatePackageWarningMsg:function(e,t){for(var i,s=[],n=0;n<e.length;n++)s.push(SYNO.SDS.AdminCenter.Share.Utils.GetPackageName(e[n]));return i=String.format("{0}<br><b>{1}</b><br>",t,e.join(", ")),i=String.format(i,s.join(", "))},combineWarningMsg:function(e){var t=[];if(e.hasOwnProperty("warning_external")){var i=String.format("{0}<br><b>{1}</b><br>",_T("share","share_cannot_delete_for_reserved"),e.warning_external.join(", "));t.push(i)}if(e.hasOwnProperty("warning_mount_point")){var s=String.format("{0}<br><b>{1}</b><br>",_T("share","error_mount_point_delete"),e.warning_mount_point.join(", "));t.push(s)}if(e.hasOwnProperty("warning_homes")){var n=String.format("{0}<br><b>{1}</b><br>",_T("share","error_home_service"),e.warning_homes.join(", "));t.push(n)}if(e.hasOwnProperty("warning_ftp_anonymousroot")){var o=String.format("{0}<br><b>{1}</b><br>",_T("share","error_ftp_anonymousroot"),e.warning_ftp_anonymousroot.join(", "));t.push(o)}if(e.hasOwnProperty("warning_ftp_userchroot")&&t.push(String.format("{0}<br><b>{1}</b><br>",_T("share",1==e.warning_ftp_userchroot.length?"error_ftp_userchroot":"error_ftp_userchroot_plural"),e.warning_ftp_userchroot.join(", "))),e.hasOwnProperty("warning_replica_demote")){var a=String.format("{0}<br><b>{1}</b><br>",_T("share","error_replica_demote"),e.warning_replica_demote.join(", "));t.push(a)}if(e.hasOwnProperty("warning_replica_promote")){var r=String.format("{0}<br><b>{1}</b><br>",_T("snapmgr","error_replica_promote"),e.warning_replica_promote.join(", "));t.push(r)}if(e.hasOwnProperty("warning_disable_package")||e.hasOwnProperty("warning_uninstall_package")?(e.hasOwnProperty("warning_disable_package")&&t.push(this.generatePackageWarningMsg(e.warning_disable_package,_T("share","error_packages"))),e.hasOwnProperty("warning_uninstall_package")&&t.push(this.generatePackageWarningMsg(e.warning_uninstall_package,_T("share","error_package_uninstall")))):e.hasOwnProperty("warning_package")&&t.push(this.generatePackageWarningMsg(e.warning_package,_T("share","error_packages"))),e.hasOwnProperty("warning_cluster_share")){var l=String.format("{0}<br><b>{1}</b><br>",_T("share","error_cluster_share"),e.warning_cluster_share.join(", "));t.push(l)}if(e.hasOwnProperty("warning_worm_snapshot")){var d=String.format("{0}<br><b>{1}</b><br>",_T("share","error_worm_snapshot"),e.warning_worm_snapshot.join(", "));t.push(d)}return t},combineWarningConfirm:function(e){var t="";if(e.hasOwnProperty("warning_sd_destination")){var i=String.format(_T("share","share_rmsdcopyfolderempty"),e.warning_sd_destination);t=i}if(e.hasOwnProperty("warning_usb_destination")){var s=String.format(_T("share","share_rmusbcopyfolderempty"),e.warning_usb_destination);t=""===t?s:t+"<b>"+s}return e.hasOwnProperty("warning_disable_service")&&(Ext.each(e.warning_disable_service,(function(e){var i,s,n=e.services,o=[];if(!Ext.isArray(n))return!1;Ext.each(n,(function(e){o.push(SYNO.SDS.AdminCenter.Share.Utils.GetServiceI18N(e))})),i="<b>"+e.share+"</b>",s="<b>"+o.join(", ")+"</b>",t=""===t?String.format(_T("share","share_service_disable_confirm"),i,s):t+"<br>"+String.format(_T("share","share_service_disable_confirm"),i,s)})),t=t+"<br><br>"+_T("share","share_service_disable_confirm_post")),t},loadDeleteDialog:function(e,t,i){var s,n=t.normal.length+t.c2.length>1;s=i||t.c2.length>0?n?_T("share","share_delete_confirm_more"):_T("share","share_single_delete_confirm_more"):n?_T("share","share_delete_confirm_multiple"):_T("share","share_delete_confirm"),s+='<ul style="list-style-type: disc; list-style-position: inside;">',i&&(s+=n?String.format("<li>{0}</li>",_T("share","share_snapshot_delete_confirm")):String.format("<li>{0}</li>",_T("share","share_snapshot_single_delete_confirm"))),t.c2.length>0&&(s+=String.format("<li>{0}</li>",_T("share","c2share_delete_confirm"))),t.tiering.length>0&&(s+=String.format("<li>{0}</li>",_T("share","tiering_share_delete_confirm"))),s+="</ul>";var o=new SYNO.SDS.AdminCenter.Share.Delete({module:this,owner:this.module.appWin,shares:t,alert_message:s});o.open(),o.loadShareName(_T("share","share_cfrmrmv"),e)},unmountHandler:function(e,t){var i=this.view.getSelectedRecords()[0];this.module.appWin.setStatusBusy(null,_T("common","msg_waiting")),this.sendWebAPI({api:"SYNO.Core.Share.Crypto",method:"validate_encrypt",version:1,params:{name:i.id},scope:this,callback:function(e,t,s){var n=[],o="",a="";if(this.module.appWin.clearStatus(),!e)return this.module.appWin.getMsgBox().alert("",_T("common","error_system")),void this.store.load();t&&t.warning_pause_service?(Ext.each(t.warning_pause_service,(function(e){n.push(SYNO.SDS.AdminCenter.Share.Utils.GetServiceI18N(e))})),o="<b>"+n.join(", ")+"</b><br>",a=String.format(_T("share","encrypt_share_service_pause_confirm"),i.id,o)):a=_T("share","share_encryption_encrypt_confirm"),this.doUnmountPreAction(a,i.id,t)}})},getFeasibilityMsg:function(e){let t="";return Ext.each(e,(function(e){t+=String.format("<li>{0}</li>",SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))})),String.format('<ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;">{0}</ul>',t)},alertUnmountInFeasibilable:function(e){this.module.appWin.getMsgBox().alert("",this.getFeasibilityMsg(e))},confirmUnmountSoftCheckPromise:function(e,t){return new Promise(((i,s)=>{if(!e||!e.soft||!e.soft[t])return void i();let n=e.soft[t];this.module.appWin.getMsgBox().confirm("",this.getFeasibilityMsg(n),{cancel:{text:_T("common","no")},confirm:{text:_T("common","yes"),btnStyle:"blue"}},{useHtml:!0}).then((e=>{"confirm"===e?i():s()}))}))},confirmUnmountPromise:function(e){return new Promise(((t,i)=>{this.module.appWin.getMsgBox().confirm("",e).then((e=>{"confirm"===e?t():i()}))}))},doUnmountPreAction:function(e,t,i){i&&i.hard&&i.hard[t]?this.alertUnmountInFeasibilable(i.hard[t]):this.confirmUnmountPromise(e).then((()=>this.confirmUnmountSoftCheckPromise(i,t))).then((()=>this.doUnmount(t))).catch(Ext.emptyFn)},doUnmount:function(e){this.module.appWin.setStatusBusy(null,_T("common","msg_waiting")),this.sendWebAPI({api:"SYNO.Core.Share.Crypto",method:"encrypt",version:1,params:{name:e},scope:this,callback:function(e,t,i){this.module.appWin.clearStatus(),e||this.module.appWin.getMsgBox().alert("",_T("share","mount_point_not_empty")),SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged","permission"),this.store.load()}})},decryptHandler:function(){var e=this.view.getSelectedRecords();new SYNO.SDS.AdminCenter.Share.Decrypt({module:this.module,owner:this.module.appWin,share:e,decrypt_by_km:this.isSelectedShareInKeyManager(e),km_location:this.keyManagerLocation}).open()},exportKeyHandler:function(){var e=this.view.getSelectedRecords()[0];new SYNO.SDS.AdminCenter.Share.Export({module:this.module,owner:this.module.appWin,share:e}).open()}}),Ext.define("SYNO.SDS.AdminCenter.FileService.FakeWinTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.link_id=Ext.id();let t=String.format('<a id="{0}" class="link-font" style="cursor:pointer">{1}</a>',this.link_id,_T("tree","leaf_packagemanage")),i=String.format(_T("domain","need_samba_service"),t,_T("network","smb_app_name"));var s=Ext.apply({title:_T("network","wnds_file_service"),items:[{xtype:"syno_displayfield",value:i,htmlEncode:!1,listeners:{afterrender:function(){this.mon(Ext.get(this.link_id),"click",this.launchPkgSMBPage)},scope:this}},{xtype:"syno_checkbox",itemId:"enable_samba",checked:!1,hidden:!0}]},e);this.callParent([s])},launchPkgSMBPage:function(){SYNO.SDS.AppLaunch("SYNO.SDS.PkgManApp.Instance",{action:"open",packages:["SMBService"]})}}),Ext.define("SYNO.SDS.AdminCenter.FileService.FakeNFSTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.link_id=Ext.id();let t=String.format('<a id="{0}" class="link-font" style="cursor:pointer">{1}</a>',this.link_id,_T("tree","leaf_packagemanage")),i=String.format(_T("domain","need_samba_service"),t,_T("nfs","nfs_title"));var s=Ext.apply({title:_T("tree","leaf_nfs"),items:[{xtype:"syno_displayfield",value:i,htmlEncode:!1,listeners:{afterrender:function(){this.mon(Ext.get(this.link_id),"click",this.launchPkgNFSPage)},scope:this}},{xtype:"syno_checkbox",itemId:"enable_nfs",checked:!1,hidden:!0}]},e);this.callParent([s])},launchPkgNFSPage:function(){SYNO.SDS.AppLaunch("SYNO.SDS.PkgManApp.Instance",{action:"open",packages:["NFSService"]})}}),Ext.define("SYNO.SDS.AdminCenter.FileService.AfpTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.afpTMEnable=!1,this.callParent([t]),this.macHelpBox=Ext.getCmp(this.macHelpBox),this.on("afterlayout",this.onPanelAfterLayout,this,{single:!0})},onPanelAfterLayout:function(e,t){e.mon(e.getForm().findField("enable_afp"),"check",(function(e,t){this.setMacHelpBoxVisible(t),this.getComponent("advanceBtnId").setDisabled(!t)}),this),this.checkEnableAFP=new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"enable_afp",["afp_transfer_log_enable"])},setMacHelpBoxVisible:function(e){this.macHelpBox.setVisible(e),this.doLayout()},fillConfig:function(e){var t={title:_T("network","apple_subject"),autoScroll:!0,webapi:{api:"SYNO.Core.FileServ.AFP",methods:{get:"get",set:"set"},version:1},items:this.createMacTabObj(e)};return Ext.apply(t,e),t},createMacTabObj:function(e){return[{xtype:"syno_checkbox",itemId:"enable_afp",name:"enable_afp",boxLabel:_T("network","apple_enable")},{xtype:"syno_checkbox",name:"afp_transfer_log_enable",itemId:"afp_transfer_log_enable",indent:1,boxLabel:_T("service","service_afp_transfer_log"),listeners:{enable:{scope:this,fn:function(e){!0===this.getComponent("enable_afp").originalValue&&!0===e.originalValue&&this.getComponent("afpLogBtn").setDisabled(!1)}},disable:{scope:this,fn:function(){this.getComponent("afpLogBtn").setDisabled(!0)}}}},{xtype:"syno_button",btnStyle:"default",itemId:"afpLogBtn",name:"afpLogBtn",text:_T("log","log_subtitle"),autoWidth:!0,indent:2,style:{marginBottom:"0px"},handler:function(){SYNO.SDS.AppLaunch("SYNO.SDS.LogCenter.BuiltIn",{logType:"fileTransfer",protocol:"afpxfer"})}},{xtype:"spacer",height:18},{xtype:"syno_button",btnStyle:"default",name:"advanceBtnId",itemId:"advanceBtnId",text:_T("common","adv_setting"),indent:1,style:{marginBottom:"0px"},scope:this,handler:this.onAfpAdvSettingBtnClick},{xtype:"spacer",height:18},{xtype:"syno_displayfield",itemId:"afpNoteId",fieldLabel:"Note",hideLabel:!0,indent:1,htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+' </span><br><ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;"><li>'+String.format(_T("service","afp_time_machine_note_desc"),'<a id="'+Ext.id()+'" class="link-font" href="">'+_T("common","advanced")+"</a>")+"</li><li>"+String.format(_T("fileindex","fileindex_spotlight_win_desc"),'<a id="'+Ext.id()+'" class="link-font" href="">'+_T("fileindex","indexed_folder_list")+"</a>")+"</li></ul>",listeners:{render:function(e){var t=e.el.select("a"),i=t.item(0);i&&this.mon(i,"click",(function(e){e.preventDefault(),SYNO.SDS.AdminCenter.FileService.AfpTab.Utils.onClickServiceDiscoveryUrl(this.module)}),this);var s=t.item(1);s&&this.mon(s,"click",(function(e){e.preventDefault(),SYNO.SDS.AdminCenter.FileService.AfpTab.Utils.onClickFileIndexUrl(this.module.appWin)}),this)},scope:this,single:!0,buffer:80}},{xtype:"box",hidden:"true",id:this.macHelpBox=Ext.id(),tpl:new Ext.XTemplate('<div class="syno_fileservice_container"><div><div class="description normal-font" tabIndex="0" aria-labelledby="{this.promptId}"><span id="{this.promptId}">'+_T("network","share_access_prompt")+'</span></div><div class="content" tabIndex="0" aria-labelledby="{this.promptMacId} {this.promptMacHostnameId}"><span id="{this.promptMacId}" class="title normal-font">'+_T("network","share_access_prompt_mac")+" ("+_T("network","mac_finder")+")"+_T("common","colon")+'</span><span id="{this.promptMacHostnameId}" class="info allowDefCtxMenu link-font" style="text-decoration: none">afp://{hostname}.local</span></div></div></div>',{promptId:Ext.id(),promptMacId:Ext.id(),promptMacHostnameId:Ext.id()})}]},selectHelpText:function(e,t){var i=t.ownerDocument.createRange();i.selectNode(t.firstChild);var s=window.getSelection();s.removeAllRanges(),s.addRange(i)},onAfpAdvSettingBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.AFP.AdvancedSettingDialog({module:this.module,owner:this.module.appWin}).open()},onBeforeRequest:function(e){return!0},processParams:function(e,t){var i={};if("set"==e){i=this.getForm().getValues(),this.getForm().findField("afp_transfer_log_enable").isDirty()&&(t=t.concat({api:"SYNO.Core.SyslogClient.FileTransfer",method:"set",version:1,params:{afp:i.afp_transfer_log_enable}})),this.afpChange=this.getForm().findField("enable_afp").isDirty();var s=this.getForm().findField("enable_afp").checked;this.afpChange&&(this.afpTMEnable=!!s&&this.afpTMEnable,t=t.concat({api:"SYNO.Core.FileServ.ServiceDiscovery",method:"set",version:1,params:{enable_afp_time_machine:this.afpTMEnable}}))}return t=(t=(t=(t=t.concat({api:"SYNO.Core.FileServ.ServiceDiscovery",method:"get",version:1})).concat({api:"SYNO.Core.SyslogClient.FileTransfer",method:"get",version:1})).concat({api:"SYNO.Core.Network",method:"get",version:1})).filter((function(e){return!!SYNO.API.GetKnownAPI(e.api)}),this)},processReturnData:function(e,t,i){for(var s=!1,n={api:"SYNO.Core.SyslogClient.FileTransfer",method:"get",version:1},o={api:"SYNO.Core.Network",method:"get",version:1},a={api:"SYNO.Core.FileServ.ServiceDiscovery",method:"get",version:1},r=0;r<t.result.length;r++)if(!0===SYNO.ux.Utils.checkApiConsistency(n,t.result[r]))s=t.result[r].data.afp;else if(!0===SYNO.ux.Utils.checkApiConsistency(o,t.result[r])){var l=Ext.util.Format.htmlEncode(t.result[r].data.server_name);this.macHelpBox.update({hostname:l}),this.macHelpBox.getEl().on("click",this.selectHelpText,null,{delegate:"span.link-font"})}else!0===SYNO.ux.Utils.checkApiConsistency(a,t.result[r])&&(this.afpTMEnable=t.result[r].data.enable_afp_time_machine);this.getForm().setValues({afp_transfer_log_enable:s}),this.getForm().loadRecords(t.result,i.compound),this.afterLoad()},afterLoad:function(){var e=this.getComponent("enable_afp").getValue(),t=this.getComponent("afp_transfer_log_enable").getValue(),i=e&&t,s="SYNO.SDS.CMS.Application"===this.findAppWindow().getOpenConfig("className");this.setMacHelpBoxVisible(e),s?this.getComponent("afpLogBtn").disable():this.getComponent("afpLogBtn").setDisabled(!i),this.getComponent("advanceBtnId").setDisabled(!e),this.sendServiceEvent()},sendServiceEvent:function(){var e=this.getForm();this.afpChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.WinMacNfs.AFP",!e.findField("enable_afp").getValue())}}),Ext.define("SYNO.SDS.AdminCenter.FileService.AfpTab.Utils",{statics:{onClickFileIndexUrl:function(e){SYNO.SDS.AppLaunch("SYNO.Finder.Application",{fn:"preference"})},onClickServiceDiscoveryUrl:function(e){e.app.startModule("SYNO.SDS.AdminCenter.FileService.Main",{tab:"adv"})}}}),Ext.ns("SYNO.SDS.AdminCenter.FileService.NFS.IDMap"),Ext.define("SYNO.SDS.AdminCenter.FileService.NFS.IDMap.EditMapDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.principal=e.principal?e.principal:null,this.userStore=this.createUserStore(),this.panel=this.configForm(),this.applyBtn=new SYNO.ux.Button({disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",btnStyle:"blue",text:_T("common","apply"),handler:this.onApplyBtnClick,scope:this}),this.cancelBtn=new SYNO.ux.Button({text:_T("common","cancel"),btnStyle:"grey",handler:this.close,scope:this});var t=Ext.apply({dsmStyle:"v5",title:_T("nfs","nfs_create_static_mapping"),autoDestroy:!0,width:550,height:200,layout:"fit",items:[this.panel],buttons:[this.cancelBtn,this.applyBtn]},e);Ext.apply(t,e),this.callParent([t]),this.principal&&(this.setTitle(_T("nfs","nfs_edit_static_mapping")),this.panel.getForm().setValues(this.principal))},configForm:function(){var e={border:!1,itemId:"formpanel",items:[{xtype:"syno_textfield",name:"kerberos_principal",itemId:"kerberos_principal",fieldLabel:_T("nfs","nfs_krb5_principal"),allowBlank:!1,width:250,validator:function(e){return 0>e.indexOf("=")}},{xtype:"syno_combobox",name:"local_name",itemId:"local_name",fieldLabel:_T("app_privilege","local_user"),store:this.userStore,displayField:"local_name",valueField:"local_name",triggerAction:"all",mode:"remote",editable:!0,resizable:!0,pageSize:50,width:250,grow:!0,allowBlank:!1,queryParam:"filter",listWidth:300,maxHeight:360,minChars:1,typeAhead:!0,typeAheadDelay:1e3,listeners:{scope:this,change:this.isValidUser,blur:this.isValidUser}}]};return SYNO.LayoutConfig.fill(e),new SYNO.SDS.Utils.FormPanel(e)},onApplyBtnClick:function(){var e=this.panel.getComponent("local_name").getValue();this.isValidUser(e)&&this.panel.getForm().isValid()?this.panel.getForm().isDirty()?this.applyHandler():this.close():this.setStatusError({text:_T("common","forminvalid"),clear:!0})},applyHandler:function(){var e="",t={},i=this.panel.getComponent("kerberos_principal").getValue(),s=this.panel.getComponent("local_name").getValue();this.principal?(e="set",t={id:this.principal.id,kerberos_principal:i,local_name:s}):(e="create",t={idmap:[{kerberos_principal:i,local_name:s}]}),this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.NFS.IDMap",method:e,params:t,version:1,scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),e)this.owner.idmapTab.idmapStore.reload(),this.close();else if(2351==t.code)this.setStatusError({text:_T("nfs","nfs_krb5_princ_conflict"),clear:!0});else if(2353==t.code){var s=_T("error","error_bad_field");this.setStatusError({text:s,clear:!0})}else this.setStatusError({text:_T("common","commfail"),clear:!0})}})},isValidUser:function(){var e=!1,t=this.panel.getComponent("local_name").getValue();return this.userStore.each((function(i){t===i.get("local_name")&&(e=!0)}),this),e||this.panel.getComponent("local_name").markInvalid(_T("firewall","firewall_field_blank_alert")),e},onActivate:function(){this.userStore.load({params:{offset:0,limit:50}})},createUserStore:function(){return new SYNO.API.JsonStore({api:"SYNO.Core.FileServ.NFS.IDMap",method:"list",version:1,root:"idmap",idProperty:"local_name",fields:["local_name"],appWindow:this.findAppWindow()||!1,autoDestroy:!0,baseParams:{offset:0,limit:this.pageSize,suggestion:!0},sortInfo:{field:"local_name",direction:"ASC"},totalProperty:"total",listeners:{scope:this,beforeload:this.onBeforeLoad,exception:this.onException,load:this.onLoad}})},onBeforeLoad:function(){this.setStatusBusy()},onException:function(){this.clearStatusBusy(),this.setStatusError({text:_T("common","commfail"),clear:!0})},onLoad:function(){this.clearStatusBusy()}}),Ext.ns("SYNO.SDS.AdminCenter.FileService.NFS.Kerberos"),Ext.define("SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.KeyUploadDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.applyBtn=new SYNO.ux.Button({disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",btnStyle:"blue",text:_T("common","apply"),handler:this.onApplyBtnClick,scope:this}),this.cancelBtn=new SYNO.ux.Button({text:_T("common","cancel"),btnStyle:"grey",handler:this.close,scope:this}),this.panel=this.configForm();var t=Ext.apply({dsmStyle:"v5",title:_T("nfs","nfs_kerberos_import_keys"),autoDestroy:!0,width:500,height:200,layout:"fit",items:[this.panel],buttons:[this.cancelBtn,this.applyBtn]},e);Ext.apply(t,e),this.callParent([t])},configForm:function(){var e={border:!1,itemId:"formpanel",fileUpload:!0,trackResetOnLoad:!0,labelWidth:130,padding:0,items:[{xtype:"syno_displayfield",value:_T("nfs","nfs_select_import_key")},{xtype:"syno_filebutton",name:"keytab_file",fieldLabel:_T("nfs","nfs_kerberos_keys")}],webapi:{api:"SYNO.Core.FileServ.NFS.Kerberos",method:"upload_key",version:1},onApiSuccess:function(){this.ownerCt.owner.kerberosTab.keyStore.reload(),this.ownerCt.clearStatusBusy(),this.ownerCt.close()},onApiFailure:function(e,t,i){var s=SYNO.API.getErrorString(t);this.ownerCt.clearStatusBusy(),this.ownerCt.setStatusError({text:s,clear:!0})}};return SYNO.LayoutConfig.fill(e),new SYNO.SDS.Utils.FormPanel(e)},onApplyBtnClick:function(){this.panel.getForm().findField("keytab_file").getValue()?0<this.owner.kerberosTab.keyStore.getCount()?this.module.appWin.getMsgBox().confirm(this.title,_T("nfs","nfs_key_overwrite_confirm"),(function(e){"yes"===e&&(this.setStatusBusy({text:_T("common","saving")}),this.panel.upload())}),this):(this.setStatusBusy({text:_T("common","saving")}),this.panel.upload()):this.setStatusError({text:_T("service","service_ssl_no_file")})}}),Ext.define("SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.IdmapTab",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.idmapStore=this.createIdmapStore(),this.defaultMapDialog=null;var t={title:_T("nfs","nfs_static_mapping"),store:this.idmapStore,header:!1,disabled:!0,height:450,enableColumnMove:!1,enableHdMenu:!1,autoExpandColumn:"kerberos_principal",colModel:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:[{id:"kerberos_principal",header:_T("nfs","nfs_krb5_principal"),dataIndex:"kerberos_principal",align:"left",width:200,renderer:Ext.util.Format.htmlEncode},{id:"local_name",header:_T("app_privilege","local_user"),dataIndex:"local_name",align:"left",width:150,renderer:Ext.util.Format.htmlEncode}]}),selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:{fn:this.onSelectionChange,buffer:50,scope:this}}}),tbar:{items:[{xtype:"syno_button",text:_T("common","create"),itemId:"addBtn",menu:new SYNO.ux.Menu({items:[{text:_T("nfs","nfs_static_mapping"),scope:this,handler:this.onCreateMapBtnClick},{text:_T("nfs","nfs_default_map_list"),scope:this,handler:this.onDefaultMapBtnClick}]})},{xtype:"syno_button",text:_T("common","alt_edit"),itemId:"editBtn",disabled:!0,scope:this,handler:this.onEditMapBtnClick},{xtype:"syno_button",text:_T("common","delete"),itemId:"delBtn",disabled:!0,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",scope:this,handler:this.onDelMapBtnClick},"->",new SYNO.ux.TextFilter({iconStyle:"search",itemId:"search",store:this.idmapStore,queryAction:"list",enumAction:"list",queryParam:"filter",pageSize:50})]},listeners:{scope:this,activate:{fn:function(){this.idmapStore.load()}}},bbar:new SYNO.ux.PagingToolbar({store:this.idmapStore,pageSize:50,displayInfo:!0})};Ext.apply(t,e),SYNO.LayoutConfig.fill(t),this.callParent([t])},onCreateMapBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.NFS.IDMap.EditMapDialog({module:this.module,owner:this.owner,principal:null}).open()},onEditMapBtnClick:function(){var e=this.getSelectionModel().getSelected();new SYNO.SDS.AdminCenter.FileService.NFS.IDMap.EditMapDialog({module:this.module,owner:this.owner,principal:e.data}).open()},onDefaultMapBtnClick:function(){this.defaultMapDialog=new SYNO.SDS.UserChooser({owner:this.ownerCt.ownerCt,module:this.module,title:_T("nfs","nfs_default_map_list"),setStoreConfig:function(){return{api:"SYNO.Core.FileServ.NFS.IDMap",method:"list",version:"1",id:"id",root:"idmap"}},setApiParams:function(){return{suggestion:!0}},setStoreField:function(){return["id","kerberos_principal","local_name"]},setColModel:function(){return[{id:"kerberos_principal",header:_T("nfs","nfs_krb5_principal"),dataIndex:"kerberos_principal",width:200},{id:"description",header:_T("app_privilege","local_user"),dataIndex:"local_name",width:150}]},setTextFilterConfig:function(){return{queryAction:"list",queryParam:"filter"}},setGridPanelConfig:function(){return{enableHdMenu:!1,autoExpandColumn:"kerberos_principal"}},singleSelect:!1,localOnly:!0}),this.mon(this.defaultMapDialog,"beforeclose",this.onBeforeCloseDefaultMap,this),this.defaultMapDialog.getFooterToolbar().getComponent("ok").setText(_T("common","add")),this.defaultMapDialog.chooseUsers()},onBeforeCloseDefaultMap:function(e){var t=[],i=e.getRecords();if(0===i.length)return!0;for(var s=0;s<i.length;s++)t.push({kerberos_principal:i[s].data.kerberos_principal,local_name:i[s].data.local_name});return e.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.NFS.IDMap",method:"create",params:{idmap:t},version:1,scope:this,callback:function(e,t,i){this.defaultMapDialog.clearStatusBusy(),e?(this.idmapStore.reload(),this.mun(this.defaultMapDialog,"beforeclose",this.onBeforeCloseDefaultMap,this),this.defaultMapDialog.close()):2351==t.code&&this.deselectConflictPrincipals(t.errors.principal_conflict)}}),!1},deselectConflictPrincipals:function(e){for(var t=this.defaultMapDialog.grid.getSelectionModel(),i=this.defaultMapDialog.userStore,s=0;s<i.getCount();s++)if(t.isSelected(s)){var n=i.getAt(s);-1!=e.indexOf(n.get("kerberos_principal"))&&t.deselectRow(s)}this.module.appWin.getMsgBox().alert(this.defaultMapDialog.title,_T("nfs","nfs_krb5_princ_conflict"))},createIdmapStore:function(){return new SYNO.API.JsonStore({api:"SYNO.Core.FileServ.NFS.IDMap",method:"list",version:1,root:"idmap",fields:["id","kerberos_principal","local_name"],appWindow:this.findAppWindow()||!1,defaultSortable:!0,listeners:{scope:this,beforeload:this.onBeforeLoad,load:this.onLoad,exception:this.onException}})},onBeforeLoad:function(){this.owner.setStatusBusy()},onLoad:function(){this.owner.clearStatusBusy()},onException:function(){this.owner.clearStatusBusy();var e=_T("common","commfail");this.owner.getMsgBox().alert(this.owner.title,e),this.idmapStore.loadData({},!1)},onSelectionChange:function(){var e=this.getTopToolbar(),t=this.getSelectionModel().getCount();e.getComponent("editBtn").setDisabled(1!=t),e.getComponent("delBtn").setDisabled(0>=t||!!_S("demo_mode"))},onDelMapBtnClick:function(){this.module.appWin.getMsgBox().confirmDelete(this.title,_T("nfs","nfs_idmap_delete_confirm_desc"),(function(e){"yes"===e&&this.doDelete()}),this)},doDelete:function(){for(var e=[],t=this.getSelectionModel().getSelections(),i=0;i<t.length;i++)e.push(t[i].id);this.owner.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.NFS.IDMap",method:"delete",version:1,scope:this,params:{id:e},callback:function(e,t,i){this.owner.clearStatusBusy(),e&&this.deleteDone()}})},deleteDone:function(){this.idmapStore.load()}}),Ext.define("SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.KeyTab",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.keyStore=this.createKeyStore();var t={title:_T("nfs","nfs_kerberos_keys"),store:this.keyStore,header:!1,height:450,enableColumnMove:!1,enableHdMenu:!1,autoExpandColumn:"kerberos_principal",colModel:new Ext.grid.ColumnModel({columns:[{id:"version",header:_T("nfs","nfs_key_version"),dataIndex:"version",align:"center",autoWidth:!0},{id:"kerberos_principal",header:_T("nfs","nfs_krb5_principal"),dataIndex:"kerberos_principal",align:"left",width:300},{id:"enc_type",header:_T("nfs","nfs_key_encrypt"),dataIndex:"enc_type",align:"left",width:200}]}),selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),listeners:{scope:this,activate:{fn:function(){this.keyStore.load()}}},tbar:{items:[{xtype:"syno_button",text:_T("nfs","nfs_kerberos_import_keys"),itemId:"keyImportBtn",scope:this,handler:this.onImportBtnClick}]}};Ext.apply(t,e),SYNO.LayoutConfig.fill(t),this.callParent([t])},onBeforeLoad:function(){this.owner.setStatusBusy()},onLoad:function(){0<this.keyStore.getCount()?this.owner.idmapTabEnable():this.owner.idmapTabDisable(),this.owner.clearStatusBusy()},onException:function(){this.owner.clearStatusBusy();var e=_T("common","commfail");this.owner.getMsgBox().alert(this.owner.title,e),this.keyStore.loadData({},!1)},onImportBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.KeyUploadDialog({module:this.module,owner:this.owner}).open()},createKeyStore:function(e){return new SYNO.API.JsonStore({api:"SYNO.Core.FileServ.NFS.Kerberos",method:"list",version:1,root:"keytab",fields:["version","kerberos_principal","enc_type"],appWindow:this.findAppWindow()||!1,defaultSortable:!0,listeners:{scope:this,beforeload:this.onBeforeLoad,load:this.onLoad,exception:this.onException}})}}),Ext.define("SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.MainDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.kerberosTab=new SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.KeyTab({owner:this,itemId:"keyTab",module:this.module}),this.idmapTab=new SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.IdmapTab({owner:this,itemId:"idmapTab",module:this.module});var t=Ext.apply({title:_T("nfs","nfs_kerberos_setting"),autoDestroy:!0,width:670,height:500,autoHeight:!0,layout:"fit",items:[{xtype:"syno_tabpanel",itemId:"tabs",plain:!0,activeTab:0,items:[this.kerberosTab,this.idmapTab]}],buttons:[{text:_T("common","alt_finish"),scope:this,handler:this.close}]},e);Ext.apply(t,e),this.callParent([t]),this.tabs=this.getComponent("tabs"),this.idmapTabDisable()},idmapTabEnable:function(){this.idmapTab.enable(),this.tabs.unhideTabStripItem("idmapTab")},idmapTabDisable:function(){this.idmapTab.disable(),this.tabs.hideTabStripItem("idmapTab")}}),Ext.namespace("SYNO.SDS.AdminCenter.FileService.NFS"),Ext.define("SYNO.SDS.AdminCenter.FileService.NFS.AdvancedSettingsDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.nfs_enable=e.nfs_enable,this.nfs_v4_enable=e.nfs_v4_enable,this.nfs_v4_max_minor_version=e.nfs_v4_max_minor_version,this.panel=this.configForm();var t=Ext.apply({title:_T("common","adv_setting"),width:500,border:!1,autoHeight:!0,layout:"fit",resizable:!0,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.cancelHandler},{btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","save"),scope:this,handler:this.apply}],listeners:{beforeclose:this.onBeforeClose}},e);this.callParent([t]),this.panel.mon(this.panel.getForm().findField("custom_port_enable"),"check",(function(e,t){this.panel.getForm().findField("statd_port").setDisabled(!t),this.panel.getForm().findField("nlm_port").setDisabled(!t)}),this)},onOpen:function(){var e=[{api:"SYNO.Core.FileServ.NFS.AdvancedSetting",method:"get",version:1,params:{}},{api:"SYNO.Core.FileServ.NFS.Kerberos",method:"get",version:1,params:{}}];this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},params:{},scope:this,callback:function(e,t,i){this.clearStatusBusy(),e?(this.panel.getForm().setValues(t),this.afterLoad(t)):this.module.appWin.getMsgBox().alert(_T("tree","leaf_nfs"),_T("common","error_system"))}}),this.callParent([arguments])},configForm:function(e){this.packetSizeStore=this.createLocalStore();var t={title:_T("tree","leaf_nfs"),cls:"nfs-advance-formpanel",autoScroll:!0,autoHeight:!0,itemId:"nfsFieldset",items:[{xtype:"syno_checkbox",name:"unix_pri_enable",boxLabel:_T("common","apply_default_umask")},{xtype:"syno_checkbox",name:"custom_port_enable",boxLabel:_T("nfs","nfs_custom_port")},{xtype:"syno_numberfield",name:"statd_port",itemId:"statd_port",fieldLabel:_T("nfs","nfs_statd_port"),validator:SYNO.SDS.AdminCenter.PublicAccess.Utils.PortValidator("statd_port"),maxlength:5,vtype:"port",listeners:{disable:function(e){e.validate()}}},{xtype:"syno_numberfield",name:"nlm_port",itemId:"nlm_port",validator:SYNO.SDS.AdminCenter.PublicAccess.Utils.PortValidator("nlm_port"),fieldLabel:_T("nfs","nfs_nlm_port"),maxlength:5,vtype:"port",listeners:{disable:function(e){e.validate()}}},{xtype:"displayfield",height:10},{xtype:"syno_displayfield",value:_T("nfs","nfs_prefer_rw_size_desc")},{xtype:"syno_combobox",name:"read_size",fieldLabel:_T("nfs","nfs_prefer_read_size"),displayField:"display",valueField:"value",value:this.rgPacketSize[1][0],store:this.packetSizeStore},{xtype:"syno_combobox",name:"write_size",fieldLabel:_T("nfs","nfs_prefer_write_size"),displayField:"display",valueField:"value",value:this.rgPacketSize[1][0],store:this.packetSizeStore},{xtype:"displayfield",height:10},{xtype:"syno_textfield",name:"nfs_v4_domain",itemId:"nfs_v4_domain",fieldLabel:this.nfs_v4_max_minor_version>0?_T("nfs","nfs_v4_1_domain"):_T("nfs","nfs_v4_domain"),maxlength:512,vtype:"hostname"},{xtype:"displayfield",height:10},{xtype:"syno_displayfield",name:"krb5_desc",itemId:"krb5_desc",value:_T("nfs","nfs_kerberos_desc"),hidden:!0},{xtype:"syno_button",synotype:"indent_no_label",name:"krb5_btn",itemId:"krb5_btn",text:_T("nfs","nfs_kerberos_setting"),id:this.nfsKrb5SetId=Ext.id(),handler:this.onNfsKerberosBtnClick,hidden:!0,scope:this},{xtype:"syno_displayfield",fieldLabel:_T("nfs","nfs_krb5_principal"),name:"kerberos_principal",itemId:"krb5_principal",hidden:!0},{xtype:"displayfield",height:10}]};return new SYNO.SDS.Utils.FormPanel(t)},afterLoad:function(e){for(var t={api:"SYNO.Core.FileServ.NFS.AdvancedSetting",method:"get",version:1},i={api:"SYNO.Core.FileServ.NFS.Kerberos",method:"get",version:1},s=0;s<e.result.length;s++)if(!0===SYNO.ux.Utils.checkApiConsistency(t,e.result[s])){var n=e.result[s].data;n.statd_port=0===n.statd_port?"":n.statd_port,n.nlm_port=0===n.nlm_port?"":n.nlm_port,this.panel.getForm().setValues(n);var o=this.panel.getForm().findField("custom_port_enable").getValue();this.ori_customPortEnable=o,this.ori_statd_port=n.statd_port,this.ori_nlm_port=n.nlm_port,this.panel.getForm().findField("statd_port").setDisabled(!o),this.panel.getForm().findField("nlm_port").setDisabled(!o),this.panel.getForm().findField("nfs_v4_domain").setDisabled(!this.nfs_v4_enable)}else if(!0===SYNO.ux.Utils.checkApiConsistency(i,e.result[s])&&!0===e.result[s].data.kerberos_support){var a=this.getComponent("nfsFieldset");a.getComponent("krb5_desc").show(),a.getComponent("krb5_btn").show(),""!==e.result[s].data.kerberos_principal&&(a.getComponent("krb5_principal").show(),this.panel.getForm().setValues({kerberos_principal:e.result[s].data.kerberos_principal}))}},onNfsKerberosBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.MainDialog({module:this.module,owner:this}).open()},createLocalStore:function(){return this.rgPacketSize=[[4096,"4KB"],[8192,"8KB"],[16384,"16KB"],[32768,"32KB"]],new Ext.data.ArrayStore({fields:["value","display"],data:this.rgPacketSize})},checkPortConfict:function(e){return e.findField("statd_port").getValue()!==e.findField("nlm_port").getValue()||(this.module.appWin.getMsgBox().alert(_T("tree","leaf_nfs"),_T("error","error_port_conflict")),!1)},apply:function(){var e=this.panel.getForm(),t=e.getValues();t.enable_nfs=this.nfs_enable,e.isValid()?e.isDirty()?t.custom_port_enable&&!this.checkPortConfict(e)||(!this.nfs_enable||t.custom_port_enable==this.ori_customPortEnable&&t.statd_port==this.ori_statd_port&&t.nlm_port==this.ori_nlm_port?this.submit(t):this.confirmSubmit(t)):this.doClose():this.module.appWin.getMsgBox().alert(this.title,_T("common","forminvalid"))},confirmSubmit:function(e){this.getMsgBox().confirm(_T("tree","leaf_winmacnfs"),_T("network","service_restart_warning")+" "+_T("common","ask_cont"),(function(t,i,s){"yes"==t&&this.submit(e)}),this)},submit:function(e){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.FileServ.NFS.AdvancedSetting",method:"set",version:1,scope:this,params:e,callback:function(e,t,i){if(this.clearStatusBusy(),e)return this.doClose(),!0;this.module.appWin.getMsgBox().alert(this.title,SYNO.API.getErrorString(t.code))}})},onBeforeClose:function(){var e=this,t=this.panel.getForm(),i={dontSave:function(){e.doClose()},cancel:Ext.emptyFn,save:function(){e.apply()}};return!t.isDirty()||(this.confirmLostChangePromise(i,e),!1)},cancelHandler:function(){this.close()}}),Ext.define("SYNO.SDS.AdminCenter.FileService.NfsTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.nfsApiMaxVersion=this.getKnownAPI("SYNO.Core.FileServ.NFS").maxVersion;var t=this.fillConfig(e);this.callParent([t]),this.on("afterlayout",this.onPanelAfterLayout,this,{single:!0})},onPanelAfterLayout:function(e,t){var i;2<=this.nfsApiMaxVersion&&e.mon(e.getForm().findField("enable_nfs"),"check",(function(e,t){this.getComponent("NfsadvanceBtnId").setDisabled(!t)}),this),i=2>this.nfsApiMaxVersion?["enable_nfs_v4","read_size","write_size",this.nfsKrb5SetId,"unix_pri_enable"]:["nfs_max_protocol","nfs_enabled_protocol"],this.checkEnableNFS=new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"enable_nfs",i)},fillConfig:function(e){var t,i=this.nfsApiMaxVersion;t=2>this.nfsApiMaxVersion?this.createNfsTabObj(e):this.createNfsTabObjV3(e);var s={title:_T("tree","leaf_nfs"),autoScroll:!0,webapi:{api:"SYNO.Core.FileServ.NFS",methods:{get:"get",set:"set"},version:i},items:t};return Ext.apply(s,e),s},createNfsTabObj:function(e){return this.packetSizeStore=this.createLocalStore(),[{xtype:"syno_checkbox",name:"enable_nfs",itemId:"enable_nfs",boxLabel:_T("nfs","nfs_enable")},{xtype:"syno_checkbox",name:"enable_nfs_v4",indent:1,boxLabel:_T("nfs","nfs_enable_version_4")},{xtype:"displayfield",height:10},{xtype:"syno_checkbox",name:"unix_pri_enable",indent:1,boxLabel:_T("common","apply_default_umask")},{xtype:"syno_displayfield",indent:1,value:_T("nfs","nfs_prefer_rw_size_desc")},{xtype:"syno_combobox",name:"read_size",fieldLabel:_T("nfs","nfs_prefer_read_size"),displayField:"display",valueField:"value",value:this.rgPacketSize[1][0],indent:1,store:this.packetSizeStore},{xtype:"syno_combobox",name:"write_size",fieldLabel:_T("nfs","nfs_prefer_write_size"),displayField:"display",valueField:"value",value:this.rgPacketSize[1][0],indent:1,store:this.packetSizeStore},{xtype:"displayfield",height:10},{xtype:"syno_displayfield",name:"krb5_desc",itemId:"krb5_desc",indent:1,value:_T("nfs","nfs_kerberos_desc"),hidden:!0},{xtype:"syno_button",synotype:"indent_no_label",name:"krb5_btn",itemId:"krb5_btn",text:_T("nfs","nfs_kerberos_setting"),indent:1,id:this.nfsKrb5SetId=Ext.id(),handler:this.onNfsKerberosBtnClick,hidden:!0,scope:this},{xtype:"syno_displayfield",fieldLabel:_T("nfs","nfs_krb5_principal"),name:"kerberos_principal",itemId:"krb5_principal",hidden:!0,indent:1},{xtype:"displayfield",height:10},{xtype:"syno_displayfield",indent:1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+' </span><br><ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;"><li>'+String.format(_T("nfs","nfs_share_permission_desc"),'<a id="'+Ext.id()+'" class="link-font" href="">'+_T("helptoc","share")+"</a>")+"</li><li>"+_T("nfs","nfs_refer_faq")+"</li></ul>",listeners:{render:function(e){var t=e.el.select("a").item(0);t&&this.mon(t,"click",(function(e){e.preventDefault(),SYNO.SDS.AdminCenter.FileService.NfsTab.Utils.onClickShareUrl(this.module)}),this)},scope:this,single:!0,buffer:80},reset:Ext.emptyFn}]},createNfsTabObjV3:function(e){return this.isNfsMaxProtocolReady=!1,this.updateAvailNfsVerArray(3,0,!1),[{xtype:"syno_checkbox",name:"enable_nfs",itemId:"enable_nfs",boxLabel:_T("nfs","nfs_enable"),listeners:{check:{scope:this,fn:this.onNfsCheckHandler}}},{xtype:"syno_combobox",name:"nfs_max_protocol",itemId:"nfs_max_protocol",fieldLabel:_T("nfs","nfs_max_protocol"),displayField:"display",valueField:"value",indent:1,labelWidth:250,value:this.rgAvailNfsVer[0][0],store:new Ext.data.ArrayStore({fields:["value","display"],data:this.rgAvailNfsVer}),listeners:{select:this.updateEnabledNfsVer,scope:this}},{xtype:"syno_displayfield",name:"nfs_enabled_protocol",itemId:"nfs_enabled_protocol",htmlEncode:!1,indent:1,labelWidth:250,fieldLabel:_T("nfs","nfs_avail_protocol"),isDirty:function(){return!1}},{xtype:"syno_button",btnStyle:"default",name:"NfsadvanceBtnId",itemId:"NfsadvanceBtnId",text:_T("common","adv_setting"),autoWidth:!0,indent:1,style:{marginTop:"12px"},scope:this,handler:this.onNfsAdvSettingBtnClick},{xtype:"syno_displayfield",itemId:"nfsNoteId",indent:1,style:{marginTop:"6px"},htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+' </span><br><ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;"><li>'+String.format(_T("nfs","nfs_share_permission_desc"),'<a id="'+Ext.id()+'" class="link-font" href="">'+_T("helptoc","share")+"</a>")+"</li><li>"+_T("nfs","nfs_refer_faq")+"</li></ul>",listeners:{render:function(e){var t=e.el.select("a").item(0);t&&this.mon(t,"click",(function(e){e.preventDefault(),SYNO.SDS.AdminCenter.FileService.NfsTab.Utils.onClickShareUrl(this.module)}),this)},scope:this,single:!0,buffer:80},reset:Ext.emptyFn}]},selectHelpText:function(e,t){var i=t.ownerDocument.createRange();i.selectNode(t.firstChild);var s=window.getSelection();s.removeAllRanges(),s.addRange(i)},onNfsKerberosBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.NFS.Kerberos.MainDialog({module:this.module,owner:this.module.appWin}).open()},onNfsAdvSettingBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.NFS.AdvancedSettingsDialog({nfs_enable:this.getForm().findField("enable_nfs").getValue(),nfs_v4_enable:this.nfs_enable_nfs_v4,nfs_v4_max_minor_version:this.nfs_enabled_minor_ver,module:this.module,owner:this.module.appWin}).open()},createLocalStore:function(){return this.rgPacketSize=[[4096,"4KB"],[8192,"8KB"],[16384,"16KB"],[32768,"32KB"]],new Ext.data.ArrayStore({fields:["value","display"],data:this.rgPacketSize})},updateAvailNfsVerArray:function(e,t,i){var s=[[0,"NFSv3"]];if(4<=e&&(s.push([1,"NFSv4"]),1<=t&&s.push([2,"NFSv4.1"])),!0===i){var n=0;!0===this.nfs_enable_nfs_v4&&(n=s[1][0],1===this.nfs_enabled_minor_ver&&(n=s[2][0])),n>s[s.length-1][0]&&(n=s[s.length-1][0]),this.getComponent("nfs_max_protocol").store.loadData(s),this.getComponent("nfs_max_protocol").setValue(n),!1===this.isNfsMaxProtocolReady&&(this.isNfsMaxProtocolReady=!0,this.getComponent("nfs_max_protocol").initValue())}this.rgAvailNfsVer=s.slice()},updateAvailNfsVer:function(){var e=this.nfs_support_major_ver,t=this.nfs_support_minor_ver;this.updateAvailNfsVerArray(e,t,!0),this.updateEnabledNfsVer(null),this.getComponent("nfs_enabled_protocol").initValue()},updateEnabledNfsVer:function(e){var t=this.getComponent("nfs_max_protocol").getValue(),i=this.rgAvailNfsVer,s="NFSv2";"yes"===_D("support_hyper_converged","no")&&(s="");for(var n=0;n<i.length;n++){var o=i[n][0],a=i[n][1];o<=t&&(""!==s&&(s+=","),s=s+" "+a)}this.getComponent("nfs_enabled_protocol").setValue(s),this.nfs_enable_nfs_v4=0!==t,this.nfs_enabled_minor_ver=2===t?1:0},onBeforeRequest:function(e){return!0},processParams:function(e,t){if(2<=this.nfsApiMaxVersion)for(var i=0;i<t.length;i++)"SYNO.Core.FileServ.NFS"===t[i].api&&"set"===t[i].method&&(t[i].params.enable_nfs_v4=this.nfs_enable_nfs_v4,t[i].params.enabled_minor_ver=this.nfs_enabled_minor_ver,this.isNfsMaxProtocolReady=!1);return"set"==e&&(this.getForm().getValues(),this.nfsChange=this.getForm().findField("enable_nfs").isDirty()),2>this.nfsApiMaxVersion&&(t=t.concat({api:"SYNO.Core.FileServ.NFS.Kerberos",method:"get",version:1})),t=t.filter((function(e){return!!this.getKnownAPI(e.api)}),this)},processReturnData:function(e,t,i){for(var s={api:"SYNO.Core.FileServ.NFS.Kerberos",method:"get",version:1},n=0;n<t.result.length;n++)!0===SYNO.ux.Utils.checkApiConsistency(s,t.result[n])&&(!0===t.result[n].data.kerberos_support&&(this.getComponent("krb5_desc").show(),this.getComponent("krb5_btn").show(),""!==t.result[n].data.kerberos_principal&&(this.getComponent("krb5_principal").show(),this.getForm().setValues({kerberos_principal:t.result[n].data.kerberos_principal}))),this.doLayout());for(this.getForm().loadRecords(t.result,i.compound),this.afterLoad(),n=0;n<t.result.length;n++)"SYNO.Core.FileServ.NFS"===t.result[n].api&&"get"===t.result[n].method&&(this.nfs_enable_nfs_v4=t.result[n].data.enable_nfs_v4,2<=this.nfsApiMaxVersion&&(this.nfs_enabled_minor_ver=t.result[n].data.enabled_minor_ver,this.nfs_support_major_ver=t.result[n].data.support_major_ver,this.nfs_support_minor_ver=t.result[n].data.support_minor_ver,this.updateAvailNfsVer()))},afterLoad:function(){var e=this.getComponent("enable_nfs").getValue();2<=this.nfsApiMaxVersion&&this.getComponent("NfsadvanceBtnId").setDisabled(!e),this.onNfsCheckHandler(null,null),this.sendServiceEvent()},sendServiceEvent:function(){var e=this.getForm();this.nfsChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.WinMacNfs.NFS",!e.findField("enable_nfs").getValue())},onNfsCheckHandler:function(e,t){var i=this.getComponent("nfsNoteId");i.originalValue=i.getValue()}}),Ext.define("SYNO.SDS.AdminCenter.FileService.NfsTab.Utils",{statics:{onClickShareUrl:function(e){e.app.startModule("SYNO.SDS.AdminCenter.Share.Main")}}}),Ext.ns("SYNO.SDS.AdminCenter.FileService.FTP"),Ext.define("SYNO.SDS.AdminCenter.FileService.FTP.ConnectionSettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.panel=this.configForm();var t=Ext.apply({title:_T("ftp","conn_restriction"),autoDestroy:!0,width:500,height:360,layout:"fit",closeAction:"onCloseBtnClick",items:[this.panel],buttons:[{text:_T("common","cancel"),btnStyle:"grey",scope:this,handler:this.onCloseBtnClick},{disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",btnStyle:"blue",text:_T("common","save"),scope:this,handler:this.apply}]},e);this.callParent([t]),this.mon(this,"show",this.load,this),this.on("afterlayout",(function(e,t){var i=this.panel.getForm().findField("max_download_rate_composite"),s=this.panel.getForm().findField("max_upload_rate_composite");SYNO.ux.Utils.DescribeGroup(i.items.get(0),i.items.get(1)),SYNO.ux.Utils.DescribeGroup(s.items.get(0),s.items.get(1)),this.checkEnableMaxConnPerIP=new SYNO.ux.Utils.EnableCheckGroup(this.panel.getForm(),"enable_max_conn_per_ip",["max_conn_per_ip"]),this.checkEnableFlowCtrl=new SYNO.ux.Utils.EnableCheckGroup(this.panel.getForm(),"enable_flow_ctrl",["max_upload_rate_composite","max_download_rate_composite"])}),this,{single:!0})},configForm:function(){var e={border:!1,itemId:"formpanel",trackResetOnLoad:!0,padding:0,labelWidth:268,items:[{xtype:"syno_checkbox",boxLabel:_T("ftp","ftp_enable_max_conn_per_ip"),name:"enable_max_conn_per_ip"},{xtype:"syno_combobox",name:"max_conn_per_ip",indent:1,width:120,fieldLabel:_T("ftp","ftp_max_conn"),store:[2,3,4,5,6,7,8,9,10],value:2,allowBlank:!1},{xtype:"syno_checkbox",name:"enable_flow_ctrl",boxLabel:_T("ftp","ftp_flow_ctrl")},{xtype:"syno_compositefield",name:"max_upload_rate_composite",fieldLabel:_T("ftp","ftp_max_upload"),width:270,indent:1,items:[{xtype:"syno_numberfield",name:"maxuploadrate",width:120,allowBlank:!0,allowNegative:!1,allowDecimals:!1,vtype:"number",emptyText:_T("dhcp_server","unlimited"),maxlength:6},{xtype:"syno_displayfield",value:_T("bandwidth","speed_unit")}]},{xtype:"syno_compositefield",name:"max_download_rate_composite",fieldLabel:_T("ftp","ftp_max_download"),indent:1,items:[{xtype:"syno_numberfield",name:"maxdownloadrate",width:120,allowBlank:!0,allowNegative:!1,allowDecimals:!1,vtype:"number",emptyText:_T("dhcp_server","unlimited"),maxlength:6},{xtype:"syno_displayfield",value:_T("bandwidth","speed_unit")}]},{xtype:"syno_checkbox",name:"enable_ftp",hidden:!0},{xtype:"syno_checkbox",name:"enable_ftps",hidden:!0}]};return SYNO.LayoutConfig.fill(e),new SYNO.SDS.Utils.FormPanel(e)},load:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.FTP",method:"get",version:1,scope:this,callback:function(e,t,i){this.clearStatusBusy(),e&&(0===t.max_conn_per_ip?(t.enable_max_conn_per_ip=!1,delete t.max_conn_per_ip):t.enable_max_conn_per_ip=!0,t.maxuploadrate||(t.maxuploadrate=""),t.maxdownloadrate||(t.maxdownloadrate=""),this.panel.getForm().setValues(t))}})},apply:function(){var e=this.panel.getForm(),t=e.getValues();return!!e.isValid()&&(e.isDirty()?(!1===t.enable_max_conn_per_ip&&(t.max_conn_per_ip=0),t.maxuploadrate||(t.maxuploadrate=0),t.maxdownloadrate||(t.maxdownloadrate=0),this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.FileServ.FTP",method:"set",version:1,scope:this,params:t,callback:function(e,t,i){if(this.clearStatusBusy(),e)return this.close(),!0}}),!0):(this.close(),!1))},onCloseBtnClick:function(){if(!this.panel.getForm().isDirty())return this.close(),!0;this.confirmLostChangePromise({dontSave:this.close,cancel:Ext.emptyFn,save:this.apply},this)}}),Ext.ns("SYNO.SDS.AdminCenter.FileService.FTP"),Ext.define("SYNO.SDS.AdminCenter.FileService.FTP.ChrootRuleDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.userHomeEnabled=e.userHomeEnabled,this.domainUserHomeEnabled=e.domainUserHomeEnabled,this.ldapUserHomeEnabled=e.ldapUserHomeEnabled,this.panel=new SYNO.SDS.AdminCenter.FileService.FTP.ChrootRulePanel({owner:this,module:this.module,userHomeEnabled:this.userHomeEnabled,domainUserHomeEnabled:this.domainUserHomeEnabled,ldapUserHomeEnabled:this.ldapUserHomeEnabled});var t=Ext.apply({dsmStyle:"v5",title:_T("ftp","ftp_chroot_user_list"),autoDestroy:!0,width:670,height:500,autoHeight:!0,layout:"fit",closeAction:"onCloseBtnClick",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.onCloseBtnClick},{btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","apply"),scope:this,handler:this.onApplyBtnClick}]},e);this.callParent([t]),this.mon(this,"show",this.panel.onShow,this.panel)},onCloseBtnClick:function(){if(!this.panel.isDirty())return this.close(),!0;this.confirmLostChangePromise({dontSave:this.close,cancel:Ext.emptyFn,save:this.onApplyBtnClick},this)},onApplyBtnClick:function(){var e=[];if(!this.panel.isDirty())return this.close(),!0;this.panel.getStore().getRange().forEach((function(t){e.push({type:t.data.type,name:t.data.name,path:t.data.path})}),this),this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.FileServ.FTP.ChrootUser",method:"save",version:2,scope:this,params:{rules:e},callback:function(e,t,i){if(this.clearStatusBusy(),e)this.close();else{var s=SYNO.API.Response.GetFirstError(t),n=_T("common","commfail");SYNO.API.Erros.core[s.code]&&(n=SYNO.API.Erros.core[s.code]),this.getMsgBox().alert(this.title,n)}}})}}),Ext.define("SYNO.SDS.AdminCenter.FileService.FTP.ChrootRulePanel",{extend:"SYNO.ux.DDGridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.userHomeEnabled=e.userHomeEnabled,this.domainUserHomeEnabled=e.domainUserHomeEnabled,this.ldapUserHomeEnabled=e.ldapUserHomeEnabled,this.ruleStore=this.createRuleStore(),this.isRuleChanged=!1,this.createActions(),this.inaction=!1;var t={store:this.ruleStore,header:!1,height:450,autoExpandColumn:"path",ddText:_T("firewall","firewall_rules_drag_drop_text"),enableDragDrop:!0,enableColumnMove:!1,enableHdMenu:!1,viewConfig:{markDirty:!1,ddGroup:"ChrootRulesDD"},listeners:{rowdblclick:function(){this.openRuleDialog("edit")},rowcontextmenu:this.onRowContextMenu,containercontextmenu:this.showCtxMenu,scope:this},tbar:{defaultType:"syno_button",items:[this.getAction("add"),this.getAction("edit"),this.getAction("del")]},colModel:new Ext.grid.ColumnModel({columns:[{id:"name",header:_T("acl_editor","user_or_group"),dataIndex:"name",width:150,renderer:function(e,t,i){var s=i.get("type"),n=e,o='<div  class="{0}"  style="width: 26px;\t  height: 26px;\t  background-position-x: 0px;\t  display: inline-block;\t  vertical-align: middle;"></div>',a=String.format(o,"acl-grid-item-user"),r=String.format(o,"acl-grid-item-group"),l=String.format('<div style="display: inline-block;\t\t\t vertical-align: middle;">\t{0} </div>',n);return"user"===s?a+l:r+l},scope:this},{id:"path",header:_T("ftp","ftp_root_dir"),dataIndex:"path",width:200,renderer:function(e,t,i){var s=Ext.util.Format.htmlEncode(e.substr(1)),n=!0;return i.data.path_exist||(t.attr=String.format('ext:qtip="{0}"',_T("mediaservice","error_folder_not_exist")),n=!1),"/home"===i.data.path&&(0<i.data.name.indexOf("@")&&!this.ldapUserHomeEnabled||0<i.data.name.indexOf("\\")&&!this.domainUserHomeEnabled?(t.attr=String.format('ext:qtip="{0}"',_T("ftp","ftp_domain_ldap_user_home_disabled")),n=!1):this.userHomeEnabled||(t.attr=String.format('ext:qtip="{0}"',_T("ftp","ftp_user_home_disabled")),n=!1)),n?s:'<span class="red-status">'+s+"</span>"},scope:this},{header:"type",id:"type",dataIndex:"type",hidden:!0}]}),selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:{fn:this.onChgButtonStatus,buffer:50,scope:this}}})};Ext.apply(t,e),SYNO.LayoutConfig.fill(t),this.callParent([t])},createActions:function(){var e=function(e,t,i,s,n){return new Ext.Action(Ext.apply({text:e,itemId:t,scope:s,handler:i},n))};return this.actions={add:e(_T("common","add"),"addBtn",(function(){this.openRuleDialog("add")}),this),edit:e(_T("common","alt_edit"),"editBtn",(function(){this.openRuleDialog("edit")}),this),del:e(_T("common","remove"),"delBtn",this.onDelBtnClick,this)},this.actions},getAction:function(e){return e in this.actions?this.actions[e]:void SYNO.Debug("no this action: "+e)},enableAction:function(e,t){var i=this.getAction(e);i&&i[t?"enable":"disable"]()},initEvents:function(){this.mon(this.ruleStore,"beforeload",this.onGridBeforeLoad,this),this.mon(this.ruleStore,"load",this.onGridAfterLoad,this),this.mon(this.ruleStore,"exception",this.onGridException,this),this.mon(this.ruleStore,"update",this.onChgButtonStatus,this),this.mon(this.ruleStore,"add",this.onStoreAdd,this),this.mon(this.ruleStore,"remove",this.onStoreRemove,this),this.mon(this,"afterlayout",(function(){this.ddrow=new Ext.dd.DropTarget(this.getView().mainBody,{ddGroup:"ChrootRulesDD",copy:!1,scope:this,notifyDrop:function(e,t,i){return this.scope.mvRules(e.getDragData(t).rowIndex,i.selections,i.grid.getStore())}})}),this,{single:!0})},onGridException:function(e,t,i,s,n,o){var a=_T("common","commfail");SYNO.API.Erros.core[n.code]&&(a=SYNO.API.Erros.core[n.code]),this.owner.getMsgBox().alert(this.title,a),this.onChgButtonStatus(),this.owner.clearStatusBusy()},onGridBeforeLoad:function(e,t){this.owner.setStatusBusy({text:_T("common","loading")})},onGridAfterLoad:function(e,t,i){this.onChgButtonStatus(),this.owner.clearStatusBusy()},onStoreAdd:function(e,t,i){this.isRuleChanged=!0,this.onChgButtonStatus()},onStoreRemove:function(e,t,i){this.isRuleChanged=!0,this.onChgButtonStatus()},isDirty:function(){return 0<this.ruleStore.getModifiedRecords().length||this.isRuleChanged},mvRules:function(e,t,i){if(void 0===e)return!1;for(var s=0;s<t.length;s++)i.remove(t[s]);return e>=i.getCount()?i.add(t):i.insert(e,t),this.isRuleChanged=!0,!0},onShow:function(){this.ruleStore.load({params:{offset:0,limit:50}})},onChgButtonStatus:function(){var e=this.getSelectionModel().getCount();this.enableAction("del",0<e),this.enableAction("edit",1===e)},initCtxMenu:function(){this.gridCtxMenu=new SYNO.ux.Menu({autoDestroy:!0,items:[this.getAction("edit"),this.getAction("del")]})},getCtxMenu:function(){return this.gridCtxMenu||this.initCtxMenu(),this.gridCtxMenu},showCtxMenu:function(e,t){this.getCtxMenu().showAt(t.getXY())},onRowContextMenu:function(e,t,i){var s=e.getSelectionModel();s.suspendEvents(!1),s.selectRow(t,s.isSelected(t)),this.onChgButtonStatus(),s.resumeEvents(),this.showCtxMenu(e,i)},onMoveRow:function(e){var t=this.getStore(),i=this.getSelectionModel().getSelected(),s=t.indexOf(i);(s+=e?-1:1)<0||s>t.getCount()-1||(this.inaction=!0,t.remove(i),t.insert(s,i),this.getSelectionModel().selectRecords([i]),this.inaction=!1)},createRuleStore:function(){return new SYNO.API.JsonStore({api:"SYNO.Core.FileServ.FTP.ChrootUser",method:"load",version:2,root:"rules",fields:["type","name","path","path_exist"],appWindow:this.owner||!1,defaultSortable:!0})},onDelBtnClick:function(){for(var e=this.getSelectionModel().getSelections(),t=this.getStore(),i=0;i<e.length;i++)t.remove(e[i])},openRuleDialog:function(e){var t="",i=null;"add"===e?(t=_T("common","add"),i=null):(t=_T("common","alt_edit"),i=this.getSelectionModel().getSelected()),new SYNO.SDS.AdminCenter.FileService.FTP.ChrootRuleEditDialog({owner:this.owner,module:this,title:t,rule:null!==i?i.data:null,userHomeEnabled:this.userHomeEnabled,domainUserHomeEnabled:this.domainUserHomeEnabled,ldapUserHomeEnabled:this.ldapUserHomeEnabled}).open()}}),Ext.define("SYNO.SDS.AdminCenter.FileService.FTP.ChrootRuleEditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t;this.owner=e.owner,this.userHomeEnabled=e.userHomeEnabled,this.domainUserHomeEnabled=e.domainUserHomeEnabled,this.ldapUserHomeEnabled=e.ldapUserHomeEnabled,this.shareStore=new Ext.data.JsonStore({fields:["name"]}),this.panel=this.configForm(),this.rule=e.rule?e.rule:null,t=this.fillConfig(e),Ext.apply(t,e||{}),this.callParent([t]),this.mon(this,"show",this.load,this)},configForm:function(){var e=null,t={itemId:"chroot_form",trackResetOnLoad:!0,border:!1,padding:0,height:200,labelWidth:150,items:[new SYNO.SDS.Share.ACLPrivilege.UserGrpCombo({fieldLabel:_T("acl_editor","user_or_group"),itemId:"cmb_owner",queryParam:"prefix",width:280,listeners:{change:function(){this.checkHomeExist()},select:function(){this.checkHomeExist()},scope:this},store:new Ext.data.Store({autoDestroy:!0,proxy:new SYNO.API.Proxy({api:"SYNO.Core.ACL",method:"list_owners",version:1,appWindow:this}),reader:new Ext.data.JsonReader({root:"owners",totalProperty:"total",id:"value"},[{name:"type"},{name:"name"},{name:"value",convert:function(e,t){return t.type+":"+t.name}}]),paramNames:{start:"offset",limit:"limit"},remoteSort:!0,baseParams:{include_everyone:!1,include_owner:!1},pruneModifiedRecords:!0})}),{xtype:"syno_displayfield",value:_T("ftp","ftp_chroot_to")+_T("common","colon")},{xtype:"syno_radio",name:"chroot_type",inputValue:"home",boxLabel:_T("user","user_home")},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_radio",name:"chroot_type",inputValue:"custom",width:150,boxLabel:_T("ftp","ftp_root_dir")+_T("common","colon")},{xtype:"syno_combobox",name:"chroot_share",itemId:"chroot_share",indent:0,width:280,displayField:"name",valueField:"name",allowBlank:!1,store:this.shareStore}]}]};return SYNO.LayoutConfig.fill(t),(e=new SYNO.SDS.Utils.FormPanel(t)).on("afterlayout",(function(e,t){this.checkChrootType=new SYNO.ux.Utils.EnableRadioGroup(e.getForm(),"chroot_type",{custom:["chroot_share"]})}),this,{single:!0}),e},load:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.Share",version:1,method:"list",params:{shareType:["local","cluster","usb","sata","dec","c2","cold_storage"]},scope:this,callback:function(e,t,i){this.clearStatusBusy(),e?(this.setShareStore(t),this.afterLoad()):this.setStatusError()}})},setShareStore:function(e){for(var t=[],i=0;i<e.shares.length;i++)"home"!==e.shares[i].name&&"homes"!==e.shares[i].name&&t.push({name:e.shares[i].name});this.shareStore.loadData(t,!1)},afterLoad:function(){if(this.rule){var e=this.panel.getComponent("cmb_owner"),t=this.rule.path.substr(1);e.setDefaultValue(this.rule.name,this.rule.type,this.rule.type+":"+this.rule.name),"home"===t?this.panel.getForm().setValues({chroot_type:"home"}):this.panel.getForm().setValues({chroot_type:"custom",chroot_share:t})}else this.panel.getForm().setValues({chroot_type:"home"});this.checkHomeExist()},checkHomeExist:function(){var e=this.getRecord();const t=this.panel.getForm().findFields("chroot_type")[0];0<e.name.indexOf("@")&&!this.ldapUserHomeEnabled||0<e.name.indexOf("\\")&&!this.domainUserHomeEnabled?(this.panel.getForm().setValues({chroot_type:"custom"}),t.setDisabled(!0),t.boxlabelEl.update(String.format('<span ext:qtip="{0}">{1}</span>',_T("ftp","ftp_domain_ldap_user_home_disabled"),t.boxLabel))):this.userHomeEnabled?t.setDisabled(!1):(this.panel.getForm().setValues({chroot_type:"custom"}),t.setDisabled(!0),t.boxlabelEl.update(String.format('<span ext:qtip="{0}">{1}</span>',_T("ftp","ftp_user_home_disabled"),t.boxLabel)))},fillConfig:function(e){var t={owner:e.owner,module:e.module,width:500,autoHeight:!0,autoScroll:!1,title:e.title,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),handler:this.onCloseHandler,scope:this},{btnStyle:"blue",text:_T("common","ok"),handler:this.onUpdateRuleGrid,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",scope:this}]};return Ext.apply(t,e),t},onCloseHandler:function(){this.close()},getRecord:function(){var e={type:"",name:"",path:""},t=this.panel.getForm().findField("chroot_type").getGroupValue(),i=this.panel.getComponent("cmb_owner").getValue().split(":");return void 0!==i[0]&&""!==i[0]&&(e.type=i[0]),void 0!==i[1]&&""!==i[1]&&(e.name=i[1]),e.path="home"===t?"/home":"/"+this.panel.getForm().findField("chroot_share").getValue(),e},validateData:function(e){if(this.panel.getComponent("cmb_owner").valueNotFound()||""===e.type||""===e.name)return this.setStatusError({text:_T("acl_editor","error_invalid_user_or_group"),clear:!0}),!1;if(!this.panel.getForm().isValid())return this.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1;var t=-1;null!==this.rule&&(t=this.owner.panel.getStore().indexOf(this.owner.panel.getSelectionModel().getSelected()));for(var i=this.owner.panel.getStore().getRange(),s=0;s<i.length;s++)if(e.name===i[s].get("name")&&e.type===i[s].get("type")){if(t===s)continue;return this.setStatusError({text:_T("ftp","ftp_chroot_duplicate_user_group"),clear:!0}),this.panel.getComponent("cmb_owner").markInvalid(_T("ftp","ftp_chroot_duplicate_user_group")),!1}return!0},onUpdateRuleGrid:function(){var e,t=null,i=null,s=this.owner.panel,n=this.owner.panel.ruleStore;if(e=this.getRecord(),!this.validateData(e))return!1;null===this.rule?(i=new n.recordType({type:"",name:"",path:"",path_exist:!0}),n.insert(0,i),i.set("type",e.type),i.set("name",e.name),i.set("path",e.path)):(t=s.getSelectionModel().getSelected(),e.path!==t.get("path")&&t.set("path_exist",!0),t.set("type",e.type),t.set("name",e.name),t.set("path",e.path)),this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.FileService.FTP"),Ext.define("SYNO.SDS.AdminCenter.FileService.FTP.ChrootUserPanel",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.userStore=this.createUserStore(),this.userChooserDialog=null,this.domainUserHomeEnabled=e.domainUserHomeEnabled,this.ldapUserHomeEnabled=e.ldapUserHomeEnabled;var t={store:this.userStore,header:!1,height:450,autoExpandColumn:"descr",tbar:{items:[{xtype:"syno_button",text:_T("common","add"),itemId:"addBtn",handler:this.onAddBtnClick,scope:this},{xtype:"syno_button",text:_T("common","remove"),itemId:"delBtn",handler:this.onDelBtnClick,disabled:!0,scope:this}]},colModel:new Ext.grid.ColumnModel({columns:[{id:"name",header:_T("user","user_account"),dataIndex:"name",width:150},{id:"descr",header:_T("user","user_fullname"),dataIndex:"descr",width:150,renderer:Ext.util.Format.htmlEncode}]}),selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:{fn:this.onSelectionChange,buffer:50,scope:this}}})};Ext.apply(t,e),SYNO.LayoutConfig.fill(t),this.callParent([t])},onShow:function(){this.userStore.load({params:{offset:0,limit:50}})},onSelectionChange:function(){var e=this.getTopToolbar(),t=this.getSelectionModel().getCount();e.getComponent("delBtn").setDisabled(0>=t)},createUserStore:function(){return new SYNO.API.JsonStore({api:"SYNO.Core.FileServ.FTP.ChrootUser",method:"list",version:1,root:"user",idProperty:"id",fields:["id","name","descr"],totalProperty:"total",appWindow:this.findAppWindow()||!1,defaultSortable:!0,baseParams:{type:"all",chroot:!0},paramNames:{start:"offset",limit:"limit"}})},onDelBtnClick:function(){this.module.appWin.getMsgBox().confirmDelete(_T("ftp","ftp_chroot_user_list"),_T("ftp","ftp_cfrm_remove_users"),(function(e){"yes"==e&&this.doDelete()}),this)},doDelete:function(){for(var e=[],t=this.getSelectionModel().getSelections(),i=0;i<t.length;i++)e.push(t[i].id);this.owner.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.FTP.ChrootUser",method:"delete",version:1,scope:this,params:{id:e},callback:function(e,t,i){this.owner.clearStatusBusy(),e&&this.deleteDone()}})},deleteDone:function(){this.userStore.reload()},onAddBtnClick:function(){this.userChooserDialog=new SYNO.SDS.UserChooser({owner:this.owner,module:this.module,domainForceIgnore:!this.domainUserHomeEnabled,ldapForceIgnore:!this.ldapUserHomeEnabled,setStoreConfig:function(){return{api:"SYNO.Core.FileServ.FTP.ChrootUser",method:"list",version:"1",id:"id",root:"user",totalProperty:"total"}},setApiParams:function(){return{chroot:!1,type:"all"}},setStoreField:function(){return["id","name","descr"]},setColModel:function(){return[{id:"name",header:_T("user","user_account"),dataIndex:"name",width:150},{id:"descr",header:_T("user","user_fullname"),dataIndex:"descr",width:150,renderer:Ext.util.Format.htmlEncode}]},setTextFilterConfig:function(){return{queryAction:"list",queryParam:"substr"}},setGridPanelConfig:function(){return{autoExpandColumn:"descr"}},singleSelect:!1,localOnly:!1}),this.mon(this.userChooserDialog,"beforeclose",this.onBeforeCloseUserChooser,this),this.userChooserDialog.chooseUsers()},onBeforeCloseUserChooser:function(e){var t=[],i=e.getRecords();if(0===i.length)return!0;for(var s=0;s<i.length;s++)t.push(i[s].id);return e.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.FTP.ChrootUser",method:"add",params:{id:t},version:1,scope:this,callback:function(e,t,i){this.userChooserDialog.clearStatusBusy(),e?(this.userStore.reload(),this.mun(this.userChooserDialog,"beforeclose",this.onBeforeCloseUserChooser,this),this.userChooserDialog.close()):this.setStatusError()}}),!1}}),Ext.define("SYNO.SDS.AdminCenter.FileService.FTP.ChrootUserDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=new SYNO.SDS.AdminCenter.FileService.FTP.ChrootUserPanel({owner:this,module:this.module,domainUserHomeEnabled:e.domainUserHomeEnabled,ldapUserHomeEnabled:e.ldapUserHomeEnabled});var t=Ext.apply({dsmStyle:"v5",title:_T("ftp","ftp_chroot_user_list"),autoDestroy:!0,width:670,height:500,autoHeight:!0,layout:"fit",items:[this.panel],buttons:[{text:_T("common","alt_finish"),scope:this,handler:this.close}]},e);this.callParent([t]),this.mon(this,"show",this.panel.onShow,this.panel)}}),Ext.define("SYNO.SDS.AdminCenter.FileService.FTP.AdvancedSettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.xferFieldSet=this.createXferFieldSet(),this.securityFieldSet=this.createSecurityFieldSet(),this.userHomeEnabled=!1,this.domainUserHomeEnabled=!1,this.ldapUserHomeEnabled=!1,this.needResetAnonymousChrootShare=!1,this.webapi=[{api:"SYNO.Core.FileServ.FTP.Security",method:"get",version:1},{api:"SYNO.Core.FileServ.FTP.Security",method:"list_ftp_share",version:1},{api:"SYNO.Core.User.Home",method:"get",version:1},{api:"SYNO.Core.SyslogClient.FileTransfer",method:"get",version:1}],this.panel=this.configForm();var t=Ext.apply({dsmStyle:"v5",title:_T("common","adv_setting"),autoDestroy:!0,width:650,autoHeight:!0,layout:"fit",border:!1,closeAction:"onCloseBtnClick",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.onCloseBtnClick},{btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","save"),scope:this,handler:this.onApplyBtnClick}]},e);this.callParent([t]),this.mon(this,"show",this.load,this)},configForm:function(){var e=null,t={border:!1,itemId:"formpanel",trackResetOnLoad:!0,autoHeight:!0,width:250,items:[this.xferFieldSet,this.securityFieldSet]};return SYNO.LayoutConfig.fill(t),(e=new SYNO.SDS.Utils.FormPanel(t)).on("afterlayout",(function(e,t){this.checkEnableAnonymousChroot=new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"anonymous_chroot",["anonymous_chroot_share"])}),this,{single:!0}),e},load:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({params:{},scope:this,compound:{params:this.webapi},callback:function(e,t,i){this.clearStatusBusy(),e?(this.setAllValues(t),this.afterLoad()):this.setStatusError()}})},anonymousChrootHandler:function(e,t){var i=this.panel.getForm().findField("anonymous_chroot");this.updateARIA(),0>=this.ftpShareStore.getCount()||(t?i.enable():i.disable())},isAnonymousChrootShareValid:function(){for(var e=this.panel.getForm().findField("anonymous_chroot_share").getValue(),t=!1,i=0;i<this.ftpShareStore.getCount();i++)if(e==this.ftpShareStore.getAt(i).get("name")){t=!0;break}return t},updateARIA:function(){var e=this.panel.getForm();e.findField("anonymous").getValue()?e.findField("anonymous_desc").getItemCt().setARIA({tabIndex:0}):e.findField("anonymous_desc").getItemCt().setARIA({tabIndex:-1})},afterLoad:function(){var e=this.panel.getForm(),t=e.findField("xferlog").getValue(),i=e.findField("anonymous"),s="SYNO.SDS.CMS.Application"===this.findAppWindow().getOpenConfig("className");this.isAnonymousChrootShareValid()||(e.setValues({anonymous_chroot:!1,anonymous_chroot_share:""}),this.needResetAnonymousChrootShare=!0),this.updateARIA(),i.mon(i,"check",this.anonymousChrootHandler,this),0>=this.ftpShareStore.getCount()?(e.findField("anonymous_chroot").disable(),e.findField("no_share").show(),e.findField("no_share").getItemCt().setARIA({tabIndex:-1})):(e.findField("anonymous").getValue()?e.findField("anonymous_chroot").enable():e.findField("anonymous_chroot").disable(),""===e.findField("anonymous_chroot_share").getValue()&&e.setValues({anonymous_chroot_share:this.ftpShareStore.getAt(0).get("name")})),this.panel.getComponent("xferFieldSet").getComponent("exportLogBtn").setDisabled(!t),s?this.panel.getComponent("xferFieldSet").getComponent("viewLogBtn").disable():this.panel.getComponent("xferFieldSet").getComponent("viewLogBtn").setDisabled(!t)},onApplyBtnClick:function(){var e=this.panel.getForm(),t=e.getValues(),i=t.xferlog,s=[];e.isDirty()?(this.needResetAnonymousChrootShare&&(void 0===t.anonymous_chroot&&(t.anonymous_chroot=!1),void 0===t.anonymous_chroot_share&&(t.anonymous_chroot_share="")),e.findField("xferlog").isDirty()&&(s=s.concat({api:"SYNO.Core.SyslogClient.FileTransfer",method:"set",version:1,params:{ftp:i}})),s=s.concat({api:"SYNO.Core.FileServ.FTP.Security",method:"set",version:1,params:t}),this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({compound:{stopwhenerror:!1,params:s},scope:this,callback:function(t,i,s){if(this.clearStatusBusy(),i.has_fail){var n=SYNO.API.Response.GetFirstError(i);1905==n.code?(e.findField("anonymous_chroot_share").markInvalid(SYNO.API.Erros.core[n.code]),this.setStatusError({text:_T("error","error_invalid"),clear:!0})):this.setStatusError({text:SYNO.API.Erros.core[n.code],clear:!0})}else this.close()}})):this.close()},onCloseBtnClick:function(){if(!this.panel.getForm().isDirty())return this.close(),!0;this.confirmLostChangePromise({dontSave:this.close,cancel:Ext.emptyFn,save:this.onApplyBtnClick},this)},setAllValues:function(e){var t={},i=[],s=!1;Ext.each(e.result,(function(e){Ext.apply(t,e.data)}));for(var n={api:"SYNO.Core.FileServ.FTP.Security",method:"list_ftp_share",version:1},o={api:"SYNO.Core.User.Home",method:"get",version:1},a={api:"SYNO.Core.SyslogClient.FileTransfer",method:"get",version:1},r=0;r<e.result.length;r++){var l=0;if(!0===SYNO.ux.Utils.checkApiConsistency(n,e.result[r])){for(this.ftpShareStore.removeAll(),l=0;l<e.result[r].data.share.length;l++)i.push({name:e.result[r].data.share[l]});this.ftpShareStore.loadData(i,!1)}else!0===SYNO.ux.Utils.checkApiConsistency(o,e.result[r])?(this.userHomeEnabled=e.result[r].data.enable,this.domainUserHomeEnabled=e.result[r].data.enable_domain,this.ldapUserHomeEnabled=e.result[r].data.enable_ldap):!0===SYNO.ux.Utils.checkApiConsistency(a,e.result[r])?s=e.result[r].data.ftp:Ext.apply(t,e.result[r].data)}Ext.apply(t,{xferlog:s}),this.panel.getForm().setValues(t)},createXferFieldSet:function(){return{xtype:"syno_fieldset",title:_T("ftp","xfer_setting"),itemId:"xferFieldSet",collapsible:!1,items:[{xtype:"syno_checkbox",name:"xferlog",itemId:"xferlog",boxLabel:_T("ftp","ftp_xferlog")},{xtype:"syno_button",itemId:"viewLogBtn",indent:1,text:_T("log","log_subtitle"),handler:function(){SYNO.SDS.AppLaunch("SYNO.SDS.LogCenter.BuiltIn",{logType:"fileTransfer",protocol:"ftpxfer"})}},{xtype:"displayfield",height:0},{xtype:"syno_splitbutton",indent:1,itemId:"exportLogBtn",text:_T("ftp","export_log"),scope:this,handler:this.onExportHtml,menu:{items:[{text:_T("log","html_type"),handler:this.onExportHtml,scope:this},{text:_T("log","csv_type"),handler:this.onExportCSV,scope:this}]}}]}},onExportCSV:function(){this.onLogSave("csv")},onExportHtml:function(){this.onLogSave("html")},onLogSave:function(e){_S("demo_mode")?this.module.appWin.getMsgBox().alert(this.module.appWin.title,_JSLIBSTR("uicommon","error_demo")):this.saveLog(e)},saveLog:function(e){synowebapi.download({api:"SYNO.Core.SyslogClient.Log",method:"export",version:1,params:{logtype:"ftp",format:e}})},createSecurityFieldSet:function(){return this.ftpShareStore=new Ext.data.JsonStore({fields:["name"]}),{xtype:"syno_fieldset",title:_T("ftp","security_setting"),itemId:"securityFieldSet",collapsible:!1,items:[{xtype:"syno_checkbox",name:"user_chroot",itemId:"user_chroot",boxLabel:2<=SYNO.API.GetKnownAPI("SYNO.Core.FileServ.FTP.ChrootUser").maxVersion?_T("ftp","ftp_chroot_desc"):_T("ftp","ftp_user_chroot"),listeners:{check:{scope:this,fn:this.onUserChrootCheck}}},{disabled:!0,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",xtype:"syno_button",indent:1,text:_T("ftp","ftp_user_select"),itemId:"select_user_btn",scope:this,handler:this.onSelectUserBtnClick},{xtype:"syno_checkbox",name:"user_home",hidden:!0},{xtype:"syno_checkbox",name:"anonymous",itemId:"anonymous",boxLabel:_T("ftp","ftp_anonymous")},{xtype:"syno_displayfield",name:"anonymous_desc",indent:1,value:_T("ftp","ftp_anonymous_desc")},{xtype:"syno_checkbox",name:"anonymous_chroot",itemId:"anonymous_chroot",indent:1,boxLabel:_T("ftp","ftp_anonymous_chroot")},{xtype:"syno_combobox",name:"anonymous_chroot_share",itemId:"anonymous_chroot_share",indent:1,fieldLabel:_T("ftp","ftp_root_dir"),displayField:"name",valueField:"name",store:this.ftpShareStore},{xtype:"syno_displayfield",indent:1,name:"no_share",itemId:"no_share",hidden:!0,htmlEncode:!1,value:String.format('<span class="red-status">{0}</span>',_T("ftp","ftp_no_share"))},{xtype:"hidden",name:"share_status"},{xtype:"syno_checkbox",name:"enable_umask",itemId:"enable_umask",boxLabel:_T("common","apply_default_umask")}]}},onSelectUserBtnClick:function(){(2<=SYNO.API.GetKnownAPI("SYNO.Core.FileServ.FTP.ChrootUser").maxVersion?new SYNO.SDS.AdminCenter.FileService.FTP.ChrootRuleDialog({module:this.module,owner:this,userHomeEnabled:this.userHomeEnabled,domainUserHomeEnabled:this.domainUserHomeEnabled,ldapUserHomeEnabled:this.ldapUserHomeEnabled}):new SYNO.SDS.AdminCenter.FileService.FTP.ChrootUserDialog({module:this.module,owner:this,domainUserHomeEnabled:this.domainUserHomeEnabled,ldapUserHomeEnabled:this.ldapUserHomeEnabled})).open()},onUserChrootCheck:function(e,t){this.panel.getComponent("securityFieldSet").getComponent("select_user_btn").setDisabled(!t)}}),Ext.ns("SYNO.SDS.AdminCenter.FileService"),Ext.define("SYNO.SDS.AdminCenter.FileService.FtpSftpTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.SFTP_DEFAULT_PORT=22,this.defaultPasvMinPort=parseInt(_D("ftp_pasv_def_min_port","55536"),10),this.defaultPasvMaxPort=parseInt(_D("ftp_pasv_def_max_port","55663"),10),this.sftpPort=0,this.ftpApiMaxVersion=SYNO.API.GetKnownAPI("SYNO.Core.FileServ.FTP").maxVersion,this.hasGetFtpExtIP=!1;var t=this.fillConfig(e);this.callParent([t]),this.generalForm=this.getComponent("generalFieldSet"),this.ftpForm=this.getComponent("ftpFieldSet"),this.sftpForm=this.getComponent("sftpFieldSet"),this.on("afterlayout",(function(e,t){var i=e.ftpForm.getComponent("custom_port_desc");this.checkEnableCustomPortRange=new SYNO.ux.Utils.EnableRadioGroup(e.getForm(),"custom_port_range",{true:["port_low","port_high"]}),this.checkEnableExtIP=new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"use_ext_ip",["ext_ip"]),SYNO.ux.Utils.DescribeGroup(e.getForm().findField("timeout"),e.getForm().findField("timeout_desc")),SYNO.ux.Utils.DescribeGroup(i.items.get(1),i.items.get(0)),SYNO.ux.Utils.DescribeGroup(i.items.get(3),i.items.get(2))}),this,{single:!0})},fillConfig:function(e){var t={title:_T("tree","leaf_ftp"),autoScroll:!0,labelWidth:300,items:[this.createFtpTabObj(e),this.createSftpTabObj(e),this.createGeneralTabObj(e)]};return Ext.apply(t,e),t},createGeneralTabObj:function(e){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::ftp::general",title:_T("common","general"),itemId:"generalFieldSet",collapsible:!0,items:[{xtype:"syno_displayfield",itemId:"ftp_adv_opt_desc",value:_T("ftp","ftp_advanced_option_desc")},{xtype:"syno_button",btnStyle:"default",itemId:"advBtn",text:_T("common","adv_setting"),autoWidth:!0,handler:this.onFtpAdvSettingBtnClick,scope:this},SYNO.SDS.BandwidthControl.SchedulePanelConfig(this,"FTP")]}},onFtpAdvSettingBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.FTP.AdvancedSettingDialog({module:this.module,owner:this.module.appWin}).open()},createFtpTabObj:function(e){var t={xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::ftp::ftp",title:_T("ftp","ftp_ftpes"),itemId:"ftpFieldSet",name:"ftpFieldSet",collapsible:!0,webapi:{api:"SYNO.Core.FileServ.FTP",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_checkbox",itemId:"enable_ftp",name:"enable_ftp",boxLabel:_T("ftp","ftp_enabled"),listeners:{scope:this,check:this.setFormsEnabled}},{xtype:"syno_checkbox",itemId:"enable_ftps",name:"enable_ftps",boxLabel:_T("ftp","ftpes_enabled"),listeners:{scope:this,check:this.setFormsEnabled}},{xtype:"syno_compositefield",indent:1,items:[{xtype:"syno_numberfield",name:"timeout",maxlength:4,width:166,fieldLabel:_T("ftp","ftp_timeout"),validator:function(e){var t=parseInt(e,10);return!(t<1||t>7200)||_T("error","error_bad_field")}},{xtype:"syno_displayfield",name:"timeout_desc",value:_T("time","time_second")+" "+_T("ftp","timeout_range"),"aria-label":_T("time","time_second")+" "+SYNO.ux.Utils.ConvertSingleSymbolToString(_T("ftp","timeout_range"),"~")}]},{xtype:"syno_numberfield",indent:1,name:"portnum",maxlength:5,width:166,fieldLabel:_T("ftp","ftp_port"),vtype:"port",validator:function(e){return!SYNO.SDS.Utils.isReservedPort("ftp",e,e)||_T("service","error_dl_port_in_used")}},{xtype:"syno_displayfield",indent:1,value:_T("ftp","ftp_pasv_port_range")},{xtype:"syno_radio",checked:!0,indent:2,name:"custom_port_range",inputValue:"false",boxLabel:_T("service","service_dl_default_port")+" ("+this.defaultPasvMinPort+"-"+this.defaultPasvMaxPort+")","aria-label":_T("service","service_dl_default_port")+this.defaultPasvMinPort+_T("ftp","ftp_port_to")+this.defaultPasvMaxPort},{xtype:"syno_radio",indent:2,name:"custom_port_range",inputValue:"true",boxLabel:_T("ftp","ftp_manual_port_range")+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:!0,fieldLabel:"composite field",itemId:"custom_port_desc",indent:3,items:[{xtype:"syno_displayfield",value:_T("ftp","ftp_port_from")+_T("common","colon")},{xtype:"syno_numberfield",name:"port_low",maxlength:5,vtype:"port"},{xtype:"syno_displayfield",value:_T("ftp","ftp_port_to")+_T("common","colon")},{xtype:"syno_numberfield",name:"port_high",maxlength:5,vtype:"port"}]},{xtype:"syno_checkbox",indent:1,name:"use_ext_ip",boxLabel:_T("ftp","ftp_pasv_ext_ip")},{xtype:"syno_combobox",name:"ext_ip",itemId:"ext_ip",indent:2,fieldLabel:_T("ftp","ftp_pasv_ext_ip_assign"),store:new Ext.data.JsonStore({fields:["display","value"],idProperty:"value",data:[]}),editable:!0,displayField:"display",valueField:"value",width:230,allowBlank:!1,owner:this,onTriggerClick:function(){!1===this.disabled&&this.owner.onFtpExternalIPComboClick(this)},validator:function(e){if(""===e)return _JSLIBSTR("extlang","fieldblank");if(Ext.form.VTypes.ip(e))return!0;for(var t=0;t<this.getStore().getCount();t++)if(e==this.getStore().getAt(t).data.display||e==this.getStore().getAt(t).data.value)return!0;return _JSLIBSTR("vtype","bad_ip")}}]};return 2==this.ftpApiMaxVersion?t.items.push({xtype:"syno_checkbox",indent:1,name:"use_utf8",boxLabel:_T("ftp","ftp_use_utf8")}):1==this.ftpApiMaxVersion&&t.items.push({xtype:"syno_checkbox",indent:1,name:"enable_utf8",boxLabel:_T("ftp","ftp_utf8_client")}),t.items=t.items.concat([{xtype:"syno_checkbox",indent:1,name:"enable_fxp",boxLabel:_T("ftp","fxp_enable")},{xtype:"syno_checkbox",indent:1,name:"enable_ascii",boxLabel:_T("ftp","ftp_support_ascii_mode")}]),3<=this.ftpApiMaxVersion&&t.items.push({xtype:"syno_combobox",name:"utf8_mode",indent:1,fieldLabel:_T("ftp","ftp_utf8_desc"),displayField:"display",valueField:"value",store:new Ext.data.ArrayStore({fields:["display","value"],idIndex:0,data:[[_T("ftp","ftp_utf8_disabled"),0],[_T("ftp","ftp_utf8_auto"),1],[_T("ftp","ftp_utf8_forced"),2]]})}),t.items=t.items.concat([{xtype:"syno_displayfield",indent:1,value:_T("ftp","ftp_modify_time_std")},{xtype:"syno_radio",checked:!0,indent:2,name:"modify_time_std",inputValue:"utc",boxLabel:_T("ftp","ftp_utc_time")},{xtype:"syno_radio",indent:2,name:"modify_time_std",inputValue:"local",boxLabel:_T("ftp","ftp_local_time")},{xtype:"syno_button",indent:1,btnStyle:"default",itemId:"advanceBtnId",text:_T("ftp","conn_restriction"),autoWidth:!0,scope:this,handler:this.onFtpConnectionSettingBtnClick}]),t.webapi.version=this.ftpApiMaxVersion,t},createSftpTabObj:function(e){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::ftp::sftp",title:_T("ftp","sftp_setting"),itemId:"sftpFieldSet",collapsible:!0,webapi:{api:"SYNO.Core.FileServ.FTP.SFTP",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_checkbox",itemId:"enable_sftp",name:"enable",boxLabel:_T("ftp","sftp_enabled"),listeners:{scope:this,check:this.setFormsEnabled}},{xtype:"syno_numberfield",indent:1,name:"sftp_portnum",maxlength:5,vtype:"port",fieldLabel:_T("ftp","sftp_port"),validator:function(e){return!SYNO.SDS.Utils.isReservedPort("ssh",e,e)||_T("service","error_dl_port_in_used")}}]}},getScheduleForm:function(){return this.getForm()},setFormsEnabled:function(){var e=this.ftpForm.getComponent("enable_ftp").checked,t=this.ftpForm.getComponent("enable_ftps").checked,i=this.sftpForm.getComponent("enable_sftp").checked;this.setFtpFormEnabled(e||t),this.setSftpFormEnabled(i),this.setGeneralFormEnabled(e||t||i)},setFtpFormEnabled:function(e){for(var t=this.ftpForm,i=null,s="",n=["custom_port_desc","ext_ip"],o=0;o<t.items.getCount();o++)"enable_ftp"!=(s=(i=t.items.get(o)).getItemId())&&"enable_ftps"!=s&&(0<=n.indexOf(s)||i.setDisabled(!e))},setSftpFormEnabled:function(e){for(var t=this.sftpForm,i=null,s=0;s<t.items.getCount();s++)"enable_sftp"!=(i=t.items.get(s)).getItemId()&&"sftp_ssh_prompt"!=i.getItemId()&&i.setDisabled(!e)},setGeneralFormEnabled:function(e){var t=this.generalForm;t.getComponent("advBtn").setDisabled(!e),e?(t.getEl().setARIA({tabIndex:0}),t.getComponent("ftp_adv_opt_desc").getEl().setARIA({tabIndex:0})):(t.getEl().setARIA({tabIndex:-1}),t.getComponent("ftp_adv_opt_desc").getEl().setARIA({tabIndex:-1})),this.bandwidthSettingEnable(e)},onFtpConnectionSettingBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.FTP.ConnectionSettingDialog({module:this.module,owner:this.module.appWin}).open()},onFtpExternalIPComboClick:function(e){this.hasGetFtpExtIP?(e.isExpanded()?e.collapse():(e.onFocus({}),e.expand()),e.el.focus()):(e.el.focus(),this.module.panel.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.DDNS.ExtIP",method:"list",version:1,callback:this.afterGetFtpExternalIP,scope:e}))},afterGetFtpExternalIP:function(e,t,i,s){var n=this.owner,o=this,a=this.getStore();if(n.module.panel.clearStatusBusy(),!e||!Ext.isArray(t)||0>=t.length)n.module.panel.setStatusError({text:_T("routerconf","routerconf_external_ip_warning")});else{n.hasGetFtpExtIP=!0;for(var r=[],l=[],d=[],c=0;c<t.length;c++)if("WAN"==t[c].type&&"0.0.0.0"!=t[c].ip)l=[{display:"WAN: "+t[c].ip,value:"default"}];else if("ha"==t[c].type.substr(0,2)){var h=t[c].type.match(/\d+/)[0];h=parseInt(h,10)+1,d.push({display:String.format("HA ({0}): {1}",h,t[c].ip),value:t[c].type})}r=(r=r.concat(l)).concat(d),o.isExpanded()||o.el.focus(),a.loadData(r,!0);var u=a.find("value",o.getValue());-1<u&&a.getAt(u)&&a.getAt(u).data&&o.setRawValue(a.getAt(u).data.display)}},isPortConflict:function(e){var t="true"==e.findField("custom_port_range").getGroupValue(),i=e.findField("portnum").getValue(),s=e.findField("sftp_portnum").getValue(),n=this.defaultPasvMinPort,o=this.defaultPasvMaxPort;return t&&((n=e.findField("port_low").getValue())>(o=e.findField("port_high").getValue())&&(e.findField("port_low").setValue(o),e.findField("port_high").setValue(n),n=e.findField("port_low").getValue(),o=e.findField("port_high").getValue()),SYNO.SDS.Utils.isReservedPort("ftp",n,o))?(this.ownerCt.setStatusError({text:_T("ftp","ftp_port_in_used"),clear:!0}),!0):i>=n&&i<=o?(this.ownerCt.setStatusError({text:_T("ftp","ftp_ports_conflict"),clear:!0}),!0):(s==i||s>=n&&s<=o||i==this.sftpPort)&&(this.ownerCt.setStatusError({text:_T("app_port_alias","err_port_dup"),clear:!0}),!0)},beforeRequest:function(e){return"set"!=e||!this.isPortConflict(this.getForm())},processParams:function(e,t){for(var i=this.getForm(),s={api:"SYNO.Core.FileServ.FTP.SFTP",method:"set",version:1},n=0;n<t.length;n++)"SYNO.Core.FileServ.FTP"===t[n].api&&"set"===t[n].method?(t[n].params.custom_port_range="true"==t[n].params.custom_port_range,t[n].params.custom_port_range&&(t[n].params.custom_port=t[n].params.port_low+":"+t[n].params.port_high)):!0===SYNO.ux.Utils.checkApiConsistency(s,t[n])&&(t[n].params.portnum=t[n].params.sftp_portnum);return"set"===e&&(this.ftpChange=i.findField("enable_ftp").isDirty(),this.ftpsChange=i.findField("enable_ftps").isDirty(),this.sftpChange=i.findField("enable_sftp").isDirty()),t},processReturnData:function(e,t,i){var s=[],n={api:"SYNO.Core.FileServ.FTP.SFTP",method:"get",version:1},o={api:"SYNO.Core.BandwidthControl.Protocol",method:"get",version:1,protocol:"FTP"};this.hasGetFtpExtIP=!1;for(var a=[],r=[],l=0;l<t.result.length;l++)if("SYNO.Core.FileServ.FTP"===t.result[l].api&&"get"===t.result[l].method){if(t.result[l].data.custom_port_range=t.result[l].data.custom_port_range?"true":"false",s=t.result[l].data.custom_port.split(":"),t.result[l].data.port_low=parseInt(s[0],10),t.result[l].data.port_high=parseInt(s[1],10),"default"===t.result[l].data.ext_ip){r=r.concat([{display:"WAN: Default external IP",value:"default"}])}else if("ha"===t.result[l].data.ext_ip.substr(0,2)){var d=t.result[l].data.ext_ip.match(/\d+/)[0];d=parseInt(d,10)+1;var c=[{display:String.format("HA ({0})",d),value:t.result[l].data.ext_ip}];r=r.concat(c)}else""!==t.result[l].data.ext_ip&&a.push({display:"MANUAL: "+t.result[l].data.ext_ip,value:t.result[l].data.ext_ip});t.result[l].data.modify_time_std||(t.result[l].data.modify_time_std="utc")}else!0===SYNO.ux.Utils.checkApiConsistency(n,t.result[l])?(t.result[l].data.sftp_portnum=t.result[l].data.portnum,this.sftpPort=t.result[l].data.portnum):!0===SYNO.ux.Utils.checkApiConsistency(o,t.result[l])&&i.compound[l].params.protocol===o.protocol&&(t.result[l].data=SYNO.SDS.BandwidthControl.reConstructApiKey("get",o.protocol,t.result[l].data));r=r.concat(a),this.ftpForm.getComponent("ext_ip").getStore().loadData(r,!1),this.getForm().loadRecords(t.result,i.compound),this.setFormsEnabled(),this.sendServiceEvent()},sendServiceEvent:function(){var e=this.getForm();this.ftpChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.FTP.FTP",!e.findField("enable_ftp").getValue()),this.ftpsChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.FTP.FTPES",!e.findField("enable_ftps").getValue()),this.sftpChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.FTP.SFTP",!e.findField("enable_sftp").getValue())},errorHandling:function(e){1903==e?this.getForm().findField("portnum").markInvalid(SYNO.API.Erros.core[e]):1904==e?(this.getForm().findField("port_low").markInvalid(SYNO.API.Erros.core[e]),this.getForm().findField("port_high").markInvalid(SYNO.API.Erros.core[e])):1951==e&&this.getForm().findField("sftp_portnum").markInvalid(SYNO.API.Erros.core[e]),this.module.appWin.getMsgBox().alert(this.title,_T("error","error_bad_field"))}}),Ext.ns("SYNO.SDS.AdminCenter.FileService.Rsync"),Ext.define("SYNO.SDS.AdminCenter.FileService.Rsync.AccountDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.appWin=e.owner,this.panel=new SYNO.SDS.AdminCenter.FileService.Rsync.AccountPanel({owner:this});var t={title:_T("service","rsync_account"),width:550,minWidth:550,height:300,minHeight:300,layout:"fit",buttons:[{xtype:"syno_button",text:_T("common","close"),scope:this,handler:this.close}],items:[this.panel]};Ext.apply(t,e||{}),this.callParent([t])},onShow:function(){this.load()},load:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.Rsync.Account",method:"list",version:1,scope:this,callback:this.loadListData})},loadListData:function(e,t,i){this.clearStatusBusy(),e?this.panel.getStore().loadData(t.account_list):this.errorHandling(t)},errorHandling:function(e){var t=SYNO.API.Response.GetFirstError(e),i=_T("common","commfail");SYNO.API.Errors.core[t.code]&&(i=SYNO.API.Errors.core[t.code]),this.setStatusError({text:i,clear:!0})}}),Ext.define("SYNO.SDS.AdminCenter.FileService.Rsync.AccountPanel",{extend:"SYNO.ux.GridPanel",constructor:function(e){function t(e,t){var i=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i)+'"',i}this.owner=e.owner,this.btntask=new Ext.util.DelayedTask(this.updateActionCB,this),this.actionGroup=this.createActionGroup(),Ext.apply(this,e||{}),e={layout:"fit",store:this.createStore(),loadMask:!0,stripeRows:!0,border:!1,sm:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{scope:this,spacepressed:function(){this.EditHandler()},selectionchange:function(){this.btntask.delay(100)}}}),enableHdMenu:!1,colModel:new Ext.grid.ColumnModel({columns:[{id:"name",header:_T("common","owner"),dataIndex:"name",renderer:t},{id:"description",header:_T("user","user_fullname"),dataIndex:"description",renderer:t}]}),listeners:{scope:this,beforedestroy:function(){this.btntask.cancel()},rowdblclick:function(e,t,i){this.EditHandler()},containercontextmenu:function(e,t){this.showMenu(e,t)},rowcontextmenu:function(e,t,i){e.getSelectionModel().selectRow(t,this.getSelectionModel().isSelected(t)),this.showMenu(e,i)}},tbar:this.createToolbar()},this.callParent([e])},createActionGroup:function(){var e=new Ext.Action({text:_T("common","add"),itemId:"add",handler:this.createHandler,scope:this}),t=new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",disabled:!0,handler:this.EditHandler,scope:this}),i=new Ext.Action({text:_T("common","delete"),itemId:"delete",disabled:!0,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",handler:this.deleteHandler,scope:this});return new SYNO.ux.Utils.ActionGroup([e,t,i])},createToolbar:function(){var e=this.actionGroup.getArray();return new Ext.Toolbar({defaultType:"syno_button",items:e})},showMenu:function(e,t){var i=this.actionGroup.getArray();new SYNO.ux.Menu({autoDestroy:!0,items:i}).showAt(t.getXY()),t.preventDefault()},createStore:function(){return new Ext.data.JsonStore({autoLoad:!1,fields:["name","description"]})},updateActionCB:function(){var e=this.getSelectionModel().getSelections();if(0>=e.length)return this.actionGroup.disable("edit"),void this.actionGroup.disable("delete");_S("demo_mode")||this.actionGroup.enable("delete"),1===e.length?this.actionGroup.enable("edit"):this.actionGroup.disable("edit")},createHandler:function(){new SYNO.SDS.AdminCenter.FileService.Rsync.CreateAccountDialog({owner:this.owner,module:this,title:_T("common","add"),isEdit:!1,old_name:"",password:"",confirmpassword:""}).open()},EditHandler:function(){var e=this.getSelectionModel().getSelections();Ext.isArray(e)&&1===e.length&&new SYNO.SDS.AdminCenter.FileService.Rsync.CreateAccountDialog({owner:this.owner,module:this,title:_T("common","alt_edit"),isEdit:!0,old_name:e[0].json.name,password:"12345678",confirmpassword:"87654321"}).open()},deleteHandler:function(){this.owner.getMsgBox().confirmDelete(_T("service","rsync_account"),_T("service","delete_check_rsync_account"),this.deleteBtnCB,this)},deleteBtnCB:function(e){var t=this.getSelectionModel().getSelections(),i=[];if("yes"==e&&!(0>=t.length)){for(var s=0;s<t.length;s++)i.push(t[s].json.name);this.owner.getEl().mask(),this.sendWebAPI({api:"SYNO.Core.FileServ.Rsync.Account",version:1,method:"delete",params:{name_list:i},scope:this,callback:this.onDeleteDone})}},onDeleteDone:function(e,t,i){this.owner.getEl().isMasked()&&this.owner.getEl().unmask(),e?this.owner.load():this.errorHandling(t)},errorHandling:function(e){var t=SYNO.API.Response.GetFirstError(e),i=_T("common","commfail");SYNO.API.Errors.core[t.code]&&(i=SYNO.API.Errors.core[t.code]),this.owner.getMsgBox().alert(this.owner.title,i)}}),Ext.define("SYNO.SDS.AdminCenter.FileService.Rsync.CreateAccountDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.isEdit=e.isEdit,Ext.apply(this,e||{});var t=this.fillConfig(e);this.callParent([t]),this.defineBehaviors()},fillConfig:function(e){var t={width:560,height:245,resizable:!1,collapsible:!1,autoScroll:!1,constrainHeader:!0,layout:"fit",items:[this.initFormConfig(e)],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),handler:this.onCloseHandler,scope:this},{btnStyle:"blue",text:_T("common","ok"),handler:this.Apply,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",scope:this}]};return Ext.apply(t,e),t},initFormConfig:function(e){return{xtype:"syno_formpanel",itemId:"fp_account",labelAlign:"left",trackResetOnLoad:!0,waitMsgTarget:!0,border:!1,padding:"0px",labelWidth:190,items:[this.combobox=new SYNO.ux.ComboBox({fieldLabel:_T("common","owner"),labelStyle:"margin-left: 0px; width: 180px;",itemId:"cmb_owner",displayField:"name",valueField:"name",mode:"remote",pageSize:50,autoSelect:!1,editable:!0,width:325,listWidth:325,maxHeight:360,minChars:0,queryParam:"substr",listEmptyText:_T("service","error_invalid_user"),store:new SYNO.API.JsonStore({autoDestroy:!0,api:"SYNO.Core.User",method:"list",version:1,appWindow:this.owner.appWin,baseParams:{type:"all",offset:0,limit:-1},root:"users",totalProperty:"total",id:"name",fields:[{name:"name",sortType:"asNaturalUCString"}],remoteSort:!0,defaultSortable:!0,pruneModifiedRecords:!0,scope:this}),allowBlank:!1,blankText:_T("user","error_noname"),validateOnBlur:!0,validationDelay:250,validationEvent:"keyup",hidden:!!this.isEdit,disabled:!!this.isEdit}),{xtype:"syno_displayfield",fieldLabel:_T("common","owner"),width:325,name:"text_owner",value:e.old_name,hidden:!this.isEdit},{xtype:"syno_textfield",textType:"password",fieldLabel:_T("user","user_passwd"),maxLength:127,width:325,name:"password",value:e.password,startValidate:!1,validator:function(){return!0}},{xtype:"syno_textfield",textType:"password_confirm",fieldLabel:_T("user","user_repswd"),maxLength:127,name:"confirmpassword",value:e.confirmpassword,width:325,confirmFor:"password",validator:function(e){var t=this.ownerCt.getForm().findField(this.confirmFor).getValue();return!!(e===t||this.scope.isEdit&&"12345678"===t&&"87654321"===e)||_T("pppoe","error_password")},scope:this}]}},defineBehaviors:function(){this.form=this.get("fp_account").form},onCloseHandler:function(){this.close()},createAccount:function(){this.sendWebAPI({api:"SYNO.Core.FileServ.Rsync.Account",version:1,method:"create",params:{name:this.combobox.getValue(),password:this.form.findField("password").getValue()},encryption:["password"],callback:this.SaveDone,scope:this})},editAccount:function(){var e={name:this.form.findField("text_owner").getValue(),password:this.form.findField("password").getValue()};this.sendWebAPI({api:"SYNO.Core.FileServ.Rsync.Account",version:1,method:"set",params:e,encryption:["password"],callback:this.SaveDone,scope:this})},Apply:function(){return!!this.form.isValid()&&(this.form.isDirty()?(this.setStatusBusy({text:_T("common","saving")}),void(this.isEdit?this.editAccount():this.createAccount())):(this.close(),!0))},SaveDone:function(e,t,i){this.clearStatusBusy(),e?(this.owner.load(),this.close()):this.errorHandling(t)},errorHandling:function(e){var t=SYNO.API.Response.GetFirstError(e),i=_T("common","commfail");SYNO.API.Errors.core[t.code]&&(i=SYNO.API.Errors.core[t.code]),this.setStatusError({text:i,clear:!0})}}),Ext.ns("SYNO.SDS.S2S"),SYNO.SDS.S2S.JobPollingIntervalSec=3,SYNO.SDS.S2S.BKPSET_MAX_LEN=32,SYNO.SDS.S2S.STATUS_SYNCING="syncing",SYNO.SDS.S2S.STATUS_IDLE="idle",SYNO.SDS.S2S.STATUS_WAITING="waiting",SYNO.SDS.S2S.LAST_RESULT_SUCC="succeed",SYNO.SDS.S2S.LAST_RESULT_ERR="error",SYNO.SDS.S2S.LAST_RESULT_CANCEL="cancel",SYNO.SDS.S2S.LAST_RESULT_PARTIAL="partial",SYNO.SDS.S2S.LAST_RESULT_NA="NA",SYNO.SDS.S2S.SCHD_REALTIME="realtime",SYNO.SDS.S2S.SCHD_MANUAL="manual",SYNO.SDS.S2S.SCHD_ADVANCE="advance",SYNO.SDS.S2S.SCHE_WEEKLY="weekly",SYNO.SDS.S2S.SCHE_MONTHLY="monthly",SYNO.SDS.S2S.SCHE_YEARLY="yearly",SYNO.SDS.S2S.SCHE_ONCE="once",SYNO.SDS.S2S.FIELD_ID="id",SYNO.SDS.S2S.FIELD_SHARE="sync_shares",SYNO.SDS.S2S.FIELD_SERVER="additional.server",SYNO.SDS.S2S.FIELD_STATUS="additional.status",SYNO.SDS.S2S.FIELD_RESULT="additional.last_sync_result",SYNO.SDS.S2S.FIELD_SCHD="additional.schedule",SYNO.SDS.S2S.RADIO_BY_WEEK="by_week",SYNO.SDS.S2S.RADIO_BY_DATE="by_date",SYNO.SDS.S2S.WEEK_ALL="1111111",SYNO.SDS.S2S.WEEK_END="1000001",SYNO.SDS.S2S.WEEK_NORMAL="0111110",SYNO.SDS.S2S.ACTION_EDIT="edit",SYNO.SDS.S2S.ACTION_DELETE="delete",SYNO.SDS.S2S.ACTION_CANCEL="cancel",SYNO.SDS.S2S.ACTION_SYNC_NOW="sync_now",SYNO.SDS.S2S.ACTION_SYNC_FULL="sync_full",SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_TYPE=401,SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_VALUE=402,SYNO.SDS.S2S.ERRCODE_NO_MEM=403,SYNO.SDS.S2S.ERRCODE_ALLOC_MEM=404,SYNO.SDS.S2S.ERRCODE_NO_SUCH_SHARE=405,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GENERIC=500,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_ENUM_JOB=501,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GET_JOB=502,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_SET_JOB=503,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_DEL_JOB=504,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_START_JOB=505,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_STOP_JOB=506,SYNO.SDS.S2S.ERRCODE_NO_SUCH_TASK=507,SYNO.SDS.S2S.ERRCODE_DUPLICATED_JOB_ID=508,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_UPDATE_FAKE_FILE=509,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_TEST_CONN=510,SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_PAIR=511,SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GENERIC=600,SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_STATUS=601,SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ALIVE=602,SYNO.SDS.S2S.ERRCODE_CUSTOMIZED_RSYNC_ENABLED=603,SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ENABLED=604,SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_NETBKP_SETTING=605,SYNO.SDS.S2S.ERRCODE_SERVER_ERR_NO_NETBKP_VOLUME=606,SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_VOLUME_PATH=607,SYNO.SDS.S2S.ERRCODE_SERVER_ERR_REGISTER_SERVICE=608,SYNO.SDS.S2S.ERRCODE_SERVER_ERR_UNREGISTER_SERVICE=609,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GENERIC=700,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_CONFIG_FILE=701,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_STATUS=702,SYNO.SDS.S2S.ERRCODE_NO_CONFIG=703,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_OPEN_SEMAPHORE=704,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_CONFIG=705,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_CONFIG=706,SYNO.SDS.S2S.ERRCODE_CONFIG_EMPTY=707,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_ADD_SECTION=708,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_SECTION=709,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_SECTION=710,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_HASH_VALUE=711,SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_HASH_VALUE=712,SYNO.SDS.S2S.ERRCODE_SHARE_LOCK=3328,SYNO.SDS.S2S.ScheduleDateToString=function(e,t){var i="",s=e.week_day;if(i+=_T("schedule","schedule_date")+": ",t===SYNO.SDS.S2S.SCHE_WEEKLY)switch(s){case SYNO.SDS.S2S.WEEK_ALL:i+=_T("schedule","schedule_daily");break;case SYNO.SDS.S2S.WEEK_END:i+=_T("schedule","schedule_weekend");break;case SYNO.SDS.S2S.WEEK_NORMAL:i+=_T("schedule","schedule_weekdays");break;default:i+=SYNO.SDS.S2S.GenWeekString(s)}else{var n=new Date(e.start_year,e.start_month-1,e.start_day);switch(i+=SYNO.SDS.DateTimeFormatter(n,{type:"date"}),i+=" ",t){case SYNO.SDS.S2S.SCHE_MONTHLY:i+=_T("schedule","repeat_monthly");break;case SYNO.SDS.S2S.SCHE_YEARLY:i+=_T("schedule","repeat_yearly");break;case SYNO.SDS.S2S.SCHE_ONCE:i+=_T("schedule","no_repeat");break;default:i+=_T("schedule","schedule_unknown")}}return i},SYNO.SDS.S2S.WeekArray=[_T("schedule","schedule_sun"),_T("schedule","schedule_mon"),_T("schedule","schedule_tue"),_T("schedule","schedule_wed"),_T("schedule","schedule_thu"),_T("schedule","schedule_fri"),_T("schedule","schedule_sat")],SYNO.SDS.S2S.GenWeekString=function(e){var t=0,i=[];for(t=0;t<SYNO.SDS.S2S.WeekArray.length;t++)"1"===e.charAt(t)&&i.push(SYNO.SDS.S2S.WeekArray[t]);return i.join(",")},SYNO.SDS.S2S.GetFormattedTimeStr=function(e,t){var i=new Date(1970,1,1,e,t);return SYNO.SDS.DateTimeFormatter(i,{type:"time"})},SYNO.SDS.S2S.ScheduleTimeToString=function(e){var t="",i=(60*e.repeat_hour+e.repeat_min)*e.repeat_in_day,s=e.first_hour+Math.floor((e.first_min+i)/60),n=(e.first_min+i)%60;return t+=_T("schedule","schedule_time")+": ",0===i?t+=SYNO.SDS.S2S.GetFormattedTimeStr(e.first_hour,e.first_min):(t+=SYNO.SDS.S2S.GetFormattedTimeStr(e.first_hour,e.first_min)+" ~ "+SYNO.SDS.S2S.GetFormattedTimeStr(s,n),t+=" ",0===e.repeat_hour?t+=String.format(_T("s2s","s2s_lbl_sched_every_min"),e.repeat_min):t+=String.format(_T("s2s","s2s_lbl_sched_mode_every"),e.repeat_hour)),t},SYNO.SDS.S2S.handleWebApiData=function(e,t,i,s){var n=!1,o=[];if(!Ext.isObject(t)||!Ext.isFunction(i))return!1;Ext.isArray(e)?o=e:o.push(e);for(var a=0;a<o.length&&(!SYNO.ux.Utils.checkApiConsistency(t,o[a])||(n=!0,i.call(s||this,o[a],a)));a++);return n||i.call(s||this,null,-1),!0},SYNO.SDS.S2S.GetFakePswd=function(){var e,t="";for(e=0;e<8;e++)t+=String.fromCharCode(65283);return t},SYNO.SDS.S2S.TestConnection=function(e,t,i,s){e.setStatusBusy({text:_T("netbackup","netbkp_connection_testing")}),e.sendWebAPI({api:"SYNO.S2S.Client.Job",version:1,method:"test_connection",encryption:["password"],params:t,callback:function(e,t,n,o){this.clearStatusBusy(),i.call(s||this,e,t,n,o)},scope:e})},SYNO.SDS.S2S.TestConnectionCallBack=function(e,t,i,s){e?this.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("netbackup","netbkp_connection_testing_success")):this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:t},_T("netbackup","netbkp_connection_testing_fail")))},SYNO.SDS.S2S.GetWebAPIErrorString=function(e,t){if(!e||!e.error)return t||_T("common","error_system");if(e.error.errors)return _T(e.error.errors.sec,e.error.errors.key);switch(e.error.code){case SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_TYPE:return _T("s2s","err_invalid_param_type");case SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_VALUE:return _T("s2s","err_invalid_param_value");case SYNO.SDS.S2S.ERRCODE_NO_MEM:return _T("s2s","err_no_mem");case SYNO.SDS.S2S.ERRCODE_ALLOC_MEM:return _T("s2s","err_alloc_mem");case SYNO.SDS.S2S.ERRCODE_NO_SUCH_SHARE:return _T("s2s","s2s_warn_no_share");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GENERIC:return _T("s2s","err_client_job_generic");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_ENUM_JOB:return _T("s2s","err_client_job_enum_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GET_JOB:return _T("s2s","err_client_job_get_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_SET_JOB:return _T("s2s","err_client_job_set_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_DEL_JOB:return _T("s2s","err_client_job_del_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_START_JOB:return _T("s2s","err_client_job_start_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_STOP_JOB:return _T("s2s","err_client_job_stop_job");case SYNO.SDS.S2S.ERRCODE_NO_SUCH_TASK:return _T("s2s","err_no_task");case SYNO.SDS.S2S.ERRCODE_DUPLICATED_JOB_ID:return _T("s2s","s2s_warn_duplicate_taskname");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_UPDATE_FAKE_FILE:return _T("s2s","err_client_job_update_fake_file");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_TEST_CONN:return _T("netbackup","netbkp_connection_testing_fail");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_PAIR:return _T("s2s","err_client_job_pair");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GENERIC:return _T("s2s","err_server_generic");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_STATUS:return _T("s2s","err_server_get_status");case SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ALIVE:return String.format(_T("s2s","s2s_warn_should_start_bkp_service"),_T("s2s","s2s_app_title"),_T("netbackup","netbkp_main_subject"),_T("netbackup","netbkp_main_subject"));case SYNO.SDS.S2S.ERRCODE_CUSTOMIZED_RSYNC_ENABLED:return String.format(_T("s2s","s2s_warn_should_start_synorsync_server"),_T("s2s","s2s_app_title"));case SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ENABLED:return String.format(_T("s2s","s2s_warn_should_start_bkp_service"),_T("s2s","s2s_app_title"),_T("netbackup","netbkp_main_subject"),_T("netbackup","netbkp_main_subject"));case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_NETBKP_SETTING:return _T("s2s","err_server_get_netbkp_setting");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_NO_NETBKP_VOLUME:return _T("share","error_volume_not_found");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_VOLUME_PATH:return _T("s2s","err_server_get_volume_path");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_REGISTER_SERVICE:return String.format(_T("s2s","err_server_register_service"),_T("s2s","s2s_app_title"));case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_UNREGISTER_SERVICE:return String.format(_T("s2s","err_server_unregister_service"),_T("s2s","s2s_app_title"));case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GENERIC:return _T("s2s","err_pair_generic");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_CONFIG_FILE:return _T("s2s","err_pair_config_file");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_STATUS:return _T("s2s","err_pair_get_status");case SYNO.SDS.S2S.ERRCODE_NO_CONFIG:return _T("s2s","err_pair_no_config");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_OPEN_SEMAPHORE:return _T("s2s","err_pair_get_open_semaphore");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_CONFIG:return _T("s2s","err_pair_get_config");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_CONFIG:return _T("s2s","err_pair_set_config");case SYNO.SDS.S2S.ERRCODE_CONFIG_EMPTY:return _T("s2s","err_pair_empty_config");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_ADD_SECTION:return _T("s2s","err_pair_add_section");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_SECTION:return _T("s2s","err_pair_get_section");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_SECTION:return _T("s2s","err_pair_set_section");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_HASH_VALUE:return _T("s2s","err_pair_get_hash_value");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_HASH_VALUE:return _T("s2s","err_pair_set_hash_value");case SYNO.SDS.S2S.ERRCODE_SHARE_LOCK:return _T("s2s","err_share_action");case void 0:return t||_T("common","error_system");default:return t||_T("s2s","err_unexpected_error")}},SYNO.SDS.S2S.SyncShareRenderer=function(e,t,i){return null!==t&&(t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e.join(","))+'"'),e},SYNO.SDS.S2S.DestinationRenderer=function(e,t,i){return e.name},SYNO.SDS.S2S.CurStatusRenderer=function(e,t,i){switch(e){case SYNO.SDS.S2S.STATUS_SYNCING:return _T("s2s","s2s_lbl_status_sync");case SYNO.SDS.S2S.STATUS_WAITING:return _T("s2s","s2s_lbl_status_waiting");default:return _T("s2s","s2s_lbl_status_idle")}},SYNO.SDS.S2S.LastResultRenderer=function(e,t,i){var s;let n,o;switch(e){case SYNO.SDS.S2S.LAST_RESULT_SUCC:s=_T("usbbackup","usbbkp_succeed");break;case SYNO.SDS.S2S.LAST_RESULT_ERR:s='<span class="red-status">'+_T("s2s","task_status_error")+"</span>";break;case SYNO.SDS.S2S.LAST_RESULT_PARTIAL:n=Ext.id(),o=String.format(_T("s2s","err_partial_success_reason"),('<a href="#" id="'+n+'" role="link" style="cursor:pointer" class="link-font">').replace(/"/g,"&apos;"),"</a>"),s='<span class="orange-status">'+_T("s2s","err_partial_success")+"</span>",s+=String.format('<div ext:wtip="{0}" class="syno-ux-whitetip-icon"></div>',o),this.partialFilesLink[n]=i.data.id;break;case SYNO.SDS.S2S.LAST_RESULT_CANCEL:s=_T("common","alt_cancel");break;default:s=_T("status","status_not_available")}return s},SYNO.SDS.S2S.ScheduleRenderer=function(e,t,i){switch(e.mode){case SYNO.SDS.S2S.SCHD_REALTIME:return _T("s2s","s2s_lbl_sched_realtime");case SYNO.SDS.S2S.SCHD_MANUAL:return _T("s2s","s2s_lbl_sched_mode_man");default:var s=SYNO.SDS.S2S.ScheduleDateToString(e,e.mode);return s+="<br />",s+=SYNO.SDS.S2S.ScheduleTimeToString(e),null!==t&&(t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(s)+'"'),_T("schedule","schedule_advance")}},SYNO.SDS.S2S.GenGetJobParams=function(e){return{api:"SYNO.S2S.Client.Job",version:1,method:"get",params:{id:e,additional:["schedule","server","use_block","use_compression","use_ssh","ssh_port","user","rsync_timeout","sync_remote_mount"]}}},SYNO.SDS.S2S.GenListJobParams=function(e){return Ext.apply({api:"SYNO.S2S.Client.Job",version:1,method:"list"},e)},SYNO.SDS.S2S.GenGetShareParams=function(e){return Ext.apply({api:"SYNO.Core.Share",version:1,method:"list",params:{shareType:["local","enc","dec","cluster","cold_storage"],additional:["enable_share_tiering","is_tiering_bucket"]}},e)},SYNO.SDS.S2S.IsTieringShare=function(e){return e.enable_share_tiering||e.is_tiering_bucket},SYNO.SDS.S2S.GenRunActionParamsByAction=function(e,t){var i={api:"SYNO.S2S.Client.Job",params:{id:t}};switch(e){case SYNO.SDS.S2S.ACTION_SYNC_NOW:i.version=1,i.method="start",i.params.sync_mode="normal";break;case SYNO.SDS.S2S.ACTION_SYNC_FULL:i.version=1,i.method="start",i.params.sync_mode="full_sync";break;case SYNO.SDS.S2S.ACTION_DELETE:i.version=1,i.method="delete";break;case SYNO.SDS.S2S.ACTION_CANCEL:i.version=1,i.method="stop";break;default:return void SYNO.Debug("SYNO.SDS.S2S.S2SaskPage: unknown action ["+e+"]")}return i},SYNO.SDS.S2S.GenGetNetworkParams=function(e){return Ext.apply({api:"SYNO.Core.System",version:1,method:"info",params:{type:"network"}},e)},SYNO.SDS.S2S.GenCreateJobParams=function(e){return Ext.apply({api:"SYNO.S2S.Client.Job",version:1,method:"create",encryption:["password"]},e)},SYNO.SDS.S2S.GenSetJobParams=function(e){return Ext.apply({api:"SYNO.S2S.Client.Job",version:1,method:"set",encryption:["password"]},e)},SYNO.SDS.S2S.GenListServerParams=function(e){return Ext.apply({api:"SYNO.S2S.Client",version:1,method:"list_server",params:{sort_by:"name"}},e)},SYNO.SDS.S2S.GenGetServerParams=function(e){return Ext.apply({api:"SYNO.S2S.Server",version:1,method:"get"},e)},SYNO.SDS.S2S.GenListPairParams=function(e){return Ext.apply({api:"SYNO.S2S.Server.Pair",version:1,method:"list",params:{additional:["sync_shares"]}},e)},SYNO.SDS.S2S.GenDelPairParams=function(e){return Ext.apply({api:"SYNO.S2S.Server.Pair",version:1,method:"delete"},e)},Ext.define("SYNO.SDS.S2S.ClientDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({width:900,minWidth:720,height:300,minHeight:300,title:_T("s2s","s2s_btn_client_task_list"),layout:{type:"fit"},items:[this.jobGrid=new SYNO.SDS.S2S.JobGrid({owner:this})],closeAction:"closeHandler",buttons:[{text:_T("common","close"),handler:this.closeHandler,scope:this}]},e)},onShow:function(){return this.jobGrid.onPageActivate()},closeHandler:function(){this.jobGrid.onPageDeactivate(),this.close()}}),Ext.define("SYNO.SDS.S2S.JobGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"activate",(function(e,t){this.applyActionAndReload(null),this.startPollStatus(!1)}),this),this.mon(this,"deactivate",(function(e,t){this.stopPollStatus()}),this)},fillConfig:function(e){this.actionGroup=this.createActionGroup(),this.partialFilesLink={};var t=new SYNO.API.Store({reader:new Ext.data.JsonReader({idProperty:SYNO.SDS.S2S.FIELD_ID,root:"",fields:[{name:SYNO.SDS.S2S.FIELD_ID},{name:SYNO.SDS.S2S.FIELD_SHARE},{name:SYNO.SDS.S2S.FIELD_SERVER,sortType:function(e){return e.name}},{name:SYNO.SDS.S2S.FIELD_STATUS},{name:SYNO.SDS.S2S.FIELD_RESULT},{name:SYNO.SDS.S2S.FIELD_SCHD,sortType:function(e){switch(e.mode){case SYNO.SDS.S2S.SCHD_REALTIME:return _T("s2s","s2s_lbl_sched_realtime");case SYNO.SDS.S2S.SCHD_MANUAL:return _T("s2s","s2s_lbl_sched_mode_man");default:return _T("schedule","schedule_advance")}}}]})});return this.addManagedComponent(t),Ext.apply({store:t,cm:this.getColModel(),tbar:this.toolbar=this.getToolbar(),listeners:{rowdblclick:{scope:this,fn:this.onRowDblClick},containercontextmenu:{scope:this,fn:this.onContainerContextMenu},rowcontextmenu:{scope:this,fn:this.onRowContextMenu}},selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{spacepressed:{scope:this,fn:this.onSpacePress},selectionchange:{scope:this,fn:this.onSelectionChange}}})},e)},startPollStatus:function(e){this.pollStatus||(this.pollStatus=this.pollReg({immediate:e,interval:SYNO.SDS.S2S.JobPollingIntervalSec,webapi:SYNO.SDS.S2S.GenListJobParams({params:{additional:["last_sync_result","server","schedule","status"]}}),status_callback:this.afterRequestJobs,scope:this}))},stopPollStatus:function(){this.pollStatus&&(this.pollUnreg(this.pollStatus),this.pollStatus=null)},getColModel:function(){return this.cm||(this.cm=new Ext.grid.ColumnModel({defaults:{sortable:!0,menuDisabled:!0,align:"center"},columns:[{width:.15,header:_T("s2s","col_task_name"),dataIndex:SYNO.SDS.S2S.FIELD_ID},{width:.15,header:_T("s2s","s2s_lbl_src_share"),dataIndex:SYNO.SDS.S2S.FIELD_SHARE,renderer:SYNO.SDS.S2S.SyncShareRenderer},{width:.15,header:_T("s2s","col_task_destination"),dataIndex:SYNO.SDS.S2S.FIELD_SERVER,renderer:SYNO.SDS.S2S.DestinationRenderer},{width:.1,header:_T("s2s","col_task_status"),dataIndex:SYNO.SDS.S2S.FIELD_STATUS,renderer:SYNO.SDS.S2S.CurStatusRenderer},{width:.2,header:_T("s2s","s2s_lbl_lastSync_result"),dataIndex:SYNO.SDS.S2S.FIELD_RESULT,renderer:SYNO.SDS.S2S.LastResultRenderer.createDelegate(this)},{width:.15,header:_T("s2s","s2s_lbl_sched_mode"),dataIndex:SYNO.SDS.S2S.FIELD_SCHD,renderer:SYNO.SDS.S2S.ScheduleRenderer}]})),this.cm},createActionGroup:function(){var e=function(e){return new Ext.Action(Ext.apply({disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""},e))},t=e({text:_T("common","create"),itemId:"create",handler:this.onCreateJob,scope:this}),i=e({itemId:"edit",disabled:!0,text:_T("common","alt_edit"),handler:this.onEditJob,scope:this}),s=e({itemId:"remove",disabled:!0,text:_T("common","delete"),handler:function(e,t){this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("common","remove_cfrmrmv"),(function(e){"yes"===e&&this.applyActionAndReload(SYNO.SDS.S2S.ACTION_DELETE)}),this)},scope:this}),n=e({itemId:"cancel",disabled:!0,text:_T("netbackup","netbkp_cancel"),handler:function(e,t){this.applyActionAndReload(SYNO.SDS.S2S.ACTION_CANCEL)},scope:this}),o=e({itemId:"sync_now",disabled:!0,text:_T("s2s","s2s_btn_sync_imm"),handler:function(e,t){this.applyActionAndReload(SYNO.SDS.S2S.ACTION_SYNC_NOW)},scope:this}),a=e({itemId:"sync_all",disabled:!0,text:_T("s2s","s2s_btn_full_sync"),handler:function(e,t){this.applyActionAndReload(SYNO.SDS.S2S.ACTION_SYNC_FULL)},scope:this});return new SYNO.ux.Utils.ActionGroup([t,i,s,n,o,a])},getToolbar:function(){var e=this.actionGroup.getArray();return new Ext.Toolbar({defaultType:"syno_button",items:e})},onPageActivate:function(){return this.startPollStatus(!0),!0},onPageDeactivate:function(){return this.stopPollStatus(),!0},onCreateJob:function(e,t){var i=this.getStore().getCount(),s=_D("s2s_task_max","2");if(i>=(s=parseInt(s,10)))this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_reach_maxtask"));else{this.stopPollStatus();var n=new SYNO.SDS.S2S.NewJobWizard({module:this.module,appWin:this.appWin,owner:this.owner});this.mon(n,"close",(function(e){this.applyActionAndReload(),this.startPollStatus(!1)}),this),n.open()}},onEditJob:function(e,t){var i=this.getSelectionModel().getSelected();if(i){this.stopPollStatus();var s=new SYNO.SDS.S2S.ConfigDialog({owner:this.owner,jobId:i.get(SYNO.SDS.S2S.FIELD_ID)});this.mon(s,"close",(function(e){this.applyActionAndReload(),this.startPollStatus(!1)}),this),s.open()}},afterRequestJobs:function(e,t,i,s){e&&t&&Ext.isArray(t.jobs)||(SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.afterRequestJobs: get job list fail"),t={jobs:[]}),this.owner.clearStatusBusy();var n=t.jobs.length,o=this.getStore(),a=!1;if(o.getTotalCount()!==n)a=!0;else for(var r=0;n>r;r++){var l=o.getById(t.jobs[r][SYNO.SDS.S2S.FIELD_ID]);if(!l){a=!0;break}l.set(SYNO.SDS.S2S.FIELD_SHARE,t.jobs[r].sync_shares),l.set(SYNO.SDS.S2S.FIELD_SERVER,t.jobs[r].additional.server),l.set(SYNO.SDS.S2S.FIELD_STATUS,t.jobs[r].additional.status),l.set(SYNO.SDS.S2S.FIELD_RESULT,t.jobs[r].additional.last_sync_result),l.set(SYNO.SDS.S2S.FIELD_SCHD,t.jobs[r].additional.schedule)}a?o.loadData(t.jobs,!1):o.commitChanges(),this.onSelectionChange(this.getSelectionModel()),Object.keys(this.partialFilesLink).forEach((e=>{Ext.get(e)&&this.mon(Ext.get(e),"click",(function(){synowebapi.download({api:"SYNO.S2S.Client.Job",method:"export_log",version:1,params:{id:this.partialFilesLink[e]}})}),this)}))},onRowContextMenu:function(e,t,i){e.getSelectionModel().selectRow(t,this.getSelectionModel().isSelected(t)),this.onContainerContextMenu(e,i)},onContainerContextMenu:function(e,t){var i=this.actionGroup.getArray();new SYNO.ux.Menu({autoDestroy:!0,items:i}).showAt(t.getXY()),t.preventDefault()},onRowDblClick:function(e){this.onSpacePress({grid:e})},onSpacePress:function(e){var t=e.grid.getSelectionModel().getSelections();t&&1==t.length&&this.isJobCan(SYNO.SDS.S2S.ACTION_EDIT,t[0].get(SYNO.SDS.S2S.FIELD_STATUS))&&this.onEditJob()},onSelectionChange:function(e){var t=e.getSelections(),i={edit:!0,remove:!0,cancel:!0,sync_now:!0,sync_all:!0};if(!_S("demo_mode")&&t){1===t.length&&this.isJobCan(SYNO.SDS.S2S.ACTION_EDIT,t[0].get(SYNO.SDS.S2S.FIELD_STATUS))&&(i.edit=!1);for(var s=0;t.length>s;s++){var n=t[s].get(SYNO.SDS.S2S.FIELD_STATUS);if(this.isJobCan(SYNO.SDS.S2S.ACTION_DELETE,n)&&(i.remove=!1),this.isJobCan(SYNO.SDS.S2S.ACTION_CANCEL,n)&&(i.cancel=!1),this.isJobCan(SYNO.SDS.S2S.ACTION_SYNC_NOW,n)){var o=t[s].get(SYNO.SDS.S2S.FIELD_SCHD).mode;SYNO.SDS.S2S.SCHD_REALTIME!==o&&(i.sync_now=!1)}this.isJobCan(SYNO.SDS.S2S.ACTION_SYNC_FULL,n)&&(i.sync_all=!1)}for(var a in i)i.hasOwnProperty(a)&&(i[a]?this.actionGroup.disable(a):this.actionGroup.enable(a))}},isJobCan:function(e,t){switch(e){case SYNO.SDS.S2S.ACTION_EDIT:case SYNO.SDS.S2S.ACTION_SYNC_NOW:case SYNO.SDS.S2S.ACTION_SYNC_FULL:return t!==SYNO.SDS.S2S.STATUS_SYNCING;case SYNO.SDS.S2S.ACTION_CANCEL:return t===SYNO.SDS.S2S.STATUS_SYNCING;case SYNO.SDS.S2S.ACTION_DELETE:return!0;default:return!1}},applyActionAndReload:function(e){var t,i=SYNO.SDS.S2S.GenListJobParams({params:{additional:["last_sync_result","server","schedule","status"]}}),s=[i];if(e){var n=this.getSelectionModel().getSelections(),o=this.getValidJobIdsByAction(e,n);(t=SYNO.SDS.S2S.GenRunActionParamsByAction(e,o))&&s.unshift(t)}this.owner.setStatusBusy(),this.stopPollStatus(),this.sendWebAPI({compound:{stopwhenerror:!1,params:s},callback:function(e,s,n,o){if(this.owner.clearStatusBusy(),this.startPollStatus(!1),!e||!s)return SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyActionAndReload: sendWebAPI fail"),void this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));SYNO.SDS.S2S.handleWebApiData(s.result,t,(function(e,t){e&&(e.success||(SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyActionAndReload: command "+e.method+" fail"),this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString(e))))}),this),SYNO.SDS.S2S.handleWebApiData(s.result,i,(function(e,t){e?this.afterRequestJobs(e.success,e.data):SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyActionAndReload: no list job result")}),this)},scope:this})},getValidJobIdsByAction:function(e,t){var i=[];if(t)e:for(var s=0;t.length>s;s++){var n=t[s].get(SYNO.SDS.S2S.FIELD_STATUS),o=t[s].get(SYNO.SDS.S2S.FIELD_SCHD).mode;switch(e){case SYNO.SDS.S2S.ACTION_SYNC_NOW:if(SYNO.SDS.S2S.STATUS_IDLE!==n||SYNO.SDS.S2S.SCHD_REALTIME===o)continue;break;case SYNO.SDS.S2S.ACTION_SYNC_FULL:if(SYNO.SDS.S2S.STATUS_IDLE!==n)continue;break;case SYNO.SDS.S2S.ACTION_DELETE:break;case SYNO.SDS.S2S.ACTION_CANCEL:if(SYNO.SDS.S2S.STATUS_SYNCING!==n)continue;break;default:SYNO.Debug("SYNO.SDS.S2S.S2SaskPage: unknown btn pressed");break e}i.push(t[s].get(SYNO.SDS.S2S.FIELD_ID))}return i}}),Ext.define("SYNO.SDS.S2S.PairDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",(function(e){this.setStatusBusy(),this.sendWebAPI(SYNO.SDS.S2S.GenListPairParams({callback:this.afterRequestPairs,scope:this}))}),this,{single:this})},fillConfig:function(e){return Ext.apply({width:500,height:320,padding:15,title:_T("s2s","s2s_dlg_pairinfo_title"),layout:{type:"fit"},items:[this.pairGrid=this.createGridPanel(e)],buttons:[{text:_T("common","close"),handler:function(){this.close()},scope:this}]},e)},createGridPanel:function(e){return new SYNO.ux.GridPanel({border:!1,store:this.createPairStore(),autoExpandColumn:"descr",columns:[{menuDisabled:!0,sortable:!1,width:200,header:_T("s2s","s2s_col_sharename"),dataIndex:"share"},{id:"descr",menuDisabled:!0,sortable:!1,width:150,header:_T("s2s","s2s_col_pairedclient"),dataIndex:"display",renderer:Ext.util.Format.htmlEncode}],tbar:{xtype:"toolbar",items:[{xtype:"syno_button",id:this.resetBtnId=Ext.id(),disabled:!0,text:_T("s2s","s2s_btn_unlink"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",handler:this.onResetBtnClick,scope:this}]},selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:{fn:function(e){_S("demo_mode")||(0===e.getSelections().length?Ext.getCmp(this.resetBtnId).disable():Ext.getCmp(this.resetBtnId).enable())},scope:this}}})})},createPairStore:function(){var e=new SYNO.API.JsonStore({root:"",fields:[{name:"client_id"},{name:"client_name"},{name:"share"},{name:"display"}]});return this.addManagedComponent(e),e},afterRequestPairs:function(e,t,i,s){if(this.clearStatusBusy(),!e||!t||!Ext.isArray(t.clients))return SYNO.Debug("SYNO.SDS.S2S.S2STaskPage: get clients fail"),void this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:t}));for(var n=t.clients,o=[],a=0;n.length>a;a++)for(var r=n[a].additional.sync_shares,l=0;r.length>l;l++)o.push({client_id:n[a].id,client_name:n[a].name,share:r[l],display:n[a].name+" \\ "+r[l]});this.pairGrid.getStore().loadData(o)},onResetBtnClick:function(){var e=this.pairGrid.getSelectionModel().getSelections(),t=[];Ext.each(e,(function(e,i,s){t.push(e.get("share"))}),this),this.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_cfm_reset_sharepair"),(function(e){"yes"===e&&this.applyDeletePairByShareName(t)}),this)},applyDeletePairByShareName:function(e){var t=SYNO.SDS.S2S.GenListPairParams(),i=SYNO.SDS.S2S.GenDelPairParams({params:{id_type:"sync_share",id:e}});this.setStatusBusy({text:_T("common","reset")}),this.sendWebAPI({compound:{stopwhenerror:!0,params:[i,t]},callback:function(e,s,n,o){var a=!1;if(this.clearStatusBusy(),!e||!s)return SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyDeletePairByShareName: sendWebAPI fail"),void this.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));SYNO.SDS.S2S.handleWebApiData(s.result,i,(function(e,t){if(!e||!e.success)return SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyDeletePairByShareName: deletePairWebAPI fail"),void(a=SYNO.SDS.S2S.GetWebAPIErrorString(e))}),this),SYNO.SDS.S2S.handleWebApiData(s.result,t,(function(e,t){if(!e)return SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyDeletePairByShareName: listPairWebAPI fail"),void(a=SYNO.SDS.S2S.GetWebAPIErrorString(e));this.afterRequestPairs(e.success,e.data)}),this),a&&this.getMsgBox().alert(_T("s2s","s2s_app_title"),a)},scope:this})}}),Ext.define("SYNO.SDS.S2S.NewJobWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this.panelDestination,"test_connection",this.onTestConnection,this),this.mon(this,"afterlayout",this.requestJobsAndShares,this,{single:!0})},fillConfig:function(e){var t=[this.panelName=new SYNO.SDS.S2S.NamePanel({itemId:"taskname",nextId:"srcShare",header:!1,headline:_T("s2s","s2s_wiz_lbl_create_task"),description:_T("s2s","s2s_wiz_lbl_create_task_name"),owner:this}),this.panelShare=new SYNO.SDS.S2S.SharePanel({itemId:"srcShare",nextId:"destnet",header:!1,headline:_T("s2s","s2s_wiz_lbl_srcShare_select"),description:_T("s2s","s2s_wiz_sub_srcShare_select"),isWizard:!0,owner:this}),this.panelDestination=new SYNO.SDS.S2S.DestinationPanel({itemId:"destnet",nextId:"schedule",header:!1,headline:_T("s2s","s2s_wiz_lbl_set_dest"),description:_T("s2s","s2s_wiz_sub_set_dest"),owner:this}),this.panelSchedule=new SYNO.SDS.S2S.SchdPanel({itemId:"schedule",nextId:"summary",header:!1,headline:_T("s2s","s2s_wiz_lbl_setSched_title"),description:_T("s2s","s2s_wiz_sub_setSched"),owner:this}),this.panelOverview=new SYNO.SDS.S2S.OverviewPanel({itemId:"summary",nextId:null,header:!1,headline:_T("s2s","s2s_wiz_lbl_summary"),description:_T("wizcommon","summary_descr"),owner:this,getNext:function(){return this.owner.applyNewJob(),!1}})];return Ext.apply({title:_T("s2s","s2s_wiz_title"),width:600,height:560,steps:t},e)},onTestConnection:function(e){var t=e.getValues();t.sync_shares=this.panelShare.getSelectedShares(),SYNO.SDS.S2S.TestConnection(this,t,SYNO.SDS.S2S.TestConnectionCallBack,this)},requestJobsAndShares:function(){var e=SYNO.SDS.S2S.GenListJobParams(),t=SYNO.SDS.S2S.GenGetShareParams(),i=SYNO.SDS.S2S.GenGetNetworkParams();this.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:[e,t,i]},callback:function(s,n,o,a){var r=!1;if(this.clearStatusBusy(),!s||!n)return SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: sendWebAPI fail"),void this.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"),(function(){this.close()}),this);SYNO.SDS.S2S.handleWebApiData(n.result,e,(function(e,t){if(!e||!e.data)return SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: listJobWebAPI fail"),void(r=SYNO.SDS.S2S.GetWebAPIErrorString(e));this.panelName.initUniqueId(e.data.jobs)}),this),SYNO.SDS.S2S.handleWebApiData(n.result,t,(function(e,t){var i;if(!e||!e.data)return SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: getShareWebAPI fail"),void(r=SYNO.SDS.S2S.GetWebAPIErrorString(e));let s=(null==e||null===(i=e.data)||void 0===i?void 0:i.shares)??[];s=s.filter((e=>!SYNO.SDS.S2S.IsTieringShare(e))),this.panelShare.setValues(s,[])}),this),SYNO.SDS.S2S.handleWebApiData(n.result,i,(function(e,t){if(!e||!e.data)return SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: request network fail"),void(r=SYNO.SDS.S2S.GetWebAPIErrorString(e));var i=[];Ext.each(e.data.nif,(function(e,t,s){i.push(e.addr),Ext.isArray(e.ipv6)&&Ext.each(e.ipv6,(function(e){i.push(e.addr)}))})),i.push(e.data.hostname.toLowerCase()),this.panelDestination.setInvalidDests(i)}),this),r&&this.getMsgBox().alert(_T("s2s","s2s_app_title"),r,(function(){this.close()}),this)},scope:this})},applyNewJob:function(){var e={};Ext.apply(e,this.panelName.getForm().getValues()),Ext.apply(e,this.panelShare.getValues()),Ext.apply(e,this.panelDestination.getValues()),Ext.apply(e,this.panelSchedule.getValues()),this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI(SYNO.SDS.S2S.GenCreateJobParams({params:e,callback:function(e,t,i,s){this.clearStatusBusy(),e?this.close():this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:t}))},scope:this}))}}),Ext.define("SYNO.SDS.S2S.ConfigDialog",{extend:"SYNO.SDS.ModalWindow",applyBtnId:void 0,constructor:function(e){this.jobId=e.jobId;var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",this.requestJobConfAndShares,this,{single:!0}),this.mon(this.panelDestination,"test_connection",this.onTestConnection,this),this.mon(this.panelDestination,"destination_change",this.onDestinationChange,this)},fillConfig:function(e){var t=[this.panelShare=new SYNO.SDS.S2S.SharePanel({checkConfirmRename:!0,header:!1,title:_T("s2s","s2s_lbl_src_share"),headline:_T("s2s","s2s_wiz_lbl_srcShare_select"),description:_T("s2s","s2s_wiz_sub_srcShare_select"),cls:"s2s-edit",isWizard:!1,owner:this}),this.panelDestination=new SYNO.SDS.S2S.DestinationPanel({header:!1,title:_T("s2s","tab_destination"),headline:_T("s2s","s2s_wiz_lbl_set_dest"),description:_T("s2s","s2s_wiz_sub_set_dest"),owner:this}),this.panelSchedule=new SYNO.SDS.S2S.SchdPanel({header:!1,title:_T("s2s","s2s_wiz_lbl_schedule"),headline:_T("s2s","s2s_wiz_lbl_setSched_title"),description:_T("s2s","s2s_wiz_sub_setSched"),owner:this})];return Ext.apply({width:600,height:540,padding:15,title:_T("common","alt_edit"),layout:{type:"fit"},items:[{xtype:"syno_tabpanel",deferredRender:!1,plain:!0,activeTab:0,items:t}],fbar:{xtype:"statusbar",defaultText:"&nbsp",statusAlign:"left",buttonAlign:"left",items:[{text:_T("common","cancel"),xtype:"syno_button",btnStyle:"grey",handler:this.cancelHandler,scope:this},{id:this.applyBtnId=Ext.id(),text:_T("common","apply"),xtype:"syno_button",btnStyle:"blue",handler:this.applyHandler,scope:this}]}},e)},applyHandler:function(){return 0===this.panelShare.getSelectedShares().length?(this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("usbbackup","usbbkp_no_share")),!1):!1===this.panelShare.hasConfirmRename()?(this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_accept_share_change")),!1):this.panelDestination.getForm().isValid()?!0===this.panelShare.isFirstSyncHomes()?(this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_disable_server_home_service"),(function(e){"yes"===e&&this.testConnection()}),this),!1):void this.testConnection():(this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("error","error_bad_field")),!1)},testConnection:function(){var e=this.panelDestination.getValues();e.sync_shares=this.panelShare.getSelectedShares(),e.id=this.jobId,SYNO.SDS.S2S.TestConnection(this,e,(function(e,t,i,s){e?this.applyJob():this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:t},_T("netbackup","netbkp_connection_testing_fail")))}),this)},cancelHandler:function(){this.close()},onDestinationChange:function(e){this.panelShare.setConfirmRename(!1)},onTestConnection:function(e){var t=e.getValues();t.sync_shares=this.panelShare.getSelectedShares(),t.id=this.jobId,0!==t.sync_shares.length?SYNO.SDS.S2S.TestConnection(this,t,SYNO.SDS.S2S.TestConnectionCallBack,this):this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("usbbackup","usbbkp_no_share"))},requestJobConfAndShares:function(){var e=SYNO.SDS.S2S.GenGetShareParams(),t=SYNO.SDS.S2S.GenGetJobParams(this.jobId),i=SYNO.SDS.S2S.GenGetNetworkParams();this.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:[e,t,i]},callback:function(s,n,o,a){var r={},l=!1;if(this.clearStatusBusy(),!s||!n)return SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: sendWebAPI fail"),void this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"),(function(){this.close()}),this);SYNO.SDS.S2S.handleWebApiData(n.result,t,(function(e,t){if(!e||!e.data)return SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: request jobs fail"),void(l=SYNO.SDS.S2S.GetWebAPIErrorString(e));r=e.data.jobs[0],this.panelDestination.setValues(r.additional),this.panelSchedule.setValues(r.additional.schedule)}),this),SYNO.SDS.S2S.handleWebApiData(n.result,e,(function(e,t){var i;if(!e||!e.data)return SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: request shares fail"),void(l=SYNO.SDS.S2S.GetWebAPIErrorString(e));let s=(null==e||null===(i=e.data)||void 0===i?void 0:i.shares)??[];s=s.filter((e=>!SYNO.SDS.S2S.IsTieringShare(e))),this.panelShare.setValues(s,r.sync_shares?r.sync_shares:[])}),this),SYNO.SDS.S2S.handleWebApiData(n.result,i,(function(e,t){if(!e||!e.data)return SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: request network fail"),void(l=SYNO.SDS.S2S.GetWebAPIErrorString(e));var i=[];Ext.each(e.data.nif,(function(e,t,s){i.push(e.addr),Ext.isArray(e.ipv6)&&Ext.each(e.ipv6,(function(e){i.push(e.addr)}))})),i.push(e.data.hostname.toLowerCase()),this.panelDestination.setInvalidDests(i)}),this),l&&this.getMsgBox().alert(_T("s2s","s2s_app_title"),l,(function(){this.close()}),this)},scope:this})},applyJob:function(){var e={id:this.jobId};Ext.apply(e,this.panelShare.getValues()),Ext.apply(e,this.panelDestination.getValues()),Ext.apply(e,this.panelSchedule.getValues()),this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI(SYNO.SDS.S2S.GenSetJobParams({params:e,callback:function(e,t,i,s){this.clearStatusBusy(),e?this.close():this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:t}))},scope:this}))}}),Ext.define("SYNO.SDS.S2S.NamePanel",{extend:"SYNO.SDS.Utils.FormPanel",ID_PREFIX:"Folder Sync ",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({title:_T("s2s","col_task_destination"),items:[{xtype:"syno_textfield",name:"id",id:this.nameId=Ext.id(),allowBlank:!1,maxLength:SYNO.SDS.S2S.BKPSET_MAX_LEN,vtype:"taskname",fieldLabel:_T("s2s","s2s_lbl_task_name")}]},e)},checkIdConflict:function(){this.owner.setStatusBusy(),this.sendWebAPI(SYNO.SDS.S2S.GenListJobParams({callback:function(e,t,i,s){if(this.owner.clearStatusBusy(),!e||!t||!t.jobs)return SYNO.Debug("SYNO.SDS.S2S.SharePanel.checkIdConflict: list job fail"),void this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:t}));var n=Ext.getCmp(this.nameId).getValue();this.existJobId(t.jobs,n)?(SYNO.Debug("SYNO.SDS.S2S.SharePanel.setValues: id exists"),this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_duplicate_taskname"),(function(){Ext.getCmp(this.nameId).focus(!0)}),this)):(this.owner.goNext(this.nextId),this.owner.panelShare.setConfirmRename(!1),this.owner.getButton("next").setDisabled(!0))},scope:this}))},existJobId:function(e,t){if(!e)return!1;for(var i=0;e.length>i;i++)if(e[i].id===t)return!0;return!1},initUniqueId:function(e){var t=1,i=this.ID_PREFIX+t;if(e)for(;this.existJobId(e,i);)t++,i=this.ID_PREFIX+t;Ext.getCmp(this.nameId).setValue(i)},getValues:function(){return this.getForm().getValues()},getNext:function(){if(!this.getForm().isValid())return this.owner.setStatusError({text:_T("common","forminvalid"),clear:!0}),Ext.getCmp(this.nameId).focus(!0),!1;var e=Ext.util.Format.trim(Ext.getCmp(this.nameId).getValue());return Ext.getCmp(this.nameId).setValue(e),this.checkIdConflict(),!1},summary:function(e){e.append(_T("s2s","col_summary_task_name"),Ext.getCmp(this.nameId).getValue())}}),Ext.define("SYNO.SDS.S2S.SharePanel",{extend:"SYNO.SDS.Utils.FormPanel",isWizard:!1,constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.isWizard=e.isWizard,this.mon(this,"afterlayout",(function(){this.setConfirmRename(t.checkConfirmRename)}),this,{single:!0}),this.mon(this.selectCol,"click",(function(){this.setConfirmRename(!1)}),this),this.mon(Ext.getCmp(this.shareGridId),"headerclick",(function(e,t,i){0===t&&this.setConfirmRename(!1)}),this)},fillConfig:function(e){var t=new SYNO.API.Store({reader:new Ext.data.JsonReader({idProperty:"name",root:"",fields:[{name:"selected"},{name:"name"}]})});this.addManagedComponent(t);var i=new Ext.grid.ColumnModel({defaults:{menuDisabled:!0},columns:[this.selectCol=new SYNO.ux.EnableColumn({width:75,header:_T("usbbackup","usbbkp_select_all"),align:"center",dataIndex:"selected"}),{sortable:!0,width:350,header:_T("s2s","col_share_name"),align:"center",dataIndex:"name"}]});return Ext.apply({checkConfirmRename:!1,items:[{xtype:"syno_gridpanel",id:this.shareGridId=Ext.id(),loadMask:!0,enableColumnMove:!1,enableHdMenu:!1,padding:0,height:300,cm:i,ds:t,plugins:[this.selectCol]},{xtype:"syno_checkbox",name:"confirmRename",id:this.confirmRenameId=Ext.id(),height:"auto",boxLabel:_T("s2s","s2s_wiz_warn_shareData_del"),listeners:{check:{fn:function(e,t){this.isWizard?(this.owner.getButton("next").setDisabled(!t),this.owner.getButton("next").setTooltip(t?"":_T("s2s","s2s_warn_accept_share_change"))):(Ext.getCmp(this.owner.applyBtnId).setDisabled(!t),Ext.getCmp(this.owner.applyBtnId).setTooltip(t?"":_T("s2s","s2s_warn_accept_share_change")))},scope:this}}}]},e)},setConfirmRename:function(e){Ext.getCmp(this.confirmRenameId).setValue(e)},setValues:function(e,t){if(!Ext.isArray(e)||!Ext.isArray(t))return SYNO.Debug("SYNO.SDS.S2S.SharePanel.setValues: set shares fail"),void this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","err_unexpected_error"));var i=0,s={};for(i=0;t.length>i;i++)s[t[i]]=!0;for(i=0;e.length>i;i++)e[i].selected=!!s[e[i].name];Ext.getCmp(this.shareGridId).getStore().loadData(e,!1)},getSelectedShares:function(){for(var e=Ext.getCmp(this.shareGridId).getStore(),t=[],i=0;e.getTotalCount()>i;i++){var s=e.getAt(i);s.get("selected")&&t.push(s.get("name"))}return t},getValues:function(){return{sync_shares:this.getSelectedShares()}},hasConfirmRename:function(){return Ext.getCmp(this.confirmRenameId).getValue()},isFirstSyncHomes:function(){var e=Ext.getCmp(this.shareGridId).getStore().getModifiedRecords(),t=!1;return Ext.each(e,(function(e){if(e.get("selected")&&"homes"===e.get("name"))return t=!0,!1})),t},getNext:function(){return 0===this.getSelectedShares().length?(this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("usbbackup","usbbkp_no_share")),!1):!1===this.hasConfirmRename()?(this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_accept_share_change")),!1):!0===this.isFirstSyncHomes()?(this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_disable_server_home_service"),(function(e){"yes"===e&&this.owner.goNext(this.nextId)}),this),!1):this.nextId},summary:function(e){var t=this.getSelectedShares();0===t.length?e.append(_T("s2s","col_summary_share_list"),_T("s2s","no_selected_share")):e.append(_T("s2s","col_summary_share_list"),t.join(","))}}),Ext.define("SYNO.SDS.S2S.DestinationPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.hasFindServer=!1;var t=this.fillConfig(e);this.callParent([t]),this.addEvents("test_connection","destination_change"),this.mon(this,"afterlayout",(function(e,t){SYNO.ux.AddTip(this.getForm().findField("use_block").getEl(),_T("s2s","s2s_wiz_desc_enable_blockLvl"))}),this,{single:!0}),this.mon(this,"afterlayout",(function(){var e=new Ext.Component({autoEl:"span",renderTo:this.getForm().findField("ssh_port_check").getEl().next("label")});SYNO.ux.AddTip(e.getEl(),_T("s2s","s2s_wiz_desc_customize_ssh_port"))}),this,{single:!0})},fillConfig:function(e){var t=new SYNO.API.Store({reader:new Ext.data.JsonReader({idProperty:"name",root:"",fields:[{name:"ip"},{name:"name"},{name:"display"}]})});return this.addManagedComponent(t),Ext.apply({labelWidth:275,items:[this.combServer=new SYNO.ux.ComboBox({name:"server",allowBlank:!1,editable:!0,width:200,mode:"local",displayField:"display",valueField:"display",triggerAction:"all",fieldLabel:_T("netbackup","netbkp_set_ip"),emptyText:_T("netbackup","netbkp_input_addr"),owner:this,store:t,validator:Ext.createDelegate(this.validateServerName,this),onTriggerClick:function(){this.owner.onServerComboClick()},listeners:{change:{fn:function(e){this.fireEvent("destination_change")},scope:this}}}),{xtype:"syno_textfield",name:"user",allowBlank:!1,fieldLabel:_T("netbackup","netbkp_account")},{xtype:"syno_textfield",name:"password",fieldLabel:_T("common","password"),inputType:"password"},{xtype:"syno_numberfield",name:"rsync_timeout",allowBlank:!1,allowNegative:!1,maxValue:86400,minValue:600,maxlength:5,fieldLabel:_T("s2s","s2s_connection_timeout"),value:600},{xtype:"syno_checkbox",name:"ssh_port_check",boxLabel:_T("s2s","s2s_lbl_customize_ssh_port"),scope:this,handler:function(e,t){t?this.getForm().findField("ssh_port").enable():this.getForm().findField("ssh_port").disable()}},{xtype:"syno_numberfield",name:"ssh_port",disabled:!0,allowBlank:!1,indent:1,maxlength:5,vtype:"port",fieldLabel:_T("common","port")},{xtype:"syno_checkbox",name:"use_ssh",boxLabel:_T("netbackup","encryption_enable")},{xtype:"syno_checkbox",name:"use_compression",boxLabel:_T("netbackup","compression_enable")},{xtype:"syno_checkbox",name:"use_block",boxLabel:_T("s2s","s2s_wiz_lbl_enable_blockLvl")},{xtype:"syno_checkbox",name:"sync_remote_mount",boxLabel:_T("s2s","s2s_sync_remote_mount")},{xtype:"syno_button",text:_T("netbackup","netbkp_test_connection"),handler:function(e,t){this.fireEvent("test_connection",this)},scope:this}]},e)},validateServerName:function(e){var t=this.invalidDests,i=e.indexOf("("),s=e.indexOf(")");return e=e.toLowerCase(),i>0&&i<s&&s===e.length-1&&(e=e.substring(i+1,s)),!new RegExp("\\s").exec(e)&&(null!==/^(localhost|127\.0\.0\.1|0\.0\.0\.0|::1|0:0:0:0:0:0:0:1)$/.exec(e)||t&&-1!==t.indexOf(e)?_T("netbackup","netbkp_sync_self"):!!(Ext.form.VTypes.netbiosName(e)||Ext.form.VTypes.fwLooseip(e)||Ext.form.VTypes.hostname(e))||_T("netbackup","netbkp_err_host_str"))},getHostName:function(e){var t=e.indexOf("("),i=e;return t>0&&(i=e.substring(0,t)),Ext.form.VTypes.netbiosName(i)||Ext.form.VTypes.hostname(i)&&!Ext.form.VTypes.fwLooseip(i)?i:""},getHostIp:function(e){var t=e.indexOf("("),i=e.indexOf(")"),s=e;return t>0&&t<i&&i===e.length-1&&(s=e.substring(t+1,i)),Ext.form.VTypes.fwLooseip(s)?s:""},onServerComboClick:function(){var e=this.combServer;this.hasFindServer&&0<e.getStore().getTotalCount()?(e.isExpanded()?e.collapse():(e.onFocus({}),e.expand()),e.el.focus()):(e.el.focus(),this.owner.setStatusBusy({text:_T("netbackup","netbkp_wait_server")}),this.sendWebAPI(SYNO.SDS.S2S.GenListServerParams({callback:this.afterFindServers,scope:this})))},afterFindServers:function(e,t,i,s){if(this.owner.clearStatusBusy(),!e||!t||!Ext.isArray(t.servers))return SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.afterFindServers: sendWebAPI fail"),void this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));0<t.servers.length&&(this.hasFindServer=!0);for(var n=[],o=0;t.servers.length>o;o++){var a=t.servers[o].name;t.servers[o].ip!==a&&(a+="("+t.servers[o].ip+")"),n.push({ip:t.servers[o].ip,name:t.servers[o].name,display:a})}this.combServer.isExpanded()||this.combServer.el.focus(),this.combServer.getStore().loadData(n)},setInvalidDests:function(e){e?Ext.isArray(e)?this.invalidDests=e.slice(0):this.invalidDests=[e]:this.invalidDests=null},setValues:function(e){if(e){var t=e.server.name,i=e.server.ip,s=t;i!==s&&(s+="("+i+")"),this.combServer.setValue(s);var n=this.getForm();n.findField("use_block").setValue(e.use_block),n.findField("use_compression").setValue(e.use_compression),n.findField("use_ssh").setValue(e.use_ssh),n.findField("ssh_port_check").setValue(0!==e.ssh_port),n.findField("ssh_port").setValue(e.ssh_port?e.ssh_port:""),n.findField("user").setValue(e.user),n.findField("rsync_timeout").setValue(e.rsync_timeout),n.findField("sync_remote_mount").setValue(e.sync_remote_mount),n.findField("password").setValue(SYNO.SDS.S2S.GetFakePswd())}else SYNO.Debug("SYNO.SDS.S2S.DestinationPanel.setValues: fail")},getValues:function(e,t){var i=this.getForm(),s=i.findField("server").getValue(),n=this.getHostName(s);return{server_ip:this.getHostIp(s),server_name:n,use_block:i.findField("use_block").getValue(),use_compression:i.findField("use_compression").getValue(),use_ssh:i.findField("use_ssh").getValue(),ssh_port:i.findField("ssh_port").disabled?0:parseInt(i.findField("ssh_port").getValue(),10),user:i.findField("user").getValue(),password:i.findField("password").getValue(),rsync_timeout:parseInt(i.findField("rsync_timeout").getValue(),10),sync_remote_mount:i.findField("sync_remote_mount").getValue()}},getNext:function(){return this.getForm().isValid()?this.nextId:(this.owner.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1)},summary:function(e){var t=this.getForm();e.append(_T("netbackup","netbkp_account"),t.findField("user").getValue()),t.findField("use_ssh").getValue()?e.append(_T("netbackup","netbkp_security"),_T("netbackup","netbkp_high_security")):e.append(_T("netbackup","netbkp_security"),_T("netbackup","netbkp_low_security")),t.findField("ssh_port").disabled?e.append(_T("s2s","col_summary_customize_ssh_port"),_T("common","default")):e.append(_T("s2s","col_summary_customize_ssh_port"),t.findField("ssh_port").getValue()),t.findField("use_compression").getValue()?e.append(_T("netbackup","netbkp_data_compression"),_T("common","enabled")):e.append(_T("netbackup","netbkp_data_compression"),_T("common","disabled")),t.findField("use_block").getValue()?e.append(_T("s2s","col_summary_blockbkp"),_T("common","enabled")):e.append(_T("s2s","col_summary_blockbkp"),_T("common","disabled")),e.append(_T("s2s","s2s_connection_timeout"),t.findField("rsync_timeout").getValue()),t.findField("sync_remote_mount").getValue()?e.append(_T("s2s","s2s_sync_remote_mount"),_T("common","enabled")):e.append(_T("s2s","s2s_sync_remote_mount"),_T("common","disabled"))}}),Ext.define("SYNO.SDS.S2S.SchdPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",(function(e,t){new SYNO.ux.Utils.EnableRadioGroup(e.getForm(),this.scheduleRadio,{manual:[],realtime:[],advance:[this.advSchdBtn,"txtadvscheduletime","txtadvscheduleday"]}),this.setValues({})}),this,{single:!0})},fillConfig:function(e){var t=new Date;return this.advSchdMode=SYNO.SDS.S2S.SCHE_WEEKLY,this.schdData={week_day:SYNO.SDS.S2S.WEEK_ALL,mode:SYNO.SDS.S2S.SCHD_REALTIME,start_year:t.getFullYear(),start_month:t.getMonth()+1,start_day:t.getDate(),first_hour:0,first_min:0,repeat_hour:0,repeat_min:0,repeat_in_day:0},this.scheduleRadio="schedule_radio",Ext.apply({title:Ext.util.Format.ellipsis(_T("usbbackup","usbbkp_schedule"),15),tabTip:_T("usbbackup","usbbkp_schedule"),items:[{xtype:"syno_radiogroup",items:[{name:this.scheduleRadio,id:this.radioRealtimeId=Ext.id(),checked:!0,inputValue:SYNO.SDS.S2S.SCHD_REALTIME,boxLabel:_T("s2s","s2s_wiz_lbl_setSched_realtime"),handler:this.schdModeChangeHandler,scope:this},{name:this.scheduleRadio,id:this.radioManualId=Ext.id(),checked:!1,inputValue:SYNO.SDS.S2S.SCHD_MANUAL,boxLabel:_T("s2s","s2s_wiz_lbl_setSched_man"),handler:this.schdModeChangeHandler,scope:this},{name:this.scheduleRadio,id:this.radioAdvanceId=Ext.id(),checked:!1,inputValue:SYNO.SDS.S2S.SCHD_ADVANCE,boxLabel:_T("schedule","schedule_advance"),handler:this.schdModeChangeHandler,scope:this},{xtype:"syno_button",id:this.advSchdBtn=Ext.id(),text:_T("schedule","schedule_title"),autoWidth:!0,indent:1,handler:function(e,t){var i=new SYNO.SDS.S2S.AdvSchdDialog({title:_T("schedule","schedule_advance"),owner:this.owner});this.mon(i,"confirm",this.onApplyAdvSchd,this),i.setValues(this.schdData),i.open()},scope:this},{xtype:"syno_displayfield",name:"txtadvscheduletime",disabled:!0,indent:1,value:" "},{xtype:"syno_displayfield",name:"txtadvscheduleday",disabled:!0,indent:1,value:" "}]}]},e)},setValues:function(e){if(e){switch(Ext.apply(this.schdData,e),this.schdData.mode){case SYNO.SDS.S2S.SCHD_MANUAL:case SYNO.SDS.S2S.SCHD_REALTIME:this.getForm().findField(this.scheduleRadio).setValue(this.schdData.mode);break;default:this.advSchdMode=this.schdData.mode,this.getForm().findField(this.scheduleRadio).setValue(SYNO.SDS.S2S.SCHD_ADVANCE)}this.printAdvSchd()}},getValues:function(){return{schedule_mode:this.schdData.mode,schedule_start_year:this.schdData.start_year,schedule_start_month:this.schdData.start_month,schedule_start_day:this.schdData.start_day,schedule_first_hour:this.schdData.first_hour,schedule_first_min:this.schdData.first_min,schedule_repeat_hour:this.schdData.repeat_hour,schedule_repeat_min:this.schdData.repeat_min,schedule_repeat_in_day:this.schdData.repeat_in_day,schedule_week_day:this.schdData.week_day}},schdModeChangeHandler:function(e,t){if(t)switch(e.getId()){case this.radioManualId:this.schdData.mode=SYNO.SDS.S2S.SCHD_MANUAL;break;case this.radioRealtimeId:this.schdData.mode=SYNO.SDS.S2S.SCHD_REALTIME;break;default:this.schdData.mode=this.advSchdMode}},onApplyAdvSchd:function(e,t){t&&(Ext.apply(this.schdData,t),this.advSchdMode=t.mode,this.printAdvSchd())},printAdvSchd:function(){var e=this.getForm().findField("txtadvscheduletime"),t=this.getForm().findField("txtadvscheduleday");e.setValue(SYNO.SDS.S2S.ScheduleDateToString(this.schdData,this.advSchdMode)),t.setValue(SYNO.SDS.S2S.ScheduleTimeToString(this.schdData))},getNext:function(){return this.nextId},summary:function(e){var t="";switch(this.schdData.mode){case SYNO.SDS.S2S.SCHD_REALTIME:t=_T("s2s","s2s_lbl_sched_realtime");break;case SYNO.SDS.S2S.SCHD_MANUAL:t=_T("s2s","s2s_lbl_sched_mode_man");break;default:t=SYNO.SDS.S2S.ScheduleDateToString(this.schdData,this.schdData.mode),t+=", ",t+=SYNO.SDS.S2S.ScheduleTimeToString(this.schdData)}e.append(_T("s2s","s2s_wiz_lbl_schedule"),t)}}),Ext.define("SYNO.SDS.S2S.OverviewPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({border:!1,layout:{type:"fit"},height:390,items:[this.grid=new SYNO.SDS.Wizard.SummaryStep({})]},e)},activate:function(){var e=this.owner.stepStack,t=null;this.grid.getStore().removeAll(!0);for(var i=0;i<e.length;i++)t=this.owner.getStep(e[i]),Ext.isFunction(t.summary)&&t.summary(this.grid.getStore());this.grid.getView().refresh()}}),Ext.define("SYNO.SDS.S2S.AdvSchdPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",(function(e,t){new SYNO.ux.Utils.EnableRadioGroup(e.getForm(),this.scheduleRadio,{by_week:[this.weekDayId],by_date:[this.startDateId,this.byDateId]})}),this,{single:this})},fillConfig:function(e){var t=function(e,t){var i=new Ext.data.ArrayStore({fields:["display","value"],data:t});return e.addManagedComponent(i),i},i=function(e,i,s,n){for(var o=[],a=i;s>=a;a++)o.push(n(a));return t(e,o)},s=function(e){return Ext.apply({xtype:"syno_combobox",editable:!1,triggerAction:"all",mode:"local",displayField:"display",valueField:"value"},e)},n=i(this,0,23,(function(e){return[String.leftPad(String(e),2,"0"),e]})),o=i(this,0,59,(function(e){return[String.leftPad(String(e),2,"0"),e]})),a=t(this,[[_T("schedule","no_repeat"),SYNO.SDS.S2S.SCHE_ONCE],[_T("schedule","repeat_monthly"),SYNO.SDS.S2S.SCHE_MONTHLY],[_T("schedule","repeat_yearly"),SYNO.SDS.S2S.SCHE_YEARLY]]);return this.periodStore=t(this,[]),this.lastWorkHourStore=t(this,[]),this.scheduleRadio="scheduleRadio",Ext.apply({height:500,items:[{xtype:"syno_fieldset",title:_T("time","time_date"),items:[{xtype:"syno_radiogroup",items:[{name:this.scheduleRadio,boxLabel:_T("schedule","run_on_days"),inputValue:SYNO.SDS.S2S.RADIO_BY_WEEK},{xtype:"syno_schedulefield",id:this.weekDayId=Ext.id(),allowBlank:!1,editable:!1,boxMinWidth:200,boxMaxWidth:200,indent:1},{name:this.scheduleRadio,boxLabel:_T("schedule","by_date"),inputValue:SYNO.SDS.S2S.RADIO_BY_DATE},{xtype:"syno_datetimefield",id:this.startDateId=Ext.id(),allowBlank:!1,editable:!1,boxMinWidth:200,boxMaxWidth:200,indent:1,maxValue:"2037/12/31",minValue:"2005/1/1"},s({id:this.byDateId=Ext.id(),value:SYNO.SDS.S2S.SCHE_ONCE,boxMinWidth:200,boxMaxWidth:200,indent:1,store:a})]}]},{xtype:"syno_fieldset",title:_T("time","time_time"),items:[{xtype:"syno_compositefield",fieldLabel:_T("schedule","run_time_first"),items:[s({id:this.fisrtHourId=Ext.id(),width:60,store:n,listeners:{select:{fn:function(){this.updatePeriodStore(),this.updateLastWorkTimeStore()},scope:this}}}),{xtype:"syno_displayfield",value:":",tabIndex:-1},s({id:this.firstMinId=Ext.id(),width:60,store:o,listeners:{select:{fn:function(){this.updatePeriodStore(),this.updateLastWorkTimeStore()},scope:this}}})]},s({id:this.periodId=Ext.id(),value:0,fieldLabel:_T("schedule","schedule_every"),store:this.periodStore,listeners:{select:{fn:function(){this.updateLastWorkTimeStore()},scope:this}}}),s({id:this.repeatTimesId=Ext.id(),value:0,fieldLabel:_T("schedule","run_time_last"),store:this.lastWorkHourStore})]}]},e)},setValues:function(e){if(e){for(var t=[],i=0;e.week_day.length>i;i++)"0"!==e.week_day.charAt(i)&&t.push(i);switch(Ext.getCmp(this.weekDayId).setValue(t.join(",")),Ext.getCmp(this.startDateId).setValue(new Date(e.start_year,e.start_month-1,e.start_day)),Ext.getCmp(this.startDateId).isValid()||Ext.getCmp(this.startDateId).setValue(new Date),Ext.getCmp(this.fisrtHourId).setValue(e.first_hour),Ext.getCmp(this.firstMinId).setValue(e.first_min),this.updatePeriodStore(),Ext.getCmp(this.periodId).setValue(60*e.repeat_hour+e.repeat_min),this.updateLastWorkTimeStore(),Ext.getCmp(this.repeatTimesId).setValue(e.repeat_in_day),e.mode){case SYNO.SDS.S2S.SCHE_MONTHLY:case SYNO.SDS.S2S.SCHE_YEARLY:case SYNO.SDS.S2S.SCHE_ONCE:this.getForm().findField(this.scheduleRadio).setValue(SYNO.SDS.S2S.RADIO_BY_DATE),Ext.getCmp(this.byDateId).setValue(e.mode);break;default:this.getForm().findField(this.scheduleRadio).setValue(SYNO.SDS.S2S.RADIO_BY_WEEK),Ext.getCmp(this.byDateId).setValue(SYNO.SDS.S2S.SCHE_ONCE)}}},getValues:function(){for(var e=this.getForm().findField(this.scheduleRadio).getGroupValue(),t=Ext.getCmp(this.startDateId).getValue(),i="",s=["0","0","0","0","0","0","0"],n=Ext.getCmp(this.weekDayId).getValue().split(","),o=0;n.length>o;o++){s[parseInt(n[o],10)]="1"}switch(e){case SYNO.SDS.S2S.RADIO_BY_WEEK:i=SYNO.SDS.S2S.SCHE_WEEKLY;break;default:case SYNO.SDS.S2S.RADIO_BY_DATE:i=Ext.getCmp(this.byDateId).getValue()}return{mode:i,start_year:t.getFullYear(),start_month:t.getMonth()+1,start_day:t.getDate(),first_hour:Ext.getCmp(this.fisrtHourId).getValue(),first_min:Ext.getCmp(this.firstMinId).getValue(),repeat_hour:Math.floor(Ext.getCmp(this.periodId).getValue()/60),repeat_min:Ext.getCmp(this.periodId).getValue()%60,repeat_in_day:Ext.getCmp(this.repeatTimesId).getValue(),week_day:s.join("")}},updatePeriodStore:function(){var e,t=[],i=1440-(60*Ext.getCmp(this.fisrtHourId).getValue()+Ext.getCmp(this.firstMinId).getValue());t.push([_T("schedule","schedule_every_once"),0]),i>15&&t.push([String.format(_T("s2s","s2s_lbl_sched_every_min"),15),15]),i>30&&t.push([String.format(_T("s2s","s2s_lbl_sched_every_min"),30),30]);for(var s=1;i>60*s;s++)e=String.format(_T("s2s","s2s_lbl_sched_mode_every"),s),t.push([e,60*s]);this.periodStore.loadData(t),Ext.getCmp(this.periodId).getValue()>i&&Ext.getCmp(this.periodId).setValue(0)},updateLastWorkTimeStore:function(){for(var e=[],t=60*Ext.getCmp(this.fisrtHourId).getValue()+Ext.getCmp(this.firstMinId).getValue(),i=t,s=Ext.getCmp(this.repeatTimesId).getValue(),n=Ext.getCmp(this.periodId).getValue(),o=0;i<1440;){var a=Math.floor(i/60),r=i%60;if(e.push([SYNO.SDS.S2S.GetFormattedTimeStr(a,r),o]),i=t+ ++o*n,0===n)break}this.lastWorkHourStore.loadData(e),s>=o?Ext.getCmp(this.repeatTimesId).setValue(0):Ext.getCmp(this.repeatTimesId).setValue(s)}}),Ext.define("SYNO.SDS.S2S.AdvSchdDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.addEvents("confirm")},fillConfig:function(e){return this.panelSchedule=new SYNO.SDS.S2S.AdvSchdPanel({owner:this}),Ext.apply({title:e.title,width:510,height:480,items:[this.panelSchedule],buttons:[{text:_T("common","cancel"),handler:this.cancelHandler,scope:this},{text:_T("common","apply"),handler:this.applyHandler,btnStyle:"blue",scope:this}]},e)},applyHandler:function(){this.fireEvent("confirm",this,this.getValues()),this.close()},cancelHandler:function(){this.fireEvent("confirm",this,null),this.close()},getValues:function(){return this.panelSchedule.getValues()},setValues:function(e){this.panelSchedule.setValues(e)}}),Ext.ns("SYNO.SDS.AdminCenter.FileService"),Ext.define("SYNO.SDS.AdminCenter.FileService.RsyncTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",this.enableCheckGroup,this,{single:!0})},enableCheckGroup:function(){new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable",["rsync_sshd_port","enable_rsync_account"]),this.updateRsyncUI()},fillConfig:function(e){var t={title:_T("service","service_rsync"),autoScroll:!0,webapi:{api:"SYNO.Backup.Service.NetworkBackup",methods:{get:"get",set:"set"},version:1},items:this.createRsyncItems(e)};return Ext.apply(t,e),t},createRsyncItems:function(e){var t=[{xtype:"syno_displayfield",value:String.format(_T("service","service_rsync_desc"),"yes"===_D("dockerdsm")||SYNO.SDS.Utils.isInVirtualDSM()?_T("service","service_rsync_nondsm_server"):_T("service","service_rsync_dsm_server"))},{xtype:"syno_checkbox",name:"enable",boxLabel:_T("service","enable_rsync_service"),listeners:{scope:this,check:this.updateRsyncUI}},{xtype:"syno_numberfield",name:"rsync_sshd_port",indent:1,maxlength:5,vtype:"port",labelWidth:270,fieldLabel:_T("service","rsync_sshd_port"),validator:function(e){return!SYNO.SDS.Utils.isReservedPort("ssh",e,e)||_T("service","error_dl_port_in_used")}},{xtype:"syno_checkbox",name:"enable_rsync_account",indent:1,boxLabel:_T("service","enable_rsync_account")},{xtype:"syno_displayfield",name:"rsync_account_desc",indent:2,value:_T("service","rsync_account_desc")},{xtype:"syno_button",id:this.AccountBtnId=Ext.id(),indent:2,disabled:!0,text:_T("service","edit_rsync_account"),handler:this.showRsyncAccount,scope:this}];return t.push(SYNO.SDS.BandwidthControl.SchedulePanelConfig(this,"NetworkBackup")),t},getScheduleForm:function(){return this.getForm()},updateRsyncUI:function(){var e=this.getForm(),t=e.findField("enable").getValue();this.bandwidthSettingEnable(t),e.findField("rsync_account_desc").setDisabled(!t),t?Ext.getCmp(this.AccountBtnId).enable():Ext.getCmp(this.AccountBtnId).disable()},processReturnData:function(e,t,i){this.processBandwidthReturnData(t,i),this.getForm().loadRecords(t.result,i.compound),this.sendServiceEvent()},processBandwidthReturnData:function(e,t){for(var i={api:"SYNO.Core.BandwidthControl.Protocol",method:"get",version:1,protocol:"NetworkBackup"},s=0;s<e.result.length;s++)!0===SYNO.ux.Utils.checkApiConsistency(i,e.result[s])&&t.compound[s].params.protocol===i.protocol&&(e.result[s].data=SYNO.SDS.BandwidthControl.reConstructApiKey("get",i.protocol,e.result[s].data))},sendServiceEvent:function(){this.sshPortChg&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.Rsync",!0),(this.rsyncChg||this.sshPortChg)&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.Rsync",!this.getForm().findField("enable").getValue())},processParams:function(e,t){if("set"==e){this.rsyncChg=this.getForm().findField("enable").isDirty(),this.sshPortChg=this.getForm().findField("rsync_sshd_port").isDirty();var i={api:"SYNO.S2S.Server",version:1,method:"set",params:{enable:this.getForm().findField("enable").getValue()}};t=t.concat(i)}return t},errorChecking:function(e,t){if(!0===SYNO.ux.Utils.checkApiConsistency({api:"SYNO.S2S.Server",version:1,method:"set"},e.result[t]))return!0},errorHandling:function(e){var t=SYNO.SDS.S2S.GetWebAPIErrorString({error:{code:e}});this.module.appWin.getMsgBox().alert(this.title,t)},showRsyncAccount:function(){new SYNO.SDS.AdminCenter.FileService.Rsync.AccountDialog({owner:this.module.appWin}).open()}}),Ext.define("SYNO.SDS.AdminCenter.FileService.TFTPAdvancedSettingsDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.form=this.panel.getForm(),this.tftpGet={api:"SYNO.Core.TFTP",method:"get",version:1},this.tftpSet={api:"SYNO.Core.TFTP",method:"set",version:1},this.syslogGet={api:"SYNO.Core.SyslogClient.FileTransfer",method:"get",version:1},this.syslogSet={api:"SYNO.Core.SyslogClient.FileTransfer",method:"set",version:1},this.mon(this,"show",(function(){var e="SYNO.SDS.CMS.Application"===this.findAppWindow().getOpenConfig("className");new SYNO.ux.Utils.EnableRadioGroup(this.form,"allowclient",{manual:["startip","endip"]}),SYNO.ux.Utils.DescribeGroup(this.panel.getForm().findField("timeout"),this.panel.getForm().findField("timeout_desc")),e&&Ext.getCmp(this.logBtnId).disable(),this.load()}),this,{single:!0})},fillConfig:function(e){return this.owner=e.owner,Ext.apply({resizable:!1,width:700,height:575,title:_T("common","adv_setting"),layout:{type:"fit"},items:[this.panel=this.createPanel()],buttons:[{xtype:"syno_button",text:_T("common","cancel"),handler:this.cancelHandler,scope:this},{xtype:"syno_button",text:_T("common","save"),disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",btnStyle:"blue",handler:this.applyHandler,scope:this}]},e)},createPanel:function(){return new SYNO.SDS.Utils.FormPanel({border:!1,trackResetOnLoad:!0,owner:this,webapi:{api:"SYNO.Core.TFTP",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_fieldset",title:_T("ftp","xfer_setting"),items:[{xtype:"syno_checkbox",name:"enable_log",id:this.enableLogId=Ext.id(),boxLabel:_T("ftp","tftp_xferlog")},{xtype:"syno_button",indent:1,id:this.logBtnId=Ext.id(),text:_T("log","log_subtitle"),handler:function(){SYNO.SDS.AppLaunch("SYNO.SDS.LogCenter.BuiltIn",{fn:"SYNO.SDS.LogCenter.LogSearch",logType:"fileTransfer",protocol:"tftpxfer"})}}]},{xtype:"syno_fieldset",title:_T("ftp","privilege_setting"),hideMode:"offsets",items:[{xtype:"syno_combobox",name:"permission",id:this.permissionId=Ext.id(),fieldLabel:_T("ftp","tftp_permission"),forceSelection:!0,editable:!1,value:"r",valueField:"value",displayField:"display",store:new SYNO.API.JsonStore({fields:["display","value"],data:[{display:_T("common","readonly"),value:"r"},{display:_T("common","writeable"),value:"rw"}]})},{xtype:"syno_displayfield",value:_T("ftp","tftp_allowed_client")},{xtype:"syno_radiogroup",items:[{indent:1,name:"allowclient",inputValue:"default",boxLabel:_T("ftp","tftp_all_connection")},{indent:1,name:"allowclient",inputValue:"manual",boxLabel:_T("ftp","tftp_allow_ip_range")}]},{xtype:"syno_textfield",name:"startip",id:this.startIpId=Ext.id(),fieldLabel:_T("ftp","ftp_port_from"),indent:2,allowBlank:!1,vtype:"ip"},{xtype:"syno_textfield",name:"endip",id:this.endIpId=Ext.id(),fieldLabel:_T("ftp","ftp_port_to"),indent:2,allowBlank:!1,vtype:"ip"}]},{xtype:"syno_fieldset",title:_T("ftp","ftp_timeout"),hideMode:"offsets",items:[{xtype:"syno_compositefield",items:[{xtype:"syno_numberfield",name:"timeout",id:this.timeoutId=Ext.id(),allowBlank:!1,maxValue:255,minValue:1,fieldLabel:_T("ftp","ftp_timeout")},{xtype:"syno_displayfield",name:"timeout_desc",value:_T("time","time_second")+"(1 ~ 255)","aria-label":_T("time","time_second")+SYNO.ux.Utils.ConvertSingleSymbolToString("(1 ~ 255)","~")}]}]}]})},cancelHandler:function(){this.fireEvent("confirm",null),this.close()},load:function(){var e=[this.tftpGet,this.syslogGet];this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({scope:this,compound:{params:e},callback:function(e,t,i){this.clearStatusBusy(),e?this.setAllValues(t):this.setStatusError()}})},setAllValues:function(e){var t=!1,i={};this.handleWebApiData(e.result,this.tftpGet,(function(e,t){e.success?Ext.apply(i,e.data):SYNO.Debug("SYNO.SDS.AdminCenter.FileService.TFTPAdvancedSettingsDialog: request tftp fail")}),this),this.handleWebApiData(e.result,this.syslogGet,(function(e,i){e.success?t=e.data.tftp:SYNO.Debug("SYNO.SDS.AdminCenter.FileService.TFTPAdvancedSettingsDialog: request syslog fail")}),this),i.enable_log=t,i.enable_log||Ext.getCmp(this.logBtnId).disable(),"0.0.0.0"===i.startip&&"255.255.255.255"===i.endip?i.allowclient="default":i.allowclient="manual",this.form.setValues(i)},applyHandler:function(){if(this.validateForm()){var e=this.form.getValues();if("default"===e.allowclient?(e.startip="0.0.0.0",e.endip="255.255.255.255"):(e.startip=Ext.getCmp(this.startIpId).getValue(),e.endip=Ext.getCmp(this.endIpId).getValue()),!this.form.isDirty())return this.fireEvent("confirm",this,e),void this.close();var t=[Ext.apply({params:e},this.tftpSet),Ext.apply({params:{tftp:e.enable_log}},this.syslogSet)];this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({compound:{stopwhenerror:!1,params:t},scope:this,callback:function(e,t,i){this.clearStatusBusy(),e&&t?t.has_fail?this.setStatusError({text:SYNO.API.getErrorString(t)}):(this.fireEvent("confirm",this,t),this.close()):this.setStatusError()}})}else this.setStatusError({text:_T("common","forminvalid"),clear:!0})},validateForm:function(){if(!this.form.isValid())return!1;var e=this.form.findField("allowclient").getGroupValue(),t=this.form.findField("startip"),i=this.form.findField("endip"),s=t.getValue(),n=i.getValue();if("manual"===e){if(!this.form.findField("startip").isValid())return this.form.findField("startip").markInvalid(),!1;if(!this.form.findField("endip").isValid())return this.form.findField("endip").markInvalid(),!1}return!this.checkIpInterval(s,n)||(this.form.findField("startip").markInvalid(),this.form.findField("endip").markInvalid(),!1)},checkIpInterval:function(e,t){if("string"!=typeof e||"string"!=typeof t)return!0;for(var i=e.split("."),s=t.split("."),n=0;n<4;++n){if(parseInt(s[n],10)>parseInt(i[n],10))return!1;if(parseInt(s[n],10)<parseInt(i[n],10))return!0}return!1},handleWebApiData:function(e,t,i,s){for(var n=0;n<e.length;n++)!0===SYNO.ux.Utils.checkApiConsistency(t,e[n])&&i.call(s||this,e[n],n)}}),Ext.ns("SYNO.SDS.AdminCenter.FileService"),Ext.define("SYNO.SDS.AdminCenter.FileService.AdvancedTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.enableSmb2Lease=!1,this.enableSmbDurable=!1,this.smbMaxProtocol=1,this.enableSmbOpLock=!0,this.bonjourChange=!1,this.supportBtrfs="yes"===_D("support_btrfs","no");var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",this.enableCheckGroup,this,{single:!0}),"yes"!==_D("support_hyper_converged")&&this.mon(this,"activate",(function(e,t){this.requestS2SServerInfo()}),this)},fillConfig:function(e){var t={title:_T("common","advanced"),autoScroll:!0,items:[]};return this.supportBtrfs&&t.items.push(this.createFileCloneTabObj(e)),t.items.push(this.createBonjourTabObj(e)),t.items.push(this.createSSDPTabObj(e)),"yes"!==_D("support_hyper_converged")&&t.items.push(this.createTftpTabObj(e)),t.items.push(this.createS2STabObj(e)),t.items.push(this.createBypassTraverseObj(e)),Ext.apply(t,e)},enableCheckGroup:function(){new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_avahi",["enable_printer_support","enable_afp_time_machine","enable_smb_time_machine"]),"yes"===_D("support_printer","yes")?Ext.getCmp(this.printerCheckboxId).setVisible(!0):Ext.getCmp(this.printerCheckboxId).setVisible(!1),"yes"!==_D("support_hyper_converged")&&new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"tftp_enable",["tftp_root_path",this.advRootPathBtnId,this.advSettingBtnId])},createFileCloneTabObj:function(e){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::copy::reflink",collapsible:!0,itemId:"enable_reflink_copy",title:_T("share","share_reflink_copy"),items:[{xtype:"syno_displayfield",value:_T("share","share_reflink_copy_desc")},{xtype:"syno_checkbox",boxLabel:_T("share","share_reflink_copy_enable"),itemId:"reflinkCheckBox",name:"enable_reflink_copy"}]}},createBypassTraverseObj:function(e){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::acl::bypass",collapsible:!0,itemId:"enable_bypass_traverse_checking",title:_T("service","acl_bypass_traverse_checking"),items:[{xtype:"syno_displayfield",value:_T("service","enable_acl_bypass_traverse_checking_desc")},{xtype:"syno_checkbox",boxLabel:_T("service","enable_acl_bypass_traverse_checking"),itemId:"bypassCheckBox",name:"enable_bypass_traverse_checking"}]}},createSSDPTabObj:function(e){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::sd::ssdp",collapsible:!0,itemId:"enable_ssdp",title:_T("service","ssdp_title"),items:[{xtype:"syno_displayfield",value:_T("service","enable_ssdp_desc")},{xtype:"syno_checkbox",boxLabel:_T("service","enable_ssdp"),itemId:"ssdpCheckBox",name:"enable_ssdp"}]}},createBonjourTabObj:function(e){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::sd::bonjour",collapsible:!0,itemId:"bonjourFieldSet",title:_T("firewall","firewall_service_opt_bonjour"),items:[{xtype:"syno_checkbox",itemId:"enable_avahi",boxLabel:_T("service","enable_avahi"),name:"enable_avahi",listeners:this.createBonjourListener()},{xtype:"syno_checkbox",name:"enable_printer_support",itemId:"enable_printer_support",id:this.printerCheckboxId=Ext.id(),indent:1,boxLabel:_T("network","bonjourPrinter_enable")},{xtype:"syno_checkbox",name:"enable_smb_time_machine",itemId:"enable_smb_time_machine",indent:1,boxLabel:_T("service","smb_time_machine_enable")},{xtype:"syno_checkbox",name:"enable_afp_time_machine",itemId:"enable_afp_time_machine",indent:1,boxLabel:_T("service","afp_time_machine_enable"),hidden:"yes"===_D("support_hyper_converged")},{xtype:"syno_button",btnStyle:"default",name:"TimeMachineBtnId",itemId:"TimeMachineBtnId",text:_T("network","network_time_machine_folders"),indent:1,scope:this,handler:this.onTimeMachineBtnClick}]}},createTftpTabObj:function(e){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.FileService.Main::tftp::tftp",collapsible:!0,useGradient:!1,title:_T("ftp","tftp_title"),items:[{xtype:"syno_displayfield",value:_T("ftp","tftp_desc")},{xtype:"syno_checkbox",name:"tftp_enable",boxLabel:_T("ftp","tftp_enable")},{xtype:"syno_compositefield",fieldLabel:_T("ftp","tftp_root"),indent:1,items:[{xtype:"syno_textfield",name:"tftp_root_path",readOnly:!0,allowBlank:!1},{xtype:"syno_button",id:this.advRootPathBtnId=Ext.id(),text:_T("common","choose"),handler:function(){var e=new SYNO.SDS.Utils.FileChooser.Chooser({title:_T("ftp","select_folder"),superuser:!0,enumColdStorage:!0,enumC2Share:!0,folderToolbar:!0,owner:this.module.appWin,usage:{type:"chooseDir"},treeFilter:function(e,t){return!(t&&"broken"===t.status)}});e.mon(e,"choose",(function(e,t,i){this.getForm().findField("tftp_root_path").setValue(t.path.substr(1)),e.close()}),this),e.open()},scope:this}]},{xtype:"syno_button",id:this.advSettingBtnId=Ext.id(),text:_T("common","adv_setting"),indent:1,handler:function(){new SYNO.SDS.AdminCenter.FileService.TFTPAdvancedSettingsDialog({owner:this.module.appWin}).show()},scope:this}]}},createS2STabObj:function(e){var t={itemId:"s2sFieldSet",xtype:"syno_fieldset",labelWidth:310,stateId:"SYNO.SDS.AdminCenter.FileService.Main::sd::s2s",title:_T("s2s","s2s_app_title"),collapsible:!0},i=[];return"yes"===_D("support_s2s")&&"yes"!==_D("usbstation")&&i.push({xtype:"syno_displayfield",id:this.s2sStatusId=Ext.id(),htmlEncode:!1,fieldLabel:_T("s2s","s2s_wiz_lbl_svr_status"),value:"-",hidden:"yes"===_D("support_hyper_converged")},{xtype:"syno_displayfield",id:this.s2sPairLstId=Ext.id(),fieldLabel:_T("s2s","s2s_wiz_lbl_svr_pair"),hidden:!0},{xtype:"syno_displayfield",id:this.s2sUpgradeDescId=Ext.id(),hidden:!0,htmlEncode:!1,value:'<span class="red-status">'+_T("s2s","s2s_warn_multisrc_upgrade")+"</span>"},{xtype:"syno_displayfield",id:this.s2sResetDescId=Ext.id(),hidden:!0,value:_T("s2s","s2s_wiz_lbl_reset_desc")},{xtype:"syno_button",id:this.s2sResetBtnId=Ext.id(),hidden:!0,name:"resetS2Sbtn",text:_T("s2s","s2s_btn_cancel_sharepair"),handler:this.resetS2SPairInfo,scope:this}),i.push({xtype:"syno_button",id:this.s2sTaskListBtnId=Ext.id(),name:"clientS2Sbtn",text:_T("s2s","s2s_btn_client_task_list"),handler:this.showS2STasks,scope:this}),"yes"===_D("netbkp")&&"yes"!==_D("support_hyper_converged")&&i.push({xtype:"syno_displayfield",hideLabel:!0,htmlEncode:!1,indent:0,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+String.format(_T("s2s","s2s_server_desc"),'<a id="'+Ext.id()+'" class="link-font" href>'+_T("service","service_rsync")+"</a>"),listeners:{render:function(e){var t=e.el.first("a");t&&this.mon(t,"click",(function(e){e.preventDefault(),this.module.app.startModule("SYNO.SDS.AdminCenter.FileService.Main",{tab:"rsync"})}),this)},scope:this,single:!0,buffer:80}}),t.items=i,t},createBonjourListener:function(){return{check:{scope:this,fn:this.onBonjourCheckHandler}}},processParams:function(e,t){var i=this.getComponent("bonjourFieldSet"),s=this.getComponent("enable_ssdp").getComponent("ssdpCheckBox"),n=i.getComponent("enable_avahi"),o=i.getComponent("enable_printer_support"),a=i.getComponent("enable_smb_time_machine"),r="yes"!==_D("support_hyper_converged")?i.getComponent("enable_afp_time_machine"):{checked:!1,isDirty:function(){return!1}},l=this.module.panel.smbTab.getForm().getValues().enable_samba,d=this.getComponent("enable_bypass_traverse_checking").getComponent("bypassCheckBox");if("set"==e){if(this.supportBtrfs){var c=this.getComponent("enable_reflink_copy").getComponent("reflinkCheckBox");c.isDirty()&&(t=t.concat({api:"SYNO.Core.FileServ.ReflinkCopy",method:"set",version:1,params:{reflink_copy_enable:c.getValue()}}))}if("yes"!==_D("support_hyper_converged")){var h=this.getForm().findField("tftp_enable"),u=this.getForm().findField("tftp_root_path");this.tftpChange=h.isDirty(),(this.tftpChange||u.isDirty())&&(t=t.concat({api:"SYNO.Core.TFTP",method:"set",version:1,params:{enable:h.getValue(),root_path:u.getValue()}}))}(s.isDirty()||n.isDirty())&&(t=t.concat({api:"SYNO.Core.Web.DSM",method:"set",version:2,params:{enable_ssdp:s.getValue(),enable_avahi:n.getValue()}})),n.checked&&o.isDirty()&&(t=t.concat({api:"SYNO.Core.ExternalDevice.Printer.BonjourSharing",method:"set",version:1,params:{enable_bonjour_support:o.checked}})),n.checked&&(a.isDirty()||r.isDirty())&&(t=t.concat({api:"SYNO.Core.FileServ.ServiceDiscovery",method:"set",version:1,params:{enable_afp_time_machine:r.checked,enable_smb_time_machine:a.checked}})),l&&n.checked&&a.isDirty()&&a.checked&&(t=t.concat({api:"SYNO.Core.FileServ.SMB",method:"set",version:3,params:{enable_samba:!0,smb_max_protocol:3,enable_op_lock:!0,enable_durable_handles:!0,enable_smb2_leases:!0}})),this.bonjourChange=this.getForm().findField("enable_avahi").isDirty(),d.isDirty()&&(t=t.concat({api:"SYNO.Core.ACL",method:"set_bypass_traverse",version:1,params:{enable:d.getValue()}}))}return this.supportBtrfs&&(t=t.concat({api:"SYNO.Core.FileServ.ReflinkCopy",method:"get",version:1})),"yes"!==_D("support_hyper_converged")&&(t=t.concat({api:"SYNO.Core.TFTP",method:"get",version:1})),t=(t=(t=(t=t.concat({api:"SYNO.Core.Web.DSM",method:"get",version:2})).concat({api:"SYNO.Core.ExternalDevice.Printer.BonjourSharing",method:"get",version:1})).concat({api:"SYNO.Core.FileServ.ServiceDiscovery",method:"get",version:1})).concat({api:"SYNO.Core.ACL",method:"get_bypass_traverse",version:1})},processReturnData:function(e,t,i){var s=!1,n=!1,o=!1,a=!1,r=!1,l=!1,d=!1,c="",h=!1,u=this.getComponent("bonjourFieldSet").getComponent("TimeMachineBtnId"),p={api:"SYNO.Core.Web.DSM",method:"get",version:2},_={api:"SYNO.Core.ExternalDevice.Printer.BonjourSharing",method:"get",version:1},m={api:"SYNO.Core.FileServ.ServiceDiscovery",method:"get",version:1},f={api:"SYNO.Core.FileServ.SMB",method:"get",version:3},S={api:"SYNO.Core.FileServ.ReflinkCopy",method:"get",version:1},g={api:"SYNO.Core.TFTP",method:"get",version:1},y={api:"SYNO.Core.ACL",method:"get_bypass_traverse",version:1};Ext.each(t.result,(function(e,t){!0===SYNO.ux.Utils.checkApiConsistency(p,e)?(s=e.data.enable_ssdp,n=e.data.enable_avahi):!0===SYNO.ux.Utils.checkApiConsistency(S,e)?l=e.data.reflink_copy_enable:!0===SYNO.ux.Utils.checkApiConsistency(_,e)?o=e.data.enable_bonjour_support:!0===SYNO.ux.Utils.checkApiConsistency(m,e)?(a=e.data.enable_afp_time_machine,r=e.data.enable_smb_time_machine):!0===SYNO.ux.Utils.checkApiConsistency(f,e)?(this.enableSmbDurable=e.data.enable_durable_handles,this.enableSmb2Lease=e.data.enable_smb2_leases,this.smbMaxProtocol=e.data.smb_max_protocol,this.enableSmbOpLock=e.data.enable_op_lock):!0===SYNO.ux.Utils.checkApiConsistency(g,e)?(d=e.data.enable,c=e.data.root_path):!0===SYNO.ux.Utils.checkApiConsistency(y,e)&&(h=e.data.enable)}),this),this.supportBtrfs?this.getForm().setValues({enable_ssdp:s,enable_reflink_copy:l,enable_avahi:n,enable_printer_support:o,enable_afp_time_machine:a,enable_smb_time_machine:r,tftp_enable:d,enable_bypass_traverse_checking:h,tftp_root_path:c}):this.getForm().setValues({enable_ssdp:s,enable_avahi:n,enable_printer_support:o,enable_afp_time_machine:a,enable_smb_time_machine:r,tftp_enable:d,enable_bypass_traverse_checking:h,tftp_root_path:c}),n||u.setDisabled(!0),this.sendServiceEvent()},sendServiceEvent:function(){this.bonjourChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.WinMacNfs.BONJOUR",!this.getForm().findField("enable_avahi").getValue()),"yes"!==_D("support_hyper_converged")&&this.tftpChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.FTP.TFTP",!this.getForm().findField("tftp_enable").getValue())},onBonjourCheckHandler:function(e,t){var i=!t;this.getComponent("bonjourFieldSet").getComponent("TimeMachineBtnId").setDisabled(i)},onTimeMachineBtnClick:function(){new SYNO.SDS.AdminCenter.FileService.Bonjour.TimeMachineDialog({module:this.module,owner:this.module.appWin}).open()},requestS2SServerInfo:function(e){if("yes"===_D("support_s2s")&&"yes"!==_D("usbstation")){var t=SYNO.SDS.S2S.GenListPairParams(),i=SYNO.SDS.S2S.GenGetServerParams();this.module.appWin.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:[t,i]},callback:function(e,s,n,o){var a={clients:[],enable:!1,status:SYNO.SDS.S2S.STATUS_UNKNOWN,isMultiClient:!0};if(this.module.appWin.clearStatus(),!e||!s)return SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.requestServerInfo: sendWebAPI fail"),void this.module.appWin.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));SYNO.SDS.S2S.handleWebApiData(s.result,t,(function(e,t){e&&e.data?a.clients=e.data.clients:e.error&&e.error.code===SYNO.SDS.S2S.ERRCODE_NO_CONFIG&&e.error.code===SYNO.SDS.S2S.ERRCODE_CONFIG_EMPTY||SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.requestServerInfo: get clients fail")}),this),SYNO.SDS.S2S.handleWebApiData(s.result,i,(function(e,t){e&&e.data?(a.enable=e.data.enable,a.status=e.data.status,a.isMultiClient=e.data.is_multi_client):SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.requestServerInfo: get server config fail")}),this),this.setS2SValues(a),this.doLayout()},scope:this})}},getS2SServerStatusString:function(e){switch(e){case SYNO.SDS.S2S.STATUS_SYNCING:return'<span class="green-status">'+_T("s2s","s2s_lbl_status_sync")+"</span>";case SYNO.SDS.S2S.STATUS_IDLE:return'<span class="green-status">'+_T("s2s","s2s_lbl_status_idle")+"</span>";default:return"-"}},setS2SValues:function(e){if(e){var t=this.getS2SServerStatusString(e.status);this.getForm().setValues([{id:this.s2sStatusId,value:t},{id:this.s2sPairLstId,value:Ext.util.Format.ellipsis(Ext.pluck(e.clients,"name").join(", "),50)}]),Ext.getCmp(this.s2sResetBtnId).setVisible(e.enable),Ext.getCmp(this.s2sPairLstId).setVisible(e.enable),this.isMultiClient=e.isMultiClient,e.enable&&!e.isMultiClient?(Ext.getCmp(this.s2sResetDescId).setVisible(!0),Ext.getCmp(this.s2sUpgradeDescId).setVisible(!0)):(Ext.getCmp(this.s2sResetDescId).setVisible(!1),Ext.getCmp(this.s2sUpgradeDescId).setVisible(!1)),e.isMultiClient?Ext.getCmp(this.s2sResetBtnId).setText(_T("s2s","s2s_btn_cancel_sharepair")):Ext.getCmp(this.s2sResetBtnId).setText(_T("common","alt_reset"))}else SYNO.Debug("SYNO.SDS.S2S.ServerPanel.setValues")},resetS2SPairInfo:function(){if(this.isMultiClient){var e=new SYNO.SDS.S2S.PairDialog({module:this.module,appWin:this.module.appWin,owner:this.module.appWin});this.mon(e,"close",this.requestS2SServerInfo,this),e.show()}else this.module.appWin.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_cfm_upgrade_reset"),(function(e){"yes"===e&&this.sendWebAPI(SYNO.SDS.S2S.GenDelPairParams({callback:function(e,t,i,s){e?this.requestS2SServerInfo():this.module.appWin.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:t}))},scope:this}))}),this)},showS2STasks:function(){this.s2sClientDialog||(this.s2sClientDialog=new SYNO.SDS.S2S.ClientDialog({module:this.module,appWin:this.module.appWin,owner:this.module.appWin}),this.s2sClientDialog.show(),this.mon(this.s2sClientDialog,"close",(()=>{this.s2sClientDialog=null}),this))}}),Ext.ns("SYNO.SDS.AdminCenter.FileService"),Ext.define("SYNO.SDS.AdminCenter.FileService.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.app=e.app,this.panel=new SYNO.SDS.AdminCenter.FileService.TabPanel({module:this})},getHelpTopic:function(){if("win"===this.panel.getActiveTab().itemId)return SYNO.API.GetKnownAPI("SYNO.Core.FileServ.SMB")?"SYNO.SDS.SMBService.Instance":void 0},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"win":if(SYNO.API.GetKnownAPI("SYNO.Core.FileServ.SMB"))return;return"AdminCenter/file_winmacnfs_desc.html";case"afp":return"AdminCenter/file_winmacnfs_mac.html";case"nfs":return"AdminCenter/file_winmacnfs_nfs.html";case"ftp":return"AdminCenter/file_ftp_desc.html";case"rsync":return"AdminCenter/file_rsync.html";case"adv":return"AdminCenter/file_service_discovery.html";default:return"AdminCenter/file_desc.html"}},getPanel:function(){return this.panel},launchDialog:function(e){e&&e.tab&&"adv"===e.tab&&!0===e.launchS2SDialog&&this.panel.getComponent("adv").showS2STasks()},setActivateParams:function(e){e&&e.tab&&(this.panel.setActiveTab(e.tab),this.launchDialog(e),"ftp"===e.tab&&!0===e.launchAdvanceDialog&&this.panel.getComponent("ftp").onFtpAdvSettingBtnClick())},activate:function(e){this.setActivateParams(e),this.panel.loadAllForm(),e&&e.tab&&this.panel.setActiveTab(e.tab)},focus:function(e){this.launchDialog(e)},deactivate:function(){for(var e=this.panel.getAllForms(),t=0;t<e.length;t++)if(e[t].isDirty())return!1;return!0},confirmLostChangeSave:function(){return new Promise(function(e,t){this.panel.applyHandler(),this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t}.bind(this))},confirmLostChangeDontSave:function(){},confirmLostChangeCancel:function(){}}),Ext.define("SYNO.SDS.AdminCenter.FileService.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){this.module=e.module,this.smbTab=null,this.afpTab=null,this.nfsTab=null,this.ftpTab=null,this.rsyncTab=null,this.advTab=new SYNO.SDS.AdminCenter.FileService.AdvancedTab({itemId:"adv",module:this.module});var t={applyDirtyOnly:!0,loadDirtyOnly:!0,items:[]};SYNO.API.GetKnownAPI("SYNO.Core.FileServ.SMB")?this.smbTab=new SYNO.SDS.SMBService.SMB.WinTab({itemId:"win",module:this.module}):this.smbTab=new SYNO.SDS.AdminCenter.FileService.FakeWinTab({itemId:"win"}),t.items.unshift(this.smbTab),"yes"!==_D("support_hyper_converged")&&(this.afpTab=new SYNO.SDS.AdminCenter.FileService.AfpTab({itemId:"afp",module:this.module}),t.items.push(this.afpTab)),"yes"===_D("supportNFS","no")&&(SYNO.API.GetKnownAPI("SYNO.Core.FileServ.NFS")?this.nfsTab=new SYNO.SDS.AdminCenter.FileService.NfsTab({itemId:"nfs",module:this.module}):this.nfsTab=new SYNO.SDS.AdminCenter.FileService.FakeNFSTab({itemId:"nfs"}),t.items.push(this.nfsTab)),"yes"!==_D("support_hyper_converged")&&(this.ftpTab=new SYNO.SDS.AdminCenter.FileService.FtpSftpTab({itemId:"ftp",module:this.module}),t.items.push(this.ftpTab)),"yes"===_D("netbkp")&&"yes"!==_D("support_hyper_converged")&&(this.rsyncTab=new SYNO.SDS.AdminCenter.FileService.RsyncTab({itemId:"rsync",module:this.module}),t.items.push(this.rsyncTab)),t.items.push(this.advTab),t=Ext.apply(t,e),this.callParent([t])},processParams:function(e,t){if("set"===e)for(var i={api:"SYNO.Core.BandwidthControl.Protocol",method:"set",version:1},s=0;s<t.length;s++)if(!0===SYNO.ux.Utils.checkApiConsistency(i,t[s])){var n=Ext.apply({},i);n.params=SYNO.SDS.BandwidthControl.reConstructApiKey(e,"FTP",t[s].params);var o=[];if(Ext.isEmpty(n.params.policy)?this.ftpTab&&this.ftpTab.getForm().isDirty()&&(n.params.policy="disabled",o.push(n)):o.push(n),"yes"===_D("netbkp")&&"yes"!==_D("support_hyper_converged")){var a=Ext.apply({},i);a.params=SYNO.SDS.BandwidthControl.reConstructApiKey(e,"NetworkBackup",t[s].params),Ext.isEmpty(a.params.policy)?this.rsyncTab.getForm().isDirty()&&(a.params.policy="disabled",o.push(a)):o.push(a)}t.remove(t[s]),t=o.concat(t);break}return this.callParent(arguments)},onBeforeRequest:function(e){if(!1===this.callParent(arguments))return!1;for(var t=this.items,i=0;i<t.length;i++)if(t.items[i]instanceof SYNO.SDS.Utils.FormPanel&&Ext.isFunction(t.items[i].beforeRequest)&&!t.items[i].beforeRequest(e))return this.setActiveTab(i),!1;return!0},onApiSuccess:function(e,t,i){"set"===e&&(t.has_fail?this.module.confirmSaveLostReject&&this.module.confirmSaveLostReject():this.module.confirmSaveLostResolve&&this.module.confirmSaveLostResolve()),this.callParent(arguments)},processReturnData:function(e,t,i){!0!==t.has_fail?this.callParent(arguments):this.errorHandling(t)},getAjaxCfg:function(e){return"set"===e?{timeout:18e5}:{}},errorHandling:function(e){var t=SYNO.API.Response.GetFirstError(e),i=SYNO.API.Response.GetFirstErrorIndex(e),s=_T("common","commfail");return 1903==t.code||1904==t.code||1951==t.code?(this.ftpTab.errorHandling(t.code),void this.setActiveTab("ftp")):this.rsyncTab&&this.rsyncTab.errorChecking(e,i)?(this.rsyncTab.errorHandling(t.code),void this.setActiveTab("rsync")):7003==t.code?(this.module.appWin.getMsgBox().alert(this.title,_T("error","error_smb_not_enable")),void this.setActiveTab("win")):7004==t.code?(this.module.appWin.getMsgBox().alert(this.title,_T("error","error_afp_not_enable")),void this.setActiveTab("afp")):(SYNO.API.Errors.core[t.code]&&(s=SYNO.API.Errors.core[t.code]),void this.module.appWin.getMsgBox().alert(this.title,s))},confirmEnableAFPPromise:function(){var e=this.afpTab.getForm().findField("enable_afp"),t=!(!e.isDirty()||!e.checked);return new Promise(function(e,i){t?(this.setActiveTab("afp"),this.module.appWin.getMsgBox().confirm("",_T("service","enable_afp_warning")).then((t=>{"confirm"===t?e():i()}))):e()}.bind(this))},confirmDisableAvahiPromise:function(){var e=this.advTab.getForm().findField("enable_avahi").getValue(),t=this.advTab.getForm().findField("enable_avahi").isDirty();return new Promise(function(i,s){!e&&t?this.module.appWin.getMsgBox().confirm("",_T("service","disable_avahi_warning")).then((e=>{"confirm"===e?i():s()})):i()}.bind(this))},confirmDisableSMBAFPPromise:function(){var e=this.smbTab.getForm().findField("enable_samba"),t=this.afpTab?this.afpTab.getForm().findField("enable_afp"):{checked:!1},i=!(!e.isDirty()||e.checked),s=this.afpTab&&t.isDirty()&&!t.checked,n=this.advTab.getForm().findField("enable_smb_time_machine"),o=this.afpTab?this.advTab.getForm().findField("enable_afp_time_machine"):{checked:!1,setValue:Ext.emptyFn},a=this.advTab.getForm().findField("enable_avahi").getValue(),r="";return new Promise(function(l,d){(i||s)&&(r=_T("service","confirm_disable_smb_afp_tm_mdns"),r=i&&n.checked&&s&&o.checked?String.format(r,_T("helptoc","winmacnfs_win")+"/"+_T("helptoc","winmacnfs_mac")):i&&n.checked?String.format(r,_T("helptoc","winmacnfs_win")):s&&o.checked?String.format(r,_T("helptoc","winmacnfs_mac")):""),a&&(i&&n.checked||s&&o.checked)?this.module.appWin.getMsgBox().confirm("",r).then((i=>{"confirm"===i?(n.setValue(!!e.checked&&n.checked),o.setValue(!!t.checked&&o.checked),l()):d()})):l()}.bind(this))},confirmSMBTMConfigPromise:function(){var e=this.advTab.getForm().findField("enable_smb_time_machine"),t=this.advTab.enableSmbOpLock,i=this.advTab.enableSmb2Lease,s=this.advTab.enableSmbDurable,n=this.advTab.smbMaxProtocol;return new Promise(function(o,a){!e.isDirty()||!e.checked||t&&i&&s&&3==n?o():this.module.appWin.getMsgBox().confirm("",_T("service","enable_smb_tm_mdns_warning")).then((e=>{"confirm"===e?o():a()}))}.bind(this))},confirmWSTransferPromise:function(){var e=this.smbTab.getForm().findField("enable_samba"),t=!(!e.isDirty()||e.checked),i=this.smbTab.getForm().findField("enable_wstransfer");return new Promise(function(e,s){t&&i.checked?this.module.appWin.getMsgBox().confirm("",_T("service","confirm_disable_smb_wstransfer"),(function(t){"yes"===t?(i.setValue(!1),e()):s()}),this):e()}.bind(this))},getFeasibilityCheckMsg:function(e,t){let i="";return Ext.each(t,(function(e){i+=String.format("<li>{0}</li>",SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))})),String.format("{0}<ul>{1}</ul>",e,i)},confirmACLBypassTraversePromise:function(){var e=this.advTab.getForm().findField("enable_bypass_traverse_checking").getValue(),t=this.advTab.getForm().findField("enable_bypass_traverse_checking").isDirty();return new Promise(function(i,s){t?this.sendWebAPI({api:"SYNO.Core.ACL",method:"validate_set_bypass_traverse",params:{enable:e},version:1,scope:this,callback:function(t,n,o){if(!t){let e=SYNO.API.Response.GetFirstError(n);const t=SYNO.API.Errors.core[e.code]||_T("common","error_system");return this.findWindow().getMsgBox().alert(null,t),void s()}if(n&&Ext.isArray(n.hard_reasons)&&n.hard_reasons.length>0){var a=e?_T("service","enable_bypass_traverse_hard_check_fail"):_T("service","disable_bypass_traverse_hard_check_fail");return this.findWindow().getMsgBox().alert(null,this.getFeasibilityCheckMsg(a,n.hard_reasons)),void s()}n&&Ext.isArray(n.soft_reasons)&&n.soft_reasons.length>0?this.findWindow().getMsgBox().confirm(null,this.getFeasibilityCheckMsg(_T("service","bypass_traverse_soft_check_fail"),n.soft_reasons),(function(e){"yes"===e?i():s()}),this):i()}}):i()}.bind(this))},applyHandler:function(e,t){this.confirmDisableAvahiPromise().then(this.confirmEnableAFPPromise.bind(this)).then(this.confirmDisableSMBAFPPromise.bind(this)).then(this.confirmSMBTMConfigPromise.bind(this)).then(this.confirmWSTransferPromise.bind(this)).then(this.confirmACLBypassTraversePromise.bind(this)).then(this.applyAllForm.bind(this)).catch(Ext.emptyFn)}}),Ext.namespace("SYNO.SDS.Share"),Ext.define("SYNO.SDS.AdminCenter.User.ShareGrid",{extend:"SYNO.ux.GridPanel",WEBAPI_PARAM_SHARE_TYPE:["dec","local","usb","sata","cluster","c2","cold_storage","worm"],WEBAPI_PARAM_ADDITIONAL:["hidden","encryption","is_aclmode"],constructor:function(e){var t=e.owner.newuser;this.owner=e.owner,this.isCopyMode=e.owner.isCopyMode,this.showHomesWarning=!0;var i=["is_aclmode","is_readonly","is_writable","is_deny","name","preview","inherit","is_custom","share_path","is_unite_permission",{name:"force_readonly_reason",defaultValue:void 0},"is_mask"];"yes"===_D("support_s2s","no")&&i.push("is_sync_share");var s="",n="";!this.isCopyMode&&t?(s="list_by_group",n="local_group"):(s="list_by_user",n=e.owner.authType+"_user");var o=new SYNO.API.JsonStore({autoDestroy:!0,appWindow:e.appWin,api:"SYNO.Core.Share.Permission",method:s,version:1,baseParams:{user_group_type:n,share_type:this.WEBAPI_PARAM_SHARE_TYPE,additional:this.WEBAPI_PARAM_ADDITIONAL},listeners:{exception:{scope:e.owner,fn:SYNO.SDS.AdminCenter.User.UserDialog.prototype.onStoreException},load:{scope:this,fn:this.onLoad}},root:"shares",idProperty:"name",totalProperty:"total",fields:i}),a=new SYNO.ux.EnableColumn({header:_T("share","share_permission_readonly"),dataIndex:"is_readonly",width:SYNO.SDS.AdminCenter.User.UserDialog.prototype._defaultColumnWidth,align:"center",ownerGrid:this,isIgnore:function(e,t){return!0===t.get("is_mask")||this.ownerGrid.isAdminGroupMember()&&t.get("is_aclmode")},renderer:function(e,t,i){return(!0===i.get("is_mask")||this.ownerGrid.isAdminGroupMember()&&i.get("is_aclmode"))&&(e="disabled"),SYNO.SDS.Share.renderCheckBox.call(this,e,t,i)}}),r=new SYNO.ux.EnableColumn({header:_T("share","share_permission_writable"),dataIndex:"is_writable",width:SYNO.SDS.AdminCenter.User.UserDialog.prototype._defaultColumnWidth,align:"center",isIgnore:function(e,t){return!0===t.get("is_mask")},renderer:function(e,t,i){return!0===i.get("is_mask")?SYNO.SDS.Share.renderCheckBox.call(this,"disabled",t,i):SYNO.ux.EnableColumn.prototype.renderer.call(this,e,t,i)}}),l=new SYNO.ux.EnableColumn({header:_T("share","share_permission_none"),dataIndex:"is_deny",width:SYNO.SDS.AdminCenter.User.UserDialog.prototype._defaultColumnWidth,align:"center",isIgnore:function(e,t){return!0===t.get("is_mask")},renderer:function(e,t,i){return!0===i.get("is_mask")?SYNO.SDS.Share.renderCheckBox.call(this,"disabled",t,i):SYNO.ux.EnableColumn.prototype.renderer.call(this,e,t,i)}}),d=e.hideCustomColumn;d=(d=!this.isCopyMode&&(d||t))||"yes"===_D("usbstation","no")||!_S("is_admin");var c=new SYNO.SDS.Share.CustomColumn({module:e.module,owner:e.owner,ownerGrid:this,dataIndex:"is_custom",hidden:d,isLockCustomSetting:!!this.isCopyMode,applyCallback:function(){this.getStore().load({params:{name:this.owner.username}})},applyTarget:this}),h=new Ext.grid.ColumnModel([new SYNO.SDS.Share.InfoColumn({dataIndex:"is_unite_permission",width:50,hidden:t,getHeaderAriaAttr:function(){return'aria-label="'+_T("share","unite_permission_description")+'"'}}),{id:"name",header:_T("share","share_name"),dataIndex:"name",tooltip:_T("share","share_name"),width:100,renderer:function(e,t){return e&&(t.attr=String.format('ext:qtip="{0}"',e)),e}},{header:_T("share","share_preview"),id:"preview",dataIndex:"preview",useHtmlEncodeRender:!1,tooltip:_T("share","share_preview"),width:120},new SYNO.SDS.AdminCenter.Share.Utils.PermissionColumn({header:_T("share","share_inherit"),dataIndex:"inherit",align:"left",width:158,tooltip:_T("share","share_inherit"),hidden:_S("diskless")}),l,r,a,c]),u='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("share","share_privileges_priority"),p={title:_T("share","share_rights"),cm:h,ds:o,cls:"without-dirty-red-grid",plugins:[a,r,l,c,new SYNO.ux.plugin.GroupHeaderGrid({groups:[{header:_T("share","share_user_permission"),dataIndex:["is_deny","is_writable","is_readonly","is_custom"]}]})],autoExpandColumn:"name",enableColLock:!1,enableHdMenu:!1,enableColumnMove:!1,colRo:a,colRw:r,colNa:l,colCu:c,clicksToEdit:1,loadMask:!0,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),bbar:new SYNO.ux.PageLessToolbar({store:o,doRefresh:this.doRefresh.bind(this)}),fbar:{xtype:"syno_toolbar",layout:"fit",style:"padding-top: 12px;",items:[{xtype:"syno_displayfield",htmlEncode:!1,style:"white-space: normal;",value:u,"aria-label":SYNO.ux.Utils.ConvertSingleSymbolToString(u,">",!0)}]},footerCfg:{style:"padding: 0px;"}};Ext.apply(p,e),this.callParent([p]),this.mon(this,"afterrender",this.defineShareGridBehaviors,this),this.mon(l,"click",(function(e,t,i,s){var n=t.getStore().getAt(i);this.showHomesWarning&&"homes"===n.id&&!0===n.get("is_deny")&&!0===n.get("is_aclmode")&&(this.appWin.getMsgBox().alert(this.title,_T("share","warn_deny_rule_homes")),this.showHomesWarning=!1)}),this)},doRefresh:function(){if(this.owner.newuser||!this.isChanged())if(this.owner.newuser){let e=[];this.owner.groupGrid.getStore().each((function(t){!0===t.get("is_member")&&e.push(t.get("name"))})),this.getStore().load({params:{name:e}})}else this.getStore().load({params:{name:this.owner.username}});else this.owner.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?(this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{params:this.getWebAPI(this.owner.username)},callback:function(e,t){if(this.owner.clearStatusBusy(),e&&!t.has_fail)this.getStore().commitChanges(),this.doRefresh();else{let e=SYNO.API.Response.GetFirstError(t);this.owner.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})):(this.getStore().rejectChanges(),this.doRefresh())}),this)},initComponent:function(){this.callParent(arguments),this.mon(this,"headerclick",(function(e,t,i){this.getStore().suspendEvents(!1)}),this)},defineShareGridBehaviors:function(){this.colRo.checkSelectAll(this.getStore()),this.colRw.checkSelectAll(this.getStore()),this.colNa.checkSelectAll(this.getStore()),this.mon(this,"cellclick",this.onGridCellClick,this),this.mon(this.getSelectionModel(),"spacepressed",this.onGridCellSpacePressed,this),this.mon(this,"headerspace",(function(e){var t=this.getColumnModel(),i=t.findColumnIndex(e.dataIndex),s=t.getColumnId(i);this.onGridHeaderClick.call(this,t.getColumnById(s))}),this),this.mon(this,"headerclick",(function(e,t,i){var s=e.getColumnModel(),n=s.getColumnId(t);this.onGridHeaderClick.call(this,s.getColumnById(n))}),this),"local"===this.owner.authType&&this.mon(this,"activate",(function(){if(this.isAdminGroupMember()){var e=this.getStore();e.suspendEvents(!1),e.each((function(e){e.get("is_aclmode")&&this.restorePermission(e,"is_readonly")}),this),this.checkPreviewAll(),e.resumeEvents()}this.getView().refresh()}),this)},onLoad:function(e,t,i){e.suspendEvents(!1),!this.isCopyMode&&this.owner.newuser&&Ext.each(t,(function(e){e.set("inherit",SYNO.SDS.AdminCenter.Share.Utils.convertBoolPermissions(e)),e.set("is_deny",!1),e.set("is_writable",!1),e.set("is_readonly",!1),e.set("is_custom",!1)}),this),this.checkPreviewAll(),e.commitChanges(),e.resumeEvents(),this.getView().refresh()},restorePermission:function(e,t){var i=e.getChanges();i.hasOwnProperty(t)&&e.set(t,!i[t])},onGridCellSpacePressed:function(e,t){var i=e.grid,s=i.getStore().indexOf(e.getSelected()),n=e.getColIdx();0<=n&&this.onGridCellClick(i,s,n,t)},onGridCellClick:function(e,t,i,s){var n=e.getStore().getAt(t),o=e.getColumnModel().getDataIndex(i);if(!_S("is_admin")&&"is_writable"===o&&n.getChanges().hasOwnProperty("is_writable")&&this.owner.sharePermLimited.hasOwnProperty(n.data.name)&&!this.owner.sharePermLimited[n.data.name]&&!0===n.get("is_writable"))return n.set("is_writable",!1),void this.owner.getMsgBox().alert(this.title,_T("error","error_privilege_not_enough"));(function(e){return"is_readonly"===e||"is_writable"===e||"is_deny"===e})(o)&&(!0===n.get(o)?function(t,i){"is_readonly"!==t&&(i.set("is_readonly",!1),e.colRo.checkSelectAll(e.getStore())),"is_writable"!==t&&(i.set("is_writable",!1),e.colRw.checkSelectAll(e.getStore())),"is_deny"!==t&&(i.set("is_deny",!1),e.colNa.checkSelectAll(e.getStore())),"is_custom"!==t&&i.set("is_custom",!1)}(o,n):this.restorePermission(n,"is_custom")),this.checkPreview(n)},onGridHeaderClick:function(e){e.box_el&&(e.box_el.hasClass("syno-ux-cb-checked")?("is_readonly"!==e.dataIndex&&(this.colRo.box_el.removeClass("syno-ux-cb-checked"),this.colRo.onSelectAll()),"is_writable"!==e.dataIndex&&(this.colRw.box_el.removeClass("syno-ux-cb-checked"),this.colRw.onSelectAll()),"is_deny"!==e.dataIndex&&(this.colNa.box_el.removeClass("syno-ux-cb-checked"),this.colNa.onSelectAll()),this.getStore().each((function(e){e.set("is_custom",!1)}),this)):this.getStore().each((function(e){this.restorePermission(e,"is_custom")}),this)),this.checkPreviewAll(),this.getStore().resumeEvents(),this.getView().refresh()},checkPreview:function(e){e.set("preview",SYNO.SDS.AdminCenter.Share.Utils.colorizePermission(this.getFinalPermission(e)))},isChanged:function(){return 0!==this.getStore().getModifiedRecords().length},isAdminGroupMember:function(){if(Ext.isBoolean(this.owner.isAdminGroupMember))return this.owner.isAdminGroupMember;var e=null;return this.owner.groupGrid.store.each((function(t){if("administrators"===t.get("name").toLowerCase())return e=t,!1})),null!==e&&!0===e.get("is_member")},getFinalPermission:function(e){return"na"===e.data.inherit?"na":"cu"===e.data.inherit?e.data.is_deny?"na":"cu":"rw"===e.data.inherit?e.data.is_deny?"na":e.data.is_custom?"cu":"rw":e.data.is_deny?"na":e.data.is_custom?"cu":e.data.is_writable?"rw":"-"!==e.data.inherit||e.data.is_readonly?this.isAdminGroupMember()&&e.data.is_aclmode?"rw":"ro":"homes"===e.data.name?"default":"na"},getOpenConfig:function(){return{userName:this.owner.username,userType:"user"}},getWebAPI:function(e){var t=[];return Ext.each(this.getStore().getModifiedRecords(),(function(e){t.push({name:e.data.name,is_readonly:e.data.is_readonly,is_writable:e.data.is_writable,is_deny:e.data.is_deny,is_custom:e.data.is_custom})})),0===t.length?[]:[{api:"SYNO.Core.Share.Permission",method:"set_by_user_group",version:1,params:{name:e||this.owner.username,user_group_type:this.owner.authType+"_user",permissions:t}}]},checkPreviewAll:function(){this.getStore().each((function(e){this.checkPreview(e)}),this)},getShareInfoForS2S:function(){var e=[];return Ext.each(this.getStore().getModifiedRecords(),(function(t){e.push({name:t.data.name,is_sync_share:t.data.is_sync_share,permissions:[{is_readonly:t.data.is_readonly,is_deny:t.data.is_deny,is_writable:t.data.is_writable,is_custom:t.data.is_custom}]})})),e}}),Ext.define("SYNO.SDS.AdminCenter.User.GenPasswordDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.passwordChecker=e.passwordChecker,this.user_account=this.passwordChecker.getInfo("getUserAcc"),this.user_fullname=this.passwordChecker.getInfo("getUserDesc"),this.panel=this.createPanel(),this.form=this.panel.getForm();var t={title:_T("passwd","passwd_generator"),width:300,height:150,resizable:!1,buttons:[{text:_T("common","cancel"),scope:this,handler:this.close},{text:_T("common","commit"),btnStyle:"blue",scope:this,handler:this.apply}],items:[this.panel]};Ext.apply(t,e),this.callParent([t])},createPanel:function(){var e,t;for(e=0;e<100&&(t=this.genPasswd(),!0!==this.passwordChecker.isPasswordValid(t,this.user_account,this.user_fullname));e++);var i={border:!1,items:[{xtype:"syno_textfield",width:200,hideLabel:!0,value:t,name:"random_passwd"}]};return SYNO.LayoutConfig.fill(i),new Ext.form.FormPanel(i)},applyPasswd:function(e){this.passwordChecker.setValue("getPasswd",e),this.passwordChecker.setValue("getPasswdConfirm",e)},apply:function(){var e=this.form.findField("random_passwd").getValue();this.applyPasswd(e),this.owner.userForm.findField("password").hidePasswordStrength(),this.close()},genPasswd:function(){var e,t,i=[],s=6,n="abcdefghijklmnopqrstuvwxyz",o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a="~`!@#$%^&*()-_+={[}]|\\:;\"'<,>.?/",r="1234567890",l=n+o+a+r,d=0,c=function(e,t){return e.substr(t,1)};const h=e=>SYNO.Encryption.RandomUint8(e-1);for(!0===this.passwordChecker.passwordPolicy.mixed_case&&(i.push(c(o,h(o.length))),i.push(c(n,h(n.length)))),!0===this.passwordChecker.passwordPolicy.included_numeric_char&&i.push(c(r,h(r.length))),!0===this.passwordChecker.passwordPolicy.included_special_char&&i.push(c(a,h(a.length))),!0===this.passwordChecker.passwordPolicy.min_length_enable&&(s=this.passwordChecker.passwordPolicy.min_length),d=i.length;d<s;d++)i[d]=c(l,h(l.length));for(d=s;d>0;d--)t=h(d),e=i[d-1],i[d-1]=i[t],i[t]=e;return i.join("")}}),Ext.define("SYNO.SDS.AdminCenter.User.ChangePasswordDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.passwordChecker=e.passwordChecker,this.ori_name=e.ori_name,this.name=e.name,this.desc=e.desc,this.hideRandPwdBtn=void 0!==this.passwordChecker&&(!1===this.passwordChecker.passwordPolicy.strong_password_enable||"admin"===this.ori_name);var t=this.createPanel();this.userForm=t.getForm();var i={title:String.format(_T("user","change_password_title"),this.ori_name),width:418,height:this.hideRandPwdBtn?219:247,resizable:!1,layout:"fit",buttons:[{text:_T("common","cancel"),handler:this.close,scope:this},{text:_T("common","save"),btnStyle:"blue",handler:this.onApply,scope:this}],items:[t]};Ext.apply(i,e),this.callParent([i])},createPanel:function(){var e={labelWidth:170,padding:0,cls:"change-passwd-panel",items:[{xtype:"syno_button",text:_T("passwd","passwd_gen_title"),style:"margin-bottom: 12px;",hidden:this.hideRandPwdBtn,scope:this,handler:function(){new SYNO.SDS.AdminCenter.User.GenPasswordDialog({owner:this,passwordChecker:this.passwordChecker}).open()}},{xtype:"syno_passwordfield","aria-label":_T("user","user_passwd"),fieldLabel:_T("user","user_passwd"),maxLength:127,width:200,name:"password",updateWhenRender:!1,startValidate:!0,validator:this.passwordChecker?this.passwordChecker.isStrongValidator.createDelegate(this.passwordChecker):Ext.emptyFn,listeners:{afterrender:function(){this.hidePasswordStrength()},password_strength_get:function(){this.showPasswordStrength()}}},{xtype:"syno_textfield",textType:"password_confirm",fieldLabel:_T("user","user_repswd"),maxLength:127,name:"confirmpassword",width:200,labelHtmlEncode:!1,confirmFor:"password",validator:function(e){return e===this.ownerCt.getForm().findField(this.confirmFor).getValue()||_T("pppoe","error_password")}},{xtype:"hidden",name:"name",value:this.name},{xtype:"hidden",name:"description",value:this.desc}]},t=new SYNO.SDS.Utils.FormPanel(e);return this.passwordChecker&&(this.passwordChecker.getForm=function(){return t.getForm()}),t},onApply:function(){var e=this;if(!this.userForm.isValid())return this.getMsgBox().alert(e.title,_T("common","forminvalid")),!1;e.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.User",method:"set",version:1,params:{name:e.ori_name,password:this.userForm.findField("password").getValue()},encryption:["password"],callback:function(t,i){e.clearStatusBusy(),t?(e.updateUserInfo(i.password_last_change),e.close()):e.getMsgBox().alert(e.title,SYNO.API.getErrorString(i))}})},updateUserInfo:function(e){let t="";if(0===e)t=String.format('<span class="orange-status">{0}</span>',_T("user","user_acnt_mustchange"));else if(0<e){let i=new Date(24*e*60*60*1e3);t=_T("personal_settings","password_last_changed")+_T("common","colon")+" "+SYNO.SDS.DateTimeFormatter(i,{type:"date"})}else t=_T("personal_settings","password_last_changed")+_T("common","colon")+" -";this.owner.userForm.findField("password_last_change").setValue(t),this.owner.userFormPanel.fireEvent("passwordchange",this.ori_name),this.owner.fireEvent("userchange",this.ori_name)}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.EditAppPrivPanel",{extend:"SYNO.ux.GridPanel",pageSize:20,constructor:function(e){!0===e.isLockCustomSetting?this.isLockCustomSetting=!0:this.isLockCustomSetting=!1,this.appRules=[];let t=function(t){return"SYNO.Desktop"===t&&"group"===e.entity_type&&0<=["administrators","users"].indexOf(e.entity_name)};this.store=new Ext.data.JsonStore({autoDestroy:!0,fields:["name","app_id","supportIP"]}),this.allowCol=new SYNO.ux.EnableColumn({header:_T("app_privilege","allow_privilege"),dataIndex:"allow",disableSelectAll:!1,width:120,align:"center",id:"allow"}),this.denyCol=new SYNO.ux.EnableColumn({header:_T("app_privilege","deny_privilege"),dataIndex:"deny",disableSelectAll:!1,width:120,align:"center",isIgnore:function(e,i){return t(i.get("app_id"))},renderer:function(e,i,s){return t(s.get("app_id"))?this.disableRenderer(e,i,s):SYNO.ux.EnableColumn.prototype.renderer.call(this,e,i,s)},id:"deny"}),this.advCol=new SYNO.SDS.AdminCenter.AppRulePrivileges.CustomColumn({entity_type:e.entity_type,entity_name:e.entity_name,module:e.module,owner:e.owner,ownerGrid:this,dataIndex:"custom",disableSelectAll:!0,isLockCustomSetting:this.isLockCustomSetting,width:120,id:"custom",hidden:e.hide_custom});var i=function(e){return"allow"===e?_T("app_privilege","allow_privilege"):"deny"===e?'<span class="red-status">'+_T("app_privilege","deny_privilege")+"</span>":"custom"===e?_T("app_privilege","grant_by_ip"):void 0},s=[this.allowCol,this.denyCol,this.advCol];e.showPreview&&"user"===e.entity_type&&s.push(new SYNO.ux.plugin.GroupHeaderGrid({groups:[{header:_T("share","share_user_permission"),dataIndex:["allow","deny","custom"]}]}));var n=Ext.apply({module:this,header:!1,border:!1,height:404,cls:"without-dirty-red-grid",ds:this.store,cm:new Ext.grid.ColumnModel({columns:[{id:"name",header:_T("common","name"),dataIndex:"name",width:168,scope:this,renderer:function(e,t){return e&&(t.attr=String.format('ext:qtip="{0}"',e)),e}},{header:_T("share","share_preview"),id:"preview",dataIndex:"preview",width:120,hidden:!e.showPreview,renderer:i},{header:_T("share","share_inherit"),id:"inherit",dataIndex:"inherit",width:180,hidden:!e.showPreview,renderer:i},this.allowCol,this.denyCol,this.advCol]}),plugins:s,autoExpandColumn:"name",enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),bbar:new SYNO.ux.PageLessToolbar({store:this.store,doRefresh:this.doRefresh.bind(this)}),fbar:{xtype:"syno_toolbar",layout:"fit",style:"padding-top: 12px;",items:[{xtype:"syno_displayfield",htmlEncode:!1,style:"white-space: normal;",value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("app_privilege","affected_by_group")}]},footerCfg:{style:"padding: 0px;"}},e);this.callParent([n]),this.mon(this,"afterrender",this.definePrivGridBehaviors,this),this.mon(this,"activate",this.onLoadPrivilege,this,{single:!0})},definePrivGridBehaviors:function(){this.mon(this,"cellclick",this.onGridCellClick,this),this.mon(this.getSelectionModel(),"spacepressed",this.onGridCellSpacePressed,this),this.mon(this,"headerclick",(function(e,t,i){var s=e.getColumnModel(),n=s.getColumnId(t);this.onGridHeaderClick.call(this,s.getColumnById(n))}),this),this.mon(this,"headerspace",(function(e){var t=this.getColumnModel(),i=t.findColumnIndex(e.dataIndex),s=t.getColumnId(i);this.onGridHeaderClick.call(this,t.getColumnById(s))}),this)},activate:function(){this.onLoadPrivilege()},doRefresh:function(){this.owner.newuser||this.owner.newgroup||!this.isChanged()?this.onLoadPrivilege():this.owner.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?(this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{stopwhenerror:!0,params:this.getWebAPI()},callback:function(e,t,i){if(this.owner.clearStatusBusy(),e&&!t.has_fail)this.store.commitChanges(),this.doRefresh();else{let e=SYNO.API.Response.GetFirstError(t);this.owner.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})):(this.store.rejectChanges(),this.doRefresh())}),this)},onLoadPrivilege:function(){this.onBeforeLoadApp(),this.loadRules()},loadRules:function(){var e=[];if(this.isRuleReady=!1,Ext.isDefined(this.entity_name)&&(e=e.concat([{api:"SYNO.Core.AppPriv.Rule",version:1,method:"get",params:{entity_type:this.entity_type,entity_name:this.entity_name}}])),this.showPreview){var t={};"user"===this.entity_type&&(t=Ext.isDefined(this.entity_name)?{username:this.entity_name,include_user:!1}:{groups:this.previewGroups,is_group_name:void 0===this.isGroupName||this.isGroupName,include_everyone:!0}),e=e.concat({api:"SYNO.Core.AppPriv.App",version:2,method:"preview",params:t})}this.owner.sendWebAPI({compound:{stopwhenerror:!0,params:e},scope:this,callback:function(e,t,i,s){if(!e||t.has_fail)return this.owner.clearStatusBusy(),void this.owner.getMsgBox().alert(this.title,_T("common","error_system"));if(Ext.isDefined(this.entity_name)){var n=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.AppPriv.Rule","get");this.appRules=n.rules}if(this.showPreview){var o=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.AppPriv.App","preview");this.onRenderInherit(o.applications)}this.isRuleReady=!0,this.onRenderPriv()}})},getAppRules:function(){return this.isRuleReady?this.appRules:[]},onGridCellSpacePressed:function(e,t){var i=e.grid,s=i.getStore().indexOf(e.getSelected()),n=e.getColIdx();0<=n&&this.onGridCellClick(i,s,n,t)},onGridCellClick:function(e,t,i,s){var n=e.getStore().getAt(t),o=e.getColumnModel().getDataIndex(i);(function(e){return"allow"===e||"deny"===e})(o)&&(!0===n.get(o)?function(t,i){"allow"!==t&&(i.set("allow",!1),e.allowCol.checkSelectAll(e.getStore())),"deny"!==t&&(i.set("deny",!1),e.denyCol.checkSelectAll(e.getStore())),"custom"!==t&&i.set("custom",!1)}(o,n):this.restorePermission(n,"custom")),this.checkPreview(n)},restorePermission:function(e,t){var i=e.getChanges();i.hasOwnProperty(t)&&e.set(t,!i[t])},onGridHeaderClick:function(e){e.box_el&&(e.box_el.hasClass("syno-ux-cb-checked")?("allow"!==e.dataIndex&&(this.allowCol.box_el.removeClass("syno-ux-cb-checked"),this.allowCol.onSelectAll()),"deny"!==e.dataIndex&&(this.denyCol.box_el.removeClass("syno-ux-cb-checked"),this.denyCol.onSelectAll()),this.getStore().each((function(e){e.set("custom",!1)}),this)):this.getStore().each((function(e){this.restorePermission(e,"custom")}),this)),this.checkPreviewAll()},onBeforeLoadApp:function(){this.owner.setStatusBusy(),this.appReady=!1,this.owner.sendWebAPI({api:"SYNO.Core.AppPriv.App",version:2,method:"list",params:{offset:0,limit:this.pageSize},scope:this,callback:function(e,t,i){e?this.onLoad(t):this.owner.getMsgBox().alert(this.title,_T("common","error_system"))}})},onLoad:function(e){var t,i=e.applications,s=[];for(t=0;t<i.length;t++){var n=i[t];!0===this.appFilter(n)&&s.push(n)}s.sort((function(e,t){return e.name[0]===t.name[0]?0:e.name[0]<t.name[0]?-1:1})),this.store.loadData(s),this.appReady=!0,this.onRenderPriv()},appFilter:function(e){if(e.supportIP)return!0},onRenderPriv:function(){this.appReady&&this.isRuleReady&&(this.owner.clearStatusBusy(),this.renderPrivGrid())},isChanged:function(){return 0!==this.store.getModifiedRecords().length},getWebAPI:function(){var e,t=[],i=[],s=this.store.getModifiedRecords(),n=s.length,o=[],a=function(e){return!e.get("allow")&&!e.get("deny")&&!e.get("custom")};if(0===n)return o;for(e=0;e<n;e++){var r=s[e],l={entity_type:r.get("entity_type"),entity_name:this.newname?this.newname:r.get("entity_name"),app_id:r.get("app_id")};a(r)?t.push(l):(r.get("allow")?l.allow_ip=["0.0.0.0"]:l.deny_ip=["0.0.0.0"],i.push(l))}return t.length>0&&o.push({api:"SYNO.Core.AppPriv.Rule",version:1,method:"delete",params:{rules:t}}),i.length>0&&o.push({api:"SYNO.Core.AppPriv.Rule",version:1,method:"set",params:{rules:i}}),o},onRenderInherit:function(e){this.store.suspendEvents(!1);var t,i,s=this.store.getCount(),n=e.length;for(t=0;t<s;t++){var o=this.store.getAt(t),a=o.json.app_id;for(o.set("inherit",null),i=0;i<n;i++)a===e[i].app_id&&o.set("inherit",e[i].privilelge)}this.checkPreviewAll(),this.store.commitChanges(),this.store.resumeEvents(),this.getView().refresh()},renderPrivGrid:function(){this.store.suspendEvents(!1);var e,t,i=this.store.getCount(),s=this.appRules;for(e=0;e<i;e++){var n=this.store.getAt(e),o=n.json.app_id;for(n.set("entity_type",this.entity_type),n.set("entity_name",this.entity_name),n.set("app_id",o),n.set("allow",!1),n.set("deny",!1),n.set("custom",!1),t=0;t<s.length;t++){var a=s[t];a.app_id===o&&(1===a.allow_ip.length&&"0.0.0.0"===a.allow_ip[0]&&0===a.deny_ip.length?n.set("allow",!0):0===a.allow_ip.length&&1===a.deny_ip.length&&"0.0.0.0"===a.deny_ip[0]?n.set("deny",!0):n.set("custom",!0))}}this.allowCol.checkSelectAll(this.getStore()),this.denyCol.checkSelectAll(this.getStore()),this.checkPreviewAll(),this.store.commitChanges(),this.store.resumeEvents(),this.getView().refresh()},getFinalPermission:function(e){return"deny"==e.data.inherit?"deny":"custom"===e.data.inherit?e.data.deny?"deny":"custom":"allow"===e.data.inherit?e.data.deny?"deny":e.data.custom?"custom":"allow":e.data.deny?"deny":e.data.custom?"custom":e.data.allow?"allow":void 0},checkPreview:function(e){e.set("preview",this.getFinalPermission(e))},checkPreviewAll:function(){this.getStore().each((function(e){this.checkPreview(e)}),this)}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.DefaultPrivDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.gridPanel=new SYNO.SDS.AdminCenter.AppRulePrivileges.EditAppPrivPanel({entity_type:"everyone",entity_name:"everyone",module:e.module,owner:this,itemId:"privgrid"});var t=Ext.apply({width:800,height:470,minWidth:550,minHeight:370,title:_T("iscsitrg","iscsitrg_masking_default"),layout:"fit",items:[this.gridPanel],buttons:[{text:_T("common","cancel"),scope:this,handler:this.onCancel},{text:_T("common","save"),scope:this,btnStyle:"blue",handler:this.onSaveAppRulePriv}]},e);this.callParent([t])},isChanged:function(){return this.gridPanel.isChanged()},onCancel:function(){this.isChanged()?this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this):this.close()},onSaveAppRulePriv:function(){this.isChanged()?this.saveAppRulePriv():this.close()},saveAppRulePriv:function(){this.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!0,params:this.gridPanel.getWebAPI()},scope:this,callback:this.onSaveAppRulePrivDone})},onSaveAppRulePrivDone:function(e,t,i,s){this.clearStatusBusy(),e&&!t.has_fail?this.close():this.getMsgBox().alert(this.title,_T("common","error_system"))}}),Ext.define("SYNO.SDS.AdminCenter.User.QuotaGrid",{extend:"SYNO.ux.EditorGridPanel",constructor:function(e){this.supportShareQuota="yes"===_D("support_share_quota","no"),this.showMask=!1,this.isCopyMode=e.owner.isCopyMode,this.owner=e.owner,this.hideUsedCapacity=e.hideUsedCapacity;var t=this.createStore(),i=this.createColModel(t),s=Ext.apply({plugins:[i.getColumnById("quota_enabled")],cls:"quota-grid",autoExpandColumn:"display_name",enableHdMenu:!1,enableColumnMove:!1,clicksToEdit:1,store:t,colModel:i,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),view:new SYNO.ux.GroupingView({showGroupName:!1,getRowClass:function(e){if(this.isQuotaStatusDisabled(e.get("quota_status")))return"quota-row-disable"}.bind(this)}),bbar:new SYNO.ux.PageLessToolbar({store:t,doRefresh:this.doRefresh.bind(this)}),fbar:{xtype:"syno_toolbar",layout:"fit",style:"padding-top: 12px;",items:[{xtype:"syno_displayfield",htmlEncode:!1,style:"white-space: normal;",value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("user","quota_unconstrained_by_group")}]},footerCfg:{style:"padding: 0px;"},listeners:{beforeedit:{scope:this,fn:function(e){var t=e.record;"crash"!==t.get("status")&&t.get("target")||(e.cancel=!0)}},validateedit:{scope:this,fn:this.checkVolumeConstraint}}},e);this.callParent([s]),this.mon(this,"activate",(function(e){if(e.unmask(),e.showMask)e.mask.defer(100,e,[_T("user","edit_quota_latter")]);else if(e.owner.shareGrid&&e.owner.shareGrid.isAdminGroupMember()){var t=String.format(_T("user","edit_adminquota"),"<b>"+e.owner.userForm.findField("name").getValue()+"</b>");e.mask.defer(100,e,[t])}})),this.mon(this,"deactivate",(function(e){e.unmask()}))},isQuotaStatusDisabled:function(e){return"incompatible"===e},convertToMB:function(e,t){return"TB"===t?1024*e*1024:"GB"===t?1024*e:e},checkVolumeConstraint:function(e){var t=4194304,i=e.record,s=i.get("total"),n=null,o="";if("quota"===e.field)n=this.convertToMB(e.value,i.get("unit"));else{if("unit"!==e.field)return!1;n=this.convertToMB(i.get("quota"),e.value)}return n>=s?(s/=1024,o=String.format(_T("user","user_quota_limit_max_vol"),i.get("volume"),s.toFixed(2)),e.grid.owner.getMsgBox().alert(_T("user","error_quota_set"),o),!1):!(i.get("limit_4T")&&n>=t)||(o="TB"===i.get("unit")?String.format(_JSLIBSTR("extlang","maxnumber"),"3 TB"):"GB"===i.get("unit")?String.format(_JSLIBSTR("extlang","maxnumber"),"4095 GB"):String.format(_JSLIBSTR("extlang","maxnumber"),"4194304 MB"),e.grid.owner.getMsgBox().alert(_T("user","error_quota_set"),o),!1)},createStore:function(){return new Ext.data.GroupingStore({listeners:{beforeload:{scope:this,fn:function(){this.owner.setStatusBusy()}},load:{scope:this,fn:function(){this.owner.clearStatusBusy()}},exception:{scope:this,fn:function(e,t,i,s,n,o){this.owner.clearStatusBusy(),SYNO.Debug("Store exception: ",e,t,i,s,n,o)}}},reader:new Ext.data.JsonReader({fields:[{name:"name",mapping:"name"},{name:"description",mapping:"description"},{name:"used",mapping:"used"},{name:"preview",mapping:"preview"},{name:"group_limit",mapping:"group_limit"},{name:"quota",mapping:"quota"},{name:"unit",mapping:"unit"},{name:"quota_enabled",mapping:"quota_enabled"},{name:"limit_4T",mapping:"limit_4T"},{name:"status",mapping:"status"},{name:"quota_status",mapping:"quota_status"},{name:"deduped",mapping:"deduped"},{name:"total",mapping:"total"},{name:"volume",mapping:"volume"},{name:"target",mapping:"target"},{name:"display_name",mapping:"display_name"}]}),groupField:"volume",idProperty:"name",autoDestroy:!0,remoteSort:!1})},doRefresh:function(){if("yes"!==_D("supportquota","no"))return;if(!this.owner.newuser&&this.isDirty())return void this.owner.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?(this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{params:this.getWebAPI(this.owner.username)},callback:function(e,t,i){if(this.owner.clearStatusBusy(),e&&!t.has_fail)this.getStore().commitChanges(),this.doRefresh();else{let e=SYNO.API.Response.GetFirstError(t);this.owner.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})):(this.getStore().rejectChanges(),this.doRefresh())}),this);let e={api:"SYNO.Core.Quota",version:1,params:{support_share_quota:"yes"===_D("support_share_user_quota","no")}};this.owner.newuser?(e.method="inspect",e.params.groups=[],this.owner.groupGrid&&this.owner.groupGrid.getStore().each((function(t){!0===t.get("is_member")&&e.params.groups.push(t.get("name"))}))):(e.method="get",e.params.name=this.owner.username),this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{stopwhenerror:!0,params:[{api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{offset:0,limit:-1,option:"include_cold_storage",location:"internal"}},e]},callback:function(t,i,s){if(this.owner.clearStatusBusy(),t&&!i.has_fail)this.loadQuotaSettings(SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Quota",e.method),SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Storage.Volume","list"));else{let e=SYNO.API.Response.GetFirstError(i);this.owner.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})},createColModel:function(e){let t=this;var i=new Ext.data.ArrayStore({fields:["value","display"],data:this.supportShareQuota?[["TB",_T("common","size_tb")],["GB",_T("common","size_gb")],["MB",_T("common","size_mb")]]:[["GB",_T("common","size_gb")],["MB",_T("common","size_mb")]]}),s=[{header:this.supportShareQuota?_T("common","volume_share"):_T("volume","volume"),dataIndex:"display_name",align:"left",renderer:function(e,t,i){return t.attr='ext:qtip="'+e+'"',"normal"===i.get("status")?e:String.format('(<font class="red-status">{0}</font>)',e)}},{header:_T("user","acnt_used_cap"),dataIndex:"used",hidden:this.hideUsedCapacity,align:"left",width:120,renderer:function(e,i,s){return t.isQuotaStatusDisabled(s.get("quota_status"))?"-":!this.hidden&&s.get("target")?SYNO.SDS.Utils.CapacityRender(e,2):"-"}},{header:_T("user","user_quota_preview"),align:"left",width:120,renderer:function(e,i,s){return s.get("target")?t.isQuotaStatusDisabled(s.get("quota_status"))?_T("user","user_quota_no_limit"):s.get("quota")?`${s.get("quota")} ${_T("common","size_"+s.get("unit").toLowerCase())}`:0!==s.get("group_limit")?SYNO.SDS.Utils.CapacityRender(s.get("group_limit"),2):_T("user","user_quota_no_limit"):"-"}},{header:_T("user","group_quota_limit"),dataIndex:"group_limit",align:"left",width:135,renderer:function(e,i,s){return s.get("target")?t.isQuotaStatusDisabled(s.get("quota_status"))||0===s.get("group_limit")?_T("user","user_quota_no_limit"):SYNO.SDS.Utils.CapacityRender(e,2):"-"}},{header:_T("personal_settings","user_quota_capacity"),dataIndex:"quota",id:"quota",align:"left",width:140,editor:new SYNO.ux.NumberField({allowBlank:!0,allowNegative:!1,allowDecimals:!1,validateOnBlur:!0,selectOnFocus:!0,emptyText:_T("dhcp_server","unlimited"),validationEvent:"keyup",vtype:"number",listeners:{beforeshow:function(e){e.getValue()||e.reset()}}}),renderer:function(e,t,i){return e||(i.set(this.dataIndex,0),t.attr='style="color:#aaaaaa;"',e=_T("dhcp_server","unlimited")),i.get("target")?e:""}},{header:"",dataIndex:"unit",id:"unit",align:"left",width:80,editor:new SYNO.ux.ComboBox({store:i,lazyRender:!0,mode:"local",displayField:"display",valueField:"value",triggerAction:"all",editable:!1}),renderer:function(e,t,i){return i.get("target")?_T("common","size_"+e.toLowerCase()):""}},new SYNO.ux.EnableColumn({header:_T("user","enable_quota"),id:"quota_enabled",dataIndex:"quota_enabled",width:195,hidden:!0,enableFastSelectAll:!0,isIgnore:function(e,t){return!t.get("target")},renderer:function(e,t,i){return i.get("target")?SYNO.ux.EnableColumn.prototype.renderer.apply(this,arguments):""}}),{dataIndex:"volume",hidden:!0,groupRenderer:function(e,i,s){if("share"===s.get("target")&&(e+=" (btrfs)"),"volume"===s.get("target")&&(e+=" (ext4)"),t.isQuotaStatusDisabled(s.get("quota_status"))){e+=`<span class="syno-ux-whitetip-icon" ext:wtip="${Ext.util.Format.htmlEncode(_T("user","user_quota_unsupported"))}"></span>`}return e}}];return new Ext.grid.ColumnModel({defaults:{width:130,align:"center"},columns:s,isCellEditable:function(i,s){var n=e.getAt(s);return!t.isQuotaStatusDisabled(n.get("quota_status"))&&Ext.grid.ColumnModel.prototype.isCellEditable.call(this,i,s)}})},configLeafObj:function(e,t){Ext.isDefined(e.quota)?(e.quota=Math.floor(e.quota),e.unit="MB",e.quota%1024==0&&(e.quota/=1024,e.unit="GB"),e.quota%1024==0&&(e.quota/=1024,e.unit="TB")):(e.quota=0,e.unit="GB"),e.quota_enabled=0!==e.quota,e.quota_enabled||(e.unit="GB"),Ext.isDefined(e.group_limit)||(e.group_limit=0),e.status=t.readonly?"crash":"normal",e.volume=t.display_name,e.total=Math.floor(t.size_total_byte/1024/1024),e.leaf=!0,e.expanded=!1},loadQuotaSettings:function(e,t){var i=this,s={},n=[];Ext.each(t.volumes,(function(e){s[e.volume_path]=e})),Ext.isDefined(e.user_quota)||(e.user_quota=e.quota),Ext.each(e.user_quota,(function(e){var t=s[e.volume];e.support_share_quota?(e.children=e.shares,e.leaf=!1,e.expanded=!0,e.status=t.readonly?"crash":"normal",e.volume=t.display_name,e.total=Math.floor(t.size_total_byte/1024/1024),e.display_name=t.display_name,e.description=Ext.util.Format.htmlEncode(t.description),Ext.each(e.children,(function(s){i.configLeafObj(s,t),s.target="share",s.limit_4T=!1,s.display_name=s.name,s.description=Ext.util.Format.htmlEncode(s.description),s.quota_status=e.quota_status,s.deduped=e.deduped,n.push(s)}))):(i.configLeafObj(e,t),e.target="volume",e.limit_4T=!0,e.name=t.volume_path,e.display_name=t.display_name,e.description=Ext.util.Format.htmlEncode(t.description),n.push(e))})),this.getStore().loadData(n)},isDirty:function(){return 0!==this.getStore().getModifiedRecords().length},confirmQuotaUpdate:function(){return this.getStore().getModifiedRecords().some((e=>"v1"===e.get("quota_status")&&!0===e.get("deduped")))},getWebAPI:function(e){var t=[];return this.getStore().getModifiedRecords().forEach((function(e){var i=parseInt(e.get("quota"),10);"share"===e.get("target")?t.push({share:e.get("name"),quota:this.convertToMB(i,e.get("unit"))}):"volume"===e.get("target")&&t.push({volume:e.get("name"),quota:this.convertToMB(i,e.get("unit"))})}),this),0===t.length?[]:[{api:"SYNO.Core.Quota",method:"set",version:1,params:{name:e,user_quota:t}}]}}),Ext.define("SYNO.SDS.AdminCenter.User.UserDialog",{extend:"SYNO.SDS.ModalWindow",specialAccounts:["guest"],_defaultNameColumnWidth:150,_defaultColumnWidth:130,WEBAPI_PARAM_SHARE_TYPE:["dec","local","usb","sata","cluster","c2","cold_storage","worm"],WEBAPI_PARAM_ADDITIONAL:["hidden","encryption","is_aclmode"],constructor:function(e){this.module=e.module,this.owner=e.owner,this.username=e.username,this.passwordChecker=e.passwordChecker,this.twoFactorObj={},this.authType=e.authType||"local",this.isHCM="yes"===_D("support_hyper_converged","no"),this.supportShareUserQuota="yes"===_D("support_share_user_quota","no"),this.supportSharedOperation=_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"),this.supportAppPrivOperation=(_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.AppRulePrivileges.Main"))&&!this.isHCM,this.isSupportQuota=!this.isHCM&&"yes"===_D("supportquota","no"),this.isSupportBandwidth=!this.isHCM,this.commonUsernames=[],this.panel=this.createTabPanel(e);var t={width:910,height:590,minWidth:910,minHeight:420,layout:"fit",buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.close},{text:_T("common","save"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.panel]};Ext.apply(t,e),this.callParent([t]),Ext.getCmp(this.resend_invitation_button).hide(),this.defineBehaviors(),this.userFormPanel.mon(this.userForm.findField("name"),"blur",(function(){this.isValid()&&this.clearInvalid()}),this.userForm.findField("password")),this.userFormPanel.mon(this.userForm.findField("description"),"blur",(function(){this.isValid()&&this.clearInvalid()}),this.userForm.findField("password"))},onClose:function(){return!1!==this.callParent(arguments)&&(!this.isTabsDirty()||(this.getMsgBox().confirm(_T("user","user_acnt_info"),_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.doClose()}),this),!1))},createTabPanel:function(e){this.userFormPanel=this.initUserForm(),this.userForm=this.userFormPanel.getForm(),this.groupGrid=this.initGroupGrid({owner:this,module:this.module,appWin:this}),this.shareGrid=this.supportSharedOperation?this.initShareGrid({owner:this,module:this.module,appWin:this}):null,this.quotaGrid=this.isSupportQuota?this.initQuotaGrid({owner:this,module:this.module,appWin:this}):null,this.bandwidthGrid=this.isSupportBandwidth?this.initBandwidthGrid({owner:this,module:this.module,preview:!0}):null,this.appPrivilegeGrid=this.supportAppPrivOperation?this.initPrivilegeGrid({title:_T("user","user_application"),owner:this,module:this.module,entity_type:"user",entity_name:this.username,showPreview:!0,appFilter:function(t){if(-1<t.grant_type.indexOf(e.authType))return!0}}):null;var t=[this.userFormPanel];"local"===e.authType&&t.push(this.groupGrid),this.shareGrid&&t.push(this.shareGrid),this.isSupportQuota&&t.push(this.quotaGrid),this.appPrivilegeGrid&&this.needShowAppPrivilege(this.username)&&(t=t.concat([this.appPrivilegeGrid])),this.isSupportBandwidth&&(t=t.concat([this.bandwidthGrid]));var i={activeTab:0,plain:!0,defaults:{height:310},useDefaultBtn:!1,items:t};return new SYNO.SDS.Utils.TabPanel(i)},initUserForm:function(e){for(var t,i=void 0!==this.passwordChecker&&this.passwordChecker.passwordPolicy.strong_password_enable&&(this.passwordChecker.passwordPolicy.mixed_case||this.passwordChecker.passwordPolicy.included_numeric_char||this.passwordChecker.passwordPolicy.included_special_char||this.passwordChecker.passwordPolicy.min_length_enable),s=[],n=0;n<24;++n)s.push([n+1,String.leftPad(String(n+1),2,"0")]);var o=new Ext.data.ArrayStore({fields:["value","display"],data:s}),a={title:_T("user","user_info"),trackResetOnLoad:!0,labelWidth:250,items:[{xtype:"syno_textfield",fieldLabel:_T("user","user_account")+' <font class="red-status">'+_T("common","star")+"</font>","aria-label":_T("user","user_account"),name:"name",disabled:"local"!==this.authType,allowBlank:!1,blankText:_T("user","error_noname"),validateOnBlur:!0,validationDelay:250,validationEvent:"keyup",validator:function(e){let t=this.userForm.findField("name");return!t.isDirty()||("admin"===t.originalValue.toLowerCase()?"admin"===e||_T("user","error_cannot_rename_admin"):!Array.isArray(this.commonUsernames)||!this.commonUsernames.includes(e.toLowerCase())||String.format(_T("user","error_dont_use_admin"),e))}.bind(this),maxLength:64,width:220,labelHtmlEncode:!1,vtype:"username"},{xtype:"syno_textfield",disabled:"local"!==this.authType,fieldLabel:_T("user","user_fullname"),maxLength:64,width:220,name:"description"},{xtype:"syno_textfield",fieldLabel:_T("user","user_email"),name:"email",hidden:"local"!==this.authType,maxLength:512,width:220,vtype:"email",validator:function(){return!0!==this.ownerCt.getForm().findField("notify_by_email").getValue()||""!==this.getValue()||_T("user","empty_email")}},{xtype:"syno_displayfield",fieldLabel:_T("user","user_passwd"),name:"password_last_change",style:"min-width: 220px;",htmlEncode:!1,width:500,hidden:"local"!==this.authType||this.newuser,disabled:"local"!==this.authType||this.newuser},{xtype:"syno_compositefield",fieldLabel:"",hidden:"local"!==this.authType||this.newuser,disabled:"local"!==this.authType||this.newuser,items:[{xtype:"syno_button",text:_T("personal_settings","change_password"),handler:function(){new SYNO.SDS.AdminCenter.User.ChangePasswordDialog({owner:this,passwordChecker:this.passwordChecker,ori_name:this.username,name:this.userForm.findField("name").getValue(),desc:this.userForm.findField("description").getValue()}).open()},scope:this},{xtype:"syno_button",id:this.resend_invitation_button=Ext.id(),text:_T("user","resend_invitation_mail"),hidden:!1,name:"resend_invitation_mail",handler:function(){new SYNO.SDS.AdminCenter.User.UserInviteDialog({owner:this,ori_name:this.username}).open()},scope:this}]},{xtype:"syno_compositefield",fieldLabel:_T("user","user_passwd")+(i?' <font class="red-status">'+_T("common","star")+"</font>":""),width:500,cls:"password-composite-field",labelHtmlEncode:!1,hidden:"local"!==this.authType||!this.newuser,disabled:"local"!==this.authType||!this.newuser,items:[{xtype:"syno_passwordfield","aria-label":_T("user","user_passwd"),maxLength:127,width:220,name:"password",updateWhenRender:!1,startValidate:!1,validator:this.passwordChecker&&this.newuser?this.passwordChecker.isStrongValidator.createDelegate(this.passwordChecker):void 0,listeners:{afterrender:function(){this.hidePasswordStrength()},password_strength_get:function(){this.showPasswordStrength()}}},{xtype:"syno_button",text:_T("passwd","passwd_gen_title"),tabIndex:-1,hidden:void 0!==this.passwordChecker&&(!1===this.passwordChecker.passwordPolicy.strong_password_enable||"admin"===this.username),scope:this,handler:function(){new SYNO.SDS.AdminCenter.User.GenPasswordDialog({owner:this,passwordChecker:this.passwordChecker}).open()}}]},{xtype:"syno_textfield",textType:"password_confirm",fieldLabel:_T("user","user_repswd")+(i?' <font class="red-status">'+_T("common","star")+"</font>":""),"aria-label":_T("user","user_repswd"),hidden:"local"!==this.authType||!this.newuser,disabled:"local"!==this.authType||!this.newuser,maxLength:127,name:"confirmpassword",width:220,labelHtmlEncode:!1,confirmFor:"password",validator:function(e){var t=this.ownerCt.getForm().findField(this.confirmFor).getValue();return e===t||"12345678"===t&&"87654321"===e||_T("pppoe","error_password")}},{xtype:"syno_checkbox",name:"notify_by_email",hidden:!0,value:!1,boxLabel:_T("user","create_user_notification_mail"),listeners:{check:function(){var e=this.ownerCt.getForm().findField("email");this.checked?e.label.dom.innerHTML=_T("user","user_email")+' <font class="red-status">'+_T("common","star")+"</font>:":e.label.dom.innerHTML=_T("user","user_email")+":"}}},{xtype:"syno_radio",name:"send_notification_email",inputValue:"send_password_reset_link",checked:!0,hidden:!0,scope:this,boxLabel:_T("user","send_time_limited_password_reset_link"),indent:1},{xtype:"syno_compositefield",name:"password_reset_link_expire",hideLabel:!0,hidden:!0,indent:2,items:[{xtype:"syno_displayfield",name:"mail_valid_duration",value:_T("user","valid_duration")+_T("common","colon"),width:193},{xtype:"syno_combobox",name:"email_expire_hour",store:o,displayField:"display",valueField:"value",value:s[s.length-1][0],width:90},{xtype:"syno_displayfield",name:"hour_time_description",value:_T("common","time_hours"),width:50}]},{xtype:"syno_radio",name:"send_notification_email",inputValue:"send_password",hidden:!0,indent:1,boxLabel:_T("user","send_user_password")},{xtype:"syno_radio",name:"send_notification_email",inputValue:"send_plain_information",hidden:!0,indent:1,boxLabel:_T("user","send_plain_information")},{xtype:"syno_checkbox",name:"cannot_chg_passwd",hidden:"local"!==this.authType,boxLabel:_T("user","user_chpasswd_disallow")},{xtype:"syno_checkbox",name:"passwd_never_expire",hidden:"local"!==this.authType,boxLabel:_T("user","passwd_never_expire")},{xtype:"syno_checkbox",name:"disabled",hidden:"local"!==this.authType,boxLabel:_T("user","user_account_disable")},{xtype:"syno_radio",indent:1,boxLabel:_T("user","user_disable_immediately"),name:"disableimmediately",hidden:"local"!==this.authType,inputValue:"setdisableimmediately"},{xtype:"syno_compositefield",name:"expirefield",hidden:"local"!==this.authType,hideLabel:!0,indent:1,items:[{xtype:"syno_radio",width:217,boxLabel:_T("user","user_disable_date"),name:"disableimmediately",inputValue:"setdisabledate"},{xtype:"syno_datetimefield",format:"Y/n/j",invalidText:_JSLIBSTR("extlang","invaliddate").replace("{1}","Y/m/d"),allowBlank:!1,width:220,name:"expireddate",maxValue:new Date(2038,0,19),minValue:new Date(2003,1,1)}]},{xtype:"syno_button",id:this.reset_otp_btn=Ext.id(),text:_T("user","reset_user_otp"),scope:this,hidden:!0,handler:this.resetUserOTPConfirm},{xtype:"syno_button",id:this.reset_amfa_btn=Ext.id(),scope:this,hidden:!0,handler:this.resetAmfa},{xtype:"syno_displayfield",id:this.note_2fa=Ext.id(),hidden:!0,scope:this,htmlEncode:!1,value:String.format('<span class="syno-ux-note">{0}{1} </span>',_T("common","note"),_T("common","colon"))+String.format(_T("otp_enforcement","note_set_up_otp"),'<a id="'+(this.set2fa_link=Ext.id())+'" class="link-font" style="cursor:pointer">'+_T("common","user_setting")+"</a>")}]};return Ext.apply(a,e),t=new SYNO.SDS.Utils.FormPanel(a),this.passwordChecker&&this.passwordChecker.initPasswordChecker({getForm:function(){return t.getForm()},getUserAcc:"name",getUserDesc:"description",getPasswd:"password",getPasswdConfirm:"confirmpassword",getStartValidate:function(){var e;return null===(e=this.getForm().findField("password"))||void 0===e?void 0:e.startValidate}}),t},initGroupGrid:function(e){var t=new SYNO.API.JsonStore({appWindow:e.appWin,autoDestroy:!0,api:"SYNO.Core.Group",method:"list",version:1,fields:[{name:"name",type:"string"},{name:"description",type:"string"},{name:"is_member",type:"boolean"}],root:"groups",id:"name",remoteSort:!1,listeners:{exception:{scope:e.owner,fn:SYNO.SDS.AdminCenter.User.UserDialog.prototype.onStoreException}}});let i=function(e,t){return"users"===e||"administrators"===e&&0<=["admin","guest",_S("user")].indexOf(t)};var s=new SYNO.ux.EnableColumn({enableFastSelectAll:!0,header:_T("userwizard","join_group"),dataIndex:"is_member",width:SYNO.SDS.AdminCenter.User.UserDialog.prototype._defaultColumnWidth,align:"center",username:e.owner.username,isIgnore:function(e,t){return i(t.get("name"),this.username)},renderer:function(e,t,s){return i(s.get("name"),this.username)?this.disableRenderer(e,t,s):SYNO.ux.EnableColumn.prototype.renderer.call(this,e,t,s)}}),n=new Ext.grid.ColumnModel([{id:"name",header:_T("group","grp_name"),dataIndex:"name",width:this._defaultNameColumnWidth+this._defaultColumnWidth/2},{header:_T("group","grp_desc"),id:"description",dataIndex:"description",renderer:Ext.util.Format.htmlEncode,width:3.5*this._defaultColumnWidth},s]),o={title:_T("user","tabpanel_user_groups"),cm:n,ds:t,bbar:new SYNO.ux.PageLessToolbar({store:t,doRefresh:function(){let t=e.owner,i=()=>{t.setStatusBusy(),this.checkGroupPolling(t.username,(function(e){t.clearStatusBusy(),"local"===t.authType&&t.groupGrid.getStore().load({params:{name_only:!1,user:e,type:"local"},callback:function(){t.newuser&&t.groupGrid.getStore().getAt(t.groupGrid.getStore().find("name","users")).set("is_member",!0)}})}))},s=e=>{"yes"===e?(this.setStatusBusy(),this.sendWebAPI({compound:{params:this.serializeGroupTab()},callback:function(e,t){if(this.clearStatusBusy(),e&&!t.has_fail)this.groupGrid.getStore().commitChanges(),i();else{let e=SYNO.API.Response.GetFirstError(t);this.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})):(this.groupGrid.getStore().rejectChanges(),i())};t.newuser||0===t.groupGrid.getStore().getModifiedRecords().length?i():t.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),s,t)}.bind(this)}),plugins:[s],autoExpandColumn:"name",enableColLock:!1,enableHdMenu:!1,cls:"without-dirty-red-grid"};return Ext.apply(o,e),new SYNO.ux.GridPanel(o)},initPrivilegeGrid:function(e){return e.owner.isCopyMode&&(e.isLockCustomSetting=!0),new SYNO.SDS.AdminCenter.AppRulePrivileges.EditAppPrivPanel(e)},initShareGrid:function(e){return new SYNO.SDS.AdminCenter.User.ShareGrid(e)},initBandwidthGrid:function(e){var t=this,i=function(e,t,i,s,n,o){return"enabled"!==i.get("policy")?(t.attr='style="color:#aaaaaa;"',e="-"):e||(i.set(this.dataIndex,0),t.attr='style="color:#aaaaaa;"',e=_T("dhcp_server","unlimited")),e},s=function(e,i){var s;void 0!==(s=t.selModel.getSelected())&&(void 0!==s.data.schedule_plan&&""!==s.data.schedule_plan||(s.data.schedule_plan="111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"),void 0!==s.data.upload_limit_2&&""!==s.data.upload_limit_2||(s.data.upload_limit_2=0),void 0!==s.data.download_limit_2&&""!==s.data.download_limit_2||(s.data.download_limit_2=0),SYNO.SDS.BandwidthControl.SchedulePlanWinOpen.createDelegate(t,["user",s,!0])())},n=new SYNO.ux.NumberField({allowBlank:!0,allowNegative:!1,allowDecimals:!1,validationEvent:"keyup",selectOnFocus:!0,maxLength:9,emptyText:_T("dhcp_server","unlimited"),validateOnBlur:!0,validator:function(e){if(!this.bandwidthGrid.activeEditor||"FileStation"!==this.bandwidthGrid.activeEditor.record.get("protocol"))return!0;var t=parseInt(e,10);return!(("upload_limit_1"==a[this.bandwidthGrid.activeEditor.col].dataIndex||"download_limit_1"==a[this.bandwidthGrid.activeEditor.col].dataIndex)&&t<10&&t>0)||_WFT("bandwidth","bandwidth_min_rate")}.createDelegate(this),vtype:"number",listeners:{beforeshow:function(e){e.getValue()||e.reset()}}}),o=new Ext.data.ArrayStore({fields:["display","value"],data:[[_T("bandwidth","mode_disable_user"),"disabled"],[_T("bandwidth","mode_enable"),"enabled"],[_T("bandwidth","mode_schedule"),"scheduled"]],autoDestroy:!0}),a=[];a.push({header:_T("bandwidth","bandwidth_protocol"),dataIndex:"protocol",width:115,renderer:SYNO.SDS.BandwidthControl.ProtocolTitle}),!0===e.preview&&a.push({header:_T("bandwidth","bandwidth_preview"),dataIndex:"preview",width:130,renderer:function(e,t,i,s,n,o){var a=i.get("policy"),r=0,l=0;return"scheduled"===a?_T("bandwidth","mode_schedule"):("enabled"===a?(r=i.get("upload_limit_1"),l=i.get("download_limit_1")):(r=i.get("upload_result"),l=i.get("download_result")),r||(r=_T("dhcp_server","unlimited")),l||(l=_T("dhcp_server","unlimited")),`${r} / ${l}`)}}),a.push({header:_T("bandwidth","mode"),dataIndex:"policy",width:236,renderer:function(e){return"notexist"===e||"disabled"===e||!1===e?_T("bandwidth","mode_disable_user"):"enabled"===e||!0===e?_T("bandwidth","mode_enable"):"scheduled"===e?_T("bandwidth","mode_schedule"):e},editor:new SYNO.ux.ComboBox({name:"modeSelect",hiddenName:"modeSelect",typeAhead:!0,triggerAction:"all",displayField:"display",valueField:"value",hideLabel:!0,id:Ext.id(),editable:!1,forceSelection:!0,valueNotFoundText:_T("bandwidth","mode_disable_user"),store:o,mode:"local",tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" role="option" aria-label="{display}" id="{[Ext.id()]}" ext:qtip="{display}">',"{display}","</div>","</tpl>"),listeners:{scope:this,select:function(e,t,i){"scheduled"===t.data.value&&s(),e.fireEvent("blur")}}})}),a.push({header:`${_T("bandwidth","bandwidth_up_rate")} (${_T("bandwidth","speed_unit")})`,dataIndex:"upload_limit_1",width:125,editor:n,renderer:i}),a.push({header:`${_T("bandwidth","bandwidth_down_rate")} (${_T("bandwidth","speed_unit")})`,dataIndex:"download_limit_1",width:140,editor:n,renderer:i}),a.push({dataIndex:"schedule_plan",hidden:!0}),a.push({dataIndex:"upload_limit_2",hidden:!0}),a.push({dataIndex:"download_limit_2",hidden:!0});var r=new Ext.grid.ColumnModel(a);r.isCellEditable=function(e,t){var i=l.getAt(t),s=r.findColumnIndex("policy");return("enabled"===i.get("policy")||e===s)&&Ext.grid.ColumnModel.prototype.isCellEditable.call(this,e,t)};var l=new SYNO.API.JsonStore({api:"SYNO.Core.BandwidthControl",method:"get",version:2,appWindow:this,baseParams:{name:this.isCopyMode?this.defaultData.name:"",owner_type:"local_user"},fields:["upload_result","download_result","upload_limit_1","download_limit_1","policy","protocol","protocol_ui","owner_type","schedule_plan","upload_limit_2","download_limit_2"],root:"bandwidths",remoteSort:!1,listeners:{exception:{scope:e.owner,fn:SYNO.SDS.AdminCenter.User.UserDialog.prototype.onStoreException}}}),d=new SYNO.ux.Toolbar,c=new SYNO.ux.Button({name:"schedulePlanBtn",text:_T("bandwidth","edit_adv_setting"),tabIndex:-1,disabled:!0,scope:this,handler:s});d.add(c);var h={title:_T("bandwidth","bandwidth_tab_title"),cm:r,ds:l,tbar:d,itemId:"bandwidth",enableHdMenu:!1,enableColumnMove:!1,clicksToEdit:1,cls:"synoug-speed-limit-grid",selModel:this.selModel=new Ext.grid.RowSelectionModel({singleSelect:!0,listeners:{selectionchange:{fn:function(e){e.getCount()>0?c.enable(!1):c.disable(!1)},scope:this}}}),bbar:new SYNO.ux.PageLessToolbar({store:l,doRefresh:function(){this.newuser||0===this.bandwidthGrid.getStore().getModifiedRecords().length?this.bandwidthGrid.getStore().load({params:{name:this.username}}):this.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?(this.setStatusBusy(),this.sendWebAPI({compound:{params:this.serializeBandwidthTab()},callback:function(e,t){if(this.clearStatusBusy(),e&&!t.has_fail)this.bandwidthGrid.getStore().commitChanges(),this.bandwidthGrid.getStore().load({params:{name:this.username}});else{let e=SYNO.API.Response.GetFirstError(t);this.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})):(this.bandwidthGrid.getStore().rejectChanges(),this.bandwidthGrid.getStore().load({params:{name:this.username}}))}),this)}.bind(this)})};return Ext.apply(h,e),new SYNO.ux.EditorGridPanel(h)},initQuotaGrid:function(e){return"yes"===_D("supportquota","no")?new SYNO.SDS.AdminCenter.User.QuotaGrid({title:_T("user","user_quota_capacity"),owner:e.owner,module:e.owner,itemId:"quota"}):{loadQuotaSettings:Ext.emptyFn,getWebAPI:function(){return[]},isDirty:function(){return!1}}},defineBehaviors:function(){"local"===this.authType&&(new SYNO.ux.Utils.EnableCheckGroup(this.userForm,"disabled",["disableimmediately","expireddate"]),new SYNO.ux.Utils.EnableRadioGroup(this.userForm,"disableimmediately",{setdisabledate:["expireddate"],setdisableimmediately:[]}),this.userFormPanel.mon(this.userFormPanel,"passwordchange",this.checkConnection,this))},checkConnection:function(e,t,i){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.CurrentConnection",method:"list_by_user",version:1,params:{username:e},callback:function(e,s){if(this.clearStatusBusy(),!e)return;if(0>=s.total)return;let n=new Set,o="",a={yes:{text:_T("connections","end_connections")},no:{text:_T("common","no")}};s.items.forEach((function(e){e.can_be_kicked&&n.add(e.protocol)})),0>=n.size||(o=_S("user")===this.username?String.format(_T("connections","confirm_kill_connection_self"),n.join(", ")):String.format(_T("connections","confirm_kill_connection_others"),n.join(", ")),this.getMsgBox().confirm("",t||o,(function(e){"yes"===e&&this.kickConnection(s.items)}),this,i||a))},scope:this})},kickConnection:function(e){let t=[],i=[];e.forEach((function(e){if(e.can_be_kicked)if("HTTP/HTTPS"===e.protocol){if(e.is_current_connected)return;i.push({who:e.who,did:e.did})}else t.push({pid:e.pid,type:e.type,who:e.who,from:e.from})})),this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.CurrentConnection",method:"kick_connection",version:1,params:{http_conn:i,service_conn:t},callback:function(e,t){this.clearStatusBusy(),e||this.getMsgBox().alert("",SYNO.API.Errors.core[t.code]||_T("common","error_system")),this.resetAmfaDone()},scope:this})},onStoreException:function(e,t,i,s,n,o){if(SYNO.Debug("Store exception: options:",e,t,i,s,n,o),!this.isAlertExist)if(this.isAlertExist=!0,3202!==n.code)SYNO.SDS.AdminCenter.User.Alert.call(this,_T("user","failed_load_user"),(function(){this.close(),this.isAlertExist=!1}),this);else{var a=this.getGroupTaskData(),r=a&&Ext.isArray(a.running)?a.running.map((function(e){return e.data.name}))[0]:void 0;this.groupGrid.getEl().mask(SYNO.API.Errors.core[n.code]+(r?" ("+r+")":""),"syno-ux-mask-info")}},loadSuccess:function(e,t){this.clearStatusBusy();var i=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.User","get").users[0],s=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Share.Permission","list_by_user"),n=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Storage.Volume","list"),o=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Quota","get"),a=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.BandwidthControl","get");this.twoFactorObj=SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance")?SYNO.API.Response.GetValByAPI(e,"SYNO.SecureSignIn.Method.Admin","get"):{};var r=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.FileServ.SMB","get"),l=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Group.Member","admin_check"),d=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.User.PasswordExpiry","get");if(Ext.isObject(l)&&(this.isAdminGroupMember=l.users[0].is_admin),"guest"===i.name&&r&&r.enable_samba&&r.enable_local_master_browser&&this.GuestWithLMB(),"local"===this.authType){if((_S("user")===i.name||!0===this.owner.getOpenConfig("cms_self")&&_S("user")===i.name)&&(_S("demo_mode")&&(this.userForm.findField("password").disable(),this.userForm.findField("confirmpassword").disable()),this.userForm.findField("disabled").disable(),this.userForm.findField("cannot_chg_passwd").disable()),_S("demo_mode")&&"admin"===i.name.toLowerCase()&&(this.userForm.findField("password").disable(),this.userForm.findField("confirmpassword").disable(),this.userForm.findField("disabled").disable(),this.userForm.findField("cannot_chg_passwd").disable()),"admin"===i.name.toLowerCase()&&SYNO.ux.AddTip(this.userForm.findField("disabled").getEl(),_T("user","disable_admin_tip")),!0===d.password_expire_enable&&"guest"!==i.name||this.userForm.findField("passwd_never_expire").hide(),i.is_password_pending&&Ext.getCmp(this.resend_invitation_button).show(),this.userForm.setValues({password:"12345678",confirmpassword:"87654321"}),this.userForm.findField("password").startValidate=!0,"normal"===i.expired?(i.disabled=!1,i.disableimmediately="setdisableimmediately"):"now"===i.expired?(i.disabled=!0,i.disableimmediately="setdisableimmediately"):(i.disabled=!0,i.disableimmediately="setdisabledate",i.expireddate=new Date(i.expired)),0===i.password_last_change)i.password_last_change=String.format('<span class="orange-status">{0}</span>',_T("user","user_acnt_mustchange"));else if(0<i.password_last_change){var c=new Date(24*i.password_last_change*60*60*1e3);i.password_last_change=_T("personal_settings","password_last_changed")+_T("common","colon")+" "+SYNO.SDS.DateTimeFormatter(c,{type:"date"})}else i.password_last_change=_T("personal_settings","password_last_changed")+_T("common","colon")+" -";this.userForm.setValues(i);let t=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.User.UsernamePolicy","list");Array.isArray(t)&&(this.commonUsernames=t)}else this.userForm.setValues({name:i.name,description:i.description});if(this.isSupportQuota&&(this.quotaGrid.loadQuotaSettings(o,n),(!n.volumes||0>=n.volumes.length)&&this.panel.hideTabStripItem("quota")),this.isSupportBandwidth&&(this.bandwidthGrid.getStore().loadData(a),(!a.bandwidths||0>=a.bandwidths.length)&&this.panel.hideTabStripItem("bandwidth")),"two-factor"===this.twoFactorObj.mode&&"on"===this.twoFactorObj.status&&Ext.getCmp(this.reset_otp_btn).show(),Ext.getCmp(this.reset_amfa_btn).setText(_S("user")===this.username?_T("secure_signin","sign_out_other_devices"):_T("secure_signin","sign_out_all_devices")),Ext.getCmp(this.reset_amfa_btn).show(),_S("user")===this.username){Ext.getCmp(this.note_2fa).show();var h=Ext.get(this.set2fa_link);h&&this.mon(h,"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.App.PersonalSettings.Instance")}),this)}this.shareGrid&&s.shares&&s.shares.length>0&&this.shareGrid.getStore().loadData(s)},needShowAppPrivilege:function(e){return"admin"!=e&&"guest"!=e},loadDetail:function(e){var t=[{api:"SYNO.Core.User",version:1,method:"get",params:{name:e,additional:["description","email","expired","cannot_chg_passwd","passwd_never_expire","password_last_change","is_password_pending"]}},{api:"SYNO.Core.User.PasswordExpiry",version:1,method:"get"}];this.isSupportQuota&&t.push({api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{offset:0,limit:-1,option:"include_cold_storage",location:"internal"}}),this.isSupportBandwidth&&t.push({api:"SYNO.Core.BandwidthControl",method:"get",version:2,params:{name:e,owner_type:"local_user"}}),SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance")&&t.push({api:"SYNO.SecureSignIn.Method.Admin",version:1,method:"get",params:{account:e}}),SYNO.API.GetKnownAPI("SYNO.Core.FileServ.SMB")&&t.push({api:"SYNO.Core.FileServ.SMB",version:1,method:"get"}),(_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"))&&t.push({api:"SYNO.Core.Share.Permission",method:"list_by_user",version:1,params:{name:e,user_group_type:this.authType+"_user",share_type:this.WEBAPI_PARAM_SHARE_TYPE,additional:this.WEBAPI_PARAM_ADDITIONAL}}),"yes"===_D("supportquota","no")&&t.push({api:"SYNO.Core.Quota",version:1,method:"get",params:{name:e,support_share_quota:this.supportShareUserQuota}}),"local"!==this.authType?t.push({api:"SYNO.Core.Group.Member",method:"admin_check",version:1,params:{name:e}}):t.push({api:"SYNO.Core.User.UsernamePolicy",version:1,method:"list"}),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:t},callback:function(e,t,i){e&&!t.has_fail?this.loadSuccess(t,i):(this.clearStatusBusy(),SYNO.SDS.AdminCenter.User.Alert.call(this,_T("user","failed_load_user"),this.close,this))},scope:this})},onOpen:function(){this.setStatusBusy(),this.loadInfo(this.username),this.callParent(arguments)},loadInfo:function(e){""!==e&&this.setTitle(e),"no"===_D("supportquota","no")&&this.panel.hideTabStripItem("quota"),this.checkSpecialAccout(e)&&(this.userForm.findField("email").disable(),this.userForm.findField("name").disable()),this.checkGroupPolling(e,(function(e){"local"===this.authType&&this.groupGrid.getStore().load({params:{name_only:!1,user:e,type:"local"}}),this.loadDetail(e)}))},GuestWithLMB:function(){this.userForm.findField("password").disable(),this.userForm.findField("confirmpassword").disable(),this.userForm.findField("disabled").disable()},resetUserOTPConfirm:function(){var e={yes:{text:_T("common","disable")},no:{text:_T("common","cancel")}};this.getMsgBox().confirm(_T("user","reset_user_otp"),_T("user","reset_user_otp_confirm"),(function(e){"yes"===e&&this.resetUserOTP()}),this,e)},resetUserOTP:function(){SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance")&&this.sendWebAPI({api:"SYNO.SecureSignIn.Method.Admin",version:1,method:"reset",params:{account:this.username,keep_amfa_settings:!0},callback:this.reset2faDone,scope:this})},reset2faDone:function(e,t,i){if(e){Ext.getCmp(this.reset_otp_btn).hide();var s=String.format('<div class="content"><span id={0} class="green-status">{1} </span></div>',Ext.id(),_T("user","reset_otp_success"));new SYNO.SDS.ToastBox({owner:this,html:s})}else SYNO.SDS.AdminCenter.User.Alert.call(this,_T("user","reset_otp_failed"))},resetAmfa:function(){let e="<b>"+_T("secure_signin","are_you_kick_devices_title")+"</b>";e+="<br>",e+="<br>",e+=String.format(_T("secure_signin","are_you_kick_devices_desc"),this.username),e+="<br>",Ext.getCmp(this.reset_otp_btn).isVisible()?e+=_T("secure_signin","are_you_kick_devices_note"):this.twoFactorObj.amfa_devcies_count&&0<this.twoFactorObj.amfa_devcies_count&&(e+=_T("secure_signin","are_you_kick_amfa_devices_note")),this.checkConnection(this.username,e,{yes:{text:_T("common","logout")},no:{text:_T("common","cancel")}})},resetAmfaDone:function(){if(Ext.getCmp(this.reset_amfa_btn).isVisible()){var e=String.format('<div class="content"><span id={0} class="green-status">{1} </span></div>',Ext.id(),_T("common","completed"));new SYNO.SDS.ToastBox({owner:this,html:e})}},checkSpecialAccout:function(e){for(var t=0;t<this.specialAccounts.length;t++)if(this.specialAccounts[t]==e)return!0;return!1},serializeInformationTab:function(){if(!this.userForm.isDirty())return[];var e="normal";this.userForm.findField("disabled").getValue()?this.userForm.findField("disableimmediately").getValue()?e="now":this.userForm.findField("expireddate").getValue()&&(e=new Date(this.userForm.findField("expireddate").getValue()).dateFormat("Y/n/j")):e="normal";var t={name:this.username||this.userForm.findField("name").getValue(),description:this.userForm.findField("description").getValue(),email:this.userForm.findField("email").getValue(),cannot_chg_passwd:!!this.userForm.findField("cannot_chg_passwd").getValue(),expired:e},i=this.userForm.findField("passwd_never_expire");i.isDirty()&&Ext.apply(t,{passwd_never_expire:!!i.getValue()}),this.userForm.findField("password").getValue()===this.userForm.findField("confirmpassword").getValue()&&Ext.apply(t,{password:this.userForm.findField("password").getValue()});var s="set";if(this.newuser){s="create";var n=this.userForm.findField("notify_by_email").getValue(),o=this.userForm.findFields("send_notification_email").find((e=>e.getValue())),a=o?o.inputValue:null,r={};n&&"send_password_reset_link"===a?(r.notify_by_email=!0,r.send_password_reset_link=!0,r.expire_hour=this.userForm.findField("email_expire_hour").getValue()):n?(r.notify_by_email=!0,r.send_password="send_password"===a):r.notify_by_email=!1,Ext.apply(t,r)}else Ext.apply(t,{new_name:this.userForm.findField("name").getValue()});return[{api:"SYNO.Core.User",method:s,version:1,params:t}]},serializeGroupTab:function(){var e=this.groupGrid.getStore(),t=[],i=[],s=[],n=this.userForm.findField("name").getValue();return e.getModifiedRecords().forEach((function(e){"users"!==e.get("name")&&("administrators"!==e.get("name")||"admin"!==n&&"guest"!==n&&_S("user")!==n)&&(e.get("is_member")?i.push(e.get("name")):s.push(e.get("name")))})),i.length+s.length>0&&t.push({api:"SYNO.Core.User.Group",method:"join",version:1,params:{join_group:i,leave_group:s,name:n}}),t},serializeShareTab:function(){return this.shareGrid.getWebAPI(this.userForm.findField("name").getValue())},serializeQuotaTab:function(){return this.quotaGrid.getWebAPI(this.userForm.findField("name").getValue())},serializeBandwidthTab:function(){var e=[],t=this.bandwidthGrid.getStore();return Ext.each(t.getModifiedRecords(),(function(t){t.data.name=this.userForm.findField("name").getValue(),e.push(t.data)}),this),0<e.length?[{api:"SYNO.Core.BandwidthControl",method:"set",version:1,params:{bandwidths:e}}]:[]},serializeAppRulePrivTab:function(){return this.appPrivilegeGrid.newname=this.userForm.findField("name").getValue(),this.appPrivilegeGrid.getWebAPI()},serializeApplyData:function(){var e=[];return"local"===this.authType&&(e=(e=e.concat(this.serializeInformationTab())).concat(this.serializeGroupTab())),this.shareGrid&&(e=e.concat(this.serializeShareTab())),this.isSupportQuota&&(e=e.concat(this.serializeQuotaTab())),this.isSupportBandwidth&&(e=e.concat(this.serializeBandwidthTab())),this.appPrivilegeGrid&&(e=e.concat(this.serializeAppRulePrivTab())),e},isTabsDirty:function(){return!this.ignoreDirty&&!!(this.userForm.isDirty()||this.groupGrid.getStore().getModifiedRecords().length||this.shareGrid&&this.shareGrid.getStore().getModifiedRecords().length||this.quotaGrid&&this.quotaGrid.isDirty()||this.bandwidthGrid&&this.bandwidthGrid.getStore().getModifiedRecords().length||this.appPrivilegeGrid&&this.appPrivilegeGrid.getStore().getModifiedRecords().length)},onApply:function(){if("local"===this.authType&&!this.userForm.isValid())return this.setStatusError({text:_T("common","forminvalid"),clear:!0}),this.panel.setActiveTab(0),!1;if("on"===this.twoFactorObj.status&&this.userForm.findField("name").isDirty()){let e="two-factor"===this.twoFactorObj.mode?_T("secure_signin","2fa_rename_warning"):_T("secure_signin","passwordless_rename_warning");this.getMsgBox().confirm("",e,(function(e){"yes"===e&&this.onSaveSetting()}),this)}else this.onSaveSetting()},onSaveSetting:function(){var e=this.shareGrid?this.shareGrid.getShareInfoForS2S():null;SYNO.SDS.Utils.S2S.confirmIfSyncShareAffected(!1,e,{dialogTitle:this.title,dialogMsg:_T("s2s","s2s_warn_share_change_priv"),dialogOwner:this,continueHandler:function(){this.setStatusBusy({text:_T("common","saving")}),this.confirmQuotaUpdate()},abortHandler:function(){this.shareGrid&&(this.shareGrid.getStore().rejectChanges(),this.shareGrid.getView().refresh())},scope:this})},confirmQuotaUpdate:function(){if(this.isSupportQuota&&this.quotaGrid.confirmQuotaUpdate()){let e=_T("user","confirm_quota_update");this.getMsgBox().confirm("",e,(function(e){"yes"===e?this.queryGlobalConf():this.clearStatusBusy()}),this)}else this.queryGlobalConf()},queryGlobalConf:function(){let e={api:"SYNO.Core.BandwidthControl.Protocol",method:"get",version:1},t=[Ext.apply({params:{protocol:"FileStation"}},e)];"yes"!==_D("support_hyper_converged","no")&&(t.push(Ext.apply({params:{protocol:"FTP"}},e),{api:"SYNO.Core.FileServ.FTP",method:"get",version:1},{api:"SYNO.Core.FileServ.FTP.SFTP",method:"get",version:1}),"no"===_D("usbstation","no")&&t.push(Ext.apply({params:{protocol:"NetworkBackup"}},e),{api:"SYNO.Backup.Service.NetworkBackup",method:"get",version:1})),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:t},scope:this,callback:function(e,t,i){e?this.checkBandwidthSetting(t.result,i.compound):this.failureAlert()}})},setGlobalConf:function(e){for(var t={api:"SYNO.Core.BandwidthControl.Protocol",method:"set",version:1},i=[],s=0;s<e.length;s++)i.push(Ext.apply({params:{protocol:e[s],policy:"enabled"}},t));this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:i},scope:this,callback:function(e,t,i){e?this.applyUserData():this.failureAlert()}})},getConfirmString:function(e,t){var i=[];return Ext.each(t,(function(e){i.push(SYNO.SDS.BandwidthControl.ProtocolTitle(e))})),String.format('{0}<div ext:qtip="{1}" class="blue-status">{1}<div>',e,i.join(", "))},checkBandwidthSetting:function(e,t){var i=this.isSupportBandwidth?this.bandwidthGrid.getStore():null,s=[],n=[],o="",a=!1,r=!1;Ext.each(e,(function(e){e.success&&("SYNO.Core.FileServ.FTP"===e.api&&(e.data.enable_ftp||e.data.enable_ftps)||"SYNO.Core.FileServ.FTP.SFTP"===e.api&&e.data.enable?a=!0:"SYNO.Backup.Service.NetworkBackup"===e.api&&e.data.enable?r=!0:"SYNO.Core.BandwidthControl.Protocol"===e.api&&"disabled"===e.data.policy&&n.push(e.data.protocol))})),a||n.remove("FTP"),r||n.remove("NetworkBackup");i&&i.each((function(e){let t=e.get("protocol");0<=n.indexOf(t)&&!function(e){let t=e.get("policy");return 0<=["notexist","disabled"].indexOf(t)||"enabled"===t&&!e.get("upload_limit_1")&&!e.get("download_limit_1")}(e)&&s.push(t)}),this),s.length>0?(o=this.getConfirmString(_T("bandwidth","bandwidth_global_conf_enable_desc"),s)||_T("bandwidth","bandwidth_global_conf_enable_desc"),this.getMsgBox().confirm(_T("bandwidth","bandwidth_tab_title"),o,(function(e){"yes"===e?this.setGlobalConf(s):this.applyUserData()}),this)):this.applyUserData()},applyUserData:function(){if(!this.isTabsDirty())return this.clearStatusBusy(),this.close(),!1;this.sendWebAPI({scope:this,compound:{stopwhenerror:!1,params:this.serializeApplyData()},encryption:["password"],callback:this.applyDone})},applyDone:function(e,t,i){var s=this.userForm.findField("name").getValue()||this.username;if(this.clearStatusBusy(),t.has_fail)SYNO.SDS.AdminCenter.User.Alert.call(this,t.result),this.lastResult=!1;else{if(t.result){var n=t.result.filter((function(e){return"SYNO.Core.User.Group"===e.api&&"join"===e.method&&e.data.task_id}))[0];if(n)return this.setStatusBusy(),void this.startGroupPolling(n.data.task_id,s)}this.ignoreDirty=!0,this.hide(),this.fireEvent("userchange",s),this.close()}},getGroupTaskData:function(){var e;return Ext.isFunction(this.ownerGrid.getCacheData)?e=this.ownerGrid.getCacheData.call(this.ownerGrid):(SYNO.Debug("getGroupTaskData from local variable"),e=this.groupTaskCache),e.groupTask},setGroupTaskData:function(e){var t;return Ext.isFunction(this.ownerGrid.getCacheData)?t=this.ownerGrid.getCacheData.call(this.ownerGrid):(SYNO.Debug("setGroupTaskData to local variable"),t=this.groupTaskCache),t.groupTask=e,t.groupTask},checkGroupPolling:function(e,t){if(t=Ext.isFunction(t)?t:Ext.emptyFn,"local"===this.authType){var i=this.getGroupTaskData();if(void 0===i)this.sendWebAPI({api:"SYNO.Core.User.Group",version:1,method:"join_list",params:{},scope:this,callback:function(i,s){if(!i){var n=SYNO.API.Response.GetFirstError(s),o=SYNO.API.Errors.core[n.code]||_T("common","error_system");return this.getMsgBox().alert("warning_msg",o),!1}var a={running:Ext.value(s.running,[]),interrupted:Ext.value(s.interrupted,[]),finished:Ext.value(s.finished,[])};SYNO.Debug("loading task status",a),this.setGroupTaskData(a);var r=a.running.map((function(e){return{name:e.data.name,task_id:e.task_id}})).filter((function(t){return t.name===e}))[0];r?this.startGroupPolling(r.task_id,e):t.call(this,e)}});else{SYNO.Debug("checkGroup using cache",i,this.ownerGrid.cacheData);var s=(Ext.isArray(i.finished)?i.finished:[]).concat(Ext.isArray(i.interrupted)?i.interrupted:[]).map((function(e){return e.task_id}));if(s.length>0&&(SYNO.Debug("clear stopped task",s),this.sendWebAPI({api:"SYNO.Core.User.Group",version:1,method:"join_stop",params:{task_id:s},scope:this,callback:function(e,t,i){if(e){if(!t||!Ext.isArray(t.task_id)||t.task_id.length<=0)return;var s=t.task_id,n=this.getGroupTaskData();n.interrupted=n.interrupted.reject((function(e){return s.any((function(t){return e.task_id===t}))})),n.finished=n.finished.reject((function(e){return s.any((function(t){return e.task_id===t}))})),this.setGroupTaskData(n)}}})),i.running&&Ext.isArray(i.running)){var n=i.running.map((function(e){return{name:e.data.name,task_id:e.task_id}})).filter((function(t){return t.name===e}))[0];if(n)return void this.startGroupPolling(n.task_id,e)}t.call(this,e)}}else t.call(this,e)},startGroupPolling:function(e,t){this.getMsgBox().show({title:_T("share","percentage"),width:300,wait:!1,progress:!0,closable:!1,msg:_T("common","msg_waiting"),hideDlg:!0,scope:this});var i=this.pollReg({webapi:{api:"SYNO.Core.User.Group",method:"join_status",version:1,params:{task_id:e}},interval:3,immediate:!0,scope:this,status_callback:function(e,s,n,o){var a=s.data;if(!e){this.stopGroupPolling(i,t);var r=SYNO.API.Response.GetFirstError(s),l=SYNO.API.Errors.core[r.code]||_T("common","error_system");return this.getMsgBox().alert("warning_msg",l),!1}s.finish?(this.stopGroupPolling(i,t),this.getMsgBox().hide()):this.getMsgBox().updateProgress(a.progress/a.total,"",_T("common","msg_waiting"),!0)}})},stopGroupPolling:function(e,t){this.clearStatusBusy(),this.pollUnreg(e),this.setGroupTaskData(void 0),this.ignoreDirty=!0,this.hide(),this.fireEvent("userchange",t),this.close()},failureAlert:function(e,t){this.clearStatusBusy(),this.getMsgBox().alert(_T("tree","leaf_user"),_T("common","error_system"),(function(){this.close()}),this)}}),Ext.define("SYNO.SDS.AdminCenter.User.UploadUserFileDialog",{extend:"SYNO.SDS.ModalWindow",ds:null,constructor:function(e){this.owner=e.owner,this.module=e.module,this.supportNotificationSet=_S("is_admin"),this.password_must_change=e.password_must_change,this.panel=this.createPanel(),this.supportNotificationSet=_S("is_admin");var t={layout:"fit",width:760,height:620,resizable:!1,title:_T("user","user_upload"),buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"apply",scope:this,disabled:!0,handler:this.onSubmit}],items:[this.panel]};Ext.apply(t,e),this.callParent([t]),this.DefineBehaviors()},createPanel:function(){var e;this.grid=this.createPreviewGrid();var t={border:!1,padding:0,webapi:{api:"SYNO.Core.User",version:1,methods:{set:"parse_user_list"}},fileUpload:!0,items:[{xtype:"syno_checkbox",name:"overwrite",boxLabel:_T("user","user_check_overwrite")},{xtype:"syno_checkbox",name:"new_user_mail",boxLabel:_T("user","create_user_notification_mail"),listeners:{check:function(){var e=this.ownerCt.getForm().findField("send_password");this.checked?e.enable():e.disable()}}},{xtype:"syno_checkbox",name:"send_password",boxLabel:_T("user","send_user_password")},{xtype:"syno_checkbox",name:"password_must_change",boxLabel:_T("user","first_time_login_change_passwd"),checked:this.password_must_change},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_compositefield",hideLabel:!0,flex:3,items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("user","user_file")+_T("common","colon"),style:{"padding-right":"20px"}},{xtype:"syno_filebutton",hideLabel:!0,name:"filename",value:""}]},{xtype:"syno_compositefield",hideLabel:!0,flex:2,items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("common","delimiter")+_T("common","colon"),style:{"padding-right":"20px"}},{xtype:"syno_combobox",width:120,hideLabel:!0,name:"delimiter",displayField:"display",tpl:new Ext.XTemplate('<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item">{display}</div></tpl>'),valueField:"value",value:this.delimiterOldOption=0,store:new Ext.data.ArrayStore({fields:["value","display"],data:[[0,_T("common","tab_str")],[1,_T("common","comma_str")],[2,_T("common","semicolon_str")]]})}]}]},this.grid]};return(e=new SYNO.SDS.Utils.FormPanel(t)).getForm().findField("send_password").disable(),e},createPreviewGrid:function(){var e=new SYNO.API.JsonStore({root:"items",totalProperty:"total",fields:[{name:"name",mapping:"name"},{name:"password",mapping:"password"},{name:"description",mapping:"description"},{name:"email",mapping:"email"},{name:"quota",mapping:"quota"},{name:"group",mapping:"group"},{name:"status",mapping:"status"}],listeners:{exception:{scope:this,fn:function(e,t,i,s,n,o){SYNO.Debug("Store exception: options:",e,t,i,s,n,o)}},load:{scope:this,fn:this.onLoad}},sortInfo:{field:"status",direction:"DESC"}});function t(e,t){var i=Ext.util.Format.htmlEncode(e);return t.attr=String.format('ext:qtip="{0}"',Ext.util.Format.htmlEncode(i)),i}this.ds=e;var i=[{header:_T("user","user_account"),dataIndex:"name",width:100,sortable:!0,renderer:t},{header:_T("user","user_passwd"),dataIndex:"password",width:75,sortable:!0,renderer:t},{header:_T("user","user_fullname"),dataIndex:"description",id:"description",width:100,sortable:!0,renderer:t},{header:_T("user","user_email"),dataIndex:"email",width:125,sortable:!0,renderer:t},{header:_T("group","group_name"),dataIndex:"group",width:100,sortable:!0,renderer:t}];_S("diskless")||"yes"===_D("usbstation","no")||i.push({header:_T("user","user_quota_capacity"),dataIndex:"quota",width:100,sortable:!0,renderer:function(e,t){if(""===e)return _T("user","user_quota_nolimit");for(var i=e.split(","),s=[],n=0;n<i.length;n++){var o=i[n].split(":");s.push(String.format("[{0} {1}: {2} {3}]",_T("volume","volume"),o[0],o[1],_T("common","size_mb")))}var a=s.join("<br>"),r=s.join(" ");return t.attr=String.format('ext:qtip="{0}"',Ext.util.Format.htmlEncode(a)),r}}),i.push({header:_T("user","user_acnt_status"),dataIndex:"status",width:150,sortable:!0,renderer:function(e,t){var i="";switch(e){case 1:i=_T("user","error_user_invalid");break;case 2:i=_T("user","error_user_repeat");break;case 3:i=_T("user","error_exist");break;case 4:i=_T("user","error_status_nameused");break;case 5:i=_T("user","error_pwd_maxlen");break;case 6:i=_T("user","error_desc");break;case 7:i=_T("user","error_badmail");break;case 8:i=_T("user","error_quota_set");break;case 9:i=String.format(_T("user","error_too_much_user"),_D("maxaccounts"));break;case 10:i=_T("user","user_overwrite");break;case 11:i=_T("user","error_privilege");break;case 12:i=_T("user","error_group");break;default:i=""}return t.attr=String.format('ext:qtip="{0}"',i),"<font class='red-status'>"+i+"</font>"}});var s=new Ext.grid.ColumnModel(i,!0);return new SYNO.ux.GridPanel({ds:e,cm:s,cls:"without-dirty-red-grid",padding:"6px 0px 0px 0px",height:330,autoExpandColumn:"description",selModel:new Ext.grid.RowSelectionModel,view:new SYNO.ux.FleXcroll.grid.BufferView({scrollDelay:!1,cacheSize:50})})},onLoad:function(){var e,t=!1;for(e=0;e<this.ds.getCount();e++){var i=this.ds.getAt(e),s=parseInt(i.get("status"),10);if(0===s||10===s){t=!0;break}}t?this.btnUpload.enable():this.btnUpload.disable()},onOpen:function(){this.getMailSetting(),this.callParent(arguments)},getMailSetting:function(){this.sendWebAPI({api:"SYNO.Core.Notification.Mail.Conf",method:"get",version:1,scope:this,callback:function(e,t,i){if(!this.isDestroyed)if(this.clearStatusBusy(),e){if(t.send_welcome_mail&&this.panel.getForm().findField("new_user_mail").setValue(!0),!t.enable_mail){var s=this.panel.getForm().findField("new_user_mail");this.supportNotificationSet?this.panel.mon(s,"check",this.validMail,this):(s.disable(),SYNO.ux.AddTip(s.getEl(),_T("delegation","tip_user_ask_admin_to_set_notification")))}}else SYNO.SDS.AdminCenter.User.Alert.call(this,t.code)}}),this.setStatusBusy()},validMail:function(e,t){t&&this.getMsgBox().confirm(this.title,_T("notification","mail_service_not_enable_revised"),(function(t){"yes"===t?(this.module.app.startModule("SYNO.SDS.AdminCenter.Notification.Main"),this.close()):e.setValue(!1)}),this)},DefineBehaviors:function(){this.mon(this.panel.getForm(),"actioncomplete",this.onFormSuccess,this),this.mon(this.panel.getForm(),"actionfailed",this.onFormFailed,this),this.mon(this.panel.getForm().findField("overwrite"),"check",this.onOverwriteCheck,this),this.mon(this.panel.getForm().findField("filename").getEl(),"change",this.onImportFilePathChanged,this),this.mon(this.panel.getForm().findField("delimiter"),"select",this.onDelimiterOptionSelected,this),this.btnUpload=this.getFooterToolbar().getComponent("apply")},onOverwriteCheck:function(e,t){var i=!1;if(!(this.ds.getCount()<=0)){this.ds.suspendEvents(!1);for(var s=0;s<this.ds.getCount();s++){var n=this.ds.getAt(s),o=parseInt(n.get("status"),10);t?3===o&&(n.set("status",10),o=10):10===o&&(n.set("status",3),o=3),0!==o&&10!==o||(i=!0)}i?this.btnUpload.enable():this.btnUpload.disable(),this.ds.resumeEvents(),this.grid.getView().refresh()}},onImportFilePathChanged:function(e,t){t&&t.value?(this.setStatusBusy({text:_T("common","loading")}),this.panel.getForm().doAction("apply")):(this.ds.removeAll(),this.btnUpload.disable())},onDelimiterOptionSelected:function(e,t){var i=t.data.value;""!==this.panel.getForm().findField("filename").getValue()?i!==this.delimiterOldOption&&(this.delimiterOldOption=i,this.setStatusBusy({text:_T("common","loading")}),this.panel.getForm().doAction("apply")):this.delimiterOldOption=i},onFormSuccess:function(e,t){this.clearStatusBusy(),t.result.success&&this.ds.loadData(t.result.data)},onFormFailed:function(e,t){var i=t.result.error,s=SYNO.SDS.AdminCenter.User.Error2Msg(i.code);this.clearStatusBusy(),this.ds.removeAll(),this.btnUpload.disable(),3130!==i.code&&3131!==i.code&&3132!==i.code||(s=String.format(s,'<span class="selectabletext">'+Ext.util.Format.htmlEncode(i.errors.invalid_field)+"</span>")),this.getMsgBox().alert(_T("user","user_upload"),s)},prepareApplyParameter:function(e,t){var i=[];return this.ds.each((function(e){var t=parseInt(e.get("status"),10);if(0!==t&&10!==t)return!0;i.push({name:e.get("name"),password:e.get("password"),description:e.get("description"),email:e.get("email"),group:e.get("group"),quota:e.get("quota"),overwrite:10===t})})),i},startPolling:function(){this.pollingId=this.pollReg({webapi:{api:"SYNO.Core.User",method:"import_status",version:1,params:{task_id:this.taskId}},interval:5,immediate:!0,scope:this,status_callback:this.onPollRequestComplete})},stopPolling:function(){Ext.isDefined(this.pollingId)&&(this.pollUnreg(this.pollingId),delete this.pollingId)},onPollRequestComplete:function(e,t,i){if(!e)return this.stopPolling(),this.clearStatusBusy(),void SYNO.SDS.AdminCenter.User.Alert.call(this,t.code,(function(){3116!==t.code&&3117!==t.code||(this.module.ds.reload(),this.close())}),this);t.finished&&(this.sendWebAPI({webapi:{api:"SYNO.Core.User",version:1,method:"import_stop",params:{task_id:this.taskId},scope:this}}),this.stopPolling(),this.clearStatusBusy(),this.module.appWin.getMsgBox().alert(_T("tree","leaf_user"),_T("common","setting_applied")),this.module.ds.reload(),this.close())},onMainRequestComplete:function(e,t,i){if(!e)return this.clearStatusBusy(),void SYNO.SDS.AdminCenter.User.Alert.call(this,t.code);this.taskId=t.task_id,this.startPolling()},onSubmit:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.User",version:1,method:"import",scope:this,params:{users:this.prepareApplyParameter(),new_user_mail:this.panel.getForm().findField("new_user_mail").getValue(),send_password:this.panel.getForm().findField("send_password").getValue(),password_must_change:this.panel.getForm().findField("password_must_change").getValue(),delimiter:this.panel.getForm().findField("delimiter").getValue()},callback:this.onMainRequestComplete})}}),Ext.define("SYNO.SDS.AdminCenter.User.CreateUserSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",constructor:function(e){this.isCopyMode=e.isCopyMode,this.defaultData=e.defaultData,this.callParent(arguments)},activate:function(){this.genSummary.call(this.owner,this.getStore()),this.getView().syncFocusEl(0),this.getView().refresh()},genSummary:function(e){var t=[],i=[],s=[],n=[],o=this.userForm.findField("name").getValue(),a=this.userForm.findField("description").getValue(),r=this.userForm.findField("email").getValue(),l=[],d=[],c=[];e.removeAll(!0),e.append(_T("user","user_account"),o),e.append(_T("user","user_fullname"),a),e.append(_T("user","user_email"),r),this.groupGrid.getStore().each((function(e){return this.isCopyMode&&(e.markDirty(),this.groupGrid.getStore().modified.push(e)),e.data.is_member&&t.push(e.get("name")),!0}),this),e.append(_T("group","group_list"),t.join(",")),this.supportSharedOperation&&(this.shareGrid.getStore().each((function(e){this.isCopyMode&&(e.markDirty(),this.getStore().modified.push(e));var t=this.getFinalPermission(e);"rw"==t?i.push(e.data.name):"ro"==t?n.push(e.data.name):"na"==t&&s.push(e.data.name)}),this.shareGrid),e.append(_T("common","writeable"),i.join(", ")),e.append(_T("common","readonly"),n.join(", ")),e.append(_T("share","share_add_deny"),s.join(", "))),this.isSupportQuota&&this.quotaGrid&&this.quotaGrid.getStore().each((function(t){if(this.isCopyMode&&(t.markDirty(),this.quotaGrid.getStore().modified.push(t)),t.get("target")){var i="";0!==t.get("quota")?i=String.format("{0} {1}",t.get("quota"),t.get("unit")):0!==t.get("group_limit")&&(i=SYNO.SDS.Utils.CapacityRender(t.get("group_limit"),2)),""!==i&&e.append(t.get("share"===t.get("target")?"name":"volume"),i+" ("+_T("storage_report","user_quota")+")")}}),this);if(this.supportAppPrivOperation&&this.appPrivilegeGrid&&this.appPrivilegeGrid.getStore().each((function(e){var t,i,s;this.isCopyMode&&(t=this.appPrivilegeGrid.getStore().modified,i=e.get("app_id"),s=!1,t.forEach((function(e){e.get("app_id")===i&&(s=!0)})),s||(e.markDirty(),this.appPrivilegeGrid.getStore().modified.push(e))),e.get("allow")&&l.push(e.get("name")),e.get("deny")&&d.push(e.get("name"))}),this),this.isCopyMode&&!this.defaultData.ignoreAppPriv&&!0!==this.appPrivilegePageActivated)for(var h=function(e){return(1!==e.length||"0.0.0.0"!==e[0])&&0!==e.length},u=this.defaultData.appPriv.rules.length-1;u>=0;u--){var p=this.defaultData.appPriv.rules[u];this.defaultData.appPriv.rules[u].entity_name=o,1!==p.allow_ip.length||h(p.allow_ip)||l.push(p.appName),1!==p.deny_ip.length||h(p.deny_ip)||d.push(p.appName)}this.supportAppPrivOperation&&(e.append(_T("app_privilege","has_privilege"),l.join(", ")),e.append(_T("app_privilege","has_no_privilege"),d.join(", "))),this.isSupportBandwidth&&this.bandwidthGrid&&(this.bandwidthGrid.getStore().each((function(e){if(this.isCopyMode&&(e.markDirty(),this.bandwidthGrid.getStore().modified.push(e)),"notexist"===e.get("policy"))return;let t=SYNO.SDS.BandwidthControl.ProtocolTitle(e.get("protocol"));if("scheduled"===e.get("policy"))return void c.push(`${t}(${_T("bandwidth","mode_schedule")})`);let i=e.get("upload_limit_1"),s=e.get("download_limit_1");i||(i=_T("dhcp_server","unlimited")),s||(s=_T("dhcp_server","unlimited")),c.push(`${t}(${i}/${s})`)}),this),e.append(_T("bandwidth","bandwidth_settings"),c.join(", ")))}}),Ext.define("SYNO.SDS.AdminCenter.User.CreateUserWizardDialog",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){this.owner=e.owner,this.module=e.module,this.isCopyMode=e.isCopyMode,this.defaultData=e.defaultData,this.passwordChecker=e.passwordChecker,this.newuser=!0,this.usernameValidating=!1,this.newusermail=!1,this.isAlertExist=!1,this.authType="local",this.isHCM="yes"===_D("support_hyper_converged","no"),this.supportSharedOperation=_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"),this.supportAppPrivOperation=(_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.AppRulePrivileges.Main"))&&!this.isHCM,this.supportNotificationSet=_S("is_admin"),this.isSupportQuota=!this.isHCM&&"yes"===_D("supportquota","no"),this.isSupportBandwidth=!this.isHCM,this.commonUsernames=[];var t=Ext.apply({title:_T("userwizard","wizard_title"),resizable:!1,width:800,height:570,steps:[]},e),i="";i=this.isCopyMode?["summary"]:["group"],this.userFormPanel=SYNO.SDS.AdminCenter.User.UserDialog.prototype.initUserForm.call(this,{owner:this,passwordChecker:this.passwordChecker,module:this.module,height:450,width:720,nextId:i});var s=new Ext.Container({headline:_T("userwizard","userinfo_title"),title:"",itemId:"user",items:[this.userFormPanel],getNext:function(){return this.owner.groupPageActivated=!0,this.owner.userForm.isValid()?this.owner.validUserName(!0):SYNO.Debug("form invalid",this.owner.userForm),!1}});this.groupGrid=SYNO.SDS.AdminCenter.User.UserDialog.prototype.initGroupGrid({appWin:this,owner:this,module:this.module,height:414,width:720,bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}});var n=new Ext.Container({headline:_T("userwizard","grpinfo_title"),title:"",itemId:"group",nextId:this.findNextId("group"),appWin:this,owner:this,module:this.module,items:[this.groupGrid],getNext:function(){this.owner.sharePageActivated=!0;var e=[],t=[];return this.owner.groupGrid.getStore().each((function(i){!0===i.get("is_member")&&(e.push(i.get("name")),t.push(i.json.gid.toString()))})),this.appWin.appPrivilegeGrid&&(this.appWin.appPrivilegeGrid.previewGroups=t,this.appWin.appPrivilegeGrid.isGroupName=!1),this.owner.isSupportQuota&&this.owner.sendQuotaRequest(e),this.owner.goNext(this.nextId),this.owner.shareGrid&&(this.owner.getButton("next").disable(),this.owner.shareGrid.getStore().load({params:{name:this.owner.isCopyMode?this.owner.defaultData.name:e},callback:function(){this.owner.getButton("next").enable()},scope:this})),!1}}),o=new Ext.Container;this.supportSharedOperation&&(this.shareGrid=SYNO.SDS.AdminCenter.User.UserDialog.prototype.initShareGrid({appWin:this,owner:this,module:this.module,height:414,width:720,bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}),o=new Ext.Container({headline:_T("userwizard","shareinfo_title"),title:"",itemId:"share",nextId:this.findNextId("share"),appWin:this,owner:this,module:this.module,items:[this.shareGrid],getNext:function(){return"quota"===this.nextId?(this.owner.quotaGrid.fireEvent("activate",this.owner.quotaGrid),this.owner.quotaPageActivated=!0):"appprivilege"===this.nextId&&(this.owner.appPrivilegeGrid.fireEvent("activate"),this.owner.appPrivilegePageActivated=!0),this.owner.goNext(this.nextId),!1}})),this.quotaGrid=this.isSupportQuota?new SYNO.SDS.AdminCenter.User.QuotaGrid({appWin:this,owner:this,module:this.module,hideUsedCapacity:!0,height:414,width:720,bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}):{loadQuotaSettings:Ext.emptyFn,getWebAPI:function(){return[]}};var a=this.isSupportQuota?new Ext.Container({headline:_T("userwizard","quotainfo_title"),title:"",itemId:"quota",nextId:this.findNextId("quota"),appWin:this,owner:this,module:this.module,items:[this.quotaGrid],getNext:function(){return this.owner.supportAppPrivOperation&&(this.owner.appPrivilegePageActivated=!0,this.owner.appPrivilegeGrid.fireEvent("activate")),this.owner.goNext(this.nextId),!1}}):this.quotaGrid,r=new Ext.Container;if(this.supportAppPrivOperation&&(this.appPrivilegeGrid=SYNO.SDS.AdminCenter.User.UserDialog.prototype.initPrivilegeGrid({owner:this,module:this.module,height:414,width:720,entity_type:"user",entity_name:this.isCopyMode?this.defaultData.name:void 0,hide_custom:!this.isCopyMode,showPreview:!0,appFilter:function(e){if(-1<e.grant_type.indexOf(this.owner.authType))return!0},bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}),r=new Ext.Container({headline:_T("userwizard","user_asign_app_privilege"),title:"",itemId:"appprivilege",nextId:this.findNextId("appprivilege"),owner:this,module:this.module,items:[this.appPrivilegeGrid],getNext:function(){return this.owner.bandwisthPageActivated=!0,this.owner.goNext(this.nextId),!1}})),this.isSupportBandwidth){this.bandwidthGrid=SYNO.SDS.AdminCenter.User.UserDialog.prototype.initBandwidthGrid.createDelegate(this,[{owner:this,module:this.module,preview:!0,height:414,width:720,listeners:{afterrender:function(e){var t=e.getGridEl(),i=e.tbar;t.setStyle("padding-top","0px"),i.setStyle("padding-top","24px")}},bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}])();var l=new Ext.Container({headline:_T("bandwidth","bandwidth_user_create_headline"),title:"",itemId:"bandwidth",nextId:"summary",owner:this,module:this.module,items:[this.bandwidthGrid],getNext:function(){return this.owner.bandwisthPageActivated=!0,this.owner.goNext(this.nextId),!1}})}this.summaryGrid=new SYNO.SDS.AdminCenter.User.CreateUserSummaryStep({headline:_T("userwizard","summary_title"),itemId:"summary",nextId:null,isCopyMode:this.isCopyMode,defaultData:this.defaultData,owner:this,module:this.module,getNext:function(){return this.owner.onApply(),!1}}),this.userForm=this.userFormPanel.getForm(),t.steps.push(s),t.steps.push(n),this.supportSharedOperation&&t.steps.push(o),this.isSupportQuota&&t.steps.push(a),this.supportAppPrivOperation&&t.steps.push(r),this.isSupportBandwidth&&t.steps.push(l),t.steps.push(this.summaryGrid),this.callParent([t]),this.userForm.findField("password").startValidate=!0,this.userFormPanel.mon(this.userForm.findField("name"),"blur",(function(){this.getValue()&&this.isValid()&&this.clearInvalid()}),this.userForm.findField("password")),this.userFormPanel.mon(this.userForm.findField("description"),"blur",(function(){this.getValue()&&this.isValid()&&this.clearInvalid()}),this.userForm.findField("password")),this.userFormPanel.mon(this.userForm.findField("notify_by_email"),"check",(function(e,t){t&&Ext.isEmpty(this.getValue())||this.isValid()&&this.clearInvalid()}),this.userForm.findField("email"))},findNextId:function(e){switch(e){case"group":if(this.supportSharedOperation)return"share";case"share":if(this.isSupportQuota)return"quota";case"quota":if(this.supportAppPrivOperation)return"appprivilege";case"appprivilege":if(this.isSupportBandwidth)return"bandwidth";default:return"summary"}},sendQuotaRequest:function(e){var t={api:"SYNO.Core.Quota",version:1,params:{support_share_quota:"yes"===_D("support_share_user_quota","no")}};this.isCopyMode?(t.method="get",t.params.name=this.defaultData.name):(t.method="inspect",t.params.groups=e),this.quotaGrid.showMask=!1,this.sendWebAPI({compound:{stopwhenerror:!0,params:[{api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{offset:0,limit:-1,option:"include_cold_storage",location:"internal"}},t]},scope:this,callback:function(e,i,s){i.has_fail?this.quotaGrid.showMask=!0:this.quotaGrid.loadQuotaSettings(SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Quota",t.method),SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Storage.Volume","list"))}})},InitTask:function(){this.setStatusBusy();var e=this.getACLRuleAPIs();e=e.concat([{api:"SYNO.Core.Notification.Mail.Conf",version:1,method:"get"},{api:"SYNO.Core.User.PasswordExpiry",version:1,method:"get"},{api:"SYNO.Core.User.UsernamePolicy",version:1,method:"list"}]),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},scope:this,callback:function(e,t,i){if(!this.isDestroyed)if(this.clearStatusBusy(),t.has_fail)SYNO.SDS.AdminCenter.User.Alert.call(this,t.result);else{this.getACLRuleCallback(t.result,i.compound);var s=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Notification.Mail.Conf","get","send_welcome_mail"),n=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Notification.Mail.Conf","get","enable_mail");if(s&&(this.newusermail=s,this.userForm.findField("notify_by_email").setValue(this.newusermail)),!n){var o=this.userForm.findField("notify_by_email");this.supportNotificationSet?this.userFormPanel.mon(o,"check",this.validMail,this):(o.disable(),SYNO.ux.AddTip(o.getEl(),_T("delegation","tip_user_ask_admin_to_set_notification")))}var a=this.userForm.findField("passwd_never_expire");SYNO.API.Response.GetValByAPI(t,"SYNO.Core.User.PasswordExpiry","get","password_expire_enable")?(a.show(),a.setValue(!1)):(a.hide(),a.setValue(!0));let e=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.User.UsernamePolicy","list");Array.isArray(e)&&(this.commonUsernames=e)}}})},getACLRuleAPIs:function(){if(!this.isCopyMode)return[];if(!_S("is_admin")&&!SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"))return[];for(var e=[],t=0;t<this.defaultData.share.shares.length;t++)this.defaultData.share.shares[t].is_custom&&e.push({api:"SYNO.Core.ACL",version:1,method:"get",params:{name:this.defaultData.share.shares[t].name,type:"all",file_path:this.defaultData.share.shares[t].share_path}});return e},getACLRuleCallback:function(e,t){if(this.isCopyMode){this.defaultData.aclRules=[];for(var i={},s=0;s<t.length;s++)"SYNO.Core.ACL"===t[s].api&&(i={file_path:t[s].file_path,files:t[s].file_path,dirPaths:"/"+t[s].file_path.split("/").splice(2,1).join("/"),change_acl:!0,rules:e[s].data.acl,inherited:!1,acl_recur:!1,name:t[s].name},this.defaultData.aclRules.push(i))}},onOpen:function(){this.InitTask(),SYNO.SDS.AdminCenter.User.CreateUserWizardDialog.superclass.onOpen.call(this),this.userForm.findField("disabled").hide(),this.userForm.findField("expirefield").hide(),this.userForm.findField("disableimmediately").hide(),this.userForm.findField("expireddate").hide(),this.userForm.findField("notify_by_email").show(),this.userForm.findFields("send_notification_email").forEach((e=>e.show())),this.userForm.findField("password_reset_link_expire").show(),this.userForm.findFields("send_notification_email").forEach((e=>e.disable())),this.userForm.findField("mail_valid_duration").disable(),this.userForm.findField("hour_time_description").disable(),new SYNO.ux.Utils.EnableCheckGroup(this.userForm,"notify_by_email",["send_notification_email","mail_valid_duration","email_expire_hour","hour_time_description"],[],{disable_group:!0}),new SYNO.ux.Utils.EnableRadioGroup(this.userForm,"send_notification_email",{send_password_reset_link:["password_reset_link_expire"],send_password:[],send_plain_information:[]}),this.userForm.findField("password_reset_link_expire").disable(),this.userForm.findField("disabled").disable(),this.userForm.findField("expirefield").disable(),this.userForm.findField("disableimmediately").disable(),this.userForm.findField("expireddate").disable(),this.getButton("next").disable(),this.userFormPanel.mon(this.userForm.findField("name"),"valid",this.validUserName,this),this.userFormPanel.mon(this.userForm.findField("password"),"valid",(function(){this.getButton("next").enable()}),this),this.groupGrid.getStore().load({params:{user:this.isCopyMode?this.defaultData.name:"",name_only:!1},callback:function(e,t,i){i?this.groupGrid.getStore().getAt(this.groupGrid.getStore().find("name","users")).set("is_member",!0):(SYNO.SDS.AdminCenter.User.Alert.call(this,_T("user","failed_load_user")),this.close())},scope:this}),this.isSupportBandwidth&&this.bandwidthGrid.getStore().load(),this.isCopyMode&&(this.supportSharedOperation&&this.shareGrid.getStore().load({params:{name:this.defaultData.name}}),this.isSupportQuota&&this.sendQuotaRequest([]))},onApply:function(){this.setStatusBusy({text:_T("common","saving")}),SYNO.SDS.AdminCenter.User.UserDialog.prototype.confirmQuotaUpdate.call(this)},applyUserData:function(){this.sendWebAPI({scope:this,compound:{stopwhenerror:!1,params:SYNO.SDS.AdminCenter.User.UserDialog.prototype.serializeApplyData.call(this)},encryption:["password"],callback:this.applyDone})},queryGlobalConf:function(){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.queryGlobalConf.call(this)},setGlobalConf:function(e){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.setGlobalConf.call(this,e)},checkBandwidthSetting:function(e,t){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.checkBandwidthSetting.call(this,e,t)},getConfirmString:function(e,t){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.getConfirmString.call(this,e,t)},failureAlert:function(e,t){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.failureAlert.call(this,e,t)},serializeInformationTab:function(){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.serializeInformationTab.call(this)},serializeQuotaTab:function(){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.serializeQuotaTab.call(this)},serializeGroupTab:function(){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.serializeGroupTab.call(this)},copyOldRule:function(e){for(var t=this.defaultData.name,i=this.userForm.findField("name").getValue(),s=0;s<e.length;s++)if(e[s].owner_name===t){var n=JSON.parse(JSON.stringify(e[s]));return n.owner_name=i,n}},getCustomRule:function(e,t){for(var i=0;i<this.defaultData.aclRules.length;i++)if(this.defaultData.aclRules[i].name===t.name){var s=this.copyOldRule(this.defaultData.aclRules[i].rules);return this.defaultData.aclRules[i].rules.push(s),this.defaultData.aclRules[i]}},serializeACLRules:function(e){if(this.isCopyMode&&0!==e.length)for(var t=e[0].params,i=0;i<t.permissions.length;i++)t.permissions[i].is_custom&&e.push({api:"SYNO.Core.ACL",version:1,method:"set",params:this.getCustomRule(e,t.permissions[i])})},serializeShareTab:function(){var e=SYNO.SDS.AdminCenter.User.UserDialog.prototype.serializeShareTab.call(this);return this.serializeACLRules(e),e},syncData:function(){for(var e=function(e,t){for(var i=0;i<t.length;i++)if(t[i].get("app_id")===e)return t[i]},t=0;t<this.defaultData.appPriv.rules.length;t++){var i=this.defaultData.appPriv.rules[t],s=e(i.app_id,this.appPrivilegeGrid.getStore().modified);s.get("deny")?(i.allow_ip=[],i.deny_ip=["0.0.0.0"]):s.get("allow")&&(i.allow_ip=["0.0.0.0"],i.deny_ip=[])}},changeEntityName:function(e){this.defaultData.appPriv.rules.forEach((function(t){t.entity_name=e}),this)},serializeAppRulePrivTab:function(){var e=this.userForm.findField("name").getValue();return this.isCopyMode&&!this.defaultData.ignoreAppPriv?(!0===this.appPrivilegePageActivated&&this.syncData(),this.changeEntityName(e),{api:"SYNO.Core.AppPriv.Rule",version:1,method:"set",params:{rules:this.defaultData.appPriv.rules}}):(this.appPrivilegeGrid.newname=e,SYNO.SDS.AdminCenter.User.UserDialog.prototype.serializeAppRulePrivTab.call(this))},serializeBandwidthTab:function(){return SYNO.SDS.AdminCenter.User.UserDialog.prototype.serializeBandwidthTab.call(this)},validMail:function(e,t){t&&this.getMsgBox().confirm(this.title,_T("notification","mail_service_not_enable_revised"),(function(t){"yes"===t?(this.module.app.startModule("SYNO.SDS.AdminCenter.Notification.Main"),this.close()):e.setValue(!1)}),this)},validUserName:function(e){var t=this.userForm.findField("name"),i=this.userForm.findField("description"),s=this.userForm.findField("password"),n=t.getValue(),o=i.getValue(),a=s.getValue();if("MAILER-DAEMON"===n.toUpperCase()||"POSTMASTER"===n.toUpperCase()||n.toUpperCase()===SYNO.SDS.AdminCenter.User.CMS_USER.toUpperCase())return this.getButton("next").disable(),void t.markInvalid(_T("common","reservedname"));if(!0===e){var r={api:"SYNO.Core.User",method:"get",version:1,params:{action:"get",name:n}},l={api:"SYNO.Core.User.PasswordPolicy",method:"check",version:1,params:{name:n,description:o,password:a}};this.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:[r,l]},scope:this,encryption:["password"],callback:function(e,i,n){this.clearStatusBusy();var o=i.result[0],a=i.result[1];o.success&&(this.getButton("next").disable(),t.markInvalid(_T("user","error_nameused"))),a.success||(this.getButton("next").disable(),s.markInvalid(SYNO.SDS.AdminCenter.User.Error2Msg(a.error.code))),!o.success&&a.success&&(this.getButton("next").enable(),this.goNext(this.userFormPanel.nextId[0]))}})}else this.sendWebAPI({api:"SYNO.Core.User",method:"get",version:1,params:{action:"get",name:n},callback:function(e,i,s){this.isDestroyed||(e?(this.getButton("next").disable(),t.markInvalid(_T("user","error_nameused"))):this.getButton("next").enable())},scope:this})},applyDone:async function(e,t,i){this.isDestroyed||(this.clearStatusBusy(),e?t.has_fail?SYNO.SDS.AdminCenter.User.Alert.call(this,t.result):(this.module.ds.load(),this.close()):SYNO.SDS.AdminCenter.User.Alert.call(this))}}),Ext.define("SYNO.SDS.AdminCenter.User.DeleteDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.appWin=e.appWin,this.module=e.module,this.ownerGrid=e.ownerGrid,this.homesExist=e.homesExist,this.names=[],this.formPanel=this.createFormPanel();var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={width:540,autoHeight:!0,layout:"fit",cls:"x-window-dlg",header:!1,draggable:!1,resizable:!1,elements:"body",padding:"24px 30px 0",items:this.formPanel,fbar:["->",{xtype:"syno_button",itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.close},{xtype:"syno_button",itemId:"apply",text:_T("common","delete"),btnStyle:"red",disabled:!!this.homesExist,scope:this,handler:this.onClickDelete}]};return Ext.apply(t,e),t},createFormPanel:function(){var e={trackResetOnLoad:!0,autoScroll:!0,autoHeight:!0,padding:"0px",items:[{xtype:"syno_displayfield",itemCls:"user-delete-message",style:"font-size: 14px;",htmlEncode:!1,name:"message"},{xtype:"syno_displayfield",htmlEncode:!1,name:"username"}]};return this.homesExist&&e.items.push({xtype:"syno_checkbox",name:"",htmlEncode:!1,boxLabel:String.format('<span class="red-status">{0}</span>',_T("user","user_delete_confirm")),listeners:{check:{scope:this,fn:this.onCheckboxCheck}}}),new SYNO.SDS.Utils.FormPanel(e)},loadUserName:function(e){var t=this.formPanel.getForm(),i=t.findField("message"),s=t.findField("username"),n=e.length>5,o=(this.homesExist?_T("user","user_rm_home_warning"):"")+(n?String.format(_T("user","user_cfrmrmv_num"),e.length):_T("user","user_cfrmrmv"));i.setValue(o),n?s.setVisible(!1):s.setValue(e.join(", ")),this.names=e},onClickDelete:function(){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.applySetting)},applySetting:function(){this.close(),this.applyDeleteUser()},applyDeleteUser:function(){this.appWin.setStatusBusy(null,_T("user","deleting_user")),SYNO.API.Request({api:"SYNO.Core.User",version:1,method:"delete",params:{name:this.names},timeout:6e5,scope:this,callback:this.applyDeleteUserDone})},applyDeleteUserDone:function(e,t,i){e||SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,t.code),this.appWin.clearStatus(),this.ownerGrid.findField&&this.ownerGrid.findField.reset(),this.ownerGrid.getStore().load({params:{start:0,limit:this.ownerGrid.pageSize}})},onCheckboxCheck:function(e,t){this.getFooterToolbar().getComponent("apply").setDisabled(!t)}}),Ext.define("SYNO.SDS.AdminCenter.User.DelegateCheckbox",{extend:"SYNO.ux.TriModeCheckbox",isDirty:function(){return this.callParent()&&""!==this.getValue()},getNextStat:function(){var e=this.callParent();return null!==e&&e}}),Ext.define("SYNO.SDS.AdminCenter.User.DelegateDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.type=e.type,this.name=e.name.sort(),this.delegationFormPanel=this.initDelegationForm(),this.delegationForm=this.delegationFormPanel.getForm();var t={width:648,height:550,minWidth:648,minHeight:550,layout:"fit",title:_T("delegation","title"),buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.close},{text:_T("common","alt_apply"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.delegationFormPanel]};Ext.apply(t,e),this.callParent([t]),this.delegationForm.findField("desc").getEl().addListener("click",this.launchHelp,this),this.getDelegationRoles()},launchHelp:function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/file_user_delegate.html"},!1)},getDelegationRoles:function(){this.setStatusBusy();var e=[];this.roles=[],this.sendWebAPI({api:"SYNO.Core.ActionPriv.Role",version:1,method:"list",callback:function(t,i,s){if(t){this.roles=i.roles,Ext.each(this.roles,(function(t){e.push(new SYNO.SDS.AdminCenter.User.DelegateCheckbox({name:t.priv_id,boxLabel:_T(t.title.split(":")[0],t.title.split(":")[1]),htmlEncode:!1,itemCls:"role-delegate-checkbox"}),{xtype:"syno_displayfield",value:_T(t.desc.split(":")[0],t.desc.split(":")[1]),indent:1,htmlEncode:!1,name:"desc"})}));var n={xtype:"syno_fieldset",title:_T("delegation","roles"),collapsible:!1,padding:"0 0 0 4px",itemId:"roles_fieldset",items:e};this.delegationFormPanel.remove("roles_fieldset"),this.delegationFormPanel.add(n),this.delegationFormPanel.doLayout(),this.loadInfo()}else this.clearStatusBusy(),this.getMsgBox().alert(_T("delegation","title"),_T("delegation","failed_get_roles"))},scope:this})},onClose:function(){return!0===this.confirmToLeave||!1!==this.callParent(arguments)&&(!this.isTabsDirty()||(this.getMsgBox().confirm(_T("delegation","delegation"),_T("common","confirm_lostchange"),(function(e){"yes"===e&&(this.confirmToLeave=!0,this.close())}),this),!1))},initDelegationForm:function(e){this.linkID=Ext.id();var t={title:_T("delegation","title"),labelWidth:150,items:[{xtype:"syno_displayfield",htmlEncode:!1,value:String.format(_T("delegation","desc"),'<a id="'+this.linkID+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</a>"),name:"desc"},{xtype:"syno_displayfield",hideLabel:!1,fieldLabel:_T("delegation","delegate_to"),name:"name",allowBlank:!1,blankText:_T("user","error_noname"),htmlEncode:!1,width:400,value:this.name},{xtype:"spacer",height:12},{xtype:"syno_fieldset",title:_T("delegation","roles"),collapsible:!1,itemId:"roles_fieldset",items:[]}]};return Ext.apply(t,e),new SYNO.SDS.Utils.FormPanel(t)},setDefaultValue:function(e,t){var i=this.delegationForm.findField(e);null!==i&&(i.setValue(t),i.originalValue=t)},loadInfo:function(){var e=[{api:"SYNO.Core.ActionPriv",version:1,method:"get",params:{type:this.type,name:this.name}}];"user"===this.type&&e.push({api:"SYNO.Core.Group.Member",version:1,method:"admin_check",params:{name:this.name}}),this.sendWebAPI({compound:{params:e},callback:function(e,t,i){if(this.clearStatusBusy(),e&&!t.has_fail){var s,n,o=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Group.Member","admin_check"),a=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.ActionPriv","get"),r=!1;if(Ext.isObject(o)){for(s=0;s<o.users.length;++s)if(!0===o.users[s].is_admin){r=!0;break}n=1===o.users.length?String.format(_T("delegation","is_admin_user"),"<b>"+this.name[0]+"</b>"):_T("delegation","contain_admin_user")}else{for(s=0;s<this.name.length;++s)if("administrators"===this.name[s]){r=!0;break}n=String.format(_T("delegation","is_admin_user"),"<b>administrators</b>")}r&&(this.delegationFormPanel.getEl().mask(n,"syno-ux-mask-info"),this.getFooterToolbar().getComponent("apply").disable()),Ext.isObject(a)&&a.privileges&&Ext.each(a.privileges,(function(e){this.setDefaultValue(e.priv_id,"full"===e.state||null)}),this)}else this.owner.getMsgBox().alert(_T("delegation","title"),_T("delegation","failed_get_privs"))},scope:this})},isTabsDirty:function(){return!!this.delegationForm.isDirty()},setPrivileges:function(){for(var e=[],t=[],i=0;i<this.roles.length;i++)this.delegationForm.findField(this.roles[i].priv_id).isDirty()&&("true"===this.delegationForm.findField(this.roles[i].priv_id).getValue()?e.push(this.roles[i].priv_id):t.push(this.roles[i].priv_id));this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.ActionPriv",version:1,method:"set",params:{type:this.type,name:this.name,add_roles:e,delete_roles:t},callback:function(e,t,i){this.clearStatusBusy(),e?(this.delegationForm.reset(),this.close()):5===t.code?this.owner.getMsgBox().alert(_T("delegation","title"),String.format(_T("delegation","delegation_rule_max"),_T("tree","leaf_"+this.type))):this.owner.getMsgBox().alert(_T("delegation","title"),_T("delegation","failed_set_privs"))},scope:this})},onApply:function(){this.isTabsDirty()?SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.setPrivileges):this.close()}}),Ext.define("SYNO.SDS.AdminCenter.User.DelegateViewerDialog",{extend:"SYNO.SDS.ModalWindow",SEPARATOR_LINE:'<hr style="height: 1px;margin: 0;background: rgba(198,212,224,0.40); border: 0;">',constructor:function(e){this.module=e.module,this.owner=e.owner,this.previewFormPanel=this.initPreviewForm(),this.previewForm=this.previewFormPanel.getForm();var t={width:648,height:550,minWidth:648,minHeight:550,layout:"fit",title:_T("delegation","permission_viewer"),buttons:[{text:_T("common","alt_close"),scope:this,handler:this.close}],items:[this.previewFormPanel]};Ext.apply(t,e),this.callParent([t]),this.previewFormPanel.mon(this.previewForm.findField("permission_type"),"select",(function(){"roles"===this.previewForm.findField("permission_type").getValue()?this.previewForm.findField("account_type").disable():this.previewForm.findField("account_type").enable(),this.getPreviewResult()}),this),this.previewFormPanel.mon(this.previewForm.findField("account_type"),"select",(function(){this.getPreviewResult()}),this)},exportHandler:function(){synowebapi.download({api:"SYNO.Core.ActionPriv",method:"export",version:1})},onOpen:function(){this.getDelegationRoles(),this.callParent(arguments)},initPreviewForm:function(e){var t={title:_T("delegation","permission_viewer"),items:[{xtype:"syno_displayfield",value:_T("delegation","export_desc"),name:"desc"},{xtype:"syno_button",text:_T("delegation","export"),itemId:"export",style:{marginLeft:"8px"},scope:this,handler:this.exportHandler},{xtype:"spacer",height:18},{xtype:"syno_fieldset",title:_T("delegation","permission_preview"),collapsible:!1,style:{marginBottom:"0px"},itemId:"permission_preview_fieldset",items:[{xtype:"syno_compositefield",hideLabel:!0,fieldLabel:"permission_preview",itemId:"permission_preview",items:[{xtype:"syno_combobox",name:"permission_type",width:250,valueField:"id",displayField:"display",allowBlank:!1,store:new Ext.data.JsonStore({fields:["id","display"],idProperty:"id",data:[{id:"roles",display:_T("delegation","preview_by_roles")},{id:"account",display:_T("delegation","preview_by_account")}]}),value:"roles",tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" role="option" aria-label="{display}" id="{[Ext.id()]}" ext:qtip="{display}">',"{display}","</div>","</tpl>")},{xtype:"syno_combobox",name:"account_type",width:250,valueField:"id",displayField:"display",allowBlank:!1,disabled:!0,store:new Ext.data.JsonStore({fields:["id","display"],idProperty:"id",data:[{id:"all",display:_T("delegation","all_account")},{id:"local",display:_T("delegation","local_account")},{id:"directory",display:_T("delegation","directory_account")}]}),value:"all",tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" role="option" aria-label="{display}" id="{[Ext.id()]}" ext:qtip="{display}">',"{display}","</div>","</tpl>")}]},{xtype:"syno_fieldset",title:"",collapsible:!1,itemId:"preview_data",bwrapCfg:{padding:0},items:[]}]}]};return Ext.apply(t,e),new SYNO.SDS.Utils.FormPanel(t)},getRoleNameStr:function(e,t){for(var i=0;i<this.roles.length;i++)if(this.roles[i].priv_id===e)return _T(this.roles[i][t].split(":")[0],this.roles[i][t].split(":")[1]);return e},getDelegationRoles:function(){this.roles=[],this.sendWebAPI({api:"SYNO.Core.ActionPriv.Role",version:1,method:"list",callback:function(e,t,i){e?(this.roles=t.roles,this.getPreviewResult()):this.getMsgBox().alert(_T("delegation","title"),_T("delegation","failed_get_roles"))},scope:this})},addQtipTo:function(e){return String.format('<div ext:qtip="{0}">{1}</div>',e,e)},parseAccountPreviewData:function(e,t){var i=[],s="";return Ext.each(e,(function(e){s="";for(var n=0;n<e.priv_id.length;n++)""!==s&&(s+=", "),s+=this.getRoleNameStr(e.priv_id[n],"title");i.push({xtype:"syno_displayfield",htmlEncode:!1,height:1,value:this.SEPARATOR_LINE},{xtype:"syno_displayfield",htmlEncode:!1,height:24,value:'<div style="float:left;font-weight:bold;">'+e.name+'</div><div span style="color:rgba(60,118,255,1);width:auto;margin-left:8px;padding-left:12px;padding-right:12px;float:left;border-radius:3px;background-color:rgba(60,118,255,0.1)">'+_T("tree","leaf_"+t)+"</span></div>"},{xtype:"syno_displayfield",htmlEncode:!1,value:this.addQtipTo(s)})}),this),i},parseRolesPreviewData:function(e){var t=[];return Ext.each(e,(function(e){(e.user.length>0||e.group.length>0)&&t.push({xtype:"syno_displayfield",htmlEncode:!1,height:1,padding:4,value:this.SEPARATOR_LINE},{xtype:"syno_displayfield",htmlEncode:!1,height:24,value:this.getRoleNameStr(e.priv_id,"title").bold()},{xtype:"syno_displayfield",htmlEncode:!1,height:32,hideLabel:!1,fieldLabel:_T("tree","leaf_user"),style:"padding-left: 5px;",hidden:!(e.user.length>0),value:e.user.length>0?this.addQtipTo(e.user.sort().join(", ")):"-"},{xtype:"syno_displayfield",htmlEncode:!1,height:32,hideLabel:!1,fieldLabel:_T("tree","leaf_group"),style:"padding-left: 5px;",hidden:!(e.group.length>0),value:e.group.length>0?this.addQtipTo(e.group.sort().join(", ")):"-"})}),this),t},getPreviewResult:function(){var e=this.previewForm.findField("permission_type").getValue(),t=this.previewForm.findField("account_type").getValue(),i="roles"===e,s="all"===t||"local"===t,n="all"===t||"directory"===t;this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.ActionPriv",version:1,method:"preview",params:{roles:i,local:!i&&s,directory:!i&&n},callback:function(e,t,i){if(this.clearStatusBusy(),e){var s=[];t.roles&&t.roles.length>0?s.push(this.parseRolesPreviewData(t.roles)):t.user&&t.group?(t.user.length>0&&s.push(this.parseAccountPreviewData(t.user,"user")),t.group.length>0&&s.push(this.parseAccountPreviewData(t.group,"group"))):this.body.mask(_T("delegation","empty_setting"),"syno-ux-mask-info");var n={xtype:"syno_fieldset",title:"",itemId:"preview_data",bwrapCfg:{padding:0},labelWidth:150,items:s};this.previewFormPanel.getComponent("permission_preview_fieldset").remove("preview_data"),this.previewFormPanel.getComponent("permission_preview_fieldset").add(n),this.previewFormPanel.doLayout()}else this.owner.getMsgBox().alert(_T("delegation","title"),_T("delegation","failed_get_preview"))},scope:this})}}),Ext.define("SYNO.SDS.AdminCenter.Group.MemberGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.groupName=e.groupName;let t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.store=new Ext.data.JsonStore({fields:[{name:"name",sortType:"asNaturalUCString"},{name:"desc",sortType:"asNaturalUCString"},"is_member"],pruneModifiedRecords:!0,sortInfo:{field:"name",direction:"ASC"}});let t=function(e,t){return"users"===e||"administrators"===e&&0<=["admin","guest",_S("user")].indexOf(t)},i=new SYNO.ux.EnableColumn({enableFastSelectAll:!0,header:this.owner.newgroup?_T("common","add"):_T("group","group_members"),dataIndex:"is_member",align:"center",groupName:this.groupName,isIgnore:function(e,i){return t(this.groupName,i.get("name"))},renderer:function(e,i,s){return t(this.groupName,s.get("name"))?this.disableRenderer(e,i,s):SYNO.ux.EnableColumn.prototype.renderer.call(this,e,i,s)}});var s={title:_T("group","group_members"),store:this.store,columns:[{header:_T("user","user_account"),dataIndex:"name",sortable:!0,renderer:function(e,t,i){return"administrators"===this.groupName&&_S("user")===e?`${e} (${_T("group","current_account")})`:e}.bind(this)},{header:_T("user","user_fullname"),dataIndex:"desc",sortable:!0},i],plugins:[i],autoExpandColumn:"desc",enableHdMenu:!1,enableColumnMove:!1,view:new SYNO.ux.FleXcroll.grid.BufferView({trackResetOnLoad:!1,scrollDelay:!1,cacheSize:50}),tbar:["->",this.getSearchField()],bbar:new SYNO.ux.PageLessToolbar({store:this.store,doRefresh:this.doRefresh.bind(this)}),listeners:{scope:this,afterrender:this.onAfterrender,activate:this.onActivate}};return Ext.apply(s,e)},onAfterrender:function(e){if(this.load(),this.owner.newgroup){var t=e.getGridEl(),i=e.tbar;t.setStyle("padding-top","0px"),i.setStyle("padding-top","24px")}},onActivate:function(e){"users"===this.groupName&&e.mask(_T("group","users_group_mask_info"),"syno-ux-mask-info")},getSearchField:function(){let e={itemId:"search",localFilter:!0,localFilterField:["name","desc"],blOr:!0,width:200,emptyText:_T("user","search_user"),store:this.store};return this.owner.newgroup?new SYNO.ux.TextFilter(e):new SYNO.ux.SearchField(Ext.apply(e,{menu:new SYNO.ux.Menu({cls:"syno-ux-check-menu",items:[{checked:!0,value:"all",text:_T("common","show_all")},{value:"member",text:_T("group","group_members")}],defaults:{group:"member_search_type",checked:!1},listeners:{scope:this,itemclick:this.onMemberMenuSelect}}),getMenu:function(){return this.menu}}))},onMemberMenuSelect:function(e){this.memberSearchType=e.value,this.load()},load:function(){this.owner.newgroup||!this.isDirty()?this.groupName?this.loadMembers():this.loadUsers():this.owner.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?this.saveAndLoad():(this.getStore().rejectChanges(),this.load())}),this)},loadUsers:function(){this.owner.setStatusBusy(),this.owner.sendWebAPI({api:"SYNO.Core.User",method:"list",version:1,params:{additional:["description"]},callback:function(e,t,i){if(this.owner.clearStatusBusy(),!e){let e=SYNO.API.Response.GetFirstError(t);return void this.getMsgBox().alert("warning_msg",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}let s=t.users.map((e=>({name:e.name,desc:e.description,is_member:!1})));this.getStore().loadData(s)},scope:this})},loadMembers:function(){let e=[{api:"SYNO.Core.Group.Member",method:"list",version:1,params:{group:this.groupName,ingroup:!0}}];"member"!==this.memberSearchType&&e.push({api:"SYNO.Core.Group.Member",method:"list",version:1,params:{group:this.groupName,ingroup:!1}}),this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{params:e},callback:function(e,t,i){if(this.owner.clearStatusBusy(),!e||t.has_fail){let e=SYNO.API.Response.GetFirstError(t);return void this.getMsgBox().alert("warning_msg",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}let s=t.result[0].data.users.map((e=>({name:e.name,desc:e.description,is_member:!0})));t.result[1]&&(s=s.concat(t.result[1].data.users.map((e=>({name:e.name,desc:e.description,is_member:!1}))))),this.getStore().loadData(s)},scope:this})},doRefresh:function(){this.load()},saveAndLoad:function(){this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{params:this.getWebAPIParams(this.groupName)},callback:function(e,t,i){if(this.owner.clearStatusBusy(),e&&!t.has_fail)this.getStore().commitChanges(),this.load();else{let e=SYNO.API.Response.GetFirstError(t);this.owner.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})},isDirty:function(){return 0<this.getStore().getModifiedRecords().length},getWebAPIParams:function(e){let t=[],i=[];return this.isDirty()?(this.getStore().getModifiedRecords().forEach((e=>{e.get("is_member")?t.push(e.get("name")):i.push(e.get("name"))})),[{api:"SYNO.Core.Group.Member",method:"change",version:1,params:{group:e,add_member:t,remove_member:i}}]):[]}}),Ext.ns("SYNO.SDS.AdminCenter.Group"),Ext.ns("SYNO.SDS.Share"),SYNO.SDS.AdminCenter.Group.GetErrMsg=function(e,t){var i=3299,s=SYNO.API.Errors.core[i],n="";if(e){if("string"==typeof e)s=e;else if("number"==typeof e)i=e,s=SYNO.API.Errors.core[e];else if(e instanceof Array)for(var o=0;o<e.length;o++)if(!e[o].success){i=e[o].error.code,s=SYNO.API.Errors.core[i],3321===i&&(n=e[o].error.errors.fail_share);break}}else;switch(i){case 3209:s=String.format(s,_D("maxgroups"));break;case 3321:s=String.format(_T("share","error_too_many_acl_rules_with_sharename"),n)}return s},SYNO.SDS.AdminCenter.Group.Alert=function(e,t){return this.getMsgBox().alert(_T("tree","leaf_group"),SYNO.SDS.AdminCenter.Group.GetErrMsg(e,t)||_T("common","error_system"))},Ext.define("SYNO.SDS.AdminCenter.Group.GroupShareGrid",{extend:SYNO.ux.GridPanel,WEBAPI_PARAM_SHARE_TYPE:["dec","local","usb","sata","cluster","c2","cold_storage","worm"],WEBAPI_PARAM_ADDITIONAL:["hidden","encryption","is_aclmode"],constructor:function(e){this.module=e.module,this.owner=e.owner,this.authType=e.authType,this.showHomesWarning=!0,this.colRo=new SYNO.ux.EnableColumn({header:_T("share","share_permission_readonly"),dataIndex:"is_readonly",width:120,align:"center",ownerGrid:this,isIgnore:function(e,t){return!0===t.get("is_mask")||this.ownerGrid.owner.isAdminGroup&&t.get("is_aclmode")},renderer:function(e,t,i){return(!0===i.get("is_mask")||this.ownerGrid.owner.isAdminGroup&&i.get("is_aclmode"))&&(e="disabled"),SYNO.SDS.Share.renderCheckBox.call(this,e,t,i)}}),this.colRw=new SYNO.ux.EnableColumn({header:_T("share","share_permission_writable"),dataIndex:"is_writable",width:120,align:"center",isIgnore:function(e,t){return!0===t.get("is_mask")},renderer:function(e,t,i){return!0===i.get("is_mask")?SYNO.SDS.Share.renderCheckBox.call(this,"disabled",t,i):SYNO.ux.EnableColumn.prototype.renderer.call(this,e,t,i)}}),this.colNa=new SYNO.ux.EnableColumn({header:_T("share","share_permission_none"),dataIndex:"is_deny",width:120,align:"center",isIgnore:function(e,t){return!0===t.get("is_mask")},renderer:function(e,t,i){return!0===i.get("is_mask")?SYNO.SDS.Share.renderCheckBox.call(this,"disabled",t,i):SYNO.ux.EnableColumn.prototype.renderer.call(this,e,t,i)}});var t=e.hideCustomColumn;t=t||e.newGroup||"yes"===_D("usbstation","no")||!_S("is_admin"),this.colCu=new SYNO.SDS.Share.CustomColumn({module:this.module,owner:this.owner,ownerGrid:this,dataIndex:"is_custom",hidden:t,applyCallback:function(){this.loadInfo(this.owner.groupName)},applyTarget:this});var i=this.createStore(),s='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("share","share_privileges_priority"),n={title:_T("tree","leaf_group"),store:i,header:!1,height:350,cls:"without-dirty-red-grid",stripeRows:!0,enableColumnMove:!1,enableHdMenu:!1,autoExpandColumn:"name",colModel:new Ext.grid.ColumnModel({columns:[new SYNO.SDS.Share.InfoColumn({dataIndex:"is_unite_permission",width:55,hidden:e.newGroup||!1}),{id:"name",header:_T("share","share_name"),dataIndex:"name",width:200},new SYNO.SDS.AdminCenter.Share.Utils.PermissionColumn({header:_T("share","share_inherit"),align:"left",hidden:e.newGroup,convert:SYNO.SDS.AdminCenter.Share.Utils.convertBoolPermissions}),this.colNa,this.colRw,this.colRo,this.colCu]}),plugins:[this.colRo,this.colRw,this.colNa,this.colCu],selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),bbar:new SYNO.ux.PageLessToolbar({store:i,doRefresh:this.doRefresh.bind(this)}),fbar:{xtype:"syno_toolbar",layout:"fit",style:"padding-top: 12px;",items:[{xtype:"syno_displayfield",htmlEncode:!1,style:"white-space: normal;",value:s,"aria-label":SYNO.ux.Utils.ConvertSingleSymbolToString(s,">",!0)}]},footerCfg:{style:"padding: 0px;"}};Ext.apply(n,e),this.callParent([n]),this.mon(this,"afterrender",this.defineShareGridBehaviors,this),this.mon(this,"afterlayout",(function(e,t){e.getView().updateScroller()}),this),this.mon(this.colNa,"click",(function(e,t,i,s){var n=t.getStore().getAt(i);this.showHomesWarning&&"homes"===n.id&&!0===n.get("is_deny")&&!0===n.get("is_aclmode")&&(this.owner.getMsgBox().alert(this.title,_T("share","warn_deny_rule_homes")),this.showHomesWarning=!1)}),this)},doRefresh:function(){this.owner.newgroup||!this.isChanged()?this.loadInfo(this.owner.groupName):this.owner.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?this.saveAndRefresh():(this.getStore().rejectChanges(),this.doRefresh())}),this)},saveAndRefresh:function(){this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{params:this.getWebAPI(this.owner.groupName)},callback:function(e,t,i){if(this.owner.clearStatusBusy(),e&&!t.has_fail)this.getStore().commitChanges(),this.doRefresh();else{let e=SYNO.API.Response.GetFirstError(t);this.owner.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})},createStore:function(){var e=["is_aclmode","name","permission","is_writable","is_readonly","is_deny","is_custom","share_path","is_unite_permission",{name:"force_readonly_reason",defaultValue:void 0},"is_mask"];return"yes"===_D("support_s2s","no")&&e.push("is_sync_share"),new SYNO.API.JsonStore({autoDestroy:!0,appWindow:this.owner,api:"SYNO.Core.Share.Permission",method:"list_by_group",version:1,baseParams:{user_group_type:this.authType+"_group",share_type:this.WEBAPI_PARAM_SHARE_TYPE,additional:this.WEBAPI_PARAM_ADDITIONAL},listeners:{exception:{scope:this,fn:this.onStoreException},beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad}},root:"shares",idProperty:"name",totalProperty:"total",fields:e})},onBeforeLoad:function(e,t){this.owner.setStatusBusy()},onLoad:function(e,t,i){this.owner.clearStatusBusy(),this.loadedPrivList=[];for(var s=0;s<t.length;++s)this.loadedPrivList.push({name:t[s].data.name,is_readonly:t[s].data.is_readonly,is_writable:t[s].data.is_writable,is_deny:t[s].data.is_deny,is_custom:t[s].data.is_custom})},onStoreException:function(e,t,i,s,n,o){if(this.owner.clearStatusBusy(),SYNO.Debug("Store exception: options:",e,t,i,s,n,o),!this.owner.isAlertExist){this.owner.isAlertExist=!0;var a=SYNO.SDS.AdminCenter.Group.GetErrMsg(n.code?n.code:3299,this.module);this.owner.getMsgBox().alert(_T("tree","leaf_group"),a,(function(){this.close(),this.isAlertExist=!1}),this.owner)}},loadInfo:function(e){this.getStore().load({params:{name:e?e.toString():""}})},initComponent:function(){this.callParent(arguments),this.mon(this,"headerclick",(function(e,t,i){this.getStore().suspendEvents(!1)}),this)},defineShareGridBehaviors:function(){this.colRo.checkSelectAll(this.getStore()),this.colRw.checkSelectAll(this.getStore()),this.colNa.checkSelectAll(this.getStore()),this.mon(this,"cellclick",this.onGridCellClick,this),this.mon(this.getSelectionModel(),"spacepressed",this.onGridCellSpacePressed,this),this.mon(this,"headerspace",(function(e){var t=this.getColumnModel(),i=t.findColumnIndex(e.dataIndex),s=t.getColumnId(i);this.onGridHeaderClick.call(this,t.getColumnById(s))}),this),this.mon(this,"headerclick",(function(e,t,i){var s=e.getColumnModel(),n=s.getColumnId(t);this.onGridHeaderClick.call(this,s.getColumnById(n))}),this)},onGridHeaderClick:function(e){e.box_el&&(e.box_el.hasClass("syno-ux-cb-checked")?("is_readonly"!==e.dataIndex&&(this.colRo.box_el.removeClass("syno-ux-cb-checked"),this.colRo.onSelectAll()),"is_writable"!==e.dataIndex&&(this.colRw.box_el.removeClass("syno-ux-cb-checked"),this.colRw.onSelectAll()),"is_deny"!==e.dataIndex&&(this.colNa.box_el.removeClass("syno-ux-cb-checked"),this.colNa.onSelectAll()),this.getStore().each((function(e){e.set("is_custom",!1)}),this)):this.getStore().each((function(e){var t=e.getChanges();t.hasOwnProperty("is_custom")&&e.set("is_custom",!t.is_custom)}),this)),this.getStore().resumeEvents(),this.getView().refresh()},onGridCellSpacePressed:function(e,t){var i=e.grid,s=i.getStore().indexOf(e.getSelected()),n=e.getColIdx();0<=n&&this.onGridCellClick(i,s,n,t)},onGridCellClick:function(e,t,i,s){var n=e.getStore().getAt(t),o=e.getColumnModel().getDataIndex(i);if(!_S("is_admin")&&"is_writable"===o&&n.getChanges().hasOwnProperty("is_writable")&&this.owner.sharePermLimited.hasOwnProperty(n.data.name)&&!this.owner.sharePermLimited[n.data.name]&&!0===n.get("is_writable"))return n.set("is_writable",!1),void this.owner.getMsgBox().alert(this.title,_T("error","error_privilege_not_enough"));(function(e){return"is_readonly"===e||"is_writable"===e||"is_deny"===e})(o)&&(!0===n.get(o)?function(e,t,i){"is_readonly"!==e&&(t.set("is_readonly",!1),i.colRo.checkSelectAll(i.getStore())),"is_writable"!==e&&(t.set("is_writable",!1),i.colRw.checkSelectAll(i.getStore())),"is_deny"!==e&&(t.set("is_deny",!1),i.colNa.checkSelectAll(i.getStore())),"is_custom"!==e&&t.set("is_custom",!1)}(o,n,e):n.getChanges().hasOwnProperty("is_custom")&&n.set("is_custom",!n.getChanges().is_custom))},isChanged:function(){return 0!==this.getChangedRecords().length},isRecordPrivChanged:function(e){for(var t=0;t<this.loadedPrivList.length;++t)if(this.loadedPrivList[t].name==e.data.name){if(this.loadedPrivList[t].is_readonly!=e.data.is_readonly||this.loadedPrivList[t].is_writable!=e.data.is_writable||this.loadedPrivList[t].is_deny!=e.data.is_deny)return!0;break}return!1},getChangedRecords:function(){var e=[];return Ext.each(this.getStore().getModifiedRecords(),(function(t){this.isRecordPrivChanged(t)&&e.push(t)}),this),e},getFinalPermission:function(e){return e.data.is_deny?"na":e.data.is_writable||this.owner.isAdminGroup&&e.data.is_aclmode?"rw":e.data.is_readonly?"ro":""},getOpenConfig:function(){return{userName:this.owner.groupName,userType:"group"}},getWebAPI:function(e){var t=[];return Ext.each(this.getChangedRecords(),(function(e){t.push({name:e.data.name,is_readonly:e.data.is_readonly,is_writable:e.data.is_writable,is_deny:e.data.is_deny,is_custom:e.data.is_custom})})),0===t.length?[]:[{api:"SYNO.Core.Share.Permission",method:"set_by_user_group",version:1,params:{name:e||this.owner.groupName,user_group_type:this.authType+"_group",permissions:t}}]},getShareInfoForS2S:function(){var e=[];return Ext.each(this.getChangedRecords(),(function(t){e.push({name:t.data.name,is_sync_share:t.data.is_sync_share,permissions:[{is_readonly:t.data.is_readonly,is_deny:t.data.is_deny,is_writable:t.data.is_writable,is_custom:t.data.is_custom}]})})),e}}),Ext.define("SYNO.SDS.AdminCenter.Group.QuotaGrid",{extend:"SYNO.ux.EditorGridPanel",constructor:function(e){this.supportShareQuota="yes"===_D("support_share_quota","no");var t=this.createStore(),i=this.createColModel(t),s=Ext.apply({plugins:[i.getColumnById("quota_enabled")],cls:"quota-grid",autoExpandColumn:"display_name",enableHdMenu:!1,enableColumnMove:!1,clicksToEdit:1,store:t,colModel:i,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),view:new SYNO.ux.GroupingView({showGroupName:!1,getRowClass:function(e){if(this.isQuotaStatusDisabled(e.get("quota_status")))return"quota-row-disable"}.bind(this)}),listeners:{beforeedit:function(e){var t=e.record;"crash"!==t.get("status")&&t.get("target")||(e.cancel=!0)},cellclick:{delay:100,scope:this,fn:this.onCellClick},headerclick:{scope:this,fn:this.onHeaderClick},validateedit:{scope:this,fn:this.checkVolumeConstraint}},bbar:new SYNO.ux.PageLessToolbar({store:t,doRefresh:this.doRefresh.bind(this)})},e);this.callParent([s])},doRefresh:function(){this.isSupportQuota||(this.owner.newgroup||!this.isDirty()?this.initForCreation():this.owner.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?this.saveAndRefresh():(this.getStore().rejectChanges(),this.doRefresh())}),this))},saveAndRefresh:function(){this.owner.setStatusBusy(),this.owner.sendWebAPI({compound:{params:this.getWebAPI(this.owner.groupName)},callback:function(e,t,i){if(this.owner.clearStatusBusy(),e&&!t.has_fail)this.getStore().commitChanges(),this.doRefresh();else{let e=SYNO.API.Response.GetFirstError(t);this.owner.getMsgBox().alert("",SYNO.API.Errors.core[e.code]||_T("common","error_system"))}},scope:this})},isQuotaStatusDisabled:function(e){return"incompatible"===e},convertToMB:function(e,t){return"TB"===t?1024*e*1024:"GB"===t?1024*e:e},checkVolumeConstraint:function(e){var t=4194304,i=e.record,s=i.get("total"),n=null,o="";if("quota"===e.field)n=this.convertToMB(e.value,i.get("unit"));else{if("unit"!==e.field)return!1;n=this.convertToMB(i.get("quota"),e.value)}return n>=s?(s/=1024,o=String.format(_T("user","user_quota_limit_max_vol"),i.get("volume"),s.toFixed(2)),e.grid.owner.getMsgBox().alert(_T("user","error_quota_set"),o),!1):!(i.get("limit_4T")&&n>=t)||(o="TB"===i.get("unit")?String.format(_JSLIBSTR("extlang","maxnumber"),"3 TB"):"GB"===i.get("unit")?String.format(_JSLIBSTR("extlang","maxnumber"),"4095 GB"):String.format(_JSLIBSTR("extlang","maxnumber"),"4194304 MB"),e.grid.owner.getMsgBox().alert(_T("user","error_quota_set"),o),!1)},onCellClick:function(e,t,i,s){var n=e.getStore().getAt(t);"quota_enabled"===e.getColumnModel().getColumnAt(i).id&&"crash"!==n.get("status")&&n.get("target")&&(n.get("quota_enabled")?(n.set("quota",1),e.startEditing(t,i-2)):n.set("quota",0))},onHeaderClick:function(e,t,i){var s=i.getTarget("input",1,!1);"quota_enabled"===e.getColumnModel().getColumnAt(t).id&&s&&e.getStore().each((function(e){if(!e.get("target"))return!0;s.classList.contains("syno-ux-cb-checked")?e.set("quota",0):0===e.get("quota")&&e.set("quota",1)}))},createStore:function(){return new Ext.data.GroupingStore({listeners:{beforeload:{scope:this,fn:function(){this.owner.setStatusBusy()}},load:{scope:this,fn:function(){this.owner.clearStatusBusy()}},exception:{scope:this,fn:function(e,t,i,s,n,o){this.owner.clearStatusBusy(),SYNO.Debug("Store exception: ",e,t,i,s,n,o)}}},reader:new Ext.data.JsonReader({fields:[{name:"name",mapping:"name"},{name:"description",mapping:"description"},{name:"quota",mapping:"quota"},{name:"unit",mapping:"unit"},{name:"quota_enabled",mapping:"quota_enabled"},{name:"limit_4T",mapping:"limit_4T"},{name:"status",mapping:"status"},{name:"quota_status",mapping:"quota_status"},{name:"deduped",mapping:"deduped"},{name:"total",mapping:"total"},{name:"volume",mapping:"volume"},{name:"target",mapping:"target"},{name:"display_name",mapping:"display_name"}]}),groupField:"volume",idProperty:"name",autoDestroy:!0,remoteSort:!1})},createColModel:function(e){let t=this;var i=new Ext.data.ArrayStore({fields:["value","display"],data:this.supportShareQuota?[["TB",_T("common","size_tb")],["GB",_T("common","size_gb")],["MB",_T("common","size_mb")]]:[["GB",_T("common","size_gb")],["MB",_T("common","size_mb")]]}),s=[{header:this.supportShareQuota?_T("common","volume_share"):_T("volume","volume"),dataIndex:"display_name",width:150,renderer:function(e,t,i){return t.attr='ext:qtip="'+e+'"',"normal"===i.get("status")?e:String.format('(<font class="red-status">{0}</font>)',e)}},{header:_T("group","group_quota_header"),dataIndex:"quota",id:"quota",width:120,editor:new SYNO.ux.NumberField({allowBlank:!0,allowNegative:!1,allowDecimals:!1,validateOnBlur:!0,selectOnFocus:!0,emptyText:_T("dhcp_server","unlimited"),validationEvent:"keyup",vtype:"number",listeners:{beforeshow:function(e){e.getValue()||e.reset()}}}),renderer:function(e,t,i){return e||(i.set(this.dataIndex,0),t.attr='style="color:#aaaaaa;"',e=_T("dhcp_server","unlimited")),i.get("target")?e:""}},{header:"",dataIndex:"unit",id:"unit",width:80,editor:new SYNO.ux.ComboBox({store:i,lazyRender:!0,mode:"local",displayField:"display",valueField:"value",triggerAction:"all",editable:!1}),renderer:function(e,t,i){return i.get("target")?_T("common","size_"+e.toLowerCase()):""}},new SYNO.ux.EnableColumn({header:_T("user","enable_quota"),id:"quota_enabled",dataIndex:"quota_enabled",align:"center",width:170,hidden:!0,enableFastSelectAll:!0,isIgnore:function(e,t){return!t.get("target")},renderer:function(e,t,i){return i.get("target")?SYNO.ux.EnableColumn.prototype.renderer.apply(this,arguments):""}}),{dataIndex:"volume",hidden:!0,groupRenderer:function(e,i,s){if("share"===s.get("target")&&(e+=" (btrfs)"),"volume"===s.get("target")&&(e+=" (ext4)"),t.isQuotaStatusDisabled(s.get("quota_status"))){e+=`<span class="syno-ux-whitetip-icon" ext:wtip="${Ext.util.Format.htmlEncode(_T("user","user_quota_unsupported"))}"></span>`}return e}}];return new Ext.grid.ColumnModel({defaults:{width:130,align:"left"},columns:s,isCellEditable:function(i,s){var n=e.getAt(s);return!t.isQuotaStatusDisabled(n.get("quota_status"))&&Ext.grid.ColumnModel.prototype.isCellEditable.call(this,i,s)}})},configLeafObj:function(e,t){e.quota=Math.floor(e.quota),e.unit="MB",e.quota%1024==0&&(e.quota/=1024,e.unit="GB"),e.quota%1024==0&&(e.quota/=1024,e.unit="TB"),e.quota_enabled=0!==e.quota,e.quota_enabled||(e.unit="GB"),e.status=t.readonly?"crash":"normal",e.volume=t.display_name,e.total=Math.floor(t.size_total_byte/1024/1024),e.leaf=!0,e.expanded=!1},loadQuotaSettings:function(e,t,i){var s=this,n={},o=[];Ext.each(t.volumes,(function(e){n[e.volume_path]=e})),Ext.each(e.group_quota,(function(e){var t=n[e.volume];e.support_share_quota?(e.children=e.shares,e.leaf=!1,e.expanded=!0,e.status=t.readonly?"crash":"normal",e.volume=t.display_name,e.total=Math.floor(t.size_total_byte/1024/1024),e.display_name=t.display_name,e.description=Ext.util.Format.htmlEncode(t.description),Ext.each(e.children,(function(i){s.configLeafObj(i,t),i.target="share",i.limit_4T=!1,i.display_name=i.name,i.description=Ext.util.Format.htmlEncode(i.description),i.quota_status=e.quota_status,i.deduped=e.deduped,o.push(i)}))):(s.configLeafObj(e,t),e.target="volume",e.limit_4T=!0,e.name=t.volume_path,e.display_name=t.display_name,e.description=Ext.util.Format.htmlEncode(t.description),o.push(e))})),this.getStore().loadData(o),Ext.isObject(i)&&i.is_admin&&(this.mon(this,"activate",(function(e){e.mask(String.format(_T("user","edit_adminquota"),i.name))})),this.mon(this,"deactivate",(function(e){e.unmask()})))},initForCreation:function(){this.owner.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({compound:{stopwhenerror:!0,params:[{api:"SYNO.Core.Quota",method:"get",version:1,params:{name:this.owner.groupName?this.owner.groupName:"",subject_type:"group",support_share_quota:"yes"===_D("support_share_user_quota","no")}},{api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{offset:0,limit:-1,option:"include_cold_storage",location:"internal"}}]},scope:this,callback:function(e,t,i){this.isDestroyed||(this.owner.clearStatusBusy(),t.has_fail?SYNO.SDS.AdminCenter.Group.Alert.call(this.owner,SYNO.API.Response.GetFirstError(t)||3299):this.loadQuotaSettings(SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Quota","get"),SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Storage.Volume","list")))}})},isDirty:function(){return 0!==this.getStore().getModifiedRecords().length},confirmQuotaUpdate:function(){return this.getStore().getModifiedRecords().some((e=>"v1"===e.get("quota_status")&&!0===e.get("deduped")))},getWebAPI:function(e){var t=[];return this.getStore().getModifiedRecords().forEach((function(e){var i=parseInt(e.get("quota"),10);"share"===e.get("target")?t.push({share:e.get("name"),quota:this.convertToMB(i,e.get("unit"))}):"volume"===e.get("target")&&t.push({volume:e.get("name"),quota:this.convertToMB(i,e.get("unit"))})}),this),0===t.length?[]:[{api:"SYNO.Core.Quota",method:"set",version:1,params:{name:e,group_quota:t}}]}}),Ext.define("SYNO.SDS.AdminCenter.Group.GroupDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.isAlertExist=!1,this.authType=e.authType||"local",this.isHCM="yes"===_D("support_hyper_converged","no"),this.supportSharedOperation=_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"),this.supportAppPrivOperation=(_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.AppRulePrivileges.Main"))&&!this.isHCM,this.isSupportBandWidth=!this.isHCM,this.isSupportQuota=!this.isHCM&&"yes"===_D("supportquota","no");var t=this.createFormPanel(e);this.groupForm=t.getForm(),this.memberGrid=new SYNO.SDS.AdminCenter.Group.MemberGrid({owner:this,module:e.module,itemId:"member",groupName:e.groupName}),this.groupGrid=this.supportSharedOperation?new SYNO.SDS.AdminCenter.Group.GroupShareGrid({title:_T("share","share_rights"),owner:this,module:e.module,itemId:"share",authType:this.authType}):null,this.quotaGrid=this.isSupportQuota?new SYNO.SDS.AdminCenter.Group.QuotaGrid({title:_T("user","user_quota_capacity"),owner:this,module:e.module,itemId:"quota"}):{loadQuotaSettings:Ext.emptyFn,isDirty:function(){return!1},getWebAPI:function(){return[]}},this.isSupportBandWidth&&(this.bandwidthGrid=this.initBandwidthGrid({owner:this,module:e.module}));var i=[];"local"===this.authType&&(i.push(t),i.push(this.memberGrid)),this.groupGrid&&i.push(this.groupGrid),this.isSupportQuota&&i.push(this.quotaGrid),this.supportAppPrivOperation&&(this.appPrivilegeGrid=this.initPrivilegeGrid({title:_T("user","user_application"),owner:this,module:e.module,entity_type:"group",entity_name:e.groupName,appFilter:function(e){if(e.supportIP&&-1<e.grant_type.indexOf(this.owner.authType))return!0}}),i.push(this.appPrivilegeGrid)),this.isSupportBandWidth&&i.push(this.bandwidthGrid);var s=Ext.apply({width:770,height:400,title:"",layout:"fit",closeAction:"cancelCallback",items:[{xtype:"syno_tabpanel",itemId:"tabs",plain:!0,activeTab:0,deferredRender:!1,items:i}],buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.cancelCallback},{text:_T("common","save"),btnStyle:"blue",scope:this,handler:this.onSaveGroup}]},e);this.callParent([s])},createFormPanel:function(e){var t=Ext.apply({title:_T("group","tabpanel_group_basicinfo"),webapi:{api:"SYNO.Core.Group",methods:{set:"set"},version:1},trackResetOnLoad:!0,itemId:"info",labelWidth:150,items:[{xtype:"syno_textfield",name:"name",maxlength:32,labelHtmlEncode:!1,fieldLabel:_T("group","group_name")+' <font class="red-status">'+_T("common","star")+"</font>","aria-label":_T("group","group_name"),allowBlank:!1,validationEvent:"keyup",blankText:_T("group","error_noname"),vtype:"groupname"},{xtype:"syno_textfield",name:"description",maxlength:64,fieldLabel:_T("group","group_desc")},{xtype:"hidden",name:"new_name"},{xtype:"syno_displayfield",tabIndex:-1,htmlEncode:!1,value:['<font class="red-status">'+_T("common","star")+"</font> "+_T("firewall","firewall_field_blank_alert")]}],listeners:{actioncomplete:{scope:this,fn:this.onActionComplete},actionfailed:{scope:this,fn:this.onActionFailed}}},e);return new SYNO.ux.FormPanel(t)},initPrivilegeGrid:function(e){return new SYNO.SDS.AdminCenter.AppRulePrivileges.EditAppPrivPanel(e)},initBandwidthGrid:function(e){var t=this,i=function(e,t,i,s,n,o){return"enabled"!==i.get("policy")?(t.attr='style="color:#aaaaaa;"',e="-"):e||(i.set(this.dataIndex,0),t.attr='style="color:#aaaaaa;"',e=_T("dhcp_server","unlimited")),e},s=function(e,i){var s=t.selModel.getSelected();void 0!==s&&(void 0!==s.data.schedule_plan&&""!==s.data.schedule_plan||(s.data.schedule_plan="111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"),void 0!==s.data.upload_limit_2&&""!==s.data.upload_limit_2||(s.data.upload_limit_2=0),void 0!==s.data.download_limit_2&&""!==s.data.download_limit_2||(s.data.download_limit_2=0),SYNO.SDS.BandwidthControl.SchedulePlanWinOpen.createDelegate(t,["user",s,!1])())},n=new SYNO.ux.NumberField({allowBlank:!0,allowNegative:!1,allowDecimals:!1,validationEvent:"keyup",selectOnFocus:!0,maxLength:9,emptyText:_T("dhcp_server","unlimited"),validateOnBlur:!0,validator:function(e){if(!this.bandwidthGrid.activeEditor||"FileStation"!==this.bandwidthGrid.activeEditor.record.get("protocol"))return!0;var t=parseInt(e,10);return!(("upload_limit_1"==r.config[this.bandwidthGrid.activeEditor.col].dataIndex||"download_limit_1"==r.config[this.bandwidthGrid.activeEditor.col].dataIndex)&&t<10&&t>0)||_WFT("bandwidth","bandwidth_min_rate")}.createDelegate(this),vtype:"number",listeners:{beforeshow:function(e){e.getValue()||e.reset()}}}),o=new Ext.data.ArrayStore({fields:["display","value"],data:[[_T("bandwidth","mode_enable"),"enabled"],[_T("bandwidth","mode_schedule"),"scheduled"]],autoDestroy:!0}),a={header:_T("bandwidth","mode"),dataIndex:"policy",width:160,renderer:function(e){return"disabled"===e||"notexist"===e||!1===e||"enabled"===e||!0===e?_T("bandwidth","mode_enable"):"scheduled"===e?_T("bandwidth","mode_schedule"):e},editor:new SYNO.ux.ComboBox({name:"modeSelect",hiddenName:"modeSelect",typeAhead:!0,triggerAction:"all",displayField:"display",valueField:"value",hideLabel:!0,id:Ext.id(),editable:!1,forceSelection:!0,valueNotFoundText:_T("bandwidth","mode_enable"),store:o,mode:"local",tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" role="option" aria-label="{display}" id="{[Ext.id()]}" ext:qtip="{display}">',"{display}","</div>","</tpl>"),listeners:{scope:this,select:function(e,t){"scheduled"===t.data.value&&s(),e.fireEvent("blur")}}})},r=new Ext.grid.ColumnModel([{header:_T("bandwidth","bandwidth_protocol"),dataIndex:"protocol",width:120,align:"left",renderer:SYNO.SDS.BandwidthControl.ProtocolTitle},a,{header:`${_T("bandwidth","bandwidth_up_rate")} (${_T("bandwidth","speed_unit")})`,dataIndex:"upload_limit_1",width:115,align:"left",editor:n,renderer:i},{header:`${_T("bandwidth","bandwidth_down_rate")} (${_T("bandwidth","speed_unit")})`,dataIndex:"download_limit_1",width:135,align:"left",editor:n,renderer:i},{dataIndex:"schedule_plan",align:"center",hidden:!0},{dataIndex:"upload_limit_2",align:"center",hidden:!0},{dataIndex:"download_limit_2",align:"center",hidden:!0}]);r.isCellEditable=function(e,t){var i=d.getAt(t),s=r.findColumnIndex("policy");return("enabled"===i.get("policy")||e===s)&&Ext.grid.ColumnModel.prototype.isCellEditable.call(this,e,t)};let l=function(e){return 0<=["disabled","notexist"].indexOf(e)||!e};var d=new SYNO.API.JsonStore({api:"SYNO.Core.BandwidthControl",method:"get",version:2,appWindow:this,baseParams:{name:"",owner_type:"local_group"},pruneModifiedRecords:!0,fields:[{name:"upload_limit_1",convert:function(e,t){return l(t.policy)?0:e}},{name:"download_limit_1",convert:function(e,t){return l(t.policy)?0:e}},{name:"policy",convert:function(e,t){return l(t.policy)?"enabled":e}},"protocol","protocol_ui","owner_type","schedule_plan","upload_limit_2","download_limit_2"],root:"bandwidths",remoteSort:!1,listeners:{exception:{scope:e.owner,fn:SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.onStoreException}}}),c=new SYNO.ux.Toolbar,h=new SYNO.ux.Button({name:"schedulePlanBtn",text:_T("bandwidth","edit_adv_setting"),disabled:!0,scope:this,handler:s});c.add(h);var u={title:_T("bandwidth","bandwidth_tab_title"),cm:r,ds:d,tbar:c,enableHdMenu:!1,enableColumnMove:!1,clicksToEdit:1,cls:"synoug-speed-limit-grid",selModel:this.selModel=new Ext.grid.RowSelectionModel({singleSelect:!0,listeners:{selectionchange:{fn:function(e){e.getCount()>0?h.enable(!1):h.disable(!1)},scope:this}}}),bbar:new SYNO.ux.PageLessToolbar({store:d,doRefresh:function(){this.newgroup||0===this.bandwidthGrid.getStore().getModifiedRecords().length?this.bandwidthGrid.getStore().load({params:{name:this.groupName}}):this.owner.getMsgBox().confirm("",_T("share","share_save_chg_before_reload"),this.bandwidthConfirmSaveChange,this)}.bind(this)})};return Ext.apply(u,e),new SYNO.ux.EditorGridPanel(u)},bandwidthConfirmSaveChange:function(e){if("yes"!==e)return this.bandwidthGrid.getStore().rejectChanges(),void this.bandwidthGrid.getStore().load({params:{name:this.groupName}});let t=[];Ext.each(this.bandwidthGrid.getStore().getModifiedRecords(),(function(e){e.data.name=this.groupName,t.push(e.data)}),this),this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.BandwidthControl",method:"set",version:1,params:{bandwidths:t},callback:function(e,t,i){this.clearStatusBusy(),e?(this.bandwidthGrid.getStore().commitChanges(),this.bandwidthGrid.getStore().load({params:{name:this.groupName}})):this.getMsgBox().alert("",SYNO.API.Errors.core[t.error.code]||_T("common","error_system"))},scope:this})},onActionComplete:function(e,t){},onActionFailed:function(e,t){},hasForbidSelf:function(){let e=this.appPrivilegeGrid?this.appPrivilegeGrid.store.getModifiedRecords():[];return!!this.memberGrid&&this.memberGrid.getStore().findBy((e=>_S("user")===e.get("name")&&e.get("is_member")))>=0&&e.some((e=>"SYNO.Desktop"===e.get("app_id")&&"group"===e.get("entity_type")&&!0===e.get("deny")))},onSaveGroup:function(){if(this.hasForbidSelf()){let e=String.format(_T("app_privilege","warning_forbid_self_group"),this.groupName),t={yes:{text:_T("common","continue"),btnStyle:"red"},no:{text:Ext.MessageBox.buttonText.cancel}};this.getMsgBox().confirmDelete(this.title,e,(function(e){"yes"===e&&this.confirmQuotaUpdate()}),this,t)}else this.confirmQuotaUpdate()},confirmQuotaUpdate:function(){if(this.isSupportQuota&&this.quotaGrid.confirmQuotaUpdate()){let e=_T("user","confirm_quota_update");this.getMsgBox().confirm("",e,(function(e){"yes"===e?this.queryGlobalConf():this.clearStatusBusy()}),this)}else this.queryGlobalConf()},queryGlobalConf:function(){this.setStatusBusy({text:_T("common","saving")});let e={api:"SYNO.Core.BandwidthControl.Protocol",method:"get",version:1},t=[Ext.apply({params:{protocol:"FileStation"}},e)];"yes"!==_D("support_hyper_converged","no")&&(t.push(Ext.apply({params:{protocol:"FTP"}},e),{api:"SYNO.Core.FileServ.FTP",method:"get",version:1},{api:"SYNO.Core.FileServ.FTP.SFTP",method:"get",version:1}),"no"===_D("usbstation","no")&&t.push(Ext.apply({params:{protocol:"NetworkBackup"}},e),{api:"SYNO.Backup.Service.NetworkBackup",method:"get",version:1})),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:t},scope:this,callback:function(e,t,i){e?this.checkGlobalProtocol(t.result,i.compound):this.onActionFailed()}})},setGlobalConf:function(e){for(var t={api:"SYNO.Core.BandwidthControl.Protocol",method:"set",version:1},i=[],s=0;s<e.length;s++)i.push(Ext.apply({params:{protocol:e[s],policy:"enabled"}},t));this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:i},scope:this,callback:function(e,t,i){e?this.applySetting():this.onActionFailed()}})},getConfirmString:function(e,t){var i=[];return Ext.each(t,(function(e){i.push(SYNO.SDS.BandwidthControl.ProtocolTitle(e))})),String.format('{0}<div ext:qtip="{1}" class="blue-status">{1}<div>',e,i.join(", "))},checkGlobalProtocol:function(e,t){var i=this.isSupportBandWidth?this.bandwidthGrid.getStore():null,s=[],n=[],o="",a=!1,r=!1;Ext.each(e,(function(e){e.success&&("SYNO.Core.FileServ.FTP"===e.api&&(e.data.enable_ftp||e.data.enable_ftps)||"SYNO.Core.FileServ.FTP.SFTP"===e.api&&e.data.enable?a=!0:"SYNO.Backup.Service.NetworkBackup"===e.api&&e.data.enable?r=!0:"SYNO.Core.BandwidthControl.Protocol"===e.api&&"disabled"===e.data.policy&&n.push(e.data.protocol))})),a||n.remove("FTP"),r||n.remove("NetworkBackup");i&&i.each((function(e){let t=e.get("protocol");0<=n.indexOf(t)&&!function(e){let t=e.get("policy");return 0<=["notexist","disabled"].indexOf(t)||"enabled"===t&&!e.get("upload_limit_1")&&!e.get("download_limit_1")}(e)&&s.push(t)}),this),s.length>0?(o=this.getConfirmString(_T("bandwidth","bandwidth_global_conf_enable_desc"),s)||_T("bandwidth","bandwidth_global_conf_enable_desc"),this.getMsgBox().confirm(_T("bandwidth","bandwidth_tab_title"),o,(function(e){"yes"===e?this.setGlobalConf(s):this.applySetting()}),this)):this.applySetting()},createApiArray:function(){var e={},t=this.groupForm.getFieldValues(!0);e.name=this.groupName,t.name&&(e.new_name=t.name),Ext.isDefined(t.description)&&(e.description=t.description);var i=[];if("local"===this.authType&&this.groupForm.isDirty()&&i.push({api:"SYNO.Core.Group",method:"set",version:1,params:e}),this.groupGrid&&(i=i.concat(this.groupGrid.getWebAPI(e.new_name||e.name))),this.isSupportQuota&&(i=i.concat(this.quotaGrid.getWebAPI(e.new_name||e.name))),this.isSupportBandWidth){var s=[];Ext.each(this.bandwidthGrid.getStore().getModifiedRecords(),(function(t){t.data.name=e.new_name||e.name,s.push(t.data)}),this),0<s.length&&i.push({api:"SYNO.Core.BandwidthControl",method:"set",version:1,params:{bandwidths:s}})}return this.supportAppPrivOperation&&(i=i.concat(this.getAppRulePrivApi())),i=i.concat(this.memberGrid.getWebAPIParams(e.new_name||e.name))},getAppRulePrivApi:function(){return this.appPrivilegeGrid.newname=this.groupForm.findField("name").getValue(),this.appPrivilegeGrid.getWebAPI()},isDirty:function(){return this.groupForm.isDirty()||this.memberGrid.isDirty()||this.groupGrid&&0!==this.groupGrid.getChangedRecords().length||this.bandwidthGrid&&0!==this.bandwidthGrid.getStore().getModifiedRecords().length||this.quotaGrid&&this.quotaGrid.isDirty()||this.supportAppPrivOperation&&this.appPrivilegeGrid.isChanged()},applySetting:function(){if("local"===this.authType&&!this.groupForm.isValid())return this.clearStatusBusy(),SYNO.SDS.AdminCenter.Group.Alert.call(this,3208,this.module),void this.getComponent("tabs").setActiveTab(0);if(this.isDirty()){var e=this.groupGrid?this.groupGrid.getShareInfoForS2S():null;SYNO.SDS.Utils.S2S.confirmIfSyncShareAffected(!1,e,{dialogTitle:this.title,dialogMsg:_T("s2s","s2s_warn_share_change_priv"),dialogOwner:this,continueHandler:function(){this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:this.createApiArray()},scope:this,callback:this.applyDone})},abortHandler:function(){this.clearStatusBusy(),this.groupGrid&&(this.groupGrid.getStore().rejectChanges(),this.groupGrid.getView().refresh())},scope:this})}else this.close()},applyDone:function(e,t,i,s){this.clearStatusBusy(),t.has_fail?SYNO.SDS.AdminCenter.Group.Alert.call(this,t.result,this.module):(this.lastResult=!0,"local"===this.authType&&(this.groupName=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Group","set","name")),this.close())},loadSuccess:function(e){var t=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Group","admin_check").groups[0];if(this.isAdminGroup=t.is_admin,this.isSupportQuota&&this.quotaGrid.loadQuotaSettings(SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Quota","get"),SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Storage.Volume","list"),t),this.isSupportBandWidth){var i=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.BandwidthControl","get");i&&i.bandwidths&&i.bandwidths.length>0&&this.bandwidthGrid.getStore().loadData(i)}},load:function(e,t){this.setTitle(e),this.groupForm.findField("name").setDisabled("users"===e||"administrators"===e||"http"===e),this.isSupportBandWidth&&this.bandwidthGrid.setDisabled("http"===e),this.groupName=e,this.lastResult=!1,this.supportAppPrivOperation&&(this.appPrivilegeGrid.entity_name=e);var i=[{api:"SYNO.Core.Group",method:"admin_check",version:1,params:{name:e}}];this.isSupportBandWidth&&(i=i.concat([{api:"SYNO.Core.BandwidthControl",method:"get",version:2,params:{name:e,owner_type:"local_group"}}])),this.isSupportQuota&&(i=i.concat([{api:"SYNO.Core.Quota",method:"get",version:1,params:{name:e,subject_type:"group",support_share_quota:"yes"===_D("support_share_user_quota","no")}},{api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{offset:0,limit:-1,option:"include_cold_storage",location:"internal"}}])),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:i},scope:this,callback:function(e,t,i){if(!e||t.has_fail){var s=SYNO.API.Response.GetFirstError(t);this.getMsgBox().alert(this.title,SYNO.API.Erros.core[s.code]||_T("common","error_system")),this.close()}else this.loadSuccess(t)}}),this.groupForm.setValues({name:e,description:t}),this.groupGrid&&this.groupGrid.loadInfo(this.groupName),this.show()},getResult:function(){var e={};return e.success=this.lastResult,e.group=this.groupName,e},cancelCallback:function(){this.isDirty()?this.getMsgBox().confirm(_T("user","user_acnt_info"),_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.doClose()}),this):this.doClose()}}),Ext.define("SYNO.SDS.AdminCenter.Group.CreateGroupSummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",activate:function(){var e=this.owner,t=this.getStore(),i=[],s=[],n=[],o=[],a=[],r=e.groupForm.findField("name").getValue(),l=e.groupForm.findField("description").getValue();this.supportSharedOperation=_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"),t.removeAll(!0),t.append(_T("group","group_name"),r),t.append(_T("group","group_desc"),l);let d=e.memberGrid.getStore().getModifiedRecords().map((e=>e.get("name")));t.append(_T("group","group_members"),d.join(", ")),this.supportSharedOperation&&(e.groupGrid.getStore().each((function(e){var t=this.getFinalPermission(e);"rw"==t?i.push(e.data.name):"ro"==t?n.push(e.data.name):"na"==t&&s.push(e.data.name)}),e.groupGrid),t.append(_T("common","writeable"),i.join(", ")),t.append(_T("common","readonly"),n.join(", ")),t.append(_T("share","share_add_deny"),s.join(", "))),this.owner.isSupportQuota&&this.owner.quotaGrid.getStore().each((function(e){if(e.get("target")&&e.get("quota_enabled")){var i=String.format("{0} {1}",e.get("quota"),e.get("unit"));t.append(e.get("share"===e.get("target")?"name":"volume"),i+" ("+_T("user","group_quota_limit")+")")}})),this.owner.appPrivilegeGrid&&(this.owner.appPrivilegeGrid.getStore().each((function(e){e.get("allow")&&o.push(e.get("name"))})),t.append(_T("tree","leaf_appprivilege"),o.join(", "))),this.owner.isSupportBandwidth&&(e.bandwidthGrid.getStore().getModifiedRecords().forEach((function(e){if("notexist"===e.get("policy"))return;let t=SYNO.SDS.BandwidthControl.ProtocolTitle(e.get("protocol"));if("scheduled"===e.get("policy"))return void a.push(`${t}(${_T("bandwidth","mode_schedule")})`);let i=e.get("upload_limit_1"),s=e.get("download_limit_1");i||(i=_T("dhcp_server","unlimited")),s||(s=_T("dhcp_server","unlimited")),a.push(`${t}(${i}/${s})`)})),t.append(_T("bandwidth","bandwidth_settings"),a.join(", "))),this.getView().syncFocusEl(0),this.getView().refresh()}}),Ext.define("SYNO.SDS.AdminCenter.Group.CreateGroupWizardDialog",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){this.isAlertExist=!1,this.owner=e.owner,this.module=e.module,this.newgroup=!0,this.isHCM="yes"===_D("support_hyper_converged","no"),this.supportSharedOperation=_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"),this.supportAppPrivOperation=(_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.AppRulePrivileges.Main"))&&!this.isHCM,this.isSupportQuota=!this.isHCM&&"yes"===_D("supportquota","no"),this.isSupportBandwidth=!this.isHCM;var t=Ext.apply({title:_T("group","group_wizard_title"),width:640,height:500,steps:[]},e);this.groupFormPanel=SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.createFormPanel.call(this,{headline:_T("group","group_basicinfo"),description:_T("group","groupinfo_descr"),title:"",itemId:"group",nextId:"member",owner:this,module:this.module,getNext:function(){return this.getForm().isValid()?this.owner.validGroupName(!0):SYNO.Debug("form invalid",this.getForm()),!1}}),this.memberGrid=new SYNO.SDS.AdminCenter.Group.MemberGrid({owner:this,module:this.module,height:345,width:560});var i=new Ext.Container({headline:_T("group","group_member_title"),owner:this,module:this.module,items:[this.memberGrid],itemId:"member",nextId:this.findNextId("member"),getNext:function(){return this.nextId}}),s=new Ext.Container;this.supportSharedOperation&&(this.groupGrid=new SYNO.SDS.AdminCenter.Group.GroupShareGrid({owner:this,module:this.module,authType:"local",newGroup:!0,height:345,width:560,bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}),s=new Ext.Container({headline:_T("group","group_shareinfo_title"),description:_T("group","group_shareinfo_descr"),title:"",itemId:"share",nextId:this.findNextId("share"),owner:this,module:this.module,items:[this.groupGrid],getNext:function(){return"appprivilege"===this.nextId&&this.owner.appPrivilegeGrid.fireEvent("activate"),this.nextId}})),this.quotaGrid=this.isSupportQuota?new SYNO.SDS.AdminCenter.Group.QuotaGrid({owner:this,module:this.module,height:345,width:560,bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}):{initForCreation:Ext.emptyFn,getWebAPI:function(){return[]}};var n=this.isSupportQuota?new Ext.Container({headline:_T("group","quotainfo_title"),description:_T("userwizard","quotainfo_descr"),title:"",owner:this,module:this.module,items:[this.quotaGrid],itemId:"quota",nextId:this.findNextId("quota"),getNext:function(){return this.owner.supportAppPrivOperation&&this.owner.appPrivilegeGrid.fireEvent("activate"),this.nextId}}):this.quotaGrid,o=new Ext.Container;if(this.supportAppPrivOperation&&(this.appPrivilegeGrid=SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.initPrivilegeGrid({owner:this,module:this.module,height:345,width:560,entity_type:"group",hide_custom:!0,appFilter:function(e){if(e.supportIP&&-1<e.grant_type.indexOf("local"))return!0},bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}),o=new Ext.Container({headline:_T("userwizard","user_asign_app_privilege"),description:_T("userwizard","user_app_privilege_descr"),title:"",itemId:"appprivilege",nextId:this.findNextId("appprivilege"),owner:this,module:this.module,items:[this.appPrivilegeGrid]})),this.isSupportBandwidth){this.bandwidthGrid=SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.initBandwidthGrid.createDelegate(this,[{owner:this,module:this.module,height:345,width:560,listeners:{afterrender:function(e){var t=e.getGridEl(),i=e.tbar;t.setStyle("padding-top","0px"),i.setStyle("padding-top","24px")}},bwrapCfg:{cls:"x-panel-bwrap",style:"padding-bottom: 0px;"}}])();var a=new Ext.Container({headline:_T("bandwidth","bandwidth_group_create_headline"),description:_T("bandwidth","bandwidth_group_create_description"),title:"",itemId:"bandwidth",nextId:"summary",owner:this,module:this.module,items:[this.bandwidthGrid]})}this.summaryGrid=new SYNO.SDS.AdminCenter.Group.CreateGroupSummaryStep({headline:_T("group","group_summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,owner:this,module:this.module,getNext:function(){return this.owner.onApply(),!1}}),this.groupForm=this.groupFormPanel.getForm(),t.steps.push(this.groupFormPanel),t.steps.push(i),this.supportSharedOperation&&t.steps.push(s),this.isSupportQuota&&t.steps.push(n),this.appPrivilegeGrid&&t.steps.push(o),this.isSupportBandwidth&&t.steps.push(a),t.steps.push(this.summaryGrid),this.callParent([t])},onOpen:function(){this.callParent(arguments),this.getButton("next").disable(),this.groupFormPanel.mon(this.groupForm.findField("name"),"valid",this.validGroupName,this),this.supportSharedOperation&&this.groupGrid.loadInfo(),this.isSupportQuota&&this.quotaGrid.initForCreation(),this.isSupportBandwidth&&this.bandwidthGrid.getStore().load()},findNextId:function(e){switch(e){case"member":if(this.supportSharedOperation)return"share";case"share":if(this.isSupportQuota)return"quota";case"quota":if(this.supportAppPrivOperation)return"appprivilege";case"appprivilege":if(this.isSupportBandwidth)return"bandwidth";default:return"summary"}},getAppRulePrivApi:function(){var e=this.groupForm.findField("name").getValue();return this.appPrivilegeGrid.newname=e,SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.getAppRulePrivApi.call(this)},onApply:function(){this.setStatusBusy({text:_T("common","saving")}),SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.confirmQuotaUpdate.call(this)},queryGlobalConf:function(){return SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.queryGlobalConf.call(this)},checkGlobalProtocol:function(e,t){return SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.checkGlobalProtocol.call(this,e,t)},getConfirmString:function(e,t){return SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.getConfirmString.call(this,e,t)},setGlobalConf:function(e){return SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.setGlobalConf.call(this,e)},onActionFailed:function(e,t){return SYNO.SDS.AdminCenter.Group.GroupDialog.prototype.onActionFailed.call(this,e,t)},applySetting:function(){var e=[],t={name:this.groupForm.findField("name").getValue()},i=this.groupForm.findField("description").getValue();i&&(t.description=i),e.push({api:"SYNO.Core.Group",method:"create",version:1,params:t});var s=[];if(this.supportSharedOperation&&Ext.each(this.groupGrid.getChangedRecords(),(function(e){s.push({name:e.data.name,is_readonly:e.data.is_readonly,is_writable:e.data.is_writable,is_deny:e.data.is_deny})})),s.length>0&&this.supportSharedOperation&&e.push({api:"SYNO.Core.Share.Permission",method:"set_by_user_group",version:1,params:{name:t.name,user_group_type:"local_group",permissions:s}}),this.isSupportQuota&&(e=e.concat(this.quotaGrid.getWebAPI(t.name))),this.isSupportBandwidth){var n=[];this.bandwidthGrid.getStore().getModifiedRecords().forEach((function(e){e.data.name=this.groupForm.findField("name").getValue(),n.push(e.data)}),this),0<n.length&&e.push({api:"SYNO.Core.BandwidthControl",method:"set",version:1,params:{bandwidths:n}})}this.supportAppPrivOperation&&(e=e.concat(this.getAppRulePrivApi())),e=e.concat(this.memberGrid.getWebAPIParams(t.name)),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:e},scope:this,callback:this.applyDone})},applyDone:function(e,t,i,s){this.isDestroyed||(this.clearStatusBusy(),t.has_fail?SYNO.SDS.AdminCenter.Group.Alert.call(this,t.result,this.owner):(this.module.store.reload(),this.close()))},validGroupName:function(e){var t=this.groupForm.findField("name").getValue();e&&this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Group",method:"get",version:1,params:{name:t,go_next:!0===e},scope:this,callback:function(t,i,s,n){if(e&&this.clearStatusBusy(),!this.isDestroyed){var o=this.groupForm.findField("name");t?0===i.groups.length?(this.getButton("next").enable(),!0===s.go_next&&this.goNext(this.groupFormPanel.nextId)):(this.getButton("next").disable(),o.markInvalid(_T("group","error_nameused"))):this.getButton("next").disable()}}})}}),Ext.define("SYNO.SDS.AdminCenter.Group.GridPanel",{extend:"SYNO.ux.GridPanel",itemId:"group_tab",constructor:function(e){this.authType=e.authType||"local",this.pageSize=this.isLocal()?-1:50,this.store=this.createStore(e),this.selModel=this.createSelectionModel(),this.isHCM="yes"===_D("support_hyper_converged","no"),this.isHCMAgent=this.isHCM&&!_S("sofs_is_controller");var t=Ext.apply({title:_T("tree","leaf_group"),store:this.store,tbar:this.configTopToolbar(e),bbar:this.createBBar(),header:!1,border:!1,height:404,stripeRows:!0,autoExpandColumn:"description",enableHdMenu:"domain"===this.authType,enableColumnMove:"domain"===this.authType,colModel:new Ext.grid.ColumnModel({defaults:{sortable:"ldap"!==this.authType},columns:[{header:_T("group","grp_name"),dataIndex:"name",hideable:!1,width:250},{header:_T("service","service_ddns_fullname"),dataIndex:"fullname",hidden:"domain"!==this.authType,width:250},{id:"description",header:_T("group","grp_desc"),dataIndex:"description",width:200,renderer:function(e,t){var i=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i)+'"',i}},{header:_T("group","grp_type"),dataIndex:"type",hidden:"domain"!==this.authType,scope:this,renderer:function(e){return"security"===e?_T("domain","security_group"):"distribution"===e?_T("domain","distribution_group"):""},sortable:!1,width:200},{header:_T("group","grp_scope"),dataIndex:"scope",hidden:"domain"!==this.authType,scope:this,renderer:function(e){return"domain local"===e?_T("domain","domain_local_group"):"global"===e?_T("domain","global_group"):"universal"===e?_T("domain","universal_group"):""},sortable:!1,width:200},{header:_T("user","user_email"),dataIndex:"email",hidden:"domain"!==this.authType,width:200},{header:_T("group","grp_managedby"),dataIndex:"managedby",hidden:!0,width:200}]}),selModel:this.selModel,listeners:{rowcontextmenu:{scope:this,fn:this.onRowContextMenu},containercontextmenu:{scope:this,fn:this.onContainerContextMenu},rowdblclick:{scope:this,fn:this.onRowDblClick},deactivate:function(){this.updateButton&&this.updateButton.pollingId&&(this.updateButton.stopPolling(),this.getEl().unmask())},activate:function(){"domain"===this.authType?this.domainActivateLoad():"ldap"===this.authType?(this.updateButton&&this.updateButton.startPolling&&this.updateButton.startPolling(),this.store.load()):this.store.load()}}},e);this.isLocal()&&(t.view=new SYNO.ux.FleXcroll.grid.BufferView({trackResetOnLoad:!1,scrollDelay:!1,cacheSize:50})),this.callParent([t]),this.toolbar=this.getTopToolbar(),"local"===this.authType&&this.mon(this,"keydown",(function(e){e.getKey()==e.DELETE&&this.deleteHandler()}),this),this.sharePermLimited={},!_S("is_admin")&&SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main")&&this.sendWebAPI({api:"SYNO.Core.Share.Permission",version:1,method:"list_by_user",params:{name:_S("user"),user_group_type:_S("authType")+"_user",share_type:["dec","local","usb","sata","cluster","c2","cold_storage","worm"],additional:["hidden","encryption","is_aclmode"]},scope:this,callback:function(e,t,i){if(e){if(t.shares)for(var s=0;s<t.shares.length;s++)this.sharePermLimited[t.shares[s].name]=t.shares[s].is_writable}else SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,t.code)}})},domainActivateLoad:function(){this.sendWebAPI({api:"SYNO.Core.Directory.Domain",version:2,method:"get_domain_list",scope:this,callback:function(e,t,i){e&&(this.domainFilter.updateList(t.domain_list),this.store.baseParams.domain_name=this.module.currDomain?this.module.currDomain:""),this.store.load()}})},createStore:function(e){var t={autoDestroy:!0,appWindow:e.module.owner,api:"SYNO.Core.Group",method:"list",version:1,remoteSort:!this.isLocal(),defaultSortable:!0,baseParams:{offset:0,limit:this.pageSize,name_only:"local"!==this.authType&&"ldap"!==this.authType,type:this.authType},listeners:{exception:{scope:this,fn:this.onStoreException},beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad}},root:"groups",idProperty:"name",totalProperty:"total",fields:"domain"===this.authType?["name","fullname","description","type","scope","email","managedby"]:[{name:"name",sortType:"asNaturalUCString"},"description"]};return this.isLocal()&&(t.sortInfo={field:"name",direction:"asc"}),new SYNO.API.JsonStore(t)},createSelectionModel:function(){return new Ext.grid.RowSelectionModel({singleSelect:"local"!==this.authType,listeners:{scope:this,selectionchange:function(e){this.onSelectionChange.defer(100,this,[e])}}})},createBBar:function(){return this.isLocal()?new SYNO.ux.PageLessToolbar({store:this.store,displayInfo:!0}):new SYNO.ux.PagingToolbar({store:this.store,pageSize:this.pageSize,displayButtons:!0,displayInfo:!0})},createActionEdit:function(){return new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",scope:this,hidden:this.isHCMAgent,handler:this.editHandler})},createActionDelete:function(){return new Ext.Action({text:_T("common","delete"),itemId:"delete",scope:this,hidden:this.isHCMAgent,handler:this.deleteHandler})},createActionExport:function(){return new Ext.Action({text:_T("group","group_export"),itemId:"export_group",hidden:!_S("is_admin")||this.isHCMAgent,scope:this,menu:new SYNO.ux.Menu({items:[{text:"HTML",scope:this,handler:this.exportHandler("html")},{text:"CSV",scope:this,handler:this.exportHandler("csv")}]})})},createActionDelegate:function(){return new Ext.Action({text:_T("delegation","delegate"),itemId:"delegate",hidden:!_S("is_admin")||this.isHCM,scope:this,menu:new SYNO.ux.Menu({items:[{text:_T("delegation","title"),itemId:"delegate",scope:this,handler:this.delegateHandler},{text:_T("delegation","permission_viewer"),itemId:"delegate_viewer",scope:this,handler:function(){new SYNO.SDS.AdminCenter.User.DelegateViewerDialog({owner:this.module.owner,module:this.module}).open()}}]})})},configTopToolbar:function(e){var t,i=this.createActionEdit(),s=this.createActionDelete(),n=this.createActionExport(),o=this.createActionDelegate();if(this.actionGroup={edit:i,delete:s},t=this.isLocal()?new SYNO.ux.TextFilter({iconStyle:"filter",itemId:"search",emptyText:_T("common","filter_label_text"),store:this.store,localFilter:!0,localFilterField:["name","description"],blOr:!0}):new SYNO.ux.TextFilter({iconStyle:"search",queryParam:"substr",itemId:"search",emptyText:_T("group","search_group"),store:this.store,pageSize:this.pageSize}),this.btnDelegate=new SYNO.ux.Button(o),"ldap"===this.authType)return e.updateButton.grid=this,{items:[new SYNO.ux.Button(i),this.btnDelegate,e.updateButton,"->",t]};if("domain"===this.authType){e.updateButton.grid=this,e.domainFilter.grid=this;let s=new Ext.Panel({cls:"syno-domain-toolbar-panel-wrapper",autoHeight:!0,items:[new SYNO.ux.Toolbar({itemId:"innerToolbar",items:[new SYNO.ux.Button(i),this.btnDelegate,e.updateButton,"->",{xtype:"syno_displayfield",itemId:"filterName",value:_T("helptoc","directory_service_domain")+_T("common","colon"),style:"margin-right: 8px"},e.domainFilter,t]}),e.statusBar]});return this.getTopToolbar=function(){return s.getComponent("innerToolbar")},{layout:"fit",style:"padding: 0; border: 0;",items:[s]}}return{items:[{xtype:"syno_button",text:_T("common","create"),itemId:"create_grp",scope:this,hidden:this.isHCMAgent,handler:this.createHandler},new SYNO.ux.Button(i),new SYNO.ux.Button(s),new SYNO.ux.Button(n),this.btnDelegate,"->",t]}},isLocal:function(){return"local"===this.authType},createHandler:function(){_D("maxgroups")<=this.store.getTotalCount()?SYNO.SDS.AdminCenter.Group.Alert.call(this.findAppWindow(),3209,this):new SYNO.SDS.AdminCenter.Group.CreateGroupWizardDialog({owner:this.module.owner,sharePermLimited:this.sharePermLimited,module:this}).open()},editHandler:function(){var e=this.getFirstSelection();e&&(this.position=this.getBottomToolbar().cursor+this.store.indexOf(e),this.launchGroupDialog(e.get("name"),e.get("description")))},async deleteHandler(){const e=this.getSelectionModel(),t=["users","administrators","http"];if(t.some((t=>e.isIdSelected(t))))return await this.module.owner.getMsgBox().alert(_T("tree","leaf_group"),_T("group","error_rmvdef")),void t.forEach((t=>{const i=this.store.indexOfId(t);-1!==i&&e.deselectRow(i)}));var i=e.getSelections();if(0===i.length)return void this.module.owner.getMsgBox().alert(_T("tree","leaf_group"),_T("group","error_rmvempty"));var s=[];Ext.each(i,(function(e,t,i){s.push(e.get("name"))}),this);const n=s.length>5?String.format(_T("group","group_cfrmrmv_num"),s.length):_T("group","group_cfrmrmv"),o=s.length>5?"":s.join(", ");"confirm"===await this.module.owner.getMsgBox().confirmDelete(n,o,null,{useHtml:!0})&&(this.position=this.getBottomToolbar().cursor+this.store.indexOf(i[0]),this.applyDeleteGroup(s))},stopExport:async function(){try{await synowebapi.promises.request({api:"SYNO.Core.Group",method:"export_prepare_stop",version:"1",params:{task_id:this.exportTaskId||""}}),this.isCancelExport=!0,delete this.exportTaskId}catch(e){SYNO.Debug(e)}},exportProgressHandler:async function(e){await this.stopExport(),this.stopExportPolling()},showExportProgress:function(e){this.msgBox=this.findAppWindow().getMsgBox(),this.msgBox.progress(e,0,"","%",{confirm:!1}).then((e=>{this.exportProgressHandler(e)}))},updateExportProgress:function(e,t){var i;null===(i=this.msgBox)||void 0===i||i.progress(t,e,"","%",{confirm:!1}).then((e=>{this.exportProgressHandler(e)}))},stopExportPolling:async function(){var e;Ext.isDefined(this.ExportPollingId)&&(await(null===(e=this.msgBox)||void 0===e?void 0:e.close()),this.pollUnreg(this.ExportPollingId),delete this.ExportPollingId)},startExport:function(e){this.showExportProgress(_T("login","check_status_title")),this.ExportPollingId=this.pollReg({interval:3,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Group",method:"export_prepare_status",params:{task_id:this.exportTaskId},version:1},status_callback:async function(t,i){if(!t)return await this.stopExportPolling(),delete this.exportTaskId,void this.findAppWindow().getMsgBox().alert("",SYNO.API.getErrorString(null==i?void 0:i.code));i.finished?(await this.stopExportPolling(),this.isCancelExport||synowebapi.download({api:"SYNO.Core.Group",version:1,method:"export",params:{type:e}})):this.updateExportProgress(i.progress,_T("login","check_status_title"))}})},exportHandler:function(e){return async()=>{"confirm"===await this.findAppWindow().getMsgBox().confirm("",_T("user","export_confirm_desc"),{confirm:{text:_T("common","continue")}},{useHtml:!0})&&(await this.stopExport(),this.sendWebAPI({api:"SYNO.Core.Group",method:"export_prepare",version:1,callback:async function(t,i){t?(this.exportTaskId=i.task_id,this.isCancelExport=!1,this.startExport(e)):await this.findAppWindow().getMsgBox().alert("",SYNO.API.getErrorString(null==i?void 0:i.code))},scope:this}))}},exportHTMLHandler:function(){this.exportPollingHandler("html")},exportCSVHandler:function(){this.exportPollingHandler("csv")},delegateHandler:function(){var e=[],t=this.getSelectionModel().getSelections();0!==t.length?(Ext.each(t,(function(t){e.push(t.get("name"))})),this.launchGroupDelegateDialog(e)):this.module.owner.getMsgBox().alert(_T("tree","leaf_group"),_T("group","error_rmvempty"))},getFirstSelection:function(){var e=this.getSelectionModel().getSelected();return e||(this.module.owner.getMsgBox().alert(_T("tree","leaf_group"),_T("group","error_rmvempty")),null)},clearSearch:function(){this.toolbar.getComponent("search").reset()},applyDeleteGroup:function(e){this.module.appWin.setStatusBusy(null,_T("group","deleting_group")),SYNO.API.Request({api:"SYNO.Core.Group",method:"delete",version:1,params:{name:e},scope:this,callback:this.applyDeleteGroupDone})},applyDeleteGroupDone:function(e,t,i,s){this.module.appWin.clearStatus();var n=0;if(e)this.isLocal()||(n=Math.floor(this.position/this.pageSize)*this.pageSize)>=this.totalNum-i.name.length&&(n-=this.pageSize)<0&&(n=0);else if(SYNO.SDS.AdminCenter.Group.Alert.call(this,t.code),t.code&&3202===t.code)return;this.store.load({params:{offset:n,limit:this.pageSize,type:this.authType}})},onSelectionChange:function(e){var t=e.getCount(),i=this.actionGroup;0===t?(Ext.iterate(i,(function(e,t,i){t.disable()}),this),this.btnDelegate.menu.getComponent("delegate").disable()):(i.delete.enable(),e.isIdSelected("users")||e.isIdSelected("administrators")?this.btnDelegate.menu.getComponent("delegate").disable():this.btnDelegate.menu.getComponent("delegate").enable(),t>1?i.edit.disable():i.edit.enable())},onContainerContextMenu:function(e,t){if(!this.isHCMAgent){var i=e.getSelectionModel().getSelected(),s=e.store.indexOf(i);this.onRowContextMenu(e,s,t)}},onRowContextMenu:function(e,t,i){if(!this.isHCMAgent){var s=[];"local"===this.authType?Ext.iterate(this.actionGroup,(function(e,t,i){s.push(t)}),this):s.push(this.actionGroup.edit);var n=new SYNO.ux.Menu({autoDestroy:!0,items:s}),o=e.getSelectionModel();o.selectRow(t,o.isSelected(t)),n.showAt(i.getXY()),i.preventDefault()}},onRowDblClick:function(e,t,i){var s=this.store.getAt(t);s&&!this.isHCMAgent&&(this.position=this.getBottomToolbar().cursor+this.store.indexOf(s),this.launchGroupDialog(s.get("name"),s.get("description")))},onStoreException:function(e,t,i,s,n,o){if(this.module.owner.clearStatus(),SYNO.Debug("Store exception: options:",s),s.params.substr&&this.clearSearch(),this.store.loadData({groups:[]}),3203===n.code)return this.getEl().mask(_T("directory_service","warr_db_not_ready"),"syno-ux-mask-info"),void(this.updateButton.pollingId||this.updateButton.restartPolling());var a=SYNO.SDS.AdminCenter.Group.GetErrMsg(n.code?n.code:3299);this.module.owner.getMsgBox().alert(this.title,a,(function(){}),this)},onBeforeLoad:function(e,t){if("domain"===this.authType){var i=[];this.domainFilter.setValue(this.module.currDomain),this.store.baseParams.domain_name=this.module.currDomain?this.module.currDomain:"",this.getColumnModel().getColumnsBy((function(e){return e.hidden||i.push(e.dataIndex),!1})),t.params.searchFields=i}this.module.owner.setStatusBusy()},onLoad:function(e,t,i){if("domain"!==this.authType&&"ldap"!==this.authType||(0===e.getCount()?this.addClass("syno-directory-service-user-group-gridpanel"):this.removeClass("syno-directory-service-user-group-gridpanel")),this.onSelectionChange(this.selModel),this.module.owner.clearStatus(),this.totalNum=e.totalLength,this.focusGroup){var s=e.indexOfId(this.focusGroup);-1!==s&&(this.getSelectionModel().selectRow(s),function(){this.getView().focusRow(s)}.defer(100,this))}},onGroupDialogClose:function(e){var t=e.getResult();if(!0===t.success){var i=0;this.isLocal()||(i=Math.floor(this.position/this.pageSize)*this.pageSize),this.focusGroup=t.group,this.store.load({params:{offset:i,limit:this.pageSize,type:this.authType}})}},launchGroupDialog:function(e,t){var i=new SYNO.SDS.AdminCenter.Group.GroupDialog({owner:this.module.owner,module:this,authType:this.authType,groupName:e,sharePermLimited:this.sharePermLimited,newGroup:!1});i.mon(i,"close",this.onGroupDialogClose,this),i.load(e,t)},launchGroupDelegateDialog:function(e){new SYNO.SDS.AdminCenter.User.DelegateDialog({owner:this.module.owner,module:this.module,type:"group",name:e}).open()}}),Ext.define("SYNO.SDS.AdminCenter.Group.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.owner=e.appWin,this.callParent([e]),this.panel=new SYNO.SDS.AdminCenter.Group.GridPanel({module:this})},getPanel:function(){return this.panel},getHelpParam:function(){return"AdminCenter/file_group_desc.html"},activate:function(){return!0},deactivate:function(){return!0}}),Ext.define("SYNO.SDS.AdminCenter.User.HomeFieldSet",{extend:"SYNO.ux.FieldSet",moveShareMsg:_T("share","share_move_progress"),initEvents:function(){this.callParent(arguments);const e=()=>{new SYNO.ux.Utils.EnableCheckGroup(this.ownerCt.getForm(),"enable",["location"])},t=()=>{this.volProcessingTip=SYNO.ux.AddTip(this.ownerCt.getForm().findField("location"),_T("user","home_volume_processing"))};this.mon(this,"afterlayout",e,this,{single:!0}),this.mon(this,"afterlayout",t,this,{single:!0})},constructor:function(e){this.authType=e.authType||"local",this.stopHomePollingCallback=e.stopHomePollingCallback||Ext.emptyFn,this.homeInfo={},this.homePollingId=void 0,this.hasWebStation=SYNO.API.GetKnownAPI("SYNO.WebStation.Default");const t=Ext.apply({title:"local"===this.authType?_T("user","user_home_set"):"",collapsible:"local"===this.authType,webapi:{api:"SYNO.Core.User.Home",version:1,methods:{get:"get",set:"set"},params:{get:{additional:["personal_photo_enable"]}}},items:this.createItems(e)},e);this.callParent([t])},createItems:function(e){let t=_T("user","user_home_enable");"domain"===e.authType?t=_T("domain","domain_user_home_enable"):"ldap"===e.authType&&(t=_T("ldap","ldap_user_home_enable"));const i=String.format(_T("share","note_enable_home_recycle_bin"),'<a id="'+Ext.id()+'" class="link-font" style="cursor:pointer">',"</a>"),s=String.format(_T("share","note_enable_home_recycle_bin"),"","");let n='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>";return"local"===this.authType?n+=i:n+='<br><ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;"><li>'+_T("domain","domain_user_home_notice")+"</li><li>"+s+"</li></ul>",[{xtype:"syno_checkbox",name:"enable",ref:"enable",boxLabel:t,listeners:{check:function(e,t){if(t&&_D("usbstation")){if(0===this.location.getStore().getCount())return this.findAppWindow().getMsgBox().alert(null,String.format(_T("service","no_ext4_external_devices"),_T("helptoc","user_home"))),e.setValue(!1),!1}!t&&this.homeInfo.chroot&&this.homeInfo.chroot_include_home&&this.findAppWindow().getMsgBox().alert(null,_T("user","user_chroot_warning"))},afterrender:function(e){SYNO.ux.AddTip(e,_T("user","homes_tooltip"))},scope:this}},{xtype:"syno_displayfield",indent:1,name:"errorMsg",ref:"errorMsg",htmlEncode:!1,hidden:!0},{xtype:"syno_message_combobox",indent:1,width:360,fieldLabel:_T("user","location_of_homes"),name:"location",ref:"location",store:new Ext.data.JsonStore({autoDestroy:!0,idProperty:"value",fields:["value","display","desc"]}),allowBlank:!1,displayField:"display",descriptionField:"desc",valueField:"value",triggerAction:"all",editable:!1,grow:!0},{xtype:"syno_displayfield",indent:1,name:"recycle_bin_status",htmlEncode:!1,fieldLabel:_T("home","recycle_bin_status")},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,name:"user_home_note",value:n,listeners:{afterrender:function(e){const t=e.el.first("a");t&&this.mon(t,"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Share.Main"})}),this)},scope:this},reset:Ext.emptyFn}]},updateMoveShareProgress:function(e){this.findAppWindow().getMsgBox().progress(this.moveShareMsg,Math.min(e.toFixed(2),100),"","",{confirm:!1,cancel:!1})},startHomePolling:function(e){this.updateMoveShareProgress(0),this.homePollingId=this.pollReg({webapi:{api:"SYNO.Core.User.Home",method:"status",version:1,params:{task_id:e}},interval:3,immediate:!0,scope:this,status_callback:function(e,t,i,s){if(!e||!t.success)return this.findAppWindow().getMsgBox().alert(_T("tree","leaf_notification"),SYNO.SDS.AdminCenter.User.Error2Msg(t.error.code)),void this.stopHomePolling(!0);t.finish?(this.findAppWindow().getMsgBox().close(),this.stopHomePolling(!0),this.stopHomePollingCallback()):this.updateMoveShareProgress(t.data.percent)}})},stopHomePolling:function(e){void 0!==this.homePollingId&&(this.pollUnreg(this.homePollingId),this.homePollingId=void 0),e&&this.sendWebAPI({api:"SYNO.Core.User.Home",method:"stop",version:1,callback:function(e,t,i){e||SYNO.SDS.AdminCenter.User.Alert(this.owner)},scope:this})},isHomePolling:function(){return this.homePollingId},restartHomePolling:function(){if(this.isHomePolling())return;const e=(t,i)=>{i>=t.length||this.sendWebAPI({api:"SYNO.Core.User.Home",method:"status",version:1,params:{task_id:t[i]},scope:this,callback:function(s,n,o,a){!s||n.finish?e(t,i+1):this.startHomePolling(o.task_id)}})};SYNO.API.Request.Polling.List({task_id_prefix:"userhome",extra_group_tasks:["admin"],scope:this,callback:function(t,i,s,n){t&&Ext.isArray(i.admin)&&e(i.admin,0)}})},getFeasibilityCheckMsg:function(e,t){let i="";return Ext.each(t,(function(e){i+=String.format("<li>{0}</li>",SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))})),String.format('{0}<br><br><ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;">{1}</ul>',e,i)},getBtrfsErrorMsg:function(){let e="";const t=this.homeInfo.location,i=this.location.getValue();return t===i||(this.volumeFsMap={},Ext.each(this.homeInfo.volumes,(function(e,t,i){this.volumeFsMap[e.volume_path]=e.fs_type}),this),"btrfs"===this.volumeFsMap[t]&&(e+="<li>"+_T("share","share_move_snapshot_lost_warning")+"</li>","btrfs"!==this.volumeFsMap[i]&&(e+="<li>"+_T("share","share_move_quota_lost_warning")+"</li>"))),e},doFeasibilityCheck:function(){const e=this.enable.getValue(),t=this.location.getValue();this.homeInfo.enable!==e?(this.findAppWindow().setStatusBusy(null,_T("common","saving")),this.sendWebAPI({api:"SYNO.Core.User.Home",method:"validate_set",params:{enable:e,location:t},version:1,scope:this,callback:async function(e,t,i){if(this.findAppWindow().clearStatus(),e)if(Ext.isArray(t.hard_reasons)&&t.hard_reasons.length>0)this.findAppWindow().getMsgBox().alert(null,this.getFeasibilityCheckMsg(_T("share","edit_hard_check_fail"),t.hard_reasons));else if(Ext.isArray(t.soft_reasons)&&t.soft_reasons.length>0){"confirm"===await this.findAppWindow().getMsgBox().confirm(null,this.getFeasibilityCheckMsg(_T("home","edit_soft_check_fail"),t.soft_reasons),{confirm:{text:_T("common","continue")},cancel:{text:_T("common","cancel")}},{useHtml:!0})&&this.doSubmit()}else this.doSubmit();else{let e=SYNO.API.Response.GetFirstError(t);const i=SYNO.API.Errors.core[e.code]||_T("common","error_system");this.findAppWindow().getMsgBox().alert(null,i)}}})):this.doSubmit()},doSubmit:function(){var e=this.location.getValue();this.enable.getValue()&&e!==this.homeInfo.location&&""!==this.homeInfo.location?(this.findAppWindow().setStatusBusy(null,_T("common","saving")),this.sendWebAPI({api:"SYNO.Core.User.Home",method:"move_check",version:1,params:{location:e},scope:this,callback:async function(e,t,i){if(this.findAppWindow().clearStatus(),!e)return void SYNO.Debug("failed to perform move_check");const s=()=>{let e=_T("share","share_move_desc_time_spent")+"<br>";e+=_T("share","share_move_please_note")+_T("common","colon")+"<br>",e+="<li>"+_T("share","share_move_serivce_stopped")+"</li>",e+=this.getBtrfsErrorMsg(),e+="<li>"+_T("user","home_volume_change")+"</li>",e+="<br>"+_T("common","ask_cont");const t=new SYNO.SDS.AdminCenter.Share.Move({owner:this.findAppWindow(),msg:e,scope:this,callback:function(e){"yes"===e&&this.submitHomeChange(!0)}});t.loadMessage(e),t.open()};if(Ext.isArray(t.hard_reasons)&&t.hard_reasons.length>0)this.findAppWindow().getMsgBox().alert(null,this.getFeasibilityCheckMsg(_T("share","edit_hard_check_fail"),t.hard_reasons));else if(Ext.isArray(t.soft_reasons)&&t.soft_reasons.length>0){"confirm"===await this.findAppWindow().getMsgBox().confirm(null,this.getFeasibilityCheckMsg(_T("share","edit_soft_check_fail"),t.soft_reasons),{confirm:{text:_T("common","yes")},cancel:{text:_T("common","no")}},{useHtml:!0})&&s()}else s()}})):this.submitHomeChange(!1)},submitHomeChange:function(e){const t=this.enable.getValue();e&&(this.successHandler=this.startHomePolling),SYNO.SDS.Utils.S2S.confirmIfSyncShareAffected(!1,t?{name:"homes",is_sync_share:this.homeInfo.userhome_in_s2s,no_check_permission:!0}:null,{dialogTitle:null,dialogMsg:_T("s2s","s2s_warn_homes_enable"),dialogOwner:this.findAppWindow(),continueHandler:function(){this.ownerCt&&Ext.isFunction(this.ownerCt.applyForm)&&this.ownerCt.applyForm()},abortHandler:function(){this.enable.setValue(!1)},scope:this})},isHomeEnableChanged:function(e){return!(e===this.homeInfo.enable)},applyHandler:function(){const e=this.homeInfo.location,t=this.location.getValue(),i=this.enable.getValue();if(e!==t&&2==this.homeInfo.encryption)return this.findAppWindow().getMsgBox().alert(null,_T("user","warning_move_share_decrypted")),!1;if((this.homeInfo.enable_userdir||this.homeInfo.personal_photo_enable)&&this.isHomeEnableChanged(i)&&!i)if("local"!==this.authType)this.doSubmit();else{let e=[];this.homeInfo.enable_userdir&&e.push(_T("service","service_web_localuser")),this.homeInfo.personal_photo_enable&&e.push(_T("service","service_photo_personal_title")),this.findAppWindow().getMsgBox().minWidth=400,this.findAppWindow().getMsgBox().confirm(_T("user","user_home_set"),String.format(_T("service","service_app_uhconflict"),e.join(", ")),(function(e,t){"yes"==e?(SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.PersonalPhotoStation",!0),this.doFeasibilityCheck()):this.enable.setValue(!0)}),this)}else this.doFeasibilityCheck()},processParams:function(e,t){if("set"===e){let e=t.find((e=>"SYNO.Core.User.Home"===e.api));e&&""===this.homeInfo.remote_location&&("local"===this.authType?!1===e.params.enable&&(this.homeInfo.enable_domain&&(e.params.enable_domain=!1),this.homeInfo.enable_ldap&&(e.params.enable_ldap=!1)):("domain"===this.authType?e.params.enable_domain=e.params.enable:"ldap"===this.authType&&(e.params.enable_ldap=e.params.enable),0==e.params.enable&&!0===this.homeInfo.enable&&delete e.params.enable))}let i=[{api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{offset:0,limit:-1,location:"yes"===_D("usbstation","no")?"external":"internal",option:"include_cold_storage"}},{api:"SYNO.S2S.Server.Pair",version:1,method:"list",params:{additional:["sync_shares"]}}];return SYNO.API.GetKnownAPI("SYNO.Core.FileServ.FTP.Security")&&i.push({api:"SYNO.Core.FileServ.FTP.Security",version:1,method:"get"}),SYNO.API.GetKnownAPI("SYNO.Core.FileServ.FTP.ChrootUser")&&i.push({api:"SYNO.Core.FileServ.FTP.ChrootUser",version:2,method:"load"}),this.hasWebStation&&(i=i.concat([{api:"SYNO.WebStation.Default",version:1,method:"get"}])),i},processReturnData:function(e,t,i){if("local"!==this.authType&&0===SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Storage.Volume","list","total"))return void("SYNO.SDS.CMS.Application"===this.findAppWindow().getOpenConfig("className")?SYNO.SDS.AdminCenter.User.Alert.call(this.findAppWindow(),_T("cms","cms_no_volumes")):SYNO.SDS.AdminCenter.User.Alert.call(this.findAppWindow(),_T("volume","volume_share_volumeno"),(function(){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")})));const s=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.User.Home","get"),n=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Storage.Volume","list"),o=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.FileServ.FTP.Security","get"),a=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.FileServ.FTP.ChrootUser","load"),r=SYNO.API.Response.GetValByAPI(t,"SYNO.S2S.Server.Pair","list");let l=!1;if(r&&r.clients&&Ext.each(r.clients,(function(e){if(Ext.each(e.additional.sync_shares,(function(e){if("homes"===e)return l=!0,!1})),l)return!1})),this.successHandler)Ext.each(t.result,(function(e){"SYNO.Core.User.Home"===e.api&&"get"===e.method&&(e.data={})}));else{Ext.apply(this.homeInfo,s),s.additional&&Ext.apply(this.homeInfo,s.additional);const e=s.location;Ext.apply(this.homeInfo,n),SYNO.SDS.AdminCenter.User.CreateVolumeMap(n),this.homeInfo.userhome_in_s2s=l;const t=n.map[e];let i=!1,o="",a=!1,r=!1;if(Ext.each(n.volumes,(function(e){if(!e.readonly)return i=!0,!1})),i?t&&(0<=["volume_op_fsck","volume_op_balance","volume_op_stop"].indexOf(t.status)?r=!0:t.readonly&&(o='<font class="red-status">'+_T("user","home_volume_crash")+"</font>",a=!0)):(o='<font class="red-status">'+_T("volume","volume_share_volumeno")+"</font>",this.enable.disable(),a=!0),a)return this.enable.disable(),this.errorMsg.setValue(o),this.errorMsg.originalValue=o,this.errorMsg.setVisible(!0),void Ext.getCmp(this.volProcessingTip.id).hide();if(r?(this.enable.disable(),this.errorMsg.setVisible(!1),Ext.getCmp(this.volProcessingTip.id).show()):(this.enable.enable(),this.errorMsg.setVisible(!1),Ext.getCmp(this.volProcessingTip.id).hide()),1==this.homeInfo.encryption){const e='<font class="red-status">'+_T("user","warning_status_share_encrypted")+"</font>";this.errorMsg.setValue(e),this.errorMsg.originalValue=e,this.errorMsg.setVisible(!0)}let d=this.location.getStore();n.volumes&&n.total&&(d.removeAll(),Ext.each(n.volumes,(function(e){return!!e.readonly||("yes"===_D("usbstation")&&"ext4"!==e.fs_type||void d.loadData({value:e.volume_path,display:SYNO.SDS.Utils.StorageUtils.VolumeNameSizeRenderer(e),desc:e.description},!0))}),this)),d.sort("value","ASC"),"domain"===this.authType?this.homeInfo.enable=this.homeInfo.enable_domain:"ldap"===this.authType&&(this.homeInfo.enable=this.homeInfo.enable_ldap),this.homeInfo.recycle_bin_status=!0===this.homeInfo.enable_recycle_bin?'<span class="green-status">'+_T("common","enabled")+"</font>":'<span class="red-status">'+_T("common","disabled")+"</font>",this.ownerCt.getForm().setValues(this.homeInfo),0!==n.volumes.length&&0!==d.getCount()&&!this.location.getValue()&&d.getRange(0,0)[0].get("value")&&this.ownerCt.getForm().setValues({location:d.getRange(0,0)[0].get("value")})}if(this.homeInfo.chroot=o.user_chroot,a&&a.rules&&(this.homeInfo.chroot_include_home=a.rules.some((e=>"/home"===e.path))),this.hasWebStation){const e=SYNO.API.Response.GetValByAPI(t,"SYNO.WebStation.Default","get");this.homeInfo.enable_userdir=e.enable_userdir}else this.homeInfo.enable_userdir=!1;if("get"===e)return;if(this.successHandler){const e=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.User.Home","set");this.successHandler(e.task_id),this.successHandler=null}const d=!0===this.enable.getValue()?"create":"delete";SYNO.SDS.StatusNotifier.fireEvent("sharefolderchanged",d)}}),Ext.define("SYNO.SDS.AdminCenter.User.OptionTab",{extend:"SYNO.SDS.Utils.FormPanel",default_min_length:8,default_max_length:127,default_history_num:1,default_max_history:99,default_min_age:1,default_max_age:999,itemId:"option_tab",constructor:function(e){this.owner=e.owner,this.module=e.module,this.passwordChecker=e.passwordChecker,this.form=this.getForm(),this.enable_mail=!0,this.showMustChgPwdConfirm=!0,this.setAllMustChgPwd=!1,this.neverExpiredList=[],this.userHomeFieldSet=new SYNO.SDS.AdminCenter.User.HomeFieldSet({module:this.module,authType:"local",stopHomePollingCallback:this.loadForm.bind(this)}),Ext.QuickTips.init();var t=Ext.apply({title:_T("common","advanced"),border:!1,trackResetOnLoad:!0,useDefaultBtn:!0,items:[{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.User.Main::advance::password",title:_T("passwd","passwd_strength_title"),collapsible:!0,webapi:{api:"SYNO.Core.User.PasswordPolicy",version:1,methods:{get:"get",set:"set"}},items:[{xtype:"syno_checkbox",name:"enable_reset_passwd_by_email",boxLabel:_T("passwd","forget_pass_enable"),listeners:{check:function(e,t){t&&!this.enable_mail&&this.confirmMailService(e,"pwd_settings")},scope:this}},{xtype:"syno_checkbox",name:"password_must_change",boxLabel:_T("passwd","mustchange_after_reset")},{xtype:"syno_checkbox",name:"strong_password_enable",boxLabel:_T("passwd","passwd_strength_enforce")},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,value:String.format(_T("passwd","passwd_strength_desc"),'<a id="'+Ext.id()+'" class="link-font" style="cursor:pointer">',"</a>"),listeners:{scope:this,afterrender:function(e){const t=e.el.first("a");t&&this.mon(t,"click",(function(){this.owner.onHelp()}),this)}}},{xtype:"syno_checkbox",indent:1,name:"exclude_username",boxLabel:_T("passwd","exclude_username")},{xtype:"syno_checkbox",indent:1,name:"mixed_case",boxLabel:_T("passwd","mixed_case")},{xtype:"syno_checkbox",indent:1,name:"included_numeric_char",boxLabel:_T("passwd","included_numeric_char")},{xtype:"syno_checkbox",indent:1,name:"included_special_char",boxLabel:_T("passwd","included_special_char")},{xtype:"syno_checkbox",indent:1,name:"exclude_common_password",boxLabel:_T("passwd","exclude_common_password")},{indent:1,xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"min_length_enable",width:280,boxLabel:_T("passwd","min_length_enable")},{xtype:"syno_numberfield",defaultMinValue:this.default_min_length,maxValue:this.default_max_length,width:100,name:"min_length",validator:function(e){return!this.isDirty()||(!(e<this.defaultMinValue)||String.format(this.minText,this.defaultMinValue))},value:this.default_min_length}]},{indent:1,xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"exclude_history",width:280,boxLabel:_T("passwd","pwd_history")},{xtype:"syno_numberfield",minValue:this.default_history_num,maxValue:this.default_max_history,width:100,maxlength:2,name:"history_num",value:this.default_history_num}]}]},this.getPwdExpireConfig(),this.userHomeFieldSet]},e);this.callParent([t]),this.mon(this,"afterlayout",this.defineBehaviors,this,{single:!0}),this.mon(this,"activate",this.activate,this)},confirmMailService:async function(e,t){"confirm"===await this.owner.getMsgBox().confirm("","otp"===t?_T("otp_enforcement","enforce_mail_notification_service"):_T("notification","mail_service_not_enable_revised"))?(this.getForm().reset(),this.module.app.startModule("SYNO.SDS.AdminCenter.Notification.Main")):e&&e.setValue(!1)},getPwdExpireConfig:function(){var e,t=[],i=[];for(e=0;e<24;++e)t.push([e,String.leftPad(String(e),2,"0")]);var s=new Ext.data.ArrayStore({fields:["value","display"],data:t});for(e=0;e<60;++e)i.push([e,String.leftPad(String(e),2,"0")]);var n=new Ext.data.ArrayStore({fields:["value","display"],data:i});return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.User.Main::advance::passwordExpiry",title:_T("passwd","pwd_expire"),collapsible:!0,webapi:{api:"SYNO.Core.User.PasswordExpiry",version:1,methods:{get:"get",set:"set"}},items:[{xtype:"syno_checkbox",name:"password_expire_enable",listeners:{check:function(e,t){t&&this.form.findField("password_expire_enable").isDirty()&&(this.neverExpiredList=[],new SYNO.SDS.AdminCenter.User.UnExpireUserDialog({owner:this.owner,module:this.appWin,appWin:this.appWin,neverExpiredList:this.neverExpiredList}).open())},scope:this},boxLabel:_T("passwd","enable_pwd_expire")},{indent:1,xtype:"syno_numberfield",name:"max_age",id:this.max_age_id=Ext.id(),vtype:"number",fieldLabel:_T("passwd","pwd_maxage"),labelWidth:364,width:100,minValue:this.default_min_age,maxValue:this.default_max_age,value:30,maxlength:3,listeners:{scope:this,blur:function(e){this.form.findField("min_age").validate(),this.form.findField("login_prompt_days").validate(),this.form.findField("mail_notification_days").validate()}}},{indent:1,xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"min_age_enable",id:this.min_age_enable_id=Ext.id(),width:330,boxLabel:_T("passwd","pwd_minage")},{xtype:"syno_numberfield",name:"min_age",id:this.min_age_id=Ext.id(),vtype:"number",width:100,minValue:this.default_min_age,maxValue:this.default_max_age,value:this.default_min_age,maxlength:3,validator:Ext.createDelegate((function(e){var t=Ext.getCmp(this.min_age_enable_id).getValue(),i=Ext.getCmp(this.max_age_id).getValue();return!(!0===t&&e>=i)||_T("passwd","invalid_expire_general_rule")}),this)}]},{indent:1,xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_checkbox",name:"enable_login_prompt",id:this.enable_login_prompt_id=Ext.id(),width:330,boxLabel:_T("passwd","expire_warning")},{xtype:"syno_numberfield",minValue:this.default_min_age,maxValue:this.default_max_age,width:100,name:"login_prompt_days",value:this.default_min_age,maxlength:2,validator:Ext.createDelegate((function(e){var t=Ext.getCmp(this.enable_login_prompt_id).getValue(),i=Ext.getCmp(this.max_age_id).getValue();return!(!0===t&&e>=i)||_T("passwd","invalid_expire_general_rule")}),this)}]},{xtype:"syno_checkbox",indent:1,name:"allow_reset_after_expired",boxLabel:_T("passwd","expire_change_pwd")},{xtype:"syno_checkbox",indent:1,name:"enable_mail_notification",listeners:{check:function(e,t){t&&!this.enable_mail&&this.confirmMailService(e,"pwd_expiration")},scope:this},boxLabel:_T("passwd","expire_notification")},{xtype:"syno_compositefield",hideLabel:!0,indent:2,items:[{xtype:"syno_displayfield",name:"mail_notify_time",value:_T("passwd","notify_time"),width:302},{xtype:"syno_combobox",store:s,displayField:"display",valueField:"value",triggerAction:"all",mode:"local",width:93,name:"mail_scheduled_hour",value:t[0][0],editable:!1},{xtype:"syno_displayfield",value:":",tabindex:-1},{xtype:"syno_combobox",store:n,displayField:"display",valueField:"value",triggerAction:"all",width:93,mode:"local",name:"mail_scheduled_minute",value:i[0][0],editable:!1}]},{indent:2,xtype:"syno_textfield",fieldLabel:_T("passwd","notify_frequency"),labelWidth:364,width:204,name:"mail_notification_days",allowBlank:!1,maskRe:/[0-9,]/,regex:/^([0-9]{1,3}(,[0-9]{1,3})*|^[^0])$/,value:"7",maxLength:4096,listeners:{afterrender:function(e){SYNO.ux.AddTip(this.getEl(),_T("passwd","notify_frequency_tip"))}},validator:Ext.createDelegate((function(e){var t=e.split(",").map(Number),i=Ext.getCmp(this.min_age_enable_id).getValue(),s=Ext.getCmp(this.max_age_id).getValue(),n=Ext.getCmp(this.min_age_id).getValue();return t.sort((function(e,t){return t-e})),t[0]>s?_T("passwd","notify_day_greater_than_maxage"):!0===i&&t[t.length-1]<n?_T("passwd","notify_day_smaller_than_minage"):0!==t[t.length-1]}),this)}]}},processReturnData:function(e,t,i){if(t.has_fail){var s=this.checkError(t);if(s.hasError)return this.owner.getMsgBox().alert(this.title,s.errMsg),!1}!0!==this.oriStrongPasswordEnable||this.getForm().findField("strong_password_enable").getValue()||this.owner.getMsgBox().alert(this.title,_T("passwd","alert_disable_passwd_strength"));var n=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.User.PasswordPolicy","get"),o=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.User.PasswordExpiry","get");n.strong_password&&SYNO.SDS.AdminCenter.User.applyPasswordPolicy(this.passwordChecker,n.strong_password),this.form.setValues({enable_reset_passwd_by_email:n.enable_reset_passwd_by_email}),this.form.setValues({password_must_change:n.password_must_change}),Object.keys(n.strong_password).length>0&&(this.form.setValues({strong_password_enable:!0}),this.form.setValues(n.strong_password),this.successHandler||(this.oriStrongPasswordEnable=n.strong_password.strong_password_enable)),this.form.findField("password_expire_enable").suspendEvents(!0),this.form.setValues(o),this.form.findField("password_expire_enable").resumeEvents(),this.userHomeFieldSet.processReturnData(e,t,i)},checkError:function(e){let t=!1,i=[];Ext.each(e.result,(function(e){if(!e.success){if("SYNO.S2S.Server.Pair"===e.api&&(703===e.error.code||707===e.error.code))return!0;if("SYNO.Core.User.Home"===e.api&&"get"===e.method&&3113===e.error.code)return!0;e.error&&e.error.code&&i.push(e.error.code),t=!0}}));const s=SYNO.API.Errors.core[i[0]]||_JSLIBSTR("uicommon","error_system");return{hasError:t,errMsg:s}},onApiSuccess:function(e,t,i){this.findAppWindow().clearStatus(),t.has_fail=this.checkError(t).hasError,"set"===e&&(t.has_fail?(this.module.confirmSaveLostReject&&this.module.confirmSaveLostReject(),this.module.panel&&this.module.panel.setActiveTab("option_tab")):(this.module.confirmSaveLostResolve&&this.module.confirmSaveLostResolve(),this.setStatusOK())),this.callParent(arguments)},processParams:function(e,t){for(var i=0;i<t.length;i++){var s=t[i];if("SYNO.Core.User.PasswordPolicy"===s.api&&"set"===s.method){var n=["exclude_username","included_numeric_char","included_special_char","min_length_enable","min_length","mixed_case","exclude_common_password","exclude_history","history_num"];if(s.params.strong_password={},s.params.strong_password_enable)for(var o=0;o<n.length;o++)s.params.strong_password[n[o]]=s.params[n[o]],delete s.params[n[o]];this.setAllMustChgPwd&&(s.params.strong_password.set_all_mustchgpwd=!0),this.setAllMustChgPwd=!1,delete s.params.strong_password_enable}else"SYNO.Core.User.PasswordExpiry"===s.api&&"set"===s.method&&s.params.password_expire_enable&&(s.params.never_expired_list=this.neverExpiredList)}return t=t.concat(this.userHomeFieldSet.processParams(e,t))},isPasswordRuleModified:function(){if(!this.getForm().findField("strong_password_enable").getValue())return!1;return["exclude_username","mixed_case","included_numeric_char","included_special_char","exclude_common_password","min_length_enable","min_length"].some((e=>this.getForm().findField(e).isDirty()))},onBeforeRequest:function(e){if("set"===e&&this.showMustChgPwdConfirm&&this.isPasswordRuleModified()){return new SYNO.SDS.AdminCenter.User.ConfirmSetMustChgPwdDialog({module:this.module,owner:this.owner,callback:function(e){this.showMustChgPwdConfirm=!1,this.setAllMustChgPwd="yes"===e,this.applyHandler(),this.showMustChgPwdConfirm=!0},scope:this}).open(),!1}return!0},getMailSetting:function(){this.sendWebAPI({compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.Notification.Mail.Conf",version:1,method:"get"},{api:"SYNO.Core.NormalUser",version:1,method:"get"}]},scope:this,callback:function(e,t,i,s){t.has_fail||(this.enable_mail=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Notification.Mail.Conf","get","enable_mail"),this.current_user_mail=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.NormalUser","get","email"))}})},activate:function(){this.userHomeFieldSet.restartHomePolling(),this.getMailSetting()},deactivate:function(){return this.userHomeFieldSet.stopHomePolling(),!this.getForm().isDirty()},defineBehaviors:function(){new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"min_length_enable",["min_length"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"strong_password_enable",["exclude_username","included_numeric_char","included_special_char","min_length_enable","min_length","mixed_case","exclude_common_password","exclude_history","history_num"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"exclude_history",["history_num"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"min_age_enable",["min_age"],[],{disable_group:!0}),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_login_prompt",["login_prompt_days"],[],{disable_group:!0}),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_mail_notification",["mail_notify_time","mail_scheduled_hour","mail_scheduled_minute","mail_notification_days"],[],{disable_group:!0}),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"password_expire_enable",["max_age","min_age_enable","min_age","enable_login_prompt","login_prompt_days","allow_reset_after_expired","enable_mail_notification","mail_notify_time","mail_scheduled_hour","mail_scheduled_minute","mail_notification_days"],[],{disable_group:!0})},applyHandler:function(){return!this.form.findField("strong_password_enable").getValue()||!this.form.findField("exclude_history").getValue()||this.form.findField("password_expire_enable").getValue()&&this.form.findField("min_age_enable").getValue()?this.form.findField("strong_password_enable").getValue()&&!this.hasRule()?(this.owner.getMsgBox().alert(this.title,_T("passwd","invalid_rule")),!1):!!this.onBeforeRequest("set")&&this.userHomeFieldSet.applyHandler():(this.owner.getMsgBox().alert(this.title,_T("passwd","invalid_history_rule")),!1)},hasRule:function(){var e=this,t=!1;return Ext.each(["exclude_username","mixed_case","included_numeric_char","included_special_char","min_length_enable","exclude_common_password","exclude_history"],(function(i){if(e.getForm().findField(i).getValue())return t=!0,!1})),t}}),Ext.define("SYNO.SDS.AdminCenter.User.UnExpireUserDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.appWin=e.appWin,this.neverExpiredList=e.neverExpiredList,this.panel=this.createPanel(e);var t={width:600,height:420,minWidth:600,minHeight:420,layout:"fit",title:_T("user","join_never_expired_list"),buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.close},{text:_T("common","alt_apply"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.panel]};Ext.apply(t,e),this.callParent([t])},onApply:function(){this.panel.getStore().each((function(e){e.get("is_checked")&&this.neverExpiredList.push(e.get("name"))}),this),this.close()},createPanel:function(e){var t=new SYNO.API.JsonStore({appWindow:this,autoDestroy:!0,api:"SYNO.Core.Group.ValidLocalAdmin",method:"list",version:1,baseParams:{},listeners:{exception:{scope:this,fn:this.onStoreException},beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad}},fields:[{name:"is_checked",type:"boolean",mapping:function(e){return e.name===_S("user")}},{name:"name",type:"string"}],root:"users",id:"name",remoteSort:!1}),i=new SYNO.ux.EnableColumn({enableFastSelectAll:!0,header:_T("userwizard","join_group"),dataIndex:"is_checked",width:50,align:"center"}),s=new Ext.grid.ColumnModel([i,{id:"name",header:_T("user","user_account"),dataIndex:"name",width:150}]),n={title:_T("user","user_groups"),cm:s,ds:t,plugins:[i],autoExpandColumn:"name",enableColLock:!1,enableHdMenu:!1,cls:"without-dirty-red-grid",bbar:{autoHeight:!0,items:[{tabIndex:0,xtype:"syno_displayfield",style:{"white-space":"pre-wrap","word-wrap":"break-word"},value:_T("user","user_never_expire_list_desc"),"aria-label":_T("user","user_never_expire_list_desc")}]}};return Ext.apply(n,e),new SYNO.ux.GridPanel(n)},afterRender:function(e){this.callParent([e]),this.panel.getStore().load()},onStoreException:function(e){this.clearStatusBusy()},onBeforeLoad:function(e,t){this.setStatusBusy()},onLoad:function(e,t,i){this.clearStatusBusy()}}),Ext.define("SYNO.SDS.AdminCenter.User.ConfirmSetMustChgPwdDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.callParent([this.fillConfig(e)])},fillConfig:function(e){let t={width:580,minHeight:160,autoHeight:!0,resizable:!1,draggable:!1,header:!1,cls:"x-window-dlg",padding:"24px 30px 0px",elements:"body",items:[{xtype:"syno_displayfield",value:_T("user","confirm_set_must_chg_pwd")},{xtype:"syno_checkbox",checked:!1,htmlEncode:!1,boxLabel:`<span class="red-status">${_T("user","agree_set_must_chg_pwd")}</span>`,listeners:{scope:this,check:function(e,t){this.getFooterToolbar().getComponent("apply").setDisabled(!t)}}}],fbar:{items:[{xtype:"syno_button",text:_T("common","skip"),handler:function(){this.btnHandler("no")},scope:this},{xtype:"syno_button",itemId:"apply",text:_T("common","yes"),btnStyle:"blue",disabled:!0,handler:function(){this.btnHandler("yes")},scope:this}]}};return Ext.apply(t,e)},btnHandler:function(e){this.callback&&this.callback.call(this.scope||window,e),this.close()}}),Ext.namespace("SYNO.SDS.AdminCenter.User"),SYNO.SDS.AdminCenter.User.applyPasswordPolicy=function(e,t){Object.keys(t).length>0?(t.strong_password_enable=!0,e.passwordPolicy=Ext.apply({},t)):(t.strong_password_enable=!1,e.passwordPolicy=Ext.apply({},t))},SYNO.SDS.AdminCenter.User.Error2Msg=function(e){return SYNO.API.getErrorString(e)},SYNO.SDS.AdminCenter.User.CreateVolumeMap=function(e){e.map={},Ext.each(e.volumes,(function(t){e.map[t.volume_path]=t}))},SYNO.SDS.AdminCenter.User.Alert=function(e,t,i){var s=_T("tree","leaf_user"),n=_T("common","error_system"),o=-1,a="";if(e){if("string"==typeof e)n=e;else if("number"==typeof e)o=e,n=SYNO.SDS.AdminCenter.User.Error2Msg(o);else if(e instanceof Array)for(var r=0;r<e.length;r++)if(!e[r].success){o=e[r].error.code,n=SYNO.SDS.AdminCenter.User.Error2Msg(o),3321===o&&(a=e[r].error.errors.fail_share);break}}else;switch(o){case 3110:n=String.format(n,_D("maxaccounts"));break;case 3321:n=String.format(_T("share","error_too_many_acl_rules_with_sharename"),a)}this.getMsgBox().alert(s,n,t,i)},SYNO.SDS.AdminCenter.User.CMS_USER="SynologyCMS",Ext.define("SYNO.SDS.AdminCenter.User.UserListGrid",{extend:"SYNO.ux.GridPanel",itemId:"user_tab",constructor:function(e){this.authType=e.authType||"local",this.pageSize=this.isLocal()?-1:50,this.isFirstLoad=!0,Ext.copyTo(this,e,["owner","module","authType","domain","appWin","app","passwordChecker"]);var t=this.createStore();this.module.ds=t,this.isHCM="yes"===_D("support_hyper_converged","no"),this.isHCMAgent=this.isHCM&&!_S("sofs_is_controller");var i={module:this,title:_T("tree","leaf_user"),header:!1,border:!1,height:404,width:750,ds:t,cm:this.createColumnModel(),autoExpandColumn:"descr",enableHdMenu:"domain"===this.authType,selModel:new Ext.grid.RowSelectionModel({singleSelect:"local"!==this.authType}),listeners:{deactivate:this.deactivate},tbar:this.configTopToolbar(e),bbar:this.createBBar()};this.isLocal()&&(i.view=new SYNO.ux.FleXcroll.grid.BufferView({trackResetOnLoad:!1,scrollDelay:!1,cacheSize:50})),Ext.apply(i,e),this.callParent([i]),this.isHCMAgent||this.defineBehaviors()},isLocal:function(){return"local"===this.authType},defineBehaviors:function(){this.mon(this,"rowdblclick",(function(e,t,i){this.editHandler()}),this),this.mon(this.getSelectionModel(),"selectionchange",this.setButtonState,this,{buffer:50}),this.mon(this,"rowcontextmenu",this.onRowContextMenu,this),this.mon(this,"containercontextmenu",this.onContainerContextMenu,this),this.canPressDelete=!0,"local"===this.authType&&this.mon(this,"keydown",(function(e){e.getKey()==e.DELETE&&this.canPressDelete&&this.deleteHandler()}),this),this.forget_password={},this.sharePermLimited={},!_S("is_admin")&&SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main")&&this.sendWebAPI({api:"SYNO.Core.Share.Permission",version:1,method:"list_by_user",params:{name:_S("user"),user_group_type:_S("authType")+"_user",share_type:["dec","local","usb","sata","cluster","c2","cold_storage","worm"],additional:["hidden","encryption","is_aclmode"]},scope:this,callback:function(e,t,i){if(e){if(t.shares)for(var s=0;s<t.shares.length;s++)this.sharePermLimited[t.shares[s].name]=t.shares[s].is_writable}else SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,t.code)}})},domainActivateLoad:function(){this.sendWebAPI({api:"SYNO.Core.Directory.Domain",version:2,method:"get_domain_list",scope:this,callback:function(e,t,i){e&&(this.domainFilter.updateList(t.domain_list),this.store.baseParams.domain_name=this.module.currDomain),this.getStore().load()}})},show:function(){this.callParent(arguments),"local"===this.authType&&this.getStore().reload()},activate:function(){"domain"===this.authType?this.domainActivateLoad():"ldap"===this.authType?(this.updateButton&&this.updateButton.startPolling&&this.updateButton.startPolling(),this.getStore().load()):this.getStore().load()},deactivate:function(){return this.updateButton&&this.updateButton.pollingId&&(this.updateButton.stopPolling(),this.getEl().unmask()),!0},refreshGrid:function(){this.getStore()&&!this.isDestroyed&&(this.getStore().load(),this.doLayout(),this.setButtonState())},getCacheData:function(){return this.cacheData||(this.cacheData={}),this.cacheData},configTopToolbar:function(e){if(this.actionEdit=new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",scope:this,hidden:this.isHCMAgent,handler:this.editHandler}),this.actionDel=new Ext.Action({text:_T("common","delete"),itemId:"delete",hidden:this.isHCMAgent,scope:this,handler:this.deleteHandler}),this.actionDelegate=new Ext.Action({text:_T("delegation","delegate"),itemId:"delegate",hidden:!_S("is_admin")||this.isHCM,scope:this,menu:new SYNO.ux.Menu({items:[{text:_T("delegation","title"),itemId:"delegate",scope:this,handler:this.delegateHandler},{text:_T("delegation","permission_viewer"),itemId:"delegate_viewer",scope:this,handler:function(){new SYNO.SDS.AdminCenter.User.DelegateViewerDialog({owner:this.appWin,module:this.module}).open()}}]})}),this.actionExport=new Ext.Action({text:_T("user","user_export"),itemId:"export_user",hidden:!_S("is_admin")||this.isHCMAgent,scope:this,menu:new SYNO.ux.Menu({items:[{text:"HTML",scope:this,handler:this.exportHandler("html")},{text:"CSV",scope:this,handler:this.exportHandler("csv")}]})}),this.btnEdit=new SYNO.ux.Button(this.actionEdit),this.btnDel=new SYNO.ux.Button(this.actionDel),this.btnDelegate=new SYNO.ux.Button(this.actionDelegate),this.btnExport=new SYNO.ux.Button(this.actionExport),this.isLocal()?this.findField=new SYNO.ux.TextFilter({iconStyle:"filter",itemId:"search",localFilter:!0,localFilterField:["name","description","email"],blOr:!0,emptyText:_T("common","filter_label_text"),store:this.module.ds}):this.findField=new SYNO.ux.TextFilter({iconStyle:"search",queryParam:"substr",itemId:"search",emptyText:_T("user","search_user"),store:this.module.ds,pageSize:this.pageSize}),"ldap"===this.authType)return e.updateButton.grid=this,{items:[this.btnEdit,e.homeButton,this.btnDelegate,e.updateButton,"->",this.findField]};if("domain"===this.authType){e.updateButton.grid=this,e.domainFilter.grid=this;let t=new Ext.Panel({cls:"syno-domain-toolbar-panel-wrapper",autoHeight:!0,items:[new SYNO.ux.Toolbar({itemId:"innerToolbar",items:[this.btnEdit,e.homeButton,this.btnDelegate,e.updateButton,"->",{xtype:"syno_displayfield",itemId:"filterName",value:_T("helptoc","directory_service_domain")+_T("common","colon"),style:"margin-right: 8px"},e.domainFilter,this.findField]}),e.statusBar]});return this.getTopToolbar=function(){return t.getComponent("innerToolbar")},{layout:"fit",style:"padding: 0; border: 0;",items:[t]}}return{items:[this.actionCreate=new SYNO.ux.SplitButton({text:_T("common","create"),handler:this.createHandler,scope:this,hidden:this.isHCMAgent,itemId:"create_users",menu:{items:[{text:_T("user","newuser_dlgtitle"),scope:this,handler:this.createHandler},{text:_T("user","user_import"),scope:this,handler:_S("demo_mode")?function(){SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,_JSLIBSTR("uicommon","error_demo"))}:this.launchUserFileDialog},{text:_T("user","copy_user"),itemId:"copy_user",scope:this,hidden:this.isHCM,disabled:!0,handler:this.copyUserHandler}]}}),this.btnEdit,this.btnDel,this.btnExport,this.btnDelegate,"->",this.findField]}},createStore:function(){var e={api:"SYNO.Core.User",method:"list",version:1,appWindow:this.appWin,baseParams:{type:this.authType,offset:0,limit:this.pageSize,additional:"domain"===this.authType?["email","fullname","description","expired","office","telephone","title","department","company","2fa_status"]:["email","description","expired","2fa_status"]},listeners:{exception:{scope:this,fn:this.onStoreException},beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad}},root:"users",totalProperty:"total",id:"name",fields:"domain"===this.authType?["name","fullname","description","email","expired","office","telephone","title","department","company","2fa_status"]:[{name:"name",sortType:"asNaturalUCString"},"description","email","expired","2fa_status"],remoteSort:!this.isLocal(),defaultSortable:!0,scope:this};return this.isLocal()&&(e.sortInfo={field:"name",direction:"asc"}),new SYNO.API.JsonStore(e)},createColumnModel:function(){var e=[{header:_T("user","user_account")+"<span id='"+Ext.id()+"'></span>",headerHtmlEncode:!1,dataIndex:"name",hideable:!1,width:200},{header:_T("domain","full_name"),dataIndex:"fullname",width:200,hidden:"domain"!==this.authType},{header:_T("user","user_email"),dataIndex:"email",width:200,hidden:"ldap"===this.authType},{id:"descr",header:_T("user","user_fullname"),dataIndex:"description",width:200,renderer:function(e,t){var i=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i)+'"',i}},{header:_T("user","user_2fa_status"),dataIndex:"2fa_status",width:150,scope:this,renderer:function(e){return!0===e?_T("user","user_2fa_enabled"):_T("user","user_2fa_disabled")}},{header:_T("user","user_acnt_status"),dataIndex:"expired",width:150,scope:this,renderer:function(e){if("Must Change"===e)return'<span class="orange-status">'+_T("user","user_acnt_mustchange")+"</span>";if("Password Expired"===e)return'<span class="orange-status">'+_T("user","user_pwd_expired")+"</span>";if("Locked"===e)return'<span class="red-status">'+_T("user","user_acnt_locked")+"</span>";if("normal"==e)return _T("user","user_acnt_normal");if("now"==e)return'<span class="red-status">'+_T("user","user_acnt_disabled")+"</span>";if("lockout"==e)return'<span class="red-status">'+_T("user","user_lockout")+"</span>";if("expired"===e)return'<span class="orange-status">'+_T("user","user_acnt_expired")+"</span>";if("Password Pending"===e)return _T("user","user_acnt_not_activated");var t=new Date;if(t.setHours(0,0,0,0),new Date(e)<t)return'<span class="orange-status">'+_T("user","user_acnt_expired")+"</span>";if(e){var i=SYNO.SDS.DateTimeFormatter(Date.parseDate(e,"Y/n/j"),{type:"date"});return'<span class="green-status">'+_T("user","user_acnt_expired_date")+i+"</span>"}return _T("user","user_acnt_unknow_status")}},{header:_T("user","user_telephone"),dataIndex:"telephone",width:150,hidden:!0},{header:_T("user","user_title"),dataIndex:"title",width:150,hidden:!0},{header:_T("user","user_department"),dataIndex:"department",width:150,hidden:!0},{header:_T("user","user_company"),dataIndex:"company",width:150,hidden:!0},{header:_T("user","user_office"),dataIndex:"office",width:150,hidden:!0}];return new Ext.grid.ColumnModel({defaults:{sortable:"ldap"!==this.authType},columns:e})},createBBar:function(){return this.isLocal()?new SYNO.ux.PageLessToolbar({store:this.module.ds,displayInfo:!0}):new SYNO.ux.PagingToolbar({store:this.module.ds,pageSize:this.pageSize,displayButtons:!0,displayInfo:!0})},onBeforeLoad:function(e,t){if("domain"===this.authType){var i=[];this.domainFilter.setValue(this.module.currDomain),this.store.baseParams.domain_name=this.module.currDomain?this.module.currDomain:"",this.getColumnModel().getColumnsBy((function(e){return e.hidden||i.push(e.dataIndex),!1})),t.params.searchFields=i}this.appWin.setStatusBusy()},onLoad:function(e,t,i){if(this.appWin.clearStatus(),this.isFirstLoad=!1,this.setButtonState(),"local"===this.authType){if(this.focusUserName){var s=this.getStore().indexOfId(this.focusUserName);this.getSelectionModel().selectRow(s),function(){this.getView().focusRow(s)}.defer(100,this),this.focusUserName=null}this.module.launchUserDialogOnLoad&&(this.launchUserDialog(this.module.launchUserDialogOnLoad),this.module.launchUserDialogOnLoad="")}else 0===e.getCount()?this.addClass("syno-directory-service-user-group-gridpanel"):this.removeClass("syno-directory-service-user-group-gridpanel")},onStoreException:function(e,t,i,s,n,o){var a=this.module.getPanel();if(SYNO.Debug("Store exception: options:",e,t,i,s,n,o),this.appWin.clearStatus(),this.store.loadData({users:[]}),n.code){if(3105===n.code)return this.getEl().mask(_T("directory_service","warr_db_not_ready"),"syno-ux-mask-info"),void(this.updateButton.pollingId||this.updateButton.restartPolling());n.code,a.userTab&&"list"===s.params.action&&a.userTab.getTopToolbar().getComponent("search").getValue()&&a.userTab.getTopToolbar().getComponent("search").reset(),SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,_T("user","failed_load_user"))}else this.appWin.getMsgBox().alert("",_T("common","error_system"))},deselectUsers:function(e){for(var t=this.getSelectionModel(),i=0;i<e.length;i++){var s=this.getStore().indexOfId(e[i]);-1!=s&&t.deselectRow(s)}},loadUserDetailAPIs:function(e){var t=[{api:"SYNO.Core.Group",version:1,method:"list",params:{user:e,name_only:!1,type:"local"}}];return(_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.Share.Main"))&&(t=t.concat([{api:"SYNO.Core.Share.Permission",version:1,method:"list_by_user",params:{name:e,user_group_type:"local_user",share_type:["dec","local","usb","sata","cluster","c2","cold_storage","worm"],additional:["hidden","encryption","is_aclmode"]}}])),(_S("is_admin")||SYNO.SDS.ActionPrivilege.AllowList.includes("SYNO.SDS.AdminCenter.AppRulePrivileges.Main"))&&"admin"!=e&&"guest"!=e&&(t=t.concat([{api:"SYNO.Core.AppPriv.Rule",version:1,method:"get",params:{entity_type:"user",entity_name:e}},{api:"SYNO.Core.AppPriv.App",version:2,method:"list"}])),t},copyUserHandler:function(){var e=this.getSelectionModel().getSelected();if(e){if(e.get("name").toUpperCase()!==SYNO.SDS.AdminCenter.User.CMS_USER.toUpperCase()){var t=_D("maxaccounts");if(t<=this.store.getTotalCount())SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,String.format(_T("user","error_toomanyur"),t));else{this.templateName=e.get("name");var i=this.loadUserDetailAPIs(this.templateName);this.sendWebAPI({params:{},compound:{stopwhenerror:!0,params:i},callback:function(e,t,i){var s={};if(this.appWin.clearStatus(),e){s.name=this.templateName,s.share=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Share.Permission","list_by_user"),s.appPriv=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.AppPriv.Rule","get");var n=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.AppPriv.App","list");if(void 0===n)s.ignoreAppPriv=!0;else{s.ignoreAppPriv=!1;for(var o=0;o<n.applications.length;o++)for(var a=0;a<s.appPriv.rules.length;a++)if(n.applications[o].app_id===s.appPriv.rules[a].app_id){s.appPriv.rules[a].appName=n.applications[o].name;break}}new SYNO.SDS.AdminCenter.User.CreateUserWizardDialog({owner:this.module.appWin,module:this.module,isCopyMode:!0,defaultData:s,passwordChecker:this.passwordChecker}).open()}else this.appWin.getMsgBox().alert(_T("tree","leaf_user"),_T("user","failed_load_user"),this.close,this)},scope:this})}}}else SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,_T("user","error_rmvempty"))},createHandler:function(){var e=_D("maxaccounts");if(e<=this.store.getTotalCount())SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,String.format(_T("user","error_toomanyur"),e));else{var t=new SYNO.SDS.AdminCenter.User.CreateUserWizardDialog({owner:this.module.appWin,module:this.module,isCopyMode:!1,sharePermLimited:this.sharePermLimited,passwordChecker:this.passwordChecker});this.appWin.openExtWindow(t)}},editHandler:function(){var e=this.getSelectionModel().getSelected();e?e.get("name").toUpperCase()!==SYNO.SDS.AdminCenter.User.CMS_USER.toUpperCase()&&this.launchUserDialog(e.get("name")):SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,_T("user","error_rmvempty"))},loadHomeInfoAndDelete:function(){this.appWin.setStatusBusy(),SYNO.API.Request({api:"SYNO.Core.User.Home",version:1,method:"get",callback:function(e,t,i){this.isDestroyed||(this.appWin.clearStatus(),e?this.launchUserDeletionDialog(!Ext.isEmpty(t.location)):SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,t.code))},scope:this})},selectReservedUser:function(e){var t=!1;return Ext.each(e.getSelections(),(function(e){if(e.id.toUpperCase()===SYNO.SDS.AdminCenter.User.CMS_USER.toUpperCase())return t=!0,!1})),e.isIdSelected("admin")||t||e.isIdSelected("guest")},deleteHandler:async function(){var e=this.getSelectionModel();return this.selectReservedUser(e)?(await this.appWin.getMsgBox().alert(_T("tree","leaf_user"),_T("user","error_rmvdef")),void this.deselectUsers(["admin",SYNO.SDS.AdminCenter.User.CMS_USER,"guest"])):e.isIdSelected(_S("user"))?(await this.appWin.getMsgBox().alert(_T("tree","leaf_user"),_T("user","error_rmvcur")),void this.deselectUsers([_S("user")])):(this.canPressDelete=!1,void this.loadHomeInfoAndDelete())},delegateHandler:function(){var e=[],t=this.getSelectionModel().getSelections();0!==t.length?(Ext.each(t,(function(t){e.push(t.get("name"))})),this.launchUserDelegateDialog(e)):this.appWin.getMsgBox().alert(_T("tree","leaf_user"),_T("user","error_rmvempty"))},stopExport:async function(){try{await synowebapi.promises.request({api:"SYNO.Core.User",method:"export_prepare_stop",version:"1",params:{task_id:this.exportTaskId||""}}),this.isCancelExport=!0,delete this.exportTaskId}catch(e){SYNO.Debug(e)}},exportProgressHandler:async function(e){await this.stopExport(),this.stopExportPolling()},showExportProgress:function(e){this.msgBox=this.findAppWindow().getMsgBox(),this.msgBox.progress(e,0,"","%",{confirm:!1}).then((e=>{this.exportProgressHandler(e)}))},updateExportProgress:function(e,t){var i;null===(i=this.msgBox)||void 0===i||i.progress(t,e,"","%",{confirm:!1}).then((e=>{this.exportProgressHandler(e)}))},stopExportPolling:async function(){var e;Ext.isDefined(this.ExportPollingId)&&(await(null===(e=this.msgBox)||void 0===e?void 0:e.close()),this.pollUnreg(this.ExportPollingId),delete this.ExportPollingId)},startExport:function(e){this.showExportProgress(_T("login","check_status_title")),this.ExportPollingId=this.pollReg({interval:3,immediate:!0,scope:this,webapi:{api:"SYNO.Core.User",method:"export_prepare_status",params:{task_id:this.exportTaskId},version:1},status_callback:async function(t,i){if(!t)return await this.stopExportPolling(),delete this.exportTaskId,void this.findAppWindow().getMsgBox().alert("",SYNO.API.getErrorString(null==i?void 0:i.code));i.finished?(await this.stopExportPolling(),this.isCancelExport||synowebapi.download({api:"SYNO.Core.User",version:1,method:"export",params:{type:e}})):this.updateExportProgress(i.progress,_T("login","check_status_title"))}})},exportHandler:function(e){return async()=>{"confirm"===await this.findAppWindow().getMsgBox().confirm("",_T("user","export_confirm_desc"),{confirm:{text:_T("common","continue")}},{useHtml:!0})&&(await this.stopExport(),this.sendWebAPI({api:"SYNO.Core.User",method:"export_prepare",version:1,callback:async function(t,i){t?(this.exportTaskId=i.task_id,this.isCancelExport=!1,this.startExport(e)):await this.findAppWindow().getMsgBox().alert("",SYNO.API.getErrorString(null==i?void 0:i.code))},scope:this}))}},setButtonState:function(){var e=this.getSelectionModel(),t=e.getCount();"local"===this.authType&&(t>1?this.actionDel.enable():1!=t||this.selectReservedUser(e)?this.actionDel.disable():this.actionDel.enable()),1==t&&e.getSelections()[0].id.toUpperCase()!==SYNO.SDS.AdminCenter.User.CMS_USER.toUpperCase()?(this.actionEdit.enable(),"local"===this.authType&&this.actionCreate.menu.getComponent("copy_user").enable()):(this.actionEdit.disable(),"local"===this.authType&&this.actionCreate.menu.getComponent("copy_user").disable()),0<t?this.btnDelegate.menu.getComponent("delegate").enable():this.btnDelegate.menu.getComponent("delegate").disable()},onContainerContextMenu:function(e,t){var i=e.getSelectionModel().getSelected(),s=e.store.indexOf(i);this.onRowContextMenu(e,s,t)},onRowContextMenu:function(e,t,i){var s=[],n=this.getSelectionModel();(n.suspendEvents(!1),n.selectRow(t,n.isSelected(t)),this.setButtonState(),n.resumeEvents(),s.push(this.actionEdit),"local"===this.authType&&s.push(this.actionDel),0!==s.length)&&(new SYNO.ux.Menu({autoDestroy:!0,items:s}).showAt(i.getXY()),i.preventDefault())},launchUserDialog:function(e){var t=new SYNO.SDS.AdminCenter.User.UserDialog({owner:this.appWin,module:this.module,ownerGrid:this,username:e,authType:this.authType||"local",sharePermLimited:this.sharePermLimited,passwordChecker:this.passwordChecker});this.appWin.openExtWindow(t),this.mon(t,"userchange",(function(e){this.focusUserName=e,this.getStore().load()}),this)},launchUserDeletionDialog:function(e){var t=this.getSelectionModel().getSelections(),i=[],s=0,n=null;if(0!==t.length){for(s=0;s<t.length;s++)i.push(t[s].get("name"));n=new SYNO.SDS.AdminCenter.User.DeleteDialog({owner:this.owner,module:this.module,appWin:this.appWin,ownerGrid:this,homesExist:e}),this.mon(n,"close",(function(){this.canPressDelete=!0}),this),n.loadUserName(i),n.show()}else SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,_T("user","error_rmvempty"))},launchUserDelegateDialog:function(e){new SYNO.SDS.AdminCenter.User.DelegateDialog({owner:this.appWin,module:this.module,type:"user",name:e}).open()},launchUserFileDialog:function(){var e=_D("maxaccounts");e<=this.store.getTotalCount()?SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,String.format(_T("user","error_toomanyur"),e)):(this.appWin.setStatusBusy(),SYNO.API.Request({api:"SYNO.Core.User.PasswordPolicy",version:1,method:"get",scope:this,callback:function(e,t,i){this.appWin.clearStatus(),new SYNO.SDS.AdminCenter.User.UploadUserFileDialog({owner:this.appWin,module:this.module,password_must_change:t.password_must_change||!1}).open()}}))}}),Ext.define("SYNO.SDS.AdminCenter.User.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.appWin=e.appWin,this.app=e.app,this.module=e.module,this.owner=e.appWin,this.panel=this.createPanel(),this.launchUserDialogOnLoad="",this.callParent([e])},activate:function(e){this.panel=this.getPanel(),this.panel.activate(),this.panel.loadAllForm(),e&&(e.tab?this.panel.setActiveTab(e.tab):e.userHomeDialog?this.panel.setActiveTab("option_tab"):e.userEditDialog&&e.user&&(this.panel.passwordChecker&&this.panel.passwordChecker.passwordPolicy?this.panel.launchUserDialog(e.user):this.launchUserDialogOnLoad=e.user))},deactivate:function(){return this.getPanel().deactivate()},getPanel:function(){return this.panel},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"user_tab":default:return"AdminCenter/file_user_desc.html";case"group_tab":return"AdminCenter/file_group_desc.html";case"option_tab":return"AdminCenter/file_user_advanced.html"}},createPanel:function(){return new SYNO.SDS.AdminCenter.User.TabPanel({module:this,appWin:this.appWin})},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t,this.panel.optionTab&&this.panel.optionTab.applyHandler()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.User.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){Ext.copyTo(this,e,["module","appWin"]),this.passwordChecker=new SYNO.SDS.Utils.CheckStrongPassword,this.userTab=new SYNO.SDS.AdminCenter.User.UserListGrid({owner:this.appWin,module:this.module,appWin:this.appWin,passwordChecker:this.passwordChecker}),this.groupTab=new SYNO.SDS.AdminCenter.Group.GridPanel({owner:this.appWin,module:this.module,appWin:this.appWin}),this.isHCM="yes"===_D("support_hyper_converged","no"),this.isHCMAgent=this.isHCM&&!_S("sofs_is_controller");var t=[this.userTab,this.groupTab];this.optionTab=null,_S("is_admin")&&!this.isHCMAgent&&(this.optionTab=new SYNO.SDS.AdminCenter.User.OptionTab({owner:this.appWin,module:this.module,passwordChecker:this.passwordChecker}),t.push(this.optionTab));var i=Ext.apply({activeTab:0,useDefaultBtn:!1,items:t},e);this.callParent([i])},activate:function(){SYNO.API.Request({api:"SYNO.Core.User.PasswordPolicy",version:1,method:"get",scope:this,callback:function(e,t,i){e?SYNO.SDS.AdminCenter.User.applyPasswordPolicy(this.passwordChecker,t.strong_password):SYNO.SDS.AdminCenter.User.Alert.call(this.appWin,t.code)}}),this.userTab.activate(),this.callParent(arguments)},deactivate:function(){return null!==this.optionTab?this.userTab.deactivate()&&this.optionTab.deactivate():this.userTab.deactivate()},launchUserDialog:function(e){this.userTab.launchUserDialog(e)}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.ServerSettingStep",{extend:"SYNO.ux.FormPanel",LABEL_WIDTH:182,FIELDSET_WIDTH:300,initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",this.onAfterLayout,this,{single:!0})},constructor:function(e){var t=Ext.apply({headline:_T("directory_service","server_setting_title"),labelWidth:this.LABEL_WIDTH,fieldWidth:this.FIELDSET_WIDTH,items:this.initComponents(e)},e);this.callParent([t])},initComponents:function(e){var t=[],i="";return SYNO.API.GetKnownAPI("SYNO.Core.Directory.Domain")&&(t.push({display:_T("directory_service","server_type_auto"),value:"auto"}),t.push({display:_T("network","wnds_domain"),value:"domain"}),i="auto"),t.push({display:_T("ldap","client_title"),value:"ldap"}),0===i.length&&(i="ldap"),[{xtype:"syno_combobox",name:"server_type",fieldLabel:_T("directory_service","server_type"),mode:"local",forceSelection:!0,displayField:"display",valueField:"value",value:i,store:new Ext.data.JsonStore({fields:["display","value"],data:t})},{xtype:"syno_textfield",name:"server_address",fieldLabel:_T("directory_service","server_address")+' <font class="red-status">'+_T("common","star")+"</font>",maxlength:255,allowBlank:!1,labelHtmlEncode:!1,vtype:"iporhostname"},{xtype:"syno_textfield",name:"ldap_server_ip",fieldLabel:"ldap_server_ip",hidden:!0},{xtype:"syno_textfield",name:"dns",fieldLabel:_T("directory_service","dns_server")+' <font class="red-status">'+_T("common","star")+"</font>",labelHtmlEncode:!1,maxlength:64,allowBlank:!1,emptyText:"IP LIST (EXAMPLE: 192.168.1.1,192.168.1.2)",maskRe:/[,.:0-9A-Fa-f]/,validator:SYNO.SDS.AdminCenter.DirectoryService.Util.MultiIPValidator},{xtype:"syno_displayfield",htmlEncode:!1,value:'<font class="red-status">'+_T("common","star")+"</font> "+_T("firewall","firewall_field_blank_alert")}]},onAfterLayout:function(){this.sendWebAPI({api:"SYNO.Core.Network",method:"get",version:1,callback:function(e,t){var i;t.dns_primary&&(i=t.dns_secondary?t.dns_primary+","+t.dns_secondary:t.dns_primary,this.getForm().findField("dns").setValue(i))},scope:this})},checkServerAddress:function(){var e=this.getForm().findField("server_type").getValue(),t=[],i={api:"SYNO.Core.DirectoryServiceCheck.Domain",method:"check_server_address",version:1,params:this.getForm().getValues(),scope:this},s={api:"SYNO.Core.DirectoryServiceCheck.LDAP",method:"check_server_address",version:1,params:this.getForm().getValues(),scope:this};"ldap"===e?t.push(s):"domain"===e?t.push(i):"auto"===e&&(t.push(i),t.push(s)),this.owner.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,mode:"parallel",params:t},scope:this,callback:function(e,t,i){var s,n=this.getForm().findField("server_type").getValue();if(this.owner.clearStatusBusy(),e){for(var o=0;o<t.result.length;o++){if("SYNO.Core.DirectoryServiceCheck.Domain"===(s=t.result[o]).api){if(!s.success||!s.data||!s.data.server_address){if("domain"!==n)continue;return void this.owner.getMsgBox().alert(this.title,_T("directory_service","convert_server_ip_fail"))}if("auto"===n&&s.data.check_address_fail)continue;return this.getForm().findField("server_address").setValue(s.data.server_address),this.getForm().findField("server_type").setValue("domain"),this.owner.setTitle(_T("directory_service","wizard_title_domain")),void this.owner.goNext("domain_info")}if("SYNO.Core.DirectoryServiceCheck.LDAP"!==s.api);else{if(s.success)return this.getForm().findField("ldap_server_ip").setValue(s.data.server_address),this.getForm().findField("server_type").setValue("ldap"),this.owner.setTitle(_T("directory_service","wizard_title_ldap")),void this.owner.goNext("ldap_info");if(!s.success&&s.error&&1e3===s.error.code&&"ldap"===n)return void this.owner.getMsgBox().alert(this.title,_T("directory_service","action_dns_resolve_fail"))}}this.owner.getMsgBox().alert(this.title,_T("directory_service","auto_detect_server_type_fail"))}else this.owner.getMsgBox().alert(this.title,_T("directory_service","auto_detect_server_type_fail"))}})},getNext:function(){return this.getForm().isValid()?this.checkServerAddress():SYNO.Debug("form invalid",this.getForm()),!1}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Domain.ItemMenu",{extend:"SYNO.ux.Menu",shadow:!1,useARIA:!0,constructor:function(e){SYNO.SDS.AdminCenter.DirectoryService.Domain.ItemMenu.superclass.constructor.call(this,e)},onRender:function(e,t){SYNO.SDS.AdminCenter.DirectoryService.Domain.ItemMenu.superclass.onRender.call(this,e,t),this.keyNav.destroy(),this.keyNav=null,this.keyNav=new SYNO.ux.ScheduleMenuNav(this)}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Domain.CheckItemsMenu",{extend:"Ext.form.TriggerField",overCls:"syno-ux-triggerfield-hover",triggerClass:"syno-ux-triggerfield-trigger",isAfterItemClickInvoked:!1,constructor:function(e){this.IFRecords=[],this.owner=e.owner,this.parentForm=e.parentForm,this.loadNetIF(),this.callParent([e]),this.mon(this,"afterrender",(function(){this.onLoad()}),this),this.addClass("syno-ux-triggerfield")},initEvents:function(){SYNO.SDS.AdminCenter.DirectoryService.Domain.CheckItemsMenu.superclass.initEvents.call(this),this.keyNav=new Ext.KeyNav(this.el,{down:function(e){this.menu.isVisible()||this.onTriggerClick()},scope:this})},loadNetIF:function(){this.sendWebAPI({api:"SYNO.Core.Network.Interface",method:"list",version:1,callback:this.loadNetIFCB,scope:this})},loadNetIFCB:function(e,t,i){!0===e?(this.IFRecords=[],t.forEach((function(e){var t={};0!==e.ifname.indexOf("eth")&&0!==e.ifname.indexOf("bond")&&0!==e.ifname.indexOf("ovs_eth")&&0!==e.ifname.indexOf("ovs_bond")||(t.name=e.ifname,t.display=SYNO.SDS.Utils.Network.idToString.apply(this,[t.name,e.type]),this.IFRecords.push(t))}),this),this.setMenu()):this.setMenu()},setMenu:function(){var e=[{text:_T("domain","all_interface"),name:"all_interface",cls:"syno-domain-menu-with-button-checkbox"},"-"];Ext.each(this.IFRecords,(function(t){e.push(new Ext.menu.CheckItem({name:t.name,text:t.display,checked:!1}))})),this.menu&&this.menu.destroy(),this.menu=new SYNO.SDS.AdminCenter.DirectoryService.Domain.ItemMenu({cls:"syno-ux-menu",autoDestroy:!0,items:e}),this.menu.mon(this.menu,"hide",this.onHide,this),this.menu.mon(this.menu,"click",this.onItemClick,this),this.menu.mon(this.menu,"itemclick",this.onBeforeItemClick,this),this.addManagedComponent(this.menu),this.setInterface(["all"])},onTriggerClick:function(){this.disabled||this.menu.show(this.el)},onLoad:function(){this.setDisplayText()},onBeforeItemClick:function(){this.isAfterItemClickInvoked=!0},onItemClick:function(e,t,i){"all_interface"==t.name?this.setInterface(["all"]):this.setDisplayText()},setInterface:function(e){var t=0;if(this.menu&&this.menu.items&&e){var i=this.menu.items.items;if(-1!=e.indexOf("all"))for(t=2;t<i.length;++t)"menucheckitem"==i[t].getXType()&&i[t].setChecked(!0);else for(t=2;t<i.length;++t)"menucheckitem"==i[t].getXType()&&i[t].setChecked(-1!=e.indexOf(i[t].name));this.setDisplayText()}},setValue:function(e){e instanceof Array&&this.setInterface(e)},getValue:function(){var e=!0,t=[],i=[];if(void 0===this.menu||void 0===this.menu.items)return t;i=this.menu.items.items;for(var s=2;s<i.length;++s)"menucheckitem"==i[s].getXType()&&(i[s].checked?t.push(i[s].name):e=!1);return e&&(t=["all"]),t},setDisplayText:function(){var e=!0,t=[],i=[];if(this.menu&&this.menu.items){i=this.menu.items.items;for(var s=2;s<i.length;++s)"menucheckitem"==i[s].getXType()&&(i[s].checked?t.push(i[s].text):e=!1);t=e?_T("domain","all_interface"):t.join(","),SYNO.SDS.AdminCenter.DirectoryService.Domain.CheckItemsMenu.superclass.setValue.call(this,t)}},onRender:function(e,t){this.callParent(arguments),this.label&&this.label.addClass("syno-ux-item-label"),this.trigger&&(this.trigger.addListener("mouseover",this.onMouseover,this),this.trigger.addListener("mouseout",this.onMouseout,this)),this.mon(this.el,{scope:this,mouseover:this.onMouseover,mouseout:this.onMouseout}),SYNO.ux.Utils.setFormItemIndent(this),SYNO.ux.Utils.setFormFieldWidth(this),this.hiddenName&&(this.hiddenField=this.el.insertSibling({tag:"input",type:"hidden",name:this.hiddenName,id:this.hiddenId||this.hiddenName},"before",!0),this.hiddenField.value=void 0!==this.hiddenValue?this.hiddenValue:void 0!==this.value?this.value:"",this.el.dom.removeAttribute("name"))},onHide:function(){this.isAfterItemClickInvoked&&this.menu.show(this.el,"tl-bl?"),this.isAfterItemClickInvoked=!1,this.focus()},onMouseover:function(){this.addClass("syno-ux-triggerfield-hover"),this.trigger.addClass("x-form-trigger-over")},onMouseout:function(){this.removeClass("syno-ux-triggerfield-hover"),this.trigger.removeClass("x-form-trigger-over")},markInvalid:function(e){this.callParent(arguments),this.trigger.addClass("syno-ux-trigger-invalid")},clearInvalid:function(){this.callParent(arguments),this.trigger.removeClass("syno-ux-trigger-invalid")}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService.Domain.Util"),SYNO.SDS.AdminCenter.DirectoryService.Domain.LABELWIDTH=260,SYNO.SDS.AdminCenter.DirectoryService.Domain.FIELDWIDTH=430,Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.Filter",{extend:"SYNO.ux.ComboBox",constructor:function(e){var t=Ext.apply({width:100,hideLabel:!1,valueField:"value",displayField:"domain",ctCls:"syno-domain-filter-container",store:{xtype:"arraystore",autoDestroy:!0,fields:["domain","value","comment"]},mode:"local",triggerAction:"all",editable:!0,value:"",tpl:new Ext.XTemplate('<tpl for="."><div ext:qtip="{[Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(values.comment))]}" class="x-combo-list-item">{[Ext.util.Format.htmlEncode(values.domain)]}</div></tpl>'),forceSelection:!0,listeners:{select:this.onSelect}},e);this.addEvents("filterchanged"),this.callParent([t])},updateList:function(e){var t=[],i=!0;Ext.each(e,(function(e){"object"==typeof e?(e[1]?t.push(e):t.push([_T("directory_service","domainou_list_all_items"),e[1],e[2]]),e[1]&&e[1]===this.getValue()&&(i=!1)):(t.push([e,e,e]),e===this.getValue()&&(i=!1))}),this),this.getStore().loadData(t),i&&0!==t.length&&(this.setValue(t[0][1]||""),this.module.currDomain=t[0][1]||""),this.fireEvent("filterchanged",this.module.currDomain)},onSelect:function(e,t){var i="",s=this.grid.getStore();this.grid&&e.data&&e.data.value&&(i=e.data.value),this.module.currDomain=i,s.baseParams.domain_name=this.module.currDomain,s.load({params:{offset:0}}),this.collapse(),this.fireEvent("filterchanged",this.module.currDomain)}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.UpdateButton",{extend:"SYNO.ux.Button",initEvents:function(){this.addEvents("syncdb")},constructor:function(e){this.panel=e.panel,this.grid=e.grid,this.syncAction=new Ext.Action({text:_T("directory_service","sync"),itemId:"sync_action",scope:this,menu:new SYNO.ux.Menu({items:[{text:_T("directory_service","update_all_domain"),itemId:"sync_domain",scope:this,handler:this.syncDomainHandler},{text:_T("directory_service","check_sync_status"),itemId:"sync_status",scope:this,handler:this.syncStatusHandler}]})});var t=Ext.apply(this.syncAction,e);this.initEvents(),this.callParent([t])},syncDomainHandler:async function(){const e=this.panel.currDomain,t=new Ext.Template(_T("directory_service","sync_domain_confirm_title")).apply({domain:e}),i=_T("directory_service","sync_domain_confirm_desc"),s={confirm:{text:_T("directory_service","sync_data_btn")}};"confirm"===await this.findAppWindow().getMsgBox().confirm(t,i,s)&&this.syncDomainDb(e)},syncStatusHandler:function(){this.findAppWindow().openModalWindow(SYNO.SDS.AdminCenter.DirectoryService.DomainDbStatusDialog,{})},syncDomainDb:function(e){this.grid&&SYNO.API.Request({api:"SYNO.Core.Directory.Domain",method:"sync_db",version:1,params:{domain:e},scope:this,callback:function(e,t){e?this.fireEvent("syncdb",this):SYNO.Debug("Failed to sync domain database")}})}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.DCIP",{extend:"SYNO.ux.CompositeField",defaultMargins:"0 0 0 0",boxMinHeight:28,initEvents:function(){this.callParent(arguments),this.mon(this,"afterrender",this.addTip,this)},constructor:function(e){this.name=e.name;const t={name:this.name,fieldLabel:_T("network","domain_kdc_ip"),items:this.createItems(e)};this.callParent([t])},createItems:function(e){return this.superBoxSelect=new SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.SuperBoxSelect(Ext.apply({owner:this},e)),this.boxCmp=new Ext.BoxComponent({width:0,height:28}),[this.superBoxSelect,this.boxCmp]},addTip:function(){SYNO.ux.AddTip(this.boxCmp.getEl(),_T("domain","dcip_tip"))},updateLayout:function(){this.setHeight(this.superBoxSelect.getHeight()),this.findWindow().doLayout()},getValue:function(){return this.superBoxSelect.getValue()},setDCIPValue:function(e){this.superBoxSelect.setDCIPValue(e)}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.SuperBoxSelect",{extend:"SYNO.ux.SuperBoxSelect",initEvents:function(){this.callParent(arguments),this.mon(this,"afterrender",this.setDCIPValue,this),this.mon(this,"afterrender",(function(){this.mon(this,"autosize",this.updateLayout,this)}),this)},constructor:function(e){const t={maxlength:255,ctCls:"syno-domain-dcip-field",hideLabel:!0,style:"text-transform: uppercase;",store:new Ext.data.SimpleStore({fields:["host"]}),mode:"local",allowAddNewData:!0,addNewDataOnBlur:!0,renderFieldBtns:!1,htmlEncode:!0,displayField:"host",valueField:"host",maskRe:/[-.*:0-9A-Za-z]/,validator:SYNO.SDS.AdminCenter.DirectoryService.Util.DCIPValidator,listeners:{scope:this,newitem:function(e,t){this.addItem({host:t.toUpperCase()})}}};this.callParent([Ext.apply(t,e)])},setDCIPValue:function(e){let t=[],i=[];i=Ext.isString(e)?e.split(","):Ext.isArray(e)?e:this.dcipValue?this.dcipValue.split(","):[];for(const e of i)""!==e&&t.push({host:e});this.setValueEx(t),this.originalValue=this.getValue()},updateLayout:function(){this.oldHeight!==this.getHeight()&&(this.oldHeight=this.getHeight(),this.owner.updateLayout())}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.DbStatusBar",{extend:"SYNO.ux.Toolbar",initEvents:function(){this.addEvents("hidebar"),this.on("afterrender",(function(){this.el.on("click",this.showAllStatus,this,{delegate:"a.show-all-link"}),this.el.on("click",this.onClose,this,{delegate:"div.close-icon"})}),this)},constructor:function(e){const t={cls:"syno-domain-db-status-bar",boxMinHeight:32,width:"100%",hidden:!0,data:{status:"unknown",desc:""},tpl:this.createTpl()};this.initEvents(),this.callParent([Ext.apply(t,e)])},createTpl:function(){return new Ext.XTemplate('<div class="status-bar-wrapper status-bar-bg-{status}">','<div class="status-icon status-{status}"></div>','<div class="status-desc">',"{desc}","</div>",'<div class="show-all-status">',`<a class="link-font show-all-link" style="cursor:pointer">${_T("common","show_all")}</a>`,"</div>",'<div class="close-icon"></div>',"</div>")},onClose:function(){this.hide(),this.fireEvent("hidebar")},setStatus:function(e,t){if(!e||!t)return;const i=_T("directory_service",`staus_bar_domain_${e}`);if(0===i.length)return;const s={status:e,desc:new Ext.XTemplate(i).apply({domain:t})};this.update(s)},showAllStatus(){this.findAppWindow().openModalWindow(SYNO.SDS.AdminCenter.DirectoryService.DomainDbStatusDialog,{})}}),Ext.reg("syno_dcip_superboxselect",SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.DCIP),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.DomainInfoStep",{extend:"SYNO.ux.FormPanel",LABEL_WIDTH:222,FIELDSET_WIDTH:300,ouCandidateData:[],constructor:function(e){var t=Ext.apply({headline:_T("directory_service","domain_info_title"),labelWidth:this.LABEL_WIDTH,fieldWidth:this.FIELDSET_WIDTH,cls:"syno-directory-wizard-body-auto-height",items:this.initComponents()},e);this.callParent([t])},initComponents:function(){var e=new SYNO.SDS.AdminCenter.DirectoryService.Domain.CheckItemsMenu({name:"register_nics",fieldLabel:_T("domain","dns_register_nic"),width:this.FIELDSET_WIDTH-10,allowBlank:!1,editable:!1,parentForm:this,owner:this});return[{xtype:"syno_displayfield",fieldLabel:_T("network","wnds_domain"),style:"text-transform: uppercase;",name:"server_address"},{xtype:"syno_displayfield",fieldLabel:_T("directory_service","dns_server"),name:"dns"},{xtype:"syno_combobox",name:"manage_mode",fieldLabel:_T("directory_service","domain_manage_mode"),mode:"local",forceSelection:!0,editable:!1,displayField:"display",valueField:"value",value:0,tpl:'<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item">{display}</div></tpl>',store:new Ext.data.JsonStore({fields:["display","value"],data:[{display:_T("directory_service","trust_domain_mode"),value:0},{display:_T("directory_service","domain_ou_mode"),value:1}]})},{xtype:"syno_textfield",name:"username",maxLength:64,labelHtmlEncode:!1,fieldLabel:`${_T("directory_service","domain_account")} <font class="red-status">${_T("common","star")}</font>`,value:"administrator",allowBlank:!1},{xtype:"syno_textfield",textType:"password",name:"password",maxLength:127,fieldLabel:_T("directory_service","join_password"),allowBlank:!0},{xtype:"syno_dcip_superboxselect",name:"dc_ips",width:this.FIELDSET_WIDTH},e,{xtype:"syno_checkbox",name:"enable_ou_select",value:!1,boxLabel:_T("directory_service","specify_ou")},{xtype:"syno_displayfield",htmlEncode:!1,value:`<font class="red-status">${_T("common","star")}</font> ${_T("firewall","firewall_field_blank_alert")}`}]},sendOuWebapi:function(){this.ouCandidateData=[],this.dns=this.getForm().findField("dns").getValue(),this.domain_name=this.getForm().findField("server_address").getValue(),this.owner.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Directory.Domain",version:1,method:"list_candidate_ou",params:{server:this.dns,username:this.getForm().findField("username").getValue(),password:this.getForm().findField("password").getValue(),fqdn_name:this.domain_name},encryption:["password"],scope:this,callback:function(e,t,i){this.owner.clearStatusBusy(),e?(Ext.each(t.ou_list,(function(e,t){var i=e;""===e&&(i=_T("common","default"));var s=[i,e];this.ouCandidateData.push(s)}),this),this.owner.goNext(this.nextId)):this.errorHandling(t)}})},errorHandling:function(e){var t=SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrorData(e),i=_T("common","commfail");return SYNO.API.Errors.core[t.code]&&(i=SYNO.API.Errors.core[t.code]),this.owner.getMsgBox().alert(_T("network","wnds_domain"),i),!0},activate:function(){var e=this.owner.serverSettingStep.getForm().getValues();this.getForm().setValues(e)},getNext:function(){return!!this.getForm().isValid()&&(this.enable_ou_select=this.getForm().findField("enable_ou_select").getValue(),this.enable_ou_select?this.sendOuWebapi():(this.owner.domainOUStep.getForm().findField("ou_specified").setValue(""),this.owner.goNext("domain_check_join")),!1)},getBack:function(){this.owner.setTitle(_T("directory_service","wizard_title")),this.owner.goBack("server_type")}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.DomainOUStep",{extend:"SYNO.ux.FormPanel",LABEL_WIDTH:182,FIELDSET_WIDTH:300,initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("ou_specified").getEl(),_T("domain","ou_candidate_tip"))}),this,{single:!0}),this.ou_condidate_store.on("load",(function(){this.getForm().findField("ou_specified").setValue("")}),this)},constructor:function(e){this.ou_condidate_store=new Ext.data.ArrayStore({fields:["display","value"],data:[]});var t=Ext.apply({headline:_T("directory_service","domain_ou_title"),items:[{xtype:"syno_combobox",name:"ou_specified",fieldLabel:_T("domain","specified_ou"),labelWidth:this.LABEL_WIDTH,width:this.FIELDSET_WIDTH,allowBlank:!1,forceSelection:!0,mode:"local",displayField:"display",valueField:"value",resizable:!0,editable:!0,tpl:'<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item">{display}</div></tpl>',store:this.ou_condidate_store}]},e);this.callParent([t])},activate:function(){var e=this.owner.domainInfoStep.ouCandidateData;this.ou_condidate_store.loadData(e,!1)}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService.Util"),SYNO.SDS.AdminCenter.DirectoryService.Util.MultiIPValidator=function(e){if(!Ext.isString(e))return _JSLIBSTR("vtype","bad_ip");if(0===e.length)return!0;const t=e.split(/,+/);for(const e of t)if(!Ext.form.VTypes.ip(e))return _JSLIBSTR("vtype","bad_ip");return!0},SYNO.SDS.AdminCenter.DirectoryService.Util.DCIPValidator=function(e){return Ext.isString(e)?0===e.length||(!(!Ext.form.VTypes.ip(e)&&!Ext.form.VTypes.FQDN2(e))||_JSLIBSTR("vtype","bad_ip")):_JSLIBSTR("vtype","bad_ip")},SYNO.SDS.AdminCenter.DirectoryService.Util.DirectoryServiceDataGetCB=function(e,t,i){let s,n=_T("common","commfail");if(!0===t.isTimeout)return n=_T("network","domain_join_err"),{error:n};if(!0===t.has_fail&&!Ext.isEmpty(SYNO.API.GetKnownAPI("SYNO.Core.Directory.Domain"))&&!SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","get_domain_list","code"))return s=SYNO.API.Response.GetFirstError(t),SYNO.API.Errors.core[s.code]&&(n=SYNO.API.Errors.core[s.code]),{error:n};let o={};return o.enable_domain=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","get","enable_domain"),o.domain_list=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","get_domain_list","domain_list"),o.enable_ldap=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.LDAP","get","enable_client"),o},SYNO.SDS.AdminCenter.DirectoryService.Util.GetFeasibilityMsgList=function(e){let t="";return Ext.each(e,(function(e){t+=String.format("<li>{0}</li>",SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))})),String.format("<ul>{0}</ul>",t)},Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Util.ArrayReader",{extend:"Ext.data.JsonReader",constructor:function(e){this.createArrayElement=e.createArrayElement||null,this.callParent([e])},extractData:function(e,t){let i=[];return e.forEach((function(e,t,s){Ext.isFunction(this.createArrayElement)?i.push(this.createArrayElement(e)):i.push({item:e})}),this),SYNO.SDS.AdminCenter.DirectoryService.Util.ArrayReader.superclass.extractData.call(this,i,t)}}),SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg=function(e){return SYNO.API.Errors.core[e]||_T("common","error_system")},Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Util.HomeDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.panel=this.createFormPanel(e);const t=Ext.apply({title:_T("user","user_home_set"),width:620,autoHeight:!0,closeAction:"cancelHandler",resizable:!1,layout:"fit",items:this.panel,buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.cancelHandler},{btnStyle:"blue",text:_T("common","apply"),scope:this,handler:this.applyHandler}]},e);this.callParent([t]),this.mon(this,"afterlayout",this.loadForm,this,{single:!0})},loadForm:function(){this.findWindow().setStatusBusy(),this.panel.loadForm()},createFormPanel:function(e){this.userHomeFieldSet=new SYNO.SDS.AdminCenter.User.HomeFieldSet({authType:e.authType});const t={border:!1,trackResetOnLoad:!0,userHomeFieldSet:this.userHomeFieldSet,items:[this.userHomeFieldSet],processParams:function(e,t){return t=t.concat(this.userHomeFieldSet.processParams(e,t))},processReturnData:function(e,t,i){if(this.findWindow().clearStatusBusy(),t.has_fail){const e=this.checkError(t);if(e.hasError)return void this.findWindow().getMsgBox().alert(null,e.errMsg)}this.userHomeFieldSet.processReturnData(e,t,i)},onApiSuccess:function(e,t,i){t.has_fail=this.checkError(t).hasError,"set"!==e||t.has_fail?this.processReturnData(e,t,i):this.findWindow().close()},checkError:function(e){let t=!1,i=[];Ext.each(e.result,(function(e){if(!e.success){if("SYNO.S2S.Server.Pair"===e.api&&(703===e.error.code||707===e.error.code))return!0;if("SYNO.Core.User.Home"===e.api&&"get"===e.method&&3113===e.error.code)return!0;e.error&&e.error.code&&i.push(e.error.code),t=!0}}));const s=SYNO.API.Errors.core[i[0]]||_JSLIBSTR("uicommon","error_system");return{hasError:t,errMsg:s}}};return new SYNO.SDS.Utils.FormPanel(t)},applyHandler:function(){this.panel.getForm().isDirty()?this.userHomeFieldSet.applyHandler():this.close()},cancelHandler:function(){this.panel.getForm().isDirty()?this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this):this.close()}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Util.HomeButton",{extend:"SYNO.ux.Button",constructor:function(e){var t="yes"===_D("support_hyper_converged","no")&&!_S("sofs_is_controller");const i=Ext.apply({text:_T("user","user_home_set"),scope:this,hidden:!_S("is_admin")||t,handler:this.launchHomeDialog},e);this.callParent([i])},launchHomeDialog:function(){new SYNO.SDS.AdminCenter.DirectoryService.Util.HomeDialog({owner:this.appWin,module:this.module,authType:this.authType}).open()}}),SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrorData=function(e){return Ext.isBoolean(e.has_fail)?SYNO.API.Response.GetFirstError(e):e.error?e.error:e},Ext.define("SYNO.SDS.AdminCenter.DirectoryService.LDAP.ProfileDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({root:"rules",fields:["category","attribute","target"]}),groupField:"category"}),this.store.loadData(e.data),this.panel=this.createPanel(this.store);var t=Ext.apply({title:_T("ldap","profile_title"),autoDestroy:!0,width:480,height:500,minWidth:480,minHeight:500,layout:"fit",items:[this.panel],closeAction:"onCancel",buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.onCancel},{btnStyle:"blue",text:_T("common","save"),scope:this,handler:this.onApply}]},e);this.callParent([t])},createPanel:function(e){var t=[{header:_T("ldap","profile_origin"),dataIndex:"attribute",sortable:!1},{header:_T("ldap","profile_target"),dataIndex:"target",sortable:!1,id:"target",editor:new SYNO.ux.TextField({}),renderer:"htmlEncode"},{header:_T("ldap","profile_map"),dataIndex:"category",sortable:!1,hidden:!0}];return new SYNO.ux.EditorGridPanel({clicksToEdit:1,autoExpandColumn:"target",enableHdMenu:!1,enableColumnMove:!1,store:e,columns:t,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),listeners:{viewready:function(e){e.getView().updateScroller()}},view:new SYNO.ux.GroupingView({forceFit:!0,showGroupName:!1,enableGroupingMenu:!1})})},hasModification:function(){return 0!==this.store.getModifiedRecords().length},onCancel:function(){if(!this.hasModification())return this.close(),!0;this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this)},onApply:function(){if(!this.hasModification())return this.close(),!0;this.setStatusBusy();var e=[];this.store.each((function(t){e.push(t.data)}),this),this.sendWebAPI({api:"SYNO.Core.Directory.LDAP.Profile",method:"set",version:2,params:{profile_rules:e},callback:this.afterApplyDone,scope:this})},afterApplyDone:function(e,t,i){if(this.clearStatusBusy(),e)return this.applyCallback&&this.applyCallback.call(this.applyTarget||this,this.hasModification()),this.close(),!0;this.getMsgBox().alert(this.title,_T("error","save"))}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.LDAPInfoStep",{extend:"SYNO.ux.FormPanel",LABEL_WIDTH:314,FIELDSET_WIDTH:172,initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("enable_idmap").getEl(),_T("ldap","idmap_support_tips")),this.enableGroup=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_client_certificate",[this.btnUploadCertificate]),SYNO.ux.AddTip(this.getForm().findField("enable_client_certificate").getEl(),_T("ldap","ldap_client_certificate_tips")),SYNO.ux.AddWhiteTipWithItem(Ext.getCmp(this.getForm().findField("tls_reqcert").getEl().id),{xtype:"syno_displayfield",htmlEncode:!1,value:_T("ldap","tls_reqcert_tips")})}),this,{single:!0})},constructor:function(e){this.module=e.module;var t=Ext.apply({headline:_T("directory_service","ldap_info_title"),labelWidth:this.LABEL_WIDTH,fieldWidth:this.FIELDSET_WIDTH,items:this.initComponents()},e);this.callParent([t]),this.componentStateHint={binddn:"",basedn:"",encryption:"no"},this.handleComponentState()},handleComponentState:function(){if(-1!==this.componentStateHint.basedn.search(",dc=c2,dc=")&&-1!==this.componentStateHint.binddn.search(",cn=nasAccount,cn=Syno,dc="))return this.componentStateHint.encryption="no",this.getForm().findField("encryption").setValue("no"),this.getForm().findField("encryption").disable(),this.getForm().findField("tls_reqcert").setValue(!1),void this.getForm().findField("tls_reqcert").disable();this.getForm().findField("encryption").enable(),this.getForm().findField("tls_reqcert").enable(),"no"===this.componentStateHint.encryption&&(this.getForm().findField("tls_reqcert").setValue(!1),this.getForm().findField("tls_reqcert").disable())},initComponents:function(){return[{xtype:"syno_textfield",name:"bind_dn",fieldLabel:_T("ldap","bind_account")+' <font class="red-status">'+_T("common","star")+"</font>",labelHtmlEncode:!1,listeners:{change:function(e,t,i){this.componentStateHint.binddn=t,this.handleComponentState()},scope:this},allowBlank:!1},{xtype:"syno_textfield",textType:"password",name:"bind_pw",fieldLabel:_T("user","user_passwd")+' <font class="red-status">'+_T("common","star")+"</font>",labelHtmlEncode:!1,allowBlank:!1},{xtype:"syno_combobox",name:"encryption",fieldLabel:_T("ldap","security_type"),forceSelection:!0,editable:!1,displayField:"display",valueField:"value",value:"no",store:new Ext.data.JsonStore({fields:["display","value"],data:[{display:_T("ldap","no_ssl"),value:"no"},{display:_T("ldap","with_ssl"),value:"ssl"},{display:_T("ldap","with_tls"),value:"start_tls"}]}),listeners:{change:function(e,t){this.componentStateHint.encryption=t,this.handleComponentState()},scope:this}},{xtype:"syno_combobox",name:"base_dn",fieldLabel:_T("ldap","base_dn")+' <font class="red-status">'+_T("common","star")+"</font>",labelHtmlEncode:!1,allowBlank:!1,editable:!0,forceSelection:!1,selectOnFocus:!1,displayField:"item",valueField:"item",listeners:{change:function(e,t,i){this.componentStateHint.basedn=t,this.handleComponentState()},scope:this},mode:"remote",store:new SYNO.API.Store({autoDestroy:!0,appWindow:this.findAppWindow(),api:"SYNO.Core.Directory.LDAP.BaseDN",method:"list",version:2,reader:new SYNO.SDS.AdminCenter.DirectoryService.Util.ArrayReader({root:"base_dn",fields:["item"]}),listeners:{exception:this.onLoadBaseDNException,beforeload:this.onBeforeLoadBaseDN,load:this.onLoadBaseDN,scope:this}}),validator:function(e){return e.trim()===e}},{xtype:"syno_compositefield",fieldLabel:_T("ldap","profile_title"),items:[{xtype:"syno_combobox",name:"profile",width:this.FIELDSET_WIDTH,mode:"remote",allowBlank:!1,editable:!1,value:"standard",valueNotFoundText:_T("ldap","profile_standard"),valueField:"value",displayField:"display",store:new SYNO.API.Store({autoDestroy:!0,appWindow:this.findAppWindow(),api:"SYNO.Core.Directory.LDAP.Profile",method:"list",version:1,reader:new SYNO.SDS.AdminCenter.DirectoryService.Util.ArrayReader({root:"profiles",fields:["value","display"],createArrayElement:function(e){return{value:e,display:_T("ldap","profile_"+e)||e}}},this)}),listeners:{select:{fn:function(){Ext.getCmp(this.btnProfileAdvance).enable()},single:!0},scope:this}},{xtype:"syno_button",synotype:"indent_no_label",id:this.btnProfileAdvance=Ext.id(),width:"auto",text:_T("ldap","profile_advance"),disabled:!0,scope:this,handler:this.onProfileBtnClick}]},{xtype:"syno_numberfield",name:"update_min",maxlength:5,value:1440,minValue:1,fieldLabel:_T("directory_service","domain_update_period")+" ("+_T("common","time_minutes")+")"},{xtype:"syno_checkbox",name:"enable_idmap",boxLabel:_T("ldap","idmap_support"),value:!1},{xtype:"syno_checkbox",id:Ext.id(),name:"tls_reqcert",boxLabel:_T("ldap","validate_server_certificate"),checked:!1,disabled:!0},{xtype:"syno_checkbox",boxLabel:_T("ldap","ldap_enable_client_certificate"),listeners:{scope:this,check:function(e,t,i){t&&this.findWindow().getMsgBox().alert(this.title,_T("ldap","ldap_client_certificate_note"))}},name:"enable_client_certificate"},{xtype:"syno_button",indent:1,id:this.btnUploadCertificate=Ext.id(),text:_T("ldap","ldap_upload_client_certificate"),scope:this,handler:this.uploadCertificateDialog},{xtype:"syno_displayfield",htmlEncode:!1,value:'<font class="red-status">'+_T("common","star")+"</font> "+_T("firewall","firewall_field_blank_alert")}]},uploadCertificateDialog:function(){new SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util.UploadCADialog({module:this.module,owner:this.module.appWin}).open()},onBeforeLoadBaseDN:function(e,t){t.params.server_address=this.owner.serverSettingStep.getForm().findField("ldap_server_ip").getValue(),t.params.encryption=this.getForm().findField("encryption").getValue(),t.params.bind_dn=this.getForm().findField("bind_dn").getValue(),t.params.bind_pw=this.getForm().findField("bind_pw").getValue(),t.encryption=["bind_dn","bind_pw"],this.owner.setStatusBusy()},onLoadBaseDNException:function(e,t,i,s,n,o){var a=this.getForm().findField("base_dn");void 0===n.code?this.owner.getMsgBox().alert(_T("ldap","base_dn"),_T("ldap_error","ldap_operations_error")):2714===n.code?this.owner.getMsgBox().alert(_T("ldap","base_dn"),_T("ldap","manual_base_dn")):this.owner.getMsgBox().alert(_T("ldap","base_dn"),SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(n.code)),delete a.lastQuery,a.setValue(""),this.componentStateHint.basedn="",this.handleComponentState(),this.owner.clearStatusBusy()},onLoadBaseDN:function(){var e=this.getForm().findField("base_dn");this.owner.clearStatusBusy(),delete e.lastQuery,0===e.getStore().data.length&&""===e.getValue()&&this.owner.getMsgBox().alert(_T("ldap","base_dn"),_T("ldap","manual_base_dn"))},onProfileBtnClick:function(){this.sendWebAPI({api:"SYNO.Core.Directory.LDAP.Profile",method:"get",version:1,params:{name:this.getForm().findField("profile").getValue()},callback:this.afterLoadProfile,scope:this})},afterLoadProfile:function(e,t,i){e?new SYNO.SDS.AdminCenter.DirectoryService.LDAP.ProfileDialog({owner:this.owner,resizable:!1,closable:!0,data:t,applyCallback:this.resetProfile,applyTarget:this}).open():this.owner.getMsgBox().alert(this.title,SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(t.code))},resetProfile:function(e){var t=this.getForm();e&&t.setValues({profile:"customized"})},getNext:function(){return this.handleComponentState(),!!this.getForm().isValid()&&this.nextId},getBack:function(){this.handleComponentState(),this.owner.setTitle(_T("directory_service","wizard_title")),this.owner.goBack("server_type")}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.Utils"),SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.Utils={getIssueTitle:function(e,t=!1){const i=this.issueContent[e]||{};return(i[t?1:0]||i[0]||{}).title||_T("directory_service","issue_title_unknown_and_retry")},getComponent:function(e){let t=[];return e.forEach((e=>{t.push(this.components[e])})),t},getIssueContent:function(e,t=!1){let i={details:"",recAction:{}};const s=this.issueContent[e]||{},n=s[t?1:0]||s[0]||{};return i.details=n.details||_T("directory_service","details_unknown_and_retry"),i.recAction.items=this.getComponent(n.component||[]),i.recAction.description=n.action||_T("directory_service","action_unknown_and_retry"),i}},SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.Utils.issueContent={1e3:[{title:_T("directory_service","issue_title_dns_resolve_fail"),details:_T("directory_service","details_dns_resolve_fail"),action:_T("directory_service","action_dns_resolve_fail"),component:["server_address","dns"]}],1003:[{title:_T("directory_service","issue_title_dns_no_ip_record"),details:_T("directory_service","details_dns_no_ip_record"),action:_T("directory_service","action_dns_no_ip_record"),component:["server_address","dns"]}],1004:[{title:_T("directory_service","issue_title_no_ns_record"),details:_T("directory_service","details_no_ns_record"),action:_T("directory_service","action_dns_resolve_fail"),component:["server_address","dns"]}],1005:[{title:_T("directory_service","issue_title_no_srv_record"),details:_T("directory_service","details_no_srv_record"),action:_T("directory_service","action_no_srv_record"),component:[]}],1006:[{title:_T("directory_service","issue_title_absent_srv_record"),details:_T("directory_service","details_absent_srv_record"),action:_T("directory_service","action_absent_srv_record"),component:[]}],1007:[{title:_T("directory_service","issue_title_srv_no_address_record"),details:_T("directory_service","details_srv_no_address_record"),action:_T("directory_service","action_srv_no_address_record"),component:[]}],1008:[{title:_T("directory_service","issue_title_dns_resolve_fail"),details:_T("directory_service","details_can_not_find_any_dc"),action:_T("directory_service","action_dns_resolve_fail"),component:["dns"]}],1009:[{title:_T("directory_service","issue_title_resolve_fqdn_fail"),details:_T("directory_service","details_resolve_fqdn_fail"),action:_T("directory_service","action_resolve_fqdn_fail"),component:["dc_ips"]},{title:_T("directory_service","issue_title_resolve_fqdns_fail"),details:_T("directory_service","details_resolve_fqdns_fail"),action:_T("directory_service","action_resolve_fqdns_fail"),component:["dc_ips"]}],1010:[{title:_T("directory_service","issue_title_single_port_invalid"),details:_T("directory_service","details_single_port_invalid"),action:_T("directory_service","action_single_port_invalid"),component:["dc_ips"]}],1011:[{title:_T("directory_service","issue_title_single_port_invalid"),details:_T("directory_service","details_single_port_invalid"),action:_T("directory_service","action_single_port_invalid"),component:["dc_ips"]},{title:_T("directory_service","issue_title_multiple_ports_invalid"),details:_T("directory_service","details_multiple_ports_invalid"),action:_T("directory_service","action_multiple_ports_invalid"),component:["dc_ips"]}],1012:[{title:_T("directory_service","issue_title_single_port_invalid"),details:_T("directory_service","details_single_port_invalid"),action:_T("directory_service","action_single_port_invalid"),component:["dc_ips"]}],1013:[{title:_T("directory_service","issue_title_single_port_invalid"),details:_T("directory_service","details_single_port_invalid"),action:_T("directory_service","action_single_port_invalid"),component:["dc_ips"]}],1014:[{title:_T("directory_service","issue_title_single_port_invalid"),details:_T("directory_service","details_single_port_invalid"),action:_T("directory_service","action_single_port_invalid"),component:["dc_ips"]}],1015:[{title:_T("directory_service","issue_title_single_port_invalid"),details:_T("directory_service","details_single_port_invalid"),action:_T("directory_service","action_single_port_invalid"),component:["dc_ips"]}],1016:[{title:_T("directory_service","issue_title_single_port_invalid"),details:_T("directory_service","details_single_port_invalid"),action:_T("directory_service","action_ldap_server_port_invalid"),component:[]}],1020:[{title:_T("directory_service","issue_title_inconsistent_mtu_value"),details:_T("directory_service","details_inconsistent_mtu_value"),action:_T("directory_service","action_inconsistent_mtu_value"),component:[]}],1021:[{title:_T("directory_service","issue_title_nas_ip_conflict"),details:_T("directory_service","details_nas_ip_conflict"),action:_T("directory_service","action_nas_ip_conflict"),component:[]}],1022:[{title:_T("directory_service","issue_title_domain_ip_conflict"),details:_T("directory_service","details_domain_ip_conflict"),action:_T("directory_service","action_domain_ip_conflict"),component:[]}],1023:[{title:_T("directory_service","issue_title_nas_hostname_conflict"),details:_T("directory_service","details_nas_hostname_conflict"),action:_T("directory_service","action_nas_hostname_conflict"),component:[]}],1024:[{title:_T("directory_service","issue_title_workgroup_conflict"),details:_T("directory_service","details_workgroup_conflict"),action:_T("directory_service","action_workgroup_conflict"),component:[]}],1030:[{title:_T("directory_service","issue_title_bad_auth_info"),details:_T("directory_service","details_bad_auth_info"),action:_T("directory_service","action_bad_auth_info"),component:["bind_dn","pwd"]}],1031:[{title:_T("directory_service","issue_title_domain_bad_auth_info"),details:_T("directory_service","details_domain_bad_auth_info"),action:_T("directory_service","action_domain_bad_auth_info"),component:["username","password"]}],1032:[{title:_T("directory_service","issue_title_account_lockout"),details:_T("directory_service","details_account_lockout"),action:_T("directory_service","action_account_lockout"),component:["username","password"]}],1033:[{title:_T("directory_service","issue_title_password_expired"),details:_T("directory_service","details_password_expired"),action:_T("directory_service","action_password_expired"),component:["username","password"]}],1034:[{title:_T("directory_service","issue_title_ntlm_service_disable"),details:_T("directory_service","details_ntlm_service_disable"),action:_T("directory_service","action_ntlm_service_disable"),component:[]}],1035:[{title:_T("directory_service","issue_title_ntlm_account_restriction"),details:_T("directory_service","details_ntlm_account_restriction"),action:_T("directory_service","action_ntlm_account_restriction"),component:[]}],1036:[{title:_T("directory_service","issue_title_kerberos_too_much_diff_time"),details:_T("directory_service","details_kerberos_too_much_diff_time"),action:_T("directory_service","action_kerberos_too_much_diff_time"),component:[]}],1037:[{title:_T("directory_service","issue_title_machine_logon_fail"),details:_T("directory_service","details_machine_logon_fail"),action:_T("directory_service","action_machine_logon_fail"),component:["dc_ips"]}],1038:[{title:_T("directory_service","issue_title_bad_auth_info"),details:_T("directory_service","details_bad_auth_info"),action:_T("ldap","err_connect_fail_with_tls_reqcert_enabled"),component:[]}],1040:[{title:_T("directory_service","issue_title_bad_user_profile"),details:_T("directory_service","details_bad_profile"),action:_T("directory_service","action_bad_profile"),component:["base_dn","profile_user_filter","profile_user_uid","profile_user_uid_number"]}],1041:[{title:_T("directory_service","issue_title_bad_group_profile"),details:_T("directory_service","details_bad_profile"),action:_T("directory_service","action_bad_profile"),component:["base_dn","profile_group_filter","profile_group_cn","profile_group_gid_number"]}],1042:[{title:_T("directory_service","issue_title_ldap_user_name_invalid"),details:_T("directory_service","details_ldap_user_name_empty"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1043:[{title:_T("directory_service","issue_title_ldap_user_name_duplicated"),details:_T("directory_service","details_ldap_user_name_duplicated"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1044:[{title:_T("directory_service","issue_title_ldap_user_id_invalid"),details:_T("directory_service","details_ldap_user_id_empty"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1045:[{title:_T("directory_service","issue_title_ldap_user_id_invalid"),details:_T("directory_service","details_ldap_user_id_bad_type"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1046:[{title:_T("directory_service","issue_title_ldap_user_id_duplicated"),details:_T("directory_service","details_ldap_user_id_duplicated"),action:_T("directory_service","action_ldap_user_duplicated_id_number")+"<br>"+_T("directory_service","action_enable_setting"),component:["enable_idmap"]},{title:_T("directory_service","issue_title_ldap_user_id_duplicated"),details:_T("directory_service","details_ldap_user_id_duplicated"),action:_T("directory_service","action_ldap_user_duplicated_id_numbers")+"<br>"+_T("directory_service","action_enable_setting"),component:["enable_idmap"]}],1047:[{title:_T("directory_service","issue_title_ldap_group_name_invalid"),details:_T("directory_service","details_ldap_group_name_empty"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1048:[{title:_T("directory_service","issue_title_ldap_group_name_duplicated"),details:_T("directory_service","details_ldap_group_name_duplicated"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1049:[{title:_T("directory_service","issue_title_ldap_group_id_invalid"),details:_T("directory_service","details_ldap_group_id_empty"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1050:[{title:_T("directory_service","issue_title_ldap_group_id_invalid"),details:_T("directory_service","details_ldap_group_id_bad_type"),action:_T("directory_service","action_ldap_bad_data"),component:[]}],1051:[{title:_T("directory_service","issue_title_ldap_group_id_duplicated"),details:_T("directory_service","details_ldap_group_id_duplicated"),action:_T("directory_service","action_ldap_group_duplicated_id_number")+"<br>"+_T("directory_service","action_enable_setting"),component:["enable_idmap"]},{title:_T("directory_service","issue_title_ldap_group_id_duplicated"),details:_T("directory_service","details_ldap_group_id_duplicated"),action:_T("directory_service","action_ldap_group_duplicated_id_numbers")+"<br>"+_T("directory_service","action_enable_setting"),component:["enable_idmap"]}],1052:[{title:_T("directory_service","issue_title_no_samba_schema"),details:_T("directory_service","details_ldap_dont_support_samba_schema"),action:_T("directory_service","action_enable_setting"),component:["enable_cifs_pam","enable_cifs_pam_note"]}],1053:[{title:_T("directory_service","issue_title_no_ntpassword"),details:_T("directory_service","details_ldap_user_lost_ntpassword"),action:_T("directory_service","action_add_ntpassword_or_enable_cifs_pam"),component:["enable_cifs_pam","enable_cifs_pam_note"]}],1054:[{title:_T("directory_service","issue_title_ldap_need_tls"),details:_T("directory_service","details_ldap_need_tls"),action:_T("directory_service","action_ldap_need_tls"),component:["encryption"]}],1071:[{title:_T("directory_service","issue_title_domain_machine_name_conflict"),details:_T("directory_service","details_domain_machine_name_conflict"),action:_T("directory_service","action_domain_machine_name_conflict"),component:[]}],1074:[{title:_T("directory_service","issue_title_duplicate_spn"),details:_T("directory_service","details_duplicate_spn"),action:_T("directory_service","action_duplicate_spn"),component:[]}],1075:[{title:_T("directory_service","issue_title_check_spn_fail"),details:_T("directory_service","details_check_spn_fail"),action:_T("directory_service","action_check_spn_fail"),component:[]}],1076:[{title:_T("directory_service","issue_title_check_account_flags_fail"),details:_T("directory_service","details_check_account_flags_fail"),action:_T("directory_service","action_check_account_flags_fail"),component:[]}],1077:[{title:_T("directory_service","issue_title_check_gpo_fail"),details:_T("directory_service","details_check_gpo_fail"),action:_T("directory_service","action_check_gpo_fail"),component:[]},{title:_T("directory_service","issue_title_check_gpo_fail"),details:_T("directory_service","details_check_gpo_fail"),action:_T("directory_service","action_check_gpo_fail"),component:[]}],1078:[{title:_T("directory_service","issue_title_machine_max_limit"),details:_T("directory_service","details_machine_max_limit"),action:_T("directory_service","action_machine_max_limit"),component:[]}],1079:[{title:_T("directory_service","issue_title_server_disconnected"),details:_T("directory_service","details_server_disconnected"),action:_T("directory_service","action_check_remote_smb_status"),component:["dc_ips"]},{title:_T("directory_service","issue_title_server_disconnected"),details:_T("directory_service","details_server_disconnected"),action:_T("directory_service","action_check_remote_smb_statuses"),component:["dc_ips"]}],1080:[{title:_T("directory_service","issue_title_machine_account_conflict"),details:_T("directory_service","details_machine_account_conflict"),action:_T("directory_service","action_machine_account_conflict"),component:[]}],1081:[{title:_T("directory_service","issue_title_machine_password_not_sync"),details:_T("directory_service","details_machine_password_not_sync"),action:_T("directory_service","action_machine_password_not_sync"),component:[]},{title:_T("directory_service","issue_title_plural_machine_password_not_sync"),details:_T("directory_service","details_plural_machine_password_not_sync"),action:_T("directory_service","action_plural_machine_password_not_sync"),component:[]}],1082:[{title:_T("directory_service","issue_title_domain_time_not_sync"),details:_T("directory_service","details_domain_time_not_sync"),action:_T("directory_service","action_domain_time_not_sync"),component:[]}],1083:[{title:_T("directory_service","issue_title_domain_bad_auth_info"),details:_T("directory_service","details_domain_bad_auth_info"),action:_T("directory_service","action_domain_bad_auth_info"),component:["username","password"]}],1085:[{title:_T("directory_service","issue_title_check_winbind_fail"),details:_T("directory_service","details_check_winbind_fail"),action:_T("directory_service","action_check_winbind_fail"),component:[]}],1086:[{title:_T("directory_service","issue_title_check_winbind_fail"),details:_T("directory_service","details_check_winbind_fail"),action:_T("directory_service","action_check_winbind_fail"),component:[]}],1087:[{title:_T("directory_service","issue_title_check_winbind_fail"),details:_T("directory_service","details_check_winbind_fail"),action:_T("directory_service","action_check_winbind_fail"),component:[]}],1088:[{title:_T("directory_service","issue_title_check_winbind_fail"),details:_T("directory_service","details_check_winbind_fail"),action:_T("directory_service","action_check_winbind_fail"),component:[]}],1089:[{title:_T("directory_service","issue_title_get_machine_account_fail"),details:_T("directory_service","details_get_machine_account_fail"),action:_T("directory_service","action_get_machine_account_fail"),component:[]}],1090:[{title:_T("directory_service","issue_title_smb_conf_bad_value"),details:_T("directory_service","details_smb_conf_bad_value"),action:_T("directory_service","action_smb_conf_bad_value"),component:[]},{title:_T("directory_service","issue_title_smb_conf_bad_value"),details:_T("directory_service","details_smb_conf_bad_values"),action:_T("directory_service","action_smb_conf_bad_values"),component:[]}],1091:[{title:_T("directory_service","issue_title_check_winbind_domainfiles_fail"),details:_T("directory_service","details_check_winbind_domainfiles_fail"),action:_T("directory_service","action_check_winbind_domainfiles_fail"),component:["enable_remove_winbind_files"]}],1120:[{title:_T("directory_service","issue_title_dc_no_response"),details:_T("directory_service","details_dc_no_response"),action:_T("directory_service","action_dc_no_response"),component:["dc_ips"]},{title:_T("directory_service","issue_title_plural_dc_no_response"),details:_T("directory_service","details_plural_dc_no_response"),action:_T("directory_service","action_plural_dc_no_response"),component:["dc_ips"]}],1121:[{title:_T("directory_service","issue_title_can_not_find_any_dc"),details:_T("directory_service","details_can_not_find_any_dc"),action:_T("directory_service","action_can_not_find_any_dc"),component:[]}],1122:[{title:_T("directory_service","issue_title_dc_is_rodc"),details:_T("directory_service","details_dc_is_rodc"),action:_T("directory_service","action_dc_is_rodc"),component:["rwdc_fqdn_name"]}],1123:[{title:_T("directory_service","issue_title_insufficient_authorization"),details:_T("directory_service","details_insufficient_authorization"),action:_T("directory_service","action_insufficient_authorization"),component:["username","password"]}],1124:[{title:_T("network","domain_join_err"),details:_T("network","domain_join_err"),action:_T("network","domain_join_err"),component:[]}],1127:[{title:_T("directory_service","issue_title_kdc_unreach"),details:_T("directory_service","detail_kdc_unreach"),action:_T("directory_service","action_kdc_unreach"),component:[]}],1128:[{title:_T("directory_service","issue_title_smb_unsuccessful"),details:_T("directory_service","details_smb_unsuccessful"),action:_T("directory_service","action_smb_unsuccessful"),component:[]}],1130:[{title:_T("directory_service","issue_title_duplicate_spn"),details:_T("directory_service","details_duplicate_spn"),action:_T("directory_service","action_duplicate_spn_hostfqdn"),component:[]}],1134:[{title:_T("directory_service","issue_title_check_tls_fail"),details:_T("directory_service","details_check_tls_fail"),action:_T("directory_service","action_check_tls_fail"),component:[]}],1301:[{title:_T("directory_service","issue_title_ntlm_account_not_exist"),details:_T("directory_service","details_ntlm_account_not_exist"),action:_T("directory_service","action_ntlm_account_not_exist"),component:[]}],1302:[{title:_T("directory_service","issue_title_domain_access_denied"),details:_T("directory_service","details_domain_access_denied_user"),action:_T("directory_service","action_domain_access_denied"),component:[]}],1303:[{title:_T("directory_service","issue_title_domain_access_denied"),details:_T("directory_service","details_domain_access_denied_machine"),action:_T("directory_service","action_domain_access_denied"),component:[]}],1304:[{title:_T("directory_service","issue_title_local_access_denied"),details:_T("directory_service","details_local_access_denied"),action:_T("directory_service","action_local_access_denied"),component:["dc_ips"]}],1306:[{title:_T("directory_service","issue_title_connection_refused"),details:_T("directory_service","details_local_smb_conn_refused"),action:_T("directory_service","action_restart_synoad_pkg"),component:[]}],1307:[{title:_T("directory_service","issue_title_connection_refused"),details:_T("directory_service","details_remote_smb_conn_refused"),action:_T("directory_service","action_check_remote_smb_status"),component:["dc_ips"]},{title:_T("directory_service","issue_title_connection_refused"),details:_T("directory_service","details_remote_smb_conn_refused"),action:_T("directory_service","action_check_remote_smb_statuses"),component:["dc_ips"]}],2e3:[{title:_T("directory_service","issue_title_dns_resolve_fail"),details:_T("directory_service","details_dns_resolve_fail"),action:_T("directory_service","action_dns_resolve_fail"),component:["dns"]}],2001:[{title:_T("directory_service","issue_title_no_ns_record"),details:_T("directory_service","details_no_ns_record"),action:_T("directory_service","action_dns_resolve_fail"),component:["dns"]}],2002:[{title:_T("directory_service","issue_title_can_not_find_any_dc"),details:_T("directory_service","details_can_not_find_any_dc"),action:_T("directory_service","action_dns_resolve_fail"),component:["dns"]}],2100:[{title:_T("directory_service","issue_title_machine_logon_fail"),details:_T("directory_service","details_machine_logon_fail"),action:_T("directory_service","action_ad_machine_logon_fail"),component:[]}],2200:[{title:_T("directory_service","issue_title_suggest_enable_local_smb"),details:_T("directory_service","details_suggest_enable_local_smb"),action:_T("directory_service","action_suggest_enable_local_smb"),component:[]}]},SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.Utils.components={server_address:{xtype:"syno_textfield",name:"server_address",fieldLabel:_T("directory_service","server_address"),maxlength:255,allowBlank:!1,vtype:"iporhostname"},dns:{xtype:"syno_textfield",name:"dns",fieldLabel:_T("directory_service","dns_server"),maxlength:64,allowBlank:!1,emptyText:"IP LIST (EXAMPLE: 192.168.1.1,192.168.1.2)",maskRe:/[,.:0-9A-Fa-f]/,validator:SYNO.SDS.AdminCenter.DirectoryService.Util.MultiIPValidator},username:{xtype:"syno_textfield",name:"username",maxLength:64,fieldLabel:_T("directory_service","domain_account"),allowBlank:!1},password:{xtype:"syno_textfield",textType:"password",name:"password",maxLength:127,fieldLabel:_T("directory_service","join_password"),allowBlank:!0},base_dn:{xtype:"syno_displayfield",fieldLabel:_T("ldap","base_dn"),name:"base_dn"},encryption:{xtype:"syno_combobox",name:"encryption",fieldLabel:_T("ldap","security_type"),forceSelection:!0,editable:!1,displayField:"display",valueField:"value",value:"start_tls",store:new Ext.data.JsonStore({fields:["display","value"],data:[{display:_T("ldap","with_ssl"),value:"ssl"},{display:_T("ldap","with_tls"),value:"start_tls"}]})},bind_dn:{xtype:"syno_textfield",name:"bind_dn",fieldLabel:_T("ldap","bind_account"),allowBlank:!1},pwd:{xtype:"syno_textfield",textType:"password",name:"bind_pw",fieldLabel:_T("user","user_passwd"),allowBlank:!1},profile_user_filter:{xtype:"syno_textfield",name:"profile_user_filter",fieldLabel:"filter",maxlength:255,emptyText:"objectClass=posixAccount"},profile_user_uid:{xtype:"syno_textfield",name:"profile_user_uid",fieldLabel:"uid",maxlength:255,emptyText:"uid"},profile_user_uid_number:{xtype:"syno_textfield",name:"profile_user_uid_number",fieldLabel:"uidNumber",maxlength:255,emptyText:"uidNumber"},profile_group_filter:{xtype:"syno_textfield",name:"profile_group_filter",fieldLabel:"filter",maxlength:255,emptyText:"objectClass=posixGroup"},profile_group_cn:{xtype:"syno_textfield",name:"profile_group_cn",fieldLabel:"cn",maxlength:255,emptyText:"cn"},profile_group_gid_number:{xtype:"syno_textfield",name:"profile_group_gid_number",fieldLabel:"uidNumber",maxlength:255,emptyText:"gidNumber"},enable_idmap:{xtype:"syno_checkbox",name:"enable_idmap",boxLabel:_T("ldap","idmap_support"),value:!1},enable_cifs_pam:{xtype:"syno_checkbox",name:"enable_cifs_pam",boxLabel:_T("ldap","smb_support_pam"),value:!1},enable_cifs_pam_note:{xtype:"syno_displayfield",hideLabel:!0,htmlEncode:!1,value:_T("ldap_error","ldap_smb2_enable_warning")+"<br>"+_T("ldap_error","ldap_cifs_pam_enabled"),name:"enable_cifs_pam_note"},enable_client_cert:{xtype:"syno_checkbox",boxLabel:_T("ldap","ldap_enable_client_certificate"),listeners:{scope:this,check:function(e,t,i){t&&this.findWindow().getMsgBox().alert(this.title,_T("ldap","ldap_client_certificate_note"))}},name:"enable_client_certificate"},upload_client_cert:{xtype:"syno_button",indent:1,text:_T("ldap","ldap_upload_client_certificate"),scope:this,handler:function(){new SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util.UploadCADialog({module:this.module,owner:this.module.appWin}).open()}},rwdc_fqdn_name:{xtype:"syno_textfield",name:"rwdc_fqdn_name",style:"text-transform:uppercase;",fieldLabel:_T("domain","rwdc_ip"),vtype:"ip",maxlength:255},dc_ips:{xtype:"syno_dcip_superboxselect",name:"dc_ips",width:260},enable_remove_winbind_files:{xtype:"syno_checkbox",name:"enable_remove_winbind_files",boxLabel:_T("directory_service","remove_winbind_files"),checked:!1}},Ext.define("SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBarStore",{extend:"Ext.data.JsonStore",constructor:function(e){const t=Ext.apply({autoDestroy:!0,fields:["status","categoryName","desc","issueList"]},e);this.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.FixDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){if(this.Utils=SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.Utils,this.issue=e.issue,this.dialogContent=this.Utils.getIssueContent(this.issue.errCode,this.issue.isPlural),!this.dialogContent)return void this.getMsgBox().alert(this.issue.title,_T("common","error_system"));this.issueInfoEncoding(),this.detailPanel=this.createDetailPanel(),this.suggestionForm=this.createSuggestionForm(),this.innerPanel=new SYNO.ux.Panel({width:580,height:370,layout:{type:"vbox",align:"center"},items:[this.detailPanel,this.suggestionForm]});const t=Ext.apply({width:580,height:480,resizable:!1,shadow:!0,buttonAlign:"left",fbar:new Ext.Toolbar({cls:"x-statusbar",style:{"padding-left":"24px"},items:this.createButtons()}),items:this.innerPanel},e);this.callParent([t]),this.setValueToForm()},issueInfoEncoding:function(){Ext.iterate(this.issue.info,(function(e,t){if(Ext.isArray(t)){let i=[];Ext.each(t,(function(e){i.push(Ext.util.Format.htmlEncode(e))})),this.issue.info[e]=i}else this.issue.info[e]=Ext.util.Format.htmlEncode(t)}),this)},createButtons:function(){const e=0===this.dialogContent.recAction.items.length?_T("directory_service","check_again"):_T("common","commit");return[{xtype:"syno_button",text:_T("directory_service","ignore_issue"),hidden:!this.issue.allowSkipIssue||0===this.issue.level,scope:this,handler:this.afterClickSkip},"->",{xtype:"syno_button",text:_T("common","close"),scope:this,handler:this.close},{xtype:"syno_button",btnStyle:"blue",text:e,hidden:this.issue.unknownError||!1,itemId:"apply",scope:this,handler:this.onSubmit}]},createDetailPanel:function(){const e=[{xtype:"label",name:"detail_title",text:_T("directory_service","details_title"),cls:"detail-panel-titles"},{xtype:"label",name:"detail_desc",cls:"detail-panel-desc",data:this.issue.info||{},tpl:new Ext.Template(this.dialogContent.details)}];return new SYNO.ux.Panel({width:540,cls:"fix-dialog-detail-panel",margins:{top:12,right:0,bottom:18,left:0},padding:"14px 20px 14px 20px",items:e})},createSuggestionForm:function(){const e=this.dialogContent.recAction;let t={};this.issue.info&&this.setupSuggestionTemplate(t);let i=[{xtype:"syno_displayfield",hideLabel:!0,data:t||{},tpl:new Ext.Template(e.description)}];i=i.concat(e.items);const s={title:_T("directory_service","recommended_action_title"),width:540,header:!0,border:!1,labelWidth:182,fieldWidth:260,trackResetOnLoad:!0,flex:1,items:i};return new SYNO.ux.FormPanel(s)},setupSuggestionTemplate:function(e){Ext.iterate(this.issue.info,(function(t,i){Ext.isArray(i)?e[t]=this.transformArrayToHTML(i):e[t]=i}),this)},transformArrayToHTML:function(e){let t="",i="";return e.forEach((function(e){t+="<li>"+e+"</li>"})),i='<div style="padding: 10px;"><ul style="list-style: inside;">'+t+"</ul></div>",i},setValueToForm:function(){let e=this.suggestionForm.getForm();const t=e.findField("dc_ips"),i=this.suggestionForm.getForm().getValues();e.setValues(this.testParams),t&&t.setDCIPValue(this.testParams.dc_ips),Ext.iterate(i,(function(t,i){i&&e.findField(t).setValue(i)}),this)},onSubmit:function(){const e=this.suggestionForm.getForm();if(!e.isValid())return!1;this.needRetestAll=!1;if((e=>{let t=!1;return e.items.each((e=>{if(e.isDirty()&&(t=!0,this.issue.forceRetestFieldList.find((t=>t===e.name))))return this.needRetestAll=!0,!1}),this),t})(e)&&Ext.isFunction(this.issue.saveConfBeforeRetestFn)){const t=Ext.applyIf(e.getValues(),this.testParams);return this.setStatusBusy(),void this.issue.saveConfBeforeRetestFn(this,t,this.needRetestAll,this.retestIssue.bind(this))}this.retestIssue()},retestIssue:function(){Ext.apply(this.testParams,this.suggestionForm.getForm().getValues()),this.testParams.dc_ips&&Ext.isArray(this.testParams.dc_ips)&&(this.testParams.dc_ips=this.testParams.dc_ips.join(",")),this.needRetestAll&&(this.issue.retest="all"),this.applyCallback(this.issue),this.close()},afterClickSkip:function(){this.skipCallback(this.issue),this.close()}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBarView",{extend:"SYNO.ux.FleXcroll.DataView",disallowBack:!1,toggleAnimation:!0,constructor:function(e){if(!e.store)throw new Error("store is required to construct SYNO.SDS.AdminCenter.DirectoryService.StatusBarView");this.isDoingAnimation=!1;const t=Ext.apply({style:"margin: auto",tpl:this.createTpl(),store:e.store},e);this.callParent([t])},createTpl:function(){const e=this.createIssueBarTpl();return new Ext.XTemplate('<tpl for=".">','<div class="syno-directory-wizard-status-container">','<div class="status-category-bar">','<div class="first-area">','<tpl if="this.isCompleted(status) == true">','<div class="status-icon status-{status}"></div>',"</tpl>",'<tpl if="this.isCompleted(status) == false">','<div class="loader {status}"></div>',"</tpl>","</div>",'<div class="second-area">','<div class="category-name">',"{categoryName}","</div>",'<div class="category-desc category-desc-{status}">',"{desc}","</div>","</div>",'<tpl if="values.issueList.length != 0">','<div class="third-area">','<div class="item-toggle">','<div class="item-toggle-img"></div>',"</div>","</div>","</tpl>","</div>",'<tpl if="values.issueList.length != 0">','<div class="item-detail status-issue-list" style="display:none;">','<tpl for="issueList">',e.html,"</tpl>","</div>","</tpl>","</div>","</tpl>",'<div class="x-clear"></div>',{compiled:!0,isCompleted:function(e){return"success"===e||"warning"===e||"fail"===e}})},createIssueBarTpl:function(){return new Ext.XTemplate('<div id="{id}" class="status-issue-bar">','<div class="first-area">','<div class="status-icon status-{[(values.level === 0) ? "fail" : "warning"]}">',"</div>","</div>",'<div class="second-area">','<div class="issue-title{[values.seen === true ? " seen" : ""]}">',"{title}","</div>","</div>",'<div class="third-area">',"</div>","</div>")},appendFixBtn:function(e){e.forEach(function(e){e.btn=new SYNO.ux.Button({btnStyle:0===e.level?"red":"grey",text:_T("directory_service","fix"),disabled:!!e.skipped,renderTo:Ext.fly(e.id).child(".third-area"),handler:this.launchFixDialog.bind(this,e),scope:this})}.bind(this))},launchFixDialog:function(e,t,i){let s=Ext.fly(t.getId()).parent(".status-issue-bar").child(".issue-title");s&&(s.addClass("seen"),e.seen=!0);const n={owner:this.findWindow(),title:e.title,testParams:e.testParams,issue:e,applyCallback:e.applyCallback,skipCallback:e.skipCallback,saveConfBeforeRetestFn:e.saveConfBeforeRetestFn};new SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.FixDialog(n).open()},onClick:function(e,t,i){let s=Ext.fly(t).parent(".status-category-bar");s&&s.child(".item-toggle")&&(s=s.parent(".syno-directory-wizard-status-container"),s&&(s.child(".item-toggle-expanded")?this.shrinkBar():this.expandBar()))},isExpand:function(){const e=Ext.fly(this.getId());if(!e)return!1;const t=e.child(".syno-directory-wizard-status-container").child(".item-toggle");return!!t&&t.hasClass("item-toggle-expanded")},shrinkBar:function(e=!1){this.toggleHandler(!1,e)},expandBar:function(e=!1){this.toggleHandler(!0,e)},toggleHandler:function(e,t){const i=Ext.fly(this.getId()).child(".syno-directory-wizard-status-container"),s=i.child(".item-toggle");let n=i.child(".item-detail");n&&s&&!this.isDoingAnimation&&(s[e?"addClass":"removeClass"]("item-toggle-expanded"),n.setVisibilityMode(Ext.Element.DISPLAY),t||!this.toggleAnimation?(n[e?"show":"hide"](),this.updateFlexcroll()):(this.isDoingAnimation=!0,n[e?"slideIn":"slideOut"]("t",{duration:.25,callback:function(){this.isDoingAnimation=!1,this.updateFlexcroll()}.bind(this)})))},updateFlexcroll:function(){if(this.fleXcrollerOwner){this.fleXcrollerOwner.updateFleXcroll();const e=Ext.get(this.fleXcrollerOwner.getScrollTarget().id+"_scrollwrapper").child(".vscrollerbase");e&&!e.isVisible()&&this.setFleXcrollToTop()}},setFleXcrollToTop:function(){this.fleXcrollerOwner&&(this.fleXcrollerOwner.getScrollTarget().dom.fleXdata.scroller[1]=!0,this.fleXcrollerOwner.updateFleXcroll(!0))}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBarPanel",{extend:"SYNO.ux.Panel",testMode:"post",statusBarList:[],constructor:function(e){this.testMode="wizard"===e.testMode?"wizard":"post",this.statusBarList=this.initComponents(e);const t=Ext.apply({autoFlexcroll:!1,items:this.statusBarList,bodyStyle:"padding: 0"},e);this.callParent([t])},initComponents:function(e){let t=[],i={module:e.module,width:e.statusBarWidth,fleXcrollerOwner:e.fleXcrollerOwner||this,allowSkipIssue:!!this.isWizardTest(),stopWhenHasFail:!!this.isWizardTest(),forceExpanded:!!this.isWizardTest(),forceRetestFieldList:Ext.isArray(e.forceRetestFieldList)?e.forceRetestFieldList:[],saveConfBeforeRetestFn:e.saveConfBeforeRetestFn?e.saveConfBeforeRetestFn:this.saveConfBeforeRetestFn,categoryTestDoneCallback:this.doNextCategory.bind(this)};const s=e.testData;return Ext.each(s.categoryList,(e=>{Ext.apply(i,{disallowBack:s.categoryStageList[e].disallowBack,categoryName:_T("directory_service","category_"+e),categoryStage:s.categoryStageList[e]}),t.push(new SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBar(i))})),t},isWizardTest:function(){return"wizard"===this.testMode},isAllTestDone:function(){return this.currentStatusBarIndex>=this.statusBarList.length},startTest:function(e){this.currentStatusBarIndex=-1,this.testParams=e,0!==this.findWindow().init_time&&(e.init_time=this.findWindow().init_time),this.doNextCategory()},doNextCategory:function(){this.currentStatusBarIndex++,this.isAllTestDone()?this.allTestDoneCallback&&this.allTestDoneCallback(this.testParams):this.statusBarList[this.currentStatusBarIndex].doCategoryTest()},resetAllStatusBars:function(){this.statusBarList.forEach((e=>{e.resetStatus()}))}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBar",{extend:"SYNO.ux.Panel",STATUS_CHECKING:"checking",STATUS_SUCCESS:"success",STATUS_WARNING:"warning",STATUS_FAIL:"fail",loaderDelay:"0s",Utils:SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.Utils,allowSkipIssue:!0,stopWhenHasFail:!0,forceExpanded:!0,forceRetestFieldList:[],saveConfBeforeRetestFn:null,initEvents:function(){this.callParent(arguments),this.mon(this.store,"load",this.afterLoad,this)},constructor:function(e){this.completeDesc=e.categoryStage.completeDesc,this.stageList=e.categoryStage.stageList,this.testParams=e.testParams,this.stageWorkQueue=[],this.store=new SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBarStore,this.view=new SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBarView({fleXcrollerOwner:e.fleXcrollerOwner,store:this.store});for(let e=0;e<this.stageList.length;e++)this.stageList[e].stageNumber=e;const t=Ext.apply({id:Ext.id(),style:"margin: auto",bodyStyle:"padding: 0",cls:"syno-directory-wizard-body-auto-height",items:[this.view]},e);this.callParent([t]),this.resetStatus()},initStatusBar:function(){this.isRetestMode=!1,this.needSkipStageCount=0,this.isExpand=!1,this.stageWorkQueue=JSON.parse(JSON.stringify(this.stageList)),this.minorIssueCount=0,this.skippedIssueCount=0,this.criticalIssueCount=0,this.statusData={status:"waiting",categoryName:this.categoryName,desc:_T("directory_service","status_waiting"),issueList:[]},this.setBackBtnEnable(!1)},cancelWebAPIRequest:function(){Ext.isEmpty(this.webAPIRequest)||(Ext.Ajax.abort(this.webAPIRequest),this.webAPIRequest=null)},resetStatus:function(){this.cancelWebAPIRequest(),this.initStatusBar(),this.updateStatusBar()},updateStatusBar:function(e){e&&Ext.apply(this.statusData,e),this.isExpand=this.view.isExpand(),this.saveLoaderState();let t={};t=this.statusData.status===this.STATUS_WARNING||this.statusData.status===this.STATUS_FAIL?this.statusData:{status:this.statusData.status,categoryName:this.categoryName,desc:this.statusData.desc},this.store.loadData([t],!1)},isIssueHandled:function(){return 0===this.criticalIssueCount&&this.minorIssueCount===this.skippedIssueCount},saveLoaderState:function(){const e=Ext.get(Ext.DomQuery.selectNode(String.format("#{0} .loader.checking",this.id))),t=e?e.getStyle("-webkit-transform")||e.getStyle("transform"):null;if(!t||"none"===t)return;this.loaderDelay=(e=>{const t=e.split(","),i=parseFloat(t[0].substr(t[0].indexOf("(")+1)),s=parseFloat(t[1]);let n=Math.atan2(s,i)/(2*Math.PI);return n<0&&(n+=1),-n+"s"})(t)},afterLoad:function(){(()=>{let e=Ext.get(Ext.DomQuery.selectNode(String.format("#{0} .loader.checking",this.id)));e&&e.setStyle("animation-delay",this.loaderDelay)})(),this.statusData.status!==this.STATUS_WARNING&&this.statusData.status!==this.STATUS_FAIL||this.view.appendFixBtn(this.statusData.issueList),this.isExpand&&this.view.expandBar(!0),this.view.updateFlexcroll(),this.isIssueHandled()||this.statusData.status!==this.STATUS_WARNING&&this.statusData.status!==this.STATUS_FAIL||!this.forceExpanded||this.view.expandBar()},genCategoryStatus:function(){return 0===this.statusData.issueList.length?this.STATUS_SUCCESS:this.criticalIssueCount>0?this.STATUS_FAIL:this.STATUS_WARNING},genCategoryDesc:function(){return 0===this.stageWorkQueue.length?0===this.statusData.issueList.length?_T("directory_service",this.completeDesc)||_T("directory_service","all_pass"):1===this.statusData.issueList.length?1===this.criticalIssueCount?_T("directory_service","single_critical_issue_short"):_T("directory_service","single_minor_issue_short"):this.criticalIssueCount>0?String.format(_T("directory_service","multi_critical_issues_short"),this.criticalIssueCount):String.format(_T("directory_service","multi_minor_issues_short"),this.minorIssueCount):1===this.statusData.issueList.length?1===this.criticalIssueCount?_T("directory_service","single_critical_issue"):_T("directory_service","single_minor_issue"):this.criticalIssueCount>0?String.format(_T("directory_service","multi_critical_issues"),this.criticalIssueCount):String.format(_T("directory_service","multi_minor_issues"),this.minorIssueCount)},setBackBtnEnable:function(e){if(this.module&&this.module.backBtn){if(this.disallowBack)return void this.module.backBtn.disable();e?this.module.backBtn.enable():this.module.backBtn.disable()}},doCategoryTest:function(){this.testParams=this.ownerCt.testParams,this.resetStatus(),this.doStageTest()},doStageTest:function(){if(0!==this.needSkipStageCount)return this.needSkipStageCount--,this.stageWorkQueue.shift(),void this.doStageTest();if(this.setBackBtnEnable(!1),0!==this.stageWorkQueue.length)return void this.sendStageTest(this.stageWorkQueue.shift());this.webAPIRequest=null;let e="";e=0===this.statusData.issueList.length?this.STATUS_SUCCESS:0!==this.minorIssueCount&&0===this.criticalIssueCount?this.STATUS_WARNING:this.STATUS_FAIL,this.updateStatusBar({status:e,desc:this.genCategoryDesc()}),this.forceExpanded=!0,this.isRetestMode||(this.isRetestMode=!0,this.categoryTestDoneCallback())},sendStageTest:function(e){let t=JSON.parse(JSON.stringify(e));this.updateStatusBar({status:this.STATUS_CHECKING,desc:_T("directory_service",t.desc)||_T("directory_service","status_checking")}),this.view.shrinkBar(!0),t.testList.forEach((e=>{e.encryption=Ext.apply(e.encryption||[],["password"]),e.params=Ext.apply(e.params||{},this.testParams)})),this.currentStage=t,this.webAPIRequest=this.sendWebAPI({compound:{stopwhenerror:!1,mode:"parallel",params:t.testList},timeout:864e5,encryption:Ext.isString(this.testParams.password)?["password"]:[],callback:this.afterStageTest,scope:this})},checkProgressErrorCode:function(e){const t=e.error.code;let i="";if(1110===t)i=_T("directory_service","already_in_directory_service");else if(1111===t)i=_T("directory_service","join_process_is_running");else if(1112===t)i=_T("directory_service","join_process_exist");else if(1113===t)i=_T("directory_service","join_progress_not_exist");else{if(1114!==t)return!1;i=_T("directory_service","join_process_interrupt")}return e.error.errors&&e.error.errors.runner&&(i=i.replace(/{user}/g,e.error.errors.runner)),e.error.errors&&e.error.errors.client_ip&&(i=i.replace(/{IP}/g,e.error.errors.client_ip)),1112===t?this.findWindow().getMsgBox().confirm(this.title,i,(function(e,t){"no"!==e?this.sendWebAPI({api:"SYNO.Core.DirectoryServiceCheck.Progress",method:"end_progress",version:1,scope:this,params:{force_remove:!0},callback:function(e,t,i){this.doCategoryTest()}}):this.findWindow().close()}),this):this.findWindow().getMsgBox().alert(this.title,i,(function(){this.findWindow().close()}),this),!0},afterStageTest:function(e,t){if(!this.ownerCt)return;let i=!1;this.webAPIRequest=null;for(const[e,s]of t.result.entries()){if(s.success){this.applyDataToTestParams(s.data);continue}if(this.checkProgressErrorCode(s))return;const t=this.constructIssue(s,e);if(!t)return void this.showErrAlert(s);i=!0;let n=this.statusData.issueList.find((e=>t.errCode===e.errCode));if(!n){this.statusData.issueList.push(t),0===t.level?this.criticalIssueCount++:this.minorIssueCount++;continue}t.level<n.level&&(n.level=t.level,this.minorIssueCount--,this.criticalIssueCount++);let o=n.stageList.find((e=>e.stageNumber===t.stageNumber));o?o.testList.push(t.testItem):n.stageList=n.stageList.concat(t.stageList)}if(this.isIssueHandled()||!1===this.stopWhenHasFail)return this.needSkipStageCount=i&&Number(this.currentStage.skipStageWhenFailed)||0,void this.doStageTest();this.updateStatusBar({status:this.criticalIssueCount>0?this.STATUS_FAIL:this.STATUS_WARNING,desc:this.genCategoryDesc()}),this.setBackBtnEnable(!0)},applyDataToTestParams:function(e){Ext.apply(this.testParams,e||{}),0==this.findWindow().init_time&&e&&e.init_time&&0!==e.init_time&&(this.findWindow().init_time=e.init_time)},showErrAlert:function(e){this.cancelWebAPIRequest(),this.findWindow().getMsgBox().alert(this.title,_T("disk_info","disk_contact_syno"),(function(){this.findWindow().inException=!0,this.findWindow().close()}),this),SYNO.Debug(String.format("Webapi error. API: {0}, method: {1}, error code: {2}",e.api,e.method,e.error.code))},constructIssue:function(e,t){if(void 0===e.success)return;let i=!1;void 0===e.error.errors&&(e.error.errors={},i=!0),this.applyDataToTestParams(e.error.errors.data);const s=this.currentStage.testList[t],n={testItem:s,id:Ext.id(null,"issue-"),unknownError:i,errCode:e.error.code,level:e.error.errors.level||0,info:e.error.errors.info||{},isPlural:e.error.errors.isPlural,allowSkipIssue:this.allowSkipIssue,forceRetestFieldList:this.forceRetestFieldList,stageNumber:this.currentStage.stageNumber,retest:s.retest,testParams:this.testParams,title:new Ext.XTemplate(this.Utils.getIssueTitle(e.error.code,e.error.errors.isPlural)).apply(e.error.errors.info||{}),applyCallback:this.applyCallback.bind(this),skipCallback:this.skipCallback.bind(this),saveConfBeforeRetestFn:this.saveConfBeforeRetestFn};let o=Ext.applyIf({testList:[s]},this.currentStage);if(n.stageList=[o],Number(this.stageList[n.stageNumber].skipStageWhenFailed)>0)for(let e=n.stageNumber+1;e<this.stageList.length;e++)n.stageList.push(this.stageList[e]);return n},applyCallback:function(e){if("stage"===e.retest)this.retestStage(e);else if("category"===e.retest)this.doCategoryTest();else if("all"===e.retest)this.ownerCt.resetAllStatusBars(),this.ownerCt.startTest(this.testParams);else{const t=this.statusData.issueList.findIndex((t=>t.id===e.id));-1!==t&&(this.statusData.issueList.splice(t,1),0===e.level?this.criticalIssueCount--:1===e.level&&this.minorIssueCount--),this.stopWhenHasFail?this.stageWorkQueue.splice(0,0,...e.stageList):this.stageWorkQueue=Ext.apply([],e.stageList),this.doStageTest()}},retestStage:function(e){this.cancelWebAPIRequest(),this.needSkipStageCount=0;let t=[];for(const i of this.statusData.issueList)i.stageNumber===e.stageNumber?(0===i.level?this.criticalIssueCount--:1===i.level&&this.minorIssueCount--,i.skipped&&this.skippedIssueCount--):t.push(i);this.statusData.issueList=t,this.stageWorkQueue.push(this.stageList[e.stageNumber]),this.doStageTest()},skipCallback:function(e){let t=this.statusData.issueList;for(let i=0;i<t.length;i++)if(t[i].id===e.id){t[i].skipped=!0,t[i].btn.disable(),this.skippedIssueCount++;break}this.isIssueHandled()&&(this.view.shrinkBar(!0),this.doStageTest())}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.CheckAndJoinStep",{extend:"SYNO.ux.FormPanel",joinConfig:{},initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",this.onAfterLayout,this,{single:!0})},constructor:function(e){this.isAllTestDone=!1;var t=Ext.apply({cls:"syno-directory-wizard-body-auto-height",layout:"fit",bodyStyle:{padding:0,"margin-top":"10px"}},e);this.callParent([t])},onAfterLayout:function(){this.sendWebAPI({api:"SYNO.Core.DirectoryServiceCheck.Common",method:"get_stages",version:1,params:{type:this.testType},callback:function(e,t,i){e?this.createStatusBarPanel.call(this,t):this.owner.getMsgBox().alert(this.title,_T("common","error_system"),(function(){this.owner.close()}),this)},scope:this})},createStatusBarPanel:function(e){this.statusBarPanel=new SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBarPanel({module:this,testMode:"wizard",fleXcrollerOwner:this.ownerCt,forceExpanded:!0,statusBarWidth:570,testData:e,allTestDoneCallback:this.allTestDoneCallback.bind(this)}),this.add(this.statusBarPanel),this.doLayout()},isTrustedDomainMode(){return"0"===this.joinConfig.manage_mode},isOUMode(){return"1"===this.joinConfig.manage_mode},initButton:function(){this.nextBtn=this.findWindow().getButton("next"),this.backBtn=this.findWindow().getButton("back"),this.isTrustedDomainMode()||this.nextBtn.setText(_T("common","ok")),this.nextBtn.disable(),this.backBtn.disable()},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments),this.startCheckAndJoin()},getExtraInfoForLDAP:function(){var e=[{api:"SYNO.Core.Directory.LDAP.Profile",method:"get",version:1,params:{name:this.joinConfig.profile},scope:this},{api:"SYNO.Core.FileServ.SMB",method:"get",params:{},version:3,scope:this}];this.sendWebAPI({compound:{stopwhenerror:!1,params:e},scope:this,callback:function(e,t,i){var s;e&&(s=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.LDAP.Profile","get"),this.joinConfig.profile_rules=s.rules,s=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.FileServ.SMB","get"),this.joinConfig.SMBStatus=s.enable_samba),this.statusBarPanel.startTest(this.joinConfig)}})},getJoinConfig:function(){this.joinConfig={},this.stepList.forEach(function(e){Ext.apply(this.joinConfig,e.getForm().getValues()),"ldap_info"===e.itemId&&(Ext.apply(this.joinConfig,{name:e.getForm().findField("profile").getValue()}),"ssl"===e.getForm().findField("encryption").getValue()?Ext.apply(this.joinConfig,{port:636}):Ext.apply(this.joinConfig,{port:389}),this.joinConfig.enable_client_certificate=e.getForm().findField("enable_client_certificate").getValue(),this.joinConfig.disable=!1),"domain_info"===e.itemId&&(Ext.isArray(this.joinConfig.dc_ips)&&(this.joinConfig.dc_ips=e.getForm().findField("dc_ips").getValue()),Ext.apply(this.joinConfig,{register_nics:e.getForm().findField("register_nics").getValue()}))}.bind(this))},startCheckAndJoin:function(){this.getJoinConfig(),this.initButton(),"ldap"===this.joinConfig.server_type?this.getExtraInfoForLDAP():this.statusBarPanel.startTest(this.joinConfig)},allTestDoneCallback:function(e){if(this.isAllTestDone=!0,e.enable_cifs_pam&&e.SMBStatus){var t=[{api:"SYNO.Core.FileServ.SMB",method:"set",version:3,params:{enable_samba:e.SMBStatus,smb_max_protocol:0,smb_min_protocol:0}},{api:"SYNO.Core.FileServ.ServiceDiscovery",method:"set",version:1,params:{enable_smb_time_machine:!1}}];this.sendWebAPI({compound:{stopwhenerror:!1,params:t},scope:this,callback:function(e,t,i){e||SYNO.Debug("Enable CIFS PAM failed"),this.nextBtn.enable()}})}else this.nextBtn.enable()},getNext:function(){return this.isOUMode()?null:this.nextId},getBack:function(){this.statusBarPanel.resetAllStatusBars()}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.SelectDomainStep",{extend:"SYNO.ux.FormPanel",initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",this.onAfterLayout,this,{single:!0})},onAfterLayout:function(){this.vuePanel=this.gridPanel.components[0]},activate:function(){this.vuePanel.update()},constructor:function(e){this.helper=SYNO.SDS.AdminCenter.DirectoryService.Util,this.gridPanel=new SYNO.SDS.VuePanel({vueClass:SYNO.SDS.AdminCenter.DirectoryService.SelectDomainPanel,height:316,mountId:"select-domain-grid"});let t=Ext.apply({headline:_T("domain","select_domain_title"),items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("domain","select_domain_desc")},this.gridPanel]},e);this.callParent([t])},isDirty:function(){return this.vuePanel.isDirty()},onMessageBoxAlert(e,t){this.findWindow().getMsgBox().alert(e,t)},applySelectedDomain:async function(){try{this.findWindow().setStatusBusy();const e=this.vuePanel.getGridData();await synowebapi.promises.request({api:"SYNO.Core.Directory.Domain.Trust",method:"set_allow_domain",version:"1",params:{domain_list:e}}),this.vuePanel.cleanDirty(),this.owner.goNext(this.nextId,!0)}catch(e){this.onMessageBoxAlert("",this.helper.GetErrMsg(e))}finally{this.findWindow().clearStatusBusy()}},getNext:function(){return this.isDirty()?(this.applySelectedDomain(),!1):this.nextId},checkState:function(){this.owner.getButton("back").hide(),this.owner.getButton("next").setText(_T("common","commit"))}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.Wizard",{extend:"SYNO.SDS.Wizard.ModalWindow",init_time:0,inException:!1,constructor:function(e){this.module=e.module,this.owner=e.owner;var t=Ext.apply({title:_T("directory_service","wizard_title"),height:560,width:700,closeAction:"closeHandler",steps:[]},e);this.serverSettingStep=new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.ServerSettingStep({itemId:"server_setting",appWin:this.owner}),t.steps.push(this.serverSettingStep),this.addDomainSteps(t),this.addLDAPSteps(t),this.callParent([t])},initEvents:function(){this.callParent(arguments),this.addEvents(["finished"])},addDomainSteps:function(e){this.domainInfoStep=new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.DomainInfoStep({itemId:"domain_info",nextId:"domain_ou"}),this.domainOUStep=new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.DomainOUStep({itemId:"domain_ou",nextId:"domain_check_join"});var t=[this.serverSettingStep,this.domainInfoStep,this.domainOUStep];this.domainCheckJoinStep=new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.CheckAndJoinStep({headline:_T("directory_service","domain_check_join_title"),testType:"domain_pretest",stepList:t,itemId:"domain_check_join",nextId:"domain_select_domain"}),this.domainSelectDomainStep=new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.SelectDomainStep({itemId:"domain_select_domain",nextId:null}),e.steps.push(this.domainInfoStep),e.steps.push(this.domainOUStep),e.steps.push(this.domainCheckJoinStep),e.steps.push(this.domainSelectDomainStep)},addLDAPSteps:function(e){this.ldapInfoStep=new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.LDAPInfoStep({module:this.module,itemId:"ldap_info",nextId:"ldap_check_join"});var t=[this.serverSettingStep,this.ldapInfoStep];this.ldapCheckJoinStep=new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.CheckAndJoinStep({headline:_T("directory_service","ldap_check_join_title"),testType:"ldap_pretest",stepList:t,itemId:"ldap_check_join",nextId:null}),e.steps.push(this.ldapInfoStep),e.steps.push(this.ldapCheckJoinStep)},onClose:function(){0!==this.init_time&&this.sendWebAPI({api:"SYNO.Core.DirectoryServiceCheck.Progress",method:"end_progress",version:1,scope:this,params:{init_time:this.init_time}}),this.fireEvent("finished",this,{joined:this.isJoined()})},isJoined:function(){let e=this.getActiveStep();return e===this.domainSelectDomainStep||(e===this.domainCheckJoinStep||e===this.ldapCheckJoinStep)&&(!!e.joinConfig&&!!e.joinConfig.isProgressEnd)},needShowConfirm:function(){return!this.inException&&(this.isJoined()&&this.getButton("next").disabled)},closeHandler:function(){if(!this.needShowConfirm())return void this.close();let e=this.getActiveStep()===this.domainCheckJoinStep?_T("directory_service","confirm_close_domain_wizard"):_T("directory_service","confirm_close_ldap_wizard");this.getMsgBox().confirm(null,e,(function(e){"yes"===e&&this.close()}),this,{yes:_T("common","stop"),no:_T("common","cancel")})}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.LeaveDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.callParent([this.fillConfig(e)])},fillConfig:function(e){let t={width:580,minHeight:120,autoHeight:!0,header:!1,resizable:!1,draggable:!1,cls:"x-window-dlg",padding:"24px 30px 0 30px",elements:"body",items:[{xtype:"syno_displayfield",cls:"ext-mb-title",value:_T("directory_service","leave")},{xtype:"syno_displayfield",name:"description",style:"margin-bottom: 6px",value:_T("directory_service","leave_warn")},{xtype:"syno_displayfield",name:"message",style:"margin-bottom: 6px",hidden:!0},{xtype:"syno_displayfield",name:"feasibility",style:"margin-bottom: 6px",hidden:!0},{xtype:"syno_checkbox",boxLabel:_T("directory_service","leave_confirm"),name:"confirm",htmlEncode:!1,listeners:{check:{scope:this,fn:this.onCheckboxCheck}}}],fbar:{items:[{xtype:"syno_button",text:_T("common","cancel"),itemId:"cancel",scope:this,handler:this.close},{xtype:"syno_button",text:_T("common","leave"),itemId:"leave",btnStyle:"red",disabled:!0,scope:this,handler:this.onClickLeave}]}};return Ext.apply(t,e)},onCheckboxCheck:function(e,t){this.getFooterToolbar().getComponent("leave").setDisabled(!t)},errorHandling:async function(e){const t=SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrorData(e);let i=_T("common","commfail");SYNO.API.Errors.core[t.code]&&(i=SYNO.API.Errors.core[t.code]),await this.module.appWin.getMsgBox().alert(_T("network","wnds_domain"),i)},updateWarnMsg:function(e,t){let i=this.getComponent("message"),s=this.getComponent("feasibility"),n=this.getComponent("confirm"),o="";if(!e){if(this.domainData){if(2627!==t.code)return void this.errorHandling(t);o=SYNO.SDS.AdminCenter.DirectoryService.Util.GetFeasibilityMsgList(t.errors.reason),s.setValue(o),"hard"===t.errors.check_type?(i.setValue(_T("domain","leave_alert")),n.hide()):(i.setValue(_T("domain","leave_confirm")),n.show())}else if(this.ldapData){if(2722!==t.code)return;o=SYNO.SDS.AdminCenter.DirectoryService.Util.GetFeasibilityMsgList(t.errors.reasons),s.setValue(o),"hard"===t.errors.check_type?(i.setValue(_T("ldap","leave_alert")),n.hide()):(i.setValue(_T("ldap","leave_confirm")),n.show())}s.show(),i.show()}},onOpen:function(e){let t,i,s,n;if(this.callParent(arguments),this.domainData)t=this.domainData,i="SYNO.Core.Directory.Domain",s="leave_check",n=1;else{if(!this.LDAPData)return;t=this.ldapData,i="SYNO.Core.Directory.LDAP",s="unbind_check",n=1}this.sendWebAPI({api:i,method:s,version:n,params:t||{},callback:this.updateWarnMsg,scope:this})},onClickLeave:function(){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.applySetting)},applySetting:function(){let e=[];this.setStatusBusy(),this.domainData&&e.push({api:"SYNO.Core.Directory.Domain",method:"set",version:"yes"===_D("support_hyper_converged")?3:2,params:{enable_domain:!1}}),this.ldapData&&e.push({api:"SYNO.Core.Directory.LDAP",method:"set",version:2,params:{disable:!0}}),this.sendWebAPI({compound:{params:e},scope:this,callback:this.afterLeave})},loadForm:async function(){let e;this.domainData&&(e=!0),this.clearStatusBusy(),this.close(),e&&await this.module.appWin.getMsgBox().alert("",_T("domain","remind_modification_after_leave_domain")),this.module.panel.getComponent("directory").loadDirectoryService()},afterLeave:async function(e,t,i){if(!e)return await this.getMsgBox().alert("",SYNO.API.getErrorString(t.code)),void this.clearStatusBusy();if(this.domainData){const e=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","set");return this.task_id=e.task_id,void(this.setPollingID=this.pollReg({interval:3,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Directory.Domain",method:"set_status",params:{task_id:this.task_id},version:1},status_callback:async function(e,t,i){if(!e)return this.stopSetPolling(),await this.errorHandling(t),void this.loadForm();!1!==t.finish&&(this.stopSetPolling(),this.loadForm())}}))}this.ldapData,this.loadForm()},stopSetPolling:function(){null!==this.setPollingID&&this.sendWebAPI({webapi:{api:"SYNO.Core.Directory.Domain",version:1,params:{task_id:this.task_id},method:"set_stop"},scope:this,callback:function(e,t,i){this.pollUnreg(this.setPollingID),this.setPollingID=null}})}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.RejoinDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.data=e.data,this.directoryType=e.domainEnable?"domain":"ldap",this.panel=this.createForm(e);var t={title:e.domainEnable?_T("domain","rejoin"):_T("ldap","rebind"),width:650,height:250,layout:"fit",buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.close},{text:_T("common","alt_apply"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.panel]};Ext.apply(t,e),this.callParent([t])},createForm:function(e){var t,i,s,n;return i=e.domainEnable?_T("directory_service","domain_account"):_T("ldap","bind_account"),t=e.domainEnable?_T("network","domain_setting_desc"):_T("ldap","bind_auth_desciption"),s={xtype:"syno_textfield",name:"username",fieldLabel:i,value:"administrator",allowBlank:!1},e.domainEnable||delete s.value,n={labelWidth:300,items:[{xtype:"syno_displayfield",value:t},s,{xtype:"syno_textfield",name:"password",textType:"password",allowBlank:e.domainEnable,fieldLabel:_T("user","user_passwd")}]},new SYNO.SDS.Utils.FormPanel(n)},onApply:function(){if("ldap"===this.directoryType)SYNO.Debug(this.data),this.data.bind_dn=this.panel.getForm().findField("username").getValue(),this.data.bind_pw=this.panel.getForm().findField("password").getValue(),this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({api:"SYNO.Core.Directory.LDAP",method:"set",version:2,encryption:["bind_pw"],params:this.data,callback:function(e,t){var i;this.clearStatusBusy(),e?this.close():(2714===t.code&&(t.code=2706),i=SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(t.code?t.code:2799),this.setStatusError({text:i}))},scope:this});else{var e=this.panel.getForm().getValues();e.rejoin=!0,this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({api:"SYNO.Core.DirectoryServiceCheck.DomainJoin",method:"join_domain",version:1,encryption:["password"],params:e,scope:this,callback:function(e,t){if(this.clearStatusBusy(),e)this.close();else if(t.code){var i=SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.Utils.getIssueTitle(t.code);this.setStatusError({text:i})}else this.setStatusError({text:_T("common","error_system")})}})}}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DomainGeneralSetting",{extend:"SYNO.SDS.Utils.FormPanel",FIELD_WIDTH:300,LABEL_WIDTH:220,initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",this.afterLayoutHandler,this,{single:!0})},afterLayoutHandler:function(){const e=`<a href="${_T("network","iwa_help_url")}" target="_blank" class="link-font" tabindex="0" role="link" style="cursor:pointer">${_T("common","learn_more")}</a>`,t=String.format(_T("network","http_negotiate_iwa_info"),e);SYNO.ux.AddTip(this.getForm().findField("enable_http_negotiate").getEl(),t)},constructor:function(e){this.module=e.module,this.owner=e.owner,this.domainData=e.domainData;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({title:_T("network","wnds_domain"),trackResetOnLoad:!0,fieldWidth:this.FIELD_WIDTH,labelWidth:this.LABEL_WIDTH,items:this.configItems(e.domainData)},e)},load:function(){var e=this.getForm();this.setStatusBusy(),this.domainData&&(this.getForm().setValues(this.domainData),!0===this.domainData.enable_adserver&&(e.findField("kdc").disable(),this.findById(this.domainRejoinBtnId).disable())),this.sendWebAPI({api:"SYNO.Core.Directory.Domain.Schedule",method:"get",version:1,scope:this,callback:function(e,t){if(!e)return this.onSceduleTypeSelect(),void this.clearStatusBusy();this.getForm().setValues(t),this.updateScheduleLoadData(t),this.clearStatusBusy()}})},createUpdateComposite:function(){var e,t,i,s,n,o=[],a=[],r=[1,2,3,6,12];for(t=[[_T("time","ntpdate_daily"),0],[_T("time","ntpdate_weekly"),1],[_T("time","ntpdate_monthly"),2],[_T("service","service_disable"),3]],i=new Ext.data.ArrayStore({fields:["display","value"],data:t}),e=0;e<24;++e)o.push([String.leftPad(String(e),2,"0"),e]);for(s=new Ext.data.ArrayStore({fields:["display","value"],data:o}),e=0;e<r.length;e++)a.push([String.format(_T("schedule","every_x_hours"),r[e]),r[e]]);n=new Ext.data.ArrayStore({fields:["display","value"],data:a}),this.itemUpdateComposite={xtype:"syno_compositefield",name:"update_period",fieldLabel:_T("directory_service","domain_update_period"),items:[{xtype:"syno_combobox",store:i,value:3,displayField:"display",valueField:"value",name:"schedule_type",triggerAction:"all",width:120,mode:"local",editable:!1,listeners:{select:{scope:this,fn:this.onSceduleTypeSelect}}},{xtype:"syno_datetimefield",fieldLabel:"",name:"date",width:120,value:new Date,hidden:!0,hideLabel:!0,editable:!1,maxValue:new Date(2037,12,31),minValue:new Date(2005,1,1)},{xtype:"syno_schedulefield",name:"week_name",fieldLabel:"",value:"0",hidden:!0,hideLabel:!0,editable:!1,width:90},{xtype:"syno_combobox",store:n,value:1,displayField:"display",valueField:"value",name:"repeat_hour",triggerAction:"all",hidden:!0,width:120,mode:"local",editable:!1},{xtype:"syno_displayfield",style:"padding-left: 4px; padding-right: 6px",value:_T("time","time_hour")+":",hidden:!0,name:"hour_label"},{xtype:"syno_combobox",store:s,fieldLabel:_T("time","time_hour")+":",displayField:"display",value:0,name:"hour",hidden:!0,valueField:"value",triggerAction:"all",mode:"local",width:58,editable:!1}]}},configItems:function(e){new Ext.data.ArrayStore({fields:["display","value"],data:[[_T("directory_service","trust_domain_mode"),0],[_T("directory_service","domain_ou_mode"),1]]});var t=new Ext.data.ArrayStore({fields:["display","value"],data:[[_T("service","service_enable"),!0],[_T("service","service_disable"),!1]]});return this.createUpdateComposite(),[{xtype:"syno_textfield",name:"dns",maxlength:64,emptyText:"IP LIST (EXAMPLE: 192.168.1.1,192.168.1.2)",fieldLabel:_T("directory_service","dns_server"),maskRe:/[,.:0-9A-Fa-f]/,allowBlank:!1,validator:SYNO.SDS.AdminCenter.DirectoryService.Util.MultiIPValidator},{xtype:"syno_dcip_superboxselect",name:"kdc",width:this.FIELD_WIDTH,dcipValue:e.kdc},this.itemUpdateComposite,{xtype:"compositefield",fieldLabel:_T("network","enable_http_negotiate_dsm_7"),items:[{xtype:"syno_combobox",store:t,name:"enable_http_negotiate",style:"margin-buttom: 4px",displayField:"display",valueField:"value",width:120,triggerAction:"all",hidden:!1,mode:"local",editable:!1}]},{xtype:"syno_button",width:"auto",id:this.domainRejoinBtnId=Ext.id(),name:"rejoin",text:_T("domain","rejoin"),scope:this,handler:this.onDomainRejoinBtnClick}]},dailySet:function(){var e=this.getForm();e.findField("repeat_hour").setVisible(!0),e.findField("hour_label").setVisible(!1),e.findField("hour").setVisible(!1),e.findField("week_name").setVisible(!1),e.findField("week_name").getVisibilityEl().setVisible(!1),e.findField("date").setVisible(!1)},weeklySet:function(){var e=this.getForm();e.findField("repeat_hour").setVisible(!1),e.findField("hour_label").setVisible(!0),e.findField("hour").setVisible(!0),e.findField("week_name").setVisible(!0),e.findField("week_name").getVisibilityEl().setVisible(!0),e.findField("date").setVisible(!1)},monthlySet:function(){var e=this.getForm();e.findField("repeat_hour").setVisible(!1),e.findField("hour_label").setVisible(!0),e.findField("hour").setVisible(!0),e.findField("week_name").setVisible(!1),e.findField("week_name").getVisibilityEl().setVisible(!1),e.findField("date").setVisible(!0)},disableSet:function(){var e=this.getForm();e.findField("repeat_hour").setVisible(!1),e.findField("hour_label").setVisible(!1),e.findField("hour").setVisible(!1),e.findField("week_name").setVisible(!1),e.findField("week_name").getVisibilityEl().setVisible(!1),e.findField("date").setVisible(!1)},onSceduleTypeSelect:function(){var e=this.getForm().findField("schedule_type").getValue();return 0===e?this.dailySet():1===e?this.weeklySet():2===e?this.monthlySet():3===e&&this.disableSet(),this.doLayout(),!0},onDomainRejoinBtnClick:function(){new SYNO.SDS.AdminCenter.DirectoryService.RejoinDialog({module:this.module,owner:this.owner,domainEnable:!0}).open()},updateScheduleLoadData:function(e){var t,i=this.getForm(),s=3,n={};1===(t=(n=e).date_type)?(s=2,n.repeat_hour=1,n.week_name="0",n.date=Date.parseDate(n.date,"Y/n/j")):0===t&&n.repeat_hour?(s=0,n.hour=0,n.week_name="0",n.date=new Date):0===t?(s=1,n.repeat_hour=1,n.date=new Date):2===t&&(s=3),i.setValues(Ext.apply(n,{schedule_type:s})),this.onSceduleTypeSelect()},isScheduleDirty:function(){var e=!1,t=this.getForm();return this.itemUpdateComposite.items.forEach((function(i){t.findField(i.name).isDirty()&&(e=!0)})),e},getScheduleParams:function(){var e,t=this.getForm(),i={date_type:0,week_name:"0,1,2,3,4,5,6",date:new Date,hour:0,min:0,repeat_hour:0,last_work_hour:0};return this.isScheduleDirty()?(3==(e=t.findField("schedule_type").getValue())?i={date_type:2}:0===e?(i.date_type=0,i.repeat_hour=t.findField("repeat_hour").getValue(),i.week_name="0,1,2,3,4,5,6",i.hour=0,i.last_work_hour=23):1===e?(i.date_type=0,i.repeat_hour=0,i.week_name=t.findField("week_name").getValue(),i.hour=t.findField("hour").getValue(),i.last_work_hour=i.hour):2===e&&(i.date_type=1,i.repeat_hour=0,i.repeat=1,i.week_name="0,1,2,3,4,5,6",i.hour=t.findField("hour").getValue(),i.date=t.findField("date").getValue().format("Y/n/j"),i.last_work_hour=i.hour),i):null},isParamNeedCheck:function(){return this.getForm().findField("dns").isDirty()||this.getForm().findField("kdc").isDirty()},getApplyWebAPIs:function(e){var t,i=[];return e&&(i.push({api:"SYNO.Core.Directory.Domain.Conf",method:"set",version:"yes"===_D("support_hyper_converged")?3:2,params:e}),i.push({api:"SYNO.Core.Directory.SSO.IWA",method:"set",version:1,params:e})),this.isParamNeedCheck()&&i.push({api:"SYNO.Core.DirectoryServiceCheck.Common",method:"get_stages",version:1,params:{type:"domain_posttest"}}),(t=this.getScheduleParams())&&i.push({api:"SYNO.Core.Directory.Domain.Schedule",method:"set",version:1,params:t}),i}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.LDAPGeneralEdit",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.ldapData=e.ldapData,this.isProfileDirty=!1;var t=[{xtype:"syno_combobox",fieldLabel:_T("ldap","security_type"),forceSelection:!0,store:new Ext.data.JsonStore({fields:["display","value"],data:[{display:_T("ldap","no_ssl"),value:"no"},{display:_T("ldap","with_ssl"),value:"ssl"},{display:_T("ldap","with_tls"),value:"start_tls"}]}),width:200,name:"encryption",value:"no",editable:!1,valueField:"value",displayField:"display",listeners:{change:function(e,t){this.componentStateHint.encryption=t,this.handleComponentState()},scope:this}},{xtype:"syno_combobox",fieldLabel:_T("ldap","base_dn"),allowBlank:!1,validator:function(e){return e.trim()===e},listeners:{change:function(e,t,i){this.componentStateHint.basedn=t,this.handleComponentState()},scope:this},name:"base_dn",store:new SYNO.API.Store({autoDestroy:!0,appWindow:e.module.owner,api:"SYNO.Core.Directory.LDAP.BaseDN",method:"list",version:2,reader:new SYNO.SDS.AdminCenter.DirectoryService.Util.ArrayReader({root:"base_dn",fields:["item"]}),listeners:{exception:this.onLoadBaseDNException,beforeload:this.onBeforeLoadBaseDN,load:this.onLoadBaseDN,scope:this}}),width:200,mode:"remote",forceSelection:!1,selectOnFocus:!1,editable:!0,valueField:"item",displayField:"item"},{xtype:"syno_compositefield",synotype:"indent",fieldLabel:_T("ldap","profile_title"),items:[{xtype:"syno_combobox",name:"profile",store:new SYNO.API.Store({autoDestroy:!0,appWindow:e.module.owner,api:"SYNO.Core.Directory.LDAP.Profile",method:"list",version:1,reader:new SYNO.SDS.AdminCenter.DirectoryService.Util.ArrayReader({root:"profiles",fields:["value","display"],createArrayElement:function(e){return{value:e,display:_T("ldap","profile_"+e)||e}}})}),width:200,mode:"remote",allowBlank:!1,editable:!1,valueNotFoundText:_T("ldap","profile_"+this.ldapData.profile),valueField:"value",displayField:"display"},{synotype:"indent_no_label",xtype:"syno_button",width:"auto",id:this.btnProfileAdvance=Ext.id(),text:_T("ldap","profile_advance"),scope:this,handler:this.onProfileBtnClick}]},{xtype:"syno_button",width:"auto",id:this.RejoinBtnId=Ext.id(),name:"rejoin",text:_T("ldap","rebind"),scope:this,handler:this.onRejoinBtnClick}],i=Ext.apply({trackResetOnLoad:!0,fieldWidth:218,labelWidth:215,items:t},e);this.callParent([i]),this.componentStateHint={basedn:"",encryption:"no"}},handleComponentState:function(){var e,t,i;const s=-1!==this.componentStateHint.basedn.search(",dc=c2,dc="),n=null===(e=this.owner)||void 0===e||null===(t=e.advancePanel)||void 0===t||null===(i=t.getForm())||void 0===i?void 0:i.findField("tls_reqcert");if(s)return this.getForm().findField("encryption").disable(),null==n||n.setValue(!1),void(null==n||n.disable());"no"===this.componentStateHint.encryption?(null==n||n.setValue(!1),null==n||n.disable()):null==n||n.enable()},load:function(){this.ldapData&&(this.getForm().setValues(this.ldapData),this.componentStateHint.basedn=this.getForm().findField("base_dn").getValue(),this.componentStateHint.encryption=this.getForm().findField("encryption").getValue(),this.handleComponentState())},onBeforeRequest:function(e){var t=this.getForm(),i=t.getValues();return t.isDirty()?t.isValid()?"start_tls"===i.encryption&&"domino"===i.profile?(this.module.panel.clearStatusBusy(),this.module.panel.setStatusError({text:_T("ldap","domino_not_support_tls"),clear:!0}),!1):(t.findField("profile").isDirty()&&(i.profile=t.findField("profile").getValue()),!1):(this.module.panel.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1):(this.module.panel.get("sso").isVisible()||this.module.panel.setStatusError({text:_T("error","nochange_subject"),clear:!0}),!1)},onBeforeLoadBaseDN:function(e,t){var i=this.getForm(),s=i.findField("base_dn");if(!this.ldapData.server_address)return s.store.removeAll(),this.module.panel.setStatusError({text:_T("ldap","set_host_first"),clear:!0}),delete s.lastQuery,!1;t.params.server_address=this.ldapData.server_address,t.params.encryption=i.findField("encryption").getValue(),this.module.panel.setStatusBusy()},onLoadBaseDNException:function(e,t,i,s,n,o){var a=this.getForm().findField("base_dn");void 0===n.code?this.module.appWin.getMsgBox().alert(_T("ldap","base_dn"),_T("ldap_error","ldap_operations_error")):2714===n.code?this.module.appWin.getMsgBox().alert(_T("ldap","base_dn"),_T("ldap","manual_base_dn")):this.module.appWin.getMsgBox().alert(_T("ldap","base_dn"),SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(n.code)),delete a.lastQuery,a.setValue(""),this.module.panel.clearStatusBusy()},onLoadBaseDN:function(){var e=this.getForm().findField("base_dn");this.module.panel.clearStatusBusy(),delete e.lastQuery,0===e.getStore().data.length&&""===e.getValue()&&this.module.appWin.getMsgBox().alert(_T("ldap","base_dn"),_T("ldap","manual_base_dn"))},onProfileBtnClick:function(){this.sendWebAPI({api:"SYNO.Core.Directory.LDAP.Profile",method:"get",version:1,params:{name:this.getForm().findField("profile").getValue()},callback:this.afterLoadProfile,scope:this})},onRejoinBtnClick:function(){new SYNO.SDS.AdminCenter.DirectoryService.RejoinDialog({module:this.module,owner:this.owner,data:this.ldapData,domainEnable:!1}).open()},afterLoadProfile:function(e,t,i){e?new SYNO.SDS.AdminCenter.DirectoryService.LDAP.ProfileDialog({module:this.module,owner:this.module.appWin,data:t,applyCallback:this.resetProfile,applyTarget:this}).open():this.module.appWin.getMsgBox().alert(this.title,SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(t.code))},resetProfile:function(e){var t=this.getForm();this.isProfileDirty=e,e&&t.setValues({profile:"customized"})},isParamNeedCheck:function(){return this.getForm().findField("encryption").isDirty()||this.getForm().findField("base_dn").isDirty()||this.isProfileDirty},getApplyWebAPIs:function(e){var t=[];return t.push({api:"SYNO.Core.Directory.LDAP.Profile",method:"set",version:2,params:{name:e.profile}}),t.push({api:"SYNO.Core.Directory.LDAP",method:"set",version:2,params:e}),this.isParamNeedCheck()&&t.push({api:"SYNO.Core.DirectoryServiceCheck.Common",method:"get_stages",version:1,params:{type:"ldap_posttest"}}),t},getExtraInfo:function(e,t){var i=[{api:"SYNO.Core.Directory.LDAP.Profile",method:"get",version:1,params:{name:t.profile},scope:this},{api:"SYNO.Core.FileServ.SMB",method:"get",params:{},version:3,scope:this}];this.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:i},scope:this,callback:function(i,s,n){var o;this.clearStatusBusy(),i?(o=SYNO.API.Response.GetValByAPI(s,"SYNO.Core.Directory.LDAP.Profile","get"),t.profile_rules=o.rules,o=SYNO.API.Response.GetValByAPI(s,"SYNO.Core.FileServ.SMB","get"),t.SMBStatus=o.enable_samba,e(t)):this.findWindow().getMsgBox.alert(this.title,_T("common","error_system"))}})}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.LDAPAdvanceEdit",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.afterLoadData=!1,this.SMBStatus=!1;var t=[{xtype:"syno_numberfield",name:"update_min",maxlength:5,minValue:1,fieldLabel:_T("directory_service","domain_update_period")+" ("+_T("common","time_minutes")+")"},{xtype:"syno_combobox",name:"ldap_schema",fieldLabel:_T("ldap","group_member_attr"),displayField:"display",valueField:"value",listeners:{change:function(e,t,i){"rfc2307"===t?this.getForm().findField("expand_nested_groups").disable():this.getForm().findField("expand_nested_groups").enable()},scope:this},store:new Ext.data.ArrayStore({fields:["display","value"],data:[["memberOf","rfc2307bis"],["memberUid","rfc2307"]]})},{xtype:"syno_checkbox",boxLabel:_T("ldap","smb_support_pam"),listeners:{enable:function(e){this.is_syno_server&&e.disable()},check:function(e,t){this.afterLoadData&&e.isDirty()&&t&&this.sendWebAPI({api:"SYNO.Core.FileServ.SMB",method:"get",params:{},version:3,scope:this,callback:this.SMBStatusHandler})},scope:this},name:"enable_cifs_pam"},{xtype:"syno_checkbox",boxLabel:_T("ldap","idmap_support"),disabled:!0,listeners:{enable:function(e){this.getForm().findField("enable_client").originalValue&&e.disable()},scope:this},name:"enable_idmap"},{xtype:"syno_checkbox",boxLabel:_T("directory_service","expand_nested_groups"),name:"expand_nested_groups"},{xtype:"syno_numberfield",indent:1,name:"nested_group_level",maxlength:2,value:9,fieldLabel:_T("directory_service","nested_groups_level")},{xtype:"syno_checkbox",id:Ext.id(),name:"tls_reqcert",boxLabel:_T("ldap","validate_server_certificate"),checked:!1,disabled:!0},{xtype:"syno_checkbox",boxLabel:_T("ldap","ldap_enable_client_certificate"),listeners:{scope:this,check:function(e,t,i){t&&this.afterLoad&&this.getForm().findField("enable_client_certificate").isDirty()&&this.findWindow().getMsgBox().alert(this.title,_T("ldap","ldap_client_certificate_note"))}},name:"enable_client_certificate"},{xtype:"syno_button",indent:1,id:this.btnUploadCertificate=Ext.id(),text:_T("ldap","ldap_upload_client_certificate"),scope:this,handler:this.uploadCertificateDialog}],i=Ext.apply({trackResetOnLoad:!0,fieldWidth:218,labelWidth:215,items:t},e);this.callParent([i])},initEvents:function(){this.callParent(arguments),this.mon(this,"activate",(function(){SYNO.API.GetKnownAPI("SYNO.Core.FileServ.SMB")?this.getForm().findField("enable_cifs_pam").enable():this.getForm().findField("enable_cifs_pam").disable(),this.getForm().findField("enable_cifs_pam").getValue()||this.getForm().findField("enable_cifs_pam").disable()})),this.mon(this,"afterlayout",(function(){this.enableGroup=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_client_certificate",[this.btnUploadCertificate]),this.enableGroup2=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"expand_nested_groups",["nested_group_level"]),SYNO.ux.AddWhiteTipWithItem(Ext.getCmp(this.getForm().findField("enable_cifs_pam").getEl().id),{xtype:"syno_displayfield",htmlEncode:!1,value:String.format(_T("ldap","smb_support_pam_tips"),'<a id="'+(this.cifs_pam_id=Ext.id())+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</a>"),listeners:{afterrender:function(e){this.mon(Ext.get(this.cifs_pam_id),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/file_directory_service_configuration.html"},!1)}))},scope:this}}),SYNO.ux.AddTip(this.getForm().findField("enable_idmap").getEl(),_T("ldap","idmap_support_tips")),SYNO.ux.AddTip(this.getForm().findField("enable_client_certificate").getEl(),_T("ldap","ldap_client_certificate_tips")),SYNO.ux.AddWhiteTipWithItem(Ext.getCmp(this.getForm().findField("ldap_schema").getEl().id),{xtype:"syno_displayfield",htmlEncode:!1,value:_T("ldap","ldap_schema_tips")}),SYNO.ux.AddWhiteTipWithItem(Ext.getCmp(this.getForm().findField("tls_reqcert").getEl().id),{xtype:"syno_displayfield",htmlEncode:!1,value:_T("ldap","tls_reqcert_tips")})}),this,{single:!0}),this.sendWebAPI({api:"SYNO.Core.FileServ.SMB",method:"get",params:{},version:3,scope:this,callback:function(e,t){this.SMBStatus=t.enable_samba}})},SMBStatusHandler:function(e,t){if(e){var i=[];this.SMBStatus=t.enable_samba,this.SMBStatus&&i.push(_T("ldap_error","ldap_smb2_enable_warning")),i.push(_T("ldap_error","ldap_cifs_pam_enabled")),this.owner.getMsgBox().alert(_T("directory_service","directory_service_title"),i.join("<br />"))}else this.SMBStatus=!1},load:function(){this.ldapData&&(this.getForm().setValues(this.ldapData),this.is_syno_server=this.ldapData.is_syno_server,this.afterLoadData=!0,"rfc2307"===this.getForm().findField("ldap_schema").getValue()&&this.getForm().findField("expand_nested_groups").disable()),this.afterLoad=!0},uploadCertificateDialog:function(){new SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util.UploadCADialog({module:this.module,owner:this.owner}).open()},afterBindWarning:function(){this.getForm().findField("enable_cifs_pam").getValue()&&(this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({api:"SYNO.Core.FileServ.SMB",method:"get",params:{},version:3,scope:this,callback:this.applyCIFSSetting}))},applyCIFSSetting:function(e,t){if(e){var i=[];i.push({api:"SYNO.Core.FileServ.SMB",method:"set",version:3,params:{enable_samba:t.enable_samba,smb_max_protocol:0,smb_min_protocol:0}}),i.push({api:"SYNO.Core.FileServ.ServiceDiscovery",method:"set",version:1,params:{enable_smb_time_machine:!1}}),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:i},scope:this,callback:this.afterApplyCIFSPam})}else{this.clearStatusBusy();var s=SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(t.code?t.code:2799);this.module.appWin.getMsgBox().alert(this.title,s)}},afterApplyCIFSPam:function(e,t,i,s){if(this.clearStatusBusy(),!e||t.has_fail){var n=SYNO.API.Response.GetFirstError(t),o=SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(n?n.code:2799);this.module.appWin.getMsgBox().alert(this.title,o)}},getApplyWebAPIs:function(e){var t=[];return e.enable_cifs_pam&&this.SMBStatus&&t.push({api:"SYNO.Core.FileServ.SMB",method:"set",version:3,params:{enable_samba:this.SMBStatus,smb_max_protocol:0,smb_min_protocol:0}},{api:"SYNO.Core.FileServ.ServiceDiscovery",method:"set",version:1,params:{enable_smb_time_machine:!1}}),t}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.SettingDialog",{extend:"SYNO.SDS.ModalWindow",generalPanel:null,advancePanel:null,constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=this.createTabPanel(e);var t={title:_T("common","common_settings"),width:720,minWidth:720,height:480,layout:"fit",buttons:[{text:_T("common","cancel"),scope:this,handler:this.close},{text:_T("common","save"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.panel]};Ext.apply(t,e),this.callParent([t]),this.mgmtModePanel&&(this.addManagedComponent(this.mgmtModePanel),this.mgmtModeVuePanel=this.mgmtModePanel._$vueInst)},createTabPanel:function(e){var t,i=[];if(e.domainData)this.directoryType="domain",this.generalPanel=new SYNO.SDS.AdminCenter.DirectoryService.DomainGeneralSetting({title:_T("common","general"),module:this.module,owner:this,domainData:e.domainData,itemId:"domainGeneralEdit"}),this.mgmtModePanel=this.createMgmtModeVuePanel(e.domainData),this.advancePanel=new SYNO.SDS.SMBService.Domain.OptionsForm({title:_T("common","advanced"),module:this.module,owner:this,domainEnable:!0,is_dc:e.domainData.enable_adserver,itemId:"domainAdvancedEdit"}),i=[this.generalPanel,this.mgmtModePanel,this.advancePanel];else{if(!e.ldapData)return this.directoryType="",null;this.directoryType="ldap",this.generalPanel=new SYNO.SDS.AdminCenter.DirectoryService.LDAPGeneralEdit({title:_T("common","general"),module:this.module,owner:this,ldapData:e.ldapData,itemId:"ldapGeneralEdit"}),this.advancePanel=new SYNO.SDS.AdminCenter.DirectoryService.LDAPAdvanceEdit({title:_T("common","advanced"),module:this.module,owner:this,ldapData:e.ldapData,itemId:"ldapAdvancedEdit"}),i=[this.generalPanel,this.advancePanel]}return t={activeTab:0,plain:!0,defaults:{height:310},useDefaultBtn:!1,items:i},new SYNO.SDS.Utils.TabPanel(t)},createMgmtModeVuePanel:function(e){return new SYNO.SDS.VuePanel({vueClass:SYNO.SDS.AdminCenter.DirectoryService.MgmtModePanel,mountId:"mgmt-mode-panel",title:_T("directory_service","domain_manage_mode"),layout:"fit",style:"padding: 8px 0 0",owner:this},{domainData:e,appWin:this})},getDirtyField:function(e){var t=e.getForm(),i=t.getValues();return i.kdc&&Ext.isArray(i.kdc)&&(i.kdc=t.findField("kdc").getValue()),t.items.each((function(e){e.isDirty()||delete i[e.name]})),e.itemUpdateComposite&&e.itemUpdateComposite.items.forEach((function(e){delete i[e.name]})),0===Object.keys(i).length?null:i},confirmDeselectDomain:async function(e){let t=!1,i=_T("directory_service","unselect_domain_confirm");return e.forEach((e=>{i+=`<li>${Ext.util.Format.htmlEncode(e)}</li>`})),await this.findAppWindow().getMsgBox().confirm("",i,null,{useHtml:!0}).then((e=>{"confirm"===e&&(t=!0)})),t},onApply:async function(){var e=[],t={};if(this.generalPanel.getForm().isValid()&&this.advancePanel.getForm().isValid())if(this.isTabsDirty()){if("domain"===this.directoryType){var i=this.getDirtyField(this.generalPanel),s=this.mgmtModeVuePanel.getDirtyField(),n=this.getDirtyField(this.advancePanel),o=this.mgmtModeVuePanel.getDeselectDomainList();if(i||s||n?(Ext.apply(t,i),Ext.apply(t,s),Ext.apply(t,n)):t=null,0!==o.length){if(!1===await this.confirmDeselectDomain(o))return}e=e.concat(this.mgmtModeVuePanel.getApplyWebAPIs(t))}else"ldap"===this.directoryType&&(Ext.apply(t,this.generalPanel.getForm().getValues()),Ext.apply(t,this.advancePanel.getForm().getValues()),t.enable_idmap=this.advancePanel.getForm().findField("enable_idmap").getValue(),t.enable_cifs_pam=this.advancePanel.getForm().findField("enable_cifs_pam").getValue());e=e.concat(this.generalPanel.getApplyWebAPIs(t)),this.advancePanel.getApplyWebAPIs&&(e=e.concat(this.advancePanel.getApplyWebAPIs(t))),0!==e.length?this.setApply(e,t):SYNO.Debug("have dirty but webapis empty. some setting wrong")}else this.close()},setApply:function(e,t){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},encryption:["bind_pw"],scope:this,callback:function(e,i,s){var n=_T("common","commfail");if(!e||i.has_fail)return t&&t.tls_reqcert&&(n=_T("ldap","err_connect_fail_with_tls_reqcert_enabled")),SYNO.Debug(i),this.clearStatusBusy(),void this.findAppWindow().getMsgBox().alert(this.title,n);if(this.module.panel.getComponent("directory").loadDirectoryService(),this.clearStatusBusy(),Ext.isFunction(this.generalPanel.isParamNeedCheck)&&this.generalPanel.isParamNeedCheck()){var o=SYNO.API.Response.GetValByAPI(i,"SYNO.Core.DirectoryServiceCheck.Common","get_stages");Ext.applyIf(t,this.domainData||this.ldapData||{}),Ext.isFunction(this.generalPanel.getExtraInfo)?this.generalPanel.getExtraInfo(this.launchPostTestDialog.bind(this,o),t):this.launchPostTestDialog(o,t)}this.doClose()}})},launchPostTestDialog:function(e,t){var i=this.domainData?"domain":this.ldapData?"ldap":null;new SYNO.SDS.AdminCenter.DirectoryService.PostTestDialog({module:this.module,owner:this.module.appWin,directoryType:i,testData:e,testParams:t}).open()},onClose:function(){return!1!==this.callParent(arguments)&&(!this.isTabsDirty()||(this.getMsgBox().confirm(_T("directory_service","directory_service_title"),_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.doClose()}),this),!1))},isTabsDirty:function(){return!(!this.generalPanel||!this.generalPanel.isFormDirty())||(!(!this.mgmtModeVuePanel||!this.mgmtModeVuePanel.isDirty())||!(!this.advancePanel||!this.advancePanel.isFormDirty()))},onOpen:function(e){this.callParent(arguments),this.generalPanel&&this.generalPanel.load(),this.advancePanel&&this.advancePanel.load()}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.ConfirmRetestDlg",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.callParent([this.fillConfig(e)])},fillConfig:function(e){let t={width:480,minHeight:120,autoHeight:!0,resizable:!1,draggable:!1,header:!1,cls:"x-window-dlg",padding:"24px 30px 0",elements:"body",items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("directory_service","retest_confirm")},{itemId:"notShowAgain",xtype:"syno_checkbox",checked:!1,boxLabel:_T("directory_service","no_retest_confirm_again")}],fbar:{items:[{xtype:"syno_button",text:_T("common","cancel"),btnStyle:"default",handler:this.noHandler,scope:this},{xtype:"syno_button",text:_T("common","continue"),btnStyle:"blue",handler:this.yesHandler,scope:this}]}};return Ext.apply(t,e)},yesHandler:function(){const e=this.getComponent("notShowAgain").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.AdminCenter.DirectoryService.PostTestDialog","hideConfirm",e),this.confirmCallback&&Ext.isFunction(this.confirmCallback.yes)&&this.confirmCallback.yes(),this.close()},noHandler:function(){this.confirmCallback&&Ext.isFunction(this.confirmCallback.no)&&this.confirmCallback.no(),this.close()}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.PostTestDialog",{extend:"SYNO.SDS.ModalWindow",initEvents:function(){this.callParent(arguments),this.mon(this,"beforeclose",this.onBeforeClosePostTest,this,{single:!0}),this.mon(this,"afterlayout",this.onAfterLayout,this,{single:!0})},constructor:function(e){this.module=e.module,this.owner=e.owner,this.statusBarPanel=this.createStatusBarPanel(e);var t={title:_T("directory_service","env_setting_test"),width:580,height:480,layout:"fit",resizable:!1,bodyStyle:{"padding-top":"12px"},buttons:[{text:_T("common","alt_close"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.close}],items:[this.statusBarPanel]};Ext.apply(t,e),this.callParent([t])},createStatusBarPanel:function(e){const t="domain"===e.directoryType?["dns","dc_ips"]:[];return new SYNO.SDS.AdminCenter.DirectoryService.StatusBarCmp.StatusBarPanel({module:this.module,forceExpanded:!1,statusBarWidth:490,testData:e.testData,testMode:"post",forceRetestFieldList:t,saveConfBeforeRetestFn:this.saveConfBeforeRetestFn.bind(this),allTestDoneCallback:this.allTestDoneCallback.bind(this)})},saveConfBeforeRetestFn:function(e,t,i,s){let n=[];"domain"===this.directoryType?(void 0!==t.dc_ips&&(Ext.isString(t.dc_ips)?t.kdc=t.dc_ips.toUpperCase():Ext.isArray(t.dc_ips)?t.kdc=t.dc_ips.join(",").toUpperCase():(SYNO.Debug("dc_ips is not string or array type."),t.kdc="")),n.push({api:"SYNO.Core.Directory.Domain.Conf",method:"set",version:"yes"===_D("support_hyper_converged")?3:2,params:t})):"ldap"===this.directoryType&&(n.push({api:"SYNO.Core.Directory.LDAP.Profile",method:"set",version:2,params:{name:t.profile}}),n.push({api:"SYNO.Core.Directory.LDAP",method:"set",version:2,params:t}));const o=()=>{this.sendWebAPI({compound:{stopwhenerror:!1,params:n},encryption:["bind_pw"],scope:this,callback:function(t,i,n){if(!t||i.has_fail)return SYNO.Debug("Failed to save config.",i),this.clearStatusBusy(),void e.getMsgBox().alert(null,_T("common","commfail"));s&&Ext.isFunction(s)&&s()}})},a=SYNO.SDS.UserSettings.getProperty("SYNO.SDS.AdminCenter.DirectoryService.PostTestDialog","hideConfirm");if(!i||a)o();else{const t={owner:this,confirmCallback:{yes:o,no:()=>{e.clearStatusBusy()}}};new SYNO.SDS.AdminCenter.DirectoryService.ConfirmRetestDlg(t).show()}},allTestDoneCallback:function(e){SYNO.Debug("All test done.",e),this.sendWebAPI({api:"SYNO.Core.DirectoryServiceCheck.Common",method:"set_last_test",version:1})},onBeforeClosePostTest:function(){const e=this.findAppWindow().activePage.getComponent("directory");return e&&e.loadDirectoryService(),!0},onAfterLayout:function(){SYNO.SDS.UserSettings.setProperty("SYNO.SDS.AdminCenter.DirectoryService.PostTestDialog","hideConfirm",!1),this.prepareParams()&&this.statusBarPanel.startTest(this.testParams)},prepareParams:function(){if(this.testParams.client_status&&delete this.testParams.client_status,"domain"===this.directoryType)this.settleDomainParams();else{if("ldap"!==this.directoryType)return this.getMsgBox().alert(this.title,_T("common","error_system"),(function(){this.close()}),this),!1;this.settleLDAPParams()}return!0},settleDomainParams:function(){this.testParams.domain_name&&(this.testParams.server_address=this.testParams.domain_name),this.testParams.kdc&&(this.testParams.dc_ips=this.testParams.kdc)},settleLDAPParams:function(){this.testParams.profile&&(this.testParams.name=this.testParams.profile),this.testParams.encryption&&("ssl"===this.testParams.encryption?this.testParams.port=636:this.testParams.port=389)}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.DirectoryTab",{extend:"SYNO.ux.Panel",initEvents:function(){this.callParent(arguments),this.mon(this,"activate",this.onTabActivate)},constructor:function(e){var t;this.module=e.module,this.owner=e.owner,this.itemId=e.itemId,this.isHCM="yes"===_D("support_hyper_converged","no"),this.isHCMAgent=this.isHCM&&!_S("sofs_is_controller"),this.noticeSystemChanged=!1,t=this.fillConfig(e),this.callParent([t]),this.loadDirectoryService()},fillConfig:function(e){var t={title:_T("directory_service","directory_service_title"),layout:"card",style:"padding-top: 0px",items:[]};return this.BeforeJoinForm=new SYNO.SDS.AdminCenter.DirectoryService.BeforeJoin({module:e.module,owner:e.owner,isHCMAgent:this.isHCMAgent,itemId:"BeforeJoin",listeners:{scope:this,joined:function(){this.noticeSystemChanged=!0,this.loadDirectoryService()}}}),this.AfterJoinForm=new SYNO.SDS.AdminCenter.DirectoryService.AfterJoin({module:e.module,owner:e.owner,isHCMAgent:this.isHCMAgent,itemId:"AfterJoin"}),t.items=[this.BeforeJoinForm,this.AfterJoinForm],t},onTabActivate:function(){var e=!1;this.owner.domainRunning?this.AfterJoinForm.domainData||(e=!0):this.owner.ldapRunning&&this.AfterJoinForm.ldapData||(e=!0),e&&this.loadDirectoryService()},dropData:function(){this.owner.domainRunning&&this.AfterJoinForm.setConnectionStatus("-"),this.AfterJoinForm.domainData=null,this.AfterJoinForm.ldapData=null},colorT:function(e,t){return String.format('<font class="{1}-status">{0}</font>',e,t||"black")},loadDirectoryService:function(){var e=[{api:"SYNO.Core.DirectoryServiceCheck.Common",method:"get_last_test",version:1},{api:"SYNO.Core.Directory.LDAP",method:"get",version:2}];SYNO.API.GetKnownAPI("SYNO.Core.Directory.Domain")&&e.push({api:"SYNO.Core.Directory.Domain",method:"get",version:1,params:{get:{additional:!0}}}),_S("is_admin")&&(e=e.concat({api:"SYNO.Core.Directory.SSO.IWA",method:"get",version:1})),this.module.appWin.setStatusBusy(),this.AfterJoinForm.setConnectionStatus(this.colorT(_T("directory_service","status_checking"),"blue")),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},scope:this,callback:this.processReturnData})},getLDAPConnectionStatus:function(e){var t,i;return!0===e.enable_client?(i=e.error||2799,t=this.colorT(SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(i),2702===i?"green":"red"),!0===e.is_syno_server&&(t+=" ("+_T("ldap","syno_server")+")"),2712===i&&(t=String.format(t,_T("ldap","base_dn")+" ("+e.base_dn+")"))):t=this.colorT(_T("common","disabled")),t},processReturnData:function(e,t,i){let s=this.noticeSystemChanged;if(this.noticeSystemChanged=!1,e){var n,o=!1,a=!1,r=this.AfterJoinForm.getComponent(this.AfterJoinForm.leaveBtnId),l=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","get");Ext.apply(l,SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.SSO.IWA","get"));var d=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.LDAP","get"),c=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.DirectoryServiceCheck.Common","get_last_test");if(this.info_store_data=[],c){const e=new Date(Number(c.last_test_time));c.last_test_time=Number.isNaN(e.getTime())?"-":SYNO.SDS.DateTimeFormatter(e),Ext.apply(l,c),Ext.apply(d,c)}if(!l&&!d)return SYNO.Debug("Error"),this.owner.updateTabs(a,o),void this.module.appWin.clearStatus();if(l&&(!0===l.enable_domain&&(o=!0,n={api:"SYNO.Core.Directory.Domain",method:"test_dc",version:1,scope:this,callback:this.processDomainConnectionStatus}),!0===l.enable_adserver?(r.disable(),r.setTooltip(_T("domain","warn_cant_leave_by_ad_mode"))):(r.enable(),r.setTooltip("")),s&&o&&this.module.appWin.getMsgBox().alert(_T("domain","systemchangenotice_title"),_T("domain","systemchangenotice_desc"),null,{useHtml:!0})),d&&!0===d.enable_client&&(a=!0),this.owner.updateTabs(a,o),a)d.client_status=this.getLDAPConnectionStatus(d),this.ldap_data=d,2702===(d.error||2799)?this.owner.setLdapUserGroupGrid(!0):this.owner.setLdapUserGroupGrid(!1);if(o){var h;const e=0===l.manage_mode?_T("helptoc","directory_service_domain"):_T("directory_service","organizational_unit");if(this.owner.manageMode=l.manage_mode,this.owner.primaryDomain=null===(h=l.advance_domain_conf)||void 0===h?void 0:h.netbios_name,this.owner.getComponent("domain_user").getTopToolbar().getComponent("filterName").setValue(e+_T("common","colon")),this.owner.getComponent("domain_group").getTopToolbar().getComponent("filterName").setValue(e+_T("common","colon")),this.AfterJoinForm.setData(l),r.setText(_T("directory_service","leave_domain")),"NT4"===l.domain_type){this.AfterJoinForm.getComponent(this.AfterJoinForm.testBtnId).disable();const e=_T("domain","nt4_not_support");this.AfterJoinForm.getComponent(this.AfterJoinForm.testBtnId).setTooltip(e),this.AfterJoinForm.setConnectionStatus(this.colorT(_T("domain","deprecated_nt4"),"red"))}}else a&&(this.AfterJoinForm.setData(d),r.setText(_T("directory_service","leave_ldap")));if(o||a){if(this.getLayout().setActiveItem(1),!_S("is_admin")){r.disable(),this.AfterJoinForm.getComponent(this.AfterJoinForm.editBtnId).disable(),this.AfterJoinForm.getComponent(this.AfterJoinForm.testBtnId).disable();const e=_T("directory_service","warn_delegate_user_cant_operate");r.setTooltip(e),this.AfterJoinForm.getComponent(this.AfterJoinForm.editBtnId).setTooltip(e),this.AfterJoinForm.getComponent(this.AfterJoinForm.testBtnId).setTooltip(e)}}else this.getLayout().setActiveItem(0);this.module.appWin.clearStatus(),n&&this.sendWebAPI(n)}else this.module.appWin.clearStatus()},processDomainConnectionStatus:function(e,t,i){this.AfterJoinForm&&this.AfterJoinForm.items&&0!==this.AfterJoinForm.items.length&&(this.AfterJoinForm.domainData&&"NT4"===this.AfterJoinForm.domainData.domain_type?this.AfterJoinForm.setConnectionStatus(this.colorT(_T("domain","deprecated_nt4"),"red")):e&&(!0===t.test_join_success?this.AfterJoinForm.setConnectionStatus(this.colorT(_T("network","status_connected"),"green")):this.AfterJoinForm.setConnectionStatus(this.colorT(_T("network","error_testjoin"),"red"))))}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.BeforeJoin",{extend:"SYNO.ux.Panel",constructor:function(e){var t;this.module=e.module,this.owner=e.owner,t=this.fillConfig(e),this.callParent([t])},initEvents:function(){this.callParent(arguments),this.addEvents(["joined"])},fillConfig:function(e){var t={title:_T("directory_service","directory_service_title"),layout:{type:"vbox",align:"center",pack:"center"},items:[]};return t.items.push({xtype:"label",name:"empty_domain_icon",cls:"syno-empty-domain-icon"},{xtype:"label",name:"notice_join_directory",text:e.isHCMAgent?_T("directory_service","sofs_notice_agent_join_directory"):_T("directory_service","notice_join_directory"),cls:"syno-directory-empty-text",margins:"20 0"},{xtype:"syno_button",name:"join_button",text:_T("directory_service","join"),btnStyle:"blue",style:{paddingLeft:20,paddingRight:20},hidden:e.isHCMAgent,disabled:!_S("is_admin"),scope:this,handler:this.launchDirectoryWizard}),Ext.apply(t,e),t},launchDirectoryWizard:function(){new SYNO.SDS.AdminCenter.DirectoryService.DirectoryWizard.Wizard({owner:this.module.appWin,module:this.module,listeners:{scope:this,finished:function(e,t){t.joined&&this.fireEvent("joined",this)}}}).open()}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.AfterJoin",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t;this.module=e.module,this.owner=e.owner,this.data=e.data,this.isHCMAgent=e.isHCMAgent,t=this.fillConfig(e),this.callParent([t])},getItems:function(e,t){return[{xtype:"syno_displayfield",fieldLabel:_T("ldap","ldap_server"),hidden:!t,name:"server_address"},{xtype:"syno_displayfield",fieldLabel:_T("network","wnds_domain"),hidden:!e,name:"domain_name"},{xtype:"syno_displayfield",fieldLabel:_T("network","domain_type"),hidden:!e,name:"domain_type"},{xtype:"syno_displayfield",fieldLabel:_T("directory_service","dns_server"),name:"dns"},{xtype:"syno_displayfield",fieldLabel:_T("network","domain_kdc_ip"),hidden:!e,name:"kdc",style:{"word-wrap":"break-word"}},{xtype:"syno_displayfield",fieldLabel:_T("directory_service","domain_manage_mode"),hidden:!e,name:"manage_mode"},{xtype:"syno_displayfield",fieldLabel:_T("network","enable_http_negotiate_dsm_7"),hidden:!e,name:"enable_http_negotiate"},{xtype:"syno_displayfield",fieldLabel:_T("ldap","base_dn"),hidden:!t,name:"base_dn"},{xtype:"syno_displayfield",fieldLabel:_T("ldap","security_type"),hidden:!t,name:"encryption"},{xtype:"syno_displayfield",fieldLabel:_T("ldap","profile_title"),hidden:!t,name:"profile"},{xtype:"syno_displayfield",fieldLabel:_T("tunnel","tunnel_status"),name:"client_status",value:"-",htmlEncode:!1},{xtype:"syno_displayfield",fieldLabel:_T("directory_service","last_test_time"),name:"last_test_time",value:"-"},{xtype:"syno_button",width:"auto",id:this.leaveBtnId=Ext.id(),scope:this,hidden:this.isHCMAgent,handler:this.leaveHandler},{xtype:"syno_button",width:"auto",id:this.editBtnId=Ext.id(),text:_T("common","common_settings"),scope:this,hidden:this.isHCMAgent,handler:this.editHandler},{xtype:"syno_button",width:"auto",id:this.testBtnId=Ext.id(),text:_T("directory_service","server_testing"),scope:this,hidden:this.isHCMAgent,handler:this.serverTestingHandler}]},fillConfig:function(e){this.items=this.getItems(e.domainRunning,e.LDAPRunning);var t={items:this.items};return Ext.apply(t,e),t},leaveHandler:function(){new SYNO.SDS.AdminCenter.DirectoryService.LeaveDialog({module:this.module,owner:this.module.appWin,domainData:this.domainData,ldapData:this.ldapData}).open()},editHandler:function(){new SYNO.SDS.AdminCenter.DirectoryService.SettingDialog({module:this.module,owner:this.module.appWin,domainData:this.domainData,ldapData:this.ldapData}).open()},serverTestingHandler:function(){var e,t,i;this.domainData?(i="domain",e="domain_posttest",t=this.domainData):this.ldapData&&(i="ldap",e="ldap_posttest",t=this.ldapData),this.findAppWindow().setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.DirectoryServiceCheck.Common",method:"get_stages",version:1,params:{type:e},callback:function(e,s,n){(this.findAppWindow().clearStatusBusy(),e)?new SYNO.SDS.AdminCenter.DirectoryService.PostTestDialog({module:this.module,owner:this.module.appWin,directoryType:i,testData:s,testParams:t}).open():this.findWindow().getMsgBox().alert(this.title,_T("common","error_system"))},scope:this})},setConnectionStatus:function(e){this.getForm().findField("client_status").setValue(e)},setData:function(e){var t,i,s,n,o=["domain_name","domain_type","dns","manage_mode","kdc","enable_http_negotiate"],a=["server_address","base_dn","encryption","profile"],r=Object.assign({},e,{enable_http_negotiate:e.enable_http_negotiate?_T("directory_service","enabled"):_T("common","disabled")});if((i=this.getForm()).setValues(r),e.advance_domain_conf&&e.advance_domain_conf.kdc&&(e.kdc=e.advance_domain_conf.kdc,i.findField("kdc").setValue(e.kdc.toUpperCase())),0===e.manage_mode?i.findField("manage_mode").setValue(_T("directory_service","trust_domain_mode")):1===e.manage_mode&&i.findField("manage_mode").setValue(_T("directory_service","domain_ou_mode")),e.encryption&&("no"===e.encryption?i.findField("encryption").setValue(_T("ldap","no_ssl")):"ssl"===e.encryption?i.findField("encryption").setValue(_T("ldap","with_ssl")):"start_tls"===e.encryption&&i.findField("encryption").setValue(_T("ldap","with_tls"))),e.profile&&i.findField("profile").setValue(_T("ldap","profile_"+e.profile)),e.enable_domain){this.domainData=e,this.ldapData=null,s=o,n=a;const t=i.findField("enable_http_negotiate").getEl();if(t){const e=`<a href="${_T("network","iwa_help_url")}" target="_blank" class="link-font" tabindex="0" role="link" style="cursor:pointer">${_T("common","learn_more")}</a>`,i=String.format(_T("network","http_negotiate_iwa_info"),e);SYNO.ux.AddTip(t,i)}}else{if(!e.enable_client)return;this.domainData=null,this.ldapData=e,s=a,n=o}for(t=0;t<s.length;t++)i.findField(s[t]).show();for(t=0;t<n.length;t++)i.findField(n[t]).hide();e.kdc||i.findField("kdc").hide()}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.SSOTab",{extend:"SYNO.SDS.Utils.FormPanel",DEFAULT_WIDTH:365,ValidURL:function(e){var t=e.replace(/https?:\/\/\[/i,"").replace(/\].*$/,"");return!1!==/^(https?):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:(?:6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[1-9][0-9]{1,3}|[0-9]))?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)||!1!==/((^https?):\/\/([a-z]|\d|-|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*)(:(?:6553[0-5]|655[0-2][0-9]|65[0-4][0-9]{2}|6[0-4][0-9]{3}|[1-5][0-9]{4}|[1-9][0-9]{1,3}|[0-9]))?$/i.test(e)||!1!==Ext.form.VTypes.v6ipVal.test(t)||_T("error","error_bad_field")},getFieldSetSyno:function(){return[{xtype:"syno_checkbox",boxLabel:_T("sso","enable"),name:"enable_sso",listeners:{scope:this,check:function(e,t,i){t&&""!==this.getForm().findField("host").getValue()?this.synologyInfoBox.show():this.synologyInfoBox.hide(),this.doLayout()}}},{xtype:"syno_textfield",name:"host",hideLabel:!0,hidden:!0},{xtype:"syno_button",cls:"sso-setup-btn",width:"auto",indent:1,id:this.btnSynologySsoAdvance=Ext.id(),text:_T("sso","sso_synology_settings"),scope:this,handler:this.openSynoProfileDialog},{xtype:"box",data:{},id:this.synologyInfoBoxId=Ext.id(),hidden:!0,tpl:new Ext.XTemplate('<div class="syno_sso_openid_info_container last"><div><div class="content" tabIndex="0" aria-labelledby="{this.sso_name_label} {this.sso_name}"><span id="{this.sso_name_label}" class="title normal-font">'+_T("common","name")+':</span><span id="{this.sso_name}" class="info normal-font" style="text-decoration: none">{sso_name:htmlEncode}</span></div><div class="content" tabIndex="0" aria-labelledby="{this.sso_domain_label} {this.sso_domain}"><span id="{this.sso_name_label}" class="title normal-font">'+_T("sso","server_name")+':</span><span id="{this.sso_domain}" class="info normal-font" style="text-decoration: none">{sso_domain:htmlEncode}</span></div></div></div>',{sso_name_label:Ext.id(),sso_name:Ext.id(),sso_domain_label:Ext.id(),sso_domain:Ext.id()})}]},getFieldSetOIDC:function(){return[{xtype:"syno_checkbox",boxLabel:_T("sso","oidc_enable"),listeners:{scope:this,check:function(e,t,i){t&&""!==this.getForm().findField("sso_profile").getValue()?this.infoBox.show():this.infoBox.hide(),this.doLayout()}},name:"sso_enable"},{xtype:"syno_textfield",fieldLabel:"sso_profile",name:"sso_profile",hideLabel:!0,hidden:!0},{xtype:"syno_button",cls:"sso-setup-btn",width:"auto",indent:1,id:this.btnProfileAdvance=Ext.id(),text:_T("sso","sso_oidc_settings"),scope:this,handler:this.onProfileBtnClick},{xtype:"box",data:{},id:this.infoBoxId=Ext.id(),hidden:!0,tpl:new Ext.XTemplate('<div class="syno_sso_openid_info_container"><div><div class="content" tabIndex="0" aria-labelledby="{this.sso_name_label} {this.sso_name}"><span id="{this.sso_name_label}" class="title normal-font">'+_T("common","name")+':</span><span id="{this.sso_name}" class="info normal-font" style="text-decoration: none">{sso_name:htmlEncode}</span></div><div class="content" tabIndex="0" aria-labelledby="{this.sso_domain_label} {this.sso_domain}"><span id="{this.sso_name_label}" class="title normal-font">'+_T("sso","server_name")+':</span><span id="{this.sso_domain}" class="info normal-font" style="text-decoration: none">{sso_domain:htmlEncode}</span></div><div class="content {sso_error_class:htmlEncode}" tabIndex="0" aria-labelledby="{this.sso_domain_label} {this.sso_error}"><span id="{this.sso_error_label}" class="title normal-font"></span><span id="{this.sso_error}" class="error normal-font" style="text-decoration: none">{sso_error:htmlEncode}</span></div></div></div>',{sso_name_label:Ext.id(),sso_name:Ext.id(),sso_domain_label:Ext.id(),sso_domain:Ext.id(),sso_error_label:Ext.id(),sso_error:Ext.id(),sso_error_class:Ext.id()})}]},getFieldSetSAML:function(){return[{xtype:"syno_checkbox",boxLabel:_T("sso","saml_enable"),listeners:{scope:this,check:function(e,t,i){t&&""!==this.getForm().findField("saml_idp_signin_url").getValue()?this.SAMLInfoBox.show():this.SAMLInfoBox.hide(),this.doLayout()}},name:"sso_saml_enable"},{xtype:"syno_textfield",fieldLabel:"saml_idp_signin_url",name:"saml_idp_signin_url",hideLabel:!0,hidden:!0},{xtype:"syno_button",cls:"sso-setup-btn",width:"auto",indent:1,id:this.btnSAMLAdvance=Ext.id(),text:_T("sso","sso_saml_settings"),scope:this,handler:this.onSAMLSettingBtnClick},{xtype:"box",data:{},name:"saml_info_box",id:this.SAMLInfoBoxId=Ext.id(),hidden:!0,tpl:new Ext.XTemplate('<div class="syno_sso_saml_info_container"><div><div class="content" tabIndex="0" aria-labelledby="{this.saml_name_label} {this.saml_name_label}"><span id="{this.saml_name_label}" class="title normal-font">'+_T("common","name")+':</span><span id="{this.saml_name}" class="info normal-font" style="text-decoration: none">{saml_name:htmlEncode}</span></div><div class="content" tabIndex="0" aria-labelledby="{this.saml_idp_signin_url_label} {this.saml_idp_signin_url}"><span id="{this.saml_idp_signin_url_label}" class="title normal-font">'+_T("sso","server_name")+':</span><span id="{this.saml_idp_signin_url}" class="info normal-font" style="text-decoration: none">{saml_idp_signin_url:htmlEncode}</span></div><div class="content" tabIndex="0" aria-labelledby="{this.saml_idp_certificate_label} {this.saml_idp_certificate_common_nam}"><span id="{this.saml_idp_certificate_label}" class="title normal-font">'+_T("sso","saml_certificate")+':</span><span id="{this.saml_valid_date}" class="info normal-font" style="text-decoration: none">{saml_idp_certificate_common_name:htmlEncode} - {saml_valid_date:htmlEncode}<span id="{this.saml_idp_certificate_expired}" class="normal-font error" style="padding-left:5px;"> {saml_idp_certificate_expired:htmlEncode}</span></span></div></div></div>',{saml_name_label:Ext.id(),saml_name:Ext.id(),saml_idp_signin_url_label:Ext.id(),saml_idp_signin_url:Ext.id(),saml_idp_certificate_label:Ext.id(),saml_idp_certificate_common_name:Ext.id(),saml_idp_certificate_expired:Ext.id()})}]},getFieldSetCAS:function(){return[{xtype:"syno_checkbox",boxLabel:_T("sso","cas_enable"),listeners:{scope:this,check:function(e,t,i){t&&""!==this.getForm().findField("cas_auth_url").getValue()?this.CASInfoBox.show():this.CASInfoBox.hide(),this.doLayout()}},name:"sso_cas_enable"},{xtype:"syno_textfield",name:"cas_auth_url",hideLabel:!0,hidden:!0},{xtype:"syno_button",cls:"sso-setup-btn",width:"auto",indent:1,id:this.btnCASAdvance=Ext.id(),text:_T("sso","sso_cas_settings"),scope:this,handler:this.onCASSettingBtnClick},{xtype:"box",data:{},name:"cas_info_box",id:this.CASInfoBoxId=Ext.id(),tpl:new Ext.XTemplate('<div class="syno_sso_cas_info_container"><div><div class="content" tabIndex="0" aria-labelledby="{this.cas_name_label} {this.cas_name}"><span id="{this.cas_name_label}" class="title normal-font">'+_T("common","name")+':</span><span id="{this.cas_name}" class="info normal-font url-link" style="text-decoration: none">{cas_name:htmlEncode}</span></div><div class="content" tabIndex="0" aria-labelledby="{this.cas_auth_url_label} {this.cas_auth_url}"><span id="{this.cas_auth_url_label}" class="title normal-font">'+_T("sso","server_name")+':</span><span id="{this.cas_auth_url}" class="info normal-font url-link" style="text-decoration: none">{cas_auth_url:htmlEncode}</span></div></div></div>',{cas_name_label:Ext.id(),cas_name:Ext.id(),cas_auth_url_label:Ext.id(),cas_auth_url:Ext.id()}),hidden:!0}]},constructor:function(e){this.err_msg=null;var t=Ext.apply({title:_T("sso","title"),trackResetOnLoad:!0,cls:"sso-tab-panel",hideMode:"offsets",items:[{xtype:"syno_displayfield",name:"sso_client_desc",htmlEncode:!1,value:_T("sso","sso_client_desc")},{xtype:"syno_fieldset",title:_T("sso","login_page"),items:[{xtype:"syno_checkbox",boxLabel:_T("sso","sso_default_login"),name:"sso_default_login"}]},{xtype:"syno_fieldset",title:_T("sso","services"),items:[].concat(this.getFieldSetOIDC(),this.getFieldSetSAML(),this.getFieldSetCAS(),this.getFieldSetSyno())}]},e);this.callParent([t]),this.infoBox=Ext.getCmp(this.infoBoxId),this.SAMLInfoBox=Ext.getCmp(this.SAMLInfoBoxId),this.CASInfoBox=Ext.getCmp(this.CASInfoBoxId),this.synologyInfoBox=Ext.getCmp(this.synologyInfoBoxId)},initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){this.enableGroup=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_sso",[this.btnSynologySsoAdvance]),this.enableSAMLGroup=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"sso_saml_enable",[this.btnSAMLAdvance]),this.enableCASGroup=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"sso_cas_enable",[this.btnCASAdvance]),this.azureSSOGroup=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"sso_enable",["sso_profile",this.btnProfileAdvance])}),this,{single:!0});var e=this.owner.buttons.find((function(e){return e.text&&e.text===_T("common","commit")}));this.mon(e,"click",this.onApplyBtnClick,this)},onApplyBtnClick:function(){var e=this.getForm();if(e.isDirty())if(e.isValid()){var t=this.getForm().findField("sso_enable").getValue(),i=this.getForm().findField("sso_profile").getValue().trim();if(t&&""===i)this.module.appWin.getMsgBox().confirm(this.title,_T("sso","profile_confirm")).then((e=>{"confirm"===e&&this.openProfileDialog(i)}),this);else{var s=this.getForm().findField("sso_saml_enable").getValue(),n=this.getForm().findField("saml_idp_signin_url").getValue().trim();if(s&&""===n)this.module.appWin.getMsgBox().confirm(this.title,_T("sso","profile_confirm")).then((e=>{"confirm"===e&&this.openSAMLProfileDialog(null)}));else{var o=this.getForm().findField("sso_cas_enable").getValue(),a=this.getForm().findField("cas_auth_url").getValue().trim();if(o&&""===a)this.module.appWin.getMsgBox().confirm(this.title,_T("sso","profile_confirm")).then((e=>{"confirm"===e&&this.openCASProfileDialog(null)}));else{var r=this.getForm().findField("enable_sso").getValue(),l=this.getForm().findField("host").getValue().trim();if(r&&""===l)this.module.appWin.getMsgBox().confirm(this.title,_T("sso","profile_confirm")).then((e=>{"confirm"===e&&this.openSynoProfileDialog()}));else{this.isVisible()&&this.module.panel.setStatusBusy({text:_T("common","saving")});var d=[{api:"SYNO.Core.Directory.SSO.Setting",method:"set",version:1,params:{sso_default_login:e.findField("sso_default_login").getValue()}},{api:"SYNO.Core.Directory.SSO.Status",method:"set",version:1,params:{enabled:e.findField("enable_sso").getValue()}},{api:"SYNO.Core.Directory.SSO.Profile",method:"set",version:1,params:e.getValues()},{api:"SYNO.Core.Directory.SSO.SAML.Status",method:"set",version:1,params:{sso_saml_enable:e.findField("sso_saml_enable").getValue()}},{api:"SYNO.Core.Directory.SSO.CAS",method:"set",version:1,params:{sso_cas_enable:e.findField("sso_cas_enable").getValue()}},{api:"SYNO.Core.Directory.SSO",method:"get",version:2},{api:"SYNO.Core.Directory.SSO.Profile",method:"get",version:1},{api:"SYNO.Core.Directory.SSO.SAML",method:"get",version:1},{api:"SYNO.Core.Directory.SSO.Setting",method:"get",version:1},{api:"SYNO.Core.Directory.SSO.CAS",method:"get",version:1}];this.sendWebAPI({compound:{params:d},scope:this,callback:this.afterApplyDone})}}}}}else this.isVisible()&&this.module.panel.setStatusError({text:_T("common","forminvalid"),clear:!0});else this.module.panel.getActiveTab()===this&&this.module.panel.setStatusError({text:_T("error","nochange_subject"),clear:!0})},onBeforeRequest:function(e){return"set"!==e},afterApplyDone:function(e,t,i){if(this.module.panel.clearStatusBusy(),e){return this.processReturnData(null,t,i),void this.module.panel.setStatusOK()}this.module.panel.setStatusError()},openProfileDialog:function(e){const{window:t}=this.module.appWin.openModalWindow(SYNO.SDS.AdminCenter.DirectoryService.SelectOidcProfileDialog,{profile:e,domainRunning:!(this.owner&&!this.owner.domainRunning)});t.$on("reload",(e=>{this.getForm().findField("sso_profile").setValue(e),this.module.panel.setStatusBusy(),this.getSSOProfileInfo(e,!0)}),this,{single:!0})},onProfileBtnClick:function(){var e=this.getForm().findField("sso_profile").getValue().trim();this.openProfileDialog(e)},openSynoProfileDialog:function(){const{window:e}=this.module.appWin.openModalWindow(SYNO.SDS.AdminCenter.DirectoryService.SynologySsoProfileDialog,{});e.$on("reload",(()=>{this.getSSOSynoProfileInfo()}),this,{single:!0})},onSAMLSettingBtnClick:function(){this.openSAMLProfileDialog(null)},openSAMLProfileDialog:function(e){const{window:t}=this.module.appWin.openModalWindow(SYNO.SDS.AdminCenter.DirectoryService.SamlProfileDialog,{});t.$on("reload",(()=>{this.getSSOSAMLProfileInfo(this.updateSSOSAMLinfoBoxCallback)}),this,{single:!0})},onCASSettingBtnClick:function(){this.openCASProfileDialog(null)},openCASProfileDialog:function(e){const{window:t}=this.module.appWin.openModalWindow(SYNO.SDS.AdminCenter.DirectoryService.CASProfileDialog,{});t.$on("reload",((e,t)=>{this.getForm().findField("cas_auth_url").setValue(e),this.updateSSOCASinfoBox({cas_name:t,cas_auth_url:e}),this.CASInfoBox.show()}),this,{single:!0})},processParams:function(e,t){return t=(t=(t=(t=(t=t.concat({api:"SYNO.Core.Directory.SSO.Setting",method:"get",version:1})).concat({api:"SYNO.Core.Directory.SSO",method:"get",version:2})).concat({api:"SYNO.Core.Directory.SSO.Profile",method:"get",version:1})).concat({api:"SYNO.Core.Directory.SSO.SAML",method:"get",version:1})).concat({api:"SYNO.Core.Directory.SSO.CAS",method:"get",version:1})},processReturnData:function(e,t,i){if(this.callParent(arguments),t.result){var s={api:"SYNO.Core.Directory.SSO.Setting",method:"get",version:1},n={api:"SYNO.Core.Directory.SSO",method:"get",version:2},o={api:"SYNO.Core.Directory.SSO.Profile",method:"get",version:1},a={api:"SYNO.Core.Directory.SSO.SAML",method:"get",version:1},r={api:"SYNO.Core.Directory.SSO.CAS",method:"get",version:1};Ext.each(t.result,(function(e,t){!0===SYNO.ux.Utils.checkApiConsistency(s,e)?this.getForm().setValues({sso_default_login:e.data.sso_default_login}):!0===SYNO.ux.Utils.checkApiConsistency(n,e)?(this.getForm().setValues({enable_sso:e.data.enable_sso,host:e.data.host}),e.data.enable_sso?this.synologyInfoBox.show():this.synologyInfoBox.hide(),this.updateSSOSynologyInfoBox(e.data)):!0===SYNO.ux.Utils.checkApiConsistency(o,e)?(this.getForm().setValues({sso_enable:e.data.sso_enable,sso_profile:e.data.sso_profile}),e.data.sso_enable||this.infoBox.hide(),this.doLayout(),this.getSSOProfileInfo(e.data.sso_profile,!1)):!0===SYNO.ux.Utils.checkApiConsistency(a,e)?(this.getForm().setValues({sso_saml_enable:e.data.sso_saml_enable,saml_name:e.data.saml_name,saml_idp_entity_id:e.data.saml_idp_entity_id,saml_idp_signin_url:e.data.saml_idp_signin_url}),e.data.sso_saml_enable?this.SAMLInfoBox.show():this.SAMLInfoBox.hide(),this.updateSSOSAMLinfoBox(e.data)):1==SYNO.ux.Utils.checkApiConsistency(r,e)&&(this.getForm().setValues({sso_cas_enable:e.data.sso_cas_enable,cas_auth_url:e.data.cas_auth_url}),this.updateSSOCASinfoBox(e.data),e.data.sso_cas_enable?this.CASInfoBox.show():this.CASInfoBox.hide())}),this)}},checkExit:function(){this.module.confirmLostChangeResolve&&this.module.confirmLostChangeResolve()},setSSODisplayFields:function(e,t){var i={};switch(e){case"azure":i={sso_client_id:t.azure_client_id,sso_token_endpoint:t.azure_token_endpoint,sso_auth_endpoint:t.azure_authorization_endpoint,sso_redirect_uri:t.azure_redirect_uri,sso_server:t.azure_authorization_endpoint,sso_name:_T("sso","profile_"+e)};break;case"websphere":i={sso_client_id:t.websphere_client_id,sso_token_endpoint:t.websphere_token_endpoint,sso_auth_endpoint:t.websphere_authorization_endpoint,sso_redirect_uri:t.websphere_redirect_uri,sso_server:t.websphere_oidc_host,sso_name:_T("sso","profile_"+e)};break;case"oidc":i={sso_client_id:t.oidc_client_id,sso_token_endpoint:t.oidc_token_endpoint,sso_auth_endpoint:t.oidc_authorization_endpoint,sso_redirect_uri:t.oidc_redirect_uri,sso_server:t.oidc_wellknown,sso_name:t.oidc_name}}let s="oidc"===e&&""===t.oidc_token_endpoint?_T("sso","error_cannot_verify_server"):"",n=i.sso_server;try{n=new URL(i.sso_server).origin}catch(e){SYNO.Debug.error(e)}this.infoBox.show(),this.infoBox.update({sso_name:i.sso_name,sso_domain:n,sso_error:s,sso_error_class:""===s?"hide":""}),this.doLayout()},updateSSOSAMLinfoBoxCallback:function(e,t,i){e?(this.getForm().setValues({saml_idp_signin_url:t.saml_idp_signin_url}),this.updateSSOSAMLinfoBox(t)):this.module.appWin.getMsgBox().alert(this.title,SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(t.code))},updateSSOSAMLinfoBox:function(e){var t=new Date(e.saml_valid_date),i=new Date(e.saml_system_date),s="";e.saml_cert_detail&&e.saml_cert_detail.common_name&&(s=e.saml_cert_detail.common_name);const n={saml_name:e.saml_name,saml_idp_entity_id:e.saml_idp_entity_id,saml_idp_signin_url:e.saml_idp_signin_url,saml_idp_certificate_common_name:s,saml_valid_date:e.saml_valid_date?e.saml_valid_date:"",saml_idp_certificate_expired:i>t?"("+_T("license","license_status_expire_string")+")":""};e.sso_saml_enable&&this.SAMLInfoBox.show();let o=n.saml_idp_signin_url;if(""!==n.saml_idp_signin_url)try{o=new URL(n.saml_idp_signin_url).origin}catch(e){SYNO.Debug.error(e)}this.SAMLInfoBox.update({saml_name:n.saml_name,saml_idp_entity_id:n.saml_idp_entity_id,saml_idp_signin_url:o,saml_idp_certificate_common_name:n.saml_idp_certificate_common_name,saml_valid_date:n.saml_valid_date,saml_idp_certificate_expired:n.saml_idp_certificate_expired}),this.doLayout()},updateSSOSynologyInfoBox:function(e){var t=e.host;if(""!==t)try{t=new URL(e.host).origin}catch(e){SYNO.Debug.error(e)}this.synologyInfoBox.update({sso_name:e.name,sso_domain:t}),this.doLayout()},updateSSOCASinfoBox:function(e){var t=e.cas_auth_url;if(""!==t)try{t=new URL(e.cas_auth_url).origin}catch(e){SYNO.Debug.error(e)}this.CASInfoBox.update({cas_auth_url:t,cas_name:e.cas_name}),this.doLayout()},alert:function(e,t){this.module.appWin.getMsgBox().alert(e,t,(function(){this.checkExit()}),this)},getSSOProfileRender:function(){return new SYNO.SDS.AdminCenter.DirectoryService.Util.ArrayReader({root:"profiles",fields:["value","display"],createArrayElement:function(e){return{value:e,display:_T("sso","profile_"+e)||e}}})},getSSOProfileInfo:function(e,t){var i=null;switch(e){case"azure":i="SYNO.Core.Directory.Azure.SSO";break;case"websphere":i="SYNO.Core.Directory.WebSphere.SSO";break;case"oidc":i="SYNO.Core.Directory.OIDC.SSO"}null!==i&&this.sendWebAPI({api:i,method:"get",version:1,callback:function(i,s,n){t&&this.module.panel.clearStatusBusy(),i?this.setSSODisplayFields(e,s):this.module.appWin.getMsgBox().alert(this.title,SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(s.code))},scope:this})},getSSOSAMLProfileInfo:function(e){this.sendWebAPI({api:"SYNO.Core.Directory.SSO.SAML",method:"get",version:1,callback:e,scope:this})},getSSOSynoProfileInfo:function(){this.module.panel.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Directory.SSO",method:"get",version:2,callback:function(e,t,i){this.module.panel.clearStatusBusy(),e?(this.getForm().setValues({host:t.host}),this.synologyInfoBox.show(),this.updateSSOSynologyInfoBox(t)):this.module.appWin.getMsgBox().alert(this.title,SYNO.SDS.AdminCenter.DirectoryService.Util.GetErrMsg(t.code))},scope:this})}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util.UpdateButton",{extend:"SYNO.ux.Button",constructor:function(e){var t=Ext.apply({text:_T("ldap","update_ldap_data"),scope:this,handler:this.refresh},e);this.callParent([t])},startPolling:function(){Ext.isDefined(this.pollingId)||(this.pollingId=this.pollReg({interval:5,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Directory.LDAP.Refresh",method:"get_status",version:1},status_callback:function(e,t,i){t.ready?(!0===this.need_reload&&this.grid.getStore().reload(),this.need_reload=!1,this.setText(_T("ldap","update_ldap_data")),this.enable()):(this.need_reload=!0,this.setText(_T("update","updating")),this.disable())}}))},stopPolling:function(){Ext.isDefined(this.pollingId)&&(this.pollUnreg(this.pollingId),delete this.pollingId,delete this.need_reload)},refresh:function(){this.disable(),this.setText(_T("update","updating")),this.need_reload=!0,this.sendWebAPI({api:"SYNO.Core.Directory.LDAP.Refresh",method:"start",version:1,callback:function(e,t,i,s){e||this.enable()},scope:this})}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util.UploadCADialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.module=e.module,this.panel=this.createPanel();var t={title:_T("ldap","ldap_upload_client_certificate_title"),layout:"fit",width:600,height:230,buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.close},{xtype:"syno_button",btnStyle:"blue",text:_T("ldap","upload"),itemId:"apply",scope:this,disabled:!0,handler:this.onSubmit}],items:[this.panel]};Ext.apply(t,e),this.callParent([t]),this.defineBehaviors()},createPanel:function(){var e={border:!1,webapi:{api:"SYNO.Core.Directory.LDAP",version:1,methods:{set:"upload_certificate"}},fileUpload:!0,items:[{xtype:"syno_filebutton",fieldLabel:_T("service","service_ssl_crt"),name:"filename_crt",listeners:{scope:this,change:this.onImportFilePathChanged},value:""},{xtype:"syno_filebutton",fieldLabel:_T("service","service_ssl_key"),name:"filename_key",listeners:{scope:this,change:this.onImportFilePathChanged},value:""}]};return new SYNO.SDS.Utils.FormPanel(e)},defineBehaviors:function(){this.mon(this.panel.getForm(),"actioncomplete",this.onFormSuccess,this),this.mon(this.panel.getForm(),"actionfailed",this.onFormFailed,this),this.btnUpload=this.getFooterToolbar().getComponent("apply")},onImportFilePathChanged:function(e,t){""!==this.panel.getForm().findField("filename_crt").getValue()&&""!==this.panel.getForm().findField("filename_key").getValue()&&this.btnUpload.enable()},onFormSuccess:function(e,t){this.clearStatusBusy(),t.result.success&&this.close()},onFormFailed:function(e,t){this.clearStatusBusy(),this.getMsgBox().alert(_T("user","user_upload"),"upload file failed")},onSubmit:function(){this.setStatusBusy(),this.panel.getForm().doAction("apply")}}),Ext.ns("SYNO.SDS.AdminCenter.DirectoryService"),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.owner=e.appWin,this.appWin=e.appWin,this.app=e.app,this.callParent([e]),this.panel=new SYNO.SDS.AdminCenter.DirectoryService.TabPanel({module:this})},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"domain":case"ldap":return"AdminCenter/file_directory_service_join.html";case"domain_user":case"domain_group":case"ldap_user":case"ldap_group":return"AdminCenter/file_directory_service_user_group.html";case"sso":return"AdminCenter/file_directory_service_sso.html";default:return"AdminCenter/file_directory_service_desc.html"}},getPanel:function(){return this.panel},setActivateParams:function(e){e&&e.tab&&this.panel.setActiveTab(e.tab)},activate:function(e){this.panel.resetAllForm(),this.setActivateParams(e),this.panel.loadAllForm()},deactivate:function(){var e=this.panel.getComponent("sso");return(!e||!e.getForm().isDirty())&&(this.panel.getComponent("directory").dropData(),this.panel.getEl().unmask(),!0)},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmLostChangeResolve=e,this.panel.getComponent("sso").onApplyBtnClick()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.DirectoryService.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",initEvents:function(){this.callParent(arguments),this.mon(this.getComponent("domain_user"),"activate",(function(){this.getComponent("domain_user").activate(),this.startPollingDbStatus()}),this),this.mon(this.getComponent("domain_group"),"activate",(function(){this.startPollingDbStatus()}),this),this.mon(this.getComponent("ldap_user"),"activate",(function(){this.getComponent("ldap_user").activate()}),this),this.mon(this,"deactivate",(function(){this.stopPollingDbStatus()}),this),this.mon(this,"tabchange",(function(e,t){"domain_user"!==t.itemId&&"domain_group"!==t.itemId&&this.stopPollingDbStatus()})),this.userDomainFilter.addListener("filterchanged",this.onDomainFilterSelect,this),this.groupDomainFilter.addListener("filterchanged",this.onDomainFilterSelect,this);const e=function(){this.domainDbStatus[this.currDomain]="syncing",this.updateSyncButton(),this.updateDbStatusBar()};this.userUpdateBtn.addListener("syncdb",e,this),this.groupUpdateBtn.addListener("syncdb",e,this),this.dbStatusBar.addListener("hidebar",this.onDbStatusBarClose,this)},constructor:function(e){var t;this.domainRunning=!1,this.ldapRunning=!1,this.domainDbStatus={},this.module=e.module,t=Ext.apply({activeTab:0,items:[]},e),this.callParent([t])},initComponent:function(){this.isHCM="yes"===_D("support_hyper_converged","no"),this.items.push(new SYNO.SDS.AdminCenter.DirectoryService.DirectoryTab({module:this.module,owner:this,itemId:"directory"}));const e={emptyText:['<div class="syno-dataview">','<div class="empty-text-wrap">','<div class="empty-text-inner-wrap">','<div class="empty-text-icon"></div>','<div class="empty-text">',_T("common","no_item"),"</div>","</div>","</div>","</div>"].join("")};"yes"===_D("supportdomain","no")&&(this.userStatusBar=new SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.DbStatusBar({}),this.groupStatusBar=new SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.DbStatusBar({}),this.dbStatusBar=Ext.apply(this.dbStatusBar,{userStatusBar:this.userStatusBar,groupStatusBar:this.groupStatusBar}),this.items.push(this.userGridPanel=new SYNO.SDS.AdminCenter.User.UserListGrid({title:_T("directory_service","domain_user_tab"),appWin:this.module.owner,owner:this.module.owner,module:this.module,itemId:"domain_user",authType:"domain",cls:"syno-directory-service-user-group-gridpanel",viewConfig:e,homeButton:new SYNO.SDS.AdminCenter.DirectoryService.Util.HomeButton({module:this.module,appWin:this.module.owner,authType:"domain"}),updateButton:this.userUpdateBtn=new SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.UpdateButton({module:this.module,appWin:this.module.owner,panel:this}),domainFilter:this.userDomainFilter=new SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.Filter({module:this.module}),statusBar:this.userStatusBar}),this.groupGridPanel=new SYNO.SDS.AdminCenter.Group.GridPanel({title:_T("directory_service","domain_group_tab"),module:this.module,itemId:"domain_group",authType:"domain",cls:"syno-directory-service-user-group-gridpanel",viewConfig:e,updateButton:this.groupUpdateBtn=new SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.UpdateButton({module:this.module,appWin:this.module.owner,panel:this}),domainFilter:this.groupDomainFilter=new SYNO.SDS.AdminCenter.DirectoryService.Domain.Util.Filter({module:this.module}),statusBar:this.groupStatusBar}))),this.items.push(new SYNO.SDS.AdminCenter.User.UserListGrid({title:_T("directory_service","ldap_user_tab"),appWin:this.module.owner,owner:this.module.owner,module:this.module,itemId:"ldap_user",disabled:!0,authType:"ldap",cls:"syno-directory-service-user-group-gridpanel",viewConfig:e,homeButton:new SYNO.SDS.AdminCenter.DirectoryService.Util.HomeButton({module:this.module,appWin:this.module.owner,authType:"ldap"}),updateButton:new SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util.UpdateButton({appWin:this.module.owner})}),new SYNO.SDS.AdminCenter.Group.GridPanel({title:_T("directory_service","ldap_group_tab"),module:this.module,itemId:"ldap_group",disabled:!0,authType:"ldap",cls:"syno-directory-service-user-group-gridpanel",viewConfig:e,updateButton:new SYNO.SDS.AdminCenter.DirectoryService.LDAP.Util.UpdateButton({appWin:this.module.owner})})),_S("is_admin")&&!this.isHCM&&this.items.push(new SYNO.SDS.AdminCenter.DirectoryService.SSOTab({module:this.module,owner:this,itemId:"sso"})),this.callParent(arguments)},startPollingDbStatus:function(){this.userStatusBar&&this.groupStatusBar&&!this.pollingDbStatusId&&(this.pollingDbStatusId=this.findAppWindow().pollReg({webapi:{api:"SYNO.Core.Directory.Domain",method:"get_db_status",version:1},interval:5,immediate:!0,scope:this,status_callback:function(e,t){e?(t.db_status.forEach((e=>{this.domainDbStatus[e.domain]=e.status.toLowerCase()}),this),this.updateSyncButton(),this.updateDbStatusBar()):SYNO.Debug("Failed to get db status:",t)}}))},stopPollingDbStatus:function(){this.pollingDbStatusId&&(this.findAppWindow().pollUnreg(this.pollingDbStatusId),this.pollingDbStatusId=void 0)},dbStatusBar:{isHidden:function(){return this.userStatusBar.hidden||this.groupStatusBar.hidden},addListener:function(e,t,i){this.userStatusBar.addListener(e,t,i),this.groupStatusBar.addListener(e,t,i)},show:function(){this.userStatusBar.show(),this.groupStatusBar.show()},hide:function(){this.userStatusBar.hide(),this.groupStatusBar.hide()},update:function(e,t){this.userStatusBar.setStatus(e,t),this.groupStatusBar.setStatus(e,t)}},onDbStatusBarClose:function(){this.manualCloseStatusBar=!0,this.dbStatusBar.hide(),this.doLayout()},updateDbStatusBar:function(){let e=this.domainDbStatus[this.currDomain],t=!1;this.dbStatusBar.update(e,this.currDomain),(()=>this.manualCloseStatusBar||"complete"!==e&&"syncing"!==e&&"fail"!==e)()?(t=!1===this.dbStatusBar.isHidden(),this.dbStatusBar.hide()):(t=!0===this.dbStatusBar.isHidden(),this.dbStatusBar.show()),t&&this.doLayout()},updateSyncButton:function(){const e="syncing"===this.domainDbStatus[this.currDomain];this.userGridPanel.updateButton.menu.getComponent("sync_domain").setDisabled(e),this.groupGridPanel.updateButton.menu.getComponent("sync_domain").setDisabled(e)},onDomainFilterSelect:function(e){this.currDomain=(()=>1===this.manageMode)()?this.primaryDomain:e,this.updateSyncButton(),this.updateDbStatusBar()},loadDomainList:function(e){0!==e.length&&(this.getComponent("domain_user").domainFilter.updateList(e),this.getComponent("domain_group").domainFilter.updateList(e))},loadAllForm:function(){this.hideTabStripItem("ldap_user"),this.hideTabStripItem("ldap_group"),this.hideTabStripItem("domain_user"),this.hideTabStripItem("domain_group"),this.callParent([{timeout:36e4}])},processParams:function(e,t){return t=this.callParent(arguments),Ext.isEmpty(SYNO.API.GetKnownAPI("SYNO.Core.Directory.Domain"))?t.filter((function(e){return!e.api.startsWith("SYNO.Core.Directory.Domain")})):_S("is_admin")?(Ext.isEmpty(SYNO.API.GetKnownAPI("SYNO.GlusterfsMgmt.Service"))||(t=t.concat([{api:"SYNO.GlusterfsMgmt.Service",method:"get",version:1}])),t):t},processReturnData:function(e,t,i){var s=SYNO.SDS.AdminCenter.DirectoryService.Util.DirectoryServiceDataGetCB(e,t,i);s.error?this.module.appWin.getMsgBox().alert(this.title,s.error):this.callParent(arguments)},setLdapUserGroupGrid:function(e){if(e)return this.getComponent("ldap_user").enable(),void this.getComponent("ldap_group").enable();this.getComponent("ldap_user").disable(),this.getComponent("ldap_group").disable()},onApiFailure:function(e,t){t.isTimeout?this.getEl().mask(_T("error","error_timeout"),"syno-ux-mask-info"):this.getEl().mask(_T("error","error_error_system"),"syno-ux-mask-info")},updateTabs:function(e,t){this.ldapRunning=e,this.domainRunning=t,this.hideTabStripItem("ldap_user"),this.hideTabStripItem("ldap_group"),this.hideTabStripItem("domain_user"),this.hideTabStripItem("domain_group");var i,s,n,o,a=this.getComponent("ldap_user"),r=this.getComponent("ldap_group");(a.disable(),r.disable(),e&&(this.unhideTabStripItem("ldap_user"),this.unhideTabStripItem("ldap_group")),"yes"===_D("supportdomain","no"))&&(t?(this.unhideTabStripItem("domain_user"),this.unhideTabStripItem("domain_group")):(null===(i=this.userGridPanel)||void 0===i||null===(s=i.store)||void 0===s||s.loadData({users:[]}),null===(n=this.groupGridPanel)||void 0===n||null===(o=n.store)||void 0===o||o.loadData({groups:[]})))},checkDomainEnable:function(){return"yes"===_D("supportdomain","no")&&!(!this.domainRunning&&!this.getComponent("domain").getForm().findField("enable_domain").getValue())},checkLDAPEnable:function(){return!(!this.ldapRunning&&!this.getComponent("ldap").getForm().findField("enable_client").getValue())}}),Ext.define("SYNO.SDS.AdminCenter.WebAPIUtils",{getReqCompoundParam:function(e,t,i){var s=[];e instanceof Array?s=e:s.append(e);for(var n=0;n<s.length;n++)if(t===s[n].api&&i===s[n].method)return s[n]}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.AdvancedForm",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),this.externalSetAPI={api:"SYNO.Core.Web.DSM.External",method:"set",version:1},this.externalGetAPI={api:"SYNO.Core.Web.DSM.External",method:"get",version:1}},fillConfig:function(e){var t={title:_T("common","advanced"),autoFlexcroll:!0,trackResetOnLoad:!0,labelWidth:260,webapi:{api:"SYNO.Core.Web.DSM.External",methods:{get:"get",set:"set"},version:1},items:[this.getExternalAccessObj()]};return Ext.apply(t,e),t},getExternalAccessObj:function(){return this.getExternalAccessItems()},getExternalAccessItems:function(){return[{xtype:"syno_displayfield",value:_T("dsmoption","external_port_desc_1")},{xtype:"syno_textfield",name:"hostname",vtype:"iporhostname",maxLength:255,width:224,allowBlank:!0,fieldLabel:_T("dsmoption","external_dns_or_ip"),emptyText:"www.example.com"},{xtype:"syno_numberfield",vtype:"port",validator:this.validateExternalPort.createDelegate(this,[!1],!0),fieldLabel:_T("dsmoption","external_port_dsm")+" (HTTP)",width:224,allowBlank:!0,name:"http_port",emptyText:"5000",autoCreate:{tag:"input",maxLength:"5"}},{xtype:"syno_numberfield",vtype:"port",validator:this.validateExternalPort.createDelegate(this,[!0],!0),fieldLabel:_T("dsmoption","external_port_dsm")+" (HTTPS)",width:224,allowBlank:!0,name:"https_port",emptyText:"5001",autoCreate:{tag:"input",maxLength:"5"}}]},validateExternalPort:function(e,t){if(Ext.isEmpty(e))return!0;var i=this.getForm().findField(t?"http_port":"https_port");return!Ext.isDefined(i)||(parseInt(e,10)!==i.getValue()||_T("app_port_alias","err_port_dup"))},processReturnData:function(e,t,i){Ext.each(t.result,(function(e){SYNO.ux.Utils.checkApiConsistency(e,this.externalGetAPI)&&Ext.isObject(e.data)&&(Ext.isDefined(e.data.http_port)||(e.data.http_port=""),Ext.isDefined(e.data.https_port)||(e.data.https_port=""))}),this),this.callParent(arguments),this.confirmLostChangeResolve&&this.confirmLostChangeResolve(),this.confirmLostChangeResolve=void 0},processParams:function(e,t){return"get"===e?this.callParent(arguments):(this.ownerCt.restartHttpd=!1,Ext.each(t,(function(e){SYNO.ux.Utils.checkApiConsistency(e,this.externalSetAPI)&&(e.params.http_port=this.processPortParam(e.params.http_port),e.params.https_port=this.processPortParam(e.params.https_port))}),this),t)},processPortParam:function(e){return Ext.isNumber(e)?e:null},getHelpParam:function(){return"AdminCenter/connection_public_access_advanced.html"}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.Utils",{statics:{PortValidator:function(e){return function(t){return SYNO.SDS.Utils.isReservedPort(e,t,t)?_T("ftp","ftp_port_in_used"):!SYNO.SDS.Utils.isBrowserReservedPort(t,t)||_T("common","err_browser_reserved_ports")}}}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SetupStatusUpdater",{extend:"Object",regReset:function(){this.detectStatusConfDone=!1},constructor:function(e){if(this.setupStatusHandler=null,this.scope=null,!e.owner||!e.setupStatusHandler||!e.scope)throw Error("SetupStatusUpdater constructor failed");this.owner=e.owner,this.module=e.module,this.setupStatusHandler=e.setupStatusHandler,this.scope=e.scope,this.detectStatusConfDone=!1},getDetectStatusConf:function(e){return{interval:1,immediate:!1,webapi:{api:"SYNO.Core.PortForwarding",version:1,method:"detect_status",params:{task_id:e}},status_callback:function(e,t,i,s){if(e){if(!t.percentage||!t.status)throw Error("webapi shall return processing and status");this.detectStatusConfDone=!0,this.isAllDone()&&this.setupStatusHandler.call(this.scope,s,e,t)}else this.detecStatusErrorHandler(t)},scope:this}},isAllDone:function(){return!!this.detectStatusConfDone},Start:function(e){this.Stop(),this.regReset(),this.detectStatusConf=this.getDetectStatusConf(e),this.detectStatusPollId=this.owner.pollReg(this.detectStatusConf)},isStop:function(){return!this.detectStatusPollId},Stop:function(){this.detectStatusPollId&&(this.owner.pollUnreg(this.detectStatusPollId),this.detectStatusPollId=null),this.regReset()},detecStatusErrorHandler:function(e){var t="";this.Stop(),e&&e.code?t=SYNO.API.getErrorString(e.code):(SYNO.Debug("detecStatusErrorHandler failed"),t=_T("common","error_system")),this.module.getMsgBox().alert(this.title,t),this.owner.clearStatusBusy(),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.closeOrFireFailEvent.call(this.scope,!0)}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RouterWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){this.owner=e.owner,this.strDetectTaskId=null,this.pollDetectRegId=null,this.setup_status_updater=null,this.isRouterWizard=!0;var t=Ext.apply({title:_T("routerconf","routerconf_setup_router"),autoDestroy:!0,width:700,height:540,layout:"fit",border:!1,dsmStyle:"v5",steps:[new SYNO.SDS.AdminCenter.PublicAccess.PublicAccess.WelcomeStep({itemId:"descform",owner:this,nextId:["emptyform"],gateway:e.gateway,ifname:e.ifname}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.EmptyStep({itemId:"emptyform",owner:this,nextId:["upnpform","natpmpform","portfwform","uradioform","radioform"]}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RadioStep({itemId:"uradioform",nextId:["upnpform","portfwform"]}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.UPnPStep({itemId:"upnpform",owner:this,nextId:null}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortFWStep({itemId:"portfwform",owner:this,nextId:null}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RadioStep({itemId:"radioform",nextId:["testform","portfwform"]}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.NatpmpStep({itemId:"natpmpform",owner:this,nextId:null}),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.TestStep({itemId:"testform",owner:this,nextId:["upnpform","portfwform"]})]},e);this.callParent([t])},onOpen:function(e){var t=function(){SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RouterWizard.superclass.onOpen.apply(this,arguments),Ext.isDefined(e)?(this.callback=e.callback,this.cbscope=e.scope):(this.callback=Ext.emptyFn,this.cbscope=this)}.bind(this);this.checkAvahiEnabled(t)},reportFailure:function(e){var t=e||{},i=t.msg||_T("common","loadsetting_fail");return i+="<br><br>"+_T("common","reload_res")+"?",this.getMsgBox().confirm(this.title,i,(function(e,i,s){"yes"===e&&Ext.isFunction(t.yesfn)?t.yesfn.apply(t.scope||this,t.args||[]):"no"===e&&Ext.isFunction(t.nofn)&&t.nofn.apply(t.scope||this,t.args||[])}),this),!1},checkAvahiEnabled:function(e){var t=function(e,t,i,s){var n=null;if(Ext.isDefined(this.owner)&&Ext.isFunction(this.owner.getMsgBox)&&(n=this.owner),n){var o=e+"<br>"+String.format(_T("routerconf","routerconf_goto_module"),i);n.getMsgBox().confirm(_T("tree","leaf_routerconf"),o,(function(e){"yes"===e&&SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:t,tab:s}),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.closeOrFireFailEvent.call(this,!0)}),this)}else SYNO.Debug("app is undefined")}.bind(this);synowebapi.request({api:"SYNO.Core.PortForwarding",version:1,method:"detect_pre_check",callback:function(i,s,n){s&&!s.is_avahi_alive?t(String.format(_T("routerconf","avahi_is_not_alive"),_T("controlpanel","leaf_file_services"),_T("common","advanced")),"SYNO.SDS.AdminCenter.FileService.Main",_T("common","advanced"),"adv"):e()},scope:this})}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PublicAccess.WelcomeStep",{extend:"SYNO.SDS.Wizard.WelcomeStep",constructor:function(e){if(!e.owner)throw Error("DescStep constructor failed");var t=this.createConfig(e);t=Ext.apply(t,{headline:_T("routerconf","detect_router_desc_title"),description:_T("routerconf","routerconf_setup_router")}),this.callParent([t])},createConfig:function(e){var t=new Ext.XTemplate('<div style="padding-left: 10px;">','<ul style="list-style-type:disc;list-style-position:inside;">','<tpl for=".">',"<li> {item} </li>","</tpl>","</ul>","</div>"),i=e.gateway?e.gateway:"",s=e.ifname?e.ifname:"",n='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span> ";return Ext.apply({items:[{xtype:"syno_displayfield",value:_T("routerconf","detect_router_desc")},{xtype:"syno_displayfield",value:_T("tcpip","tcpip_gateway")+_T("common","colon")+'<span class="green-status">'+i+" ("+s+")</span>",htmlEncode:!1},{htmlEncode:!1,xtype:"syno_displayfield",tpl:t,data:function(){var e=[],t=[_T("routerconf","check_network_interface_enabled"),_T("routerconf","check_gateway_setting"),_T("routerconf","check_connect_to_wan"),_T("routerconf","check_dns_setting"),_T("routerconf","check_lan2wan_gateway_hops"),_T("routerconf","detect_router")];return Ext.each(t,(function(t){e.push({item:t})}),this),e}()},{htmlEncode:!1,xtype:"syno_displayfield",value:n+_T("routerconf","detect_router_not_stop_warn")}]},e)}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.EmptyStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){if(!e.owner)throw Error("EmptyStep constructor failed");this.owner=e.owner,this.hasDetected=!1,this.detectResult={},this.obj=null,this.hasWarning=!1,this.hasError=!1,this.hasNote=!1;var t=this.configForm({module:this.owner,headline:_T("routerconf","detect_router"),description:_T("routerconf","routerconf_setup_router")},e);Ext.apply(t,e),this.callParent([t])},configForm:function(e){var t=new Ext.XTemplate('<div class="x-list-body">','<tpl for=".">','<div role="option" id="{[Ext.id()]}" aria-label="{status} {[this.renderItems(values.desc)]} {extra}" tabindex=0 style="display:table-row; line-height:24px;">',SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.statusHtml({icon:"{[this.renderStatus(values.status)]}",text:'{[this.renderItems(values.desc)]}<tpl if="values.extra"><span class="green-status">, {extra} </span></tpl>'}),'<div class="x-clear"></div>',"</div>","</tpl>","</div>",{renderItems:function(e){var t={check_interface_enable_step:_T("routerconf","check_network_interface_enabled"),check_gateway_setting_step:_T("routerconf","check_gateway_setting"),check_connect_wan_step:_T("routerconf","check_connect_to_wan"),check_dns_setting_step:_T("routerconf","check_dns_setting"),check_hops_lan2wan_step:_T("routerconf","check_lan2wan_gateway_hops"),detect_router_step:_T("routerconf","detect_router")};return e in t?t[e]:"-"},renderStatus:function(e){var t='<div style="text-align:center">-</div>',i={processing:'<div class="x-status-loading-icon"><span></span></div>',unknown:t,success:'<div class="x-status-img x-status-success x-status-margin">&nbsp;</div>',warning:'<div class="x-status-img x-status-warn x-status-margin">&nbsp;</div>',failed:'<div class="x-status-img x-status-fail x-status-margin">&nbsp;</div>',stop:t,initial:""};return e in i?i[e]:t}});return SYNO.LayoutConfig.fill(Ext.apply({xtype:"syno_formpanel",trackResetOnLoad:!0,synodefaults:{width:200},items:[{htmlEncode:!1,xtype:"syno_displayfield",value:_T("confbackup","bkp_export_prepare")},{htmlEncode:!1,xtype:"syno_flexcroll_dataview",itemId:"test_list",useARIA:!0,cls:"syno-portforwarding-listitem",autoFlexcroll:!1,tpl:t,height:160,store:new Ext.data.ArrayStore({fields:["status","desc","extra"]})},{htmlEncode:!1,xtype:"syno_displayfield",name:"gateway_setting_warning",value:""},{htmlEncode:!1,xtype:"syno_displayfield",name:"get_hops_warnings",value:""},{htmlEncode:!1,xtype:"syno_displayfield",name:"detect_result"}]},e))},activate:function(){var e=function(){this.owner.setStatusBusy(),this.loadForm()}.bind(this);this.owner.isRouterWizard?e():SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RouterWizard.prototype.checkAvahiEnabled.call(this,e)},loadForm:function(){this.getComponent("test_list").getContentTarget().setARIA({tabIndex:-1}),_S("demo_mode")?this.owner.goNext("portfwform",!1):this.hasDetected?this.setupStatusHandler(this.detectResult.opt,this.detectResult.success,this.detectResult.resp):this.sendDetectWebAPI()},sendDetectWebAPI:function(){var e=this;SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.detect.call(this,{success_callback:function(t,i,s){e.strDetectTaskId=i.task_id,e.setupStatusUpdate()}})},setupStatusUpdate:function(){if(!this.setup_status_updater){var e=this.owner,t=e.owner;this.setup_status_updater=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SetupStatusUpdater({owner:e,module:t||e,setupStatusHandler:this.setupStatusHandler,scope:this})}this.setup_status_updater.isStop()&&this.setup_status_updater.Start(this.strDetectTaskId)},callHelp:function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_routerconf.html"},!1)},replaceStringParamToCallHelp:function(e,t){var i=e;return t&&(i=String.format(e,'<span class="link-font" style="font-weight:bold;" id="'+t+'">',"</span>")),i},getRenderedErrorString:function(e,t){var i=this.replaceStringParamToCallHelp(e,t);return i='<span class="red-status">'+_T("error","error_error")+": "+i+"</span>"},getRenderedWarningString:function(e,t){var i=this.replaceStringParamToCallHelp(e,t);return i='<span class="orange-status">'+_T("log","warn_level")+": "+i+"</span>"},getRenderedNoteString:function(e){var t='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span> ";return t+=e},getRenderedSuccessString:function(e){return'<span class="green-status">'+_T("report","status_success")+": "+e+"</span>"},showResult:function(e,t){this.getForm().findField(e).setValue(t),this.doLayout()},setErrorString:function(e){var t=Ext.id(),i=this.getRenderedErrorString(e,t);this.showResult("detect_result",i),Ext.get(t).on("click",this.callHelp),this.hasError=!0},renderCheckNetworkInterfaceStatus:function(e,t,i){var s="";t.progress.check_interface_enable_step.network_interface?(s=SYNO.SDS.Utils.Network.idToString.call(this,t.progress.check_interface_enable_step.network_interface,""),e.push([t.progress.check_interface_enable_step.status,"check_interface_enable_step",s])):SYNO.Debug("resp.progress.check_interface_enable_step.network_interface is empty"),"failed"==t.progress.check_interface_enable_step.status&&this.setErrorString(_T("routerconf","warn_interface_not_enabled"))},renderCheckGatewaySettingStatus:function(e,t){var i="",s=Ext.id();e.push([t.progress.check_gateway_setting_step.status,"check_gateway_setting_step",t.progress.check_gateway_setting_step.gateway_ip]),"warning"==t.progress.check_gateway_setting_step.status&&(i=this.getRenderedWarningString(_T("routerconf","gateway_setting_not_exist"),s),this.showResult("gateway_setting_warning",i),Ext.get(s).on("click",this.callHelp),this.hasWarning=!0)},renderCheckConnectWANStatus:function(e,t){e.push([t.progress.check_connect_wan_step.status,"check_connect_wan_step"]),"failed"==t.progress.check_connect_wan_step.status&&this.setErrorString(_T("routerconf","network_not_connect_to_wan"))},renderCheckHopsLAN2WAN:function(e,t){var i="",s=Ext.id();e.push([t.progress.check_hops_lan2wan_step.status,"check_hops_lan2wan_step"]),"warning"==t.progress.check_hops_lan2wan_step.status&&"get_hops_fail"==t.progress.check_hops_lan2wan_step.warning_type?(i=this.getRenderedWarningString(_T("routerconf","cant_get_lan2wan_gateway_hops"),s),this.showResult("get_hops_warnings",i),Ext.get(s).on("click",this.callHelp),this.hasWarning=!0):"warning"==t.progress.check_hops_lan2wan_step.status&&"hops_over_one"==t.progress.check_hops_lan2wan_step.warning_type&&(i=this.getRenderedWarningString(_T("routerconf","lan2wan_gateway_hops_over_one"),null),this.showResult("get_hops_warnings",i),this.hasWarning=!0)},renderCheckDNSSetting:function(e,t){e.push([t.progress.check_dns_setting_step.status,"check_dns_setting_step"]),"failed"==t.progress.check_dns_setting_step.status&&this.setErrorString(_T("routerconf","dns_setting_cant_resolve_public_FQDN"))},renderDetectRouter:function(e,t){var i="";e.push([t.progress.detect_router_step.status,"detect_router_step"]),"success"==t.status&&t.support_upnp&&t.support_natpmp&&("unknown"==t.support_upnp||"unknown"===t.support_change_port?(i=this.getRenderedNoteString(_T("routerconf","detect_router_fail_not_in_db")),this.showResult("detect_result",i),this.hasNote=!0):"no"==t.support_upnp&&"no"==t.support_natpmp?t.router_brand||t.router_model||t.router_version?(i=this.getRenderedNoteString(_T("routerconf","detect_router_fail_not_support")),this.showResult("detect_result",i),this.hasNote=!0):(i=this.getRenderedNoteString(_T("routerconf","detect_router_fail_no_resp")),this.showResult("detect_result",i),this.hasNote=!0):"yes"==t.support_upnp||"yes"==t.support_natpmp?this.isAutoJumpToNextStep(t)&&(i=this.getRenderedSuccessString(_T("routerconf","detect_router_success")),this.showResult("detect_result",i)):(SYNO.Debug("renderDetectRouter, impossible here"),this.hasError=!0))},setDisable:function(){var e=this.owner.getButton("back");e&&e.disable(),this.owner.getButton("next").disable(),this.owner.tools.close.setDisplayed(!1)},setEnable:function(){var e=this.owner.getButton("back");e&&e.enable(),this.isAbleToEnableNextButton()&&this.owner.getButton("next").enable(),this.owner.tools.close.setDisplayed(!0)},setupStatusHandler:function(e,t,i){var s,n=[];this.owner.clearStatusBusy(),this.setDisable(),i?i.progress?(this.renderCheckNetworkInterfaceStatus(n,i),this.renderCheckGatewaySettingStatus(n,i),this.renderCheckConnectWANStatus(n,i),this.renderCheckHopsLAN2WAN(n,i),this.renderCheckDNSSetting(n,i),this.renderDetectRouter(n,i),this.getComponent("test_list").getStore().loadData(n,!1),"","success"===(s=i).status&&(this.hasError?(this.setDisable(),this.owner.tools.close.setDisplayed(!0)):this.setEnable(),this.setup_status_updater.Stop(),this.obj=s,this.hasDetected||(this.hasDetected=!0,this.detectResult.opt=e,this.detectResult.success=t,this.detectResult.resp=i),this.owner.getStep("upnpform").getForm().setValues(s),s.upnp_pfpath||(SYNO.ux.Utils.displayFormField(this.owner.getStep("upnpform").getForm(),"router_protocol",!1),SYNO.ux.Utils.displayFormField(this.owner.getStep("upnpform").getForm(),"router_port",!1),SYNO.ux.Utils.displayFormField(this.owner.getStep("upnpform").getForm(),"router_use_custom",!1),SYNO.ux.Utils.displayFormField(this.owner.getStep("upnpform").getForm(),"router_account",!1),SYNO.ux.Utils.displayFormField(this.owner.getStep("upnpform").getForm(),"router_password",!1),SYNO.ux.Utils.displayFormField(this.owner.getStep("upnpform").getForm(),"router_password_confirm",!1)),this.owner.getStep("natpmpform").getForm().setValues(s),this.owner.getStep("radioform").getForm().setValues(s),this.owner.getStep("uradioform").getForm().setValues(s),this.owner.getStep("portfwform").getForm().setValues(s))):SYNO.Debug("resp.progress is empty"):SYNO.Debug("resp is empty")},isAbleToEnableNextButton:function(){return!this.hasError},isAutoJumpToNextStep:function(e){return!(this.hasWarning||this.hasError||this.hasNote)&&("yes"===e.support_natpmp||"yes"===e.support_upnp)},nextStep:function(e){var t;this.owner.clearStatusBusy(),t="yes"===e.support_natpmp?"natpmpform":"unknown"===e.support_change_port||"unknown"===e.support_upnp?"radioform":"yes"===e.support_upnp?"upnpform":"yes"===e.support_change_port?"uradioform":"portfwform",0===this.owner.stepStack.length&&this.owner.getButton("back").hide(),this.owner.goNext(t,!0)},onCancel:function(){this.owner.getStep(this.layout.activeItem.itemId).form.isDirty()?this.owner.getMsgBox().confirm(this.owner.title,_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.owner.close()}),this):this.owner.close()},ajaxErrorHandler:function(e){this.owner.getMsgBox().alert(this.title,e)},getNext:function(){return this.nextStep(this.obj),!1}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RadioStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t=Ext.apply({trackResetOnLoad:!0,headline:_T("ezinternet","ezinternet_router_conf_title"),description:_T("routerconf","routerconf_portmapping_method"),labelWidth:200,synodefaults:{width:200},border:!1,items:this.configForm(),listeners:{afterlayout:function(e){SYNO.ux.Utils.DescribeGroup(e.getComponent("compatibility_radio"),[e.getComponent("comp_field1"),e.getComponent("comp_field2"),e.getComponent("comp_field3"),e.getComponent("comp_field4")]),SYNO.ux.Utils.DescribeGroup(e.getComponent("manual_radio"),[e.getComponent("manual_field")])},scope:this,single:!0}},e);this.callParent([t])},configForm:function(e){return[{xtype:"syno_radio",indent:1,boxLabel:_T("routerconf","routerconf_upnp"),name:"portmapping_type",itemId:"compatibility_radio",inputValue:0,checked:!0,scope:this},{xtype:"syno_displayfield",indent:2,value:_T("routerconf","routerconf_test_upnp_router"),itemId:"comp_field1"},{xtype:"syno_displayfield",fieldLabel:_T("routerconf","routerconf_brand"),name:"router_brand",indent:2,width:360,value:"",itemId:"comp_field2"},{xtype:"syno_displayfield",fieldLabel:_T("routerconf","routerconf_model"),name:"router_model",indent:2,width:360,value:"",itemId:"comp_field3"},{xtype:"syno_displayfield",fieldLabel:_T("routerconf","routerconf_version"),name:"router_version",indent:2,width:360,itemId:"comp_field4"},{xtype:"syno_radio",indent:1,boxLabel:_T("routerconf","routerconf_portforward"),name:"portmapping_type",itemId:"manual_radio",inputValue:1,scope:this},{xtype:"syno_displayfield",indent:2,itemId:"manual_field",value:_T("routerconf","routerconf_portforward_long")}]},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.call(this)},getNext:function(){var e=this.getForm().getValues().portmapping_type;return this.nextId[e]}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortFWStep",{extend:"SYNO.ux.FormPanel",initEvents:function(){this.callParent(arguments),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortFWStep.superclass.initEvents.apply(this,arguments),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"router_use_custom",["router_account","router_password","router_password_confirm"]),this.mon(this,"afterlayout",(function(){var e=Ext.getCmp(this.updateRouterDBId);SYNO.ux.AddWhiteTipWithMsg(e,_T("routerconf","routerconf_router_warning"))}),this,{single:!0})},constructor:function(e){e.owner||SYNO.Debug("PortFWStep constructor failed, due to no owner"),this.owner=e.owner;var t=this.configForm({headline:_T("ezinternet","ezinternet_port_fwd_title"),description:_T("routerconf","routerconf_setup_router_desc"),autoFlexcroll:!1,labelWidth:200});Ext.apply(t,e),this.callParent([t])},activate:function(){this.form.findField("router_list").on("select",(function(e,t,i){this.form.findField("router_brand").setValue(t.get("router_brand")),this.form.findField("router_model").setValue(t.get("router_model")),this.form.findField("router_version").setValue(t.get("router_version")),_S("demo_mode")&&(this.owner.getButton("next").disable(),this.owner.getButton("next").setTooltip(_JSLIBSTR("uicommon","error_demo")))}),this),this.loadRouterList(),this.doLayout()},loadRouterList:function(){this.owner.setStatusBusy(),this.router_store.load({callback:function(e,t,i){this.owner.clearStatusBusy(),i||this.owner.reportFailure({yesfn:this.loadRouterList,nofn:this.close,msg:_T("routerconf","routerconf_router_list_error"),scope:this})},scope:this,add:!1})},onAfterLoad:function(e,t,i){for(var s=0;s<e.getCount();s++){var n=e.getAt(s);n.get("generic")?n.set("value",n.get("router_brand")+": "+n.get("router_model")):n.set("value",n.get("router_brand")+": "+n.get("router_model")+"("+n.get("router_version")+")")}e.commitChanges()},configForm:function(e){return this.router_store=new SYNO.API.JsonStore({api:"SYNO.Core.PortForwarding.RouterList",appWindow:this.owner,method:"list",version:1,autoDestroy:!0,root:"routers",fields:["value","router_brand","router_model","router_version","generic"],listeners:{beforeload:function(){},load:this.onAfterLoad,scope:this}}),SYNO.LayoutConfig.fill(Ext.apply({xtype:"syno_formpanel",trackResetOnLoad:!0,labelWidth:200,border:!1,items:[{indent:0,xtype:"compositefield",fieldLabel:_T("routerconf","routerconf_router_type"),width:380,items:[{width:200,xtype:"syno_combobox",name:"router_list",forceSelection:!0,selectOnFocus:!0,editable:!0,listWidth:375,allowBlank:!1,emptyText:_T("routerconf","routerconf_select_router"),store:this.router_store,valueField:"value",displayField:"value"},{disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",xtype:"syno_button",text:_T("routerconf","routerconf_update_router_list"),handler:this.updateRouterDB,id:this.updateRouterDBId=Ext.id(),scope:this}]},{xtype:"syno_combobox",fieldLabel:_T("routerconf","routerconf_manager_protocol"),name:"router_protocol",width:80,store:new Ext.data.JsonStore({fields:["name","value","port"],data:[{name:"HTTP",value:"http",port:80},{name:"HTTPS",value:"https",port:443}]}),value:"http",displayField:"name",valueField:"value",listeners:{select:function(e,t,i){this.ownerCt.getComponent("router_port").setValue(t.get("port"))}}},{xtype:"syno_numberfield",fieldLabel:_T("routerconf","routerconf_manager_port"),name:"router_port",maxlangth:5,itemId:"router_port",value:80,vtype:"port"},{xtype:"syno_checkbox",boxLabel:_T("routerconf","routerconf_custom_account"),name:"router_use_custom"},{xtype:"syno_textfield",indent:1,fieldLabel:_T("routerconf","routerconf_manager_account"),name:"router_account"},{xtype:"syno_textfield",indent:1,textType:"password",fieldLabel:_T("routerconf","routerconf_manager_password"),name:"router_password"},{xtype:"syno_textfield",indent:1,textType:"password_confirm",fieldLabel:_T("service","service_ddns_passwd_confirm"),name:"router_password_confirm",confirmFor:"router_password"},{htmlEncode:!1,xtype:"syno_displayfield",value:String.format("<p>&nbsp;</p><p>{0}</p>",String.format(_T("ezinternet","ezinternet_router_info"),'<a class="link-font" href="https://www.synology.com/knowledgebase/faq/299" target="_blank">',"</a>"))},{xtype:"hidden",name:"support_natpmp"},{xtype:"hidden",name:"support_upnp"},{xtype:"hidden",name:"router_brand"},{xtype:"hidden",name:"router_model"},{xtype:"hidden",name:"router_version"}]},e))},getNext:function(){return!!this.checkData()&&(this.popWarning(this.savePWRouterInfo,this),!1)},checkData:function(){var e=this.getForm();return!!e.isValid()&&(!!e.isDirty()||null)},popWarning:function(e,t){var i=this.getForm();if(!i.findField("router_use_custom").getValue()||!(i.findField("router_use_custom").isDirty()||i.findField("router_account").isDirty()||i.findField("router_password").isDirty()))return e.call(t),void(this.nextId&&this.owner.goNext(this.nextId,!0));this.owner.getMsgBox().confirm(this.owner.title,_T("routerconf","routerconf_custom_warning"),(function(i){"yes"===i&&(e.call(t,!0),this.nextId&&this.owner.goNext(this.nextId,!0))}),this)},savePWRouterInfo:function(){this.owner.setStatusBusy({text:_T("common","saving")});var e={router_brand:this.form.findField("router_brand").getValue(),router_model:this.form.findField("router_model").getValue(),router_version:this.form.findField("router_version").getValue(),router_protocol:this.form.findField("router_protocol").getValue(),router_port:this.form.findField("router_port").getValue(),support_upnp:"no",support_natpmp:"no"};this.form.findField("router_use_custom").getValue()&&(e.router_account=this.form.findField("router_account").getValue(),e.router_pass=this.form.findField("router_password").getValue()),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.saveRouterConf.call(this,{retryTimes:5,params:e})},updateRouterDB:function(){this.owner.setStatusBusy(),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.updateDb.call(this,{success_callback:function(e,t,i){this.owner.clearStatusBusy(),0===t.router_version?this.owner.getMsgBox().alert(this.title,_T("routerconf","routerconf_update_nochange")):(this.loadRouterList(),this.owner.getMsgBox().alert(this.title,String.format(_T("routerconf","routerconf_update_success"),t.router_version)))},failure_callback:function(e,t,i){this.owner.clearStatusBusy(),this.owner.reportFailure({msg:_T("routerconf","routerconf_update_db_failed"),yesfn:this.updateRouterDB,scope:this})}})}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI",{extend:"Object",constructor:function(){},closeOrFireFailEvent:function(e){this.isRouterWizard||(this.owner.isRouterWizard?this.owner.close():e&&this.fireEvent("disableNextStep",this))},fireSuccess:function(){this.owner.owner?this.owner.close():this.fireEvent("enableNextStep",this)},saveRouterConf:function(e){if(!e)throw Error("SendWebAPI saveRouterConf cfg null");if(void 0===e.retryTimes)throw Error("SendWebAPI saveRouterConf cfg.retryTimes null");synowebapi.request({api:"SYNO.Core.PortForwarding.RouterConf",version:1,method:"set",params:e.params,callback:function(t,i,s){if(t)this.owner.clearStatusBusy(),this.owner.callback&&this.owner.cbscope&&this.owner.callback.call(this.owner.cbscope),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.fireSuccess.call(this),SYNO.Debug("save conf success");else{if(1501===i.code){if(0>e.retryTimes)return this.owner.getMsgBox().alert(this.title,_T("common","error_occupied")),this.owner.clearStatusBusy(),void SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.closeOrFireFailEvent.call(this,!0);e.retryTimes--,this.saveRouterConfWebAPI(),SYNO.Debug("retry to save upnp conf")}else{var n=SYNO.API.getErrorString(i.code);this.owner.getMsgBox().alert(this.title,n),this.owner.clearStatusBusy(),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.closeOrFireFailEvent.call(this,!0)}}},scope:this})},detect:function(e){synowebapi.request({api:"SYNO.Core.PortForwarding",version:1,method:"detect",params:{auto_save:!1},callback:function(t,i,s){if(t){if(!i||!i.task_id)throw Error("detect webapi shall return data.task_id");e&&e.success_callback&&e.success_callback.call(this,t,i,s),SYNO.Debug("detect success")}else SYNO.Debug("detect failed")},scope:this})},updateDb:function(e){synowebapi.request({api:"SYNO.Core.PortForwarding.RouterList",version:1,method:"update",callback:function(t,i,s){if(!t)return e&&e.failure_callback&&e.failure_callback.call(this,t,i,s),void SYNO.Debug("updateDb failed");e&&e.success_callback&&e.success_callback.call(this,t,i,s),SYNO.Debug("updateDb success")},scope:this})},testCompatibility:function(e){synowebapi.request({api:"SYNO.Core.PortForwarding.Compatibility",version:1,method:"test",callback:function(t,i,s){if(!t)return e&&e.failure_callback&&e.failure_callback.call(this,t,i,s),void SYNO.Debug("start comptibility failed");e&&e.success_callback&&e.success_callback.call(this,t,i,s),SYNO.Debug("start compatibility success")},scope:this})},stopTestCompatibility:function(e){var t=this;synowebapi.request({api:"SYNO.Core.PortForwarding.Compatibility",version:1,method:"stop",callback:function(i,s,n){if(!i)return e&&e.failure_callback&&e.failure_callback.call(t,i,s,n),void SYNO.Debug("stop comptibility failed");e&&e.success_callback&&e.success_callback.call(t,i,s,n),SYNO.Debug("stop compatibility success")},scope:t})},testCompatibilityStatus:function(e){synowebapi.request({api:"SYNO.Core.PortForwarding.Compatibility",version:1,method:"test_status",params:{task_id:e.task_id},callback:function(t,i,s){if(!t)return e&&e.failure_callback&&e.failure_callback.call(this,t,i,s),void SYNO.Debug("get comptibility status failed");e&&e.success_callback&&e.success_callback.call(this,t,i,s),SYNO.Debug("get compatibility status success")},scope:this})},uploadCompatibilityResult:function(e){synowebapi.request({api:"SYNO.Core.PortForwarding.Compatibility",version:1,method:"upload",callback:function(t,i,s){if(!t)return e&&e.failure_callback&&e.failure_callback.call(this,t,i,s),void SYNO.Debug("upload comptibility status failed");e&&e.success_callback&&e.success_callback.call(this,t,i,s),SYNO.Debug("upload compatibility status success")},scope:this})},getCurrentProcessing:function(e){synowebapi.request({api:"SYNO.Core.PortForwarding",version:1,method:"get_current_process",callback:function(t,i,s){if(!t)return e&&e.failure_callback&&e.failure_callback.call(this,t,i,s),void SYNO.Debug("get current process failed");e&&e.success_callback&&e.success_callback.call(this,t,i,s),SYNO.Debug("get current process success")},scope:this})}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.UPnPStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){if(!e.owner)throw Error("UPnPStep constructor failed");this.owner=e.owner;var t=this.configForm({module:this.owner,autoFlexcroll:!1,headline:_T("ezinternet","ezinternet_router_conf_title"),description:_T("routerconf","routerconf_upnp_title")});Ext.apply(t,e),this.callParent([t])},configForm:function(e){return SYNO.LayoutConfig.fill(Ext.apply({xtype:"syno_formpanel",labelWidth:200,border:!1,items:[{fieldLabel:_T("routerconf","routerconf_brand"),name:"router_brand",indent:0,width:360,xtype:"syno_displayfield"},{fieldLabel:_T("routerconf","routerconf_model"),name:"router_model",indent:0,width:360,xtype:"syno_displayfield"},{fieldLabel:_T("routerconf","routerconf_version"),name:"router_version",indent:0,width:360,xtype:"syno_displayfield"},{xtype:"syno_combobox",fieldLabel:_T("routerconf","routerconf_manager_protocol"),name:"router_protocol",store:new Ext.data.JsonStore({fields:["name","value","port"],data:[{name:"HTTP",value:"http",port:80},{name:"HTTPS",value:"https",port:443}]}),value:"http",displayField:"name",valueField:"value",listeners:{select:function(e,t,i){this.ownerCt.getComponent("router_port").setValue(t.get("port"))}}},{xtype:"syno_numberfield",fieldLabel:_T("routerconf","routerconf_manager_port"),name:"router_port",maxlangth:5,itemId:"router_port",value:80,vtype:"port"},{xtype:"syno_checkbox",boxLabel:_T("routerconf","routerconf_custom_account"),name:"router_use_custom"},{xtype:"syno_textfield",indent:1,fieldLabel:_T("routerconf","routerconf_manager_account"),name:"router_account"},{xtype:"syno_textfield",textType:"password",indent:1,fieldLabel:_T("routerconf","routerconf_manager_password"),name:"router_password"},{xtype:"syno_textfield",textType:"password_confirm",indent:1,fieldLabel:_T("service","service_ddns_passwd_confirm"),name:"router_password_confirm",confirmFor:"router_password"},{xtype:"hidden",name:"router_list"},{xtype:"hidden",name:"upnp_pfpath"},{xtype:"hidden",name:"support_natpmp"},{xtype:"hidden",name:"support_upnp"}]},e))},getNext:function(){return this.saveUPnPRouterInfo(),!1},saveUPnPRouterInfo:function(e,t,i){var s=this.getForm();if(!this.getForm().isValid())return!1;if(!i&&s.findField("router_use_custom").getValue()&&(s.findField("router_use_custom").isDirty()||s.findField("router_account").isDirty()||s.findField("router_password").isDirty()))return this.owner.getMsgBox().confirm(this.owner.title,_T("routerconf","routerconf_custom_warning"),(function(e){"yes"===e&&this.saveUPnPRouterInfo(e,t,!0)}),this),!1;this.owner.setStatusBusy({text:_T("common","saving")});var n={router_brand:this.form.findField("router_brand").getValue(),router_model:this.form.findField("router_model").getValue(),router_version:this.form.findField("router_version").getValue(),support_upnp:"yes",support_natpmp:"no"};this.form.findField("upnp_pfpath").getValue()&&(n.upnp_pfpath=this.form.findField("upnp_pfpath").getValue(),n.router_protocol=this.form.findField("router_protocol").getValue(),n.router_port=this.form.findField("router_port").getValue(),this.form.findField("router_use_custom").getValue()&&(n.router_account=this.form.findField("router_account").getValue(),n.router_pass=this.form.findField("router_password").getValue())),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.saveRouterConf.call(this,{retryTimes:5,params:n})},initEvents:function(){SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.UPnPStep.superclass.initEvents.apply(this,arguments),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"router_use_custom",["router_account","router_password","router_password_confirm"])}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.NatpmpStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){if(!e.owner)throw Error("NatpmpStep constructor failed");this.owner=e.owner;var t=this.configForm({module:this.owner,headline:_T("ezinternet","ezinternet_router_natpmp_conf_title"),description:_T("routerconf","routerconf_natpmp_title")});Ext.apply(t,e),SYNO.LayoutConfig.fill(t),this.callParent([t])},configForm:function(e){return SYNO.LayoutConfig.fill(Ext.apply({xtype:"syno_formpanel",synodefaults:{width:200},border:!1,items:[{fieldLabel:_T("routerconf","routerconf_brand"),name:"router_brand",indent:0,width:360,xtype:"syno_displayfield"},{fieldLabel:_T("routerconf","routerconf_model"),name:"router_user_setting_name",indent:0,width:360,xtype:"syno_displayfield"},{xtype:"hidden",name:"router_model"},{xtype:"hidden",name:"router_version"},{xtype:"hidden",name:"router_protocol"},{xtype:"hidden",name:"router_port"},{xtype:"hidden",name:"support_natpmp"},{xtype:"hidden",name:"support_upnp"},{xtype:"hidden",name:"router_max_rule"}]},e))},getNext:function(e){return this.saveNatpmpRouterInfo(),!1},saveNatpmpRouterInfo:function(){var e={router_brand:this.form.findField("router_brand").getValue(),router_model:this.form.findField("router_model").getValue(),router_version:this.form.findField("router_version").getValue(),support_upnp:"no",support_natpmp:"yes"};this.owner.setStatusBusy({text:_T("common","saving")}),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.saveRouterConf.call(this,{retryTimes:5,params:e})}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.CompatibilityStatusUpdater",{extend:"Object",constructor:function(e){if(!e.owner||!e.scope||!e.pollConf)throw Error("CompatibilityStatusUpdater contructor failed");this.owner=e.owner,this.scope=e.scope,this.pollConf=e.pollConf,this.pollId=null},Start:function(){this.Stop(),this.pollId=this.owner.pollReg(this.pollConf)},Stop:function(){this.pollId&&this.owner.pollUnreg(this.pollId),this.pollId=null}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.TestStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){if(this.strTaskId=null,this.compatibility_status_updater=null,this.hasUpload=!1,!e.owner)throw Error("TestStep constructor failed");this.owner=e.owner;var t=this.configForm({module:this.owner,headline:_T("ezinternet","ezinternet_router_conf_title"),description:_T("routerconf","routerconf_test_upnp_desc")},e);Ext.apply(t,e),this.callParent([t])},initEvents:function(){this.owner.mon(this.owner,"beforeclose",this.onClose,this)},onClose:function(){this===this.owner.getActiveStep()&&this.Stop(!0),this.owner.mun(this.owner,"beforeclose",this.onClose,this)},configForm:function(e){var t=new Ext.XTemplate('<tpl for=".">','<div role="option" id="{[Ext.id()]}" aria-label="{status} {[this.renderItems(values.desc)]} {extra}" tabindex=0 style="display:table-row; line-height:24px;">',SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.statusHtml({icon:"{[this.renderStatus(values.status)]}",text:"{[this.formatString(values.desc, values.extra)]}"}),"</div>","</tpl>",{renderItems:function(e){var t={add:_T("routerconf","routerconf_test_rule_add"),max:_T("routerconf","routerconf_test_max_count")};return e in t?t[e]:"-"},renderStatus:function(e){var t='<div style="text-align:center">-</div>',i={processing:'<div class="x-status-loading-icon"><span></span></div>',unknown:t,success:'<div class="x-status-img x-status-success x-status-margin">&nbsp;</div>',failed:'<div class="x-status-img x-status-fail x-status-margin">&nbsp;</div>'};return e in i?i[e]:t},formatString:function(e,t){return String.format(this.renderItems(e),'<span class="green-status">'+t+"</span>")}});return SYNO.LayoutConfig.fill(Ext.apply({xtype:"syno_formpanel",trackResetOnLoad:!0,synodefaults:{width:200},items:[{xtype:"syno_flexcroll_dataview",itemId:"test_list",useARIA:!0,cls:"syno-portforwarding-listitem",autoFlexcroll:!1,tpl:t,height:100,store:new Ext.data.ArrayStore({fields:["status","desc","extra"]})},{xtype:"syno_displayfield",name:"test_staus",htmlEncode:!1},{xtype:"syno_checkbox",boxLabel:_T("routerconf","routerconf_test_report"),name:"test_report",checked:!0,hidden:!0,hideMode:"visibility",indent:1},{xtype:"syno_displayfield",name:"dummy",htmlEncode:!1}]},e))},activate:function(){this.getComponent("test_list").getContentTarget().setARIA({tabIndex:-1}),this.hasCompatibilityTest?this.testUPnPResult(this.compatibilitTestData):this.compatibility_status_updater||this.testUPnPCompatibility()},testUPnPCompatibility:function(){this.compatibility_status_updater&&SYNO.Debug("testUPnPCompatibility compatibility_status_updater shall not exist"),SYNO.API.Request.Polling.List({task_id_prefix:"SYNO.Core.PortForwarding.test_compatibility",extra_group_tasks:["admin"],callback:function(e,t,i,s){e?t.admin&&0<t.admin.length?this.checkStrTaskIdStatus(t.admin[0]):this.checkStrTaskIdStatus(null):SYNO.Debug("pollCompatibilityStrTaskId() failed")},scope:this})},checkStrTaskIdStatus:function(e){this.compatibility_status_updater?SYNO.Debug("checkStrTaskIdStatus falied"):e?(this.strTaskId=e,SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.testCompatibilityStatus.call(this,{task_id:e,success_callback:function(e,t,i){SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.getCurrentProcessing.call(this,{success_callback:function(e,t,i){"none"===t.process?this.createNewTaskId():"autotest"===t.process?this.compatibilityStatusUpdate(this.strTaskId):this.compatibilityErrorHandler(1501),SYNO.Debug("get current process success")},failure_callback:function(e,t,i){SYNO.Debug("get current process failed")}})},failure_callback:function(e,t,i){this.createNewTaskId()}})):this.createNewTaskId()},compatibilityErrorHandler:function(e){if(this.Stop(!0),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.closeOrFireFailEvent.call(this,!0),1501===e)SYNO.Debug("error_code: "+e+" is handling."),this.owner.module.appWin.getMsgBox().alert(this.title,_T("common","error_occupied"));else{SYNO.Debug("shall handle error code ="+e+"here");var t=SYNO.API.getErrorString(e);this.owner.module.appWin.getMsgBox().alert(this.title,t)}},createNewTaskId:function(){this.compatibility_status_updater?SYNO.Debug("createNewTaskId failed"):SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.testCompatibility.call(this,{success_callback:function(e,t,i){this.compatibilityStatusUpdate(t.task_id)},failure_callback:function(e,t,i){t&&t.code?this.compatibilityErrorHandler(t.code):SYNO.Debug("testCompatibility failed")}})},compatibilityStatusUpdate:function(e){if(e)if(this.compatibility_status_updater)SYNO.Debug("compatibilityStatusUpdater has been existed");else{var t={interval:3,immediate:!0,webapi:{api:"SYNO.Core.PortForwarding.Compatibility",version:1,method:"test_status",params:{task_id:e}},status_callback:function(e,t,i,s){if(!e)return this.Stop(!0),void(t&&t.code?this.compatibilityErrorHandler(t.code):SYNO.Debug("compatibilityStatusUpdate failed due to polling framework failed"));this.testUPnPResult(t)},scope:this};this.strTaskId=e,this.compatibility_status_updater=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.CompatibilityStatusUpdater({owner:this.owner,pollConf:t,scope:this}),this.compatibility_status_updater.Start(),this.owner.getButton("back").disable(),this.owner.getButton("next").disable()}else SYNO.Debug("compatibilityStatusUpdate need strTaskId, but strTaskId is null")},Stop:function(e){if(function(){this.compatibility_status_updater&&(this.compatibility_status_updater.Stop(),this.compatibility_status_updater=null),this.strTaskId=null}.bind(this)(),e){var t=this.owner;this.owner.module&&this.owner.module.appWin&&(t=this.owner.module.appWin),t.setStatusBusy(),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.stopTestCompatibility.call(this,{success_callback:function(){t.clearStatus()},failure_callback:function(){t.clearStatus()}})}},closeOrFireFailEvent:function(){SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.closeOrFireFailEvent.call(this,!0)},testUPnPResult:function(e){var t,i="",s=[];return this.owner.getButton("back").disable(),this.owner.getButton("next").disable(),null==e?(this.Stop(!0),this.owner.getMsgBox().alert(this.title,_T("common","loadsetting_fail"),this),0):Ext.isDefined(e.test)&&Ext.isDefined(e.status)?(t=e.test,Ext.each(t,(function(e){"max"===e.test_item&&"unknown"!==e.status?s.push([e.status,e.test_item,e.max]):s.push([e.status,e.test_item])}),this),this.getComponent("test_list").getStore().loadData(s,!1),void("success"===e.status?(this.hasCompatibilityTest||(this.hasCompatibilityTest=!0,this.compatibilitTestData=e),this.getForm().findField("test_report").setVisible(!0),this.getForm().findField("test_staus").setValue(_T("routerconf","routerconf_test_pass")),this.owner.getButton("back").enable(),this.owner.getButton("next").enable(),this.Stop()):"failed"===e.status&&(this.hasCompatibilityTest||(this.hasCompatibilityTest=!0,this.compatibilitTestData=e),this.owner.getButton("back").hide(),this.owner.getButton("next").hide(),i=_T("routerconf","routerconf_may_not_enable_upnp_write"),e.blAllPortFail&&!1===e.blAnyPortOnRouter&&(i=_T("routerconf","no_any_portmap_but_compatiblity_still_fail")),this.getForm().findField("test_staus").setValue(i),this.getForm().findField("test_report").setVisible(!0),this.Stop(),this.compability_test=-1))):(this.owner.getButton("back").enable(),this.owner.getButton("next").enable(),this.Stop(!0),this.owner.getMsgBox().alert(this.title,_T("common","loadsetting_fail"),this.closeOrFireFailEvent,this),0)},Upload:function(){this.owner.setStatusBusy(),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.SendWebAPI.prototype.uploadCompatibilityResult.call(this,{success_callback:function(e,t,i){this.owner.clearStatusBusy(),this.owner.callback&&this.owner.cbscope&&this.owner.callback.call(this.owner.cbscope),SYNO.Debug("upload test result success")},failure_callback:function(e,t,i){this.owner.clearStatusBusy(),this.owner.callback&&this.owner.cbscope&&this.owner.callback.call(this.owner.cbscope),SYNO.Debug("upload test result failed")}}),this.hasUpload=!0},getNext:function(){var e=null,t=function(){(e=this.owner.getStep("upnpform").getForm().getValues()).support_upnp="yes",this.owner.getStep("upnpform").getForm().setValues(e)}.bind(this);return"true"===this.getForm().getValues().test_report&&!1===this.hasUpload&&this.Upload(),this.Stop(!0),this.compatibilitTestData.support||this.compatibilitTestData.support_change_port?(t(),this.owner.goNext("upnpform",!0)):this.owner.goNext("portfwform",!0),!1}}),Ext.ns("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding"),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_INDEX="index",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_ROUTER_PORT="router_port",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_DS_PORT="ds_port",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_REMAP_ROUTER_PORT="remap_router_port",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_STATUS="status",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_PORT_INFO="port_info",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_PORT_STATUS="port_status",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_INDEX="index",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_SERVICENAME="service_name",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_SERVICEID="serviceid",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.STATUS_SUCCESS="success",SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.STATUS_PROGRESS="processing",Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ConfirmDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=Ext.apply({cls:"syno-admin-center-confirm-dialog x-window-dlg",width:600,minHeight:120,autoHeight:!0,padding:"24px 30px 0 30px",header:!1,draggable:!1,resizable:!1,elements:"body",fbar:[{xtype:"syno_button",text:_T("common","cancel"),itemId:"cancel",scope:this,handler:function(){Ext.isDefined(this.onCancel)&&this.onCancel(),this.close()}},{xtype:"syno_button",text:_T("common","ok"),itemId:"apply",btnStyle:"blue",scope:this,handler:function(){Ext.isDefined(this.onApply)&&this.onApply(),this.close()}}]},e);this.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortRange",{extend:"Object",constructor:function(e,t){var i=0,s=[e,t];void 0===t&&("string"==typeof e?2!==(s=e.split("-")).length&&(s=[e,e]):s=[e,e]),this.min=parseInt(s[0],10),this.max=parseInt(s[1],10),this.min>this.max&&(i=this.min,this.min=this.max,this.max=i)},isValid:function(){return 0<this.min&&this.min<=this.max&&this.max<65536},toString:function(){return this.min===this.max?this.min+"":this.min+"-"+this.max},getCount:function(){return this.isValid()?this.max-this.min+1:NaN},compare:function(e){return this.min===e.min?this.max-e.max:this.min-e.min}}),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortRange.comparator=function(e,t){return e.compare(t)},Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports",{extend:"Object",constructor:function(e){var t,i=null;if(this.ports=[],this.isValid=!0,"string"==typeof e){t=e.split(",");for(var s=0;s<t.length;s++)(i=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortRange(t[s])).isValid()?this.ports.push(i):this.isValid=!1}},toString:function(){return this.ports.join(",")},equalFormat:function(e){if(this.ports.length!==e.ports.length||!1===this.isValid||!1===e.isValid)return!1;for(var t=0;t<this.ports.length;t++)if(this.ports[t].getCount()!==e.ports[t].getCount())return!1;return!0},isConflict:function(){var e,t,i,s=null,n=[];if(0>=(s=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports(this.toString()).ports).length)return n;for(s.sort(SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortRange.comparator),t=1,e=s[0].max;t<s.length;t++)e>=s[t].min&&(i=e<s[t].max?e:s[t].max,n.push(new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortRange(s[t].min,i))),e=e<s[t].max?s[t].max:e;return n},toArr:function(){return this.ports},getPortsNumber:function(){var e=0,t=0,i=0;if(!this.ports)return 0;for(i=0;i<this.ports.length;i++)t=this.ports[i].getCount(),isNaN(t)||(e+=t);return e}}),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Conflict=function(e){return new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports(e).isConflict()},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidate=function(e){var t=e.dsPortsString||"",i=e.routerPortsString||"",s=e.cb||function(){},n=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports(t),o=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports(i),a={ret:-1,dsPort:n,routerPort:o};return t||SYNO.Debug("dsPortsString of PortsValidate is empty"),i||SYNO.Debug("routerPortsString of PortsValidate is empty"),0<n.isConflict().length||0<o.isConflict().length?(a.ret=-2,s(a),a.ret):n.isValid&&o.isValid?n.ports&&o.ports?o.getPortsNumber()!=n.getPortsNumber()?(a.ret=-5,s(a),a.ret):(a.ret=0,s(a),a.ret):(a.ret=-4,s(a),a.ret):(a.ret=-3,s(a),a.ret)},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidator=function(e){switch(SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidate(e)){case 0:return!0;case-1:return _T("routerconf","routerconf_port_hint");case-2:return _T("routerconf","routerconf_port_value_invalid");case-3:return _T("common","error_badport");case-4:return _T("routerconf","routerconf_port_hint");case-5:return _T("routerconf","routerconf_port_count_invalid");default:return _T("routerconf","routerconf_port_hint")}},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortStringValidator=function(e){var t={dsPortsString:e,routerPortsString:e};return SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidator(t)},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.IsRule=function(e){return!!(e&&e.hasOwnProperty("isEnable")&&e.hasOwnProperty("getServiceName")&&e.hasOwnProperty("getDsPorts")&&e.hasOwnProperty("getRouterPorts")&&e.hasOwnProperty("getProtocol"))||(SYNO.Debug("is not valid rule"),!1)},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Rule=function(e){var t=e.blEnable||!1,i=e.szServiceName||"",s=e.szDsPorts||"",n=e.szRouterPorts||"",o=e.szProtocol||"",a=function(e){return e+String.format(" ,[blEnable={0}, szServiceName={1}, szDsPorts={2}, szRouterPorts={3}, szProtocol={4}]",t,i,s,n,o)};return o?"TCP"!==o.toUpperCase()&&"UDP"!==o.toUpperCase()&&"ALL"!==o.toUpperCase()?(SYNO.Debug(a("failed, szProtocol is invalid")),null):0!==SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidate({dsPortsString:s,routerPortsString:n,cb:function(e){e?0===e.ret||SYNO.Debug(a("failed, PortsValidate ret="+e.ret)):SYNO.Debug(a("failed, cbData is empty"))}})?null:{isEnable:function(){return t},getServiceName:function(){return i},getDsPorts:function(){return s},getRouterPorts:function(){return n},getProtocol:function(){return o}}:(SYNO.Debug(a("failed, szProtocol is empty")),null)},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleConflict=function(e,t){var i=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.IsRule,s={dsPort:[],routerPort:[]};return i(e)?i(t)?e.getProtocol()!==t.getProtocol()&&"ALL"!==e.getProtocol().toUpperCase()&&"ALL"!==t.getProtocol().toUpperCase()?null:(s.dsPort=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports(e.getDsPorts()+","+t.getDsPorts()).isConflict(),s.routerPort=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports(e.getRouterPorts()+","+t.getRouterPorts()).isConflict(),0===s.dsPort.length&&0===s.routerPort.length?null:s):(SYNO.Debug("rule2 is not valid rule"),null):(SYNO.Debug("rule1 is not valid rule"),null)},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleSet=function(){var e=[];return{addRule:function(t,i){var s=0,n=null,o=!1;if(!(0,SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.IsRule)(t))return SYNO.Debug("rule is not rule"),!1;if(!t.isEnable())return e.push(t),!0;for(s=0;s<e.length;s++)e[s].isEnable()&&(n=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleConflict(t,e[s]))&&(o=!0,i&&i(n,t,e[s]));return!o&&(e.push(t),!0)}}},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray=function(e){var t=[],i=[],s=0,n=0,o=0;if(!e)return t;i=e.split(",");for(var a=0;a<i.length;a++)if(0>i[a].search("-"))t.push(parseInt(i[a],10));else{(s=i[a].split("-")[0])>(n=i[a].split("-")[1])&&(o=s,s=n,n=o);for(var r=s;r<=n;r++)t.push(parseInt(r,10))}return t},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.statusHtml=function(e){var t,i;return t=void 0!==(e=e||{}).icon?e.icon:'<div class="x-status-loading-img x-status-margin">&nbsp;</div>',i=void 0!==e.text?e.text:_T("common","loading"),String.format('<div style="display:table-cell;width:24px;height:24px;vertical-align:middle;margin:auto;padding-right:2px; position:relative;">{0}</div><div style="display:table-cell;vertical-align:middle;margin:0;">{1}</div>',t,i)},Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ServiceRuleGrid",{extend:"SYNO.ux.EditorGridPanel",constructor:function(e){if(!e.owner)throw Error("ServiceRuleStep constructor failed");this.owner=e.owner,this.rule_store=e.rule_store,this.serviceDescObj=e.serviceDescObj,this.next_step_callback=e.next_step_callback,this.next_step_callback_scope=e.next_step_callback_scope,this.isSupportChangePort=e.isSupportChangePort||!1,this.allowBlank=!1;var t=Ext.apply(this.createServiceRuleGridConfig(),e),i=SYNO.LayoutConfig.fill(t);this.callParent([i])},activate:function(){this.serviceDescObj.hasInitialized()?this.activateCore():(this.owner.setStatusBusy(),this.serviceDescObj.initAsync(function(){this.owner.clearStatusBusy(),this.activateCore()}.bind(this)))},activateCore:function(){this.getStore().loadData(this.serviceDescObj.getPortInfoArrayData(),!1),this.deleteAddedServices(this.getStore()),this.getColumnModel().setEditable(4,this.isSupportChangePort),this.isSupportChangePort||this.getStore().each((function(e){e.set("router_ports",e.get("dst_port"))}))},createServiceRuleGridConfig:function(){var e=new SYNO.ux.EnableColumn({dataIndex:"enabled",width:45,align:"center"}),t=new Ext.data.ArrayStore({fields:["port_id","desc","dst_port","router_ports","protocol","enabled"],listeners:{update:function(e,t,i){Ext.data.Record.EDIT===i&&(this.allowBlank||this.checkState())},scope:this}});return{headline:_T("routerconf","routerconf_systemport_title"),cls:"without-dirty-red-grid",plugins:e,selModel:new Ext.grid.RowSelectionModel({}),autoExpandColumn:"desc",view:new SYNO.ux.FleXcroll.grid.GridView({borderHeight:1,cacheSize:100,scrollDelay:!1,forceFit:!0}),cm:new Ext.grid.ColumnModel([e,{id:"desc",header:_T("routerconf","routerconf_header_service"),dataIndex:"desc",align:"left",width:160,renderer:function(e,t,i){var s=e;return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(s)+'"',s}},{header:_T("routerconf","routerconf_header_protocol"),dataIndex:"protocol",align:"left",width:90,renderer:function(e,t,i){var s=e.toUpperCase();return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(s)+'"',s}},{header:_T("routerconf","routerconf_header_ds_port"),dataIndex:"dst_port",sortable:!0,align:"left",width:160,renderer:function(e,t,i){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}},{header:_T("routerconf","routerconf_header_router_port"),dataIndex:"router_ports",align:"left",editor:new Ext.grid.GridEditor(new SYNO.ux.TextField({allowBlank:!1,vtype:"portfwd",validator:this.validateRouterPort.createDelegate(this),validationEvent:"keyup"})),width:160,renderer:function(e,t,i){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}}]),store:t,enableHdMenu:!1,clicksToEdit:1}},validateRouterPort:function(e){var t=this.getSelectionModel().getSelections();if(!t||0>=t.length)return!1;var i=e,s={dsPortsString:t[0].data.dst_port.toString(),routerPortsString:i};return SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidator(s)},deleteAddedServices:function(e){var t,i,s=0,n=function(e){e.get("serviceid").id==i.get("port_id")&&e.get("ds_port")==i.get("dst_port")&&(s=1)};for(t=e.getCount()-1;t>=0;t--)(i=e.getAt(t)).set("router_ports",i.get("dst_port")),s=0,this.rule_store&&(this.rule_store.each(n),1==s&&e.removeAt(t))},deactivate:function(){this.owner.getButton("next").enable()},checkState:function(){if(SYNO.SDS.Wizard.Step.prototype.checkState.call(this),!this.allowBlank){var e,t=this.getStore();for(e=0;e<t.getCount();e++)if(t.getAt(e).get("enabled"))return void this.owner.getButton("next").enable();this.owner.getButton("next").disable()}},getNext:function(){return this.stopEditing(),!!this.owner.addSystemRules(this.getStore())&&(this.next_step_callback&&this.next_step_callback.call(this.next_step_callback_scope),this.nextId)}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",WIDTH:700,HEIGHT:540,constructor:function(e){this.isSupportChangePort=e.isSupportChangePort||!1,this.next_step_callback=e.next_step_callback,this.next_step_callback_scope=e.next_step_callback_scope,this.owner=e.owner;var t=Ext.apply({title:_T("routerconf","routerconf_portfwd_title"),dsmStyle:"v5",width:this.WIDTH,height:this.HEIGHT,steps:[]},e);if(t.steps.push(this.configChooser({itemId:"option",nextId:["service","custom"]})),t.steps.push(new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ServiceRuleGrid({itemId:"service",nextId:null,owner:this,rule_store:e.rule_store,serviceDescObj:e.serviceDescObj,isSupportChangePort:this.isSupportChangePort,next_step_callback:this.next_step_callback,next_step_callback_scope:this.next_step_callback_scope})),t.steps.push(this.configCustomPort({itemId:"custom",nextId:null,owner:this,next_step_callback:this.next_step_callback,next_step_callback_scope:this.next_step_callback_scope})),this.callParent([t]),!this.isSupportChangePort){let e=this.getComponent("custom").getComponent("custom").getComponent("router_ports");e&&SYNO.ux.AddTip(e.getEl(),_T("routerconf","routerconf_tip_cannot_change_router_port"))}},configChooser:function(e){var t=Ext.apply({headline:_T("routerconf","routerconf_portfwd_opt_title"),synodefaults:{width:275},xtype:"syno_formpanel",listeners:{afterlayout:function(e){SYNO.ux.Utils.DescribeGroup(e.getComponent("systemport_radio"),e.getComponent("systemport_field")),SYNO.ux.Utils.DescribeGroup(e.getComponent("customport_radio"),e.getComponent("customport_field"))},scope:this,single:!0},items:[{xtype:"syno_displayfield",value:_T("routerconf","routerconf_portfwd_opt_desc")},{xtype:"syno_radio",boxLabel:_T("routerconf","routerconf_systemport_short"),name:"port_fwd_type",itemId:"systemport_radio",inputValue:0,checked:!0},{xtype:"syno_displayfield",indent:1,value:_T("routerconf","routerconf_systemport_long"),itemId:"systemport_field"},{xtype:"syno_radio",boxLabel:_T("routerconf","routerconf_customport_short"),name:"port_fwd_type",itemId:"customport_radio",inputValue:1},{xtype:"syno_displayfield",indent:1,value:_T("routerconf","routerconf_customport_long"),itemId:"customport_field"}],getNext:function(){return this.nextId[this.getForm().getValues().port_fwd_type]}},e);return SYNO.LayoutConfig.fill(t)},configCustomPort:function(e){var t='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>",i=Ext.apply({headline:_T("routerconf","routerconf_customport_title"),synodefaults:{width:275},xtype:"syno_formpanel",items:[{xtype:"syno_combobox",fieldLabel:_T("routerconf","routerconf_header_protocol"),name:"protocol",store:[["tcp","TCP"],["udp","UDP"]],value:"tcp"},{xtype:"syno_textfield",fieldLabel:_T("routerconf","routerconf_header_ds_port"),name:"ds_ports",itemId:"ds_ports",allowBlank:!1,vtype:"portfwd",validator:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortStringValidator,listeners:{blur:function(e){var t=e.ownerCt.getComponent("router_ports");this.isSupportChangePort?""===t.getValue()&&e.isValid()&&t.setValue(e.getValue()):t.setValue(e.getValue())},scope:this}},{xtype:"syno_textfield",fieldLabel:_T("routerconf","routerconf_header_router_port"),name:"router_ports",itemId:"router_ports",hiddenName:"router_ports",allowBlank:!1,vtype:"portfwd",disabled:!this.isSupportChangePort,validator:SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortStringValidator},{xtype:"syno_displayfield",value:t+_T("routerconf","routerconf_port_hint"),htmlEncode:!1}],getNext:function(){return!!this.owner.addCustomRules(this.getForm())&&(this.next_step_callback&&this.next_step_callback.call(this.next_step_callback_scope),this.nextId)}},e);return SYNO.LayoutConfig.fill(i)},loadUsedPorts:function(){return Ext.isDefined(this.used_ports)||(this.used_ports=this.rule_store.getUsedPortStrings()),Ext.apply({},this.used_ports)},isRuleIdInStore:function(e,t){for(var i=0;i<t.getCount();i++)if(e===parseInt(t.getAt(i).get("rule_id"),10))return!0;return!1},getUniqueId:function(e){for(var t=1;t<1e3;t++)if(!this.isRuleIdInStore(t,e))return parseInt(t,10);throw Error("incredible, there is more thant 1000 rules in rule.conf")},addSystemRules:function(e){var t,i,s=null,n=function(e,t){e||SYNO.Debug("addSingleSystemRule failed due to rec is null"),t||SYNO.Debug("addSingleSystemRule failed due to protocol is empty"),this.rule_store.add(new this.rule_store.recordType({rule_id:this.getUniqueId(this.rule_store).toString(10),enable:!0,rule_status:"",serviceid:{id:e.get("port_id"),desc:e.get("desc")},ds_port:e.get("dst_port").toString(),router_port:e.get("router_ports").toString(),router_protocol:t}))},o=!1,a=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleSet(),r=function(){var t=0,n={alert:!0,text:String.format("{0}:<br>",_T("routerconf","routerconf_port_conflict"))},r=function(e,t,i){n.text+=String.format("[{0} : {1}]<br>[{2} : {3}]<br>&nbsp",t.getServiceName(),t.getProtocol(),i.getServiceName(),i.getProtocol()),e.dsPort.length>0&&(n.text+=String.format(" {0}:{1} ",_T("routerconf","routerconf_header_ds_port"),e.dsPort.toString())),e.routerPort.length>0&&(n.text+=String.format(" {0}:{1} ",_T("routerconf","routerconf_header_router_port"),e.routerPort.toString())),n.text+="<br>"};for(t=0;t<e.getCount();t++)(i=e.getAt(t)).get("enabled")&&(s=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Rule({blEnable:i.get("enabled"),szServiceName:i.get("desc"),szDsPorts:i.get("dst_port").toString(),szRouterPorts:i.get("router_ports").toString(),szProtocol:i.get("protocol")}),a.addRule(s,r)||(o=!0));return!o||(this.reportFailure(n),!1)}.bind(this);if(!r())return!1;for(t=0;t<e.getCount();t++)(i=e.getAt(t)).get("enabled")&&("all"===i.get("protocol")?(n.call(this,i,"tcp"),n.call(this,i,"udp")):n.call(this,i,i.get("protocol")));return!0},addCustomRules:function(e){if(!e.isValid())return!1;var t=e.findField("protocol").getValue(),i=e.findField("ds_ports").getValue(),s=e.findField("router_ports").getValue(),n=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidator({dsPortsString:i,routerPortsString:s});return!0!==n?(this.setStatusError({text:n,clear:!0}),!1):(this.rule_store.add(new this.rule_store.recordType({rule_id:this.getUniqueId(this.rule_store).toString(10),enable:!0,rule_status:"",serviceid:{id:"",desc:_T("routerconf","routerconf_customport_short")},ds_port:i,router_port:s,router_protocol:t})),!0)},reportFailure:function(e){return e.alert?this.getMsgBox().alert(this.title,e.text):this.setStatusError(e),!1}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleStore",{extend:"SYNO.API.JsonStore",constructor:function(e){if(!Ext.isDefined(e.owner))throw Error("owner is undefined");if(this.grid=e.grid,!Ext.isDefined(this.grid))throw Error("grid is undefined");this.systemSetRules=[];var t=this.getWebAPIDesc();t.appWindow=e.owner,t.autoDestroy=!0,t.fields=["enable","rule_id","serviceid","router_port","router_protocol","rule_status","ds_port","service_name","remap_router_port_map_table"],t.listeners={exception:this.onStoreException,beforeload:this.onBeforeLoad,load:this.onAfterLoad,add:this.onRuleChanged,update:this.onRuleChanged,remove:this.onRuleChanged,scope:this};var i=Ext.apply(t,e);this.callParent([i])},getWebAPIDesc:function(){return{api:"SYNO.Core.PortForwarding.Rules",method:"load",version:1}},joinCompound:function(e){var t=function(e){e?this.loadData(e):SYNO.Debug("SYNO.Core.PortForwarding.Rules load return empty")}.bind(this);e.params.push(this.getWebAPIDesc()),e.callbacks.push(t)},setServiceDescObj:function(e){this.serviceDescObj=e},onStoreException:function(e,t,i,s,n,o){SYNO.Debug("Store exception: options:",s),this.owner.unmask(),this.owner.setStatusError()},onBeforeLoad:function(e,t){},pasteServiceDesc:function(){for(var e=0;e<this.getCount();e++){var t=this.getAt(e).get("serviceid");this.getAt(e).set("serviceid",{id:t,desc:this.serviceDescObj.getServiceDesc(t)})}this.commitChanges()},onAfterLoad:function(e,t,i){var s=null;this.serviceDescObj&&!this.serviceDescObj.hasInitialized()?this.serviceDescObj.initAsync(function(){this.pasteServiceDesc()}.bind(this)):this.pasteServiceDesc(),this.systemSetRules=[];for(var n=0;n<this.getCount();n++)""!==(s=this.getAt(n)).get("service_name")&&this.systemSetRules.push(s);this.remove(this.systemSetRules),this.commitChanges(),this.grid.updateGridHeight(),this.grid.updateUsedPortsAndShow(),this.grid.isRuleStatusLoaded=!1,this.blHasModified=!1,Ext.isDefined(this.grid.confirmLostChangeResolve)&&this.grid.confirmLostChangeResolve(),this.grid.confirmLostChangeResolve=void 0,this.showQuickConnectRule()},getSystemUsedPorts:function(){for(var e=0,t=0;t<this.systemSetRules.length;t++)this.systemSetRules[t].get("enable")&&e++;return e},countUsedPortsNumber:function(){var e=this.getPortsArray();return e?e.length+this.getSystemUsedPorts():(SYNO.Debug("countUsedPortsNumber failed"),0)},onRuleChanged:function(e,t,i){this.grid.checkOnRuleChanged(),this.grid.updateGridHeight()},getUsedPortStrings:function(){for(var e={tcp:"",udp:""},t=0;t<this.getCount();t++){var i=this.getAt(t);i.get("enable")&&(e[i.get("router_protocol")]&&(e[i.get("router_protocol")]+=","),e[i.get("router_protocol")]+=i.get("router_port"))}return e},getPortsArray:function(){var e=this.getUsedPortStrings(),t="",i=[];return e&&(e.tcp&&(t+=e.tcp),e.udp&&(t&&(t+=","),t+=e.udp),i=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray(t)),i},getRules:function(e=!0){var t=[],i=0,s=0,n=["enable","rule_id","ds_port","router_port","router_protocol","serviceid","service_name","force"],o=null;let a;for(i=0;i<this.getCount();i++)if(o={id:i},a=this.getAt(i).get("readonly"),!e||!a){for(s=0;s<n.length;s++)o[n[s]]="serviceid"===n[s]?this.getAt(i).get(n[s]).id:this.getAt(i).get(n[s])||!1;t.push(o)}return t},getEnabledRules:function(){let e=0,t=this.getRules(!1),i=[];for(e=0;e<t.length;e++)t[e].enable&&i.push(t[e]);return i},loadRules:function(){var e=this.owner,t=this.grid,i={callback:function(i,s,n){e.clearStatusBusy(),i?this.loadData(s):e.getMsgBox().alert(t.title,SYNO.API.getErrorString(s.code))},scope:this};e.setStatusBusy(),Ext.apply(i,this.getWebAPIDesc()),synowebapi.request(i)},remove:function(){this.callParent(arguments),this.blHasModified=!0},add:function(){this.callParent(arguments),this.blHasModified=!0},isDirty:function(){var e,t,i=this.getModifiedRecords();if(this.blHasModified)return!0;if(0>=i.length)return!1;for(t=0;t<i.length;t++)if(null!==(e=i[t].modified)){if(1<Object.keys(e).length)return!0;if(!e.hasOwnProperty("rule_status"))return!0}return!1},showQuickConnectRule:function(){for(let e=0;e<this.systemSetRules.length;e++){let t,i=this.systemSetRules[e];"quickconnect"===i.get("service_name")&&(t=new this.recordType({readonly:!0,rule_id:i.get("rule_id").toString(),enable:i.get("enable"),rule_status:"",disabled:!0,remap_router_port_map_table:"",ds_port:i.get("ds_port").toString(),router_port:i.get("router_port").toString(),service_name:i.get("service_name").toString(),router_protocol:i.get("router_protocol").toString(),serviceid:{id:"",desc:_T("relayservice","relayservice_title")}}),this.add(t))}this.commitChanges(),this.blHasModified=!1},reset:function(){Ext.isDefined(this.reader.jsonData)&&this.loadData(this.reader.jsonData),this.blHasModified=!1},reportFailure:function(e){return e.alert?this.owner.getMsgBox().alert("",e.text):this.owner.setStatusError(e),!1}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleEnableColumn",{extend:"SYNO.ux.EnableColumn",onCellClick:function(e,t,i){let s=e.getStore().getAt(t);if(!s.get("readonly"))return this.callParent(arguments)},isIgnore:function(e,t){return!(!t||!t.get("readonly"))},renderer:function(e,t,i){let s=i.get("disabled")?"disabled-":"",n=e?"checked":"unchecked";return String.format('<div class="syno-ux-grid-enable-column-{0}{1}">&nbsp;</div>',s,n)}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Checker",{extend:"Object",constructor:function(e){this.previousProcess=null,this.scope=null,this.statusHandler=null,e.appWin?this.appWin=e.appWin:(SYNO.Debug("contructor failed due to no module"),this.appWin=null),e.scope?this.scope=e.scope:(SYNO.Debug("constructor failed due to no scope"),this.scope=null),e.callback?this.statusHandler=e.callback:(SYNO.Debug("constructor failed due to no callback"),this.statusHandler=null),e.interval?this.interval=e.interval:this.interval=1,this.pfConfPollId=null,this.pfConf={interval:this.interval,immediate:!1,webapi:{api:"SYNO.Core.PortForwarding",version:1,method:"get_current_process"},status_callback:function(e,t,i,s){e?(this.previousProcess=this.process,this.process=t.process,this.processTaskId=t.task_id):(this.previousProcess=this.process,this.process="",this.processTaskId=""),this.statusHandler.call(this.scope),SYNO.Debug("pf conf status_callback")},scope:this}},Start:function(){this.Stop(),this.pfConfPollId=this.appWin.pollReg(this.pfConf)},Stop:function(){this.pfConfPollId&&(this.appWin.pollUnreg(this.pfConfPollId),this.pfConfPollId=null)}}),Ext.ns("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util"),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.NetworkInfo=function(){var e={},t=function(t){e=t};return{joinCompound:function(e){e.params.push({api:"SYNO.Core.Network",version:1,method:"get"}),e.callbacks.push(t)},getNetworkInfo:function(){return e}}},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.RouterConfInfo=function(){var e={},t=function(t){e=""===t.router_brand&&""===t.router_model&&""===t.router_version?{}:t};return{hasRouterConfInfo:function(){return 0!==Object.keys(e).length},sendRouterConfGetWebapi:function(){var e=Ext.apply({callback:function(e,i,s){e&&t(i)},scope:this},{api:"SYNO.Core.PortForwarding.RouterConf",version:1,method:"get"});SYNO.API.Request(e)},joinCompound:function(e){e.params.push({api:"SYNO.Core.PortForwarding.RouterConf",version:1,method:"get"}),e.callbacks.push(t)},getRouterConf:function(){return e}}},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.ServiceName=function(e,t){var i=[],s={},n=!1;if(!e)return SYNO.Debug("scope is empty"),{};if(!t)return SYNO.Debug("appWin is empty"),{};if(!t.sendWebAPI)return SYNO.Debug("appWin.sendWebAPI is empty"),{};var o=function(){return function(e){i=[],s={};for(var t=e.port_info,o=0;o<t.length;o++)s[t[o].port_id]=t[o].desc,i.push([t[o].port_id,t[o].desc,t[o].dst_port,t[o].router_ports,t[o].protocol,t[o].enabled]);n=!0}};return{hasInitialized:function(){return n},initAsync:function(t){var i={api:"SYNO.Core.Service.PortInfo",version:1,method:"load",params:{target:["port_forward"]}};i.scope=e,i.callback=function(e,i,s){if(e){if(!i)return void SYNO.Debug("data is empty");o()(i)}else SYNO.Debug("send Service.PortInfo failed");t&&t()},SYNO.API.Request(i)},joinCompound:function(e){e.params.push({api:"SYNO.Core.Service.PortInfo",version:1,method:"load",params:{target:["port_forward"]}}),e.callbacks.push(o())},getServiceDesc:function(e){var t=_T("routerconf","routerconf_customport_short");return e?s?(s[e]?t=s[e]:e&&(t=e),t):(SYNO.Debug("serviceNameMapping is empty"),e):t},getPortInfoArrayData:function(){return i}}},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.PortStatus=function(e){var t=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding,i=e,s=function(i,s){for(var n="",o=e[i],a=0;a<o[t.WEBAPI_PORT_INFO].length;a++){var r=o[t.WEBAPI_PORT_INFO][a][s];n?n=n+", "+r:n+=r}return n};return{getRulesNumber:function(){return i.length},getRule:function(e){return i[e]},getDsPorts:function(e){return s(e,t.WEBAPI_DS_PORT)},getRemapRouterPorts:function(e){return s(e,t.WEBAPI_REMAP_ROUTER_PORT)},getRouterPorts:function(e){return s(e,t.WEBAPI_ROUTER_PORT)},getFailRouterPorts:function(e){var i="";return function(e,i,s){for(var n=0;n<e[t.WEBAPI_PORT_INFO].length;n++)i===e[t.WEBAPI_PORT_INFO][n].status&&s(e[t.WEBAPI_PORT_INFO][n])}(e,2,(function(e){i?i=i+", "+e[t.WEBAPI_ROUTER_PORT]:i+=e[t.WEBAPI_ROUTER_PORT]})),i}}},Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortConflictDialog",{extend:"SYNO.SDS.ModalWindow",CONFLICT_DIALOG_HEIGHT:470,CONFLICT_DIALOG_WIDTH:680,constructor:function(e){this.forciable=e.forciable,this.confirmCB=e.confirmCB;var t=Ext.apply({xtype:"syno_formpanel",title:_T("routerconf","header_conflict_router_port"),cls:"syno-portforwarding-conflict-panel",autoFlexcroll:!0,trackResetOnLoad:!0,width:this.CONFLICT_DIALOG_WIDTH,height:this.CONFLICT_DIALOG_HEIGHT,resizable:!1,closeAction:"commitHandler",items:[{xtype:"syno_displayfield",cls:"syno-portforwarding-conflict-panel-main-desc",value:_T("routerconf","conflict_desc")},{xtype:"syno_radio",id:this.random_apply_btnid=Ext.id(),name:"apply_action_selector",boxLabel:_T("routerconf","conflict_use_random"),inputValue:"random",checked:!0,scope:this,handler:this.onRadioClick},{xtype:"syno_radio",id:this.force_apply_btnid=Ext.id(),name:"apply_action_selector",boxLabel:_T("routerconf","conflict_force_apply"),inputValue:"force",scope:this,handler:this.onRadioClick},{xtype:"syno_displayfield",cls:"syno-portforwarding-conflict-panel-desc",value:_T("routerconf","conflict_force_apply_desc"),indent:1},{xtype:"syno_displayfield",cls:"syno-portforwarding-conflict-panel-preview",value:_T("routerconf","conflict_result_preview")},{xtype:"syno_gridpanel",itemId:"conflict_records",cls:"syno-portforwarding-conflict-panel-grid",trackOver:!1,cm:this.createColumnModel(),draggable:!1,enableColumnMove:!1,enableHdMenu:!1,overClass:"",store:this.createJsonStore(),height:200}],buttons:[{text:_T("common","apply"),xtype:"syno_button",btnStyle:"blue",itemId:"apply",scope:this,handler:function(){this.commitHandler()}}],listeners:{show:this.onShow,afterrender:this.afterRender,activate:this.onActivate,deactivate:this.onDeactivate}},e);this.callParent([t])},onRadioClick:function(e,t){if(e.checked)switch(e.value){case"random":this.updatePreview(!1);break;case"force":this.updatePreview(!0);break;default:SYNO.Debug("Unexpected options: ",e.value)}},afterRender:function(){this.callParent(arguments);let e=this.createtConflictArray(),t=this.getComponent("conflict_records");t.getStore().loadData(e,!1),t.setHeight(30*(t.getStore().totalLength+1)+12),t.doLayout()},onShow:function(){this.updateFleXcroll()},createColumnModel:function(){return new Ext.grid.ColumnModel([{header:_T("routerconf","routerconf_header_service"),dataIndex:"serviceid",id:"serviceid",sortable:!0,width:160,renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}},{header:_T("routerconf","routerconf_header_ds_port"),dataIndex:"ds_port",id:"ds_port",width:120,renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}},{header:_T("routerconf","routerconf_header_router_port"),dataIndex:"router_port",id:"router_port",width:120,renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}},{header:_T("routerconf","routerconf_header_protocol"),dataIndex:"protocol",id:"protocol",sortable:!0,width:100,renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}}])},createJsonStore:function(){return new Ext.data.JsonStore({autoLoad:!1,fields:[{mapping:"enable",name:"enable"},{mapping:"status",name:"status"},{mapping:"service_name",name:"service_name"},{mapping:"serviceid",name:"serviceid"},{mapping:"ds_port",name:"ds_port"},{mapping:"router_port",name:"router_port"},{mapping:"router_port_tmp",name:"router_port_tmp"},{mapping:"remap_router_port_tmp",name:"remap_router_port_tmp"},{mapping:"protocol",name:"protocol"},{mapping:"rule_index",name:"rule_index"}]})},createtConflictArray:function(){var e=[],t=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_SERVICENAME,i=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.WEBAPI_SERVICEID;if(this.portStatusObj)for(var s=0;s<this.portStatusObj.getRulesNumber();s++){var n=this.portStatusObj.getRule(s);e.push({enable:!0,status:this.portStatusObj.getFailRouterPorts(n),serviceid:this.serviceDescObj.getServiceDesc(n[i]),service_name:n[t],ds_port:this.portStatusObj.getDsPorts(s),router_port:this.portStatusObj.getRemapRouterPorts(s),router_port_tmp:this.portStatusObj.getRouterPorts(s),remap_router_port_tmp:this.portStatusObj.getRemapRouterPorts(s),protocol:n.router_protocol.toUpperCase(),rule_index:n.index})}return e},updatePreview:function(e){for(var t=this.getComponent("conflict_records").getStore(),i=0;i<t.getCount();i++){var s=t.getAt(i);e?s.set("router_port",s.get("router_port_tmp")):s.set("router_port",s.get("remap_router_port_tmp"))}t.commitChanges()},showForceApplyConfirm:function(){this.forceApplyConfirmDialog=new SYNO.SDS.ModalWindow({owner:this,cls:"x-window-dlg confirm-delete-icon",closable:!1,resizable:!1,draggable:!1,header:!1,elements:"body",padding:"44px 30px 0px 30px",layout:"fit",width:480,autoHeight:!0,fbar:["->",{xtype:"syno_button",itemId:"cancel",text:_T("common","cancel"),scope:this,handler:function(){this.forceApplyConfirmDialog.close()}},{xtype:"syno_button",itemId:"yes",text:_T("routerconf","conflict_force_apply_yes"),btnStyle:"red",scope:this,handler:function(){this.showConfirmDialog=!0,this.commitHandler(),this.close()}}],items:[{xtype:"syno_displayfield",name:"desc",value:_T("routerconf","conflict_force_apply_comfirm")}]}),this.forceApplyConfirmDialog.show()},commitHandler:function(){if(this.confirmCB){let s=Ext.getCmp(this.force_apply_btnid).getValue();var e=this.getComponent("conflict_records").getStore();if(s&&!this.showConfirmDialog)return void this.showForceApplyConfirm();for(var t=0;t<e.getCount();t++){var i=e.getAt(t);i.get("enable")||i.set("router_port",i.get("router_port_tmp"))}e.commitChanges(),this.confirmCB({blForce:s,store:e})}this.close()}}),SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.OtherDeviceUsedPortNumber=function(e){var t=-1,i=[],s=[];return e?e.sendWebAPI?{asyncUpdateMaxPorts:function(e){SYNO.API.Request({api:"SYNO.Core.PortForwarding.RouterInfo",version:1,method:"get",callback:function(n,o,a){n?(t=o.otherDeviceUsed,i=o.otherDeviceUsedTCPPorts,s=o.otherDeviceUsedUDPPorts):(t=0,i=[],s=[]),e&&e()}})},getOtherDeviceUsedPortsNumber:function(){return t},getConflictPortsWithOtherDevice:function(e,t){for(var n=[],o="TCP"===t.toUpperCase()?i:s,a=0;a<e.length;a++)for(var r=0;r<o.length;r++)e[a]===o[r]&&n.push(e[a]);return n}}:(SYNO.Debug("appWin.sendWebAPI is empty"),{}):(SYNO.Debug("appWin is empty"),{})},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.GetDisabledSystemServiceMsg=function(e,t,i){if(!e)return SYNO.Debug("appWin is empty"),{};if(!e.sendWebAPI)return SYNO.Debug("appWin.sendWebAPI is empty"),{};var s=function(e,t){if(!t)return SYNO.Debug("isPortIdInService failed due to service_obj is null"),!1;if(!t.additional)return!1;if(!t.additional.port_info)return!1;for(var i=t.additional.port_info,s=0;s<i.length;s++)if(e===i[s].port_id)return SYNO.Debug("matched prot_id="+e+", service="+t.display_name),!0;return!1};SYNO.API.Request({api:"SYNO.Core.Service",method:"get",version:2,params:{additional:["port_info"]},callback:function(e,n,o){var a="";if(e&&n){for(var r={},l=0;l<t.getCount();l++){var d=t.getAt(l);if(d.get("enable"))for(var c=d.get("serviceid").id,h=0;h<n.service.length;h++)s(c,n.service[h])&&"disabled"==n.service[h].enable_status&&(r[n.service[h].service_id]=n.service[h])}for(var u in r)r.hasOwnProperty(u)&&(a+="<br>&nbsp;&nbsp;"+r[u].display_name);i(a)}}})},SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortString=function(e){var t="",i={port:null,originPort:null},s=!1,n=e;return{init:function(){t="",i={port:null,originPort:null},s=!1},addPort:function(e){var o={};i.port?1===Math.abs(i.port-e.port)&&1===Math.abs(i.originPort-e.originPort)?s||(t+="-",s=!0):(t=function(e){var t=e.ret,i=e.prePortObj,s=e.curPortObj,n=e.toStringCB;return e.blDashed?(t=(t+=n(i))+", "+n(s),e.blDashed=!1):t=t+", "+n(s),t}(o={ret:t,blDashed:s,prePortObj:i,curPortObj:e,toStringCB:n}),s=o.blDashed):t=n(e),i=e},finish:function(){s&&(t+=n(i),s=!1)},toString:function(){return t}}},Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleGrid",{extend:"SYNO.SDS.Utils.EditorGridPanel",getHelpParam:function(){return"AdminCenter/connection_routerconf.html"},constructor:function(e){this.msg="",this.testPortConnPollId=null,this.iface=null,this.state=null,this.routerinfo=null,this.isActivate=!1,this.originalFormPanel=e.originalFormPanel,this.module=e.module;var t=this.createConfig(e);this.callParent([t])},onBeforeRequest:function(e){if("set"===e){var t=0,i=this.getStore();if(!this.isDirty())return!0;if(!this.isSupportChangePort()&&this.hasChangePortRule(i))return this.showDisableRulesConfirmDialog(),!1;if(this.hasConflictRule())return!1;if(this.isExceedMaxUsedPorts())return this.module.appWin.getMsgBox().alert(this.title,String.format(_T("routerconf","routerconf_exceed_max_rule"),this.getMaxPortsNumber())),!1;if(!0!==this.flag_show_warning_dialog)return this.showWarningDialog(),!1;for(t=i.getCount()-1;t>=0;t--)i.getAt(t).set("rule_status","");this.getSelectionModel().clearSelections()}else"get"===e&&this.changeState("waiting");return!0},processParams:function(e,t){if("get"===e){this.resetMainPage();var i={params:[],callbacks:[]};this.routerConfInfoObj=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.RouterConfInfo(),this.networkInfoObj=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.NetworkInfo(),this.maxAndUsedPortObj=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.OtherDeviceUsedPortNumber(this.module.appWin),this.serviceDescObj=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Util.ServiceName(this,this.module.appWin),this.getStore().setServiceDescObj(this.serviceDescObj),this.showLoadingForMaxAndUsedPorts(),this.serviceDescObj.joinCompound(i),this.getStore().joinCompound(i),this.routerConfInfoObj.joinCompound(i),this.networkInfoObj.joinCompound(i),t=t.concat(i.params),this.compound=i}else"set"===e&&this.isDirty()&&(this.module.panel.registerProcessReturnData("portforwardingtab"),t.push({api:"SYNO.Core.PortForwarding.Rules",version:1,method:"save",params:{rules:this.getStore().getRules(),task_id_suffix:"PF"}}));return t},processReturnData:function(e,t,i){if("get"===e){var s=this.compound;if(Ext.each(t.result,(function(e,t){for(var i=0;i<s.params.length;i++)SYNO.ux.Utils.checkApiConsistency(e,s.params[i])&&e.success&&s.callbacks[i].call(this,e.data)}),this),this.isUpnpOrNatpmpRouter()?this.maxAndUsedPortObj.asyncUpdateMaxPorts(function(){this.updateUsedPortsAndShow()}.bind(this)):this.hideMaxAndUsedPorts(),!this.isActivate)return void(this.isGetReturnDataDone=!0);this.getReturnDataCallback()}else if("set"===e){this.flag_show_warning_dialog=!1;var n=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.PortForwarding.Rules","save");if(!n)return;this.disableAllButton(),this.startPollSaveRuleStatus({taskId:n.task_id,success_callback:this.saveSuccess.bind(this)})}},getReturnDataCallback:function(){return null===this.networkInfoObj.getNetworkInfo().gateway_info?(this.confirmToChangeSetting(_T("routerconf","routerconf_require_iface"),"SYNO.SDS.AdminCenter.Network.Main","leaf_lan"),this.changeState("error")):0!==Object.keys(this.networkInfoObj.getNetworkInfo()).length&&this.networkInfoObj.getNetworkInfo().gateway_info.ifname&&this.networkInfoObj.getNetworkInfo().gateway_info.ip&&this.networkInfoObj.getNetworkInfo().gateway_info.mask&&this.networkInfoObj.getNetworkInfo().gateway_info.type?"pppoe"===this.networkInfoObj.getNetworkInfo().gateway_info.ifname?(this.confirmToChangeSetting(_T("routerconf","routerconf_require_not_pppoe"),"SYNO.SDS.AdminCenter.Network.Main","leaf_pppoe",{tab:"InterfaceTab"}),this.changeState("error")):(this.getColumnModel().setEditable(4,this.isSupportChangePort()),this.getView().refresh(),this.routerConfInfoObj.hasRouterConfInfo()?this.changeState("normal"):this.changeState("set_router"),void this.statusUpdaterStart()):(this.confirmToChangeSetting(_T("routerconf","routerconf_require_gateway"),"SYNO.SDS.AdminCenter.Network.Main","leaf_lan"),this.changeState("error"))},showDisableRulesConfirmDialog:async function(){var e=this.getStore();await this.module.appWin.getMsgBox().alert(_T("common","note"),_T("routerconf","disable_change_port_rules_confirm")),this.disableChangePortRules(e),this.module.panel.applyAllForm(this.module.panel.applyAllFormOptions)},getListHtml:function(e){var t='<div style="padding-left:10px;line-height:20px;">';return t+='<ul style="list-style:disc;list-style-position:outside;padding-left:12px">',Ext.each(e,(function(e){t+="<li>"+e+"</li>"})),t+="</ul></div>"},showWarningDialog:function(){var e=[];e.push(_T("routerconf","routerconf_overwrite_warning")),e.push(String.format(_T("routerconf","routerconf_wan_warning"),_D("product"))),e.push(_T("routerconf","routerconf_logout_warning")),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ConfirmDialog({owner:this.module.appWin,items:[{xtype:"syno_displayfield",cls:"syno-portforwarding-dialog-title",value:_T("routerconf","apply_rules_desc"),style:"padding-bottom: 12px"},{xtype:"syno_displayfield",htmlEncode:!1,value:this.getListHtml(e)}],onApply:function(e){this.isExceedMaxUsedPorts(!0)?this.showExceedMappableWarningDialog():(this.flag_show_warning_dialog=!0,this.module.panel.applyAllForm(this.module.panel.applyAllFormOptions))}.bind(this)}).show()},showExceedMappableWarningDialog:function(){new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ConfirmDialog({owner:this.module.appWin,width:700,items:[{xtype:"syno_displayfield",cls:"dialog-title",value:_T("routerconf","routerconf_exceed_max_port_title")},{xtype:"syno_displayfield",value:_T("routerconf","routerconf_exceed_max_port_take_time")+_T("routerconf","routerconf_exceed_max_port_reduce_ports")}],onApply:function(e){this.flag_show_warning_dialog=!0,this.module.panel.applyAllForm(this.module.panel.applyAllFormOptions)}.bind(this)}).show()},createConfig:function(e){this.maxUsedDisplay=new SYNO.ux.DisplayField({itemId:"max_used",htmlEncode:!1,style:"padding: 4px 0px; height: 20px;"}),this.store=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleStore({owner:this.module.appWin,grid:this,serviceDescObj:this.serviceDescObj});var t=this.createColumnModel();return SYNO.LayoutConfig.fill(Ext.apply({width:600,height:300,title:_T("tree","leaf_routerconf"),cm:t,plugins:t.config[0],autoExpandColumn:"serviceid",enableHdMenu:!1,loadMask:!1,cls:"without-dirty-red-grid syno-portforwarding-main-grid syno-portforwarding-listitem",listeners:{rowcontextmenu:this.onRowCtxMenu,containercontextmenu:this.showCtxMenu,activate:this.onActivate,deactivate:this.onDeactivate,scope:this},clicksToEdit:1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:this.checkOnSelectionChanged,scope:this}}),store:this.store,tbar:[{xtype:"syno_button",text:_T("common","create"),handler:this.onCreateRule,scope:this,itemId:"create"},{xtype:"syno_button",text:_T("routerconf","setup_router_button"),handler:this.onSetupRouter,scope:this,itemId:"router"},{xtype:"syno_button",text:_T("common","delete"),handler:this.onDeleteRule,scope:this,itemId:"del"},{disabled:_S("demo_mode"),xtype:"syno_button",text:_T("routerconf","routerconf_test_conn"),handler:this.onTest,scope:this,itemId:"test"}],bbar:new SYNO.ux.PagingToolbar({store:this.store,displayInfo:!1}),fbar:{xtype:"syno_toolbar",layout:"fit",items:[this.maxUsedDisplay]},footerCfg:{style:"padding: 6px 0px 0px 0px;"},viewConfig:{markDirty:!1,emptyText:this.getGridEmptyText("no_rule")}},e))},updateGridEmptyText:function(e){this.getView().emptyText=this.getGridEmptyText(e),this.getView().refresh()},getGridEmptyText:function(e){let t=['<div class="syno-dataview">','<div class="empty-text-wrap">','<div class="empty-text-inner-wrap">','<div class="empty-text-icon"></div>','<div class="empty-text">'];switch(e){case"no_router":t.push(_T("routerconf","warn_setup_router"));break;case"no_rule":t.push(_T("routerconf","routerconf_no_rule"));break;default:t.push("")}return t.concat(["</div>","</div>","</div>","</div>"]).join("")},updateGridHeight:function(){let e=this.getView().el.query(".contentwrapper")[0];0<this.getStore().getCount()?e.style.height="":e.style.height="100%"},onActivate:function(){this.isActivate=!0,!0===this.originalFormPanel.pfNeedReload&&this.store.load(),this.originalFormPanel.pfNeedReload=!1,this.isGetReturnDataDone&&this.getReturnDataCallback()},onDeactivate:function(){this.isActivate=!1,this.statusUpdaterStop()},ds_port_renderer:function(e,t,i){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e},router_port_renderer:function(e,t,i,s,n){var o=0,a=function(e){return e?!!e.originPort:(SYNO.Debug("portObj is empty"),!1)},r=[],l=null,d=null;if(this.getColumnModel().isCellEditable(n,s)||(t.css=t.css.replace("syno-ux-textfield","")),i.data.remap_router_port_map_table){for(r=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Ports(e).toArr(),l=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortString((function(e){return a(e)?'<span class="blue-status">'+e.port+"</span>":e.port})),d=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortString((function(e){return a(e)?e.port+"("+e.originPort+")":e.port})),l.init(),d.init(),o=0;o<r.length;o++)for(var c=r[o].min;c<=r[o].max;c++){var h=i.data.remap_router_port_map_table[c];l.addPort({port:c,originPort:h}),d.addPort({port:c,originPort:h})}return l.finish(),d.finish(),t.cellAttr='ext:qtip="'+Ext.util.Format.htmlEncode(d.toString())+'"',l.toString()}var u=!0,p=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray(i.data.ds_port),_=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray(i.data.router_port),m=e;for(o=0;o<p.length;o++)if(p[o]!==_[o]){u=!1;break}return!1===u&&(m='<span class="blue-status">'+e+"</span>"),t.cellAttr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',m},rule_status_renderer:function(e,t){var i={testing:_T("routerconf","routerconf_status_testing"),waiting:_T("routerconf","routerconf_status_testing"),yes:_T("routerconf","routerconf_status_ok"),fail:_T("routerconf","routerconf_tip_net_cnn_failed"),udp:_T("routerconf","routerconf_tip_udp"),nolisten:_T("routerconf","routerconf_tip_no_service"),notest:_T("routerconf","routerconf_status_ntest"),psuccess:_T("routerconf","routerconf_tip_psuccess"),disabled:_T("common","disabled")},s={testing:'<div class="x-status-loading-icon-in-grid x-loading-status-center x-status-loading-icon"><span></span></div>',waiting:'<div class="x-status-loading-icon-in-grid x-loading-status-center x-status-loading-icon"><span></span></div>',yes:_T("routerconf","routerconf_status_ok"),fail:_T("routerconf","routerconf_status_failed"),udp:_T("routerconf","routerconf_status_ntest"),nolisten:_T("routerconf","routerconf_status_ntest"),notest:_T("routerconf","routerconf_status_ntest"),psuccess:_T("routerconf","routerconf_status_failed"),disabled:_T("common","disabled")};return t.attr=e in i?String.format('ext:qtip="{0}"',Ext.util.Format.htmlEncode(i[e])):"",e in s?s[e]:"-"},router_protocol_renderer:function(e,t){var i={tcp:_T("routerconf","routerconf_protocol_tcp"),udp:_T("routerconf","routerconf_protocol_udp")};return e in i?i[e]:"-"},serviceid_renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e.desc)+'"',e.desc},createColumnModel:function(){var e={grid:this,columns:[new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleEnableColumn({header:_T("routerconf","routerconf_header_enabled"),dataIndex:"enable",width:80,align:"center",commitChanges:!1}),{header:_T("routerconf","routerconf_header_status"),dataIndex:"rule_status",width:80,align:"center",renderer:this.rule_status_renderer},{header:_T("routerconf","routerconf_header_service"),id:"serviceid",dataIndex:"serviceid",width:150,align:"left",renderer:this.serviceid_renderer},{header:_T("routerconf","routerconf_header_ds_port"),dataIndex:"ds_port",width:120,align:"left",renderer:this.ds_port_renderer},{header:_T("routerconf","routerconf_header_router_port"),dataIndex:"router_port",width:120,align:"left",renderer:this.router_port_renderer,scope:this,editor:new SYNO.ux.TextField({validationEvent:"keyup",validator:this.validateRouterPort.createDelegate(this),allowBlank:!1,vtype:"portfwd"})},{header:_T("routerconf","routerconf_header_protocol"),dataIndex:"router_protocol",width:60,align:"center",renderer:this.router_protocol_renderer}],isCellEditable:function(e,t){return!this.grid.getStore().getAt(t).get("readonly")&&Ext.grid.ColumnModel.prototype.isCellEditable.call(this,e,t)}};return new Ext.grid.ColumnModel(e)},validateRouterPort:function(e){var t=this.getSelectionModel().getSelections();if(!t||0>=t.length)return!1;var i=e,s={dsPortsString:t[0].data.ds_port.toString(),routerPortsString:i};return SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.PortsValidator(s)},changeState:function(e){var t={error:this.maskAll,normal:function(){this.checkOnRuleChanged(),this.checkOnSelectionChanged(this.getSelectionModel()),this.el.unmask(),this.getView().el.unmask()},set_router:function(){this.el.unmask(),0<this.getStore().getCount()&&this.getView().el.mask(_T("routerconf","warn_setup_router"),"syno-ux-mask-info"),this.disableAllButton(),this.updateGridEmptyText("no_router"),this.enableButton("router",!0)},testing:this.disableAllButton,waiting:this.maskAll};if(!(e in t))throw Error("changeState: no such state: "+e);this.state=e,t[e].call(this)},getState:function(){return this.state},checkOnRuleChanged:function(){var e=this.isDirty();this.updateUsedPortsAndShow(),this.getButton("router").enable(),this.getButton("create").enable(),this.getButton("test").enable(),this.getButton("test").setTooltip(""),"normal"!==this.state||0>=this.getStore().getCount()?this.getButton("test").disable():e&&(this.getButton("test").disable(),this.getButton("router").disable()),e&&this.getButton("test").setTooltip(_T("routerconf","routerconf_disable_test_btn_reason"))},checkOnSelectionChanged:function(e){let t,i;if(0<e.getCount()&&"normal"===this.state){t=e.getSelections(),i=!1;for(let e=0;e<t.length;e++)if(t[e].data.readonly){i=!0;break}i?this.enableButton("del",!1):this.enableButton("del",!0)}else this.enableButton("del",!1)},isDirty:function(){return this.getStore().isDirty()||this.isRouterChanged},reset:function(){this.getStore().reset(),this.isRouterChanged=!1},getMaxAndUsedPortPrefix:function(){var e=_T("routerconf","max_port_map_number");return _T("routerconf","used_port_map_number")+"/"+e+_T("common","colon")},showMaxAndUsedPortObj:function(e,t){var i="",s=function(e,t){var i={green:'<span class="green-status">',red:'<span class="red-status">',blue:'<span class="blue-status">',orange:'<span class="orange-status">'}[t];return i?i+e+"</span>":e},n=function(e,t){var i=e.toString(),n=t.toString();return n=s(n,t/e>=.9?"red":"green"),i=s(i,"blue"),this.getMaxAndUsedPortPrefix()+n.bold()+"/"+i.bold()}.bind(this);0<=e&&0<=t&&(i=n(e,t),this.maxUsedDisplay.setValue(i))},getMaxPortsNumber:function(){return parseInt(this.routerConfInfoObj.getRouterConf().router_max_rule,10)},getOtherDeviceUsedPortsNumber:function(){return this.maxAndUsedPortObj.getOtherDeviceUsedPortsNumber()},getSystemUsedPorts:function(){return this.getStore().getSystemUsedPorts()},showMaxAndUsedPortsTips:function(){var e;""!==(e=function(){var e=_T("routerconf","max_and_used_tip");return 0>=this.getSystemUsedPorts()+this.getOtherDeviceUsedPortsNumber()?"":String.format(e,this.getSystemUsedPorts()+this.getOtherDeviceUsedPortsNumber())}.bind(this)())?Ext.QuickTips.register({target:this.maxUsedDisplay.getEl(),text:e}):Ext.QuickTips.unregister(this.maxUsedDisplay.getEl())},updateUsedPortsAndShow:function(){0<=this.getOtherDeviceUsedPortsNumber()&&this.isUpnpOrNatpmpRouter()&&(this.showMaxAndUsedPortObj(this.getMaxPortsNumber(),this.getOtherDeviceUsedPortsNumber()+this.getStore().countUsedPortsNumber()),this.showMaxAndUsedPortsTips())},showLoadingForMaxAndUsedPorts:function(){var e=this.maxUsedDisplay;e.setValue(this.getMaxAndUsedPortPrefix()+_T("common","loading")),e.show()},hideMaxAndUsedPorts:function(){this.maxUsedDisplay.hide()},isExceedMaxUsedPorts:function(e){var t=function(){var e=this.routerConfInfoObj.getRouterConf();return!!this.isNatpmpRouter()||!!(this.isUpnpRouter()&&e&&e.limit_upnp_portmap_number)}.bind(this);return!(!e&&!t())&&this.getOtherDeviceUsedPortsNumber()+this.getStore().countUsedPortsNumber()>this.getMaxPortsNumber()},isUpnpRouter:function(){var e=this.routerConfInfoObj.getRouterConf();return!!(e&&e.support_natpmp&&e.support_upnp&&"no"==e.support_natpmp&&"yes"==e.support_upnp)},isSynologyRouter:function(){var e=this.routerConfInfoObj.getRouterConf();return!(!e||"Synology Inc."!=e.router_brand)},isNatpmpRouter:function(){var e=this.routerConfInfoObj.getRouterConf();return!!(e&&e.support_natpmp&&e.support_upnp&&"yes"==e.support_natpmp&&"no"==e.support_upnp)},isUpnpOrNatpmpRouter:function(){var e=this.routerConfInfoObj.getRouterConf();return!(!(e&&e.support_natpmp&&e.support_upnp)||"yes"!=e.support_natpmp&&"yes"!=e.support_upnp)},isSupportChangePort:function(){var e=this.routerConfInfoObj.getRouterConf();return!!e&&e.support_change_port},resetMainPage:function(){this.getSelectionModel().clearSelections(),this.el.unmask(),this.getView().el.unmask(),this.statusUpdaterStop(),this.stopPollTestRuleStatus(),this.stopPollSaveRuleStatus(),Ext.QuickTips.unregister(this.maxUsedDisplay.getEl())},onRowCtxMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.showCtxMenu(e,i)},getCtxMenu:function(){var e=this.getButton("del").initialConfig,t=this.getButton("test").initialConfig;return this.gridCtxMenu=new SYNO.ux.Menu({autoDestroy:!0,items:[{text:e.text,handler:e.handler,scope:e.scope,disabled:this.getButton("del").disabled},{text:t.text,handler:t.handler,scope:t.scope,disabled:this.getButton("test").disabled}]}),this.gridCtxMenu},showCtxMenu:function(e,t){this.getCtxMenu().showAt(t.getXY())},statusUpdaterStart:function(){this.statusUpdaterStop(),this.status_updater=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Checker({appWin:this.module.appWin,scope:this,callback:this.statusHandler,interval:1}),this.status_updater.Start()},statusUpdaterStop:function(){this.status_updater&&this.status_updater.Stop()},statusHandler:function(){return SYNO.Debug("this.status_updater.process="+this.status_updater.process),"portforwarding"===this.status_updater.process?(this.changeState("waiting"),void(this.status_updater.processTaskId?this.startPollSaveRuleStatus({taskId:this.status_updater.processTaskId}):this.getView().el.mask(_T("routerconf","routerconf_upnp_service_busy"),"syno-ux-mask-info"))):"autotest"===this.status_updater.process||"routerdetect"===this.status_updater.process?(this.status_updater.processTaskId,this.getView().el.mask(_T("routerconf","routerconf_upnp_service_busy"),"syno-ux-mask-info"),void this.changeState("testing")):void("testrule"==this.status_updater.process?this.status_updater.processTaskId?"testrule"!=this.status_updater.previousProcess&&this.getStore().load({callback:function(){"testrule"==this.status_updater.process&&this.startPollTestRuleStatus({taskId:this.status_updater.processTaskId})},scope:this}):(this.getView().el.mask(_T("routerconf","routerconf_upnp_service_busy"),"syno-ux-mask-info"),this.changeState("testing")):("testing"===this.getState()&&this.routerConfInfoObj.sendRouterConfGetWebapi(),this.routerConfInfoObj.hasRouterConfInfo()?this.changeState("normal"):this.changeState("set_router")))},showSaveRuleProgress:function(e){var t="";e.stage&&("add"===e.stage?t=_T("routerconf","routerconf_progress_add"):"del"===e.stage&&(t=_T("routerconf","routerconf_progress_delete"))),this.saveRuleProgressBar=this.module.appWin.getMsgBox(),this.saveRuleProgressBar.progress(t,e.percentage,"","",{confirm:!1,cancel:!1})},hideSaveRuleProgress:function(){this.saveRuleProgressBar&&(this.saveRuleProgressBar.close(),this.saveRuleProgressBar=null)},toSaveRuleErrorStringWithData:function(e,t){var i=SYNO.API.getErrorString(e);return 1521===e||1522===e?String.format(i,t.errors.append.max_port):1523===e?String.format(i,t.errors.append.max_port,t.errors.append.max_range):1524===e?String.format(i,t.errors.append.max_port):1525===e||1526===e?i+" : "+t.errors.append:i},saveRuleErrorHandler:function(e,t){this.statusUpdaterStop(),this.showSaveRuleErrorMessage(t)},confirmToChangeSetting:function(e,t,i,s){var n=e+"<br>"+String.format(_T("routerconf","routerconf_goto_module"),_T("tree",i));this.module.appWin.getMsgBox().confirm(_T("tree","leaf_routerconf"),n,null,{useHtml:!0}).then((i=>{"confirm"===i?this.module.app.startModule(t,s):this.getView().el.mask(e,"syno-ux-mask-info")}))},startTestRules:function(e){var t=e.selectedRules,i=e.success_callback;SYNO.API.Request({api:"SYNO.Core.PortForwarding.Rules",version:1,method:"test",params:{selection:t?t.join(","):""},callback:function(e,t,s){e&&this.startPollTestRuleStatus({taskId:t.task_id,success_callback:i})},scope:this})},isPortsInRecord:function(e,t){var i;if(e&&t)return i=e+", "+t.data.router_port,SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Conflict(i).length>0;SYNO.Debug("[Error] port="+e+" record="+t)},getRecordsInStoreByUserSelectedPorts:function(e){var t,i,s=[],n=this.getStore();if(!e||0>=e.length)return s;for(t=0;t<n.getCount();t++)for(i=0;i<e.length;i++)if(("all"==e[i].data.router_protocol||"all"!=e[i].data.router_protocol&&e[i].data.router_protocol==n.getAt(t).data.router_protocol)&&this.isPortsInRecord(e[i].data.router_port,n.getAt(t))){s.push(n.getAt(t));break}return s},testingStart:function(e){var t,i=e.selectedRecords,s=e.success_callback,n=[],o=this.getStore(),a=this.getRecordsInStoreByUserSelectedPorts(i);if(0>=a.length)for(t=0;t<o.getCount();t++)o.getAt(t).get("enable")&&a.push(o.getAt(t));if(!(0>=a.length)){for(t=0;t<a.length;t++)a[t].set("rule_status","testing"),n.push(a[t].get("rule_id"));this.startTestRules({selectedRules:n,success_callback:s})}},testingStop:function(e){var t,i,s=this.getStore(),n={testing:"no",waiting:"psuccess"};for(this.stopPollTestRuleStatus(!0),t=0;t<s.getCount();t++)(i=s.getAt(t).get("rule_status"))in n&&s.getAt(t).set("rule_status",n[i])},testPortConnErrorHandler:function(e,t){if(this.testingStop(!1),1501!==e){var i=SYNO.API.getErrorString(e);this.module.appWin.getMsgBox().alert(this.title,i)}else this.module.appWin.getMsgBox().alert(this.title,_T("common","error_occupied"))},getRuleStatus:function(e,t){return t>=e.length?(SYNO.Debug("impossible here: getRuleStatus() out of range"),"unkown"):e[t]},loadTestRuleResult:function(e){var t=this.getStore(),i="";e.rules&&t&&t.each((function(t){"fail"===(i=this.getRuleStatus(e.rules,t.get("rule_id")))&&!1===t.get("enable")&&(i="disabled"),t.set("rule_status",i)}),this)},startPollTestRuleStatus:function(e){var t=e.taskId,i=e.success_callback,s={interval:3,immediate:!1,webapi:{api:"SYNO.Core.PortForwarding.Rules",version:1,method:"test_status",params:{task_id:t}},status_callback:function(e,t,s,n){if(e){if("wait"===t.status)return!0;this.loadTestRuleResult(t),"success"==t.status&&(i&&i(),this.testingStop(!0),this.isRuleStatusLoaded=!0)}else SYNO.Debug("polling test port connection, error occur, into error handling"),this.testPortConnErrorHandler(t.code,t)},scope:this};this.statusUpdaterStop(),this.changeState("testing"),this.testPortConnPollId&&(this.module.appWin.pollUnreg(this.testPortConnPollId),this.testPortConnPollId=null),this.testPortConnPollId=this.module.appWin.pollReg(s)},stopPollTestRuleStatus:function(e){this.testPortConnPollId&&(this.module.appWin.pollUnreg(this.testPortConnPollId),this.testPortConnPollId=null),e&&this.status_updater.Start()},getButton:function(e){return this.getTopToolbar().getComponent(e)},enableButton:function(e,t){var i=this.getButton(e);Ext.isObject(i)?t?i.enable():i.disable():SYNO.Debug("enableButton failed: no button object of ",e)},disableAllButton:function(){Ext.each(["router","create","del","test"],(function(e){this.getButton(e).disable()}),this)},maskAll:function(){this.disableAllButton(),this.el.mask()},onSetupRouter:function(){this.statusUpdaterStop();var e=this.networkInfoObj.getNetworkInfo().gateway,t=SYNO.SDS.Utils.Network.idToString(this.networkInfoObj.getNetworkInfo().gateway_info.ifname);new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RouterWizard({module:this.module,owner:this.module.appWin,gateway:e,ifname:t}).onOpen({scope:this,callback:function(){this.isRouterChanged=!0,this.module.panel.loadAllForm(),this.doLayout(),this.updateGridEmptyText("no_rule")}})},onCreateRule:function(){new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.AddRuleWizard({module:this.module,owner:this.module.appWin,appWin:this.module.appWin,rule_store:this.getStore(),serviceDescObj:this.serviceDescObj,isSupportChangePort:this.routerConfInfoObj.getRouterConf().support_change_port,next_step_callback:this.updateUsedPortsAndShow,next_step_callback_scope:this}).open()},onDeleteRule:function(){var e=this.getSelectionModel().getSelections(),t=this.getStore(),i=0;for(i=0;i<e.length;i++)t.remove(e[i]);this.updateUsedPortsAndShow(),this.focus(),0<e.length&&this.getView().focusRow(e.length-1)},hasConflictRule:function(){let e,t,i=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleSet(),s=!1,n=this.getStore(),o=_T("routerconf","routerconf_port_conflict")+_T("common","colon"),a=(e,t,i)=>{let s="";e.dsPort.length>0&&(s=_T("routerconf","routerconf_header_ds_port")+_T("common","colon")+e.dsPort.toString()),e.routerPort.length>0&&(s=_T("routerconf","routerconf_header_router_port")+_T("common","colon")+e.routerPort.toString()),o+=String.format('<br><div style="display:inline-flex; line-height:20px; margin-top:8px;"><div>&#8226;</div><div style="padding-left:8px;">{0}</div></div><br>',s),o+=String.format(_T("routerconf","routerconf_header_service")+_T("common","colon")+"{0} ({1})<br>",t.getServiceName(),t.getProtocol()),o+=String.format(_T("routerconf","routerconf_header_service")+_T("common","colon")+"{0} ({1})",i.getServiceName(),i.getProtocol())};for(let o=0;o<n.getCount();o++)e=n.getAt(o),e.get("enable")&&!e.get("readonly")&&(t=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.Rule({blEnable:e.get("enable"),szServiceName:e.get("serviceid").desc,szDsPorts:e.get("ds_port").toString(),szRouterPorts:e.get("router_port").toString(),szProtocol:e.get("router_protocol")}),i.addRule(t,a)||(s=!0));return s&&this.module.appWin.getMsgBox().alert(this.title,o),s},hasChangePortRule:function(e){var t=0,i=0;for(t=0;t<e.getCount();t++){var s=e.getAt(t);if(s.get("enable")){var n=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray(s.get("ds_port").toString()),o=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray(s.get("router_port").toString());for(i=0;i<n.length;i++)if(n[i]!==o[i])return!0}}return!1},disableChangePortRules:function(e){var t=0,i=0;for(t=0;t<e.getCount();t++){var s=e.getAt(t);if(s.get("enable")){var n=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray(s.get("ds_port").toString()),o=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ParsePortsToArray(s.get("router_port").toString());for(i=0;i<n.length;i++)if(n[i]!==o[i]){s.set("enable",!1);break}}}},isBusy:function(e){return 1501===e},isToPopUpPortStatus:function(e){return e.port_status.length>0},isToPopUpOpenUPnPWriteAbilityMsgBox:function(e){var t=0;if(!e)return!1;if(!e.port_status)return!1;if(0===e.port_status.length)return!1;for(var i=0;i<e.port_status.length;i++)e.port_status[i].blFailRule&&t++;return t==e.port_status.length},showServiceMsg:function(e){e&&this.module.appWin.getMsgBox().alert(_T("common","note"),_T("service","service_portmapping_services_disable")+": "+e,null,{useHtml:!0}).then((e=>{"confirm"===e&&(this.el.unmask(),this.getView().el.unmask())}))},cancelFunction:function(e){var t=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding;this.changeState("normal"),this.onTestRule(function(){var i=this.getStore(),s=function(e){for(var i={},s=0;s<e.length;s++)i[e[s][t.WEBAPI_REMAP_ROUTER_PORT]]=e[s][t.WEBAPI_ROUTER_PORT];return i};!function(i){if(!i)return SYNO.Debug("confirmCB store is null"),void this.changeState("normal");if(!e.port_status)return SYNO.Debug("confirmCB port_status is null"),void this.changeState("normal");for(var n=0;n<e.port_status.length;n++){var o=e.port_status[n][t.WEBAPI_INDEX],a=s(e.port_status[n][t.WEBAPI_PORT_INFO]),r=i.getAt(o);r&&(r.set("remap_router_port_map_table",a),r.commit())}}(i)}.bind(this))},popUpPortConflictWindow:function(e){var t=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding;this.portStatusObj=t.Util.PortStatus(e.port_status),new t.PortConflictDialog({owner:this.findWindow(),text:_T("routerconf","undo_msg_content"),forciable:this.isUpnpRouter()&&!this.isSynologyRouter(),portStatusObj:this.portStatusObj,serviceDescObj:this.serviceDescObj,confirmCB:function(t){var i=t.blForce||!1,s=t.store||null,n=this.getStore()||null,o=function(e,t){for(var i=0;i<e.getCount();i++)if(t===e.getAt(i).get("rule_index"))return e.getAt(i);return null}.bind(this),a=function(e){if(e.blForce)return!0;for(var t=0;t<s.getCount();t++)if(!s.getAt(t).get("enable"))return!0;return!1}.bind(this),r=function(e,t,i){t&&i&&(i.get("enable")?e&&i.get("enable")?(t.set("router_port",i.get("router_port_tmp")),t.set("force",!0)):(t.set("router_port",i.get("remap_router_port_tmp")),t.set("force",!1)):t.set("enable",!1))}.bind(this);if(a(t)){for(var l=n.getCount()-1;l>=0;l--){var d=o(s,l);r(i,n.getAt(l),d)}this.flag_show_warning_dialog=!0,this.module.panel.applyAllForm(this.module.panel.applyAllFormOptions)}else this.cancelFunction(e)}.bind(this)}).show()},saveSuccess:function(e){var t=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding;if(!(this.module.panel.applyAllFormOptions&&!1===this.module.panel.applyAllFormOptions.blDoSaveSuccessCallback||(this.store.loadRules(),Ext.isDefined(this.confirmLostChangeResolve)))){if(this.isUpnpRouter()&&this.isToPopUpOpenUPnPWriteAbilityMsgBox(e))return this.stopPollSaveRuleStatus(!0),this.changeState("normal"),void this.module.appWin.getMsgBox().alert(this.title,_T("routerconf","routerconf_may_not_enable_upnp_write"));t.Util.GetDisabledSystemServiceMsg(this.module.appWin,this.getStore(),this.showServiceMsg.bind(this)),this.isToPopUpPortStatus(e)?this.popUpPortConflictWindow(e):(this.changeState("normal"),this.onTestRule())}},startPollSaveRuleStatus:function(e){var t=e.taskId,i=e.success_callback;this.saveStatusConf={interval:1,immediate:!0,webapi:{api:"SYNO.Core.PortForwarding.Rules",version:1,method:"save_status",params:{task_id:t}},status_callback:function(e,t,s,n){var o=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.STATUS_SUCCESS,a=SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.STATUS_PROGRESS;e?a===t.status?(this.changeState("waiting"),this.showSaveRuleProgress(t)):o===t.status?(this.isRouterChanged=!1,this.changeState("normal"),i&&i(t),this.stopPollSaveRuleStatus(!0)):(SYNO.Debug("impossible here. data.status = "+t.status),this.changeState("normal"),this.stopPollSaveRuleStatus(!0)):(this.stopPollSaveRuleStatus(!0),this.showSaveRuleErrorMessage(t))},scope:this},this.statusUpdaterStop(),this.saveStatusConfPollId&&(this.module.appWin.pollUnreg(this.saveStatusConfPollId),this.saveStatusConfPollId=null),this.saveStatusConfPollId=this.module.appWin.pollReg(this.saveStatusConf)},showSaveRuleErrorMessage:function(e){var t=this.toSaveRuleErrorStringWithData(e.code,e);if(1528===e.code){var i=[];i.push(t),i.push(_T("routerconf","change_router_warn")),t=_T("routerconf","protocol_on_router_not_enabled_suggest")+this.getListHtml(i),new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ForceSaveRulesDialog({owner:this.module.appWin,title:this.title,store:this.getStore(),errStr:t}).show()}else t=_T("routerconf","routerconf_apply_failed")+"<br>"+t,this.module.appWin.getMsgBox().alert(this.title,t,(function(){this.msg="",this.changeState("normal")}),this)},stopPollSaveRuleStatus:function(e){this.saveStatusConfPollId&&(this.module.appWin.pollUnreg(this.saveStatusConfPollId),this.saveStatusConfPollId=null),this.hideSaveRuleProgress(),e&&this.status_updater.Start(),this.module.panel.deregisterProcessReturnData("portforwardingtab")},onTest:function(){0!==this.getStore().getCount()&&(0!==this.getSelectionModel().getSelections().length||0!==this.store.getEnabledRules().length?this.onTestRule():this.module.panel.setStatusError({text:_T("routerconf","routerconf_no_enabled_rule_for_test"),clear:!0}))},onTestRule:function(e){var t=this.getSelectionModel().getSelections();this.getStore().load({callback:function(){this.testingStart({selectedRecords:t,success_callback:e})},scope:this})}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ForceSaveRulesDialog",{extend:"SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.ConfirmDialog",constructor:function(e){var t=Ext.apply({fbar:[{xtype:"syno_button",text:_T("common","ok"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.onClickApply}],items:[{xtype:"syno_displayfield",cls:"dialog-title",value:_T("routerconf","routerconf_apply_failed")},{xtype:"syno_displayfield",htmlEncode:!1,value:e.errStr,style:{"margin-bottom":"6px"}},{xtype:"syno_checkbox",boxLabel:_T("routerconf","force_save_rules"),itemId:"force_save_rules"}]},e);this.callParent([t])},onClickApply:function(){this.getComponent("force_save_rules").getValue()?(this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.PortForwarding.Rules",version:1,method:"force_save",params:{rules:this.store.getRules()},callback:function(e,t,i){this.clearStatusBusy(),e?(this.store.loadRules(),this.close()):this.getMsgBox().alert(this.title,SYNO.API.getErrorString(t.code))},scope:this})):this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.PublicAccess"),SYNO.SDS.AdminCenter.PublicAccess.DEFAULT_PASSWORD="12345678",SYNO.SDS.AdminCenter.PublicAccess.CN_PROVIDER_ORDER=["DNSPod.cn","Oray.com","TencentCloud"],SYNO.SDS.AdminCenter.PublicAccess.CERTIFICATE_PROVIDER={le:"Let's Encrypt",tencent:"Tencent Cloud"};const providerNameComp=(e,t)=>e.display<t.display?-1:e.display>t.display?1:0;Ext.define("SYNO.SDS.AdminCenter.PublicAccess.DDNSTab",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.app=e.module.app,this.observer=e.observer;var t=this.fillConfig(e);this.callParent([t]),this.getInitInfoArray=[{api:"SYNO.Core.DDNS.Provider",version:1,method:"list"},{api:"SYNO.Core.DDNS.Record",version:1,method:"list"},{api:"SYNO.Core.DDNS.ExtIP",version:2,method:"list"},{api:"SYNO.Core.Certificate.CRT",version:1,method:"list"},{api:"SYNO.Core.DDNS.Ethernet",version:1,method:"list"},{api:"SYNO.Core.Network.PPPoE",version:1,method:"list"}],this.getInfoArray=[{api:"SYNO.Core.DDNS.Provider",version:1,method:"list"},{api:"SYNO.Core.DDNS.Record",version:1,method:"list"},{api:"SYNO.Core.DDNS.ExtIP",version:2,method:"list",retry:!0},{api:"SYNO.Core.DDNS.Synology",version:1,method:"get_myds_account"},{api:"SYNO.Core.Certificate.CRT",version:1,method:"list"},{api:"SYNO.Core.DDNS.Ethernet",version:1,method:"list"},{api:"SYNO.Core.Network.PPPoE",version:1,method:"list"}],this.getRecordInfo=[{api:"SYNO.Core.DDNS.Record",version:1,method:"list"}],this.btnDel=this.getTopToolbar().getComponent("del"),this.btnUpdate=this.getTopToolbar().getComponent("update"),_S("demo_mode")&&(this.btnDel.setTooltip(_JSLIBSTR("uicommon","error_demo")),this.btnUpdate.setTooltip(_JSLIBSTR("uicommon","error_demo"))),this.getInfoConf={interval:5,immediate:!0,webapi:{api:"SYNO.Entry.Request",version:1,method:"request",params:{mode:"parallel",stopwhenerror:!1,compound:this.getInfoArray}},status_callback:this.getInfoDone,scope:this}},fillConfig:function(e){this.store=new SYNO.SDS.AdminCenter.PublicAccess.DDNSInfoStore(e),this.createActions();var t=[this.getAction("add"),this.getAction("edit"),this.getAction("del"),this.getAction("update"),this.getAction("advanced")],i=new Ext.Toolbar({defaultType:"syno_button",items:t}),s=new Ext.grid.ColumnModel({defaults:{sortable:!1},columns:[{header:_T("service","service_ddns_type"),dataIndex:"display",width:130},{header:_T("service","service_ddns_hostname"),dataIndex:"hostname",width:180},{header:_T("service","service_wanconfig_gateway_addr_out"),dataIndex:"ip",width:270},{header:_T("service","service_wanconfig_status"),dataIndex:"status",useHtmlEncodeRender:!1,width:120},{header:_T("service","service_ddns_last_updated"),dataIndex:"lastupdated",useHtmlEncodeRender:!1,width:150}]}),n={title:_T("tree","leaf_wanconfig"),heigh:400,colModel:s,store:this.store,cls:"syno-publicaccess-ddns-gridpanel",viewConfig:{emptyText:['<div class="syno-dataview">','<div class="empty-text-wrap">','<div class="empty-text-inner-wrap">','<div class="empty-text-icon"></div>','<div class="empty-text">',_T("common","no_item"),"</div>","</div>","</div>","</div>"].join("")},tbar:i,bbar:this.createBBar(),listeners:{scope:this,activate:this.onActivate,deactivate:this.deactivate,click:this.checkState,rowdblclick:this.editHandler,rowcontextmenu:this.onRowCtxMenu,containercontextmenu:this.showCtxMenu},selModel:new Ext.grid.RowSelectionModel({singleSelect:!1})};return Ext.apply(n,e),n},createBBar:function(){return new SYNO.ux.PageLessToolbar({store:this.store,displayInfo:!0,doRefresh:function(e){this.module.appWin.setStatusBusy(),this.getRecord()}.bind(this)})},getHelpParam:function(){return"AdminCenter/connection_ddns.html"},createActions:function(){var e=function(e,t,i,s,n){return new Ext.Action(Ext.apply({text:e,itemId:t,scope:s,handler:i},n))};return this.actions={add:e(_T("common","add"),"add",this.addHandler,this),edit:e(_T("common","alt_edit"),"edit",this.editHandler,this),del:e(_T("common","delete"),"del",this.deleteHandler,this),update:e(_T("time","ntp_updatenow"),"update",this.refreshHandler,this),advanced:e(_T("service","service_ddns_customize"),"advanced",this.advancedHandler,this)},this.actions},getAction:function(e){return e in this.actions?this.actions[e]:void SYNO.Debug("no this action: "+e)},enableAction:function(e,t){var i=this.getAction(e);i&&i[t?"enable":"disable"]()},checkState:function(){var e=this.store.getCount(),t=this.getSelectionModel().getCount();this.enableAction("edit",1==t),this.enableAction("del",0<t),this.enableAction("update",0<e),_S("demo_mode")&&(this.enableAction("edit",!1),this.enableAction("del",!1),this.enableAction("update",!1))},initCtxMenu:function(){this.gridCtxMenu=new SYNO.ux.Menu({autoDestroy:!0,items:[this.getAction("edit"),this.getAction("del")]})},getCtxMenu:function(){return this.gridCtxMenu||this.initCtxMenu(),this.checkState(),this.gridCtxMenu},showCtxMenu:function(e,t){this.getCtxMenu().showAt(t.getXY())},onRowCtxMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.showCtxMenu(e,i)},addHandler:function(){if(void 0!==this.records&&void 0!==this.records.length)if(this.records.length!==this.providers.length){var e=new SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordDialog({owner:this.module.appWin,module:this,providers:this.providers,records:this.records,myDSAccountLogin:this.myDSAccountLogin,myDSAccount:this.myDSAccount,certificates:this.certificates,defaultCert:this.defaultCert,certServices:this.certServices,selected:null,action:"add",ipAddrs:this.ipAddrs,interfaces:this.interfaces});this.mon(e,"close",(function(){this.pollingTaskStart()}),this),this.pollingTaskStop(),e.open({scope:this})}else this.module.appWin.getMsgBox().alert(_T("tree","leaf_wanconfig"),_T("service","service_ddns_max_info_num"))},editHandler:function(){const e=this.getAction("edit")||{};if(this.getSelectionModel().getSelected()){if(Ext.isFunction(e.isDisabled)&&e.isDisabled())return;var t=new SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordDialog({owner:this.module.appWin,module:this,providers:this.providers,records:this.records,myDSAccountLogin:this.myDSAccountLogin,myDSAccount:this.myDSAccount,certificates:this.certificates,defaultCert:this.defaultCert,certServices:this.certServices,selected:this.getSelectionModel().getSelected().data.provider,action:"edit",ipAddrs:this.ipAddrs,interfaces:this.interfaces});this.mon(t,"close",(function(){this.pollingTaskStart()}),this),this.pollingTaskStop(),t.open({scope:this})}},sendDelCmd:function(e){this.module.appWin.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.DDNS.Record",method:"delete",version:1,scope:this,params:{id:e},callback:function(e,t,i){this.module.appWin.clearStatus(),e?this.pollingTaskStart():this.module.appWin.getMsgBox().alert(_T("tree","leaf_wanconfig"),_T("service","service_ddns_operation_fail"))}})},deleteHandler:function(){if(this.getSelectionModel().getSelected()){for(var e=[],t="",i=0;i<this.getSelectionModel().getSelections().length;i++)0!==i&&(t+="<p>"),e.push(this.getSelectionModel().getSelections()[i].data.provider),t+=this.getSelectionModel().getSelections()[i].data.hostname;this.pollingTaskStop(),this.findAppWindow().getMsgBox().confirmDelete(_T("tree","leaf_wanconfig"),_T("service","service_ddns_delete_warning")+"<br><p>"+t+"</p>",null,{useHtml:!0}).then((t=>{"confirm"===t&&this.sendDelCmd(e)}))}},refreshHandler:function(){this.module.appWin.setStatusBusy(),this.pollingTaskStop(),this.sendWebAPI({api:"SYNO.Core.DDNS.Record",method:"update_ip_address",version:1,scope:this,params:null,callback:function(e,t,i){this.pollingTaskStart(),this.module.appWin.clearStatus()}})},advancedHandler:function(){var e=new SYNO.SDS.AdminCenter.PublicAccess.DDNSAdvancedDialog({owner:this.module.appWin,module:this,providers:this.providers});this.mon(e,"close",(function(){this.pollingTaskStart()}),this),this.pollingTaskStop(),e.open({scope:this})},onActivate:function(){this.triggered_onActivate=!0,this.pollingTaskStop(),this.module.appWin.setStatusBusy(),this.myDSAccount="NO_MY_DS_ACCOUNT",this.pollingTaskStart(),this.getInfo()},deactivate:function(){this.triggered_onActivate=!1,this.pollingTaskStop()},getRecord:function(){this.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:!1,params:this.getRecordInfo},callback:this.getInfoDone})},getInfo:function(){var e=this;setTimeout((function(){"NO_MY_DS_ACCOUNT"===e.myDSAccount&&e.sendWebAPI({params:{},scope:e,compound:{stopwhenerror:!1,params:e.getInitInfoArray},callback:e.getInfoDone})}),3e3)},getInfoDone:function(e,t,i){if(this.myDSAccountLogin=!1,this.myDSAccount="NO_MY_DS_ACCOUNT",void 0!==t&&void 0!==t.result&&void 0!==t.result.length){for(var s=0;s<t.result.length;s++)if(t.result[s].success)if(SYNO.ux.Utils.checkApiConsistency(t.result[s],this.getInfoArray[0]))this.providers=t.result[s].data.providers,this.providers=SYNO.SDS.AdminCenter.PublicAccess.DDNSApplyCustomProviders(this.providers,_S("lang"),providerNameComp);else if(SYNO.ux.Utils.checkApiConsistency(t.result[s],this.getInfoArray[1])){var n=t.result[s].data.next_update_time,o=Date.parseDate(n,"Y-n-j G:i");void 0!==o&&(n=SYNO.SDS.DateTimeFormatter(o)),this.records=t.result[s].data.records}else if(SYNO.ux.Utils.checkApiConsistency(t.result[s],this.getInfoArray[2])){for(var a=0;a<t.result[s].data.length;a++)if("WAN"==t.result[s].data[a].type){_S("version")<5004?this.ipAddrs=[{id:"LAN",display:"WAN: "+t.result[s].data[a].ip}]:this.ipAddrs=t.result[s].data[a];break}}else SYNO.ux.Utils.checkApiConsistency(t.result[s],this.getInfoArray[3])?this.myDSAccount!==t.result[s].data.email?(this.myDSAccountLogin=!0,this.myDSAccount=t.result[s].data.email):(this.myDSAccountLogin=!1,this.myDSAccount=_T("myds","login_or_register_myds_account")):SYNO.ux.Utils.checkApiConsistency(t.result[s],this.getInfoArray[4])&&(this.certificates=t.result[s].data.certificates,this.certServices=[],this.certificates.forEach((function(e){e.is_default&&(this.defaultCert=e);var t=!1;e.services.forEach((function(e){"quickconnect"===e.service&&(t=!0)})),e.services.length&&!t&&(this.certServices=this.certServices.concat(e.services.map((function(t){return{service:t,old_id:e.id}}))))}),this));this.interfaces=[];var r=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.DDNS.Ethernet","list"),l=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Network.PPPoE","list");Array.isArray(r)&&Array.prototype.push.apply(this.interfaces,r),Array.isArray(l)&&Array.prototype.push.apply(this.interfaces,l),"NO_MY_DS_ACCOUNT"===this.myDSAccount&&(this.myDSAccount='<font color="red">'+_T("myds","error_query_info")+"</font>"),this.updateStoreData(),this.checkState(),this.triggered_onActivate&&this.module.appWin.clearStatus()}else this.module.appWin.clearStatus()},updateStoreData:function(){for(var e=this.getSelectionModel(),t=[],i=[],s="-",n=0;n<this.records.length;n++){e.isSelected(n)&&t.push(n),"Synology"!==this.records[n].provider&&(this.records[n].ipv6="0:0:0:0:0:0:0:0"),s="-"===SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.records[n].ip)?SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.records[n].ipv6):"-"===SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.records[n].ipv6)?SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.records[n].ip):SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.records[n].ip)+"/"+SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.records[n].ipv6);var o=this.records[n].enable?this.records[n].status:"disabled",a=this.records[n].enable?this.records[n].lastupdated:"disabled";i.push({provider:this.records[n].provider,display:SYNO.SDS.AdminCenter.PublicAccess.DDNSGetDisplayName(this.providers,this.records[n].provider),hostname:this.records[n].hostname,ip:s,status:SYNO.SDS.AdminCenter.PublicAccess.DDNSTransferStatus(this,o,this.records[n].provider),lastupdated:SYNO.SDS.AdminCenter.PublicAccess.DDNSTransferStatus(this,a,this.records[n].provider)}),"Synology"===this.records[n].provider&&(this.mailInfo={owner:this.module.appWin,email:this.records[n].username})}this.getView().el.unmask(),this.store.loadData(i,!1),e.selectRows(t,!0)},pollingTaskStart:function(){void 0===this.pollingTaskID&&(this.pollingTaskID=this.module.appWin.pollReg(this.getInfoConf))},pollingTaskStop:function(){void 0!==this.pollingTaskID&&(this.module.appWin.pollUnreg(this.pollingTaskID),this.pollingTaskID=void 0)}}),SYNO.SDS.AdminCenter.PublicAccess.DDNSApplyCustomProviders=function(e,t,i){var s=0,n=0,o=null,a=-1,r=-1,l=[{id:"TwoDNS.de",display:"Two-DNS.de"},{id:"NoIP.com",display:"No-IP.com"},{id:"DYNDNS.org",display:"DYNDNS"},{id:"Freedns.org",display:"FreeDNS"},{id:"Oray.com",display:_T("service","service_ddns_provider_oray")},{id:"TencentCloud",display:_T("service","service_ddns_provider_tencent_cloud")}];for(s=0;s<e.length;s++)if(e[s]=Ext.apply(e[s],{display:e[s].provider}),0===e[s].provider.search("USER_"))e[s].display=e[s].provider.replace("USER_","*");else for(n=0;n<l.length;n++)e[s].id===l[n].id&&(e[s].display=l[n].display);for(null!==i&&(e=e.sort(i)),s=0;s<e.length;s++)"RU-CENTER"===e[s].provider?a=s:"Synology"===e[s].provider&&(r=s);return"rus"===t&&a>=0&&(o=e.splice(a,1),e.splice(0,0,o[0])),r>=0&&(o=e.splice(r,1),e.splice(0,0,o[0])),e},SYNO.SDS.AdminCenter.PublicAccess.formatIP=function(e){return"0.0.0.0"===e||"0:0:0:0:0:0:0:0"===e||null===e||""===e?"-":e},SYNO.SDS.AdminCenter.PublicAccess.DDNSGetDisplayName=function(e,t){for(var i=0;i<e.length;i++)if(e[i].id===t)return e[i].display?e[i].display:t;return t},SYNO.SDS.AdminCenter.PublicAccess.DDNSTransferStatus=function(e,t,i){var s,n,o,a="";return"invalid login"==t?(s=_T("error","error_auth"),a="red-status"):"loading"==t||"disabled"==t?s=n=_T("common",t):"service_ddns_normal"==t||"service_status_inprocess"==t?(s=n=_T("service",t),a="green-status"):"service_ddns_error_unknown"==t?(s=_T("service","service_ddns_failed"),n=_T("service","service_ddns_status_connect_host"),a="red-status"):"check_network"==t?(s=_T("service","service_ddns_failed"),n=_T("relayservice","relayservice_err_resolv"),a="red-status"):"service_ddns_status_cant_reg_hostname"==t?(s=_T("service","service_ddns_failed"),n=String.format(_T("service","service_ddns_status_cant_reg_hostname"),i),a="red-status"):"service_ddns_status_synology_email_not_verified"==t?(s=_T("service","service_ddns_failed"),n=_T("service","service_ddns_status_synology_email_not_verified"),a="red-status"):"ip_not_ready"==t?(s=_T("service","service_ddns_not_ready"),n=_T("service","service_ddns_status_ip_not_ready"),a="green-status"):(s=_T("service",t),void 0!==(o=Date.parseDate(t,"Y-n-j G:i"))?s=n=SYNO.SDS.DateTimeFormatter(o):(s=_T("service","service_ddns_failed"),n=_T("service",t)?_T("service",t):t,a="red-status")),'<font class="'+a+'" ext:qtip="'+n+'">'+s+"</font>"},Ext.define("SYNO.SDS.AdminCenter.PublicAccess.DDNSInfoStore",{extend:"Ext.data.JsonStore",constructor:function(e){var t=Ext.apply({autoDestroy:!0,fields:["provider","display","hostname","ip","status","lastupdated"],data:[]},e);this.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.RegisterOrLoginDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.provider=e.provifer,this.isRegister=e.isRegister,this.linkMsg=e.linkMsg,this.webLink=e.webLink;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={title:e.title,width:505,height:e.isRegister?300:260,layout:"fit",items:[this.getFormPanel(e)],buttons:[{text:_T("common","cancel"),scope:this,handler:this.close},this.registerBtn=new SYNO.ux.Button({text:e.isRegister?_T("common","ok"):_T("common","login"),btnStyle:"blue",scope:this,handler:this.onApplyClick})]};return Ext.apply(t,e),t},getFormPanel:function(e){var t={items:[{xtype:"syno_displayfield",value:e.desc},{xtype:"syno_textfield",fieldLabel:_T("user","user_email"),allowBlank:!1,minLength:3,maxLength:256,vtype:"email",vtypeText:_JSLIBSTR("vtype","bad_email"),name:"account"},{xtype:"syno_textfield",fieldLabel:_T("common","password"),textType:"password",minLength:6,maxLength:128,allowBlank:!1,name:"password"},{xtype:"syno_textfield",fieldLabel:_T("login","forget_pass_comfirm_password"),textType:"password_confirm",name:"password_confirm",allowBlank:!1,hidden:!e.isRegister,disabled:!e.isRegister,confirmFor:"password"},{border:!1,layout:{type:"hbox",pack:"end"},items:[{xtype:"syno_button",cls:"myds-link-btn",text:this.linkMsg,scope:this,handler:this.onLinkClick}]}]};return this.formPanel=new SYNO.ux.FormPanel(t),this.formPanel},onLinkClick:function(){this.isRegister?(new SYNO.SDS.AdminCenter.PublicAccess.RegisterOrLoginDialog({owner:this.owner,provider:this.provider,title:_T("common","login"),desc:String.format(_T("service","service_ddns_desc_enter_account"),this.provider),isRegister:!1,linkMsg:_T("service","service_ddns_forget_password"),webLink:this.webLink}).show(),this.close()):window.open(this.webLink,"_blank")},onApplyClick:function(){var e=this.formPanel.getForm();e.isValid()?(this.owner.setUsernameAndPasswd(this.owner,e.findField("account").getValue(),e.findField("password").getValue(),this.provider),this.close()):this.setStatusError({text:_T("common","forminvalid"),clear:!0})}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){if(this.owner=e.owner,this.module=e.module,this.providers=e.providers,this.records=e.records,this.myDSAccountLogin=e.myDSAccountLogin,this.myDSAccount=e.myDSAccount,this.selected=e.selected,this.action=e.action,this.ipAddrs=e.ipAddrs,this.interfaces=e.interfaces,this.selected_unreg_records=[],this.title=_T("service","service_ddns_add_record"),this.certificates=e.certificates,this.defaultCert=e.defaultCert,this.certServices=e.certServices,this.panel=new SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordForm(e),this.testConBtn=e.testConBtn,this.customBtn=e.customBtn,this.serviceField=this.panel.getForm().findField("enable"),this.serviceFieldWithoutCheckbox=this.panel.getForm().findField("ddns_description"),this.providerField=this.panel.getForm().findField("ddns_provider_list"),this.providerField.getStore().loadData(this.providers,!1),this.selectedProviderField=this.panel.getForm().findField("ddns_selected_provider"),this.hostnameField=this.panel.getForm().findField("hostname"),this.synoHostnameField=this.panel.getForm().findField("syno_hostname"),this.domainList=this.panel.getForm().findField("ddns_domain_list"),this.TWNIC_hostnameField=this.panel.getForm().findField("twnic_hostname"),this.TWNIC_domainList=this.panel.getForm().findField("ddns_twnic_domain_list"),this.usernameField=this.panel.getForm().findField("username"),this.mydsAccountField=this.panel.getForm().findField("mydsAccount"),this.showAccountField=this.panel.getForm().findField("showAccount"),this.passwdField=this.panel.getForm().findField("passwd"),this.netV4Row=this.panel.getForm().findField("ddns_net_IPv4_row"),this.netV6Row=this.panel.getForm().findField("ddns_net_IPv6_row"),this.netField=this.panel.getForm().findField("net"),this.netV4Field=this.panel.getForm().findField("net_ipv4"),this.netV6Field=this.panel.getForm().findField("net_ipv6"),this.interfaceV4Field=this.panel.getForm().findField("interface_v4"),this.interfaceV6Field=this.panel.getForm().findField("interface_v6"),this.certificateField=this.panel.getForm().findField("certificate"),this.certificateNoteField=this.panel.getForm().findField("certificate_note"),this.heartbeatField=this.panel.getForm().findField("heartbeat"),this.providerWebsite=this.panel.getForm().findField("provider_website"),this.statusField=Ext.getCmp("status"),this.note=this.panel.getForm().findField("note_info"),this.synoDomainList=this.getSynoDomainList(),this.oldServiceEnable=null,this.lastSelected=-1,"Synology"===this.providerField.getValue()&&this.myDSAccount){var t=this.myDSAccount.indexOf(">")+1,i=this.myDSAccount.indexOf("<",t);this.myDSAccount=this.myDSAccount.slice(t,i)}"edit"===this.action&&(this.title=_T("service","service_ddns_edit_record")),this.panel.mon(this.providerField,"select",(function(e){if(this.oldServiceEnable=this.serviceField.getValue(),this.lastSelected>=0&&(this.records[this.lastSelected].service=this.oldServiceEnable,this.records[this.lastSelected].hostname=this.hostnameField.getValue(),this.records[this.lastSelected].username=this.usernameField.getValue(),this.records[this.lastSelected].passwd=this.passwdField.getValue(),this.records[this.lastSelected].net=this.getNetFieldValue(),this.records[this.lastSelected].netV4=this.getIpFieldValue(this.netV4Field),this.records[this.lastSelected].netV6=this.getIpFieldValue(this.netV6Field),this.records[this.lastSelected].interfaceV4=this.interfaceV4Field.getValue(),this.records[this.lastSelected].interfaceV6=this.interfaceV6Field.getValue(),this.records[this.lastSelected].heartbeat=this.heartbeatField.getValue()),"add"===this.action&&this.selectedProviderRegistered(this.providerField.getValue()))return this.getMsgBox().alert(_T("tree","leaf_wanconfig"),_T("service","service_ddns_one_hostname_for_a_provider")),void this.setFieldAndOriginalValues(this.providerField,"");this.loadSelectedInfo(this.providerField.getValue()),this.netV4Field.isValid(),this.netV6Row.hidden||this.netV6Field.isValid(),this.monitorCertOnHostChange(e.getValue())}),this),this.panel.mon(this.domainList,"select",this.checkCertificateFieldDisable.bind(this),this),this.synoHostnameField.on("keyup",this.checkCertificateFieldDisable.bind(this)),this.synoHostnameField.on("blur",this.checkCertificateFieldDisable.bind(this)),this.panel.mon(this.serviceField,"check",(function(){this.serviceCheckHandler(),this.changeApplyBtnStatus()}),this),this.panel.mon(this.hostnameField,"invalid",(function(){"Oray.com"!=this.providerField.getValue()||""===this.hostnameField.getValue()||/[\x20]/.test(this.hostnameField.getValue())||this.hostnameField.clearInvalid()}),this),this.initTestConBtn(),this.initCustomBtn();var s=Ext.apply({title:this.title,width:760,height:520,layout:"fit",resizable:!1,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:function(){this.close()}},{btnStyle:"blue",itemId:"recordApply",text:_T("common","apply"),disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",scope:this,handler:this.apply}]},e);this.myDSAccountLogin||this.sendWebAPI({api:"SYNO.Core.DDNS.Synology",method:"get_myds_account",version:1,scope:this,callback:function(e,t,i){e?"NO_MY_DS_ACCOUNT"!==t.email&&(this.myDSAccountLogin=!0,this.myDSAccount=t.email,this.setFieldAndOriginalValues(this.mydsAccountField,this.getAccountFieldLink(this.myDSAccount))):this.getMsgBox().alert(_T("tree","leaf_wanconfig"),_T("service","service_ddns_operation_fail"))}}),SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordDialog.superclass.constructor.call(this,s),this.mon(this,"beforeclose",this.onBeforeClose,this)},showCertificateInfo:function(e){this.certificateField.boxlabelEl.update(String.format(_T("service","service_ddns_syno_create_cert"),e)),this.setFieldAndOriginalValues(this.certificateNoteField,String.format(_T("service","service_ddns_syno_create_cert_note"),e)),this.certificateField.show(),this.certificateNoteField.show()},hideCertificateInfo:function(){this.certificateField.setValue(!1),this.certificateField.hide(),this.certificateNoteField.hide()},onClose:function(){this.SAWebLogin&&this.SAWebLogin.cancel()},onBeforeClose:function(){return this.panel.getForm().isDirty=this.isDirty,this.panel.getForm().isDirty(!0)?(this.getMsgBox().confirm("",_T("common","confirm_lostchange_without_save"),(function(e){if("leftCustom"===e){for(var t=0;t<this.selected_unreg_records.length;t++)for(var i=0;i<this.module.records.length;i++)if(this.module.records[i].provider===this.selected_unreg_records[t]){this.module.records.splice(i,1);break}this.mun(this,"beforeclose",this.onBeforeClose,this),this.close()}else"yes"===e&&this.apply()}),this,{yes:_T("common","save"),cancel:!0,leftCustom:{text:_T("common","dont_save"),extraStyle:"syno-ux-button-dontsave"}}),!1):(this.mun(this,"beforeclose",this.onBeforeClose,this),!0)},monitorCertOnHostChange:function(e){"TencentCloud"===e?(this.hostnameField.on("keyup",this.checkCertificateFieldDisable,this),this.hostnameField.on("blur",this.checkCertificateFieldDisable,this)):(this.hostnameField.un("keyup",this.checkCertificateFieldDisable,this),this.hostnameField.un("blur",this.checkCertificateFieldDisable,this))},serviceCheckHandler:function(){var e=!this.serviceField.getValue();this.providerField.setDisabled(e),this.hostnameField.setDisabled(e),this.synoHostnameField.setDisabled(e),this.domainList.setDisabled(e),this.usernameField.setDisabled(e),this.passwdField.setDisabled(e),this.netV4Field.setDisabled(e),this.netV6Field.setDisabled(e),this.checkCertificateFieldDisable(),this.heartbeatField.setDisabled(e),Ext.getCmp(this.panel.testConBtnId).setDisabled(e)},changeApplyBtnStatus:function(){this.isAbleToApply()?this.getFooterToolbar().getComponent("recordApply").enable():this.getFooterToolbar().getComponent("recordApply").disable()},afterRegMyDSAccount:function(e){this.myDSAccount=e.account,this.myDSAccountLogin=!0,this.setFieldAndOriginalValues(this.mydsAccountField,this.getAccountFieldLink(this.myDSAccount)),this.setFieldAndOriginalValues(this.usernameField,this.myDSAccount),this.module.observer.fireEvent("ddns_account_logged_in",this.myDSAccount)},openSAWebLogin:async function(e){this.SAWebLogin||(this.SAWebLogin=await SYNO.SDS.SynologyAccount.WebLogin.create()),this.SAWebLogin&&this.SAWebLogin.loginUrl&&(this.SAWebLogin.popLoginWeb(),this.SAWebLogin.on("resolve",function(t){this.clearStatusBusy(),e.call(this,t)}.bind(this)),this.SAWebLogin.on("reject",function(e){SYNO.Debug("Login Failed",e),this.clearStatusBusy()}.bind(this)),this.SAWebLogin.on("processing",function(){this.setStatusBusy({text:_T("login","waiting")})}.bind(this)))},checkAndDoRegMyDSAccount:function(e){return"Synology"==this.providerField.getValue()&&!this.myDSAccountLogin&&(this.openSAWebLogin(e),!0)},setUsernameAndPasswd:function(e,t,i,s){e.showAccountField.setValue(e.getAccountFieldLink(t,s)),e.usernameField.setValue(t),e.passwdField.setValue(i)},jumpToSynoAccount:function(){this.mun(this,"beforeclose",this.onBeforeClose,this),this.close(),this.module.app.startModule("SYNO.SDS.AdminCenter.SynologyAccount.Main")},afterRender:function(e){this.callParent([e]),this.mydsAccountField.getEl().on("click",(function(){this.checkAndDoRegMyDSAccount(this.afterRegMyDSAccount)||(this.panel.getForm().isDirty=this.isDirty,this.panel.getForm().isDirty()?this.getMsgBox().confirm(_T("tree","leaf_wanconfig"),_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.jumpToSynoAccount()}),this):this.jumpToSynoAccount())}),this),this.showAccountField.getEl().on("click",(function(){var e="",t=this.providerField.getValue();"TWNIC"===t&&(e="http://www.twnic.net.tw/service/");var i=new SYNO.SDS.AdminCenter.PublicAccess.RegisterOrLoginDialog({owner:this,provider:t,title:String.format(_T("service","service_ddns_title_register_account"),t),desc:String.format(_T("service","service_ddns_desc_register_account"),t),isRegister:!0,linkMsg:String.format(_T("service","service_ddns_had_account"),t),webLink:e});if(""===this.usernameField.getValue())i.show();else{var s=String.format(_T("service","service_ddns_desc_other_support"),t,'<a class="link-font" target="_blank" href="'+e+'">'+t+" Support </a>");this.owner.getMsgBox().alert(_T("tree","leaf_wanconfig"),s)}}),this),SYNO.ux.AddTip(this.heartbeatField.getEl(),_T("service","service_ddns_heartbeat_help"));const t=!this.selected||"Synology"===this.selected;this.netV4Field.getStore().loadData(this.getIpStoreData("ip",t),!1),this.netV6Field.getStore().loadData(this.getIpStoreData("ipv6",!0),!1),this.setFieldAndOriginalValues(this.netField,"DEFAULT");var i="";i=SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.ipAddrs.ip),this.setFieldAndOriginalValues(this.netV4Field,i),this.netV4Field.setValue(`${_T("common","auto")} (${this.netV4Field.getValue()})`),"-"==(i=SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.ipAddrs.ipv6))&&this.netV6Row.hide(),this.setFieldAndOriginalValues(this.netV6Field,i),this.netV6Field.setValue(`${_T("common","auto")} (${this.netV6Field.getValue()})`),this.setFieldAndOriginalValues(this.interfaceV4Field,"default"),this.setFieldAndOriginalValues(this.interfaceV6Field,"default"),"edit"==this.action&&(this.serviceField.show(),this.serviceFieldWithoutCheckbox.hide(),this.loadSelectedInfo(this.selected),this.setFieldAndOriginalValues(this.selectedProviderField,this.selected),this.checkCertificateFieldDisable(),this.monitorCertOnHostChange(this.selected)),this.panel.getForm().clearInvalid(),this.hostnameField.clearInvalid()},regAndTest:function(e){this.afterRegMyDSAccount(e),this.testCon()},testCon:function(e,t){if(!this.checkAndDoRegMyDSAccount(this.regAndTest)){var i=this.panel.getForm();if(this.CheckFieldValid(i)){"Synology"===this.providerField.getValue()?this.hostnameField.setValue(this.synoHostnameField.getValue()+"."+this.domainList.getValue()):"TWNIC"===this.providerField.getValue()&&this.hostnameField.setValue(this.TWNIC_hostnameField.getValue()+"."+this.TWNIC_domainList.getValue());var s={enable:!0,provider:this.providerField.getValue(),hostname:this.hostnameField.getValue(),username:this.usernameField.getValue(),net:this.getNetFieldValue(),ip:"-"===this.getIpFieldValue(this.netV4Field)?"0.0.0.0":this.getIpFieldValue(this.netV4Field),ipv6:"-"===this.getIpFieldValue(this.netV6Field)?"0:0:0:0:0:0:0:0":this.getIpFieldValue(this.netV6Field),interface_v4:this.interfaceV4Field.getValue(),interface_v6:this.interfaceV6Field.getValue(),heartbeat:this.heartbeatField.getValue()};"Synology"===this.providerField.getValue()?s.passwd="Synology":this.passwdField.isDirty()&&(s.passwd=this.passwdField.getValue()),this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.DDNS.Record",method:"test",version:1,scope:this,params:s,callback:function(e,t,i){if(this.clearStatusBusy(),e){var s=SYNO.SDS.AdminCenter.PublicAccess.DDNSTransferStatus(this,t.status,t.provider);this.setFieldAndOriginalValues(this.statusField,s),this.doLayout()}else{this.statusField.setValue("--"),this.doLayout();var n=String.format(_T("service","service_ddns_test_connection_fail"),'<a class="link-font" target="_blank" href="https://account.synology.com/support" target="_blank">',"</a>");this.body.mask(),this.getMsgBox().alert(_T("tree","leaf_wanconfig"),n,(function(e){this.body.unmask()}),this)}}})}else this.setStatusError({text:_T("common","forminvalid"),clear:!0})}},initTestConBtn:function(){this.testConBtn.mon(this.testConBtn,"click",this.testCon,this)},customDialogHandler:function(){var e=new SYNO.SDS.AdminCenter.PublicAccess.DDNSAdvancedDialog({owner:this,module:this.module,providers:this.providers});this.mon(e,"close",(function(){this.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.DDNS.Provider",version:1,method:"list"}]},callback:function(e,t,i){e&&(this.providers=t.result[0].data.providers,this.providers=SYNO.SDS.AdminCenter.PublicAccess.DDNSApplyCustomProviders(this.providers,_S("lang"),providerNameComp),this.ddnsProviderList.getStore().loadData(this.providers,!1))}})}),this),e.open({scope:this})},initCustomBtn:function(){this.customBtn.mon(this.customBtn,"click",this.customDialogHandler,this)},CheckFieldValid:function(e){var t=!0,i=e.findField("ddns_provider_list").getValue();"Oray.com"!==i&&"Synology"!==i&&"TWNIC"!==i&&(t=t&&e.findField("hostname").isValid()),"Synology"===i&&(t=t&&e.findField("syno_hostname").isValid()),"TWNIC"===i&&("idv.tw"===this.TWNIC_domainList.getValue()?/[a-zA-Z0-9]/.test(e.findField("twnic_hostname").getValue())||(e.findField("twnic_hostname").markInvalid("a-zA-Z0-9"),t=!1):""===e.findField("twnic_hostname").getValue()&&(t=!1)),""!==i&&e.findField("username").isValid()&&e.findField("passwd").isValid()||(t=!1);var s=e.findField("net_ipv4"),n=e.findField("net_ipv6"),o=e.findField("ddns_net_IPv6_row");return s.isValid()||(t=!1),o.hidden||n.isValid()||(t=!1),t},setFieldAndOriginalValues:function(e,t){e.setValue(t),e.originalValue=e.getValue()},getNetFieldValue:function(e){var t=this.interfaceV4Field.getValue(),i="default"===this.interfaceV6Field.getValue();return"default"===t?i?"DEFAULT":"MANUAL_V6":i?"MANUAL_V4":"MANUAL"},getIpFieldValue:function(e){return e.newValue?e.newValue:e.originalValue},getAccountFieldLink:function(e,t){return'<a class="link-font" style="cursor:pointer">'+String.format(e,t)+"</a>"},setElementTip:function(e,t){Ext.QuickTips.register({target:e,text:t})},checkCertificateFieldDisable:function(){var e=SYNO.SDS.AdminCenter.PublicAccess.CERTIFICATE_PROVIDER,t="Synology"===this.providerField.getValue()?this.synoHostnameField.getValue()+"."+this.domainList.getValue():this.hostnameField.getValue(),i="TencentCloud"===this.providerField.getValue()?e.tencent:"Synology"===this.providerField.getValue()?e.le:"",s=!1;this.certServices.forEach((function(e){e.old_id===this.defaultCert.id||(s=!0)}),this),Ext.QuickTips.unregister(this.certificateField.boxlabelEl),this.serviceField.hidden||this.serviceField.getValue()?s||t.toLowerCase()!==this.defaultCert.subject.common_name.toLowerCase()?this.certificateField.setDisabled(!1):(this.certificateField.setDisabled(!0),this.setElementTip(this.certificateField.boxlabelEl,String.format(_T("service","service_ddns_syno_cert_issued"),t,i))):this.certificateField.setDisabled(!0)},setIpFieldInitValue:function(e,t,i){var s="ipv6"===i,n=s?t.interface_v6:t.interface_v4,o=t.ip||"",a=t.ipv6||"",r=s?a:o,l=e.getStore(),d=s?"interfaceV6":"interfaceV4",c=!1,h=SYNO.SDS.AdminCenter.PublicAccess.formatIP(r),u=h;if(""===n){let e=s?"MANUAL_V4":"MANUAL_V6";("DEFAULT"===t.net||t.net===e)&&(n="default",c=!0)}else c=!0;if(c){let e=l.query(d,n);if(0<e.getCount()){let t=e.first().data;h=t.value,u=t.newValue}}e.setValue(h),e.newValue=u},loadSelectedInfo:function(e){var t=null;this.setFieldStatus(e);for(var i=0;i<this.records.length;i++)if(this.records[i].provider===e){if(this.lastSelected=i,this.setFieldAndOriginalValues(this.netField,this.records[i].net),"edit"===this.action&&(this.setFieldAndOriginalValues(this.interfaceV4Field,this.records[i].interface_v4),this.setIpFieldInitValue(this.netV4Field,this.records[i],"ipv4"),this.setFieldAndOriginalValues(this.interfaceV6Field,this.records[i].interface_v6),this.setIpFieldInitValue(this.netV6Field,this.records[i],"ipv6")),null!==this.oldServiceEnable?this.serviceField.setValue(this.oldServiceEnable):this.setFieldAndOriginalValues(this.serviceField,this.records[i].enable),"add"===this.action?this.providerField.setValue(this.records[i].provider):"edit"===this.action&&this.setFieldAndOriginalValues(this.providerField,this.records[i].provider),this.setFieldAndOriginalValues(this.hostnameField,this.records[i].hostname),this.setFieldAndOriginalValues(this.usernameField,this.records[i].username),void 0!==this.records[i].passwd?this.setFieldAndOriginalValues(this.passwdField,this.records[i].passwd):this.setFieldAndOriginalValues(this.passwdField,SYNO.SDS.AdminCenter.PublicAccess.DEFAULT_PASSWORD),this.setFieldAndOriginalValues(this.heartbeatField,this.records[i].heartbeat),this.records[i].status){var s=this.records[i].enable?this.records[i].status:"disabled",n=SYNO.SDS.AdminCenter.PublicAccess.DDNSTransferStatus(this,s,this.records[i].provider);this.setFieldAndOriginalValues(this.statusField,n),this.doLayout()}t=null,"Synology"===e?(""===this.records[i].hostname?this.domainList.setValue("synology.me"):(t=this.records[i].hostname.split("."),this.setFieldAndOriginalValues(this.synoHostnameField,t[0]),t.shift(),this.setFieldAndOriginalValues(this.domainList,t.join("."))),this.setFieldAndOriginalValues(this.mydsAccountField,this.getAccountFieldLink(this.myDSAccount)),this.setFieldAndOriginalValues(this.usernameField,this.myDSAccount),this.setFieldAndOriginalValues(this.passwdField,"")):"TWNIC"===e&&(""===this.records[i].hostname?this.TWNIC_domainList.setValue("idv.tw"):(t=this.records[i].hostname.split("."),this.setFieldAndOriginalValues(this.TWNIC_hostnameField,t[0]),t.shift(),this.setFieldAndOriginalValues(this.TWNIC_domainList,t.join("."))),this.records[i].username&&this.setFieldAndOriginalValues(this.showAccountField,this.getAccountFieldLink(this.records[i].username,"TWNIC")),"service_ddns_normal"!==this.records[i].status&&"loading"!==this.records[i].status||(this.TWNIC_hostnameField.disable(),this.TWNIC_domainList.disable()));break}this.records.length==i&&("Synology"===e?(this.setFieldAndOriginalValues(this.mydsAccountField,this.getAccountFieldLink(this.myDSAccount)),this.setFieldAndOriginalValues(this.usernameField,this.myDSAccount)):"TWNIC"===e&&this.setFieldAndOriginalValues(this.showAccountField,this.getAccountFieldLink(_T("service","service_ddns_login_or_register_account"),"TWNIC")),this.lastSelected=this.records.length,this.records.push({service:this.oldServiceEnable,provider:e,hostname:"",username:"",passwd:"",net:"DEFAULT",ip:SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.ipAddrs.ip),ipv6:SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.ipAddrs.ipv6),heartbeat:"Synology"===e,status:""}),this.selected_unreg_records.push(e));const o="Synology"===e;this.netV4Field.getStore().loadData(this.getIpStoreData("ip",o),!1);for(var a=0;a<this.providers.length&&this.providers[a].id!==e;a++);if(a!==this.providers.length&&""!==this.providers[a].website){var r='<a class="link-font" target="_blank" href="'+this.providers[a].website+'">'+_T("service","service_ddns_provider_website")+"</a>";this.setFieldAndOriginalValues(this.providerWebsite,r),this.providerWebsite.show()}else this.providerWebsite.hide();this.changeApplyBtnStatus(),"TWNIC"===e?(this.setFieldAndOriginalValues(this.note,'<font class="green-status">'+_T("service","service_ddns_note")+": </font>"+_T("service","service_ddns_twnic_note")),this.note.show()):this.note.hide(),this.panel.getForm().clearInvalid(),this.hostnameField.clearInvalid()},getSynoDomainList:function(){return["synology.me","DiskStation.me","i234.me","myDS.me","DSCloud.biz","DSCloud.me","DSCloud.mobi","DSmyNAS.com","DSmyNAS.net","DSmyNAS.org","FamilyDS.com","FamilyDS.net","FamilyDS.org"]},getDomainList:function(){var e=this.synoDomainList.map((function(e){return{value:e,display:e}}));this.domainList.getStore().loadData(e,!1)},getIpStoreData:function(e,t){const i="ipv6"===e,s=this.ipAddrs&&this.ipAddrs.ip?this.ipAddrs.ip:"-",n=this.ipAddrs&&this.ipAddrs.ipv6?SYNO.SDS.AdminCenter.PublicAccess.formatIP(this.ipAddrs.ipv6):"-",o=i?n:s,a=`${_T("common","auto")} (${SYNO.SDS.AdminCenter.PublicAccess.formatIP(o)})`,r={display:a,value:a,newValue:o,interfaceV4:"default",interfaceV6:"default"},l=this.interfaces.map((e=>{const t=e.ifname||"",s=SYNO.SDS.Utils.Network.idToString(t);let n="-",o="";return i?Array.isArray(e.ipv6)&&0<e.ipv6.length&&(n=e.ipv6[0].split("/")[0]):e.ip&&(n=e.ip),o=`${s} (${n})`,{display:o,value:o,newValue:n,interfaceV4:i?"":t,interfaceV6:i?t:""}})),d={display:_T("common","disable"),value:"-",newValue:"-",interfaceV4:"disabled",interfaceV6:"disabled"},c=[r,...l];return t&&c.push(d),c},setFieldStatus:function(e){var t=SYNO.SDS.AdminCenter.PublicAccess.CERTIFICATE_PROVIDER;this.hostnameField.setValue(""),this.setFieldAndOriginalValues(this.domainList,"synology.me"),this.setFieldAndOriginalValues(this.TWNIC_domainList,"idv.tw"),this.usernameField.setValue(""),this.passwdField.setValue(""),this.statusField.setValue("--"),this.doLayout(),this.panel.getComponent("ddns_hostname").hide(),this.panel.getComponent("ddns_syno_hostname").hide(),this.panel.getComponent("ddns_twnic_hostname").hide(),this.usernameField.hide(),this.mydsAccountField.hide(),this.showAccountField.hide(),this.passwdField.hide(),this.hideCertificateInfo(),this.heartbeatField.hide(),this.heartbeatField.setValue(!1),this.netV6Row.hide(),"Synology"===e?(this.panel.getComponent("ddns_syno_hostname").show(),this.mydsAccountField.show(),this.passwdField.allowBlank=!0,this.showCertificateInfo(t.le),this.heartbeatField.show(),this.heartbeatField.setValue(!0),this.netV6Row.show(),this.getDomainList()):("TencentCloud"===e&&this.showCertificateInfo(t.tencent),this.passwdField.allowBlank=!1,this.panel.getComponent("ddns_hostname").show(),this.usernameField.show(),this.passwdField.show())},getErrorString:function(e,t){if(!e)return _T("common","error_system");var i={badauth:_T("service","service_ddns_status_auth_failed"),account_inused:_T("service","service_ddns_dup_email"),host_inused:_T("service","service_ddns_dup_hostname"),host_inused_by_yourhost:_T("service","service_ddns_msg_host_in_used_by_yourhost"),account_disabled:_T("service","service_ddns_status_email_not_verified"),myds_not_logged_in:_T("service","service_ddns_status_myds_not_logged_in")},s=i[e];return e in i?("host_inused_by_yourhost"==e&&(s=String.format(s,t)),s):s=_T("service","service_ddns_status_param_error")},createTWNICHostname:function(e){this.hostnameField.setValue(this.TWNIC_hostnameField.getValue()+"."+this.TWNIC_domainList.getValue());var t={username:this.usernameField.getValue(),hostname:this.hostnameField.getValue(),dname:this.TWNIC_hostnameField.getValue(),sld:this.TWNIC_domainList.getValue(),ip:"-"===this.getIpFieldValue(this.netV4Field)?"0.0.0.0":this.getIpFieldValue(this.netV4Field),ipv6:"-"===this.getIpFieldValue(this.netV6Field)?"0:0:0:0:0:0:0:0":this.getIpFieldValue(this.netV6Field),forced_update:e};(this.passwdField.isDirty()||"add"==this.action)&&(t.passwd=this.passwdField.getValue()),this.sendWebAPI({api:"SYNO.Core.DDNS.TWNIC",method:"register_hostname",version:1,scope:this,params:t,callback:function(e,t,i){if(e)if("service_ddns_status_auth_failed"===t.status){var s=SYNO.SDS.AdminCenter.PublicAccess.DDNSTransferStatus(this,t.status,"TWNIC");this.statusField.setValue(s),this.doLayout(),this.clearStatusBusy(),new SYNO.SDS.AdminCenter.PublicAccess.RegisterOrLoginDialog({owner:this,provider:"TWNIC",title:_T("service","service_ddns_login_account_failed"),desc:_T("service","service_ddns_desc_login_failed"),isRegister:!1,linkMsg:_T("service","service_ddns_could_not_login"),webLink:"http://www.twnic.net.tw/service/"}).show()}else this.setAndUpdateRec();else{var n=this.getErrorString(t.errors,this.hostnameField.getValue());"host_inused_by_yourhost"===t.errors?this.getMsgBox().confirm(_T("tree","leaf_wanconfig"),n,(function(e){this.clearStatusBusy(),this.setStatusBusy(),"yes"==e?this.createTWNICHostname(!0):this.setAndUpdateRec()}),this):this.getMsgBox().alert(_T("tree","leaf_wanconfig"),n,this.clearStatusBusy,this)}}})},createSynoHostname:function(e){this.hostnameField.setValue(this.synoHostnameField.getValue()+"."+this.domainList.getValue()),this.sendWebAPI({api:"SYNO.Core.DDNS.Synology",method:"register_hostname",version:1,scope:this,params:{hostname:this.hostnameField.getValue(),ip:"-"===this.getIpFieldValue(this.netV4Field)?"0.0.0.0":this.getIpFieldValue(this.netV4Field),ipv6:"-"===this.getIpFieldValue(this.netV6Field)?"0:0:0:0:0:0:0:0":this.getIpFieldValue(this.netV6Field),heartbeat:this.heartbeatField.getValue(),forced_update:e},callback:function(e,t,i){if(e)this.setAndUpdateRec();else{var s=this.getErrorString(t.errors,this.hostnameField.getValue());"host_inused_by_yourhost"===t.errors?this.getMsgBox().confirm(_T("tree","leaf_wanconfig"),s,(function(e){this.clearStatusBusy(),this.setStatusBusy(),"yes"==e?this.createSynoHostname(!0):this.clearStatusBusy()}),this):this.getMsgBox().alert(_T("tree","leaf_wanconfig"),s,this.clearStatusBusy,this)}}})},createLetsEncryptCertificate:function(e,t){return new Promise(function(i,s){if(null===t){var n="*."+e,o={desc:this.getCertDescByProvider("Synology"),domain_name:e+";"+n,as_default:!1};this.el.mask(_T("service","service_ddns_syno_create_cert_waiting"),"syno-ux-mask-info"),this.sendWebAPI({api:"SYNO.Core.Certificate.LetsEncrypt",method:"create",version:1,scope:this,params:o,callback:function(e,t,n){e||s(t),i(t.id)}})}else i(t)}.bind(this))},createTencentCloudCertificate:function(e,t){return new Promise(function(i,s){if(null===t){var n={desc:this.getCertDescByProvider("TencentCloud"),domain_name:e,secret_id:this.usernameField.getValue(),secret_key:this.passwdField.isDirty()?this.passwdField.getValue():"",as_default:!1};this.el.mask(_T("service","service_ddns_syno_create_cert_waiting"),"syno-ux-mask-info"),this.sendWebAPI({api:"SYNO.Core.Certificate.Tencent",method:"create",version:1,scope:this,params:n,callback:function(e,t,n){e||s(t),i(t.id)}})}else i(t)}.bind(this))},getCertDescByProvider:function(e){return{Synology:"Synology DDNS Certificate",TencentCloud:"TencentCloud Certificate"}[e]},createCertificate:function(e){var t=this.getCertDescByProvider(e),i=this,s=this.hostnameField.getValue(),n=[],o="Do not need certificate";return new Promise((function(e,t){var a=null;i.certificates.forEach((function(e){e.subject.common_name.toLowerCase()===s.toLowerCase()&&(a=e.id)}),i),n=i.certServices.filter((function(e){return e.old_id!==a})),!i.certificateField.disabled&&i.certificateField.checked?e(a):t(o)})).then("Synology"===e?this.createLetsEncryptCertificate.bind(this,s):this.createTencentCloudCertificate.bind(this,s)).then((function(e){return new Promise((function(s,n){i.sendWebAPI({api:"SYNO.Core.Certificate.CRT",method:"set",version:1,scope:i,params:{id:e,desc:t,as_default:!0},callback:function(t,i,o){t||n(i),s(e)}})}))})).then((function(e){return 0===n.length?(i.closeCertWaitingMask(),!1):(n=n.map((function(t){return t.id=e,t})),i.el.mask(_T("service","restart_apache"),"syno-ux-mask-info"),new Promise((function(e,t){i.sendWebAPI({api:"SYNO.Core.Certificate.Service",method:"set",version:1,scope:i,params:{settings:n},callback:function(i,s,n){i||t(s),e(s.restart_httpd)}})})))})).then((function(e){if(e)return new Promise((function(e,t){i.checkHttpdRestarted.defer(3e4,i,[e])}));i.closeCertWaitingMask()})).catch((function(t){t!==o&&(i.closeCertWaitingMask(),SYNO.Debug(t),"TencentCloud"!==e&&i.owner.getMsgBox().alert(_T("tree","leaf_wanconfig"),_T("service","service_ddns_create_cert_fail")))}))},checkHttpdRestarted:function(e){"https:"===location.protocol&&location.reload(),this.checkHttpdId=this.pollReg({webapi:{api:"SYNO.Core.Certificate.CRT",method:"list",version:1},interval:3,immediate:!0,scope:this,status_callback:function(t,i,s,n){(t||i.code)&&(this.pollUnreg(this.checkHttpdId),this.closeCertWaitingMask(),e())}})},closeCertWaitingMask:function(){this.el.isMasked()&&this.el.unmask()},isSynoHostname:function(e){for(var t=e.toLowerCase(),i=0;i<this.synoDomainList.length;i++){var s=this.synoDomainList[i].toLowerCase();if(t.indexOf(s)>0)return!0}return!1},setAndUpdateRec:function(){var e={id:"add"==this.action?null:this.selected,enable:this.serviceField.getValue(),provider:this.providerField.getValue(),hostname:this.hostnameField.getValue(),username:this.usernameField.getValue(),net:this.getNetFieldValue(),ip:"-"===this.getIpFieldValue(this.netV4Field)?"0.0.0.0":this.getIpFieldValue(this.netV4Field),ipv6:"-"===this.getIpFieldValue(this.netV6Field)?"0:0:0:0:0:0:0:0":this.getIpFieldValue(this.netV6Field),interface_v4:this.interfaceV4Field.getValue(),interface_v6:this.interfaceV6Field.getValue(),heartbeat:this.heartbeatField.getValue()};"Synology"===this.providerField.getValue()?e.passwd="Synology":(this.passwdField.isDirty()||"add"==this.action)&&(e.passwd=this.passwdField.getValue()),this.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:!0,params:[{api:"SYNO.Core.DDNS.Record",version:1,method:"add"==this.action?"create":"set",params:e},{api:"SYNO.Core.DDNS.Record",version:1,method:"update_ip_address",params:{id:this.providerField.getValue()}}]},callback:this.applyFunCallback})},isAbleToApply:function(){return this.providerField?!!this.providerField.getValue()&&(!("add"==this.action&&!this.serviceField.getValue())&&("Synology"!==this.providerField.getValue()||!_S("demo_mode"))):(SYNO.Debug("this.providerField is empty"),!1)},regAndApply:function(e){this.afterRegMyDSAccount(e),this.apply()},isDirty:function(e){for(var t=this.findFields(),i=0;i<t.length;++i)if("ddns_net_IPv4_row"!=t[i].itemId&&"ddns_net_IPv6_row"!=t[i].itemId&&"net"!=t[i].itemId&&"certificate"!=t[i].itemId&&t[i].isDirty())return!0;var s=this.findField("net_ipv4"),n=void 0!==s.newValue?s.newValue:s.originalValue,o=this.findField("net_ipv6"),a=void 0!==o.newValue?o.newValue:o.originalValue,r=(this.findField("net"),this.findField("interface_v4")),l=this.findField("interface_v6");if("add"==this.action)return"default"!==r.getValue()||"default"!==l.getValue();if("edit"===this.action){for(var d="",c=0;c<this.records.length;++c)this.records[c].provider===this.selected&&(d=this.records[c]);if(r.getValue()!==d.interface_v4)return!0;if(l.getValue()!==d.interface_v6)return!0;if(n!==SYNO.SDS.AdminCenter.PublicAccess.formatIP(d.ip)||a!==SYNO.SDS.AdminCenter.PublicAccess.formatIP(d.ipv6))return!0}var h=this.findField("certificate");return!h.hidden&&!e&&!(h.disabled||!h.checked)},apply:function(){var e,t=this.panel.getForm(),i="",s="",n=Ext.emptyFn;this.CheckFieldValid(t)?(t.isDirty=this.isDirty,t.isDirty()&&this.isAbleToApply()?this.checkAndDoRegMyDSAccount(this.regAndApply)||(this.setStatusBusy(),e=this.providerField.getValue(),n=function(){"Synology"===e?this.createSynoHostname(!1):"TWNIC"===e?this.createTWNICHostname(!1):this.setAndUpdateRec()}.bind(this),i="Synology"===e?this.synoHostnameField.getValue()+"."+this.domainList.getValue():"TWNIC"===e?this.TWNIC_hostnameField.getValue()+"."+this.TWNIC_domainList.getValue():this.hostnameField.getValue(),this.isDefaultCertChanged()?(s='<p style="font-weight:bold;">'+String.format(_T("service","service_ddns_syno_set_default_cert_notification"),i)+"</p>",s+=_T("service","service_ddns_syno_set_default_cert_service_invalid"),this.getMsgBox().confirm(_T("tree","leaf_wanconfig"),s,(function(e){"yes"==e?n():this.clearStatusBusy()}),this,{yes:{text:_T("common","apply")},no:{text:_T("common","cancel")}})):n()):this.close()):this.setStatusError({text:_T("common","forminvalid"),clear:!0})},isDefaultCertChanged:function(){return!this.certificateField.hidden&&!this.certificateField.disabled&&this.certificateField.checked},applyFunCallback:function(e,t,i){for(var s=0;s<t.result.length;s++){var n=t.result[s];if(("create"===n.method||"set"===n.method)&&!n.success)return void this.getMsgBox().alert(_T("tree","leaf_wanconfig"),_T("service","service_ddns_operation_fail"),this.clearStatusBusy,this)}var o=Promise.resolve(),a=this.providerField.getValue();this.serviceField.getValue()&&("Synology"===a?o=this.createCertificate(a):"TencentCloud"===a&&(o=new Promise(((e,t)=>{const i={api:"SYNO.Core.DDNS.Record",method:"list",version:1},s=n=>{n&&n.data&&n.data.records&&Ext.each(n.data.records,(function(n){if("TencentCloud"===n.id)return"service_ddns_normal"===n.status?(SYNO.SDS.SocketInst.unregister(i,s),e()):"loading"!==n.status&&(SYNO.SDS.SocketInst.unregister(i,s),t(n.status)),!1}))};SYNO.SDS.SocketInst.register(i,s,!0),setTimeout(t.bind(this,"timeout"),3e4)})).then(this.createCertificate.bind(this,a)).catch(SYNO.Debug))),o.then(function(){this.clearStatusBusy(),this.mun(this,"beforeclose",this.onBeforeClose,this),this.close()}.bind(this))},selectedProviderRegistered:function(e){for(var t=0;t<this.records.length;t++)if(this.records[t].provider===e&&""!==this.records[t].hostname){for(var i=0;i<this.selected_unreg_records.length;i++)if(this.selected_unreg_records[i]===e)return!1;return!0}return!1}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.DDNSRecordForm",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),e.testConBtn=Ext.getCmp(this.testConBtnId),e.ddnsProviderList=Ext.getCmp(this.ddnsProviderList),e.customBtn=Ext.getCmp(this.customBtnId)},fillConfig:function(e){var t={border:!1,labelWidth:200,padding:"0 0 0 0",items:SYNO.SDS.AdminCenter.PublicAccess.DDNSGetRecordConfig(this,!1,!1,!1,e.action,this.module)};return Ext.apply(t,e),t}}),SYNO.SDS.AdminCenter.PublicAccess.DDNSGetRecordConfig=function(e,t,i,s,n,o){var a="edit"===n,r=i||!a?0:1,l=i?200:280,d="CN"!==_S("ip_country")?void 0:['<tpl for=".">','<tpl if="'+(SYNO.SDS.AdminCenter.PublicAccess.CN_PROVIDER_ORDER.length+1)+'=== xindex">','<div style="border-top: 1px solid rgba(198,212,224,0.4); height: 1px; margin: 0 12px 0 6px;"></div>',"</tpl>",'<div class="x-combo-list-item">',"{display}","</div>","</tpl>"].join("");const c=function(e){const t="ipv6"===e,i=t?"interface_v6":"interface_v4",s=t?"interfaceV6":"interfaceV4";return{scope:this,blur:{fn:function(e){const t=e.getStore(),n=this.getForm().findField(i),o=n.getValue();let a=e.getValue(),r=a;if(t.clearFilter(),""===a&&(a="-",r="-","-"!==e.newValue&&n.setValue("disabled")),""!==o){const e=t.query(s,o);if(0<e.getCount()){const t=e.first().data;a===t.newValue||a===t.value?(a=t.value,r=t.newValue):"-"!==a&&n.setValue("")}}e.newValue=r,e.setValue(a)}},focus:{fn:function(e){let t=void 0!==e.newValue?e.newValue:e.originalValue;"-"===t&&(t=""),e.setValue(t)}},select:{fn:function(e,t){this.getForm().findField(i).setValue(t.get(s)),e.newValue=t.get("newValue"),e.setValue(t.get("value"))}}}};var h=[{xtype:"syno_displayfield",value:t?_T("ezinternet","ezinternet_ddns_use_desc"):_T("service","service_ddns_tip"),name:"ddns_description",hidden:a},{xtype:"syno_checkbox",boxLabel:t?_T("ezinternet","ezinternet_ddns_use_desc"):_T("service","service_ddns_tip"),name:"enable",hidden:!a,checked:!0},{synotype:"indent",indent:r,fieldLabel:_T("service","service_ddns_type"),xtype:"syno_compositefield",itemId:"ddns_provider_type",hidden:i,items:[{xtype:"syno_combobox",width:l,hiddenName:"ddns_provider_list",valueField:"id",displayField:"display",autoDestroy:!0,allowBlank:!1,hidden:a,id:e.ddnsProviderList=Ext.id(),store:new SYNO.SDS.AdminCenter.PublicAccess.DDNSTab.ProviderStore,tpl:d},{xtype:"syno_displayfield",name:"ddns_selected_provider",hidden:!a},{xtype:"syno_button",text:_T("service","service_ddns_customize"),itemId:"ddns_customize_provider_btn",id:e.customBtnId=Ext.id(),hidden:a,scope:this}]},{indent:r,fieldLabel:_T("service","service_ddns_hostname"),xtype:"syno_compositefield",itemId:"ddns_hostname",items:[{xtype:"syno_textfield",width:l,vtype:"hostname",allowBlank:!1,value:"",name:"hostname",enableKeyEvents:!0}]},{indent:r,fieldLabel:_T("service","service_ddns_hostname"),xtype:"syno_compositefield",itemId:"ddns_syno_hostname",hidden:!0,items:[{xtype:"syno_textfield",width:130,name:"syno_hostname",allowBlank:!1,minLength:2,maxLength:24,vtype:"shorthostname",enableKeyEvents:!0},{xtype:"syno_displayfield",width:3,tabIndex:-1,value:"."},{xtype:"syno_combobox",name:"ddns_domain_list",allowBlank:!1,valueField:"value",displayField:"display",width:137,value:_T("service","service_ddns_domain_select"),store:new Ext.data.JsonStore({autoDestroy:!0,fields:["value","display"],data:[]})}]},{indent:r,fieldLabel:_T("service","service_ddns_hostname"),xtype:"syno_compositefield",itemId:"ddns_twnic_hostname",hidden:!0,items:[{xtype:"syno_textfield",width:130,name:"twnic_hostname",vtype:"shorthostname",allowBlank:!1,minLength:1,maxLength:100},{xtype:"syno_displayfield",width:3,tabIndex:-1,value:"."},{xtype:"syno_combobox",name:"ddns_twnic_domain_list",allowBlank:!1,valueField:"value",displayField:"display",width:137,value:_T("service","service_ddns_domain_select"),store:new Ext.data.JsonStore({autoDestroy:!0,fields:["value","display"],data:[{value:"idv.tw",display:"idv.tw"},{value:"tw",display:_T("service","service_ddns_domain_tw")}]})}]},{xtype:"syno_textfield",fieldLabel:i?_T("service","service_ddns_email"):_T("service","service_ddns_username")+"/"+_T("service","service_ddns_email"),name:"username",width:l,indent:r,minLength:i?3:1,maxLength:256,value:"",vtype:i?"email":"",allowBlank:!1},{xtype:"syno_displayfield",htmlEncode:!1,cls:"syno-ddns-myds-account",indent:r,itemId:"mydsAccount",hidden:!0,fieldLabel:_T("myds","myds_account")},{xtype:"syno_displayfield",htmlEncode:!1,indent:r,itemId:"showAccount",hidden:!0,fieldLabel:_T("service","service_ddns_email")},{fieldLabel:_T("service","service_ddns_passwd")+"/"+_T("service","service_ddns_auth_key"),xtype:"syno_textfield",textType:"password",name:"passwd",width:l,indent:r,minLength:i?6:1,maxLength:128,value:"",allowBlank:!1},{fieldLabel:_T("service","service_ddns_passwd_confirm"),xtype:"syno_textfield",textType:"password_confirm",confirmFor:"passwd",name:"passwd_confirm",width:l,indent:r,minLength:i?6:1,maxLength:128,hidden:!i,value:"",allowBlank:!1},{xtype:"syno_combobox",fieldLabel:_T("service","service_wanconfig_gateway_addr_out")+"(IPv4)",itemId:"ddns_net_IPv4_row",indent:r,hidden:i,name:"net_ipv4",value:"",validator:function(){var e=null,t=null,i=null;let s=null,n=null;try{e=this.getForm().findField("net_ipv4"),t=this.getForm().findField("net_ipv6"),i=this.getForm().findField("ddns_net_IPv6_row"),s=this.getForm().findField("interface_v4"),n=this.getForm().findField("interface_v6")}catch(e){return}const o=e.newValue||e.originalValue,a=s.getValue(),r=n.getValue();let l=Ext.form.VTypes.v4ip(o);return t.clearInvalid(),!0!==l&&"-"===o&&(i.hidden?l="disabled"!==a||_T("common","error_emptyip"):"disabled"===a&&"disabled"===r?(t.markInvalid(_T("service","service_ddns_check_ip_empty")),l=_T("service","service_ddns_check_ip_empty")):l=!0),l}.bind(e),maskRe:/[0-9.]/,editable:!0,enableKeyEvents:!0,listeners:c.bind(e)("ipv4"),width:l,valueField:"value",displayField:"display",store:new Ext.data.JsonStore({autoDestroy:!0,fields:["value","display","newValue","interfaceV4","interfaceV6"],data:[]})},{xtype:"syno_combobox",indent:r,hidden:!(!t&&!i),hideLabel:!!t,fieldLabel:_T("service","service_wanconfig_gateway_addr_out")+"(IPv6)",itemId:"ddns_net_IPv6_row",name:"net_ipv6",value:"-",validator:function(){var e=null,t=null,i=null;let s=null,n=null;try{e=this.getForm().findField("net_ipv4"),t=this.getForm().findField("net_ipv6"),i=this.getForm().findField("ddns_net_IPv6_row"),s=this.getForm().findField("interface_v4"),n=this.getForm().findField("interface_v6")}catch(e){return}const o=t.newValue||t.originalValue,a=s.getValue(),r=n.getValue();let l=Ext.form.VTypes.v6ip(o);return e.clearInvalid(),!0!==l&&"-"===o&&(i.hidden||"disabled"!==a||"disabled"!==r?l=!0:(e.markInvalid(_T("service","service_ddns_check_ip_empty")),l=_T("service","service_ddns_check_ip_empty"))),l}.bind(e),maskRe:/[A-Za-z0-9:]/,editable:!0,enableKeyEvents:!0,listeners:c.bind(e)("ipv6"),width:l,valueField:"value",displayField:"display",store:new Ext.data.JsonStore({autoDestroy:!0,fields:["value","display","newValue","interfaceV4","interfaceV6"],data:[]})},{xtype:"syno_displayfield",indent:r,itemId:"net",value:"DEFAULT",hidden:!0,hideLabel:!0,fieldLabel:"Net IP Type"},{xtype:"syno_displayfield",indent:r,itemId:"interface_v4",value:"",hidden:!0,hideLabel:!0,fieldLabel:"IPv4 Interface"},{xtype:"syno_displayfield",indent:r,itemId:"interface_v6",value:"",hidden:!0,hideLabel:!0,fieldLabel:"IPv6 Interface"},{synotype:"indent",xtype:"syno_compositefield",indent:r,items:[{synotype:"indent",xtype:"syno_displayfield",htmlEncode:!1,id:"status",value:"--",hidden:!(!t&&!i),hideLabel:!!t,fieldLabel:_T("service","service_wanconfig_status")},{xtype:"syno_button",text:_T("routerconf","routerconf_test_conn"),style:"margin-left: 12px;",itemId:"ddns_test_con_btn",id:e.testConBtnId=Ext.id(),disabled:_S("demo_mode"),hidden:!!t,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""}]},{xtype:"syno_checkbox",boxLabel:_T("service","service_ddns_syno_create_cert"),name:"certificate",itemId:"certificate",indent:r,checked:!1,hidden:!0},{xtype:"syno_displayfield",indent:r+1,cls:"certificate-note",itemId:"certificate_note",value:_T("service","service_ddns_syno_create_cert_note"),hidden:!0,hideLabel:!0,htmlEncode:!1},{xtype:"syno_checkbox",boxLabel:_T("service","service_ddns_syno_set_default_cert"),name:"default_cert",itemId:"default_cert",indent:r+1,checked:!0,hidden:!0},{xtype:"syno_checkbox",boxLabel:_T("service","service_enable")+" "+_T("service","service_ddns_heartbeat"),name:"heartbeat",itemId:"heartbeat",indent:r,width:l,checked:i,hidden:!0},{xtype:"syno_displayfield",htmlEncode:!1,indent:r,itemId:"provider_website",value:"",hidden:!0,hideMode:"visibility",hideLabel:!0},{xtype:"syno_displayfield",htmlEncode:!1,indent:r,itemId:"note_info",value:"",hidden:!0,hideMode:"visibility",hideLabel:!0}];return SYNO.LayoutConfig.fill(h),h},Ext.define("SYNO.SDS.AdminCenter.PublicAccess.ButtonTextField",{extend:"Ext.Container",constructor:function(e){var t={border:!1,cls:"syno-ddns-fields-wrapper",items:[this.providerField=new SYNO.ux.TextArea({autoFlexcroll:!1,name:"provider",minLength:1,maxLength:32,width:200,height:48,style:"margin-right: 6px; overflow: hidden;",maskRe:/[a-zA-Z0-9\-._]/,value:e.display||"",validator:function(t){if(!/^[a-zA-Z0-9\-._]*$/.test(t))return!1;for(var i=e.owner.getValues().provider,s=0,n=0;n<i.length;n++)if(i[n]==="USER_"+t&&++s>1)return _T("service","service_ddns_dup_customized_provider");return!0},listeners:{render:function(e){e.getEl().set({spellcheck:!1})},valid:function(){e.owner.isValid(!0)},invalid:function(){e.owner.isValid(!0)}}}),this.urlField=new SYNO.ux.TextArea({autoFlexcroll:!1,name:"url",minLength:1,maxLength:500,width:480,height:48,style:"margin-right: 6px; overflow: hidden;",value:e.url||"",maskRe:/[a-zA-Z0-9\-._:/\\&#?]/,validator:function(e){return-1===e.indexOf(" ")&&-1===e.indexOf(";")},listeners:{render:function(e){e.getEl().set({spellcheck:!1})},valid:function(){e.owner.isValid(!0)},invalid:function(){e.owner.isValid(!0)}}}),this.removeBtn=new SYNO.ux.Button({cls:"syno-ddns-remove-button",scope:this,handler:function(){e.owner.removeField(this.id)}})]};e.notRemove&&this.removeBtn.setDisabled(!0),this.callParent([Ext.apply(t,e)])},focusTextFiled:function(){this.providerField.focus()},isValid:function(e){var t=this.providerField.isValid(e),i=this.urlField.isValid(e);return t&&this.providerField.clearInvalid(),i&&this.urlField.clearInvalid(),t&&i},isEmpty:function(){var e=this.providerField,t=this.urlField,i=e.rendered?e.getValue():e.value,s=t.rendered?t.getValue():t.value;return""===i||""===s},clearInvalid:function(){this.providerField.clearInvalid(),this.urlField.clearInvalid()}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.ProvidersForm",{extend:"SYNO.ux.Panel",constructor:function(e){var t={border:!1,cls:"syno-ddns-providers-form-wrapper",autoFlexcroll:!0,items:[{xtype:"container",cls:"syno-ddns-providers-header",width:"100%",items:[{xtype:"box",width:200,style:"margin-right: 6px; margin-bottom: 2px; line-height: 20px; padding-top: 4px; padding-bottom: 4px",html:_T("service","service_ddns_type")+_T("common","colon")},{xtype:"box",width:480,style:"margin-bottom: 2px; line-height: 20px; padding-top: 4px; padding-bottom: 4px",html:"Query URL"+_T("common","colon")}]},this.formPanel=new SYNO.ux.FormPanel({cls:"syno-ddns-providers-form",autoHeight:!0,border:!1,frame:!1,width:"100%",items:[new SYNO.SDS.AdminCenter.PublicAccess.ButtonTextField({owner:this,notRemove:!1})]}),this.addFieldButton=new SYNO.ux.Button({style:"margin-top: 6px;",text:_T("common","add_field"),disabled:!0,handler:function(){this.addFieldButton.setDisabled(!1);var e=new SYNO.SDS.AdminCenter.PublicAccess.ButtonTextField({owner:this});this.formPanel.add(e),this.formPanel.doLayout(),this.syncSize(),this.scrollToEnd(),e.focusTextFiled()},scope:this}),{width:"100%",xtype:"box",html:'<div class="ddns_customize_help_container"><div><div class="description normal-font" tabIndex="0"><span>'+_T("service","ddns_available_macros")+'</span></div><div class="content" tabIndex="0"><span class="title normal-font">'+_T("service","service_ddns_hostname")+_T("common","colon")+'</span><span class="info allowDefCtxMenu">__HOSTNAME__</span></div><div class="content" tabIndex="0"><span class="title normal-font">'+_T("common","ipv4_addr")+_T("common","colon")+'</span><span class="info allowDefCtxMenu">__MYIP__</span></div><div class="content" tabIndex="0"><span class="title normal-font">'+_T("service","service_ddns_username")+"/"+_T("service","service_ddns_email")+_T("common","colon")+'</span><span class="info allowDefCtxMenu">__USERNAME__</span></div><div class="content" tabIndex="0"><span class="title normal-font">'+_T("service","service_ddns_passwd")+"/"+_T("service","service_ddns_auth_key")+_T("common","colon")+'</span><span class="info allowDefCtxMenu">__PASSWORD__</span></div><div class="description normal-font" style="padding-top:12px" tabIndex="0"><span>'+_T("service","example")+'</span></div><div class="content" tabIndex="0"><span class="title normal-font">Query URL'+_T("common","colon")+'</span><span class="info allowDefCtxMenu">https://ddns.provider.org/update?hostname=__HOSTNAME__&myip=__MYIP__</span></div></div></div>'}]};this.callParent([Ext.apply(t,e)])},setValues:function(e){0!==e.length&&(this.formPanel.removeAll(),e.forEach((function(e){var t=new SYNO.SDS.AdminCenter.PublicAccess.ButtonTextField({provider:e.provider,display:e.display,url:e.url,owner:this});this.formPanel.add(t)}),this),this.originalCount=e.length,this.setDisabledAdd(!1),this.formPanel.doLayout(),this.syncSize())},scrollToEnd:function(){var e=this.getScrollTarget().dom.fleXcroll;e.formUpdate(),e.updateScrollBars();var t=this.getContentTarget().child(".contentwrapper").getHeight();e.scrollContent(0,t)},isValid:function(e){var t=this.formPanel.items.items;if(0===t.length)return!0;if(this.onValidCheck)return!1;this.onValidCheck=!0;var i=t[t.length-1],s=this.formPanel.getForm().isValid(e);return this.setDisabledAdd(i.isEmpty()||!s),this.onValidCheck=!1,s},setFieldAllowBlank:function(e){for(var t=0;t<this.formPanel.items.items.length;t++)this.formPanel.items.items[t].providerField.allowBlank=e,this.formPanel.items.items[t].urlField.allowBlank=e},setDisabledAdd:function(e){this.addFieldButton.setDisabled(e)},removeField:function(e){this.formPanel.remove(e),this.syncSize(),0==this.formPanel.items.length&&this.setDisabledAdd(!1),this.isValid(!0)},getValues:function(){var e=this.formPanel.getForm().getValues();if(e.provider&&e.url){Array.isArray(e.provider)||(e.provider=[e.provider]),Array.isArray(e.url)||(e.url=[e.url]),""===e.provider[e.provider.length-1]&&(e.provider.pop(),e.url.pop());for(var t=0;t<e.provider.length;t++)e.provider[t]=this.addCustomizedProviderPrefix(e.provider[t])}return e},addCustomizedProviderPrefix:function(e){return"USER_"+e},focusFirstTextFiled:function(){this.formPanel.get(0).focusTextFiled()},isDirty:function(){return this.originalCount!==this.formPanel.items.items.length||this.formPanel.getForm().isDirty()}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.DDNSAdvancedDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.module=e.module,this.providers=e.providers,this.deleteProviderBtn=Ext.getCmp(this.delProviderBtnId);var t=Ext.apply({title:_T("service","service_ddns_customize_provider"),width:780,height:540,layout:"fit",resizable:!1,buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","save"),scope:this,handler:this.apply}],items:[this.providersForm=new SYNO.SDS.AdminCenter.PublicAccess.ProvidersForm]},e);SYNO.SDS.AdminCenter.PublicAccess.DDNSAdvancedDialog.superclass.constructor.call(this,t)},afterRender:function(e){this.callParent([e]);var t=0;for(t=this.providers.length-1;t>=0;t--)0===this.providers[t].provider.search("USER_")?this.providers[t].display=this.providers[t].provider.replace("USER_",""):this.providers.splice(t,1);this.providersForm.setValues(this.providers)},apply:function(){if(this.isDirty())if(this.providersForm.setFieldAllowBlank(!1),this.providersForm.isValid()){var e=this.providersForm.getValues(),t=[];if(e.provider)for(var i=0;i<e.provider.length;i++)t.push({id:e.provider[i],url:e.url[i]});this.sendWebAPI({api:"SYNO.Core.DDNS.Provider",method:"update_customized_provider",version:1,scope:this,params:{providers:t},callback:function(e,t,i){e?this.close():this.owner.getMsgBox().alert(_T("tree","leaf_wanconfig"),_T("service","service_ddns_operation_fail"))}})}else this.setStatusError({text:_T("common","forminvalid"),clear:!0});else this.setStatusError({text:_T("error","nochange_subject"),clear:!0})},isDirty:function(){const e=new Set(this.providersForm.getValues().provider);return this.providersForm.isDirty()||this.providers.some((t=>!e.has(t.provider)))}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.DDNSTab.ProviderStore",{extend:"Ext.data.JsonStore",constructor:function(e){const t=Ext.apply({autoDestroy:!0,fields:[{name:"id",mapping:"id"},{name:"display",mapping:"display"},{name:"provider",mapping:"provider"},{name:"registrable",mapping:"registrable"}],idProperty:"id"},e);"CN"===_S("ip_country")&&(t.sortInfo={field:"id",direction:"ASC"}),this.callParent([t])},createSortFunction:function(e,t){for(var i="DESC"==t.toUpperCase()?-1:1,s={},n=SYNO.SDS.AdminCenter.PublicAccess.CN_PROVIDER_ORDER,o=0;o<n.length;o++)s[n[o]]=o+1;return function(t,n){var o=t.data[e],a=n.data[e];return Ext.isDefined(s[o])&&Ext.isDefined(s[a])?(s[o]-s[a])*i:Ext.isDefined(s[o])||"Synology"===a?-1*i:Ext.isDefined(s[a])||"Synology"===o?i:i*(o>a?1:o<a?-1:0)}}}),Ext.ns("SYNO.SDS.AdminCenter.PublicAccess"),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.QuickConnectAdvDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.module=e.module,this.panel=new SYNO.SDS.AdminCenter.PublicAccess.QuickConnectAdvForm({module:this.module,owner:this,quickconnect_panel:e.quickconnect_panel,isInTunnel:e.isInTunnel});var t=Ext.apply({title:_T("common","adv_setting"),layout:"fit",width:600,height:"auto",resizable:!1,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.customCancelHandler},{btnStyle:"blue",itemId:"recordApply",text:_T("common","apply"),scope:this,handler:this.customApplyHandler}]},e);SYNO.SDS.AdminCenter.PublicAccess.QuickConnectAdvDialog.superclass.constructor.call(this,t)},afterRender:function(e){this.callParent([e]),this.panel.loadForm()},customApplyHandler:function(){if(this.panel.getForm().isDirty()){if(this.panel.getPermissionEnableCount()<=0)return void this.getMsgBox().alert(this.title,_T("relayservice","no_permission_select_warning"));this.panel.closeDialogAfterSuccess=!0,this.setStatusBusy({text:_T("common","saving")}),this.panel.applyForm()}else this.close()},customCancelHandler:function(){this.close()}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.QuickConnectAdvForm",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.quickconnect_panel=e.quickconnect_panel,this.isStoreUpdated=!1,this.store=this.createStore(),this.columnModel=this.createColumnModel(),this.dsm_permission=!1,this.mobile_apps_permission=!1,this.cloud_permission=!1,this.file_sharing_permission=!1,this.isInAliDSM=SYNO.SDS.Utils.isInAliDSM(),this.closeDialogAfterSuccess=!1;var t=Ext.apply({title:_T("relayservice","adv_setting"),items:this.createObjs(),autoHeight:!0},e);this.callParent([t]),this.mon(this,"deactivate",this.deactivate,this,{single:!1}),this.mon(this,"activate",this.activate,this,{single:!1}),this.mon(this,"beforehide",this.beforehide,this,{single:!1}),this.getCmpsAsMembers(),e.isInTunnel&&this.on("afterlayout",this.insideTunnelHandler,this,{single:!0}),this.getForm().parentPanel=this,this.getForm().isDirty=this.isDirty},createObjs:function(){return[{xtype:"syno_displayfield",id:this.field_inside_tunnel_msg=Ext.id(),hidden:!0,htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+': </span><span class="normal-font">'+_T("relayservice","inside_tunnel_msg")+"</span>"},{xtype:"syno_fieldset",title:_T("relayservice","misc"),cls:"syno_quickconnect_fieldset",collapsible:!1,items:[{xtype:"syno_checkbox",id:this.field_relay_enabled=Ext.id(),name:"relay_enabled",value:!0,boxLabel:_T("relayservice","relay_enabled"),indent:0},{xtype:"syno_displayfield",indent:1,name:"relay_enabled_desc",value:_T("relayservice","relay_enabled_desc")},{xtype:"syno_checkbox",id:this.field_portforward_enabled=Ext.id(),name:"portforward_enabled",value:!this.isInAliDSM,disabled:this.isInAliDSM,boxLabel:_T("relayservice","enable_portforward"),indent:0},{xtype:"syno_displayfield",indent:1,name:"enable_portforward_tip_desc",disabled:this.isInAliDSM,value:_T("relayservice","enable_portforward_tip")}]},{xtype:"syno_fieldset",title:_T("relayservice","permission"),cls:"syno_quickconnect_fieldset",collapsible:!1,items:[{xtype:"syno_displayfield",value:_T("relayservice","permission_desc"),id:this.permission_desc=Ext.id()},{xtype:"syno_gridpanel",id:this.gridpanel=Ext.id(),cm:this.columnModel,store:this.store,selModel:new Ext.grid.RowSelectionModel,height:142,padding:"0 0 0 0",style:{"padding-top":"0px"},enableColumnMove:!1,enableHdMenu:!1,hideMode:"offsets",plugins:[this.columnModel.enable_column]}]}]},beforehide:function(){return this.store.getCount()<=0||(!(this.getPermissionEnableCount()<=0)||(this.appWin.getMsgBox().alert(this.title,_T("relayservice","no_permission_select_warning")),!1))},cancelHandler:function(){this.store.rejectChanges()},getCmpsAsMembers:function(){for(var e=["field_relay_enabled","field_portforward_enabled","gridpanel","permission_desc","field_inside_tunnel_msg"],t=0;t<e.length;++t)this[e[t]]=Ext.getCmp(this[e[t]])},insideTunnelHandler:function(){this.field_inside_tunnel_msg.setVisible(!0),this.field_relay_enabled.disable(),this.field_portforward_enabled.disable(),this.gridpanel.disable(),this.permission_desc.disable()},updateUpnpInfo:function(e){void 0!==e&&(this.field_portforward_enabled.setValue(e.data.enabled),this.field_portforward_enabled.originalValue=this.field_portforward_enabled.getValue(),this.isInAliDSM&&this.field_portforward_enabled.setValue(!1))},updateRelaySerivceInfo:function(e){void 0!==e&&(this.field_relay_enabled.setValue(e.data.relay_enabled),this.field_relay_enabled.originalValue=this.field_relay_enabled.getValue())},updateCloudPermissionName:function(e){if(void 0!==e){this.cloud_permission_name=_T("relayservice","name_cloud");for(var t=0;t<e.data.total;t++)if("SynologyDrive"===e.data.packages[t].id){this.cloud_permission_name=e.data.packages[t].name+" ("+_T("relayservice","include_name_cloud")+")";break}}},updatePermissionHeight:function(){if(void 0!==this.gridpanel){var e=30*(this.store.getCount()+1)+2+8+12;this.gridpanel.setHeight(e)}},getPermissionEnableCount:function(){var e=this.store.getCount(),t=0;if(!(e<=0)){for(var i=0;i<e;i++){!0===this.store.getAt(i).data.enable&&t++}return t}},setAllItemDisabled:function(e){SYNO.SDS.QuickConnect.Utils.isInTunnel()||(this.field_relay_enabled.setDisabled(e),this.field_portforward_enabled.setDisabled(e),this.gridpanel.setDisabled(e),this.permission_desc.setDisabled(e),this.isInAliDSM&&this.field_portforward_enabled.disable())},createStore:function(){return new Ext.data.ArrayStore({autoDestroy:!0,autoLoad:!1,idProperty:"name",fields:["name","enable"]})},loadData:function(e){var t=[];this.name_index=[];for(var i=0,s=0;i<e.services.length;i++){var n=this.getDisplayNameByID(e.services[i].id);n&&(this.name_index[s]=e.services[i].id,t[s]=[],t[s][0]=n,t[s][1]=e.services[i].enabled,s++)}this.store.loadData(t,!1),this.savePermissionInfo(),this.updatePermissionHeight()},createGridPanel:function(){return new SYNO.ux.GridPanel({cm:this.columnModel,store:this.store,selModel:new Ext.grid.RowSelectionModel,height:215,enableColumnMove:!1,enableHdMenu:!1,hideMode:"offsets",plugins:[this.columnModel.enable_column]})},createColumnModel:function(){var e=new SYNO.ux.EnableColumn({id:"enable",align:"center",header:_T("relayservice","enable_service"),dataIndex:"enable",width:150,sortable:!1}),t=new Ext.grid.ColumnModel({defaults:{align:"center"},xtype:"datecolumn",columns:[e,{id:"name",align:"left",header:_T("common","name"),dataIndex:"name",width:650,sortable:!1,renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}}]});return t.enable_column=e,t},getDisplayNameByID:function(e){return{mobile_apps:null!==_D("unique").match(/synology_.+_nvr.+/)?_T("relayservice","name_mobile_app_for_nvr"):_T("relayservice","name_mobile_app"),cloudstation:this.cloud_permission_name?this.cloud_permission_name:_T("relayservice","name_cloud"),file_sharing:_T("relayservice","name_file_sharing"),dsm_portal:_T("relayservice","name_dsm_portal")}[e]},webAPISetPermission:function(){return{api:"SYNO.Core.QuickConnect.Permission",method:"set",version:"1",params:{services:this.savePermissionInfo()}}},webAPIGetPermission:function(){return{api:"SYNO.Core.QuickConnect.Permission",method:"get",version:"1"}},webAPIGetMiscSetting:function(){return[{api:"SYNO.Core.QuickConnect",method:"get_misc_config",version:"3",params:{}},{api:"SYNO.Core.QuickConnect.Upnp",method:"get",version:"1",params:{}}]},webAPISetMiscSetting:function(){var e=[];return this.field_relay_enabled.originalValue!=this.field_relay_enabled.getValue()&&e.push({api:"SYNO.Core.QuickConnect",method:"set_misc_config",version:"3",params:{relay_enabled:this.field_relay_enabled.getValue()}}),this.field_portforward_enabled.originalValue!=this.field_portforward_enabled.getValue()&&e.push({api:"SYNO.Core.QuickConnect.Upnp",method:"set",version:"1",params:{enabled:this.field_portforward_enabled.getValue()}}),e},isDirty:function(){for(var e=this.parentPanel,t=[e.field_relay_enabled,e.field_portforward_enabled],i=0;i<t.length;++i)if(t[i].isDirty())return!0;return e.isPermissionDirty()},isPermissionDirty:function(){return this.store.getModifiedRecords().length>0},getTabPanel:function(e){return this.panel||(this.panel=new SYNO.SDS.AdminCenter.QuickConnect.AdvancePanel({module:e.module,owner:e.owner,window_:this})),this.panel},processParams:function(e,t){return this.quickconnect_panel.stopWatchingStatus(),t=t.concat(this.getWebAPIParams(e))},getWebAPIParams:function(e){var t=[];if("get"===e)t=[{api:"SYNO.Core.Package",method:"list",version:"1",params:{additional:["status"]}},{api:"SYNO.Core.QuickConnect",method:"get_misc_config",version:"3",params:{}},{api:"SYNO.Core.QuickConnect.Upnp",method:"get",version:"1",params:{}},{api:"SYNO.Core.QuickConnect.Permission",method:"get",version:"1"}];else if("set"===e){if(this.getPermissionEnableCount()<=0)return t;t=this.webAPISetMiscSetting(),this.isPermissionDirty()&&t.push(this.webAPISetPermission())}return t},savePermissionInfo:function(){for(var e=this.store.getCount(),t=[],i=0;i<e;i++){var s=this.store.getAt(i);switch(t[i]={},t[i].id=this.name_index[i],t[i].enabled=s.data.enable,t[i].id){case"dsm_portal":this.dsm_permission=t[i].enabled;break;case"mobile_apps":this.mobile_apps_permission=t[i].enabled;break;case"cloudstation":this.cloud_permission=t[i].enabled;break;case"file_sharing":this.file_sharing_permission=t[i].enabled}}return t},processReturnData:function(e,t,i){for(var s in t.result)if(t.result.hasOwnProperty(s)){var n=t.result[s];if(!1===n.success)continue;switch(n.api){case"SYNO.Core.QuickConnect":"get_misc_config"===n.method?this.updateRelaySerivceInfo(n):"set_misc_config"===n.method&&(this.field_relay_enabled.originalValue=this.field_relay_enabled.getValue());break;case"SYNO.Core.QuickConnect.Upnp":"get"===n.method?this.updateUpnpInfo(n):"set"===n.method&&(this.field_portforward_enabled.originalValue=this.field_portforward_enabled.getValue());break;case"SYNO.Core.QuickConnect.Permission":"get"===n.method?(this.loadData(n.data),this.updatePermissionInfo(n),this.store.rejectChanges()):"set"===n.method&&this.store.commitChanges();break;case"SYNO.Core.Package":"list"===n.method&&this.updateCloudPermissionName(n)}}var o=this.quickconnect_panel;o.dsm_permission=this.dsm_permission,o.mobile_apps_permission=this.mobile_apps_permission,o.cloud_permission=this.cloud_permission,o.file_sharing_permission=this.file_sharing_permission,o.field_enabled.originalValue&&o.checkServicesFirewall(),o.setInfoItems(),o.watchStatus(),this.superclass().processReturnData.apply(this,[e,t,i]),!0===t.has_fail?this.owner.setStatusError({text:_T("error","error_unknown_desc"),clear:!0}):!0===this.closeDialogAfterSuccess&&this.owner.close()},updatePermissionInfo:function(e){if(void 0!==e.data)for(var t in this.dsm_permission=!1,this.mobile_apps_permission=!1,this.cloud_permission=!1,this.file_sharing_permission=!1,e.data.services)if(e.data.services.hasOwnProperty(t))switch(e.data.services[t].id){case"dsm_portal":this.dsm_permission=e.data.services[t].enabled;break;case"mobile_apps":this.mobile_apps_permission=e.data.services[t].enabled;break;case"cloudstation":this.cloud_permission=e.data.services[t].enabled;break;case"file_sharing":this.file_sharing_permission=e.data.services[t].enabled}}}),Ext.ns("SYNO.SDS.AdminCenter.PublicAccess"),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.QuickConnectTab",{extend:"SYNO.SDS.Utils.FormPanel",error_msg_cls:"syno_quickconnect_error_msg_field",constructor:function(e){this.info_template=new SYNO.SDS.AdminCenter.QuickConnect.InfoTemplate({parentPanel:this}),this.module=e.module,this.parent_panel=e.originalFormPanel,this.observer=e.observer,this.status_error=!1,this.isActivated=!1,this.callParent([Ext.apply({module:e.module,appWin:e.appWin,trackResetOnLoad:!0,title:_T("relayservice","relayservice_title"),webapi:{api:"SYNO.Core.QuickConnect",methods:{get:"get",set:"set_server_alias"},version:this.getQcWebApiVersion("SYNO.Core.QuickConnect","get")},labelWidth:250,items:this.createObjs(e),listeners:{activate:this.onActivate,deactivate:this.onDeactivate}},e)]),e.isInTunnel?this.on("afterlayout",this.insideTunnelHandler,this,{single:!0}):this.on("afterlayout",this.addTip,this,{single:!0}),this.on("afterlayout",this.addAriaAttirbutes,this,{single:!0}),this.getCmpsAsMembers(),this.addEnableDisableListeners(this.field_server_alias),this.getForm().parentPanel=this,this.getForm().isDirty=this.isDirty,this.initialize_permission(this.getDsmVersion()),this.realname_validation_required=!1,this.country="",this.qc_available=!0,this.violated=!1,this.mydsAccount="",this.quickconnect_ddns_domain="direct.quickconnect.to",this.is_quickconnect_enable_confirm=!1,this.is_quickconnect_disable_confirm=!1,this.isSmartDNS=e.isSmartDNS,this.isInTunnel=e.isInTunnel},getDsmVersion:function(){return _S("version")},getHelpParam:function(){return"AdminCenter/connection_quickconnect.html"},getQcWebApiVersion:function(e,t){var i=this.getDsmVersion(),s=1;if("SYNO.Core.QuickConnect"===e)switch(t){case"get":case"set":case"set_server_alias":s=4989<=i&&i<5450||5456<=i?2:1;break;case"check_availability":return 3;default:s=1}else s=1;return s},permissions:["dsm_permission","mobile_apps_permission","cloud_permission","file_sharing_permission"],initialize_permission:function(e){for(var t=0;t<this.permissions.length;++t)this[this.permissions[t]]=false},onActivate:function(){this.isActivated=!0},onDeactivate:function(){this.isActivated=!1,this.parent_panel.clearStatus(),this.SAWebLogin&&this.SAWebLogin.cancel()},addEnableDisableListeners:function(e){e.addListener("enable",(function(e){""!==e.getValue()&&e.validate()}),e),e.addListener("disable",e.clearInvalid,e)},insideTunnelHandler:function(){this.field_inside_tunnel_msg.setVisible(!0),this.field_enabled.disable(),this.field_server_alias.disable(),this.adv_setting_btn.disable()},getCmpsAsMembers:function(){for(var e=["field_enabled","field_server_alias","field_status","field_force","field_info_box","field_inside_tunnel_msg","adv_setting_btn","privacy_note"],t=0;t<e.length;++t)this[e[t]]=Ext.getCmp(this[e[t]])},showEnableConfirmMsg:function(){var e=this.findAppWindow().getMsgBox()({owner:this.appWin}),t={yes:{text:_T("common","agree")},no:{text:_T("common","cancel")}},i="<h2>"+_T("relayservice","quickconnect_confirm_title")+"</h2>";this.isSmartDNS?i+=_T("relayservice","quickconnect_confirm_desc_smartdns"):i+=_T("relayservice","quickconnect_confirm_desc"),e.confirm("",i,(function(e){"yes"===e?(this.is_quickconnect_enable_confirm=!0,this.parent_panel.applyAllForm(this.parent_panel.applyAllFormOptions)):this.discardChange()}),this,t)},showDisableConfirmMsg:function(){var e={yes:{text:_T("common","agree")},no:{text:_T("common","cancel")}};this.findAppWindow().getMsgBox().confirm("",_T("relayservice","quickconnect_disable_confirm_desc"),(function(e){"yes"==e?(this.is_quickconnect_disable_confirm=!0,this.parent_panel.applyAllForm(this.parent_panel.applyAllFormOptions)):this.discardChange()}),this,e)},setFieldsEnabled:function(){var e=this.field_enabled.getValue()&&this.qc_available;this.isInTunnel||(this.adv_setting_btn.setDisabled(!e),this.field_server_alias.setDisabled(!e),this.field_info_box.setDisabled(!e),this.field_info_box.update(this.info_template.getData(e)))},enableChanged:function(e,t){if(!this.isInTunnel)if(!0===t&&""===this.mydsAccount){this.field_enabled.setValue(!1);var i={yes:{text:_T("common","login")},no:{text:_T("common","cancel")}};this.findAppWindow().getMsgBox().confirm("",_T("relayservice","login_for_quickconnect"),(function(e){"yes"===e&&this.loginMyDsAccount()}),this,i)}else this.setFieldsEnabled()},setAvailability:function(e){this.qc_available=e,this.setFieldsEnabled(),this.setInfoItems(),this.realname_validation_required&&(this.field_status.addClass(this.error_msg_cls),""===this.country||"CN"===this.country?this.field_status.setValue(_T("relayservice","need_real_name_valid")):this.field_status.setValue(_T("relayservice","bypass_real_name_valid")))},discardChange:function(){this.field_enabled.setValue(this.field_enabled.originalValue),this.field_server_alias.setValue(this.field_server_alias.originalValue)},addTip:function(){SYNO.ux.AddTip(this.getForm().findField("server_alias").getEl(),_JSLIBSTR("vtype","bad_relay_alias_name"))},addAriaAttirbutes:function(){},hideInfoItems:function(){this.field_status.setVisible(!1),this.field_info_box.setVisible(!1)},setInfoItems:function(){var e="connected"===this.quick_connect_status,t=!(this.dsm_permission||this.cloud_permission||this.mobile_apps_permission),i=!e||t||this.violated;this.field_status.setVisible(i&&this.enabled||this.realname_validation_required),this.field_info_box.setVisible(e&&!t&&this.qc_available),this.privacy_note.setVisible(!e),this.field_info_box.update(this.info_template.getData(!0)),this.doLayout()},onBeforeRequest:function(e){if("set"===e&&!0===this.field_enabled.getValue()){if(!this.getForm().isValid())return this.parent_panel.setStatusError({text:_T("common","forminvalid"),clear:!0}),this.confirmLostChangeReject&&(this.confirmLostChangeReject(),this.confirmLostChangeReject=void 0),!1;if(this.isSmartDNS&&!1===this.is_quickconnect_enable_confirm&&this.isFieldDirty()&&!1===this.field_force.getValue())return this.showEnableConfirmMsg(),!1}return"set"===e&&!1===this.field_enabled.getValue()&&this.isSmartDNS&&!1===this.is_quickconnect_disable_confirm?(this.showDisableConfirmMsg(),!1):(this.is_quickconnect_enable_confirm=!1,this.is_quickconnect_disable_confirm=!1,!0)},processParams:function(e,t){var i,s,n=[];if(this.hideInfoItems(),this.privacy_note.setVisible("connected"===this.quick_connect_status),t.forEach((function(e){"SYNO.Core.QuickConnect"===e.api?"get"===e.method?i=e:"set_server_alias"===e.method&&(s=e):n.push(e)})),"get"===e)n.push(i),n.push(this.createQuickConnectAPI("status",{})),n.push(this.createQuickConnectAPI("get",{},"SYNO.Core.QuickConnect.Permission")),n.push(this.createQuickConnectAPI("check_availability",{}));else if(this.getForm().isDirty()){var o=this.field_enabled.getValue();if(this.isSmartDNS){var a={};a.hostname=window.location.hostname,n.push(this.createQuickConnectAPI("get_ip",a,"SYNO.Core.QuickConnect.Hostname"))}o&&!this.realname_validation_required&&n.push(s),n.push(this.createSetApi(s)),n.push(i),n.push(this.createQuickConnectAPI("status",{})),delete s.enabled}return this.setFieldDisable(!0),n},createSetApi:function(e){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.method="set",t.params={},t.params.enabled=e.params.enabled,t},createQuickConnectAPI:function(e,t,i){i=void 0===i?"SYNO.Core.QuickConnect":i;var s={};return s.api=i,s.version=this.getQcWebApiVersion(i,e),s.method=e,s.params=t,s},quickConnectSetStatusError:function(e,t,i){var s={2900:_T("error","error_unknown_desc"),2901:_T("error","error_unknown_desc"),2902:_T("relayservice","relayservice_err_resolv"),2903:_T("relayservice","error_alias_server_internal"),2904:String.format(_T("relayservice","relayservice_err_alias_in_use"),i),2905:_T("pkgmgr","myds_error_account"),2906:_T("relayservice","error_alias_used_in_your_own"),2907:_T("relayservice","relayservice_err_bad_dns"),2909:_T("relayservice","error_myds_not_logged_in"),2910:_T("relayservice","violation"),3e3:_T("error","error_unknown_desc"),3001:_T("error","error_unknown_desc"),3002:_T("relayservice","relayservice_err_network"),3003:_T("relayservice","myds_server_internal_error"),3004:_T("error","error_auth"),3005:String.format(_T("relayservice","relayservice_err_alias_in_use"),i),3006:_T("relayservice","myds_exceed_max_register_error")};if(e.success)return"";var n=e.error.code,o=n<400?SYNO.API.CheckResponse(!1,e,t):s[n];return this.parent_panel.clearStatus(),2910===n?(this.violated=!0,this.field_status.addClass(this.error_msg_cls),void this.field_status.setValue(o)):this.parent_panel.setStatusError({text:o,clear:!1})},errorHandling:function(e,t){var i,s,n;for(var o in e.result)if(!e.result[o].success){i=e.result[o],s=t.compound[o],n=t.compound[o].server_alias,this.quickConnectSetStatusError(i,s,n),this.status_error="status"===e.result[o].method;break}i&&i.error&&(2906===i.error.code?this.findAppWindow().getMsgBox({draggable:!1,owner:this.appWin}).confirm(_T("relayservice","error_alias_used_in_your_own"),_T("relayservice","alias_change_machine_message"),(function(e){"yes"===e&&(this.field_force.setValue(!0),this.parent_panel.clearStatus(),this.parent_panel.applyAllForm())}),this):2909===i.error.code&&(this.setMyDsAccount(""),this.field_enabled.setValue(!1)))},setRedirectMask:function(){new SYNO.SDS.MessageBoxV5({modal:!0,draggable:!1,renderTo:document.body}).getWrapper().show({closable:!1,msg:_T("relayservice","redirecting")})},setFieldDisable:function(e){e?(this.field_enabled.setDisabled(!0),this.field_server_alias.setDisabled(!0),this.adv_setting_btn.setDisabled(!0)):(this.field_enabled.setDisabled(this.isInTunnel),this.field_server_alias.setDisabled(this.isInTunnel||!this.field_enabled.getValue()),this.adv_setting_btn.setDisabled(this.isInTunnel||!this.field_enabled.getValue()))},processReturnData:function(e,t,i){var s=this.field_enabled.originalValue,n=this.field_enabled.getValue(),o=n!==s,a=!1,r="",l=0,d=void 0;this.setFieldDisable(!1);var c={has_fail:!1,result:[]},h={compound:[]};for(l in t.result)t.result.hasOwnProperty(l)&&(d=t.result[l]).api.startsWith("SYNO.Core.QuickConnect")&&(c.result.push(t.result[l]),h.compound.push(i.compound[l]),!1===d.success&&(c.has_fail=!0));if(!0===c.has_fail){for(l in c.result)c.result.hasOwnProperty(l)&&"SYNO.Core.QuickConnect"===(d=c.result[l]).api&&"get"===d.method&&d.success&&(this.updateServerInfo(d),this.superclass().processReturnData.apply(this,[e,t,i]));this.errorHandling(c,h)}else{for(l in c.result)if(c.result.hasOwnProperty(l))switch((d=c.result[l]).api){case"SYNO.Core.QuickConnect":switch(d.method){case"get":this.updateServerInfo(d);break;case"status":this.updateStatus(d),this.status_error&&(this.parent_panel.clearStatus(),this.status_error=!1);break;case"check_availability":this.realname_validation_required=2911===d.data.code,this.country=d.data.country,this.setAvailability(d.data.available);break;case"set":a=!0}break;case"SYNO.Core.QuickConnect.Permission":"get"===d.method&&this.updatePermissionInfo(d);break;case"SYNO.Core.QuickConnect.Hostname":"get_ip"===d.method&&(r=null!=d.data.ipv4&&""!=d.data.ipv4?d.data.ipv4:"["+d.data.ipv6+"]")}if(this.superclass().processReturnData.apply(this,[e,t,i]),n&&a){if(this.isSmartDNS){this.confirmLostChangeResolve=void 0,this.setRedirectMask();var u="https://"+this.field_server_alias.getValue()+"."+this.domain;this.waitCertificateReady(60).finally(function(){this.redirectPage(u)}.bind(this))}}else!n&&o&&this.isSmartDNS&&(this.confirmLostChangeResolve=void 0,this.setRedirectMask(),this.redirectPage("https://"+r+":"+window.location.port))}this.enableChanged(this.field_enabled,this.field_enabled.getValue()),this.field_enabled.getValue()&&!1===s&&this.checkServicesFirewall(),""===this.field_server_alias.getValue()&&this.field_server_alias.clearInvalid(),this.field_force.setValue(!1),this.setInfoItems(),this.watchStatus(),!1===c.has_fail&&this.confirmLostChangeResolve&&this.confirmLostChangeResolve(),this.confirmLostChangeResolve=void 0},setMyDsAccount:function(e){void 0!==e&&e.length>0?this.mydsAccount=e:this.mydsAccount="",this.isInTunnel||this.field_server_alias.setDisabled(!this.field_enabled.getValue())},updateServerInfo:function(e){void 0!==e.data&&(this.enabled=e.data.enabled,this.server_alias=e.data.server_alias,this.server_id=e.data.server_id,this.domain=e.data.domain,this.setMyDsAccount(Ext.util.Format.htmlEncode(e.data.myds_account)),void 0!==e.data.ddns_domain&&""!==e.data.ddns_domain&&(this.quickconnect_ddns_domain=e.data.ddns_domain),""===e.data.myds_account&&this.mon(this.observer,"ddns_account_logged_in",(e=>{this.setMyDsAccount(Ext.util.Format.htmlEncode(e))})))},updateStatus:function(e){this.quick_connect_status=e.data.status,this.alias_status=e.data.alias_status},updatePermissionInfo:function(e){if(void 0!==e.data)for(var t in this.dsm_permission=!1,this.mobile_apps_permission=!1,this.cloud_permission=!1,this.file_sharing_permission=!1,e.data.services)if(e.data.services.hasOwnProperty(t))switch(e.data.services[t].id){case"dsm_portal":this.dsm_permission=e.data.services[t].enabled;break;case"mobile_apps":this.mobile_apps_permission=e.data.services[t].enabled;break;case"cloudstation":this.cloud_permission=e.data.services[t].enabled;break;case"file_sharing":this.file_sharing_permission=e.data.services[t].enabled}},createObjs:function(e){return[{xtype:"syno_displayfield",id:this.field_inside_tunnel_msg=Ext.id(),hidden:!0,htmlEncode:!1,value:'<span class="syno-ux-note note-font">'+_T("common","note")+': </span><span class="normal-font">'+_T("relayservice","inside_tunnel_msg")+"</span>"},{xtype:"syno_displayfield",value:_T("relayservice","quickconnect_desc")},{xtype:"syno_fieldset",title:_T("common","general"),cls:"syno_quickconnect_fieldset",collapsible:!1,items:[{xtype:"syno_checkbox",name:"enabled",id:this.field_enabled=Ext.id(),listeners:{scope:this,check:this.enableChanged},boxLabel:_T("relayservice","enable_quickconnect")},{xtype:"syno_textfield",allowBlank:!1,fieldLabel:_T("relayservice","title_svrid"),id:this.field_server_alias=Ext.id(),name:"server_alias",maxLength:32,regex:/^[a-zA-Z][a-zA-Z\-0-9]*[a-zA-Z0-9]$/,regexText:_JSLIBSTR("vtype","bad_relay_alias_name"),enableKeyEvents:!0,indent:1},{xtype:"syno_checkbox",id:this.field_force=Ext.id(),name:"force",value:!1,hidden:!0},{xtype:"syno_displayfield",id:this.field_status=Ext.id(),hidden:!0,fieldLabel:_T("relayservice","status"),indent:1,htmlEncode:!1},{xtype:"box",id:this.field_info_box=Ext.id(),tpl:this.info_template,selectable:!0},{xtype:"syno_displayfield",id:this.privacy_note=Ext.id(),hideLabel:!0,value:String.format(_T("relayservice","privacy_note"),'<span class="syno-ux-note note-font">',"</span>"),indent:1,htmlEncode:!1}]},{xtype:"syno_fieldset",title:_T("relayservice","adv_setting"),cls:"syno_quickconnect_fieldset",collapsible:!1,items:[{xtype:"syno_displayfield",value:_T("relayservice","adv_setting_description")},{xtype:"syno_button",cls:"quickconnect-advance-button",text:_T("common","adv_setting"),id:this.adv_setting_btn=Ext.id(),scope:this,handler:this.advSettingHandler}]}]},advSettingHandler:function(){new SYNO.SDS.AdminCenter.PublicAccess.QuickConnectAdvDialog({owner:this.module.appWin,module:this,quickconnect_panel:this}).open({scope:this})},watchApi:{api:"SYNO.Core.QuickConnect",method:"status",version:1},watchStatus:function(){!0===this.field_enabled.originalValue&&(this.quick_connect_status="",this.alias_status="",this.status_changed=!0,SYNO.SDS.SocketInst.register(this.watchApi,this.OnMessage.createDelegate(this),!0))},OnMessage:function(e){this.statusCheck(e.success,e.data)},stopWatchingStatus:function(){SYNO.SDS.SocketInst.unregister(this.watchApi,this.OnMessage)},statusCheck:function(e,t){var i={disconnect:_T("relayservice","relayservice_disconnected"),direct_connect:_T("relayservice","relayservice_direct_connect"),login:_T("relayservice","relayservice_login"),starting:_T("relayservice","relayservice_starting"),not_running:_T("relayservice","relayservice_disconnected"),logout:_T("relayservice","relayservice_stop"),stoped:_T("relayservice","relayservice_disconnected"),connected:_T("relayservice","relayservice_connected"),unknown:_T("relayservice","relayservice_err_unknown"),no_service:_T("relayservice","no_service_enabled"),network_abnormal:_T("relayservice","relayservice_err_resolv")};if(this.old_alias_status=this.alias_status,this.old_quick_connect_status=this.quick_connect_status,e&&this.status_error&&(this.parent_panel.clearStatus(),this.status_error=!1),this.alias_status=e?t.alias_status:"unknown",this.quick_connect_status=e?t.status:"unknown",this.status_changed=this.old_alias_status!==this.alias_status||this.old_quick_connect_status!==this.quick_connect_status,this.status_changed){var s=!(this.dsm_permission||this.cloud_permission||this.mobile_apps_permission||this.file_sharing_permission),n=!e&&(2902===t.code||2907===t.code),o=2910===t.code,a="unknown";n?a="network_abnormal":o?a="stoped":s?a="no_service":e&&(a=t.status),this.setInfoItems();var r=i[a];this.violated||this.realname_validation_required||(this.field_status.removeClass(this.error_msg_cls),this.field_status.setValue(r))}},isDirty:function(){var e=this.parentPanel;return!(!e.isActivated||!e.abnormalStatus())||e.isFieldDirty()},isFieldDirty:function(){for(var e=[this.field_enabled,this.field_server_alias],t=0;t<e.length;++t)if(e[t].isDirty())return!0;return!1},abnormalStatus:function(){return!0===this.field_enabled.getValue()&&("success"!==this.alias_status||"connected"!==this.quick_connect_status&&"login"!==this.quick_connect_status&&"starting"!==this.quick_connect_status)},afterRegisterMyDSAccount:function(e){this.setMyDsAccount(Ext.util.Format.htmlEncode(e.account)),this.field_enabled.setValue(!0),this.sendWebAPI({api:"SYNO.Core.QuickConnect",method:"check_availability",version:3,callback:function(e,t){this.clearStatusBusy(),e&&(this.realname_validation_required=2911===t.code,this.country=t.country,this.setAvailability(t.available))},scope:this})},loginMyDsAccount:async function(){this.SAWebLogin||(this.SAWebLogin=await SYNO.SDS.SynologyAccount.WebLogin.create()),this.SAWebLogin&&this.SAWebLogin.loginUrl&&(this.SAWebLogin.popLoginWeb(),this.SAWebLogin.on("resolve",function(e){this.parent_panel.clearStatusBusy(),this.afterRegisterMyDSAccount.call(this,e)}.bind(this)),this.SAWebLogin.on("reject",function(e){SYNO.Debug("Login Failed",e),this.parent_panel.clearStatusBusy()}.bind(this)),this.SAWebLogin.on("processing",function(){this.parent_panel.setStatusBusy({text:_T("login","waiting")})}.bind(this)))},checkServicesFirewall:function(){var e=[];(this.dsm_permission||this.mobile_apps_permission||this.file_sharing_permission)&&e.push({name:"SYNO.SDS.AdminCenter.Network.DSM",isPkg:!1}),this.cloud_permission&&e.push({name:"CloudStation",isPkg:!0},{name:"SynologyDrive",isPkg:!0}),void 0!==e&&e.length>0&&SYNO.SDS.StatusNotifier.checkServiceBlocked(e)},waitCertificateReady:function(e){return new Promise(function(t,i){this.checkCertificateId=this.pollReg({webapi:{api:"SYNO.Core.Certificate.CRT",version:1,method:"list"},interval:5,immediate:!0,scope:this,status_callback:function(e,i,s,n){if(e||i.code)return this.isCertificateReady(i)?(this.pollUnreg(this.checkCertificateId),void t()):void 0}}),setTimeout(function(){this.pollUnreg(this.checkCertificateId),i()}.bind(this),1e3*e)}.bind(this))},isCertificateReady:function(e){var t=this.field_server_alias.getValue()+"."+this.quickconnect_ddns_domain,i=!1;return e.certificates.forEach((function(e){var s=e.subject,n=e.services;s.common_name.toLowerCase()===t.toLowerCase()&&n.forEach((function(e){"system"===e.subscriber&&"quickconnect"===e.service&&(i=!0)}))})),i},redirectPage:function(e){window.location.assign(e)}}),Ext.define("SYNO.SDS.AdminCenter.QuickConnect.InfoTemplate",{extend:"Ext.XTemplate",constructor:function(e){this.parentPanel=e.parentPanel,this.callParent([this.template])},getData:function(e){var t=this.parentPanel,i="connected"===t.quick_connect_status,s=""!==t.server_alias?t.server_alias:t.server_id,n=SYNO.SDS.QuickConnect.Utils.aliasToPortalUrl(s,t.domain),o=void 0===s||-1!==s.indexOf("_")||s.length>63,a=""!==t.server_alias&&""!==t.mydsAccount,r=t.dsm_permission,l=!(t.dsm_permission||t.cloud_permission||t.mobile_apps_permission),d='style="display:none"';return{alias:s,dsm_url:n,description:a?_T("relayservice","welcome_message"):_T("relayservice","welcome_no_alias"),hidden:t.enabled&&i&&!l?"":d,url_hidden:a&&!o&&r?"":d,alias_note_hidden:o?"":d,mobile_hidden:t.mobile_apps_permission||t.cloud_permission?"":d,dsm_hidden:r?"":d,tabindex:e?0:-1}},template:'<div class="syno_quickconnect_container" {hidden}><div class="line-padding normal-font" tabindex="{tabindex}" aria-label="{description}">{description}</div><div {url_hidden}><div class="line-padding description normal-font" tabindex="{tabindex}" aria-label="'+_T("relayservice","browser_description")+'">'+_T("relayservice","browser_description")+'</div><div class="line-padding content selectabletext" {dsm_hidden}><span class="title normal-font">DSM'+_T("common","colon")+'</span><span class="info allowDefCtxMenu"><a class="link-font" target="_blank" href="{dsm_url}" tabindex="{tabindex}" aria-label="DSM'+_T("common","colon")+' {dsm_url}">{dsm_url}</a></span></div></div><div class="line-padding description normal-font" {mobile_hidden}><span tabindex="{tabindex}" aria-label="'+_T("relayservice","syno_mobile_apps")+'">'+_T("relayservice","syno_mobile_apps")+'</span></div><div class="line-padding content selectabletext" {mobile_hidden}><span class="title normal-font">QuickConnect ID'+_T("common","colon")+'</span><span class="info allowDefCtxMenu" tabindex="{tabindex}" aria-label="{alias}">{alias}</span></div><div class="line-padding content syno-ux-displayfield x-form-display-field" {alias_note_hidden} tabindex="{tabindex}" aria-label="'+_T("common","note")+_T("common","colon")+" "+_T("relayservice","alias_new_restriction")+'"><span class="syno-ux-note note-font">'+_T("common","note")+_T("common","colon")+' </span><span class="normal-font">'+_T("relayservice","alias_new_restriction")+"</span></div></div>"}),Ext.ns("SYNO.SDS.AdminCenter.PublicAccess"),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.app=e.app,this.observer=new SYNO.SDS.EventEmitter},getHelpParam:function(){return this.panel.getActiveTab().getHelpParam()},getPanel:function(){return this.panel||(this.panel=new SYNO.SDS.AdminCenter.PublicAccess.TabPanel({module:this,appWin:this.appWin,app:this.app,observer:this.observer})),this.panel},setActivateParams:function(e){e&&e.tab&&this.panel.setActiveTab(e.tab)},confirmCallback:function(e){"no"===e&&this.panel.activeTab===this.panel.DDNSForm&&this.panel.DDNSForm.pollingTaskStart()},activate:function(e){this.panel.clearStatus(),this.panel.DDNSForm.pollingTaskStart(),this.setActivateParams(e),this.observer.fireEvent("quickconnect-tab-reload"),this.panel.loadAllForm()},deactivate:function(){this.panel.DDNSForm.pollingTaskStop();const e=this.panel.quickconnectTab._$vueInst;return(!e||!e.isDirty())&&(!this.panel.advancedForm.getForm().isDirty()&&(!this.panel.portforwardingTab.isDirty()&&(this.panel.portforwardingTab.resetMainPage(),this.panel.quickconnectTab.SAWebLogin&&this.panel.quickconnectTab.SAWebLogin.cancel(),!0)))},confirmLostCancel:function(){return new Promise(function(e,t){this.panel.quickconnectTab.startPolling(),e()}.bind(this))},confirmLostChangeSave:function(){return new Promise(function(e,t){this.panel.applyAllForm({applyHandlerCallback:e,applyHandlerReject:t,blDoSaveSuccessCallback:!1})}.bind(this))},confirmLostChangeDontSave:function(){return new Promise(function(e,t){this.panel.DDNSForm.pollingTaskStop(),this.panel.portforwardingTab.resetMainPage(),e()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.PublicAccess.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){var t;this.module=e.module,this.appWin=e.appWin;var i=[];const s=e.observer;this.quickconnectTab=new SYNO.SDS.VuePanel({vueClass:SYNO.SDS.AdminCenter.QuickConnect.AdminTab,title:_T("relayservice","relayservice_title"),appWindow:this.module.appWin,owner:this,module:this,getHelpParam:()=>"AdminCenter/connection_quickconnect.html"},{observer:s}),i.push(this.quickconnectTab),i.push(this.DDNSForm=new SYNO.SDS.AdminCenter.PublicAccess.DDNSTab({module:this.module,itemId:"ddnstab",observer:s})),SYNO.SDS.Utils.isInC2DSM()||SYNO.SDS.Utils.isInAliDSM()||i.push(this.portforwardingTab=new SYNO.SDS.AdminCenter.PublicAccess.PortForwarding.RuleGrid({module:this.module,itemId:"portforwardingtab",originalFormPanel:this})),i.push(this.advancedForm=new SYNO.SDS.AdminCenter.PublicAccess.AdvancedForm({module:this.module,itemId:"advancetab"})),t=Ext.apply({activeTab:0,items:i},e),s.on("quickconnect-applied",this.checkAndNotify.bind(this)),this.callParent([t])},getCompoundCfg:function(e){return"set"===e?{stopwhenerror:!0}:{}},onApiSuccess:function(e,t,i){if("set"===e)if(t.has_fail){var s=SYNO.API.getErrorString(t);this.setStatusError({text:s,clear:!0}),this.applyAllFormOptions&&Ext.isFunction(this.applyAllFormOptions.applyHandlerReject)&&this.applyAllFormOptions.applyHandlerReject()}else this.hasQuickConnectSetRequest(i)?this.pfNeedReload=!0:this.setStatusOK();this.processReturnData(e,t,i),this.checkAndNotify()},registerProcessReturnData:function(e){this.applyPages&&(this.applyPages[e]=!0)},deregisterProcessReturnData:function(e){this.applyPages&&(this.applyPages[e]=!1,this.checkAndNotify())},applyAllForm:function(e){this.applyAllFormOptions=e,this.applyPages={},this.callParent([e]);const t=this.quickconnectTab._$vueInst;t&&t.isDirty()&&t.onApply().then((()=>{this.quickconnectTab.confirmLostChangeResolve&&this.quickconnectTab.confirmLostChangeResolve()}))},onApiFailure:function(e,t,i){this.callParent([e,t,i]),this.applyPages={},this.checkAndNotify()},onBeforeTabChange:function(e,t,i){var s=!1;if(i===this.advancedForm?s=i.getForm().isDirty():i===this.quickconnectTab?s=i._$vueInst.isFieldDirty():i===this.portforwardingTab&&(s=i.isDirty()),!0===s&&t&&t!=i)return this.showTabChangeConfirm(t,i),!1;this.callParent([e,t,i])},resetAllForm:function(){this.callParent();const e=this.quickconnectTab._$vueInst;e&&e.isDirty()&&e.onReset()},showTabChangeConfirm:function(e,t){this.appWin.getMsgBox().confirmLostChangePromise({save:function(){return new Promise(function(e,i){t.confirmLostChangeResolve=e,t.confirmLostChangeReject=i,this.applyAllForm()}.bind(this))},dontSave:function(){return new Promise(function(e,t){this.resetAllForm(),e()}.bind(this))},cancel:Ext.emptyFn},this,Ext.emptyFn,(function(){this.setActiveTab(e)}))},checkAndNotify:function(){!0===this.checkIfAllApplyPollingDone()&&this.notifyAllApplyPollingDone()},checkIfAllApplyPollingDone:function(){if(this.applyPages){for(var e in this.applyPages)if(!0===this.applyPages[e])return!1;return!0}return!0},notifyAllApplyPollingDone:function(){this.applyAllFormOptions&&this.applyAllFormOptions.applyHandlerCallback&&this.applyAllFormOptions.applyHandlerCallback()},hasQuickConnectSetRequest:function(e){var t=!1;return e.compound.forEach((function(e){"SYNO.Core.QuickConnect"===e.api&&(t=!0)})),t}}),Ext.ns("SYNO.SDS.AdminCenter.Network.Utils"),SYNO.SDS.AdminCenter.Network.Utils.SortFunc=function(e,t){var i=0,s=/^([a-z]+)([0-9]*)(\.?)([0-9]*)$/,n=s.exec(e.ifname),o=s.exec(t.ifname);if(n instanceof Array&&o instanceof Array&&0===(i=n[1]>o[1]?1:n[1]<o[1]?-1:0)){var a=parseInt(n[2],10)||0,r=parseInt(o[2],10)||0;i=a>r?1:a<r?-1:0}return i},SYNO.SDS.AdminCenter.Network.Utils.WaitingBox=function(e){var t=e.times||10,i=t,s=!Ext.isDefined(e.no_close)||e.no_close,n=e.interval||1e3;SYNO.SDS.Desktop.getMsgBox().show({title:e.title||this.title,msg:e.msg||this.msg,width:e.width||240,progress:!0,closable:!1});var o=function(){if(SYNO.Debug("refresh"),0===--i&&!s)return Ext.isFunction(e.callback)&&e.callback.call(e.scope||this),void SYNO.SDS.Desktop.getMsgBox().hide();0===i&&(i=t),SYNO.SDS.Desktop.getMsgBox().updateProgress(1-i/t),o.defer(n,this)};o.defer(n,this)},SYNO.SDS.AdminCenter.Network.Utils.Redirect=function(e,t,i,s,n,o,a,r,l){var d=a||5e4,c=0;if(Ext.isBoolean(t)&&Ext.isArray(i)&&Ext.isString(s)&&Ext.isString(n)){e||(t="https:"===location.protocol,i=[location.hostname],s=location.port),null===o&&(o="SYNO.SDS.AdminCenter.Network.Main"),SYNO.SDS.UserSettings.setProperty("Desktop","restoreParams",Ext.apply({className:"SYNO.SDS.AdminCenter.Application",params:{fn:o}})),SYNO.SDS.StatusNotifier.fireEvent("redirect"),window.onbeforeunload=null;var h=function(e){var o=null;if(l)o="http://QuickConnect.to/"+l;else{var a="http"+(!0===t?"s":"");o=String.format("{0}://{1}:{2}/index.cgi?auth_key={3}",a,i[e%i.length],s,n)}SYNO.Debug("try "+o),window.location=o};for(h.defer(d,this,[0]),c=0;c<3;c++)h.defer(d+=1e4,this,[0]);for(c=1;c<=i.length;c++)h.defer(d+=1e4,this,[c]);var u=_T("tcpip","connect_new_ip");Ext.isEmpty(r)||(u=u+'<br><font class="red-status">'+String.format(_T("network","bond_ip_conflict"),SYNO.SDS.Utils.Network.idToString(r))+"</font>"),SYNO.SDS.AdminCenter.Network.Utils.WaitingBox.apply(this,[{times:d/1e3,msg:u}])}else SYNO.Debug("bad parameters")},SYNO.SDS.AdminCenter.Network.Utils.IsInt=function(e){return"number"==typeof e&&e%1==0},SYNO.SDS.AdminCenter.Network.Utils.GetLinkStatus=function(e,t,i,s){var n="--";if(!SYNO.SDS.AdminCenter.Network.Utils.IsInt(e)||"boolean"!=typeof t||!SYNO.SDS.AdminCenter.Network.Utils.IsInt(i)||-1==e)return n;var o=String.format(_T("tcpip","if_speed"),e),a=String.format(_T("tcpip","MTU_value"),i),r=t?_T("tcpip","full_duplex"):_T("tcpip","half_duplex");return r=!0===t?_T("tcpip","full_duplex"):_T("tcpip","half_duplex"),n=String.format("{0}, {1}, {2}",o,r,a),!0===s&&(n+=String.format(', <font class="red-status">{0}</font>',_T("network","linkaggr_8023ad_error"))),n},SYNO.SDS.AdminCenter.Network.Utils.apiMap={"SYNO.Core.Network":"network","SYNO.Core.Network.Proxy":"proxy","SYNO.Core.Network.Ethernet":"ethernet","SYNO.Core.Network.PPPoE":"pppoe","SYNO.Core.Network.Bond":"bond","SYNO.Core.Network.PPPoE.Relay":"pppoe_relay","SYNO.Core.Network.IPv6":"ipv6","SYNO.Core.Network.IPv6.Router":"ipv6_router","SYNO.Core.Network.IPv6.Router.Prefix":"ipv6_router_prefix","SYNO.Core.Network.UPnPServer":"upnpserver","SYNO.GlusterfsMgmt.Service":"gluster_service","SYNO.Core.Hardware.OOBManagement":"oobmgmt","SYNO.Core.Network.Authentication":"auth"},SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix=function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.apiMap;return t.hasOwnProperty(e)?t[e]+"_":""},SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_RULE=100,SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_PORTS_IN_A_RULE=15,SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH=200,SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_LABEL_WIDTH=200,SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_RATE=125e4,SYNO.SDS.AdminCenter.Network.Utils.TcErrCode={},Ext.apply(SYNO.SDS.AdminCenter.Network.Utils.TcErrCode,{WEBAPI_ERR_NO_REQUIRED_PARAM:114,WEBAPI_CORE_ERR_TC_NOERR:1200,WEBAPI_CORE_ERR_TC_OP_FAIL:1201,WEBAPI_CORE_ERR_TC_CEIL_EXCEED_SYSTEM_UPPER_BOUND:1202,WEBAPI_CORE_ERR_TC_MAX_CEIL_TOO_LARGE:1203,WEBAPI_CORE_ERR_TC_RESTORE_FAIL:1204,WEBAPI_CORE_ERR_TC_MAX:1299,WEBAPI_CORE_ERR_NET_NO_SUCH_INTERFACE:4311}),SYNO.SDS.AdminCenter.Network.Utils.TcRULERecord=Ext.data.Record.create({name:"id"},{name:"enabled"},{name:"port_type"},{name:"port_num"},{name:"port_direction"},{name:"protocol"},{name:"minrate"},{name:"maxrate"}),SYNO.SDS.AdminCenter.Network.Utils.Render_Min_Rate=function(e,t){return t.attr='ext:qtip="'+e+'"',e},SYNO.SDS.AdminCenter.Network.Utils.Render_Max_Rate=function(e,t){var i="";return i=0===e?_T("firewall","firewall_tc_unlimited"):e,t.attr='ext:qtip="'+i+'"',i},SYNO.SDS.AdminCenter.Network.Utils.onClickDirectoryServiceUrl=function(e){e.app.startModule("SYNO.SDS.AdminCenter.DirectoryService.Main")},SYNO.SDS.AdminCenter.Network.Utils.GetDSInfo=function(){var e={platform:"",model:""},t=_D("unique");if(!t)return e;var i=/^synology_([A-Z|a-z|0-9]*)_([a-z|0-9|+]*)$/.exec(t);return 3>i.length||(e.platform=i[1],e.model=i[2]),e},SYNO.SDS.AdminCenter.Network.Utils.Strncmp=function(e,t,i){return(e=e.substring(0,i))===(t=t.substring(0,i))?0:e>t?1:-1},SYNO.SDS.AdminCenter.Network.Utils.toYesNo=function(e){return!0===e?_T("common","yes"):_T("common","no")},SYNO.SDS.AdminCenter.Network.Utils.toEmptyDash=function(e){return e&&""!==e?e:"--"},SYNO.SDS.AdminCenter.Network.Utils.toMultiLine=function(e){var t="";return e&&0!==e.length?(Ext.each(e,(function(e){t+=e+"<br>"}),this),t):"--"},SYNO.SDS.AdminCenter.Network.Utils.getLinkStatus=function(e,t){return this.toEmptyDash(SYNO.SDS.AdminCenter.Network.Utils.GetLinkStatus(t.speed,t.duplex,t.mtu,t.error),t)},SYNO.SDS.AdminCenter.Network.Utils.getTitle=function(e,t,i){if("vpnc"==t.type)return"VPN - "+t.confname;var s=t.id?t.id:t.ifname;return SYNO.SDS.Utils.Network.idToString.apply(i,[s,t.type])},SYNO.SDS.AdminCenter.Network.Utils.statusMap={connected:_T("network","status_connected"),disconnected:_T("network","status_disconnected"),connection_failed:_T("download","download_err_network"),connection_lost:_T("download","download_err_network"),preconnecting:_T("pppoe","pppoe_connecting"),disconnecting:_T("bluetooth","state_disconnecting"),connecting:_T("pppoe","pppoe_connecting"),enabled:_T("common","enabled"),disabled:_T("common","disabled")},SYNO.SDS.AdminCenter.Network.Utils.getStatus=function(e){return String.format('<font class="{0}">{1}</font>',{connected:"blue-status",disconnected:"disable-font",connection_failed:"disable-font",connecting:"blue-status",enabled:"blue-status",disabled:"disable-font"}[e],SYNO.SDS.AdminCenter.Network.Utils.statusMap[e])},SYNO.SDS.AdminCenter.Network.Utils.getStatusStr=function(e){return SYNO.SDS.AdminCenter.Network.Utils.statusMap[e]},SYNO.SDS.AdminCenter.Network.Utils.LinuxBondModeMap={"802.3ad":_T("network","linkaggr_mode_8023ad"),"balance-alb":_T("network","linkaggr_mode_alb"),"balance-xor":_T("network","linkaggr_mode_xor"),"active-backup":_T("network","linkaggr_mode_failover")},SYNO.SDS.AdminCenter.Network.Utils.OvsBondModeMap={"balance-slb":_T("ovs","ovs_linkaggr_mode_slb"),"balance-tcp":_T("ovs","ovs_linkaggr_mode_tcp"),"ovs-active-backup":_T("ovs","ovs_linkaggr_mode_failover")},SYNO.SDS.AdminCenter.Network.Utils.GetBondModeStr=function(e,t){return e?SYNO.SDS.AdminCenter.Network.Utils.OvsBondModeMap[t]:SYNO.SDS.AdminCenter.Network.Utils.LinuxBondModeMap[t]},SYNO.SDS.AdminCenter.Network.Utils.ConvertToReadableIPv6=function(e){return e=(e=e.replace(new RegExp("[0-9a-fA-F]","g"),(function(e){return" "+e+" "}))).replace(new RegExp("\\:","g")," "+_T("common","colon_str")+" ")},Ext.define("SYNO.SDS.AdminCenter.Network.GeneralTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.showOldUI=_S("version")<4966,this.callParent([this.fillConfig(e)]),this.on("afterlayout",(function(e,t){this.checkGroupDNS=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"dns_manual",["dns_primary","dns_secondary"]),this.checkGroupProxy=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable",[]),this.checkGroupProxyDiff=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_different_host",["https_host","https_port"]),this.checkGroupProxyAuth=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_auth",["username","password"]),_S("manage_hostname_in_ha_pkg")&&SYNO.ux.AddTip(this.getForm().findField("server_name").getEl(),_TT("SYNO.SDS.HA.Instance","ui","setting_on_ha_mgr"))}),this,{single:!0}),this.customizeForm()},fillConfig:function(e){return Ext.apply({title:_T("common","general"),hideMode:"offsets",module:e.module,trackResetOnLoad:!0,proxy_keys:["enable","http_host","http_port","enable_different_host","https_host","https_port","enable_auth","username","password","enable_bypass"],items:[this.createCommonSetting(),this.createProxySetting()]},e)},isDirty:function(){return this.getForm().isDirty()},customizeForm:function(){var e=this.getForm();e.isDirtyDefault=e.isDirty,e.isDirty=function(){var e=this.isDirtyDefault(),t=this.findField("enable_different_host"),i=this.findField("http_host"),s=this.findField("http_port");return!0===t.getValue()&&(i.enable(),s.enable(),e=e||i.isDirty()||s.isDirty(),i.disable(),s.disable()),e},e.isValidDefault=e.isValid,e.isValid=function(){var e=this.findField("http_host"),t=this.findField("enable_different_host");return!!this.isValidDefault()&&(!0===t.getValue()||e.isValid())}},createCommonSetting:function(){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.Network.Main::general::general",labelWidth:232,title:_T("common","general"),cls:"syno-network-general-fieldset",collapsible:!0,webapi:{api:"SYNO.Core.Network",methods:{get:"get",set:"IGNORE"},version:2},items:[{xtype:"syno_displayfield",value:_T("tcpip","name_dns_gateway_desc"),ctCls:"syno-network-general-single-element"},{xtype:"syno_textfield",fieldLabel:_S("manage_hostname_in_ha_pkg")?_TT("SYNO.SDS.HA.Instance","ui","virtual_server"):_T("tcpip","server_name"),disabled:!0===_S("manage_hostname_in_ha_pkg"),name:"server_name",vtype:"netbiosName",allowBlank:!1,maxlength:15,hidden:"yes"===_D("dockerdsm")},{xtype:"syno_displayfield",fieldLabel:_T("tcpip","server_name"),name:"server_name",hidden:"yes"!==_D("dockerdsm")},{xtype:"syno_compositefield",hidden:this.showOldUI,disabled:this.showOldUI,items:[{xtype:"syno_displayfield",fieldLabel:_T("tcpip","tcpip_gateway"),width:200,name:"gateway"},{xtype:"syno_button",text:_T("common","alt_edit"),id:this.btnServiceOrder=Ext.id(),scope:this,handler:this.onServiceOrder}]},{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_gateway"),hidden:!this.showOldUI,disabled:!this.showOldUI,name:"gateway",vtype:"v4ip",maxlength:15,validator:function(e){var t=SYNO.SDS.Utils.Network.GatewayMatchIP,i=!1,s=null;return!(this.ownerCt&&this.ownerCt.ownerCt&&this.ownerCt.ownerCt.module)||(s=this.ownerCt.ownerCt.module.getStore(),""===e||0===s.getCount()||(s.each((function(s){var n=s.get("ip"),o=s.get("mask");if(n&&o&&t(e,n,o))return i=!0,!1}),this),!!i||_T("common","error_notmatch")))}},{xtype:"syno_displayfield",fieldLabel:_T("tcpip","tcpip_v6gateway"),hidden:this.showOldUI,name:"v6gateway"},{xtype:"syno_checkbox",boxLabel:_T("network","enable_static_dns"),name:"dns_manual",ctCls:"syno-network-general-single-element"},{xtype:"syno_textfield",fieldLabel:_T("tcpip","primary_dns"),name:"dns_primary",allowBlank:!1,maxlength:"yes"===_D("ipv4only")?15:39,indent:1,vtype:"yes"===_D("ipv4only")?"v4ip":"ip"},{xtype:"syno_textfield",fieldLabel:_T("tcpip","secondary_dns"),name:"dns_secondary",allowBlank:!0,maxlength:"yes"===_D("ipv4only")?15:39,indent:1,vtype:"yes"===_D("ipv4only")?"v4ip":"ip"},{xtype:"syno_displayfield",value:String.format('<span class="note-font">'+_T("common","note")+"</span>: "+_T("network","goto_directory_service_for_dns_desc"),'<a id="'+(this.redirectDomainServiceLinkId=Ext.id())+'">'+_T("directory_service","directory_service_title")+"</a>"),name:"dns_domain_warning",htmlEncode:!1,indent:1,hidden:!0,ctCls:"syno-network-general-single-element"},{xtype:"syno_checkbox",boxLabel:"enable_windomain",name:"enable_windomain",hidden:!0,readOnly:!0,disabled:!0,ctCls:"syno-network-general-single-element"},{xtype:"syno_checkbox",boxLabel:_T("network","arp_ignore"),hidden:!this.showOldUI,name:"arp_ignore",ctCls:"syno-network-general-single-element"},{xtype:"syno_checkbox",boxLabel:_T("network","route_multi_gateway_enable"),hidden:!0,name:"multi_gateway",ctCls:"syno-network-general-single-element"},{xtype:"syno_checkbox",boxLabel:_T("network","ipv4_first"),hidden:!0,name:"ipv4_first",ctCls:"syno-network-general-single-element"},{xtype:"syno_checkbox",boxLabel:_T("network","enable_ip_conflict_detect"),hidden:!0,name:"enable_ip_conflict_detect",ctCls:"syno-network-general-single-element"},{xtype:"syno_checkbox",boxLabel:_T("network","use_dhcp_domain"),hidden:!0,name:"use_dhcp_domain",ctCls:"syno-network-general-single-element"},{xtype:"syno_button",text:_T("common","adv_setting"),indent:1,hidden:this.showOldUI,scope:this,handler:this.onClickAdvanceSettingsBtn,ctCls:"syno-network-general-single-element"}]}},createProxySetting:function(){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.Network.Main::general::proxy",title:_T("network","proxy_title"),collapsible:!0,webapi:{api:"SYNO.Core.Network.Proxy",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_checkbox",boxLabel:_T("network","proxy_enabled"),name:"enable"},{xtype:"syno_textfield",fieldLabel:_T("network","network_address"),name:"http_host",disabled:!0,allowBlank:!1,maxlength:128,indent:1,vtype:"iporhostname"},{xtype:"syno_textfield",fieldLabel:_T("common","port"),name:"http_port",allowBlank:!0,maxlength:5,indent:1,vtype:"port"},{xtype:"syno_checkbox",name:"enable_different_host",boxLabel:_T("network","proxy_enabled_adv"),hidden:!0},{xtype:"syno_textfield",fieldLabel:_T("network","network_address"),name:"https_host",maxlength:128,indent:1,vtype:"iporhostname",hidden:!0},{xtype:"syno_textfield",fieldLabel:_T("common","port"),name:"https_port",allowBlank:!0,maxlength:5,indent:1,vtype:"port",hidden:!0},{xtype:"syno_checkbox",name:"enable_auth",boxLabel:_T("network","proxy_enabled_auth"),hidden:!0},{indent:1,xtype:"syno_textfield",fieldLabel:_T("common","username"),allowBlank:!1,maxlength:64,name:"username",hidden:!0},{indent:1,xtype:"syno_textfield",fieldLabel:_T("common","password"),maxlength:127,textType:"password",name:"password",hidden:!0},{xtype:"syno_button",text:_T("common","adv_setting"),indent:1,scope:this,handler:this.onClickProxyAdvBtn,id:this.advBtnId=Ext.id()},{xtype:"syno_checkbox",name:"enable_bypass",indent:1,boxLabel:_T("network","proxy_enabled_bypass_local")}]}},onClickProxyAdvBtn:function(){new SYNO.SDS.AdminCenter.Network.ProxyDialog({owner:this.module.appWin,module:this.module,generalSetting:this}).open()},onClickAdvanceSettingsBtn:function(){new SYNO.SDS.AdminCenter.Network.AdvanceSettings({owner:this.module.appWin,module:this.module,generalSetting:this}).open()},isGatewayDirty:function(){return this.getForm().findField("gateway").isDirty()},isGatewayEmpty:function(){return""===this.getForm().findField("gateway").getValue()},isServerNameDirty:function(){return this.getForm().findField("server_name").isDirty()},processParams:function(e,t){this.isReloadPromptNeeded=this.isServerNameDirty();var i=this.getForm(),s=i.findField("enable").getValue(),n=i.findField("password").isDirty(),o=i.findField("enable_different_host").getValue();return Ext.each(t,(function(e,t,a){var r=a[t].params;if("get"!==e.method&&"SYNO.Core.Network.Proxy"===e.api)s&&(o?(r.http_host=i.findField("http_host").getValue(),r.http_port=i.findField("http_port").getValue()):(r.http_host=i.findField("http_host").getValue(),r.http_port=i.findField("http_port").getValue(),r.https_host=i.findField("http_host").getValue(),r.https_port=i.findField("http_port").getValue())),n||delete r.password}),this),t.filter((e=>"IGNORE"!==e.method))},processReturnData:function(e,t,i){var s,n=!1,o="",a=0,r=0,l="",d=0;"set"===e&&this.isReloadPromptNeeded&&(this.isReloadPromptNeeded=!1,this.module.appWin.getMsgBox().confirm("",_T("network","hostname_change_confirm"),null,{useHtml:!0}).then((e=>{"confirm"===e&&window.location.reload()}),this));var c=Ext.get(this.redirectDomainServiceLinkId);c&&(this.mun(c,"click",this.onRedirectDomainServiceClick,this),this.mon(c,"click",this.onRedirectDomainServiceClick,this)),Ext.each(t.result,(function(e,t,i){if("set"===e.method&&(n=!0),!1!==e.success)switch(e.api){case"SYNO.Core.Network":"set"===e.method&&e.data.hostname_changed_and_join_domain&&this.module.appWin.getMsgBox().alert(_T("common","general"),_T("tcpip","rejoin_domain_msg")),"get"===e.method&&(this.showOldUI||0!==e.data.v6gateway.length||(e.data.v6gateway="--"));break;case"SYNO.Core.Network.Router.Gateway.List":if("get"===e.method&&0!==e.data.configs.length){var s="";o=e.data.configs[0].gateway,s="vpn-client"===e.data.configs[0].class?"VPN":SYNO.SDS.Utils.Network.idToString(e.data.configs[0].ifname),o=o+" ("+s+")"}}else 4319===(a=e.error.code)&&(r=t)}),this);var h=-1;if(Ext.each(t.result,(function(e,t){"SYNO.Core.Network"===e.api&&"get"===e.method&&e.success&&(h=t)}),this),-1!==h&&""!==o&&(t.result[h].data.gateway=o),this.isFormDirty()&&!1===n)this.showOldUI?this.getForm().findField("gateway").disabled&&this.getForm().setValues({gateway:o}):this.getForm().setValues({gateway:o});else if(this.callParent([e,t,i]),this.updateForm(),this.showOldUI&&this.clearGatewayInvalid(),4319===a){if("hostname_change"===(s=t.result[r].error.errors).type){for(l="",d=0;d<s.hard.length;++d)l+=String.format("<li>{0}</li>",SYNO.SDS.Utils.GetFeasibilityCheckMsg(s.hard[d]));l=String.format('<ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;">{0}</ul>',l),this.module.appWin.getMsgBox().alert(_T("controlpanel","leaf_lan"),String.format(_T("network","hostname_feasibility_check_fail"),l))}}else 0!==a&&this.module.appWin.getMsgBox().alert(_T("controlpanel","leaf_lan"),SYNO.API.getErrorString(a))},onRedirectDomainServiceClick:function(){SYNO.SDS.AdminCenter.Network.Utils.onClickDirectoryServiceUrl(this.module)},clearGatewayInvalid:function(){this.getForm().findField("gateway").clearInvalid()},updateForm:function(){var e=this.getForm();!0===e.findField("enable_windomain").getValue()?(e.findField("dns_manual").disable(),e.findField("dns_secondary").hide(),e.findField("dns_domain_warning").show()):(e.findField("dns_manual").enable(),e.findField("dns_secondary").show(),e.findField("dns_domain_warning").hide()),this.setCheckGroupProxy()},getProxyValues:function(){var e={},t=this.getForm();return Ext.each(this.proxy_keys,(function(i){var s=t.findField(i);s&&(e[i]=s.getValue())})),e},setProxyValues:function(e){var t=this.getForm();Ext.each(this.proxy_keys,(function(i){var s=t.findField(i),n=e[i];s&&void 0!==n&&s.setValue(n)}))},setCheckGroupProxy:function(){var e=this.getForm(),t=["enable_bypass",this.advBtnId],i=!e.findField("enable").getValue();!0===e.findField("enable_different_host").getValue()?(e.findField("http_host").disable(),e.findField("http_port").disable()):(e.findField("http_host").setDisabled(i),e.findField("http_port").setDisabled(i),t.push("http_host"),t.push("http_port")),e.findField("enable_bypass").setDisabled(i),Ext.getCmp(this.advBtnId).setDisabled(i),this.checkGroupProxy.enable_fields=t},afterLoad:function(){var e=!1,t=!0;this.module.getStore().each((function(i){switch(i.get("type")){case"wan":case"lan":case"ovseth":case"ovsbond":case"bond":!0!==i.get("use_dhcp")&&(t=!1);break;case"pppoe":case"vpnc":"connected"!==i.get("status")&&"connecting"!==i.get("status")||(e=!0);break;default:SYNO.Debug("unknowntype:"+i.get("type"))}}),this),this.module.getWifiStore().each((function(e){!0!==e.get("use_dhcp")&&(t=!1)}),this);var i=this.getForm().findField("gateway");i&&((e||t)&&i.reset(),i.setDisabled(e||t))},loadFormNoMask:function(e){var t,i="get";if(!1===this.onBeforeAction(this.getForm(),i))return!1;(t=this.getApiArray(i)).push({api:"SYNO.Core.Network.Router.Gateway.List",method:"get",version:1,params:{iptype:"ipv4",type:"wan"}}),t=this.processParams(i,t),this.sendAjaxRequestNoMask(i,t)},sendAjaxRequestNoMask:function(e,t){var i=this.getAjaxCfg(e),s=this.getCompoundCfg(e),n=Ext.apply({fileUpload:!1,clientValidation:!1,compound:{stopwhenerror:!1,params:t},scope:this,callback:function(t,i,s){t?this.onApiSuccess(e,i,s):this.onApiFailure(e,i,s)}},i);n.compound=Ext.apply(n.compound,s),this.getForm().submit(n)},onServiceOrder:function(e,t){new SYNO.SDS.AdminCenter.Network.ServiceOrderDialog({module:this.module,owner:this.module.appWin}).open()}}),Ext.define("SYNO.SDS.AdminCenter.Network.ProxyDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner;var t=this.fillConfig(e),i=e.generalSetting.getProxyValues();this.callParent([t]),this.getComponent("adv_form").getForm().setValues(i),this.checkGroupHost=new SYNO.ux.Utils.EnableCheckGroup(this.getComponent("adv_form").getForm(),"enable_different_host",["http_display","http_host","http_port","https_display","https_host","https_port"]),this.checkGroupAuth=new SYNO.ux.Utils.EnableCheckGroup(this.getComponent("adv_form").getForm(),"enable_auth",["username","password"])},fillConfig:function(e){return Ext.apply({title:_T("network","proxy_title_advanced"),width:480,height:460,padding:"16px 20px 0 20px",resizable:!1,buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","alt_apply"),btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.createAdvSetting()]},e)},onApply:function(){var e=this.getComponent("adv_form").getForm(),t=e.findField("http_host"),i=e.findField("https_host"),s=e.findField("enable_different_host").getValue(),n=""===t.getValue(),o=""===i.getValue();return e.isValid()?s&&n&&o?(this.setStatusError({text:_T("network","proxy_warning_host_blank"),clear:!0}),!1):(this.generalSetting.setProxyValues(e.getValues()),this.generalSetting.updateForm(),void this.close()):(this.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1)},onCancel:function(){this.close()},createAdvSetting:function(){return{xtype:"form",border:!1,itemId:"adv_form",labelWidth:200,items:[{xtype:"syno_checkbox",name:"enable_different_host",boxLabel:_T("network","proxy_enabled_adv")},{xtype:"syno_displayfield",name:"http_display",fieldLabel:_T("network","proxy_setting_http"),indent:1},{xtype:"syno_textfield",fieldLabel:_T("network","network_address"),name:"http_host",maxlength:128,indent:1,vtype:"iporhostname"},{xtype:"syno_textfield",fieldLabel:_T("common","port"),name:"http_port",allowBlank:!0,maxlength:5,indent:1,vtype:"port"},{xtype:"syno_displayfield",name:"https_display",fieldLabel:_T("network","proxy_setting_https"),labelWidth:130,indent:1},{xtype:"syno_textfield",fieldLabel:_T("network","network_address"),name:"https_host",maxlength:128,indent:1,vtype:"iporhostname"},{xtype:"syno_textfield",fieldLabel:_T("common","port"),name:"https_port",allowBlank:!0,maxlength:5,indent:1,vtype:"port"},{xtype:"syno_checkbox",name:"enable_auth",boxLabel:_T("network","proxy_enabled_auth")},{indent:1,xtype:"syno_textfield",fieldLabel:_T("common","username"),allowBlank:!1,maxlength:64,name:"username"},{indent:1,xtype:"syno_textfield",fieldLabel:_T("common","password"),maxlength:127,textType:"password",name:"password"}]}}}),Ext.define("SYNO.SDS.AdminCenter.Network.AdvanceSettings",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.generalSetting=e.generalSetting;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({title:_T("common","adv_setting"),width:400,height:350,padding:"16px 20px 0 20px",resizable:!1,buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","alt_apply"),btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.createAdvSetting()]},e)},createAdvSetting:function(){return{xtype:"syno_formpanel",border:!1,autoHeight:!0,itemId:"advancesetting_form",items:[{xtype:"syno_checkbox",boxLabel:_T("network","route_policy_route_enable"),name:"arp_ignore"},{xtype:"syno_checkbox",boxLabel:_T("network","route_multi_gateway_enable"),name:"multi_gateway"},{xtype:"syno_checkbox",boxLabel:_T("network","ipv4_first"),name:"ipv4_first"},{xtype:"syno_checkbox",boxLabel:_T("network","enable_ip_conflict_detection"),name:"enable_ip_conflict_detect"},{xtype:"syno_checkbox",boxLabel:_T("network","use_dhcp_domain"),name:"use_dhcp_domain"}]}},onActivate:function(){var e=this.getComponent("advancesetting_form").getForm(),t=this.generalSetting.getForm();e.findField("arp_ignore").setValue(t.findField("arp_ignore").getValue()),e.findField("multi_gateway").setValue(t.findField("multi_gateway").getValue()),e.findField("ipv4_first").setValue(t.findField("ipv4_first").getValue()),e.findField("enable_ip_conflict_detect").setValue(t.findField("enable_ip_conflict_detect").getValue()),e.findField("use_dhcp_domain").setValue(t.findField("use_dhcp_domain").getValue()),SYNO.SDS.AdminCenter.Network.AdvanceSettings.superclass.onActivate.call(this)},onApply:function(){var e=this.getComponent("advancesetting_form").getForm(),t=this.generalSetting.getForm();t.findField("arp_ignore").setValue(e.findField("arp_ignore").getValue()),t.findField("multi_gateway").setValue(e.findField("multi_gateway").getValue()),t.findField("ipv4_first").setValue(e.findField("ipv4_first").getValue()),t.findField("enable_ip_conflict_detect").setValue(e.findField("enable_ip_conflict_detect").getValue()),t.findField("use_dhcp_domain").setValue(e.findField("use_dhcp_domain").getValue()),this.close()},onCancel:function(){this.close()}}),SYNO.namespace("SYNO.SDS.AdminCenter.Utils"),SYNO.SDS.AdminCenter.Utils.WaitHttpdRestart=function(e){var t=new SYNO.SDS.TaskRunner,i=null;return function(){i&&(i.remove(),i=null),SYNO.SDS.Desktop.getMsgBox().show({closable:!1,msg:_T("service","restart_apache")}),(i=t.createWebAPITask({interval:5e3,autoJsonDecode:!0,api:"SYNO.Core.AppPortal.Config",method:"get",version:1,scope:this,callback:function(t){t&&(SYNO.SDS.Desktop.getMsgBox().hide(),i.remove(),i=null,SYNO.SDS.isFunction(e)&&e())}})).start(!1)}},Ext.define("SYNO.SDS.AdminCenter.Network.BondModeTab",{extend:"SYNO.ux.FormPanel",constructor:function(e){this.owner=e.owner,this.callParent([this.fillConfig(e)])},fillConfig:function(e){var t=Ext.apply({trackResetOnLoad:!0,description:_T("network","linkaggr_mode_select")},e);return"ovs"===e.bondType?t.items=this.getOVSBondingConfig():t.items=this.getLinuxBondingConfig(),t},getLinuxBondingConfig:function(){return[{xtype:"syno_radio",boxLabel:_T("network","linkaggr_mode_alb"),name:"mode",disabled:!1===_S("ha_allow_bond_manage")||_S("version")<5454,hidden:_S("version")<5454,inputValue:"balance-alb",itemId:"balance-alb",checked:!0},{xtype:"syno_displayfield",indent:1,disabled:!1===_S("ha_allow_bond_manage")||_S("version")<5454,hidden:_S("version")<5454,value:_T("network","linkaggr_tip_alb")},{xtype:"syno_radio",boxLabel:_T("network","linkaggr_mode_8023ad"),name:"mode",disabled:!1===_S("ha_allow_bond_manage"),inputValue:"802.3ad",itemId:"802.3ad"},{xtype:"syno_displayfield",indent:1,disabled:!1===_S("ha_allow_bond_manage"),value:_T("network","linkaggr_tip_8023ad")},{xtype:"syno_radio",boxLabel:_T("network","linkaggr_mode_xor"),name:"mode",disabled:!1===_S("ha_allow_bond_manage")||_S("version")<5454,hidden:_S("version")<5454,inputValue:"balance-xor",itemId:"balance-xor"},{xtype:"syno_displayfield",indent:1,disabled:!1===_S("ha_allow_bond_manage")||_S("version")<5454,hidden:_S("version")<5454,value:_T("network","linkaggr_tip_xor")},{xtype:"syno_radio",boxLabel:_T("network","linkaggr_mode_failover"),name:"mode",disabled:!1===_S("ha_allow_bond_manage"),inputValue:"active-backup",itemId:"active-backup"},{xtype:"syno_displayfield",indent:1,disabled:!1===_S("ha_allow_bond_manage"),value:_T("network","linkaggr_tip_failover")}]},getOVSBondingConfig:function(){return[{xtype:"syno_radio",boxLabel:_T("ovs","ovs_linkaggr_mode_slb"),name:"mode",disabled:!1===_S("ha_allow_bond_manage"),inputValue:"balance-slb",itemId:"balance-slb",checked:!0},{xtype:"syno_displayfield",indent:1,disabled:!1===_S("ha_allow_bond_manage"),value:_T("ovs","ovs_linkaggr_tip_slb")},{xtype:"syno_radio",boxLabel:_T("ovs","ovs_linkaggr_mode_tcp"),name:"mode",disabled:!1===_S("ha_allow_bond_manage"),inputValue:"balance-tcp",itemId:"balance-tcp"},{xtype:"syno_displayfield",indent:1,disabled:!1===_S("ha_allow_bond_manage"),value:_T("ovs","ovs_linkaggr_tip_tcp")},{xtype:"syno_radio",boxLabel:_T("ovs","ovs_linkaggr_mode_failover"),name:"mode",disabled:!1===_S("ha_allow_bond_manage"),inputValue:"ovs-active-backup",itemId:"ovs-active-backup"},{xtype:"syno_displayfield",indent:1,disabled:!1===_S("ha_allow_bond_manage"),value:_T("ovs","ovs_linkaggr_tip_failover")}]},initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){this.getComponent("802.3ad")&&SYNO.ux.AddTip(this.getComponent("802.3ad").getEl(),_T("network","linkaggr_tip_8023ad_switch"))}),this,{single:!0}),this.mon(this,"afterlayout",(function(){this.getComponent("balance-tcp")&&SYNO.ux.AddTip(this.getComponent("balance-tcp").getEl(),_T("network","linkaggr_tip_8023ad_switch"))}),this,{single:!0})},fillContent:function(e){this.getForm().setValues(this.getConfig(e))},isDirty:function(){return this.getForm().isDirty()},isValid:function(){return this.getForm().isValid()},getWebAPISetData:function(){return{api:"SYNO.Core.Network.Bond",version:1,method:"set",params:{configs:[{ifname:this.win.ifname,mode:this.getForm().findField("mode").getGroupValue()}]}}},getWebAPIGetData:function(){return[]},getWebAPIName:function(){return this.win.ifname.indexOf("bond")>-1?"SYNO.Core.Network.Bond":""},getConfig:function(e){return{mode:e[SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix(this.getWebAPIName())+"mode"]}}}),Ext.define("SYNO.SDS.AdminCenter.Network.IPv4Tab",{extend:"SYNO.ux.FormPanel",old_config:null,constructor:function(e){this.owner=e.owner,this.callParent([this.fillConfig(e)])},fillConfig:function(e){var t=this;return Ext.apply({module:e.module,trackResetOnLoad:!0,items:[{xtype:"syno_radio",boxLabel:_T("tcpip","tcpip_dhcp"),name:"use_dhcp",indent:0,id:this.useDhcpYesId=Ext.id(),inputValue:"yes",handler:function(e,i){t.onCheckDhcp(e,i,t)}},{xtype:"syno_radio",boxLabel:_T("tcpip","tcpip_manual"),name:"use_dhcp",indent:0,id:this.useDhcpNoId=Ext.id(),inputValue:"no",handler:function(e,i){t.onCheckDhcp(e,i,t)}},{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_ipaddr"),name:"ip",indent:1,allowBlank:!1,maxlength:15,vtype:"v4ip",width:350,validator:function(e){var t=e.split("."),i=this.ownerCt.getForm().findField("mask"),s=i.getValue().split(".");if(4!==t.length||4!==s.length||0!==i.getActiveError().length)return!0;var n=parseInt(t[0],10)<<24|parseInt(t[1],10)<<16|parseInt(t[2],10)<<8|parseInt(t[3],10);if(n==(n|~(parseInt(s[0],10)<<24|parseInt(s[1],10)<<16|parseInt(s[2],10)<<8|parseInt(s[3],10))))return _T("network","error_bad_broadcast_ip");if(_S("ha_running")){if(0<=_S("ha_heartbeat_ip_list").indexOf(e)){var o=_S("ha_heartbeat_ip_list").join(", ");return String.format(_T("network","ipv4_system_preserved"),o)}if("yes"===_D("support_xa")){var a=this.ownerCt.getForm().findField(this.ownerCt.useDhcpYesId).checked;if("yes"===this.ownerCt.old_config.use_dhcp&&!a&&this.ownerCt.old_config.ip===e)return _T("network","dhcp_to_static_warning")}}return!0}},{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_mask"),name:"mask",indent:1,allowBlank:!1,maxlength:15,vtype:"netmask",width:350,listeners:{valid:function(e){this.getForm().findField("ip").validate()},scope:this}},{xtype:"syno_textfield",fieldLabel:_T("network","route_gateway"),name:"gateway",indent:1,allowBlank:!0,vtype:"v4ip",width:350,maxlength:15,disabled:_S("version")<4966,hidden:_S("version")<4966,validator:function(e){var t=this.ownerCt.getForm().findField("ip").getValue(),i=this.ownerCt.getForm().findField("mask").getValue();return!(""!==e&&!SYNO.SDS.Utils.Network.GatewayMatchIP(e,t,i))||_T("common","error_notmatch")}},{xtype:"syno_textfield",fieldLabel:_T("network","route_dns"),name:"dns",allowBlank:!0,maxlength:15,indent:1,vtype:"v4ip",disabled:_S("version")<4966,hidden:_S("version")<4966,width:350},{xtype:"syno_checkbox",boxLabel:_T("network","usbmodem_set_as_default_gw"),name:"is_default_gateway",disabled:_S("version")<4966,hidden:_S("version")<4966,checked:!1},{xtype:"syno_checkbox",boxLabel:_T("tcpip","self_adjust_mtu"),name:"manual_adjust_mtu",hidden:"yes"!==_D("supportMTU")},{xtype:"syno_combobox",fieldLabel:_T("tcpip","mtu_value_label"),name:"mtu_config",indent:1,editable:!0,width:350,store:this.MtuStore=new Ext.data.JsonStore({fields:["mtu","display"]}),displayField:"display",valueField:"mtu",hidden:"yes"!==_D("supportMTU"),validator:function(e){return e==="1500 ("+_T("network","apple_default")+")"?(this.setDisabled(!0),this.ownerCt.getForm().findField("manual_adjust_mtu").setValue(!1),!0):-1===e.indexOf(".")&&(e=Number(e),!isNaN(Number(e))&&(!1===this.ownerCt.NetworkConnected?String.format(_T("tcpip","mtu_check_network_status")):!(this.ownerCt.MaxMTU<e||this.ownerCt.MinMTU>e)||String.format(_T("tcpip","mtu_range_error"),this.ownerCt.MinMTU,this.ownerCt.MaxMTU)))}},{xtype:"syno_checkbox",boxLabel:_T("network","enable_vlan"),name:"enable_vlan",hidden:"yes"===_D("dockerdsm")||e.win.ifname===_D("oob_interface")},{xtype:"syno_numberfield",indent:1,fieldLabel:"VLAN ID",name:"vlan_id",allowBlank:!1,maxlength:4,minValue:1,maxValue:4094,hidden:"yes"===_D("dockerdsm")||e.win.ifname===_D("oob_interface"),validator:function(e){return!(4094<e||1>e)}},{xtype:"syno_checkbox",boxLabel:_T("network","pppoe_relay_enabled"),name:"enable_pppoe_relay",hidden:!1},{xtype:"syno_combobox",fieldLabel:_T("network","interface"),name:"pppoe_relay_server_config",indent:1,allowBlank:!1,editable:!1,hidden:!SYNO.SDS.Utils.Network.isMultiLan.apply(this),store:this.PPPoERelayServerStore=new Ext.data.JsonStore({autoDestroy:!0,root:"devs",fields:["ifname","ifstring"]}),displayField:"ifstring",valueField:"ifname"},{xtype:"syno_checkbox",boxLabel:_T("network","upnp_service_enabled"),name:"enable_upnp",hidden:!1},{xtype:"syno_combobox",fieldLabel:_T("network","interface"),name:"upnp_server_config",indent:1,allowBlank:!1,editable:!1,hidden:!1,store:this.UPnPServerStore=new Ext.data.JsonStore({autoDestroy:!0,root:"devs",fields:["ifname","ifstring"]}),scope:this,displayField:"ifstring",valueField:"ifname"}]},e)},getMTUStore:function(){for(var e=[{mtu:1500,display:"1500 ("+_T("network","apple_default")+")"}],t=this.MinMTU;t<=1500;t+=100)e.push({mtu:t,display:t});for(t=2e3;t<=this.MaxMTU;t+=1e3)e.push({mtu:t,display:t});return e},initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("enable_vlan").getEl(),_T("network","vlan_notify")),SYNO.ux.AddTip(this.getForm().findField("gateway").getEl(),_T("network","route_gateway_warning"))}),this,{single:!0})},fillContent:function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix(this.getWebAPIName()),i=this.getConfig(e);if(this.MinMTU=1100,this.MaxMTU=9e3,1e3>e[t+"speed"])this.MaxMTU=1500;else if(1e3===e[t+"max_supported_speed"])this.MaxMTU=parseInt(_D("1g_maxmtu","9000"),10);else if("bond"===e[t+"type"]||"ovsbond"===e[t+"type"])for(var s=0;s<e[t+"slaves"].length;s++)if(1e3===e[t+"slaves"][s].max_supported_speed){this.MaxMTU=parseInt(_D("1g_maxmtu","9000"),10);break}this.nat=e[t+"nat"],!0!==this.nat&&this.hideFields(["enable_pppoe_relay","pppoe_relay_server_config","enable_upnp","upnp_server_config"]),this.old_config=i,this.setGlusterDisabled(e),this.loadStoreData(e),"yes"===i.use_dhcp&&(i.ip=""),this.getForm().setValues(i),this.setGroup()},setGlusterDisabled:function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix(this.getWebAPIName()),i=e.gluster_service_role||0,s=e.gluster_service_addr||"",n=e.gluster_service_enabled||!1;if(this.isComputingOrStorageNode=!1,(0!=(1&i)||0!=(2&i))&&n&&e[t+"ip"]===s){var o=this.getForm(),a=[this.useDhcpYesId,this.useDhcpNoId];Ext.each(a,(function(e){var t=Ext.getCmp(e);t&&t.disable()})),Ext.each(["ip","mask","gateway","dns","is_default_gateway","enable_vlan","vlan_id"],(function(e){var t=o.findField(e);t&&t.disable()})),this.isComputingOrStorageNode=!0}},getServerInterfaceMappingList:function(e,t,i){var s=this,n=[],o=[];return i&&Ext.each(i,(function(e){e.inn_ifname!==t&&o.push(e.ext_ifname)})),Ext.each(e,(function(e){0>o.indexOf(e)&&n.push({ifname:e,ifstring:SYNO.SDS.Utils.Network.idToString.apply(s,[e])})})),n},isDirty:function(){return this.getForm().isDirty()},isValid:function(){return!1!==this.checkConfigInHA(this.prepareWebAPISetMainData())&&(!1!==this.checkConfigInAHA(this.prepareWebAPISetMainData())&&this.getForm().isValid())},getWebAPISetData:function(){var e=[this.procWebAPISetMainData()];return!0===this.nat&&(e.push(this.procWebAPISetRelayData()),e.push(this.procWebAPISetUPnPData())),e},getWebAPIGetData:function(){var e=[{api:this.getWebAPIName(),version:1,method:"get",params:{ifname:this.win.ifname}},{api:"SYNO.Core.Network.PPPoE.Relay",method:"get",version:1,params:{ifname:this.win.ifname}},{api:"SYNO.Core.Network.UPnPServer",method:"get",version:1,params:{ifname:this.win.ifname}}];return Ext.isEmpty(this.getKnownAPI("SYNO.GlusterfsMgmt.Service"))||e.push({api:"SYNO.GlusterfsMgmt.Service",method:"get",version:1,params:{}}),e},prepareWebAPISetMainData:function(){var e=this.getForm(),t={ifname:this.win.ifname,use_dhcp:e.findField(this.useDhcpYesId).checked,enable_ha_ip:_S("has_ha_if")&&e.findField(this.enableHAIpYesId).checked};return!1!==t.use_dhcp&&!0!==_S("has_ha_if")||(t.ip=e.findField("ip").getValue(),t.mask=e.findField("mask").getValue(),t.gateway=e.findField("gateway").getValue(),t.dns=e.findField("dns").getValue()),!0===_S("has_ha_if")&&!1===t.enable_ha_ip&&(t.ip=this.old_config.ip,t.mask=this.old_config.mask,t.gateway=this.old_config.gateway,t.dns=this.old_config.dns),t.is_default_gateway=e.findField("is_default_gateway").getValue(),!0===e.findField("manual_adjust_mtu").getValue()?t.mtu=e.findField("mtu_config").getValue():t.mtu=1500,t.enable_vlan=e.findField("enable_vlan").getValue(),!0===t.enable_vlan&&(t.vlan_id=e.findField("vlan_id").getValue()),t},procWebAPISetMainData:function(){var e=this.prepareWebAPISetMainData();return!1!==this.checkConfigInHA(e)&&(!1!==this.checkConfigInAHA(e)&&{api:this.getWebAPIName(),version:1,method:"set",params:{configs:[e]}})},checkConfigInHA:function(e){if(!0!==_S("has_ha_if"))return!0;var t=function(e){var t=e.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);return t?(+t[1]<<24)+(+t[2]<<16)+(+t[3]<<8)+ +t[4]:0},i=SYNO.SDS.Utils.Network.idToString.apply(this,[this.win.ifname]),s=[],n=this.getForm().findField("manual_adjust_mtu").getValue(),o=this.getForm().findField("mtu_config").getValue(),a=this.getForm().findField("enable_vlan").getValue(),r=this.getForm().findField("vlan_id").getValue(),l=t(e.mask);return!0===e.use_dhcp&&this.old_config.gateway!==e.gateway&&s.push(String.format(_TT("SYNO.SDS.HA.Instance","ui","cannot_change_setting_dhcp"),i,_T("network","route_gateway"))),!0===e.use_dhcp&&this.old_config.dns!==e.dns&&s.push(String.format(_TT("SYNO.SDS.HA.Instance","ui","cannot_change_setting_dhcp"),i,_T("network","route_dns"))),!0===this.old_config.is_main_ha_ip&&!1===e.enable_ha_ip&&s.push(String.format(_TT("SYNO.SDS.HA.Instance","config","cannot_disable_main_if"),i)),!0!==this.old_config.is_main_ha_ip||this.old_config.manual_adjust_mtu===n&&this.old_config.mtu_config===o||s.push(String.format(_TT("SYNO.SDS.HA.Instance","ui","cannot_change_mtu_main_if"),i)),(this.old_config.enable_vlan!==a||this.old_config.vlan_id&&this.old_config.vlan_id!==r)&&s.push(String.format(_TT("SYNO.SDS.HA.Instance","ui","not_allow_vlan_setting"),i)),(t(this.old_config.ha_local_ip)&l)!=(t(e.ip)&l)&&s.push(String.format(_T("dhcp_server","option_in_same_subnet_warn"),e.ip,this.old_config.ha_local_ip)),0===s.length||(this.win.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),s.join("<br />")),!1)},isInvalidAHAIP:function(e,t){var i=e.split("."),s=t.split(".");if(4!==i.length||4!==s.length)return!1;return-1442906113==(parseInt(i[0],10)<<24|parseInt(i[1],10)<<16|parseInt(i[2],10)<<8|parseInt(i[3],10)|~(parseInt(s[0],10)<<24|parseInt(s[1],10)<<16|parseInt(s[2],10)<<8|parseInt(s[3],10)))},checkConfigInAHA:function(e){if("yes"!==_D("support_dual_head"))return!0;if(!1===e.use_dhcp&&this.isInvalidAHAIP(e.ip,e.mask)){var t=String.format(_TT("SYNO.SDS.AHA.Instance","uicommon","ip_forbidden"),e.ip,e.mask);return this.win.getMsgBox().alert(_TT("SYNO.SDS.AHA.Instance","uicommon","name"),t),!1}return!0},procWebAPISetRelayData:function(){var e=this.getForm();return{api:"SYNO.Core.Network.PPPoE.Relay",method:"set",version:1,params:{ifname:this.win.ifname,enabled:e.findField("enable_pppoe_relay").getValue(),server_interface:e.findField("pppoe_relay_server_config").getValue()}}},procWebAPISetUPnPData:function(){var e=this.getForm();return{api:"SYNO.Core.Network.UPnPServer",method:"set",version:1,params:{ifname:this.win.ifname,enabled:e.findField("enable_upnp").getValue(),server_interface:e.findField("upnp_server_config").getValue()}}},getWebAPIName:function(){var e="";return this.win.ifname&&(e=this.win.ifname),e.indexOf("eth")>-1?"SYNO.Core.Network.Ethernet":e.indexOf("bond")>-1?"SYNO.Core.Network.Bond":""},hideFields:function(e){var t=this.getForm();Ext.each(e,(function(e){t.findField(e).hide()}),this)},setGroup:function(){var e=this.getForm();this.isComputingOrStorageNode||(this.checkGroupDHCP=new SYNO.ux.Utils.EnableRadioGroup(e,"use_dhcp",{no:["ip","mask","gateway","dns"]}),this.checkGroupVlan=new SYNO.ux.Utils.EnableCheckGroup(e,"enable_vlan",["vlan_id"])),this.checkGroupMTU=new SYNO.ux.Utils.EnableCheckGroup(e,"manual_adjust_mtu",["mtu_config"]),this.checkGroupPPPoERelay=new SYNO.ux.Utils.EnableCheckGroup(e,"enable_pppoe_relay",["pppoe_relay_server_config"]),this.checkGroupUPNP=new SYNO.ux.Utils.EnableCheckGroup(e,"enable_upnp",["upnp_server_config"])},getConfig:function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix(this.getWebAPIName()),i={};return 0!==e[t+"vlan_id"]&&(i.vlan_id=e[t+"vlan_id"]),1500===e[t+"mtu_config"]?(i.manual_adjust_mtu=!1,i.mtu_config=1500):(i.manual_adjust_mtu=!0,i.mtu_config=e[t+"mtu_config"]),i.ip=e[t+"ip"],i.mask=e[t+"mask"],i.gateway=e[t+"gateway"],i.dns=e[t+"dns"],i.is_default_gateway=e[t+"is_default_gateway"],i.use_dhcp=e[t+"use_dhcp"]?"yes":"no",i.enable_ha_ip=e[t+"enable_ha_ip"]?"yes":"no",i.is_main_ha_ip=e[t+"is_main_ha_ip"],i.enable_vlan=e[t+"enable_vlan"],i.enable_pppoe_relay=e.pppoe_relay_enabled,i.pppoe_relay_server_config=e.pppoe_relay_server_interface,!i.pppoe_relay_server_config&&e.pppoe_relay_server_list&&(i.pppoe_relay_server_config=e.pppoe_relay_server_list[0]),i.enable_upnp=e.upnpserver_enabled,i.upnp_server_config=e.upnpserver_server_interface,!i.upnp_server_config&&e.upnpserver_server_list&&(i.upnp_server_config=e.upnpserver_server_list[0]),_S("has_ha_if")&&(i.ha_local_ip=e[t+"ha_local_ip"]),this.NetworkConnected="connected"==e[t+"status"],i},loadStoreData:function(e){this.PPPoERelayServerStore.loadData({success:!0,devs:this.getServerInterfaceMappingList(e.pppoe_relay_server_list)},!1),this.UPnPServerStore.loadData({success:!0,devs:this.getServerInterfaceMappingList(e.upnpserver_server_list,this.win.ifname,e.upnpserver_config_list)},!1),this.MtuStore.loadData(this.getMTUStore(),!1)},isNeedConfirm:function(){var e=this.getForm().findField("manual_adjust_mtu").getValue(),t=this.getForm().findField("mtu_config").getValue();return(this.old_config.manual_adjust_mtu!==e||this.old_config.mtu_config!==t)&&(this.confirmMsg=_T("network","mtu_warning_msg"),!0)},getConfirmMsg:function(){return this.confirmMsg},onCheckDhcp:function(e,t,i){e.checked&&Ext.getCmp("oobTabId")&&("yes"===e.value?!0===Ext.getCmp(Ext.getCmp("oobTabId").oobShellEnableCheckBoxId).getValue()?i.win.getMsgBox().confirm("",_T("oob","oob_dhcp_disable_confirm"),(function(e){"yes"===e?Ext.getCmp("oobTabId").updateOobEnable(!1):Ext.getCmp(i.useDhcpYesId).setValue("no")}),this):Ext.getCmp("oobTabId").updateOobEnable(!1):Ext.getCmp("oobTabId").updateOobEnable(!0))}}),Ext.define("SYNO.SDS.AdminCenter.Network.IPv6Tab",{extend:"SYNO.ux.FormPanel",constructor:function(e){this.owner=e.owner,this.callParent([this.fillConfig(e)]),this.on("activate",(function(){_S("ha_running")&&this.el.mask(_TT("SYNO.SDS.HA.Instance","ui","ha_not_support_setting"),"syno-ux-mask-info")}),this),this.on("deactivate",(function(){_S("ha_running")&&this.el.unmask()}),this)},fillConfig:function(e){return Ext.apply({title:"IPv6",module:e.module,trackResetOnLoad:!0,defaults:{width:330},items:[{xtype:"syno_combobox",fieldLabel:_T("tcpip","ipv6_setup"),name:"ipv6_type",disabled:!0===_S("ha_running"),allowBlank:!1,valueField:"value",displayField:"display",hiddenName:"ipv6_type",store:new Ext.data.SimpleStore({fields:["value","display"],data:this.getTypeData()}),listeners:{select:function(e){this.onSelect(e.getValue())},beforeselect:this.onBeforeSelect,scope:this}},{xtype:"syno_textfield",fieldLabel:_T("status","status_ipv6addr"),name:"ipv6_ip",disabled:!0===_S("ha_running"),allowBlank:!1,vtype:"v6ip"},{xtype:"syno_numberfield",fieldLabel:_T("tcpip","ipv6_prefixleng"),name:"ipv6_prefix_length",disabled:!0===_S("ha_running"),allowBlank:!1,vtype:"v6prefixLeng",listeners:{focus:function(e){const t=e.getValue();t||0===t||e.setValue(64)}}},{xtype:"syno_textfield",fieldLabel:_T("tcpip","ipv6_router"),name:"ipv6_router",disabled:!0===_S("ha_running"),allowBlank:!0,vtype:"v6ip"},{xtype:"syno_textfield",fieldLabel:_T("tcpip","primary_dns"),disabled:!0===_S("ha_running")||_S("version")<4966,hidden:_S("version")<4966,name:"ipv6_dns",allowBlank:!0,vtype:"v6ip"},{xtype:"syno_textfield",fieldLabel:_T("status","status_ipv6addr"),disabled:!0===_S("ha_running"),name:"ipv6_router_local_addr_v6",allowBlank:!1,vtype:"v6ip"},{xtype:"syno_numberfield",fieldLabel:_T("tcpip","ipv6_prefixleng"),disabled:!0===_S("ha_running"),name:"ipv6_router_prefix_length",allowBlank:!1,vtype:"v6prefixLeng"},new SYNO.ux.CompositeField({name:"prefix_composite",items:[{xtype:"syno_textfield",fieldLabel:_T("tcpip","ipv6_prefix"),name:"ipv6_router_prefix",disabled:!0===_S("ha_running"),allowBlank:!1,vtype:"v6ip",width:250},{xtype:"syno_displayfield",value:"/64"}]}),{xtype:"syno_textfield",fieldLabel:_T("tcpip","remote_ipv4_address"),name:"ipv6_router_remote_addr_v4",disabled:!0===_S("ha_running"),allowBlank:!1,vtype:"v4ip"},{xtype:"syno_checkbox",boxLabel:_T("network","usbmodem_set_as_default_gw"),name:"is_default_gateway",disabled:!0===_S("ha_running")||_S("version")<4966,hidden:_S("version")<4966,checked:!1}]},e)},getTypeData:function(){var e;return e=_S("version")<4966?[["auto",_T("tcpip","ipv6_auto")],["dhcp",_T("tcpip","ipv6_dhcp")],["static",_T("tcpip","ipv6_static")],["off",_T("tcpip","ipv6_off")]]:[["off",_T("tcpip","ipv6_off")],["auto",_T("tcpip","ipv6_auto")],["static",_T("tcpip","ipv6_static")]],_S("version")>4966&&!this.isWifiClient&&(e=e.concat([["6in4",_T("tcpip","ipv6_6in4")],["6to4",_T("tcpip","ipv6_6to4")],["native",_T("tcpip","ipv6_dhcp_pd")]])),e},fillContent:function(e){var t=this.getForm();SYNO.ux.AddTip(t.findField("ipv6_router").getEl(),_T("network","route_gateway_warning")),t.setValues(this.getConfig(e)),this.onSelect(t.findField("ipv6_type").getValue())},getConfig:function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix("SYNO.Core.Network.IPv6.Router"),i=e[t+"config"],s=this.getIPv6Type(e.ipv6_type,e[t+"type"],i);this.isDefgw=e.ipv6_is_default_gateway,this.isTunDefgw=e[t+"is_default_gateway"];var n={is_default_gateway:this.isTunnelType(s)?this.isTunDefgw:this.isDefgw,ipv6_type:s,ipv6_ip:e.ipv6_ip,ipv6_prefix_length:e.ipv6_prefix_length,ipv6_router:e.ipv6_router,ipv6_dns:e.ipv6_dns};return"6in4"===n.ipv6_type||"6to4"===n.ipv6_type?(n.ipv6_router_local_addr_v6=i.local_addr_v6.substring(0,i.local_addr_v6.indexOf("/")),n.ipv6_router_prefix_length=i.local_addr_v6.substring(i.local_addr_v6.indexOf("/")+1),n.ipv6_router_prefix=i.prefix.substring(0,i.prefix.indexOf("/")),n.ipv6_router_remote_addr_v4=i.remote_addr_v4):"native"===n.ipv6_type&&i.prefix&&(n.ipv6_router_prefix=i.prefix.substring(0,i.prefix.indexOf("/"))),n},getIPv6Type:function(e,t,i){return i&&i.wan&&i.wan===this.win.ifname?"off"===t?e:t:e},isDirty:function(){return this.getForm().isDirty()},isValid:function(){return this.getForm().isValid()},isRouterType:function(e){return"6in4"===e||"6to4"===e||"native"===e},isTunnelType:function(e){return"6in4"===e||"6to4"===e},getWebAPISetData:function(){var e=[],t=this.getForm().findField("ipv6_type").getValue();return this.isRouterType(t)?("native"==t&&e.push(this.getIPv6WebAPISetData()),e.push(this.getIPv6RouterWebAPISetData())):(e.push(this.getIPv6WebAPISetData()),this.isWifiClient||e.push({api:"SYNO.Core.Network.IPv6.Router",version:1,method:"set",params:{type:"off",config:{wan:this.win.ifname}}})),e},getIPv6WebAPISetData:function(){var e=this.getForm(),t=e.findField("ipv6_type").getValue(),i={ifname:this.win.ifname,type:"native"==t?"auto":t,is_default_gateway:e.findField("is_default_gateway").getValue(),force:!0};return"static"===i.type&&(i.ip=e.findField("ipv6_ip").getValue(),i.prefix_length=e.findField("ipv6_prefix_length").getValue(),i.router=e.findField("ipv6_router").getValue(),i.dns=e.findField("ipv6_dns").getValue()),{api:"SYNO.Core.Network.IPv6",version:1,method:"set",params:i}},getIPv6RouterWebAPISetData:function(){var e=this.getForm(),t={wan:this.win.ifname,is_default_gateway:e.findField("is_default_gateway").getValue()};return"6in4"===e.findField("ipv6_type").getValue()&&(t.prefix=e.findField("ipv6_router_prefix").getValue()+"/64",t.remote_addr_v4=e.findField("ipv6_router_remote_addr_v4").getValue(),t.local_addr_v6=e.findField("ipv6_router_local_addr_v6").getValue()+"/"+e.findField("ipv6_router_prefix_length").getValue()),{api:"SYNO.Core.Network.IPv6.Router",version:1,method:"set",params:{type:e.findField("ipv6_type").getValue(),config:t}}},getWebAPIGetData:function(){return[{api:"SYNO.Core.Network.IPv6",version:1,method:"get",params:{ifname:this.win.ifname}},{api:"SYNO.Core.Network.IPv6.Router",version:1,method:"get",params:{wan:this.win.ifname}}]},onBeforeSelect:function(e,t,i){var s=e.getValue(),n=t.get("value");return!(!this.isRouterType(s)&&this.isRouterType(n))||(e.collapse(),this.win.getMsgBox().confirm("",_T("tcpip","ipv6_tunnel_warning"),(function(t){"yes"===t&&(e.setValue(n),this.onSelect(n))}),this),!1)},onSelect:function(e){var t;t=_S("version")>=4966?["ipv6_ip","ipv6_prefix_length","ipv6_router","ipv6_dns"]:["ipv6_ip","ipv6_prefix_length","ipv6_router"];var i=["ipv6_router_remote_addr_v4","ipv6_router_local_addr_v6","ipv6_router_prefix_length"],s=["prefix_composite"];switch(this.getForm().findField("is_default_gateway").setValue(this.isTunnelType(e)?this.isTunDefgw:this.isDefgw),this.isTunnelType(e)?(this.hideFields(t,!0),this.hideFields(i,!1),this.hideFields(s,!1),this.enableFields(t,!1)):(this.hideFields(t,!1),this.hideFields(i,!0),"native"==e?this.hideFields(s,!1):this.hideFields(s,!0),this.enableFields(i,!1),this.enableFields(s,!1)),e){case"static":this.enableFields(t,!0);break;case"off":case"dhcp":case"auto":case"native":this.enableFields(t,!1),this.getForm().clearInvalid();break;case"6in4":this.enableFields(s,!0),this.enableFields(i,!0);break;case"6to4":this.enableFields(s,!1),this.enableFields(i,!1),this.getForm().clearInvalid();break;default:SYNO.Debug("Unknown type: "+e)}},syncMask:function(e){},enableFields:function(e,t){Ext.each(e,(function(e){var i=this.getForm().findField(e);return t?i.enable():i.disable()}),this)},hideFields:function(e,t){Ext.each(e,(function(e){var i=this.getForm().findField(e);return t?i.hide():i.show()}),this)}}),Ext.define("SYNO.SDS.AdminCenter.Network.PPPoEIPv6Tab",{extend:"SYNO.ux.FormPanel",constructor:function(e){this.owner=e.owner,this.callParent([this.fillConfig(e)])},fillConfig:function(e){return Ext.apply({title:"IPv6",hideMode:"offsets",module:e.module,trackResetOnLoad:!0,defaults:{width:330},items:[{xtype:"syno_combobox",fieldLabel:_T("tcpip","ipv6_setup"),name:"ipv6_type",allowBlank:!1,valueField:"value",displayField:"display",hiddenName:"ipv6_type",store:new Ext.data.SimpleStore({fields:["value","display"],data:[["off",_T("tcpip","ipv6_auto")],["6in4",_T("tcpip","ipv6_6in4")],["6to4",_T("tcpip","ipv6_6to4")],["native",_T("tcpip","ipv6_dhcp_pd")]]}),listeners:{select:function(e){this.onSelect(e.getValue())},beforeSelect:this.onBeforeSelect,scope:this}},{xtype:"syno_textfield",fieldLabel:_T("status","status_ipv6addr"),name:"ipv6_router_local_addr_v6",allowBlank:!1,vtype:"v6ip"},{xtype:"syno_numberfield",fieldLabel:_T("tcpip","ipv6_prefixleng"),name:"ipv6_router_prefix_length",allowBlank:!1,vtype:"v6prefixLeng"},new SYNO.ux.CompositeField({name:"prefix_composite",items:[{xtype:"syno_textfield",fieldLabel:_T("tcpip","ipv6_prefix"),name:"ipv6_router_prefix",allowBlank:!1,vtype:"v6ip",width:250},{xtype:"syno_displayfield",value:"/64"}]}),{xtype:"syno_textfield",fieldLabel:_T("tcpip","remote_ipv4_address"),name:"ipv6_router_remote_addr_v4",allowBlank:!1,vtype:"v4ip"},{xtype:"syno_checkbox",boxLabel:_T("network","usbmodem_set_as_default_gw"),name:"is_default_gateway",disabled:!0===_S("ha_running"),checked:!1}]},e)},fillContent:function(e){var t=this.getForm();t.setValues(this.getConfig(e)),this.onSelect(t.findField("ipv6_type").getValue())},getConfig:function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix("SYNO.Core.Network.IPv6.Router"),i=e[t+"config"],s={is_default_gateway:e[t+"is_default_gateway"],ipv6_type:e[t+"type"]};return i&&"pppoe"!==i.wan||("6in4"===s.ipv6_type||"6to4"===s.ipv6_type?(s.ipv6_router_local_addr_v6=i.local_addr_v6.substring(0,i.local_addr_v6.indexOf("/")),s.ipv6_router_prefix_length=i.local_addr_v6.substring(i.local_addr_v6.indexOf("/")+1),s.ipv6_router_prefix=i.prefix.substring(0,i.prefix.indexOf("/")),s.ipv6_router_remote_addr_v4=i.remote_addr_v4):"native"===s.ipv6_type&&i.prefix&&(s.ipv6_router_prefix=i.prefix.substring(0,i.prefix.indexOf("/")))),s},isDirty:function(){return this.getForm().isDirty()},isValid:function(){return this.getForm().isValid()},getWebAPISetData:function(){var e=this.getForm(),t={wan:this.win.ifname,is_default_gateway:e.findField("is_default_gateway").getValue()};return"6in4"===e.findField("ipv6_type").getValue()&&(t.prefix=e.findField("ipv6_router_prefix").getValue()+"/64",t.remote_addr_v4=e.findField("ipv6_router_remote_addr_v4").getValue(),t.local_addr_v6=e.findField("ipv6_router_local_addr_v6").getValue()+"/"+e.findField("ipv6_router_prefix_length").getValue()),{api:"SYNO.Core.Network.IPv6.Router",version:1,method:"set",params:{type:e.findField("ipv6_type").getValue(),config:t}}},getWebAPIGetData:function(){return{api:"SYNO.Core.Network.IPv6.Router",version:1,method:"get",params:{wan:this.win.ifname}}},onBeforeSelect:function(e,t,i){var s=e.getValue(),n=t.get("value");return"off"!==s||"off"===n||(e.collapse(),this.win.getMsgBox().confirm("",_T("tcpip","ipv6_tunnel_warning"),(function(t){"yes"===t&&(e.setValue(n),this.onSelect(n))}),this),!1)},onSelect:function(e){var t=["prefix_composite","ipv6_router_remote_addr_v4","ipv6_router_local_addr_v6","ipv6_router_prefix_length"];switch(e){case"6in4":this.enableFields(t,!0);break;case"off":case"6to4":case"native":this.enableFields(t,!1),this.getForm().clearInvalid();break;default:SYNO.Debug("Unknown type: "+e)}},enableFields:function(e,t){Ext.each(e,(function(e){var i=this.getForm().findField(e);return t?i.enable():i.disable()}),this)}}),Ext.define("SYNO.SDS.AdminCenter.Network.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.addListener("destroy",e.module.startPolling,e.module),this.init()},fillConfig:function(e){return this.owner=e.owner,this.ifname=e.ifname,this.getQCInfoAPI={api:"SYNO.Core.QuickConnect",version:this.getQcWebApiVersion(),method:"get"},Ext.apply({title:_T("common","alt_edit"),width:790,height:570,resizable:!1,layout:"fit",items:[this.getTabPanel(e)],buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","alt_apply"),disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",btnStyle:"blue",scope:this,handler:this.onApply}]},e)},getTabPanel:function(e){return this.tabpanel||(this.tabpanel=new SYNO.SDS.AdminCenter.Network.EditTabPanel({module:e.module,owner:e.owner,win:this,tabs:e.tabs,ifname:this.ifname})),this.tabpanel},onApply:function(){if(this.tabpanel.isDirty()){var e=this.tabpanel.getInvalidTab();if(e){var t=_T("common","forminvalid");return"function"==typeof e.getErrorMsg&&(t=e.getErrorMsg()),this.tabpanel.setActiveTab(e),void this.setStatusError({text:t})}if(Ext.isDefined(this.tabpanel.ipv6Panel)){var i=this.tabpanel.ipv6Panel.form.findField("ipv6_type").getValue();SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.Network.DHCPv6",!0),"auto"!==i&&"native"!==i||SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.Network.DHCPv6",!1)}this.doApply()}else this.onCancel()},doApply:function(){var e=this.tabpanel.getConfirmTabs();0<e.length?this.doConfirms(e,0):this.sendWebAPISetData()},doConfirms:function(e,t){e.length<=t||(this.tabpanel.setActiveTab(e[t]),this.getMsgBox().confirm("",e[t].getConfirmMsg(),(function(i){"yes"===i&&(e.length-1===t?this.sendWebAPISetData():this.doConfirms(e,++t))}),this))},sendWebAPISetData:function(){var e=this.tabpanel.getWebAPISetData(),t=SYNO.SDS.QuickConnect.Utils.isInTunnel(),i=SYNO.SDS.QuickConnect.Utils.isSmartDNS();(t||i)&&e.unshift(this.getQCInfoAPI),this.setStatusBusy({text:_T("common","applying"),clear:!1}),this.disable(),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},callback:this.webapiSetHandler,scope:this})},onCancel:function(){this.tabpanel.isDirty()?this.confirmLostChangePromise({save:this.onApply,dontSave:this.close,cancel:Ext.emptyFn},this):this.close()},init:function(){var e=this.tabpanel.getWebAPIGetData();this.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},callback:this.webapiGetHandler,scope:this})},webapiGetHandler:function(e,t,i,s){var n=SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix;Ext.each(t.result,(function(e,t,i){if(e.success){var s=n(e.api),o=[];Ext.iterate(e.data,(function(e){o.push(e)}),this),Ext.each(o,(function(t){e.data[s+t]=e.data[t],SYNO.Debug("result.data["+s+t+"] = "+e.data[t]),delete e.data[t]}),this),this.data=Ext.apply(e.data,this.data)}else SYNO.Debug("Failed on "+e.api+" "+e.method)}),this),this.data?(this.tabpanel.fillContent(this.data),this.clearStatusBusy()):SYNO.Debug("No success request")},webapiSetHandler:function(e,t,i,s){if(!e||t.has_fail){var n=_T("common","error_system"),o=!1,a="";return this.enable(),Ext.each(t.result,(function(e){if(e.error&&e.error.code){if(4319===e.error.code){var t=e.error.errors;if(0<t.hard.length&&(o=!0),"dhcp_change"===t.type){var i="";for(c=0;c<t.hard.length;++c)i+="<br>"+SYNO.SDS.Utils.GetFeasibilityCheckMsg(t.hard[c]);return a=String.format(_T("network","dhcp_feasibility_check_fail"),i),!1}}return n=SYNO.API.getErrorString(e.error.code),!1}}),this),!0===o&&(n=_T("error","nochange_subject"),this.getMsgBox().alert(_T("controlpanel","leaf_lan"),a)),void this.setStatusError({text:n,clear:!0})}var r="SYNO.SDS.CMS.Application"===this.findAppWindow().getOpenConfig("className"),l=!0===this.findAppWindow().getOpenConfig("cms_self");if((!r||l)&&t&&t.result)for(var d=null,c=0;c<t.result.length;c++)if(SYNO.ux.Utils.checkApiConsistency(t.result[c],this.getQCInfoAPI))t.result[c].success&&(d=t.result[c].data.server_alias);else{var h=t.result[c].data;if(h){this.removeListener("destroy",this.module.startPolling,this.module),SYNO.SDS.AdminCenter.Network.Utils.Redirect.apply(this,[h.redirect,h.secure,h.ip_list,h.port,h.auth_key,"SYNO.SDS.AdminCenter.Network.Main",1e4,null,d]);break}}this.setStatusOK(),this.close()},getQcWebApiVersion:function(){var e=_S("version");return 4989<=e&&e<5450||5456<=e?2:1}}),Ext.define("SYNO.SDS.AdminCenter.Network.EditTabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){var t=Ext.apply({activeTab:0,deferredRender:!1,items:[]},e);Ext.each(e.tabs,(function(i){switch(i){case"bond_mode":t.items.push(this.getBondModePanel(e));break;case"ipv4":t.items.push(this.getIPv4Panel(e));break;case"ipv6":_S("ha_not_support_ipv6")||t.items.push(this.getIPv6Panel(e));break;case"auth":e.ifname.indexOf("ovs_bond")<=-1&&t.items.push(this.getAuthPanel(e));break;case"oob":t.items.push(this.getOobPanel(e));break;default:SYNO.Debug("unknown tab: "+i)}}),this),this.callParent([t])},getBondModePanel:function(e){var t="";return e.ifname.indexOf("ovs")>-1&&(t="ovs"),this.bondModePanel||(this.bondModePanel=new SYNO.SDS.AdminCenter.Network.BondModeTab({title:_T("network","linkaggr_mode"),module:e.module,owner:e.owner,win:e.win,bondType:t})),this.bondModePanel},getIPv4Panel:function(e){var t={title:"IPv4",module:e.module,owner:e.owner,win:e.win,parentPanel:this};return this.ipv4Panel||(this.ipv4Panel=new SYNO.SDS.AdminCenter.Network.IPv4Tab(t)),this.ipv4Panel},getIPv6Panel:function(e){var t={title:"IPv6",module:e.module,owner:e.owner,win:e.win,parentPanel:this};return this.ipv6Panel||("pppoe"===e.win.ifname?this.ipv6Panel=new SYNO.SDS.AdminCenter.Network.PPPoEIPv6Tab(t):this.ipv6Panel=new SYNO.SDS.AdminCenter.Network.IPv6Tab(t)),this.ipv6Panel},getAuthPanel:function(e){return this.authPanel||(this.authPanel=new SYNO.SDS.AdminCenter.Network.AuthTab({module:e.module,owner:e.owner,win:e.win,parentPanel:this})),this.authPanel},getOobPanel:function(e){var t={module:e.module,owner:e.owner,win:e.win,parentPanel:this};return this.oobPanel||(this.oobPanel=new SYNO.SDS.AdminCenter.Network.OobTab(t)),this.oobPanel},fillContent:function(e){this.items.each((function(t){t.fillContent(e)}))},isDirty:function(){var e=!1;return this.items.each((function(t){t.isDirty()&&(e=!0)})),e},getInvalidTab:function(){var e;return this.items.each((function(t){t.isValid()||(e=t)})),e},getConfirmTabs:function(){var e=[];return this.items.each((function(t){Ext.isDefined(t.isNeedConfirm)&&t.isNeedConfirm()&&e.push(t)})),e},getWebAPIGetData:function(){var e=[];return this.items.each((function(t){var i=t.getWebAPIGetData();i instanceof Array?Ext.each(i,(function(t){e.push(t)})):e.push(i)})),e},getWebAPISetData:function(){var e=[];return this.items.each((function(t){if(t.getWebAPISetData&&t.isDirty()){var i=t.getWebAPISetData();i instanceof Array?Ext.each(i,(function(t){e.push(t)})):e.push(i)}})),e}}),Ext.ns("SYNO.SDS.AdminCenter.Network.Ethernet"),SYNO.SDS.AdminCenter.Network.Ethernet.getWebAPI=function(){return{api:"SYNO.Core.Network.Ethernet",method:"list",version:2,callback:function(e){Ext.each(e,(function(e,t,i){var s="net-";"wan"===e.type?s+="wan-":s+="lan-","connected"===e.status?s+="connected":s+="disconnected",e.cls=s}))}}},SYNO.SDS.AdminCenter.Network.Ethernet.setARIAInfo=function(e){var t=SYNO.SDS.AdminCenter.Network.Utils;if(e.ariaInfo=String.format("{0} {1} ",t.getTitle(e.title,e,this),t.getStatusStr(e.status)),"connected"==e.status||"enabled"==e.status){if("bond"==e.type){e.ariaInfo+=String.format("{0} {1} ",_T("network","interface"),_T("tcpip","link_status"));for(var i=0;i<e.slaves.length;i++){var s=e.slaves[i];e.ariaInfo+=String.format("{0} {1} ",t.getTitle(s.ifname,s,this),t.getLinkStatus(s.link_status,s))}}var n,o;!0===_S("has_ha_if")?(n=t.toEmptyDash(e.ha_local_ip),o=t.toEmptyDash(e.ha_local_mask)):(n=t.toEmptyDash(e.ip),o=t.toEmptyDash(e.mask)),e.ariaInfo+=String.format("{0} {1} {2} {3} {4} {5} ",_T("network","use_dhcp"),t.toYesNo(e.use_dhcp),_T("tcpip","tcpip_ipaddr"),n,_T("tcpip","tcpip_mask"),o),e.ariaInfo+=String.format("{0} {1} ",_T("status","status_ipv6addr"),t.ConvertToReadableIPv6(t.toMultiLine(e.ipv6))),0!==e.mtu&&1500!==e.mtu&&(e.ariaInfo+=String.format("{0} {1} ",_T("tcpip","MTU_setting"),_T("tcpip","MTU_enable"))),0!==e.speed&&(e.ariaInfo+=String.format("{0} {1} ",_T("tcpip","link_status"),t.getLinkStatus(e.link_status,e))),!0===e.enable_vlan&&(e.ariaInfo+=String.format("VLAN ID {0} ",e.vlan_id)),e.ariaInfo=Ext.util.Format.stripTags(e.ariaInfo)}},SYNO.SDS.AdminCenter.Network.Ethernet.getTpl=function(e){var t=new Ext.XTemplate('<tpl for="slaves">',"<dl>",'<dt class="sm-disk-list-column" style="width:30%">{ifname:this.getTitle}</dt>','<dt class="sm-disk-list-column" style="width:70%">{link_status:this.getLinkStatus}</dt>',"</dl>",'<div class="x-clear"></div>',"</tpl>");return new Ext.XTemplate("<tpl if=\"values.type=='lan' || values.type=='wan' || values.type=='bond' || values.type=='ovseth' || values.type=='ovsbond'\">","<div>",String.format(e,_T("tcpip","tcpip_mask"),!0===_S("has_ha_if")?"{ha_local_mask:this.toEmptyDash}":"{mask:this.toEmptyDash}"),String.format(e,_T("status","status_ipv6addr"),"{ipv6:this.toMultiLine}"),'<tpl if="values.mtu != 0 && values.mtu != 1500">',String.format(e,_T("tcpip","MTU_setting"),_T("tcpip","MTU_enable")+" {mtu}"),"</tpl>",'<tpl if="values.speed != 0">',String.format(e,_T("tcpip","link_status"),"{link_status:this.getLinkStatus}"),"</tpl>",'<tpl if="values.enable_vlan == true">',String.format(e,"VLAN ID","{vlan_id}"),"</tpl>","</div>","<tpl if=\"values.type=='bond' || values.type=='ovsbond'\">",'<div class="sm-disk-list">','<div class="sm-disk-list-header" style="height: 24px">',"<dl>",String.format('<dt style="float:left;width:30%">{0}</dt>',_T("network","interface")),String.format('<dt style="float:left;width:70%">{0}</dt>',_T("tcpip","link_status")),"</dl>","</div>",'<div class="sm-disk-list-body">',t.html,"</div>","</div>",'<div class="x-clear"></div>',"</tpl>","<div>{ariaInfo:this.setARIAInfo}</div>","</tpl>").html},SYNO.SDS.AdminCenter.Network.Ethernet.getIpTpl=function(){return"<tpl if=\"values.type=='lan' || values.type=='wan' || values.type=='bond' || values.type=='ovseth' || values.type=='ovsbond'\">"+(!0===_S("has_ha_if")?"{ha_local_ip:this.toEmptyDash}":"{ip:this.toEmptyDash}")+"</tpl>"},SYNO.SDS.AdminCenter.Network.Ethernet.getBtnConfig=function(){return{editBtn:{isDisabled:!1,handler:SYNO.SDS.AdminCenter.Network.Ethernet.onEdit},deleteBtn:{isDisabled:!0,handler:null},connectBtn:{isDisabled:!0,handler:null}}},SYNO.SDS.AdminCenter.Network.Ethernet.onEdit=function(){if(!0!==_S("manage_eth_in_ha_pkg")){this.module.stopPolling();var e=12&this.selectedRecord.get("block");if(0<e){var t=this.selectedRecord.get("id")?this.selectedRecord.get("id"):this.selectedRecord.get("ifname"),i=this.selectedRecord.get("type"),s="";return 0<(8&e)?s="MailPlus Server":0<(4&e)&&(s="Virtual Machine Manager"),void this.module.appWin.getMsgBox().alert("",String.format(_T("network","interface_block_msg"),SYNO.SDS.Utils.Network.idToString(t,i),s))}var n={module:this.module,owner:this.module.appWin,ifname:this.selectedRecord.get("ifname"),tabs:["ipv4","ipv6","auth"]};"yes"===_D("support_oob_ctl")&&n.ifname&&n.ifname===_D("oob_interface")&&n.tabs.push("oob"),new SYNO.SDS.AdminCenter.Network.EditDialog(n).open()}else this.module.getGoToHAMsgBox()},Ext.ns("SYNO.SDS.AdminCenter.Utils.Render"),SYNO.SDS.AdminCenter.Utils.Render.PROTOCOL=[["tcp",_T("firewall","firewall_protocol_tcp")],["udp",_T("firewall","firewall_protocol_udp")],["icmp",_T("firewall","firewall_protocol_icmp")],["igmp",_T("firewall","firewall_protocol_igmp")],["gre",_T("firewall","firewall_protocol_gre")],["esp",_T("firewall","firewall_protocol_esp")],["all",_T("firewall","firewall_ports_all")]],SYNO.SDS.AdminCenter.Utils.Render.ServerPortsParsing=function(e,t,i){var s=0,n=0;if(!e)return!1;if(!e.port_info)return!1;var o,a=e.port_info,r="",l="",d="",c="",h="";for(t.length=0,s=0;s<a.length;s++){if(d="",c="",h="",r="",l="",null!==(o=a[s]).dst_port)for(n=0;n<o.dst_port.length;n++)""!==h&&(h+=","),h+=o.dst_port[n];if(!i&&null!==o.src_port)for(n=0;n<o.src_port.length;n++)""!==c&&(c+=","),c+=o.src_port[n];""!==h&&(d+=h),""!==c&&(""!==d&&(d+=","),d+=String.format("{0} ({1})",c,_T("firewall","firewall_port_type_source"))),r=o.name,l=o.desc,t.push([o.port_id,r,d,l,o.protocol,!1])}return!0},SYNO.SDS.AdminCenter.Utils.Render.Render_Protocol=function(e,t){for(var i=SYNO.SDS.AdminCenter.Utils.Render.PROTOCOL,s=0;s<i.length;s++)if(e==i[s][0])return t.attr='ext:qtip="'+i[s][1]+'"',i[s][1];return"-"},SYNO.SDS.AdminCenter.Utils.Render.FindServiceName=function(e,t){for(var i=0;i<t.length;i++)if(e==t[i][0])return t[i][3];return""},SYNO.SDS.AdminCenter.Utils.Render.FindServicePorts=function(e,t){for(var i=0;i<t.length;i++)if(e==t[i][0])return t[i][2];return""},SYNO.SDS.AdminCenter.Utils.Render.Render_Ports=function(e,t,i){var s=[],n=i.data.port_type,o=i.data.port_num,a="dest",r="-",l="",d=[],c="-",h="",u=[];if("ALL"==n)c=r=_T("firewall","firewall_ports_all");else if("SYS"==n||"RESERVED"==n){s=o.split(",");for(var p=0;p<s.length;p++)l=SYNO.SDS.AdminCenter.Utils.Render.FindServiceName(s[p],i.store.appWindow.portInfo),d.push(l),h=l+"("+i.data.protocol+":",h+=SYNO.SDS.AdminCenter.Utils.Render.FindServicePorts(s[p],i.store.appWindow.portInfo)+")",u.push(h);r=d.join(", "),c=u.join(", ")}else"SELF"==n&&(""!==i.data.port_direction&&(a=i.data.port_direction),""!==o&&(c=r="dest"==a?String.format("{0} ({1})",o,_T("firewall","firewall_port_type_dest")):o));return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(c)+'"',r},SYNO.SDS.AdminCenter.Utils.Render.Render_Source=function(e,t){if("all"==e)e=_T("firewall","firewall_ports_all");else if(0<=e.indexOf("GEOIP:")){var i,s=[];i=(e=e.replace("GEOIP:","")).split(",");for(var n=0;n<i.length;n++)s.push(_T("Country",i[n]));e=s.join(",")}else e=e.replace("-"," "+_T("log","date_to")+" ");return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e},SYNO.SDS.AdminCenter.Utils.Render.Render_Encode_And_AddTip=function(e,t,i){return t.attr='ext:qtip="'+Ext.util.Format.qtipHtmlEncode(e)+'"',Ext.util.Format.htmlEncode(e)},Ext.define("SYNO.SDS.AdminCenter.Utils.Dialog.ServPortsGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){e.serverPorts&&(this.serverPorts=e.serverPorts),this.enabledPorts=[],this.serverPorts=[],this.nonEditable=[];var t=new Ext.data.ArrayStore({autoDestroy:!0,fields:["port_id","name","port_num","desc","protocol","enabled"],data:[]}),i={header:_T("common","selected"),nonEditable:this.nonEditable,dataIndex:"enabled",id:"enabled",width:120,menuDisabled:!0,align:"center"},s=new SYNO.SDS.AdminCenter.Utils.Dialog.EnableColumn(i),n=new Ext.grid.ColumnModel([s,{id:"desc",width:150,header:_T("firewall","firewall_system_port_column_desc"),dataIndex:"desc",align:"left",sortable:!0,renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}},{header:_T("firewall","firewall_ports"),dataIndex:"port_num",sortable:!0,renderer:function(e,t,i){var s=e.split(","),n="";n=s[0];for(var o=1;o<s.length;o++)n+=", "+s[o];return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i.data.port_num)+'"',n},align:"left",width:150},{header:_T("firewall","description"),dataIndex:"name",align:"left",sortable:!0,renderer:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e},width:150}]);n.defaultSortable=!1;var o={ds:t,cm:n,loadMask:!1,viewConfig:{markDirty:!1},enableColLock:!0,enableColumnMove:!1,autoExpandColumn:"desc",enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({}),plugins:[s]};this.hdrChkboxColumn=s,Ext.apply(o,e),SYNO.LayoutConfig.fill(o),this.callParent([o])},setVal:function(e){""===e?this.enabledPorts.length=0:this.enabledPorts=e.split(","),this.getStore().loadData(this.serverPorts,!1),this.onEnableServices(this.enabledPorts),this.hdrChkboxColumn.checkSelectAll(this.getStore())},onEnableServices:function(e){for(var t,i=this.getStore(),s=i.getCount(),n=0;n<e.length;n++)for(var o=0;o<s;o++)if(t=i.getAt(o),e[n]==t.get("port_id")){t.set("enabled",!0);break}i.commitChanges()},setNonEditable:function(e){this.getColumnModel().getColumnById("enabled").setNonEditable(e)},getEnabledPortsProtocol:function(){for(var e,t="all",i=this.getStore().getCount(),s=0,n=0,o=0,a=0;a<i;a++)if((e=this.getStore().getAt(a)).get("enabled"))switch(e.get("protocol")){case"tcp":s++;break;case"udp":n++;break;default:o++}return 0<o||0<s&&0<n?t="all":0<s?t="tcp":0<n&&(t="udp"),t},getEnabledPorts:function(){for(var e,t=[],i=this.getStore().getCount(),s=0;s<i;s++)(e=this.getStore().getAt(s)).get("enabled")&&t.push(e.get("port_id"));return this.enabledPorts=t,t.join(",")}}),Ext.define("SYNO.SDS.AdminCenter.Utils.Dialog.EnableColumn",{extend:"SYNO.ux.EnableColumn",constructor:function(e){this.nonEditable=e.nonEditable,this.callParent([e])},isIgnore:function(e,t){for(var i=0;i<this.nonEditable.length;i++)if(this.nonEditable[i]===t.get("port_id"))return!0;return!1},setNonEditable:function(e){""!==e?this.nonEditable=e.split(","):this.nonEditable.length=0}}),Ext.define("SYNO.SDS.AdminCenter.Utils.Dialog.ServPortsDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.grid=new SYNO.SDS.AdminCenter.Utils.Dialog.ServPortsGrid({serverPorts:e.serverPorts});var t={width:650,height:430,title:_T("firewall","firewall_system_port_title"),layout:"fit",items:[this.grid],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onApply}]};Ext.apply(t,e),this.callParent([t])},onApply:function(){this.onDumpEnabledPorts(),this.onDumpEnabledPortsProtocol(),this.close()},onDumpEnabledPortsProtocol:function(){this.owner.setServicesProtocol(this.grid.getEnabledPortsProtocol())},onDumpEnabledPorts:function(){this.owner.setServices(this.grid.getEnabledPorts())},setVal:function(e){this.grid.setVal(e)},onActivate:function(){this.callParent(arguments),this.grid.getView().onLayout()}}),Ext.ns("SYNO.SDS.AdminCenter.Network.PPPoE"),SYNO.SDS.AdminCenter.Network.PPPoE.getWebAPI=function(){return{api:"SYNO.Core.Network.PPPoE",method:"list",version:1,callback:function(e){Ext.each(e,(function(e,t,i){i[t].id="pppoe","connected"===e.status||"connecting"===e.status?i[t].cls="net-pppoe-connected":i[t].cls="net-pppoe-disconnected"}))}}},SYNO.SDS.AdminCenter.Network.PPPoE.setARIAInfo=function(e){var t=SYNO.SDS.AdminCenter.Network.Utils;e.ariaInfo=String.format("{0} {1} ",t.getTitle(e.title,e,this),t.getStatusStr(e.status)),"connected"!=e.status&&"enabled"!=e.status||(e.ariaInfo+=String.format("{0} {1} {2} {3} {4} {5}",_T("pppoe","pppoe_IP"),t.toEmptyDash(e.ip),_T("pppoe","pppoe_mask"),t.toEmptyDash(e.mask),_T("status","status_ipv6addr"),t.ConvertToReadableIPv6(t.toMultiLine(e.ipv6))),e.ariaInfo=Ext.util.Format.stripTags(e.ariaInfo))},SYNO.SDS.AdminCenter.Network.PPPoE.getTpl=function(e){return new Ext.XTemplate("<tpl if=\"values.type=='pppoe'\">",String.format(e,_T("pppoe","pppoe_mask"),"{mask:this.toEmptyDash}"),String.format(e,_T("status","status_ipv6addr"),"{ipv6:this.toMultiLine}"),"<div>{ariaInfo:this.setARIAInfo}</div>","</tpl>").html},SYNO.SDS.AdminCenter.Network.PPPoE.getIpTpl=function(){return"<tpl if=\"values.type=='pppoe'\">{ip:this.toEmptyDash}</tpl>"},SYNO.SDS.AdminCenter.Network.PPPoE.getBtnConfig=function(){return{editBtn:{isDisabled:function(){return"connecting"===this.selectedRecord.get("status")},handler:SYNO.SDS.AdminCenter.Network.PPPoE.onEdit},deleteBtn:{isDisabled:!0,handler:null},connectBtn:{text:function(){return"disconnected"===this.selectedRecord.get("status")?_T("vpnc","connect"):_T("vpnc","disconnect")},isDisabled:function(){return""===this.selectedRecord.get("username")},handler:SYNO.SDS.AdminCenter.Network.PPPoE.onConnect}}},SYNO.SDS.AdminCenter.Network.PPPoE.onEdit=function(){var e;!0!==_S("ha_running")?(this.module.stopPolling(),(e="disconnected"===this.selectedRecord.get("status")?new SYNO.SDS.AdminCenter.Network.PPPoE.EditDialog({module:this.module,owner:this.module.appWin}):new SYNO.SDS.AdminCenter.Network.EditDialog({module:this.module,owner:this.module.appWin,ifname:"pppoe",tabs:["ipv6"]})).addListener("destroy",(function(){this.module.startPolling()}),this),e.open()):this.module.getHAMsgBox()},SYNO.SDS.AdminCenter.Network.PPPoE.onConnect=function(){var e=SYNO.SDS.AdminCenter.Network.PPPoE.sendCommand,t=SYNO.SDS.AdminCenter.Network.PPPoE.loadFwStatus;!0!==_S("ha_running")?"disconnected"===this.selectedRecord.get("status")?!0===this.selectedRecord.get("guest_enabled")?this.module.appWin.getMsgBox().confirm(_T("pppoe","pppoe_title"),_T("pppoe","pppoe_close_guest"),(function(e){"yes"===e&&t.apply(this)}),this):t.apply(this):e.apply(this,["disconnect"]):this.module.getHAMsgBox()},SYNO.SDS.AdminCenter.Network.PPPoE.loadFwStatus=function(){var e=SYNO.SDS.AdminCenter.Network.PPPoE.sendCommand.bind(this),t=SYNO.SDS.AdminCenter.Network.PPPoE.loadFwProfileAndPortInfo.bind(this);this.sendWebAPI({api:"SYNO.Core.Security.Firewall",method:"get",version:1,callback:function(i,s){i&&s.hasOwnProperty("enable_firewall")&&s.profile_name?t({fwEnabled:s.enable_firewall,profileName:s.profile_name}):e("connect")},scope:this})},SYNO.SDS.AdminCenter.Network.PPPoE.loadFwProfileAndPortInfo=function(e){if(e&&e.profileName){var t=SYNO.SDS.AdminCenter.Network.PPPoE.sendCommand.bind(this),i=SYNO.SDS.AdminCenter.Network.PPPoE.showFwConfirmMsgBoxAndOpenWhiteListDialog.bind(this),s=[{api:"SYNO.Core.Security.Firewall.Profile",method:"get",version:1,params:{name:e.profileName}},{api:"SYNO.Core.Service.PortInfo",method:"load",version:1}];this.sendWebAPI({compound:{stopwhenerror:!0,params:s},callback:function(s,n){if(s){e.profile=SYNO.API.Response.GetValByAPI(n,"SYNO.Core.Security.Firewall.Profile","get");var o=SYNO.API.Response.GetValByAPI(n,"SYNO.Core.Service.PortInfo","load");e.profile&&o?(e.portInfo=[],SYNO.SDS.AdminCenter.Utils.Render.ServerPortsParsing(o,e.portInfo,!1),i(e)):t("connect")}else t("connect")},scope:this})}},SYNO.SDS.AdminCenter.Network.PPPoE.showFwConfirmMsgBoxAndOpenWhiteListDialog=function(e){if(e&&e.profile&&e.hasOwnProperty("fwEnabled")&&e.profileName&&e.portInfo){var t=SYNO.SDS.AdminCenter.Network.PPPoE.sendCommand.bind(this),i=e.profile;if(!i.hasOwnProperty("pppoe")||i.pppoe&&"allow"===i.pppoe.policy&&i.pppoe.rules instanceof Array&&0===i.pppoe.rules.length){var s=e.fwEnabled?_T("pppoe","pppoe_firewall_policy_change"):_T("pppoe","pppoe_firewall_enable");this.module.appWin.getMsgBox().confirm("",s,function(i){if("yes"===i){var s=new SYNO.SDS.AdminCenter.Network.PPPoE.WhiteListDialog({module:this.module,owner:this.module.appWin,serverPorts:e.portInfo,settings:e,sendCommand:t});s.setVal(""),s.open()}else t("connect")}.bind(this))}else t("connect")}},SYNO.SDS.AdminCenter.Network.PPPoE.sendCommand=function(e){if(this.sendWebAPI({api:"SYNO.Core.Network.PPPoE",method:e,version:1,params:{ifname:"pppoe"},callback:function(){this.module.connectingFlag=!1,this.module.stopPolling(),this.module.startPolling()},scope:this}),"connect"===e){this.module.connectingFlag=!0;var t=this.getTopToolbar().getComponent("connectBtn"),i=this.getTopToolbar().getComponent("editBtn");t.disable(),i.disable(),t.setText(_T("vpnc","disconnect")),this.selectedRecord.set("status","connecting")}this.module.stopPolling(),this.module.startPolling.defer(500,this.module)},Ext.define("SYNO.SDS.AdminCenter.Network.PPPoE.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner;var t=this.fillConfig(e);this.callParent([t]),this.addListener("activate",this.onActivate,this)},fillConfig:function(e){return Ext.apply({title:_T("common","alt_edit"),width:480,height:340,resizable:!1,layout:"fit",items:[this.getPPPoEForm(e)],buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","alt_apply"),disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",btnStyle:"blue",scope:this,handler:this.onApply}]},e)},getPPPoEForm:function(e){return this.panel||(this.panel=new SYNO.SDS.AdminCenter.Network.PPPoE.FormPanel({module:e.module,win:e})),this.panel},onApply:function(){var e=this.getPPPoEForm().getForm();if(!e.isDirty())return this.setStatusError({text:_T("error","nochange_subject"),clear:!0}),!1;if(!e.isValid())return this.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1;this.setStatusBusy(),this.disable();var t={api:"SYNO.Core.Network.PPPoE",method:"set",version:1,encryption:["configs"],params:{configs:[{ifname:"pppoe",real_ifname:e.findField("real_ifname").getValue(),username:e.findField("username").getValue(),password:e.findField("password").getValue(),is_default_gateway:e.findField("is_default_gateway").getValue(),mtu_config:e.findField("mtu_config").getValue()}]},callback:this.afterApply,scope:this};e.findField("password").isDirty()||delete t.params.configs[0].password,this.sendWebAPI(t)},afterApply:function(e,t,i,s){if(this.enable(),this.clearStatusBusy(),!e){SYNO.Debug("Failed to load interface info");var n=_T("common","error_system");return t.error&&t.error.code&&(n=SYNO.API.getErrorString(t.error.code)),this.setStatusError({text:n,clear:!0}),!1}this.close()},onCancel:function(){this.close()},onActivate:function(){this.callParent(arguments),this.setStatusBusy(),this.disable(),this.sendWebAPI({api:"SYNO.Core.Network.PPPoE",method:"get",version:1,params:{ifname:"pppoe"},callback:this.onLoad,scope:this})},onLoad:function(e,t,i,s){var n=this.getPPPoEForm();if(!e||!t)return SYNO.Debug("Failed to load interface info"),!1;n.setData(t),n.updatePanel(),this.enable(),this.clearStatusBusy()}}),Ext.define("SYNO.SDS.AdminCenter.Network.PPPoE.FormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t=Ext.apply({module:e.module,trackResetOnLoad:!0,items:[{xtype:"syno_displayfield",value:_T("pppoe","pppoe_intr")},{xtype:"syno_combobox",fieldLabel:_T("tcpip","tcpip_lan_port"),name:"real_ifname",editable:!1,store:new Ext.data.SimpleStore({fields:["ifname","ifstring"],data:[]}),displayField:"ifstring",valueField:"ifname",hidden:!0},{xtype:"syno_textfield",fieldLabel:_T("pppoe","pppoe_username"),name:"username",maxlength:255,allowBlank:!1},{xtype:"syno_textfield",textType:"password",fieldLabel:_T("pppoe","pppoe_password"),name:"password",maxlength:255},{xtype:"syno_combobox",vtype:"digit",fieldLabel:_T("tcpip","mtu_value_label"),name:"mtu_config",editable:!0,maxlength:256,store:[["1492","1492"]],validator:function(e){var t=this.ownerCt.getForm().findField("mtu_config").getValue();return!(1492<t||1400>t)||String.format(_T("tcpip","mtu_range_error"),1400,1492)}},{xtype:"syno_checkbox",boxLabel:_T("network","usbmodem_set_as_default_gw"),name:"is_default_gateway",checked:!1},{xtype:"syno_checkbox",name:"guest_enabled",hidden:!0}]},e);this.callParent([t])},setData:function(e){if(e.devs instanceof Array){var t=this.getForm().findField("real_ifname"),i=[];e.devs.sort(SYNO.SDS.AdminCenter.Network.Utils.SortFunc),Ext.each(e.devs,(function(e){i.push([e,SYNO.SDS.Utils.Network.idToString.apply(this,[e])])}),this),t.getStore().loadData(i)}-1==e.devs.indexOf(e.real_ifname)&&(e.real_ifname=e.devs[0]),this.getForm().setValues(e)},updatePanel:function(){var e=this.getForm().findField("real_ifname");1!==e.getStore().getCount()&&e.show()}}),Ext.define("SYNO.SDS.AdminCenter.Network.PPPoE.WhiteListDialog",{extend:"SYNO.SDS.AdminCenter.Utils.Dialog.ServPortsDialog",constructor:function(e){this.settings=e.settings,this.sendCommand=e.sendCommand;var t={dirty:!0,buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.saveAndApplyFwProfile}],listeners:{beforeclose:this.onBeforeClose.createDelegate(this)}};Ext.apply(t,e),this.callParent([t])},onBeforeClose:function(){if(this.dirty)return this.confirmLostChangePromise({save:this.saveAndApplyFwProfile,dontSave:function(){this.dirty=!1,this.close()},cancel:Ext.emptyFn},this),!1},onClose:function(){this.sendCommand("connect")},getProfile:function(){return Ext.apply(this.settings.profile,{pppoe:{policy:"drop",rules:[{enable:!0,log:!1,name:"",policy:"allow",port_direction:"destination",port_group:"service",ports:this.grid.getEnabledPorts(),protocol:this.grid.getEnabledPortsProtocol(),source_ip:"all",source_ip_group:"all"}]}})},saveAndApplyFwProfile:function(){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"set",params:{profile:this.getProfile(),profile_applying:!0}},scope:this,callback:function(e,t){if(!e)return this.clearStatusBusy(),void this.owner.getMsgBox().alert("",_T("firewall","firewall_save_failed"));this.applyProfile()}})},applyProfile:function(){this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"start",params:{name:this.settings.profileName,profile_applying:!0}},scope:this,callback:this.pollingApplyStatus})},pollingApplyStatus:function(e,t){if(!e)return this.clearStatusBusy(),void this.owner.getMsgBox().alert("",_T("firewall","fail_apply_firewall_profile"));this.polling_id=this.pollReg({interval:1,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",method:"status",params:{task_id:t.task_id},version:1},status_callback:function(e,t,i,s){if(void 0!==t.success)return!0===e&&!0===t.success||(this.stopPollingTask(),!0===t.success)?void(!0===t.success&&(this.stopPollingTask(),this.clearStatusBusy(),this.owner.getMsgBox().alert("",_T("firewall","firewall_save_success")),this.dirty=!1,this.close())):(this.clearStatusBusy(),1103===t.error.code?(this.owner.getMsgBox().alert("",_T("pppoe","pppoe_firewall_block_admin_client")),this.dirty=!1,void this.close()):void this.owner.getMsgBox().alert("",SYNO.API.getErrorString(t.error.code)))}})},stopPollingTask:function(){null!==this.polling_id&&this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"stop"},scope:this,callback:function(e,t,i){this.pollUnreg(this.polling_id),this.polling_id=null}})}}),Ext.define("SYNO.SDS.AdminCenter.Network.VPN.CreateWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){this.callParent([this.fillConfig(e)])},fillConfig:function(e){return Ext.apply({title:_T("vpnc","create_profile"),resizable:!1,width:650,height:500,fileUpload:!0,activeStep:"prtltype",steps:[this.prtltypeStep=new SYNO.SDS.AdminCenter.Network.VPN.PrtlTypeStep({headline:_T("vpnc","client_type"),itemId:"prtltype",nextId:"basic"}),this.basicStep=new SYNO.SDS.AdminCenter.Network.VPN.BasicStep({headline:_T("vpnc","basic_setting"),itemId:"basic",nextId:"advance"}),this.advanceStep=new SYNO.SDS.AdminCenter.Network.VPN.AdvanceStep({headline:_T("vpnc","adv_setting"),itemId:"advance",disableNextInDemoMode:!0,nextId:null,getNext:function(){return this.owner.onApply(),!1}})]},e)},applySetting:function(){var e;SYNO.Debug("applySetting");var t={},i=this.getStep("prtltype").getValues();Ext.apply(t,this.getStep("basic").getForm().getValues()),Ext.apply(t,this.getStep("advance").getForm().getValues()),"pptp"===i.vpnc_type?e="SYNO.Core.Network.VPN.PPTP":"l2tp"===i.vpnc_type&&(e="SYNO.Core.Network.VPN.L2TP"),this.sendWebAPI({api:e,version:1,method:"create",encryption:["pass","preshared_key"],params:t,callback:function(e,t,i,s){if(this.clearStatusBusy(),!e)return SYNO.Debug(i),void this.setStatusError({text:_T("common","error_system")});this.close()},scope:this})},onApply:function(){if(_S("demo_mode"))this.owner.getMsgBox().alert(this.title,_JSLIBSTR("uicommon","error_demo"));else{this.setStatusBusy({text:_T("common","saving")});var e=this.getStep("prtltype").getValues();"pptp"===e.vpnc_type||"l2tp"===e.vpnc_type?this.applySetting():"ovpn"!==e.vpnc_type&&"ovpn_conf"!==e.vpnc_type||this.createOVPN()}},createOVPN:function(){var e=this.getStep("advance").getForm().getValues();this.getStep("basic").createOVPN(e)},goNext:function(){this.callParent(arguments),this.getActiveStep().doLayout()}}),Ext.define("SYNO.SDS.AdminCenter.Network.VPN.PrtlTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t=Ext.apply({title:_T("vpnc","app_name"),description:_T("vpnc","select_vpnc_type"),trackResetOnLoad:!0,items:[]},e);delete t.title,t.items.push({xtype:"syno_radio",boxLabel:_T("vpnc","type_pptp"),name:"vpnc_type",hidden:SYNO.SDS.Utils.isInC2DSM(),inputValue:"pptp",checked:!SYNO.SDS.Utils.isInC2DSM()}),t.items.push({xtype:"syno_radio",boxLabel:_T("vpnc","type_ovpn_conf"),name:"vpnc_type",inputValue:"ovpn_conf"}),t.items.push({xtype:"syno_radio",boxLabel:_T("vpnc","type_l2tp"),name:"vpnc_type",inputValue:"l2tp"}),this.callParent([t])},getValues:function(){return this.getForm().getValues()}}),Ext.define("SYNO.SDS.AdminCenter.Network.VPN.BasicStep",{extend:"SYNO.SDS.Utils.FormPanel",oriConfName:"",vpnc_type:"",certs_field:"",constructor:function(e){var t=Ext.apply({cls:"syno-network-vpnclient-wizard-basic-step",itemId:"panelCrt",description:_T("vpnc","basic_setting_desc"),trackResetOnLoad:!0,fileUpload:!0,webapi:{api:"SYNO.Core.Network.VPN.OpenVPN",version:1,method:"create",scope:this},items:[{xtype:"syno_textfield",fieldLabel:_T("vpnc","profile_name"),name:"confname",width:350,allowBlank:!1,maxlength:32,vtype:"alphanum"},{xtype:"syno_textfield",fieldLabel:_T("vpnc","vpn_server"),name:"server",width:350,allowBlank:!1,maxlength:256,vtype:"iporhostname"},{xtype:"syno_textfield",fieldLabel:_T("vpnc","user"),name:"user",width:350,allowBlank:!1,maxlength:64,validator:function(e){if(Ext.form.VTypes.username_ext(e)){var t=e.match(/\\/g);return!(t&&1<t.length||0===e.search(/\\/i)||e.length-1==e.search(/\\/i))||_JSLIBSTR("vtype","bad_username")}return _JSLIBSTR("vtype","bad_username")}},{xtype:"syno_textfield",textType:"password",fieldLabel:_T("vpnc","password"),name:"pass",width:350,allowBlank:!1,maxlength:256},{xtype:"syno_textfield",width:350,textType:"password",fieldLabel:_T("vpnc","pswd_preshared"),name:"preshared_key",allowBlank:!1,validator:function(e){return!(-1!==e.search('"')||!/^[\x00-\x7F]*$/.test(e))||_T("service","service_ddns_input_warning_passwd")}},{xtype:"syno_textfield",width:350,name:"port",fieldLabel:_T("common","port"),maxlength:8,allowBlank:!1,value:"1194",vtype:"port"},{xtype:"syno_combobox",width:350,fieldLabel:_T("tcpip","wireless_protocol"),name:"protocol",editable:!1,allowBlank:!1,store:[["udp",_T("routerconf","routerconf_protocol_udp")],["tcp",_T("routerconf","routerconf_protocol_tcp")]],value:"udp"},{xtype:"syno_filebutton",width:350,fieldLabel:_T("vpnc","ovpn_conf"),name:"ovpn_file"},{xtype:"syno_filebutton",width:350,fieldLabel:_T("network","auth_ca_cert"),name:"ca_file"},this.getCertsFieldList(),{xtype:"syno_textfield",hidden:!0,name:"compress"},{xtype:"syno_textfield",hidden:!0,name:"defgw"},{xtype:"syno_textfield",hidden:!0,name:"nat"},{xtype:"syno_textfield",hidden:!0,name:"reconnect"}]},e);this.callParent([t]),this.mon(this,"afterlayout",(function(e,t){SYNO.ux.AddTip(this.getForm().findField("ca_file").getEl(),_T("vpnc","ovpn_server_cert_suggestion"))}),this,{single:!0})},getCertsFieldList:function(){var e=new SYNO.ux.InverseFieldSet({collapsedTitle:_T("router_common","more_options"),expandedTitle:_T("router_common","basic_options"),itemId:"certs_field_set",collapsed:!0,collapsible:!0,listeners:{scope:this,expand:function(){this.doLayout()},collapse:function(){this.doLayout()}},items:[{xtype:"syno_filebutton",width:350,fieldLabel:_T("vpnc","client_cert"),name:"client_crt_file"},{xtype:"syno_filebutton",width:350,fieldLabel:_T("vpnc","client_key"),name:"client_key_file"},{xtype:"syno_filebutton",width:350,fieldLabel:_T("vpnc","crl_verify_pem"),name:"pem_file"},{xtype:"syno_filebutton",width:350,fieldLabel:_T("vpnc","tls_auth_key"),name:"ta_file"}]});return this.certs_field=e,e},activate:function(){this.vpnc_type=this.owner.getStep("prtltype").getValues().vpnc_type;var e=this.getForm().findField("ca_file"),t=this.getForm().findField("port"),i=this.getForm().findField("protocol"),s=this.getForm().findField("ovpn_file"),n=this.getForm().findField("server"),o=this.certs_field;e.setVisible(!0),e.label.show(),s.setVisible(!0),s.label.show(),i.setVisible(!0),i.label.show(),t.setVisible(!0),t.label.show(),n.setVisible(!0),n.label.show(),n.allowBlank=!1,o.setVisible(!0),"ovpn_conf"===this.vpnc_type?(n.allowBlank=!0,i.setVisible(!1),i.label.hide(),t.setVisible(!1),t.label.hide(),n.setVisible(!1),n.label.hide(),n.allowBlank=!0):"ovpn"===this.vpnc_type?(s.setVisible(!1),s.label.hide(),o.setVisible(!1)):(e.setVisible(!1),e.label.hide(),s.setVisible(!1),s.label.hide(),t.setVisible(!1),t.label.hide(),i.setVisible(!1),i.label.hide(),o.setVisible(!1));var a=this.getForm().findField("preshared_key");"l2tp"===this.vpnc_type?(a.setVisible(!0),a.allowBlank=!1,a.label.show()):(a.setVisible(!1),a.allowBlank=!0,a.label.hide());var r=this.getForm().findField("confname");""===r.getValue()&&r.setValue("Connection"),this.getForm().findField("confname").focus(!0)},NameCheckDone:function(e,t,i,s){if(this.owner.clearStatusBusy(),e){var n=this.getForm().findField("confname").getValue();this.oriConfName=n,this.owner.goNext(this.nextId)}else this.owner.getMsgBox().alert(_T("vpnc","app_name"),_T("vpnc","name_conflict"),(function(){this.getForm().findField("confname").focus(!0)}),this)},getNext:function(){var e=this.getForm().findField("confname"),t=Ext.util.Format.trim(e.getValue());return e.setValue(t),this.getForm().isValid()?"ovpn_conf"!=this.vpnc_type||this.getForm().findField("ovpn_file").getValue()?"ovpn"!=this.vpnc_type||this.getForm().findField("ca_file").getValue()?"l2tp"!=this.vpnc_type||this.getForm().findField("preshared_key").getValue()?this.oriConfName!=t?(this.owner.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.Network.VPN",version:1,method:"check",params:{confname:t},callback:this.NameCheckDone,scope:this}),!1):this.nextId:(this.owner.setStatusError({text:_T("vpnc","invalid_psk"),clear:!0}),!1):(this.owner.setStatusError({text:_T("vpnc","ca_no_file"),clear:!0}),!1):(this.owner.setStatusError({text:_T("vpnc","ovpn_no_file"),clear:!0}),!1):(this.owner.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1)},createOVPN:function(e){this.getForm().setValues(e),"ovpn_conf"==this.vpnc_type&&(this.webapi.api="SYNO.Core.Network.VPN.OpenVPNWithConf"),this.upload()},onApiSuccess:function(){this.owner.clearStatusBusy(),this.owner.close()},onApiFailure:function(e,t){this.owner.clearStatusBusy();var i=SYNO.API.getErrorString(t);if(4321===t.code){var s=Ext.id();i=String.format(i,`<a id="${s}" class="link-font" href="#">`,"</a>"),this.owner.setStatusError({text:i}),Ext.get(s).addListener("click",this.launchHelp,this)}else this.owner.setStatusError({text:i})},launchHelp:function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_network_vpnclient.html"},!1)}}),Ext.define("SYNO.SDS.AdminCenter.Network.VPN.AdvanceStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t=Ext.apply(this.configForm({itemId:"form"}),e);this.callParent([t])},configForm:function(e){return Ext.apply({xtype:"form",description:_T("vpnc","adv_setting_desc"),trackResetOnLoad:!0,synodefaults:{width:250},items:[{xtype:"syno_combobox",width:350,fieldLabel:_T("vpnc","auth"),name:"auth",editable:!1,allowBlank:!1,store:[["pap","PAP"],["chap","CHAP"],["mschap","MS CHAP"],["mschap2","MS CHAP v2"]],listeners:{select:this.onSelectAuth,scope:this}},{xtype:"syno_combobox",width:350,fieldLabel:_T("vpnc","encrypt"),name:"mppe",editable:!1,allowBlank:!1,store:[["none","No MPPE"],["both","Require MPPE (40/128 bit)"],["max","Maximum MPPE (128 bit)"]]},{xtype:"syno_checkbox",boxLabel:_T("vpnc","compress"),name:"compress",checked:!1},{xtype:"syno_checkbox",boxLabel:_T("vpnc","remote_gateway"),name:"defgw",checked:!1},{xtype:"syno_checkbox",boxLabel:_T("vpnc","internet_sharing"),name:"nat",checked:!1,hidden:_S("ha_running")},{xtype:"syno_checkbox",boxLabel:_T("vpnc","server_behind_nat"),name:"behind_nat",checked:!1},{xtype:"syno_checkbox",boxLabel:_T("vpnc","auto_reconnect"),name:"reconnect",checked:!1}]},e)},onSelectAuth:function(e){var t=e.getValue();"mschap"===t||"mschap2"===t?this.getForm().findField("mppe").enable():this.getForm().findField("mppe").disable()},activate:function(){var e=this.getForm();e.setValues({auth:"mschap2",mppe:"both",compress:!0,defgw:!1,behind_nat:!1,nat:!1});var t=this.owner.getStep("prtltype").getValues().vpnc_type;"pptp"===t?(e.findField("auth").enable(),e.findField("auth").show(),e.findField("mppe").enable(),e.findField("mppe").show(),e.findField("behind_nat").disable(),e.findField("behind_nat").hide(),e.findField("compress").disable(),e.findField("compress").hide()):"l2tp"===t?(e.findField("auth").enable(),e.findField("auth").show(),e.findField("mppe").disable(),e.findField("mppe").hide(),e.findField("behind_nat").enable(),e.findField("behind_nat").show(),e.findField("compress").disable(),e.findField("compress").hide()):"ovpn"===t?(e.findField("auth").disable(),e.findField("auth").hide(),e.findField("mppe").disable(),e.findField("mppe").hide(),e.findField("behind_nat").disable(),e.findField("behind_nat").hide(),e.findField("compress").enable(),e.findField("compress").show()):"ovpn_conf"===t&&(e.findField("auth").disable(),e.findField("auth").hide(),e.findField("mppe").disable(),e.findField("mppe").hide(),e.findField("behind_nat").disable(),e.findField("behind_nat").hide(),e.findField("compress").disable(),e.findField("compress").hide())}}),Ext.ns("SYNO.SDS.AdminCenter.Network.VPN"),SYNO.SDS.AdminCenter.Network.VPN.getWebAPI=function(){var e=function(e){var t=function(e){return 10>e?"0"+e:e};Ext.each(e,(function(e,i,s){s[i].type="vpnc",s[i].real_status=e.status,"connected"===e.status||"connecting"===e.status?s[i].cls="net-vpnc-connected":s[i].cls="net-vpnc-disconnected",e.err_msg&&("disconnected"===e.status&&(s[i].status="connection_failed"),"error_auth"===e.err_msg?e.err_msg=_T("error","error_auth"):"err_server_timeout"===e.err_msg?e.err_msg=_T("vpnc","err_server_timeout"):"commfail"===e.err_msg?e.err_msg=_T("common","commfail"):"err_invalid_ca"===e.err_msg?e.err_msg=_T("vpnc","err_invalid_ca"):"err_ipsec_fail"===e.err_msg?e.err_msg=_T("vpnc","err_ipsec_fail"):"err_l2tp_fail"===e.err_msg?e.err_msg=_T("vpnc","err_l2tp_fail"):e.err_msg=_T("common","commfail")),"connected"===e.status&&(s[i].uptime=function(e){var i=e,s=Math.floor(i/86400);i%=86400;var n=Math.floor(i/3600);i%=3600;var o=Math.floor(i/60),a=i%60,r=s>0?s+_T("status","status_day")+" ":"";return r+(t(n)+":")+t(o)+":"+t(a)}(e.uptime),s[i].vpn_gateway=e.vpn_gateway,s[i].tx=e.tx+String.format(" bytes"),s[i].rx=e.rx+String.format(" bytes"))}))};return[{api:"SYNO.Core.Network.VPN.PPTP",method:"list",version:1,params:{additional:["status"]},callback:e},{api:"SYNO.Core.Network.VPN.OpenVPNWithConf",method:"list",version:1,params:{additional:["status"]},callback:e},{api:"SYNO.Core.Network.VPN.OpenVPN",method:"list",version:1,params:{additional:["status"]},callback:e},{api:"SYNO.Core.Network.VPN.L2TP",method:"list",version:1,params:{additional:["status"]},callback:e}]},SYNO.SDS.AdminCenter.Network.VPN.setARIAInfo=function(e){var t=SYNO.SDS.AdminCenter.Network.Utils;e.ariaInfo=String.format("{0} {1} ",t.getTitle(e.title,e,this),t.getStatusStr(e.status)),"connected"!=e.status&&"enabled"!=e.status||(e.ariaInfo+=String.format("{0} {1} {2} {3} {4} {5} {6} {7} {8} {9}",_T("tcpip","wimax_connected_time"),t.toEmptyDash(e.uptime),_T("vpnc","client_ip"),t.toEmptyDash(e.virtual_ip),_T("network","route_gateway"),t.toEmptyDash(e.vpn_gateway),_T("vpnc","sent"),t.toEmptyDash(e.tx),_T("vpnc","received"),t.toEmptyDash(e.rx)),e.ariaInfo=Ext.util.Format.stripTags(e.ariaInfo))},SYNO.SDS.AdminCenter.Network.VPN.getTpl=function(e){return'<tpl if="values.type==\'vpnc\'"><tpl if="values.err_msg"><tr><td colspan="2" class="syno-network-interfacelist-errmsg">{err_msg}</td></tr></tpl>'+String.format(e,_T("tcpip","wimax_connected_time"),"{uptime:this.toEmptyDash}")+String.format(e,_T("network","route_gateway"),"{vpn_gateway:this.toEmptyDash}")+String.format(e,_T("vpnc","sent"),"{tx:this.toEmptyDash}")+String.format(e,_T("vpnc","received"),"{rx:this.toEmptyDash}")+"<div>{ariaInfo:this.setARIAInfo}</div></tpl>"},SYNO.SDS.AdminCenter.Network.VPN.getIpTpl=function(){return"<tpl if=\"values.type=='vpnc'\">{virtual_ip:this.toEmptyDash}</tpl>"},SYNO.SDS.AdminCenter.Network.VPN.getBtnConfig=function(){return{editBtn:{isDisabled:function(){switch(this.selectedRecord.get("real_status")){case"connecting":case"connected":return!0;default:return!1}},handler:SYNO.SDS.AdminCenter.Network.VPN.onEdit},deleteBtn:{isDisabled:!1,handler:SYNO.SDS.AdminCenter.Network.VPN.onDelete},connectBtn:{text:function(){return"disconnected"===this.selectedRecord.get("real_status")?_T("vpnc","connect"):_T("vpnc","disconnect")},isDisabled:!1,handler:SYNO.SDS.AdminCenter.Network.VPN.onConnect}}},SYNO.SDS.AdminCenter.Network.VPN.onCreate=function(){this.module.stopPolling();for(var e=0,t=0;t<this.module.store.getCount();t++){"vpnc"===this.module.store.getAt(t).data.type&&e++}if(16<=e)return this.module.appWin.getMsgBox().alert(_T("common","create"),_T("vpnc","alt_max_config")),this.module.startPolling(),!1;var i=new SYNO.SDS.AdminCenter.Network.VPN.CreateWizard({owner:this.module.appWin,module:this.module});i.addListener("destroy",(function(){this.module.startPolling()}),this),i.open()},SYNO.SDS.AdminCenter.Network.VPN.onEdit=function(){this.module.stopPolling();var e=new SYNO.SDS.AdminCenter.Network.VPN.EditDialog({module:this.module,owner:this.module.appWin,confid:this.selectedRecord.get("id"),prtl:this.selectedRecord.get("prtl")});e.addListener("destroy",(function(){this.module.startPolling()}),this),e.open()},SYNO.SDS.AdminCenter.Network.VPN.onDelete=function(){var e;this.module.stopPolling();var t=this.selectedRecord.get("id"),i=this.selectedRecord.get("prtl"),s=this.selectedRecord.get("real_status");"pptp"===i?e="SYNO.Core.Network.VPN.PPTP":"l2tp"===i?e="SYNO.Core.Network.VPN.L2TP":"ovpn"===i?e="SYNO.Core.Network.VPN.OpenVPN":"ovpn_conf"===i&&(e="SYNO.Core.Network.VPN.OpenVPNWithConf");var n=_T("common","remove_cfrmrmv");if(!this.selectedRecord)return this.module.appWin.getMsgBox().alert(_T("common","remove"),_T("vpnc","alt_no_config_select")),!1;"disconnected"!==s&&(n=_T("vpnc","remove_connected")),this.module.appWin.getMsgBox().confirmDelete(_T("common","remove"),n).then((i=>{"confirm"===i&&this.sendWebAPI({api:e,method:"delete",version:1,params:{id:t},callback:function(){this.module.store.remove(this.selectedRecord),this.module.stopPolling(),this.module.startPolling()},scope:this}),this.module.stopPolling(),this.module.startPolling.defer(500,this.module)}))},SYNO.SDS.AdminCenter.Network.VPN.onConnect=function(){var e,t,i="",s=this.selectedRecord.get("id"),n={api:"SYNO.Core.Network.VPN",method:i="disconnected"===this.selectedRecord.get("real_status")?"connect":"disconnect",version:1,params:{id:s},callback:function(e,t){e||this.module.appWin.getMsgBox().alert(_T("vpnc","app_name"),SYNO.API.getErrorString(t)),this.module.stopPolling(),this.module.startPolling()},scope:this};if("disconnect"===i)return this.sendWebAPI(n),this.module.stopPolling(),void this.module.startPolling.defer(500,this.module);for(var o=0;o<this.module.store.getCount();o++){var a=this.module.store.getAt(o);if("vpnc"===a.data.type){var r=a.data.real_status;"connected"===r?e=a.data.confname:"connecting"===r&&(t=a.data.confname)}}if(void 0===e&&void 0===t)this.sendWebAPI(n),this.module.stopPolling(),this.module.startPolling.defer(500,this.module);else{var l;if(t)return l=String.format(_T("vpnc","conflict_connect"),t),void this.module.appWin.getMsgBox().alert(_T("vpnc","connect"),l);l=String.format(_T("vpnc","confirm_connect"),e),this.module.appWin.getMsgBox().confirm(_T("vpnc","connect"),l,(function(e){"yes"===e&&this.sendWebAPI(n),this.module.stopPolling(),this.module.startPolling.defer(500,this.module)}),this)}},Ext.define("SYNO.SDS.AdminCenter.Network.VPN.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.init()},fillConfig:function(e){return Ext.apply({title:_T("common","alt_edit"),width:790,height:460,resizable:!1,layout:"fit",items:[this.getVPNForm(e)],buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","alt_apply"),btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",scope:this,handler:this.onApply}]},e)},getVPNForm:function(e){return this.panel||(this.panel=new SYNO.SDS.AdminCenter.Network.VPN.FormPanel({module:e.module,win:e,dialogWin:this})),this.panel},onApply:function(){var e=this.getVPNForm().getForm();return e.isValid()?e.isDirty()?(this.setStatusBusy(),this.disable(),void(e.findField("confname").isDirty()?this.sendWebAPI({api:"SYNO.Core.Network.VPN",version:1,method:"check",params:{confname:Ext.util.Format.trim(e.findField("confname").getValue())},callback:this.checkNameDone,scope:this}):this.doApply())):(this.setStatusError({text:_T("error","nochange_subject"),clear:!0}),!1):(this.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1)},checkNameDone:function(e,t,i,s){if(!e)return this.module.appWin.getMsgBox().alert(_T("vpnc","app_name"),_T("vpnc","name_conflict"),(function(){this.getVPNForm().getForm().findField("confname").focus(!0)}),this),this.enable(),void this.clearStatusBusy();this.doApply()},doApply:function(){var e,t=this.getVPNForm().getForm();"pptp"===this.prtl?e="SYNO.Core.Network.VPN.PPTP":"l2tp"===this.prtl?e="SYNO.Core.Network.VPN.L2TP":"ovpn"===this.prtl?e="SYNO.Core.Network.VPN.OpenVPN":"ovpn_conf"===this.prtl&&(e="SYNO.Core.Network.VPN.OpenVPNWithConf");var i={api:e,method:"set",version:1,encryption:["pass","preshared_key"],params:t.getValues(),callback:this.afterApply,scope:this};this.sendWebAPI(i)},afterApply:function(e,t,i,s){if(!e)return SYNO.Debug("Failed to load interface info"),!1;this.enable(),this.clearStatusBusy(),this.close()},onCancel:function(){this.panel.getForm().isDirty()?this.confirmLostChangePromise({save:this.onApply,dontSave:this.close,cancel:Ext.emptyFn},this):this.close()},init:function(){var e;this.setStatusBusy(),this.disable(),"pptp"===this.prtl?e="SYNO.Core.Network.VPN.PPTP":"l2tp"===this.prtl?e="SYNO.Core.Network.VPN.L2TP":"ovpn"===this.prtl?e="SYNO.Core.Network.VPN.OpenVPN":"ovpn_conf"===this.prtl&&(e="SYNO.Core.Network.VPN.OpenVPNWithConf"),this.sendWebAPI({api:e,method:"list",version:1,callback:this.onLoad,scope:this})},onLoad:function(e,t,i,s){var n=this.getVPNForm();if(!e||!t)return SYNO.Debug("Failed to load interface info"),!1;n.setData(t,this.id),this.enable(),this.clearStatusBusy()}}),Ext.define("SYNO.SDS.AdminCenter.Network.VPN.FormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t=e.win.prtl,i=[{xtype:"hidden",name:"prtl"},{xtype:"hidden",name:"id"},{xtype:"syno_displayfield",width:350,indent:1,fieldLabel:_T("vpnc","vpn_method"),name:"method"},{xtype:"syno_textfield",width:350,indent:1,fieldLabel:_T("vpnc","profile_name"),name:"confname",maxlength:32,allowBlank:!1,vtype:"alphanum"},{xtype:"ovpn_conf"===t?"hidden":"syno_textfield",width:350,indent:1,fieldLabel:_T("vpnc","vpn_server"),name:"server",maxlength:256,allowBlank:!1},{xtype:"syno_textfield",width:350,indent:1,fieldLabel:_T("vpnc","user"),name:"user",maxlength:64,allowBlank:!1,validator:function(e){if(Ext.form.VTypes.username_ext(e)){var t=e.match(/\\/g);return!(t&&1<t.length||0===e.search(/\\/i)||e.length-1==e.search(/\\/i))||_JSLIBSTR("vtype","bad_username")}return _JSLIBSTR("vtype","bad_username")}},{xtype:"syno_textfield",width:350,indent:1,textType:"password",fieldLabel:_T("vpnc","password"),name:"pass",maxlength:256,allowBlank:!1}];"l2tp"===t&&i.push({xtype:"syno_textfield",width:350,indent:1,textType:"password",fieldLabel:_T("vpnc","pswd_preshared"),name:"preshared_key",maxlength:256,allowBlank:!1,validator:function(e){return!(-1!==e.search('"')||!/^[\x00-\x7F]*$/.test(e))||_T("service","service_ddns_input_warning_passwd")}}),"pptp"!==t&&"l2tp"!==t||i.push({xtype:"syno_combobox",width:350,indent:1,fieldLabel:_T("vpnc","auth"),name:"auth",editable:!1,allowBlank:!1,store:[["pap","PAP"],["chap","CHAP"],["mschap","MS CHAP"],["mschap2","MS CHAP v2"]],listeners:{select:this.onSelectAuth,scope:this}}),"pptp"===t&&i.push({xtype:"syno_combobox",width:350,indent:1,fieldLabel:_T("vpnc","encrypt"),name:"mppe",editable:!1,allowBlank:!1,store:[["none","No MPPE"],["both","Require MPPE (40/128 bit)"],["max","Maximum MPPE (128 bit)"]]}),"ovpn"===t&&(i.push({xtype:"syno_textfield",fieldLabel:_T("common","port"),width:350,indent:1,name:"port",maxlength:8,allowBlank:!1,value:"1194",vtype:"port"}),i.push({xtype:"syno_combobox",width:350,indent:1,fieldLabel:_T("tcpip","wireless_protocol"),name:"protocol",editable:!1,allowBlank:!1,store:[["udp",_T("routerconf","routerconf_protocol_udp")],["tcp",_T("routerconf","routerconf_protocol_tcp")]],value:"udp"}),i.push({xtype:"syno_checkbox",indent:1,boxLabel:_T("vpnc","compress"),name:"compress",checked:!1})),i.push({xtype:"syno_checkbox",indent:1,boxLabel:_T("vpnc","remote_gateway"),name:"defgw",checked:!1,hidden:_S("ha_running")&&("ovpn_conf"===t||"ovpn"===t)},{xtype:"syno_checkbox",indent:1,boxLabel:_T("vpnc","internet_sharing"),name:"nat",checked:!1,hidden:_S("ha_running")}),"l2tp"===t&&i.push({xtype:"syno_checkbox",indent:1,boxLabel:_T("vpnc","server_behind_nat"),name:"behind_nat",checked:!1}),i.push({xtype:"syno_checkbox",indent:1,boxLabel:_T("vpnc","auto_reconnect"),name:"reconnect",checked:!1}),"ovpn"!==t&&"ovpn_conf"!==t||(this.dialogWin=e.dialogWin,i.push(this.configCAFields()));var s=Ext.apply({module:e.module,trackResetOnLoad:!0,items:i},e);this.callParent([s])},configCAFields:function(){return[{xtype:"syno_button",name:"ca_import",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",id:this.CaBtnId=Ext.id(),text:_T("vpnc","import_ca"),indent:1,handler:this.caImportBtn,scope:this}]},caImportBtn:function(){SYNO.Debug("caImportBtn"),new SYNO.SDS.AdminCenter.Network.VPN.UploadWin({owner:this.dialogWin}).open()},onSelectAuth:function(e){var t=e.getValue();this.getForm().findField("mppe")&&("mschap"===t||"mschap2"===t?this.getForm().findField("mppe").enable():this.getForm().findField("mppe").disable())},setData:function(e){for(var t=this.getForm(),i=0;i<e.length;i++)if(e[i].id===this.ownerCt.confid){var s,n,o=e[i].prtl;"pptp"===o?s=_T("vpnc","type_pptp"):"l2tp"===o?s=_T("vpnc","type_l2tp"):"ovpn"===o?s=_T("vpnc","type_ovpn"):"ovpn_conf"===o&&(s=_T("vpnc","type_ovpn_conf")),n={method:s},t.setValues(Ext.apply(n,e[i]));break}t.findField("auth")&&t.findField("mppe")&&("pap"===t.findField("auth").getValue()||"chap"===t.findField("auth").getValue())&&t.findField("mppe").disable(),t.findField("user").getValue()||t.findField("pass").setValue("")}}),Ext.define("SYNO.SDS.AdminCenter.Network.VPN.UploadWin",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t;return this.uploadForm=new SYNO.SDS.AdminCenter.Network.VPN.UploadForm({owner:this,confid:e.owner.confid,prtl:e.owner.prtl}),t={title:_T("vpnc","import_ca"),resizable:!1,width:570,height:"ovpn_conf"===e.owner.prtl?350:200,buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.close},{xtype:"syno_button",text:_T("common","apply"),btnStyle:"blue",scope:this,handler:this.uploadCert,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""}],items:[this.uploadForm]},Ext.apply(t,e),t},uploadCert:function(){this.uploadForm.uploadCert()}}),Ext.define("SYNO.SDS.AdminCenter.Network.VPN.UploadForm",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.prtl=e.prtl;var t={cls:"syno-network-vpnclient-edit-uploadform",fileUpload:!0,trackResetOnLoad:!0,hideMode:"offsets",frame:!1,border:!1,height:120,items:[{xtype:"syno_displayfield",value:_T("vpnc","import_ca_desc")},{xtype:"syno_filebutton",fieldLabel:_T("network","auth_ca_cert"),name:"ca_file"},{xtype:"syno_textfield",hidden:!0,name:"id",value:e.confid}],webapi:{api:"ovpn_conf"===this.prtl?"SYNO.Core.Network.VPN.OpenVPNWithConf.Certs":"SYNO.Core.Network.VPN.OpenVPN.CA",method:"upload",version:1}};return"ovpn_conf"===this.prtl&&(t.items.push(this.getCertsFieldList()),t.height=250),Ext.apply(t,e),t},getCertsFieldList:function(){return new SYNO.ux.InverseFieldSet({collapsedTitle:_T("router_common","more_options"),expandedTitle:_T("router_common","basic_options"),itemId:"certs_field_set",collapsed:!0,collapsible:!0,items:[{xtype:"syno_filebutton",fieldLabel:_T("vpnc","client_cert"),name:"client_crt_file"},{xtype:"syno_filebutton",fieldLabel:_T("vpnc","client_key"),name:"client_key_file"},{xtype:"syno_filebutton",fieldLabel:_T("vpnc","crl_verify_pem"),name:"pem_file"},{xtype:"syno_filebutton",fieldLabel:_T("vpnc","tls_auth_key"),name:"ta_file"}]})},onApiSuccess:function(){this.owner.clearStatusBusy(),this.owner.close()},onApiFailure:function(e,t){this.owner.clearStatusBusy();var i=SYNO.API.getErrorString(t);if(4321===t.code){var s=Ext.id();i=String.format(i,`<a id="${s}" class="link-font" href="#">`,"</a>"),this.owner.getMsgBox().alert(_T("vpnc","app_name"),i),Ext.get(s).addListener("click",this.launchHelp,this)}else this.owner.setStatusError({text:i})},launchHelp:function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_network_vpnclient.html"},!1)},uploadCert:function(){"ovpn_conf"===this.prtl||this.getForm().findField("ca_file").getValue()?this.getForm().findField("ca_file").getValue()||this.getForm().findField("client_crt_file").getValue()||this.getForm().findField("client_key_file").getValue()||this.getForm().findField("pem_file").getValue()||this.getForm().findField("ta_file").getValue()?(this.owner.setStatusBusy(),this.upload()):this.owner.setStatusError({text:_T("error","error_nochoosefile"),clear:!0}):this.owner.setStatusError({text:_T("vpnc","ca_no_file"),clear:!0})}}),Ext.define("SYNO.SDS.AdminCenter.Network.Bond.CreateWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){this.ifname="wizard",this.owner=e.owner,this.module=e.module,this.callParent([this.fillConfig(e)]),this.addListener("destroy",this.module.startPolling,this.module)},fillConfig:function(e){return this.store=new SYNO.SDS.AdminCenter.Network.InterfaceStore({module:this.module,autoDestroy:!0,data:[],fields:["enabled","id","status","ip","mask","mtu","mtu_config","vlan_id","use_dhcp","enable_vlan","link_status","speed","duplex","ifname","gateway","dns","is_default_gateway","max_supported_speed"],getWebAPIs:function(){return[Ext.apply(SYNO.SDS.AdminCenter.Network.Ethernet.getWebAPI(),{callback:function(e){e[0]&&(e[0].enabled=!0),e[1]&&(e[1].enabled=!0),SYNO.SDS.AdminCenter.Network.Ethernet.getWebAPI().callback(e)}})]},listeners:{update:function(e,t,i){Ext.data.Record.EDIT===i&&this.checkState()},scope:this}}),Ext.apply({cls:"syno-network-bond-wizard",title:_T("network","linkaggr_enable"),resizable:!1,width:700,height:580,layout:"fit",steps:[this.modeStep=new SYNO.SDS.AdminCenter.Network.Bond.ModeStep({module:this.module,win:this,bondType:e.bondType}),this.linkStep=new SYNO.SDS.AdminCenter.Network.Bond.LinkStep({module:this.module,win:this}),this.ipconfigStep=new SYNO.SDS.AdminCenter.Network.Bond.IPConfigStep({module:this.module,win:this,bondType:e.bondType})]},e)},onOpen:function(){this.callParent(arguments),SYNO.Debug("onOpen"),this.store.load({scope:this,afterload:this.onLoad})},onApply:function(){SYNO.Debug("onApply"),this.getMsgBox().confirm("",_T("network","create_bond_confirm"),(function(e){"yes"===e&&(this.setStatusBusy({text:_T("common","saving")}),this.SendAPI())}),this)},DoSet:function(){this.sendWebAPI({api:"SYNO.Core.Network.Bond",version:1,method:"create",params:{ipconfig:this.getIPConfig(),mode:this.modeStep.getForm().findField("mode").getGroupValue(),slaves:this.getEnabledSlaves()},callback:function(e,t,i,s){if(e){var n="SYNO.SDS.CMS.Application"===this.findAppWindow().getOpenConfig("className"),o=!0===this.findAppWindow().getOpenConfig("cms_self");n&&!o||!t||(this.removeListener("destroy",this.module.startPolling,this.module),SYNO.SDS.AdminCenter.Network.Utils.Redirect.apply(this,[t.redirect,t.secure,t.ip_list,t.port,t.auth_key,"SYNO.SDS.AdminCenter.Network.Main",6e4])),this.clearStatusBusy(),this.enable(),this.close()}else{var a=SYNO.API.getErrorString(t.code);if(this.clearStatusBusy(),4318==t.code){var r=t.errors.ifname,l=t.errors.block,d="";0<(8&l)?d="MailPlus Server":0<(4&l)&&(d="Virtual Machine Manager"),a=String.format(_T("network","interface_block_msg"),SYNO.SDS.Utils.Network.idToString(r),d)}this.getMsgBox().alert(_T("network","linkaggr_enable"),a,(function(e){this.close()}),this)}},scope:this})},SendAPI:function(){this.sendWebAPI({api:"SYNO.Core.Network.Bond",version:1,method:"create_check",params:{ipconfig:this.getIPConfig(),slaves:this.getEnabledSlaves()},callback:function(e,t,i,s){if(e)this.DoSet();else{var n="",o=0;if(this.clearStatusBusy(),4319==t.code)if(t.errors.hard){for(o=0;o<t.errors.hard.length;++o)n+="<br>"+SYNO.SDS.Utils.GetFeasibilityCheckMsg(t.errors.hard[o]);this.getMsgBox().alert("",_T("network","net_iface_change_stop")+"<br>"+n,(function(e){this.close()}),this)}else if(t.errors.soft){for(o=0;o<t.errors.soft.length;++o)n+="<br>"+SYNO.SDS.Utils.GetFeasibilityCheckMsg(t.errors.soft[o]);this.getMsgBox().confirm("",_T("network","net_iface_change_confirm")+"<br>"+n,(function(e){"yes"===e?this.DoSet():"no"===e&&this.close()}),this)}else this.module.appWin.getMsgBox().alert(_T("network","remove_bond"),SYNO.API.getErrorString(t.code));else this.module.appWin.getMsgBox().alert(_T("network","remove_bond"),SYNO.API.getErrorString(t.code))}},scope:this})},onClose:function(){SYNO.Debug("onClose")},onLoad:function(){this.store.removeAt(this.store.find("id",_D("oob_interface"))),SYNO.Debug("onLoad")},checkState:function(){this.isSelectTwo()?this.getButton("next").enable():this.getButton("next").disable()},isSelectTwo:function(){for(var e=0,t=0;t<this.store.getCount();t++)if(this.store.getAt(t).get("enabled")&&(e+=1),2<=e)return!0;return!1},getMinSupSpeedEnabled:function(){for(var e=null,t=0;t<this.store.getCount();t++)this.store.getAt(t).get("enabled")&&(null===e||e.data.max_supported_speed>this.store.getAt(t).data.max_supported_speed)&&(e=this.store.getAt(t));return e},getEnabledSlaves:function(){var e=[];return this.store.each((function(t){!0===t.get("enabled")&&e.push(t.get("ifname"))}),this),e},getIPConfig:function(){var e=this.ipconfigStep.getForm(),t={use_dhcp:e.findField("use_dhcp").getValue(),enable_vlan:e.findField("enable_vlan").getValue(),is_default_gateway:e.findField("is_default_gateway").getValue()};return!1===t.use_dhcp&&(t.ip=e.findField("ip").getValue(),t.mask=e.findField("mask").getValue(),t.gateway=e.findField("gateway").getValue(),t.dns=e.findField("dns").getValue()),!0===e.findField("manual_adjust_mtu").getValue()?t.mtu=e.findField("mtu_config").getValue():t.mtu=1500,!0===t.enable_vlan&&(t.vlan_id=e.findField("vlan_id").getValue()),t}}),Ext.define("SYNO.SDS.AdminCenter.Network.Bond.ModeStep",{extend:"SYNO.SDS.AdminCenter.Network.BondModeTab",constructor:function(e){this.owner=e.owner,this.module=e.module;var t=Ext.apply({headline:_T("network","linkaggr_mode"),itemId:"ModeStep",nextId:"LinkStep"},e);this.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.Network.Bond.LinkStep",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.owner=e.owner,this.module=e.module,this.callParent([this.fillConfig(e)])},fillConfig:function(e){var t=this,i=new SYNO.ux.EnableColumn({dataIndex:"enabled",width:40,align:"center",isIgnore:function(e,t){return t.get("id")===_D("oob_interface")},bindRowClick:!0});return Ext.apply({headline:_T("network","bond_slaves"),itemId:"LinkStep",getNext:function(){var e,t=!1,i=this.store.getRange(),s=this.win.modeStep.getForm().findField("mode").getGroupValue();if("active-backup"===s||"ovs-active-backup"===s)return"IPConfigStep";for(var n=0;n<i.length;n++)i[n].data.enabled&&"connected"===i[n].data.status&&(void 0===e?e=i[n].data.speed:e!==i[n].data.speed&&(t=!0));return t?(this.win.getMsgBox().confirm(this.title,_T("network","bond_diff_speed_confirm"),(function(e){"yes"===e&&this.owner.goNext("IPConfigStep")}),this),!1):"IPConfigStep"},stripeRows:!0,cls:"without-dirty-red-grid",enableHdMenu:!1,autoExpandColumn:"link_status",selectable:!1,columns:[i,{id:"id",dataIndex:"id",header:_T("common","name"),align:"left",sortable:!0,renderer:function(e){return SYNO.SDS.Utils.Network.idToString.apply(t,[e,"lan"])}},{id:"link_status",dataIndex:"link_status",header:_T("tcpip","link_status"),align:"left",sortable:!0,renderer:function(e,t,i){return SYNO.SDS.AdminCenter.Network.Utils.GetLinkStatus(i.get("speed"),i.get("duplex"),i.get("mtu"))}}],plugins:[i],bbar:"yes"===_D("support_oob_ctl")?new Ext.Container({xtype:"container",items:[{xtype:"syno_displayfield",itemId:"linkAggregationNoteId",htmlEncode:!1,width:550,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("oob","oob_link_aggregation_not_support_note"),height:60}]}):void 0,store:e.win.store},e)}}),Ext.define("SYNO.SDS.AdminCenter.Network.Bond.IPConfigStep",{extend:"SYNO.SDS.AdminCenter.Network.IPv4Tab",constructor:function(e){this.owner=e.owner,this.module=e.module;var t=Ext.apply({headline:_T("setupwizard","netinfo_title"),itemId:"IPConfigStep",nextId:null,disableNextInDemoMode:!0,getNext:function(){return this.isValid()?(this.win.onApply(),!1):(this.win.setStatusError({text:_T("common","forminvalid")}),!1)}},e);this.callParent([t])},activate:function(){var e=this.win.getMinSupSpeedEnabled();this.fillContent(e.data)}}),Ext.ns("SYNO.SDS.AdminCenter.Network.Bond"),SYNO.SDS.AdminCenter.Network.Bond.getWebAPI=function(){return{api:"SYNO.Core.Network.Bond",method:"list",version:2,callback:function(e){Ext.each(e,(function(e,t,i){"connected"===e.status?i[t].cls="net-bond-connected":i[t].cls="net-bond-disconnected",i[t].slaves.sort(SYNO.SDS.AdminCenter.Network.Utils.SortFunc)}))}}},SYNO.SDS.AdminCenter.Network.Bond.getBtnConfig=function(){return{editBtn:{isDisabled:!1,handler:SYNO.SDS.AdminCenter.Network.Bond.onEdit},deleteBtn:{isDisabled:!0===_S("ha_runnign"),handler:SYNO.SDS.AdminCenter.Network.Bond.onDelete},connectBtn:{isDisabled:!0,handler:null}}},SYNO.SDS.AdminCenter.Network.Bond.resetSMBInfo=function(){this.SMBMultichannelEnabled=void 0},SYNO.SDS.AdminCenter.Network.Bond.checkSMBPromise=function(){return new Promise(function(e,t){let i=function(){this.module.appWin.setStatusBusy(null,_T("common","loading")),this.sendWebAPIPromise({api:"SYNO.Core.FileServ.SMB",version:3,method:"set",params:{enable_multichannel:!1,enable_samba:!0}}).then((t=>{this.module.appWin.clearStatus(),this.SMBMultichannelEnabled=!1,e()})).catch((e=>{this.module.appWin.clearStatus(),this.module.appWin.getMsgBox().alert("",SYNO.API.getErrorString(e.code)),t()}))}.bind(this),s=function(){!1!==this.SMBMultichannelEnabled?this.module.appWin.getMsgBox().confirm("",_T("network","smb_confirm_disable_multichannel")).then((e=>{"confirm"===e?i():t()})):e()}.bind(this);void 0===this.SMBMultichannelEnabled?this.getKnownAPI("SYNO.Core.FileServ.SMB")?(this.module.appWin.setStatusBusy(null,_T("common","loading")),this.sendWebAPIPromise({api:"SYNO.Core.FileServ.SMB",version:3,method:"get"}).then((e=>{this.module.appWin.clearStatus(),this.SMBMultichannelEnabled=!!e.enable_samba&&e.enable_multichannel,s()})).catch((e=>{this.module.appWin.clearStatus(),this.module.appWin.getMsgBox().alert("",SYNO.API.getErrorString(e.code)),t()}))):e():s()}.bind(this))},SYNO.SDS.AdminCenter.Network.Bond.onCreate=function(){if(!1===_S("ha_allow_bond_manage"))return void this.module.getHAMsgBox();if(!0===this.module.glusterComputingOrStorage)return void this.module.getGlusterBox();SYNO.SDS.AdminCenter.Network.Bond.checkSMBPromise.call(this).then(function(){this.module.stopPolling(),new SYNO.SDS.AdminCenter.Network.Bond.CreateWizard({owner:this.module.appWin,module:this.module,bondType:this.module.bondType}).open()}.bind(this)).catch(Ext.emptyFn)},SYNO.SDS.AdminCenter.Network.Bond.onEdit=function(){if(!1!==_S("ha_allow_bond_manage")){this.module.stopPolling();var e=12&this.selectedRecord.get("block");if(0<e){var t=this.selectedRecord.get("id")?this.selectedRecord.get("id"):this.selectedRecord.get("ifname"),i=this.selectedRecord.get("type"),s="";return 0<(8&e)?s="MailPlus Server":0<(4&e)&&(s="Virtual Machine Manager"),void this.module.appWin.getMsgBox().alert("",String.format(_T("network","interface_block_msg"),SYNO.SDS.Utils.Network.idToString(t,i),s))}new SYNO.SDS.AdminCenter.Network.EditDialog({module:this.module,owner:this.module.appWin,ifname:this.selectedRecord.get("ifname"),tabs:["bond_mode","ipv4","ipv6","auth"]}).open()}else this.module.getGoToHAMsgBox()},SYNO.SDS.AdminCenter.Network.Bond.DoDelete=function(){this.module.stopPolling(),this.module.appWin.setStatusBusy(null,_T("common","applying")),this.sendWebAPI({api:"SYNO.Core.Network.Bond",version:1,method:"delete",params:{ifname:this.selectedRecord.get("ifname")},callback:function(e,t,i,s){if(this.module.appWin.clearStatus(),e){var n="SYNO.SDS.CMS.Application"===this.findAppWindow().getOpenConfig("className"),o=!0===this.findAppWindow().getOpenConfig("cms_self");n&&!o||!t?this.module.startPolling():SYNO.SDS.AdminCenter.Network.Utils.Redirect.apply(this,[t.redirect,t.secure,t.ip_list,t.port,t.auth_key,null,void 0,t.conflict_dev])}else this.module.appWin.getMsgBox().alert(_T("network","remove_bond"),SYNO.API.getErrorString(t.code))},scope:this})},SYNO.SDS.AdminCenter.Network.Bond.onDelete=function(){var e=12&this.selectedRecord.get("block");if(4===e);else if(0<e){var t=this.selectedRecord.get("id")?this.selectedRecord.get("id"):this.selectedRecord.get("ifname"),i=this.selectedRecord.get("type"),s="";return 0<(8&e)&&(s="MailPlus Server"),void this.module.appWin.getMsgBox().alert("",String.format(_T("network","interface_block_msg"),SYNO.SDS.Utils.Network.idToString(t,i),s))}!1!==_S("ha_allow_bond_manage")?!0!==this.module.glusterComputingOrStorage?(this.module.appWin.setStatusBusy(null,_T("common","loading")),this.sendWebAPI({api:"SYNO.Core.Network.Bond",version:1,method:"delete_check",params:{ifname:this.selectedRecord.get("ifname")},callback:function(e,t,i,s){if(this.module.appWin.clearStatus(),e)this.module.appWin.getMsgBox().confirmDelete(_T("network","remove_bond"),_T("network","remove_bond_confirm")).then((e=>{"confirm"===e&&SYNO.SDS.AdminCenter.Network.Bond.DoDelete.createDelegate(this)()}));else if(4319==t.code){var n="",o=0;if(t.errors.hard){for(o=0;o<t.errors.hard.length;++o)n+="<br>"+SYNO.SDS.Utils.GetFeasibilityCheckMsg(t.errors.hard[o]);this.module.appWin.getMsgBox().alert("",_T("network","net_iface_change_stop")+"<br>"+n,this)}else if(t.errors.soft){for(o=0;o<t.errors.soft.length;++o)n+="<br>"+SYNO.SDS.Utils.GetFeasibilityCheckMsg(t.errors.soft[o]);this.module.appWin.getMsgBox().confirm("",_T("network","net_iface_change_confirm")+"<br>"+n,(function(e){"yes"===e&&SYNO.SDS.AdminCenter.Network.Bond.DoDelete.createDelegate(this)()}),this)}else this.module.appWin.getMsgBox().alert(_T("network","remove_bond"),SYNO.API.getErrorString(t.code))}},scope:this})):this.module.getGlusterBox():this.module.getHAMsgBox()},Ext.define("SYNO.SDS.AdminCenter.Network.InterfaceStore",{extend:"Ext.data.JsonStore",constructor:function(e){this.owner=e.owner;var t=Ext.apply({fields:["ariaInfo","title","status","ifname","type","cls","iconCls","id","block","ip","ipv6","mask","mtu","mtu_config","vlan_id","use_dhcp","enable_ha_ip","enable_vlan","link_status","speed","duplex","max_supported_speed","mode","error","slaves","ha_local_ip","ha_local_mask","real_ifname","username","guest_enabled","confname","prtl","uptime","virtual_ip","vpn_gateway","tx","rx","err_msg","real_status"]},e);this.callParent([t])},getWebAPIs:function(){return this.webapis||(this.webapis=[SYNO.SDS.AdminCenter.Network.Bond.getWebAPI(),SYNO.SDS.AdminCenter.Network.Ethernet.getWebAPI()],SYNO.SDS.Utils.isInC2DSM()||SYNO.SDS.Utils.isInAliDSM()||_S("ha_not_support_pppoe")||this.webapis.push(SYNO.SDS.AdminCenter.Network.PPPoE.getWebAPI()),this.webapis=this.webapis.concat(SYNO.SDS.AdminCenter.Network.VPN.getWebAPI())),this.webapis},load:function(e){this.callback=e,e.scope?(e.scope.ifname&&"wizard"===e.scope.ifname?e.scope:e.scope.appWin).sendWebAPI({compound:{stopwhenerror:!1,params:this.getWebAPIs()},callback:this.onLoad,scope:this}):SYNO.Debug("no scope")},onLoad:function(e,t,i,s){if(!this.module.connectingFlag){var n=this.getWebAPIs(),o=[];if(!e||!t||!t.result)return SYNO.Debug("Failed to load interface info"),!1;Ext.each(t.result,(function(e,t,i){e.data?(n[t].callback(e.data),Ext.each(e.data,(function(e,t,i){e.id||(e.ifname?i[t].id=e.ifname:e.interface_name&&(i[t].id=e.interface_name))}),this),o=o.concat(e.data)):e.api?SYNO.Debug("Failed to get data from ["+e.api+"]"):SYNO.Debug("Failed to get data from ["+t+"]")}),this),this.loadData(o,!0),this.singleSort("id","ASC"),this.each((function(e){var t=!1;Ext.each(o,(function(i,s,n){i.id===e.get("id")&&(t=!0)}),this),t||(SYNO.Debug("Remove "+e.get("id")),this.remove(e))}),this),this.callback&&this.callback.afterload&&this.callback.afterload instanceof Function&&this.callback.afterload.apply(this.callback.scope)}},createSortFunction:function(e,t){var i="DESC"===(t=t||"ASC").toUpperCase()?-1:1;return function(t,s){var n=0,o=/^(ovs_)?([a-z]+)([0-9]*)(\.?)([0-9]*)$/,a=o.exec(t.data[e]),r=o.exec(s.data[e]);if(a instanceof Array&&r instanceof Array&&0===(n=a[2]>r[2]?1:a[2]<r[2]?-1:0)){var l=parseInt(a[3],10)||0,d=parseInt(r[3],10)||0;n=l>d?1:l<d?-1:0}return i*n}}}),Ext.define("SYNO.SDS.AdminCenter.Network.ExpandableListView",{extend:"SYNO.ux.ExpandableListView",constructor:function(e){this.owner=e.owner;var t=Ext.apply({useARIA:!0,innerTpl:this.getInnerTpl(e),trackResetOnLoad:!1,singleSelect:!0,multiSelect:!1,cls:"syno-network-interfacelist"},e);this.callParent([t]),this.addTplRenderer()},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div class="item-wrap {cls}" role="option" aria-expanded="false" id={[Ext.id()]} aria-label="{ariaInfo}">','<div class="item-summary">','<div class="item-icon {iconCls}"></div>','<table class="syno-network-interfacelist-summary-row">',"<tr>","<td>",'<div class="item-title">{title:this.getTitle}</div>',"</td>",'<td class="selectabletext">','<div class="syno-network-interfacelist-assignment-type">',"<tpl if=\"values.type=='lan' || values.type=='wan' || values.type=='bond' || values.type=='ovseth' || values.type=='ovsbond'\">","{[values.use_dhcp? _T('network', 'ip_assign_dhcp'): _T('network', 'ip_assign_static')]}","</tpl>",'</div">',"</td>","</tr>","<tr>",'<td class="syno-network-interfacelist-key">','<div class="item-status">{status:this.getStatus}</div>',"</td>",'<td class="selectabletext">','<div class="syno-network-interfacelist-ip-address">',SYNO.SDS.AdminCenter.Network.Ethernet.getIpTpl(),SYNO.SDS.AdminCenter.Network.PPPoE.getIpTpl(),SYNO.SDS.AdminCenter.Network.VPN.getIpTpl(),"</div>","</td>","</tr>","</table>",this.innerTpl?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':"","</div>",'<div class="item-detail syno-network-interfacelist-item-detail" style="display:none">',this.innerTpl?this.innerTpl.html:"","</div>","</div>","</tpl>",'<div class="x-clear"></div>')},getInnerTpl:function(e){var t="<tr>"+('<td class="syno-network-interfacelist-key">{0}'+_T("common","colon")+"</td>")+'<td class="syno-network-interfacelist-value selectabletext">{1}</td></tr>';return new Ext.XTemplate('<div class="item-detail-inner">','<table class="syno-network-interfacelist-row">',SYNO.SDS.AdminCenter.Network.Ethernet.getTpl(t),SYNO.SDS.AdminCenter.Network.PPPoE.getTpl(t),SYNO.SDS.AdminCenter.Network.VPN.getTpl(t),"</table>","</div>")},addTplRenderer:function(){var e=this.tpl,t=this;e.setARIAInfo=function(e,i){switch(i.type){case"lan":case"wan":case"bond":SYNO.SDS.AdminCenter.Network.Ethernet.setARIAInfo.apply(t,[i]);break;case"pppoe":SYNO.SDS.AdminCenter.Network.PPPoE.setARIAInfo.apply(t,[i]);break;case"vpnc":SYNO.SDS.AdminCenter.Network.VPN.setARIAInfo.apply(t,[i])}return""},e.toYesNo=function(e,t){return SYNO.SDS.AdminCenter.Network.Utils.toYesNo(e)},e.toEmptyDash=function(e,t){return SYNO.SDS.AdminCenter.Network.Utils.toEmptyDash(e)},e.toMultiLine=function(e,t){return SYNO.SDS.AdminCenter.Network.Utils.toMultiLine(e)},e.getLinkStatus=function(e,t){return SYNO.SDS.AdminCenter.Network.Utils.getLinkStatus(e,t)},e.getTitle=function(e,i){return SYNO.SDS.AdminCenter.Network.Utils.getTitle(e,i,t)},e.getStatus=function(e,t){return SYNO.SDS.AdminCenter.Network.Utils.getStatus(e)},e.getSignal=function(e,t){return SYNO.SDS.AdminCenter.Network.Utils.getSignal(e)}}}),Ext.define("SYNO.SDS.AdminCenter.Network.ServiceOrderGridPanel",{extend:"SYNO.ux.DDGridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.IpType="ipv4",this.GridStore=this.createGridStore(),this.tbar=new Ext.Toolbar({defaultType:"syno_button",items:this.configToolBar()});var t=Ext.apply({tbar:this.tbar,store:this.GridStore,viewConfig:{markDirty:!1,ddGroup:"ServiceOrderDD"},columns:[{header:_T("network","interface"),dataIndex:"ifname",align:"left",fixed:!0,width:252,renderer:function(e,t,i,s,n,o){return"vpn-client"===i.data.class?"VPN":SYNO.SDS.Utils.Network.idToString(e)}},{header:_T("network","route_gateway"),dataIndex:"gateway",align:"left",fixed:!0,width:252}],enableDragDrop:!0,enableColumnMove:!1,enableHdMenu:!1,monitorWindowResize:!0,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),listeners:{scope:this,resize:this.adjustColumnWidth}},e);this.callParent([t])},adjustColumnWidth:function(){var e=(this.getWidth()-17)/2,t=this.getColumnModel();t&&(t.setColumnWidth(0,e),t.setColumnWidth(1,e))},onActivate:function(e){this.parentDialog.setStatusBusy({text:_T("common","loading")}),this.GridStore.load(),this.parentDialog.clearStatusBusy()},configToolBar:function(){return["->",{xtype:"syno_combobox",id:this.ipTypeId=Ext.id(),editable:!1,allowBlank:!1,store:this.getIPTypeStore(),value:"ipv4",listeners:{scope:this,select:this.onTypeChange}}]},createGridStore:function(){return new SYNO.SDS.AdminCenter.Network.ServiceOrderStore({module:this.module,owner:this})},onMoveRow:function(e){var t=this.getStore(),i=this.getSelectionModel().getSelected(),s=t.indexOf(i);this.getView().focusRow(s),(s+=e?-1:1)<0||s>t.getCount()-1||(t.remove(i),t.insert(s,i),this.getView().focusRow(s),this.getSelectionModel().selectRecords([i]))},onTypeChange:function(e){this.IpType=e.getValue(),this.parentDialog.setStatusBusy({text:_T("common","loading")}),this.getStore().load({params:{iptype:this.IpType,type:"wan"},scope:this}),this.parentDialog.clearStatusBusy()},getButton:function(e){var t,i=this.getTopToolbar();return i&&(t=i.getComponent(e)),t},getIPTypeStore:function(){return!0===_S("ha_not_support_ipv6")?[["ipv4","IPv4"]]:[["ipv4","IPv4"],["ipv6","IPv6"]]},setButton:function(e,t){var i=this.getButton(e);i&&i[t?"enable":"disable"]()},isDirty:function(){return this.GridStore.isDirty()},onApply:function(){var e=this.GridStore.getRange(),t=[];this.isDirty()?(this.parentDialog.setStatusBusy({text:_T("common","saving")}),Ext.each(e,(function(e){t.push(e.data.ifname)})),this.sendWebAPI({api:"SYNO.Core.Network.Router.Gateway.List",method:"set",version:1,scope:this,params:{iptype:this.IpType,ifnames:t},callback:this.onSaveDone})):this.parentDialog.setStatusError({text:_T("error","nochange_subject"),clear:!0})},onSaveDone:function(e,t,i){this.parentDialog.clearStatusBusy();var s=_T("common","error_system");if(!e)return t&&t.code&&(s=SYNO.API.getErrorString(t.code)),void this.parentTab.setStatusError({text:s,clear:!0});this.parentDialog.close()}}),Ext.define("SYNO.SDS.AdminCenter.Network.ServiceOrderStore",{extend:"SYNO.API.JsonStore",constructor:function(e){this.module=e.module,this.owner=e.owner;var t=Ext.apply({api:"SYNO.Core.Network.Router.Gateway.List",appWindow:this.owner,method:"get",baseParams:{iptype:"ipv4",type:"wan"},version:1,autoDestroy:!0,root:"configs",fields:["ifname","gateway","class"],listeners:{load:this.onAfterLoad}},e);this.callParent([t])},onAfterLoad:function(e,t,i){0>=t.length?this.owner.getView().el.mask(_T("network","route_gateway_order_intro")):this.owner.getView().el.unmask()},isDirty:function(){return this.getModifiedRecords().length>0}}),Ext.define("SYNO.SDS.AdminCenter.Network.ServiceOrderDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.ServiceOrderGridPanel=new SYNO.SDS.AdminCenter.Network.ServiceOrderGridPanel({module:this.module,appWin:this.module.appWin,owner:this.owner,itemId:"ServiceOrderGridPanel",parentDialog:this});var t=Ext.apply({title:_T("network","edit_route_gateway_order"),autoDestroy:!0,width:560,height:350,layout:"fit",border:!1,padding:"16px 20px 0 20px",items:[this.ServiceOrderGridPanel],buttons:[{xtype:"syno_button",btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",btnStyle:"blue",text:_T("common","apply"),scope:this,handler:this.onApply}]},e);this.callParent([t]),this.onActivate()},onActivate:function(){this.callParent(arguments),this.ServiceOrderGridPanel.onActivate()},onApply:function(){this.ServiceOrderGridPanel.onApply()},onCancel:function(){this.close()}}),Ext.define("SYNO.SDS.AdminCenter.Network.InterfaceTab",{extend:"Ext.Panel",constructor:function(e){e.module&&(this.module=e.module),this.owner=e.module.appWin,this.sendWebAPI({api:"SYNO.Core.Network.Ethernet.External",method:"check",params:{},version:1,scope:this,callback:this.loadErrors}),this.callParent([this.fillConfig(e)]),this.getView().addListener("afterrender",(function(){0===this.module.getStore().getCount()&&this.owner.setStatusBusy()}),this),this.addListener("activate",(function(){this.activated=!0,this.module.stopPolling(),this.module.startPolling()}),this),this.addListener("deactivate",(function(){this.activated=!1}),this)},loadErrors:function(e,t,i){var s;e&&(Ext.each(t,(function(e){"exceed_max_num_ifaces"===e.error&&(s=e)}),this),s?(Ext.getCmp(this.errorMessageId).setValue(String.format(_T("network","warning_num_nic_limit"),s.max_num,s.slot_IDs.join(" "))),this.bbar.removeClass("off-error-message"),this.doLayout()):(this.bbar.addClass("off-error-message"),this.doLayout()))},fillConfig:function(e){return Ext.apply({cls:"syno-network-interfacetab",title:_T("network","interface"),layout:"fit",tbar:this.getToolbar(),bbar:this.getBottombar(),items:[this.getView()]},e)},getToolbar:function(){return this.tbar||(this.tbar=new Ext.Toolbar({defaultType:"syno_button",items:[{xtype:"syno_button",text:_T("common","create"),itemId:"create_dropdown",name:"create_dropdown",disabled:!0,btnStyle:"grey",menu:new SYNO.ux.Menu({cls:"syno-network-interface-menu",items:[{iconCls:"syno-network-interface-menu-item",text:_T("network","create_bond"),scope:this,id:this.createBondBtnId=Ext.id(),handler:SYNO.SDS.AdminCenter.Network.Bond.onCreate,disabled:!0,hidden:!SYNO.SDS.Utils.Network.isMultiLan.apply(this)||SYNO.SDS.Utils.isInVirtualDSM()},{iconCls:"syno-network-interface-menu-item",text:_T("vpnc","create_vpn"),scope:this,id:this.createVPNBtnId=Ext.id(),handler:SYNO.SDS.AdminCenter.Network.VPN.onCreate,hidden:!1}]})},{text:_T("common","alt_edit"),itemId:"editBtn",scope:this,disabled:!0,handler:null},{text:_T("common","delete"),itemId:"deleteBtn",scope:this,disabled:!0,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",handler:null},{text:_T("vpnc","connect"),itemId:"connectBtn",scope:this,disabled:!0,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",handler:null},{xtype:"syno_button",text:_T("network","network_manage"),itemId:"create_dropdown_network_man",name:"create_dropdown_network_man",disabled:!0,hidden:SYNO.SDS.Utils.isInC2DSM()||SYNO.SDS.Utils.isInAliDSM(),menu:new SYNO.ux.Menu({cls:"syno-network-interface-menu",items:[{text:_T("network","route_gateway_order"),scope:this,handler:this.onServiceOrder,iconCls:"syno-network-interface-menu-item",hidden:_S("version")<4966},{text:_T("ovs","ovs_setting"),scope:this,handler:this.onOvsSetting,iconCls:"syno-network-interface-menu-item",hidden:SYNO.SDS.Utils.isInVirtualDSM()||"yes"===_D("dockerdsm")||"yes"!==_D("support_ovs")}]})}]})),this.tbar},getBottombar:function(){return this.bbar||(this.bbar=new Ext.Toolbar({height:76,cls:"syno-network-interfacelist-bottombar-show",items:[{xtype:"syno_displayfield",cls:"error-message",id:this.errorMessageId=Ext.id()}]})),this.bbar},getView:function(){return this.view||(this.view=new SYNO.SDS.AdminCenter.Network.ExpandableListView({panel:this,owner:this.owner,store:this.module.getStore()}),this.view.mon(this.view,"selectionchange",(function(e){this.updateSelectedRecord(),this.updateToolbarStatus()}),this),this.view.mon(this.view,"containercontextmenu",this.onContainerContextMenu,this),this.view.mon(this.view,"contextmenu",this.onContextMenu,this)),this.view},onContextMenu:function(e,t,i,s){e.isSelected(i)||e.select(i),this.showContextMenu(s)},onContainerContextMenu:function(e,t){0!==e.getSelectionCount()&&this.showContextMenu(t)},showContextMenu:function(e){var t,i=[];((t=this.getTopToolbar().getComponent("editBtn")).disabled||i.push({text:t.getText(),scope:this,itemId:"editBtn",handler:t.handler}),(t=this.getTopToolbar().getComponent("deleteBtn")).disabled||i.push({text:t.getText(),scope:this,itemId:"deleteBtn",handler:t.handler}),(t=this.getTopToolbar().getComponent("connectBtn")).disabled||i.push({text:t.getText(),scope:this,itemId:"connectBtn",handler:t.handler}),0!==i.length)&&new SYNO.ux.Menu({autoDestroy:!0,items:i}).showAt(e.getXY());e.preventDefault()},afterLoad:function(){this.updateSelectedRecord(),this.updateToolbarStatus(),this.enableTopToolbar(),this.owner.clearStatus()},enableTopToolbar:function(){var e=this.getTopToolbar();e?Ext.each(["create_dropdown","create_dropdown_network_man"],(function(t){var i=e.getComponent(t);i&&i.enable()}),this):SYNO.Debug("failed to get toptoolbar")},updateSelectedRecord:function(){var e=this.getView().getSelectedRecords();e&&e[0]?this.selectedRecord=e[0]:this.selectedRecord=null},updateToolbarStatus:function(){var e=this.getBtnTable(),t=null;t=this.selectedRecord?this.selectedRecord.get("type"):"default",this.updateCreateBondBtnStatus(),this.updateCreateVPNBtnStatus(),Ext.each(["editBtn","deleteBtn","connectBtn"],(function(i){var s=this.getTopToolbar().getComponent(i);if(s){var n=!1,o="";switch(typeof e[t][i].isDisabled){case"boolean":n=e[t][i].isDisabled;break;case"function":n=e[t][i].isDisabled.apply(this);break;default:return void SYNO.Debug("no isDisabled")}switch((SYNO.SDS.Utils.isInC2DSM()||SYNO.SDS.Utils.isInAliDSM())&&"vpnc"!==t&&(n=!0),typeof e[t][i].text){case"string":o=e[t][i].text;break;case"function":o=e[t][i].text.apply(this)}""!==o&&s.setText(o),s.setDisabled(n),s.handler=e[t][i].handler}}),this)},getBtnTable:function(){return this.btnTable||(this.btnTable={default:{editBtn:{isDisabled:!0,handler:null},deleteBtn:{isDisabled:!0,handler:null},connectBtn:{isDisabled:!0,handler:null}},lan:SYNO.SDS.AdminCenter.Network.Ethernet.getBtnConfig(),wan:SYNO.SDS.AdminCenter.Network.Ethernet.getBtnConfig(),ovseth:SYNO.SDS.AdminCenter.Network.Ethernet.getBtnConfig(),ovsbond:SYNO.SDS.AdminCenter.Network.Bond.getBtnConfig(),bond:SYNO.SDS.AdminCenter.Network.Bond.getBtnConfig(),vpnc:SYNO.SDS.AdminCenter.Network.VPN.getBtnConfig(),pppoe:SYNO.SDS.AdminCenter.Network.PPPoE.getBtnConfig()},_S("demo_mode")&&Ext.iterate(this.btnTable,(function(e,t,i){var s=i[e].deleteBtn,n=i[e].connectBtn;s.isDisabled=!0,n.isDisabled=!0}),this)),this.btnTable},updateCreateBondBtnStatus:function(){var e=Ext.getCmp(this.createBondBtnId),t=0;this.module.store.each((function(e){switch(e.get("type")){case"lan":case"wan":case"ovseth":t+=1}}),this),e.setDisabled(2>t)},updateCreateVPNBtnStatus:function(){},onServiceOrder:function(e,t){new SYNO.SDS.AdminCenter.Network.ServiceOrderDialog({module:this.module,owner:this.module.appWin}).open()},onOvsSetting:function(){new SYNO.SDS.AdminCenter.Network.OvsSettingDialog({module:this.module,owner:this.module.appWin}).open()}}),Ext.define("SYNO.SDS.AdminCenter.Network.SimpleIFStore",{extend:"Ext.data.JsonStore",constructor:function(e){this.module=e.module,this.owner=e.owner,this.apiGetIFArray=this.createAPIGetIFArray();var t=Ext.apply({fields:["id","type","status","display"]},e);this.callParent([t])},createAPIGetIFArray:function(){return[{webapi:{api:"SYNO.Core.Network.Interface",method:"list",version:1}}]},loadInterface:function(){for(var e=[],t=0;t<this.apiGetIFArray.length;t++)e.push(this.apiGetIFArray[t].webapi);this.owner.sendWebAPI({params:{},scope:this,compound:{stopwhenerror:!1,params:e},callback:this.loadIFStore})},loadIFStore:function(e,t,i){e?this.fillIFStore(t,i):this.module.appWin.getMsgBox().alert(_T("common","note"),_T("common","commfail"))},fillIFRecords:function(e){var t=[];return Ext.each(e,(function(e){if(!0!==_S("ha_not_support_pppoe")||"pppoe"!==e.ifname){var i={};i.id=e.ifname,i.type=e.type,i.status=e.status,i.display=SYNO.SDS.Utils.Network.idToString.apply(this.module.appWin,[e.ifname,e.type]),t.push(i)}}),this),t},fillIFStore:function(e,t){for(var i=!1,s=[],n=0;n<e.result.length;n++){i=!1;for(var o=0;o<this.apiGetIFArray.length;o++)if(!0===SYNO.ux.Utils.checkApiConsistency(this.apiGetIFArray[o].webapi,e.result[n])){i=!0;break}if(!0===i){if(!0!==e.result[n].success)return void this.module.appWin.getMsgBox().alert(_T("common","note"),_T("common","commfail"));"SYNO.Core.Network.Interface"===t.compound[n].api&&(e.result[n].data.sort(SYNO.SDS.AdminCenter.Network.Utils.SortFunc),s=this.fillIFRecords(e.result[n].data))}}this.loadData(s,!1)},isDirty:function(){return this.getModifiedRecords().length>0}}),Ext.ns("SYNO.SDS.AdminCenter.Utils.Validator"),SYNO.SDS.AdminCenter.Utils.Validator.MarkPortsExceed=function(e,t,i){var s=e.findField(t).getValue().split(","),n=SYNO.SDS.AdminCenter.Security.Utils.FW_MAX_PORTS_IN_A_RULE;if("TC"===i&&(n=SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_PORTS_IN_A_RULE),s.length>n){var o=String.format(_T("firewall","firewall_field_exceed_multiports"),n);return e.findField(t).markInvalid(o),!1}return!0},SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField=function(e,t){for(var i=0;i<t.length;i++)if(""===e.findField(t[i]).getValue())return e.findField(t[i]).markInvalid(_T("firewall","firewall_field_blank_alert")),!1;return!0},SYNO.SDS.AdminCenter.Utils.Validator.ExchgLessThanField=function(e,t,i){var s=parseInt(e.findField(t).getValue(),10),n=parseInt(e.findField(i).getValue(),10);s>=n&&(e.findField(t).setValue(n),e.findField(i).setValue(s))},SYNO.SDS.AdminCenter.Utils.Validator.FQDNConflictChecker=function(){var e=[];this.FindListFQDNPortPair=function(t,i){t.module.appWin.setStatusBusy(),"SYNO.Core.Web.DSM"!==i&&t.sendWebAPI({api:"SYNO.Core.Web.DSM",method:"get",version:2,callback:function(t,i){Ext.isEmpty(i.fqdn)||(e.push({fqdn:i.fqdn.toLowerCase(),port:80}),e.push({fqdn:i.fqdn.toLowerCase(),port:443}))},scope:this}),"SYNO.Core.AppPortal"!==i&&t.sendWebAPI({api:"SYNO.Core.AppPortal",method:"list",version:2,callback:function(t,i){Ext.each(i.portal,(function(t){Ext.isEmpty(t.fqdn)||(e.push({fqdn:t.fqdn.toLowerCase(),port:80}),e.push({fqdn:t.fqdn.toLowerCase(),port:443}))}),this)},scope:this}),"SYNO.Core.AppPortal.ReverseProxy"!==i&&t.sendWebAPI({api:"SYNO.Core.AppPortal.ReverseProxy",method:"list",version:1,callback:function(t,i){Ext.each(i.entries,(function(t){Ext.isEmpty(t.frontend.fqdn)||e.push({fqdn:t.frontend.fqdn.toLowerCase(),port:t.frontend.port})}),this)},scope:this}),"SYNO.WebStation.HTTP.VHost"!==i&&t.getKnownAPI("SYNO.WebStation.HTTP.VHost")&&t.sendWebAPI({api:"SYNO.WebStation.HTTP.VHost",method:"list",version:1,callback:function(t,i){Ext.each(i.hosts,(function(t){if(!Ext.isEmpty(t.fqdn)){var i=t.fqdn.toLowerCase();t.port.http&&Ext.each(t.port.http,(function(t){e.push({fqdn:i,port:t})}),this),t.port.https&&Ext.each(t.port.https,(function(t){e.push({fqdn:i,port:t})}),this)}}),this)},scope:this}),t.module.appWin.clearStatus()},this.IsConflict=function(t,i){var s=!1;return t=t.toLowerCase(),Ext.each(e,(function(e){if(e.fqdn===t&&e.port===i)return s=!0,!1}),this),s}},Ext.define("SYNO.SDS.AdminCenter.Network.TcCustomPortsDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=this.createPanel(),this.form=this.panel.getForm();var t={width:560,height:335,title:_T("firewall","firewall_ports_self_defined"),layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onApply}]};Ext.apply(t,e),this.callParent([t]),this.DefineBehaviors()},createPanel:function(){var e={padding:"0",border:!1,items:[{xtype:"syno_combobox",name:"port_type",hiddenName:"port_type",fieldLabel:_T("firewall","firewall_port_type"),displayField:"display",labelWidth:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH+50,width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,valueField:"value",value:"src",store:new Ext.data.ArrayStore({autoDestroy:!0,fields:["value","display"],data:[["src",_T("firewall","firewall_port_type_source")],["dest",_T("firewall","firewall_port_type_dest")]]})},{xtype:"syno_combobox",name:"protocol",labelWidth:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_LABEL_WIDTH+50,fieldLabel:_T("firewall","firewall_protocol"),fields:["value","display"],width:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,displayField:"display",valueField:"value",value:"tcp",scope:this,store:new Ext.data.ArrayStore({autoDestroy:!0,fields:["value","display"],data:[["tcp",_T("firewall","firewall_protocol_tcp")],["udp",_T("firewall","firewall_protocol_udp")],["gre",_T("firewall","firewall_protocol_gre_extend")],["esp",_T("firewall","firewall_protocol_esp_extend")],["all",_T("firewall","firewall_ports_all")]]}),listeners:{scope:this,select:function(e,t,i){this.disableComponents(this.owner.isVpnProtocol(t.get("value")))}}},{xtype:"syno_compositefield",hideLabel:!0,name:"firewall_port_composite",labelWidth:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_LABEL_WIDTH,fieldLabel:_T("firewall","firewall_ports")+_T("firewall","firewall_split_by_common"),itemId:"firewall_ports_container",defaultMargins:"0 0 0 0",items:[{xtype:"syno_radio",name:"self_port_choose",boxLabel:_T("firewall","firewall_ports")+_T("firewall","firewall_split_by_common")+_T("common","colon"),itemId:"firewall_ports",id:this.firewall_ports_id=Ext.id(),width:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_LABEL_WIDTH+50,inputValue:"ports"},{xtype:"syno_textfield",name:"self_ports_value",width:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,validateOnBlur:!0,vtype:"fwports"}]},{xtype:"syno_radio",boxLabel:_T("firewall","firewall_ports_range"),name:"self_port_choose",width:2*SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_LABEL_WIDTH,itemId:"firewall_ports_range",id:this.firewall_ports_range_id=Ext.id(),inputValue:"ports_range"},{xtype:"syno_numberfield",width:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,indent:1,labelWidth:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_LABEL_WIDTH+50,fieldLabel:_T("ftp","ftp_port_from"),validateOnBlur:!0,name:"self_ports_range_from",maxlength:5,vtype:"port"},{xtype:"syno_numberfield",width:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,indent:1,labelWidth:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_LABEL_WIDTH+50,fieldLabel:_T("ftp","ftp_port_to"),validateOnBlur:!0,name:"self_ports_range_to",maxlength:5,vtype:"port"}]};return new SYNO.ux.FormPanel(e)},DefineBehaviors:function(){this.enableRadioGroipDummy=new SYNO.ux.Utils.EnableRadioGroup(this.form,"self_port_choose",{ports_range:["self_ports_range_from","self_ports_range_to"],ports:["self_ports_value"]}),this.radioPortsRange=Ext.getCmp(this.firewall_ports_range_id),this.radioPorts=Ext.getCmp(this.firewall_ports_id),this.comboPortType=this.form.findField("port_type")},onApply:function(){this.validateForm(this.form)&&(this.owner.setCustom(this.getValue()),this.close())},validateForm:function(e){if(this.owner.isVpnProtocol(e.findField("protocol").getValue()))return!0;var t=e.findField("self_port_choose").getGroupValue();if(!e.isValid())return!1;if("ports"==t){if(!SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["self_ports_value"])||!SYNO.SDS.AdminCenter.Utils.Validator.MarkPortsExceed(e,"self_ports_value","TC"))return!1}else if("ports_range"==t&&(SYNO.SDS.AdminCenter.Utils.Validator.ExchgLessThanField(e,"self_ports_range_from","self_ports_range_to"),!SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["self_ports_range_from","self_ports_range_to"])))return!1;return!0},getSelfPorts:function(){var e=this.form.findField("self_port_choose").getGroupValue(),t="";return"ports"==e?t=this.form.findField("self_ports_value").getValue():"ports_range"==e&&(t=String.format("{0}-{1}",this.form.findField("self_ports_range_from").getValue(),this.form.findField("self_ports_range_to").getValue())),t},getValue:function(){var e={protocol:"",port_num:"",port_direction:""};return e.protocol=this.form.findField("protocol").getValue(),e.port_direction=this.comboPortType.getValue(),this.owner.isVpnProtocol(e.protocol)||(e.port_num=this.getSelfPorts()),e},setValue:function(e,t,i){var s="",n="";e.indexOf("-")>0?(s=e.split("-")[0],n=e.split("-")[1],this.form.findField("self_port_choose").setValue("ports_range"),this.form.findField("self_ports_range_from").setValue(s),this.form.findField("self_ports_range_to").setValue(n)):(this.form.findField("self_port_choose").setValue("ports"),this.form.findField("self_ports_value").setValue(e)),this.form.findField("port_type").setValue(t),this.form.findField("protocol").setValue(i),this.disableComponents(this.owner.isVpnProtocol(i))},disableComponents:function(e){this.comboPortType.setDisabled(e),this.radioPorts.setDisabled(e),this.radioPortsRange.setDisabled(e),this.form.findField("self_ports_value").setDisabled(e),this.form.findField("self_ports_range_from").setDisabled(e),this.form.findField("self_ports_range_to").setDisabled(e)}}),Ext.define("SYNO.SDS.AdminCenter.Network.TcRuleDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.portInfo=e.portInfo,this.direction=e.direction,this.winHeight=e.winHeight,this.panel=this.createPanel(),this.form=this.panel.getForm(),this.tips={tc_rate_max:{info:_T("firewall","firewall_tc_rate_desc")}};var t={dsmStyle:"v5",width:630,height:this.winHeight,resizable:!1,title:_T("firewall","firewall_tc_rule_add"),items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onUpdateRuleGrid}],tips:this.tips};Ext.apply(t,e),this.callParent([t]),this.DefineBehaviors()},initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){for(var e in this.tips)this.tips.hasOwnProperty(e)&&SYNO.ux.AddTip(this.form.findField("tc_rate_max").getEl(),this.tips[e].info)}),this,{single:!0})},DefineBehaviors:function(){this.btnChoose=Ext.getCmp(this.btnChooseId),this.btnSelfDefine=Ext.getCmp(this.btnSelfDefineId),this.btnSrcDefine=Ext.getCmp(this.btnSrcDefineId)},createPanel:function(){var e=[{xtype:"syno_radio",itemId:"firewall_ports_all",boxLabel:_T("firewall","firewall_ports_all"),name:"ports",inputValue:"all",checked:!0,scope:this,handler:this.onCheckPorts},{xtype:"syno_compositefield",hideLabel:!0,id:this.servPortFieldID=Ext.id(),items:[{xtype:"syno_radio",itemId:"firewall_ports_system",boxLabel:_T("firewall","firewall_ports_system"),name:"ports",width:1.7*SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,inputValue:"system",checked:!1,scope:this,handler:this.onCheckPorts},{xtype:"syno_button",text:_T("common","choose"),scope:this,autoWidth:!0,id:this.btnChooseId=Ext.id(),handler:function(e,t){var i=new SYNO.SDS.AdminCenter.Utils.Dialog.ServPortsDialog({module:this.module,owner:this,serverPorts:this.portInfo});i.setVal(this.serviceChoose),i.open()}}]},{xtype:"syno_compositefield",itemId:"custom_ports_fieldset",hideLabel:!0,items:[{xtype:"syno_radio",boxLabel:_T("firewall","firewall_ports_self_defined"),name:"ports",width:1.7*SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,checked:!1,inputValue:"self-defined",scope:this,handler:this.onCheckPorts},{xtype:"syno_button",id:this.btnSelfDefineId=Ext.id(),text:_T("firewall","firewall_ports_self_defined"),scope:this,autoWidth:!0,handler:function(e,t){var i=new SYNO.SDS.AdminCenter.Network.TcCustomPortsDialog({module:this.module,owner:this});i.setValue(this.customVal.port_num,this.customVal.port_direction,this.customVal.protocol),i.open()}}]}],t={xtype:"syno_fieldset",title:_T("firewall","firewall_ports"),itemId:"firewall_ports",hideLabel:!0,items:e},i={xtype:"syno_fieldset",title:_T("firewall","firewall_tc_bandwidth_settings"),itemId:"bandwidth_settings",items:[{xtype:"syno_numberfield",width:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH-10,labelWidth:1.7*SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,fieldLabel:_T("firewall","firewall_tc_rate_min"),name:"tc_rate_min",itemId:"tc_rate_min",maxlength:7,vtype:"number"},{xtype:"syno_numberfield",width:SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH-10,labelWidth:1.7*SYNO.SDS.AdminCenter.Network.Utils.TC_DEFAULT_INPUT_WIDTH,fieldLabel:_T("firewall","firewall_tc_rate_max"),name:"tc_rate_max",itemId:"tc_rate_max",maxlength:7}]},s={border:!1,width:590,height:450,padding:"0 0 0 0",items:[t,{xtype:"syno_fieldset",title:_T("firewall","firewall_source"),itemId:"firewall_source",id:this.ipFieldID=Ext.id(),items:[{xtype:"syno_radio",name:"source",itemId:"firewall_ports_all",boxLabel:_T("firewall","firewall_ports_all"),inputValue:"all",scope:this,checked:!0,handler:this.onCheckSrc},{xtype:"syno_compositefield",itemId:"specific_source_fieldset",hideLabel:!0,items:[{xtype:"syno_radio",name:"source",boxLabel:_T("firewall","firewall_specific_ip"),inputValue:"specific_source",width:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,scope:this,handler:this.onCheckSrc},{xtype:"syno_button",id:this.btnSrcDefineId=Ext.id(),text:_T("common","choose"),scope:this,width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,handler:function(e,t){new SYNO.SDS.AdminCenter.Network.TcSrcIpDialog({module:this.module,owner:this,GridStore:this.GridStore}).open(this.source_ip)}}]}]},i]};return new SYNO.ux.FormPanel(s)},onOpen:function(){var e;this.setStatusBusy();var t=this.module.getPanel().getActiveTab().GridPanel;this.setDefault(),"add"==this.mode?this.setTitle(_T("firewall","firewall_tc_rule_add")):"edit"==this.mode&&(this.setTitle(_T("firewall","firewall_tc_rule_edit")),e=t.getSelectionModel().getSelected(),this.setValue(e)),this.onCheckPorts(),this.onCheckSrc(this.panel.getForm().findField("source")),this.gridRules=t,this.clearStatusBusy(),this.callParent(arguments)},setDefault:function(){this.customVal={port_num:"",port_direction:"src",protocol:"tcp"},this.source_ip="",this.source_subnet_mask="",this.serviceChoose="",this.ruleRecord=new SYNO.SDS.AdminCenter.Network.Utils.TcRULERecord({id:0,enabled:!0,port_type:"",port_num:"",port_direction:"src",protocol:"",minrate:-1,maxrate:-1}),this.ipDirection="dest",Ext.getCmp(this.ipFieldID).hide()},getRecordInForm:function(){var e,t,i,s;return e=this.getPorts(),t=this.getRate(),i=this.getIpDirection(),s=this.getSrc(),new SYNO.SDS.AdminCenter.Network.Utils.TcRULERecord({id:this.ruleRecord.get("id"),enabled:this.ruleRecord.get("enabled"),port_type:e.port_type,port_num:e.port_num,port_direction:e.port_direction,protocol:e.protocol,minrate:t.min,maxrate:t.max,source:s,ip_direction:i})},onUpdateRuleGrid:function(){var e,t,i=this.gridRules.GridStore;this.validateForm(this.form)&&(e=this.getRecordInForm(),"add"==this.mode?i.add(e):"edit"==this.mode&&((t=this.gridRules.getSelectionModel().getSelected()).set("enabled",e.get("enabled")),t.set("port_type",e.get("port_type")),t.set("port_num",e.get("port_num")),t.set("port_direction",e.get("port_direction")),t.set("protocol",e.get("protocol")),t.set("minrate",e.get("minrate")),t.set("maxrate",e.get("maxrate")),t.set("source",e.get("source")),t.set("ip_direction",e.get("ip_direction")),t.set("port_direction",e.get("port_direction"))),this.close())},setValue:function(e){this.ruleRecord=e,this.setPorts(e.get("port_type"),e.get("port_num"),e.get("port_direction"),e.get("protocol")),this.setRate(e.get("minrate"),e.get("maxrate")),this.setSrc(e.get("source"))},setRate:function(e,t){this.form.findField("tc_rate_min").setValue(e),this.form.findField("tc_rate_max").setValue(t)},getRate:function(){var e={min:"",max:""};return e.min=this.form.findField("tc_rate_min").getValue(),e.max=this.form.findField("tc_rate_max").getValue(),e},setPorts:function(e,t,i,s){var n="";if("ALL"==e)n="all";else if("SYS"==e)n="system",this.serviceChoose=t;else{if("SELF"!=e)return;n="self-defined",this.customVal={port_num:t,port_direction:i,protocol:s}}this.form.findField("ports").setValue(n),this.setServicesProtocol(s)},getPorts:function(){var e=this.form.findField("ports").getGroupValue(),t={port_type:"",port_num:"",port_direction:"src",protocol:""},i="";return t.protocol="","all"==e?(t.port_type="ALL",t.protocol="all"):"system"==e?(t.port_type="SYS",t.port_num=this.getServices(),t.protocol=this.getServicesProtocol()):"self-defined"==e&&(i=this.getCustom(),t.port_type="SELF",t.port_num=i.port_num,t.port_direction=i.port_direction,t.protocol=i.protocol),t},getSrc:function(){var e=this.form.findField("source").getGroupValue();return"all"==e?"all":"subnet"==e?String.format("{0}/{1}",this.srouce_ip,this.source_subnet_mask):this.source_ip},setSrc:function(e){var t="",i="";if(e||(e="all"),"all"===e)this.source_ip="all",i="all";else if(e.indexOf("-")>0)this.source_ip=e,i="specific_source";else if(e.indexOf("/")>0){var s=e.split("/");s[0],t=s[1],this.source_ip=e,this.source_subnet_mask=t,i="specific_source"}else this.source_ip=e,i="specific_source";this.form.findField("source").setValue(i)},onCheckSrc:function(e){e.checked&&("specific_source"===e.value?this.btnSrcDefine.enable():this.btnSrcDefine.disable())},getIpDirection:function(){return this.ipDirection},getServices:function(){return this.serviceChoose},setServices:function(e){this.serviceChoose=e},getServicesProtocol:function(){return this.servicesProtocol},setServicesProtocol:function(e){this.servicesProtocol=e},getCustom:function(){return this.customVal},setCustom:function(e){this.customVal=e},onCheckPorts:function(){var e=this.panel.getForm().findField("ports").getGroupValue();"system"==e?this.btnChoose.enable():this.btnChoose.disable(),"self-defined"==e?this.btnSelfDefine.enable():this.btnSelfDefine.disable()},isVpnProtocol:function(e){return-1!==["gre","esp"].indexOf(e)},validateBlank:function(e){var t=e.findField("ports").getGroupValue(),i=e.findField("source").getGroupValue();return"system"==t&&""===this.serviceChoose?(this.getMsgBox().alert(_T("firewall","firewall_tc"),_T("firewall","firewall_no_choose_service")),!1):"self-defined"!=t||""!==this.customVal.port_num||this.isVpnProtocol(this.getCustom().protocol)?"all"===i||""!==this.source_ip||(this.getMsgBox().alert(_T("firewall","firewall_tc"),_T("firewall","firewall_no_set_ip")),!1):(this.getMsgBox().alert(_T("firewall","firewall_tc"),_T("firewall","firewall_no_set_ports")),!1)},validateForm:function(e){var t=e.findField("tc_rate_min").getValue(),i=e.findField("tc_rate_max").getValue();return!!e.isValid()&&(!!this.validateBlank(e)&&(0!==i&&t>i?(this.getMsgBox().alert(_T("firewall","firewall_tc"),_T("firewall","firewall_tc_warning")),!1):SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_RATE<i?(this.getMsgBox().alert(_T("firewall","firewall_tc"),String.format(_T("firewall","firewall_tc_ceil_limit"),SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_RATE)),!1):!(SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_RATE<t)||(this.getMsgBox().alert(_T("firewall","firewall_tc"),String.format(_T("firewall","firewall_tc_rate_limit"),SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_RATE)),!1)))}}),Ext.define("SYNO.SDS.AdminCenter.Network.TcTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=Ext.apply(e,{owner:this,portInfo:e.owner.portInfo}),i=Ext.apply({layout:"fit",padding:"0 0 0 0",cls:"syno-network-tctab",items:[this.GridPanel=new SYNO.SDS.AdminCenter.Network.TcGridPanel(t)]},e);this.callParent([i]),this.setCustomFormFunc()},setCustomFormFunc:function(){this.getForm().items.items.push(this.GridPanel)},isDirty:function(){return this.GridPanel.isDirty()},getApiArray:function(e){return"set"===e?[this.GridPanel.getApiSaveRules()]:[]},processParams:function(e,t){return"set"===e?this.GridPanel.getApiSaveRules():[]},processReturnData:function(e,t,i){this.GridPanel.processReturnData(e,t,i)}}),Ext.define("SYNO.SDS.AdminCenter.Network.TcGridPanel",{extend:"SYNO.ux.DDGridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.portInfo=e.portInfo,this.IFStore=e.IFStore,this.ifname="",this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enabled",enableFastSelectAll:!0,menuDisabled:!0,sortable:!1,width:120,align:"center",tooltip:_T("common","enabled"),listeners:{selectall:{fn:this.onChgButtonStatus,scope:this}}}),this.GridStore=this.createGridStore(),this.tbar=new Ext.Toolbar({defaultType:"syno_button",items:this.configToolBar()});var t=Ext.apply({padding:"0 0 0 0",tbar:this.tbar,store:this.GridStore,cls:"syno-network-tctab-gridpanel",viewConfig:{markDirty:!1,ddGroup:"TrafficControlDD",emptyText:['<div class="syno-dataview">','<div class="empty-text-wrap">','<div class="empty-text-inner-wrap">','<div class="empty-text-icon"></div>','<div class="empty-text">',_T("common","no_item"),"</div>","</div>","</div>","</div>"].join("")},plugins:[this.enableColumn],columns:[this.enableColumn,{id:"tc_service",header:_T("firewall","firewall_ports"),dataIndex:"port_num",width:150,align:"center",tooltip:_T("firewall","firewall_ports"),renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Ports},{header:_T("firewall","firewall_protocol"),dataIndex:"protocol",width:120,align:"center",tooltip:_T("firewall","firewall_protocol"),renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Protocol},{header:_T("firewall","firewall_tc_header_rate_min"),dataIndex:"minrate",width:165,align:"center",tooltip:_T("firewall","firewall_tc_header_rate_min"),renderer:SYNO.SDS.AdminCenter.Network.Utils.Render_Min_Rate},{header:_T("firewall","firewall_tc_header_rate_max"),dataIndex:"maxrate",width:140,align:"center",tooltip:_T("firewall","firewall_tc_header_rate_max"),renderer:SYNO.SDS.AdminCenter.Network.Utils.Render_Max_Rate}],enableDragDrop:!0,ddGroup:"TcRulesDD",enableColumnMove:!1,enableHdMenu:!1,autoExpandColumn:"tc_service",monitorWindowResize:!0,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:{fn:this.onChgButtonStatus,buffer:50,scope:this}}}),ddText:_T("firewall","firewall_rules_drag_drop_text"),listeners:{rowdblclick:function(){this.openRuleDialog("edit")},rowcontextmenu:this.onRowContextMenu,containercontextmenu:this.onContainerContextMenu,scope:this}},e);this.callParent([t]),this.clearDirty()},initEvents:function(){this.callParent(arguments),this.mon(this.IFStore,"load",this.onIFAfterLoad,this),this.mon(this.GridStore,"load",this.onGridAfterLoad,this),this.mon(this.GridStore,"update",this.onChgButtonStatus,this),this.mon(this.GridStore,"add",this.onStoreAdd,this),this.mon(this.GridStore,"remove",this.onStoreRemove,this),this.mon(this,"afterlayout",(function(){this.ddrow=new Ext.dd.DropTarget(this.getView().mainBody,{ddGroup:"TcRulesDD",copy:!1,scope:this,notifyDrop:function(e,t,i){return this.scope.mvRules(e.getDragData(t).rowIndex,i.selections,i.grid.getStore())}})}),this,{single:!0})},onIFAfterLoad:function(e,t,i){this.ifname=t[0].id,this.ifnamebak=this.ifname,Ext.getCmp(this.IFComboId).setValue(this.ifname),this.GridStore.load({params:{adapter:this.ifname},scope:this})},onGridAfterLoad:function(e,t,i){this.onChgButtonStatus(),this.clearDirty()},onStoreAdd:function(e,t,i){this.isRuleUpdated=!0,this.onChgButtonStatus()},onStoreRemove:function(e,t,i){this.isRuleUpdated=!0,this.onChgButtonStatus()},configToolBar:function(){return[{text:_T("common","create"),itemId:"create",tooltip:_T("common","create"),scope:this,handler:function(e,t){this.openRuleDialog("add")}},{text:_T("common","alt_edit"),itemId:"edit",tooltip:_T("common","alt_edit"),scope:this,handler:function(e,t){this.openRuleDialog("edit")}},{text:_T("common","delete"),itemId:"remove",tooltip:_T("common","delete"),scope:this,handler:function(){var e=this.getSelectionModel().getSelections(),t=this.getStore(),i=0;for(i=0;i<e.length;i++)t.remove(e[i])}},"->",{xtype:"syno_combobox",id:this.IFComboId=Ext.id(),displayField:"display",valueField:"id",store:this.IFStore,listeners:{select:this.onIFSelect,scope:this}}]},createGridStore:function(){return new SYNO.SDS.AdminCenter.Network.TcStore({module:this.module,owner:this})},onIFSelect:function(e,t,i){t.id!=this.ifname&&(this.isDirty()?this.module.appWin.getMsgBox().confirmLostChangePromise({save:function(){this.applyChanges().then((e=>{this.module.appWin.clearStatus(),this.loadInterfaceRules(t.id)})).catch((e=>{this.module.appWin.clearStatus(),this.module.appWin.getMsgBox().alert("",_T("common","error_system"))}))},dontSave:function(){this.loadInterfaceRules(t.id)},cancel:function(){Ext.getCmp(this.IFComboId).setValue(this.IFStore.getById(this.ifname).data.display)}},this):this.loadInterfaceRules(t.id))},clearIFSelect:function(){Ext.getCmp(this.IFComboId).clearValue(),this.getSelectionModel().clearSelections(),this.getStore().removeAll(),this.clearDirty(),this.onChgButtonStatus()},processReturnData:function(e,t,i){!0===t.has_fail&&this.module.appWin.clearStatus(),"set"===e&&(this.clearDirty(),this.getStore().load({params:{adapter:this.ifname},scope:this}))},openRuleDialog:function(e){new SYNO.SDS.AdminCenter.Network.TcRuleDialog({owner:this.module.appWin,module:this.module,portInfo:this.portInfo,winHeight:380,mode:e}).open()},onContainerContextMenu:function(e,t){e.getSelectionModel().hasSelection()&&this.showContextMenu(t)},onRowContextMenu:function(e,t,i){var s=e.getSelectionModel();s.suspendEvents(!1),s.selectRow(t,s.isSelected(t)),this.onChgButtonStatus(),s.resumeEvents(),this.showContextMenu(i)},showContextMenu:function(e){var t=[],i=this.getButton("edit"),s=this.getButton("remove");i&&!i.disabled&&t.push({text:_T("common","alt_edit"),scope:this,handler:function(e,t){this.openRuleDialog("edit")}}),s&&!s.disabled&&t.push({text:_T("common","delete"),scope:this,handler:function(){for(var e=this.getSelectionModel(),t=e.getSelections(),i=this.getStore(),s=0;s<t.length;s++)i.remove(t[s]);0>=i.getCount()?this.getView().focusEl.focus():(e.selectFirstRow(),this.getView().focusRow(0))}}),new SYNO.ux.Menu({autoDestroy:!0,items:t}).showAt(e.getXY()),e.preventDefault()},mvRules:function(e,t,i){if(void 0===e)return!1;for(var s=0;s<t.length;s++)i.remove(t[s]);return e>=i.getCount()?i.add(t):i.insert(e,t),this.isRuleUpdated=!0,!0},clearDirty:function(){this.isRuleUpdated=!1,this.getStore().commitChanges()},onChgButtonStatus:function(){if(!0!==this.isMoveRow){var e=this.getStore().getCount(),t=this.getSelectionModel().getCount();this.setButton("create",e<SYNO.SDS.AdminCenter.Network.Utils.TC_MAX_RULE),this.setButton("edit",1===t),this.setButton("remove",0<t),this.setButton("save",!_S("demo_mode")&&this.isDirty())}},getButton:function(e){var t,i=this.getTopToolbar();return i&&(t=i.getComponent(e)),t},setButton:function(e,t){var i=this.getButton(e);i&&i[t?"enable":"disable"]()},isDirty:function(){return this.GridStore.isDirty()||this.isRuleUpdated},validate:function(){return!0},reset:function(){Ext.isDefined(this.GridStore.reader.jsonData)&&this.GridStore.loadData(this.GridStore.reader.jsonData)},getApiSaveRules:function(){var e=this.getStore().getRange(),t=[];return Ext.each(e,(function(e){t.push(e.data)}),this),[{api:"SYNO.Core.Network.TrafficControl.Rules",method:"save",version:1,params:{adapter:this.ifname,rules:t}}]},loadInterfaceRules:function(e){this.ifnamebak=this.ifname,this.ifname=e,this.module.appWin.setStatusBusy(null,_T("common","loading")),this.GridStore.load({params:{adapter:this.ifname},scope:this})},applyChanges:function(){var e=this.owner.getForm().getValues("set"),t=this.owner.constructApplyParams(e);return t=t.concat(this.owner.getApiArray("get",!0)),t=this.owner.processParams("set",t),this.module.appWin.setStatusBusy(null,_T("common","saving")),this.owner.sendWebAPIPromise({compound:{stopwhenerror:!1,params:t}})}}),Ext.define("SYNO.SDS.AdminCenter.Network.TcStore",{extend:"SYNO.API.JsonStore",constructor:function(e){this.module=e.module,this.owner=e.owner;var t=Ext.apply({api:"SYNO.Core.Network.TrafficControl.Rules",appWindow:this.owner,method:"load",baseParams:{adapter:this.owner.ifname},version:1,autoDestroy:!0,root:"rules",fields:["id","enabled","port_type","port_num","port_direction","protocol","minrate","maxrate"],listeners:{load:{scope:this,fn:function(){this.module.appWin.clearStatus()}},exception:{scope:this,fn:function(e,t,i,s,n,o){this.module.appWin.getMsgBox().alert(_T("firewall","firewall_tc"),SYNO.API.getErrorString(n.code)),Ext.getCmp(this.owner.IFComboId).setValue(this.owner.IFStore.getById(this.owner.ifnamebak).data.display),this.owner.ifname=this.owner.ifnamebak,this.module.appWin.clearStatus()}}}},e);this.callParent([t])},isDirty:function(){return this.getModifiedRecords().length>0}}),Ext.define("SYNO.SDS.AdminCenter.Network.RoutingTable.RuleGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.appWin=e.appWin,this.ifClass=e.ifClass,this.width=600,this.height=300,this.frame=!1,this.border=!1,this.title=_T("network","route_table"),this.tables=[],this.TableStore=new Ext.data.SimpleStore({fields:["value","display"],data:[]});var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={colModel:new Ext.grid.ColumnModel({defaults:{width:120,sortable:!0},columns:[{header:_T("network","route_network"),dataIndex:"ip"},{header:_T("network","route_gateway"),dataIndex:"gateway"},{header:_T("network","route_mask"),dataIndex:"mask"},{header:_T("network","route_metric"),dataIndex:"metric"},{header:_T("network","route_interface"),dataIndex:"ifname",width:150,renderer:{fn:function(e){var t=SYNO.SDS.Utils.Network.idToString.apply(this,[e]);return"vpn-client"===this.ifClass[e]&&(t="VPN"),t},scope:this}}]}),store:new SYNO.SDS.AdminCenter.Network.RoutingTable.RuleStore({module:this.module,appWin:this.appWin}),tbar:{items:[{xtype:"syno_combobox",id:this.TableComboId=Ext.id(),displayField:"display",valueField:"value",store:this.TableStore,listeners:{select:this.onTableSelect,scope:this}}]},listeners:{scope:this,activate:this.onActivate}};return Ext.apply(t,e),t},onTableSelect:function(e,t,i){Ext.each(this.tables,(function(e){e.name===t.data.value&&this.getStore().loadData(e.rules)}),this)},loadTables:function(e,t,i){this.parentDialog.clearStatusBusy(),e&&(!0===_S("ha_hide_ntb")?(this.tables=[],Ext.each(t.tables,(function(e){var t=e.rules.filter((function(e,t,i){return-1===e.ifname.indexOf("ntb")}));e.rules=t,this.tables.push(e)}),this)):this.tables=t.tables,this.TableStore.loadData(this.getDisplayedTableString()),Ext.getCmp(this.TableComboId).setValue(this.tables[0].name),this.getStore().loadData(this.tables[0].rules))},getDisplayedTableString:function(){var e=[];return Ext.each(this.tables,(function(t){var i=t.name.indexOf("-");if(1>i)return SYNO.Debug("error on getting table"),!1;var s,n=t.name.substring(0,i);s="static"===n?_T("network","route_static_table"):"main"===n?_T("network","route_main_table"):"vpn-client"===t.class?"VPN "+_T("network","route_table_prefix"):SYNO.SDS.Utils.Network.idToString(n)+" "+_T("network","route_table_prefix"),e.push([t.name,s])}),this),e},onActivate:function(){this.parentDialog.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.Network.Router.Static.Route",method:"tablesget",params:{type:"ipv4"},version:1,scope:this,callback:this.loadTables})}}),Ext.define("SYNO.SDS.AdminCenter.Network.RoutingTableV6.RuleGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.appWin=e.appWin,this.ifClass=e.ifClass,this.width=600,this.height=300,this.frame=!1,this.border=!1,this.title=_T("network","route_table"),this.tables=[],this.TableStore=new Ext.data.SimpleStore({fields:["value","display"],data:[]});var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={colModel:new Ext.grid.ColumnModel({defaults:{width:120,sortable:!0},columns:[{header:_T("network","route_network"),dataIndex:"ip"},{header:_T("network","route_next_hop"),dataIndex:"gateway"},{header:_T("network","route_metric"),dataIndex:"metric"},{header:_T("network","route_interface"),dataIndex:"ifname",width:150,renderer:{fn:function(e){var t=SYNO.SDS.Utils.Network.idToString.apply(this,[e]);return"vpn-client"===this.ifClass[e]&&(t="VPN"),t},scope:this}}]}),store:new SYNO.SDS.AdminCenter.Network.RoutingTable.RuleStore({module:this.module,appWin:this.appWin}),tbar:{items:[{xtype:"syno_combobox",id:this.TableComboId=Ext.id(),displayField:"display",valueField:"value",store:this.TableStore,listeners:{select:this.onTableSelect,scope:this}}]},listeners:{scope:this,activate:this.onActivate}};return Ext.apply(t,e),t},onTableSelect:function(e,t,i){Ext.each(this.tables,(function(e){e.name===t.data.value&&this.getStore().loadData(e.rules)}),this),this.getStore().filterBy((function(e){return 0!==e.get("ifname").indexOf("tap")}))},loadTables:function(e,t,i){if(this.parentDialog.clearStatusBusy(),e){var s=[];!0===_S("ha_hide_ntb")?(this.tables=[],Ext.each(t.tables,(function(e){var t=e.rules.filter((function(e,t,i){return-1===e.ifname.indexOf("ntb")}));e.rules=t,this.tables.push(e)}),this)):this.tables=t.tables,Ext.each(this.tables,(function(e){s.push([e.name,e.name])}),this),this.TableStore.loadData(this.getDisplayedTableString()),Ext.getCmp(this.TableComboId).setValue(this.tables[0].name),this.getStore().loadData(this.tables[0].rules)}},getDisplayedTableString:function(){var e=[];return Ext.each(this.tables,(function(t){var i=t.name.indexOf("-");if(1>i)return SYNO.Debug("error on getting table"),!1;var s,n=t.name.substring(0,i);s="static"===n?_T("network","route_static_table"):"main"===n?_T("network","route_main_table"):"vpn-client"===t.class?"VPN "+_T("network","route_table_prefix"):SYNO.SDS.Utils.Network.idToString(n)+" "+_T("network","route_table_prefix"),e.push([t.name,s])}),this),e},onActivate:function(){this.parentDialog.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.Network.Router.Static.Route",method:"tablesget",params:{type:"ipv6"},version:1,scope:this,callback:this.loadTables})}}),Ext.define("SYNO.SDS.AdminCenter.Network.RoutingTable.RuleStore",{extend:"SYNO.API.JsonStore",constructor:function(e){if(this.module=e.module,this.ruleFields=["gateway","mask","ifname","ip","metric"],!Ext.isDefined(e.module))throw Error("module is undefined");var t=Ext.apply({method:"get",version:1,autoDestroy:!0,idProperty:"destination",fields:this.ruleFields,listeners:{}},e);this.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.Network.RoutingTable.Window",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.ip_type=e.ip_type,this.ifClass=e.ifClass,"ipv4"===this.ip_type?this.StaticRoutingTab=new SYNO.SDS.AdminCenter.Network.RoutingTable.RuleGrid({parentDialog:this,module:this.module,appWin:this.module.appWin,owner:this.owner,ifClass:this.ifClass,itemId:"RoutingTableGrid"}):"ipv6"===this.ip_type&&(this.StaticRoutingTab=new SYNO.SDS.AdminCenter.Network.RoutingTableV6.RuleGrid({parentDialog:this,module:this.module,appWin:this.module.appWin,owner:this.owner,ifClass:this.ifClass,itemId:"RoutingTableGrid"}));var t=Ext.apply({title:_T("network","route_table"),autoDestroy:!0,width:600,height:400,layout:"fit",border:!1,items:[this.StaticRoutingTab],listeners:{scope:this,activate:this.onActivate},buttons:[{text:_T("common","close"),scope:this,handler:this.onCancel}]},e);this.callParent([t])},onActivate:function(){this.callParent(arguments),this.StaticRoutingTab.onActivate()},onCancel:function(){this.close()}}),Ext.define("SYNO.SDS.AdminCenter.Network.StaticRouting.AddRuleDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.ifClass=e.ifClass,this.rule_store=e.rule_store,this.selectModel=e.selectModel,this.ip_type=e.ip_type,this.isRuleValid=!1;var t=Ext.apply({title:_T("network","route_static"),autoDestroy:!0,width:450,height:290,layout:"fit",border:!1,items:[this.configForm({border:!1,itemId:"formpanel"})],buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{disabled:_S("demo_mode"),text:_T("common","create"),btnStyle:"blue",scope:this,handler:this.onAddRule}]},e);this.callParent([t])},configForm:function(e){return SYNO.LayoutConfig.fill(Ext.apply({xtype:"syno_formpanel",padding:"0",trackResetOnLoad:!0,synodefaults:{width:200},items:[{xtype:"syno_textfield",fieldLabel:_T("network","route_network"),name:"ip",allowBlank:!1,vtype:"ipv4"===this.ip_type?"v4ip":"v6ip"},{xtype:"syno_textfield",fieldLabel:"ipv4"===this.ip_type?_T("network","route_mask"):_T("network","route_prefix_length"),name:"mask",allowBlank:!1,vtype:"ipv4"===this.ip_type?"netmask":null},{xtype:"syno_textfield",fieldLabel:_T("network","route_gateway"),name:"gateway",allowBlank:!1,validator:function(e){return"ipv4"===this.ip_type?"0.0.0.0"===e||(!!Ext.form.VTypes.v4ipVal.test(e)||Ext.form.VTypes.v4ipText):!!Ext.form.VTypes.v6ipVal.test(e)||Ext.form.VTypes.v6ipText}.createDelegate(this)},{xtype:"syno_combobox",name:"ifname",width:200,valueField:"value",displayField:"display",store:new Ext.data.SimpleStore({fields:["value","display"],data:[]}),fieldLabel:_T("network","route_interface")}]},e))},getForm:function(){return this.getComponent("formpanel").getForm()},addRuleCallback:function(e,t,i){this.clearStatusBusy();var s=this.getForm(),n=function(e){var t=s.findField(e);return t?t.getValue():void 0};return e?(this.rule_store.add(new this.rule_store.recordType({enable:!0,ip:t.ip,mask:n("mask"),gateway:n("gateway"),ifname:n("ifname")})),this.close(),!0):(this.setStatusError({text:_T("network","route_static_rule_error"),clear:!0}),!1)},onAddRule:function(){var e=this.getForm(),t={},i=function(t){var i=e.findField(t);return i?i.getValue():void 0};return e.isDirty()?!!e.isValid()&&(t.enable=!0,t.ip=i("ip"),"ipv4"===this.ip_type?t.mask=i("mask"):"ipv6"===this.ip_type&&(t.prefix_length=i("mask")),t.gateway=i("gateway"),t.ifname=i("ifname"),this.setStatusBusy({text:_T("common","saving")}),void this.sendWebAPI({api:"SYNO.Core.Network.Router.Static.Route",method:"test",params:{rule:t,type:this.ip_type},version:1,scope:this,callback:this.addRuleCallback})):(this.close(),!0)},onCancel:function(){this.getForm().isDirty()?this.confirmLostChangePromise({save:this.onAddRule,dontSave:this.close,cancel:Ext.emptyFn},this):this.close()},onOpen:function(){var e=[],t={};for(var i in this.ifClass)this.ifClass.hasOwnProperty(i)&&("vpn-client"===this.ifClass[i]?e.push([i,"VPN"]):e.push([i,SYNO.SDS.Utils.Network.idToString(i)]));this.getForm().findField("ifname").store.loadData(e),t.ifname=this.getForm().findField("ifname").store.getAt(0).get("value"),this.getForm().setValues(t),this.callParent([arguments])}}),Ext.define("SYNO.SDS.AdminCenter.Network.StaticRouting.RuleStore",{extend:"SYNO.API.JsonStore",constructor:function(e){if(this.ruleFields=["enable","ip","mask","gateway","ifname","active"],!Ext.isDefined(e.module))throw Error("module is undefined");var t=Ext.apply({api:"SYNO.Core.Network.Router.Static.Route",appWindow:e.appWin,method:"get",version:1,autoDestroy:!0,baseParams:{type:"ipv4"},root:"rules",fields:this.ruleFields,listeners:{load:this.onLoad,exception:this.onStoreException,add:this.onRuleChanged,update:this.onUpdate,remove:this.onRuleChanged,scope:this}},e);this.callParent([t])},onLoad:function(){this.module.appWin.clearStatus()},onStoreException:function(e,t,i,s,n,o){SYNO.Debug("Store exception: options:",s),this.module.appWin.unmask(),this.module.appWin.getMsgBox().alert("",_T("common","error_system"))},onRuleChanged:function(e,t,i){this.isRuleChanged=!0,this.grid.getView().onLayout()},onUpdate:function(e,t,i){},onSelectAll:function(){},getRules:function(){var e=[],t=0,i={};for(t=0;t<this.getCount();t++)i=this.getAt(t).data,e.push(i);return e},isDirty:function(){return this.isRuleChanged||this.getModifiedRecords().length>0},clearDirty:function(){this.commitChanges(),this.isRuleChanged=!1},reset:function(){Ext.isDefined(this.reader.jsonData)&&this.loadData(this.reader.jsonData),this.isRuleChanged=!1}}),Ext.define("SYNO.SDS.AdminCenter.Network.StaticRoutingTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.appWin=e.appWin;var t=Ext.apply(e,{owner:this}),i=Ext.apply({layout:"fit",padding:"0 0 0 0",cls:"syno-network-staticroutetab",title:_T("network","route_static"),items:[this.GridPanel=new SYNO.SDS.AdminCenter.Network.StaticRoutingGrid(t)],listeners:{scope:this.GridPanel,activate:this.GridPanel.onActivate,deactivate:this.GridPanel.onDeactivate,rowcontextmenu:this.GridPanel.onRowContextMenu,containercontextmenu:this.GridPanel.onContainerContextMenu}},e);this.callParent([i]),this.setCustomFormFunc()},setCustomFormFunc:function(){Ext.isDefined(this.GridPanel.ipTypeCombo)||(this.GridPanel.ipTypeCombo=this.GridPanel.getTopToolbar().getComponent("ip_type_combobox")),this.getForm().items.items.push(this.GridPanel)},isDirty:function(){return this.GridPanel.isDirty()},getApiArray:function(e){return"set"===e?[this.GridPanel.getApiSaveRules()]:[]},processParams:function(e,t){return"set"===e?this.GridPanel.getApiSaveRules():[]},processReturnData:function(e,t,i){this.GridPanel.processReturnData(e,t,i),"set"===e&&this.getComponent(this.itemId).unmask()}}),Ext.define("SYNO.SDS.AdminCenter.Network.StaticRoutingGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.appWin=e.appWin,this.owner=e.owner,this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","commit"),dataIndex:"enable",width:80,align:"center",enableFastSelectAll:!0,listeners:{selectall:{fn:function(){this.getStore().onSelectAll()},scope:this}},commitChanges:!1}),this.renderer={qtip:function(e,t){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e},qtip_interface:function(e,t){var i=SYNO.SDS.Utils.Network.idToString(e);return"vpn-client"===this.ifClass[e]&&(i="VPN"),t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i)+'"',i},status:function(e,t){var i="Enabled"===e?_T("common","enabled"):_T("common","disabled");return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i)+'"',i}};var t=Ext.apply({padding:"0 0 0 0",width:600,height:300,frame:!1,border:!1,plugins:this.enableColumn,viewConfig:{emptyText:['<div class="syno-dataview">','<div class="empty-text-wrap">','<div class="empty-text-inner-wrap">','<div class="empty-text-icon"></div>','<div class="empty-text">',_T("common","no_item"),"</div>","</div>","</div>","</div>"].join("")},columns:[this.enableColumn,{header:_T("network","route_network"),dataIndex:"ip",width:120,align:"left",renderer:this.renderer.qtip},{header:_T("network","route_mask"),dataIndex:"mask",width:120,align:"left",renderer:this.renderer.qtip},{header:_T("network","route_gateway"),dataIndex:"gateway",width:120,align:"left",renderer:this.renderer.qtip},{header:_T("network","route_interface"),dataIndex:"ifname",width:120,align:"left",scope:this,renderer:this.renderer.qtip_interface},{header:_T("common","status"),dataIndex:"active",width:120,align:"left",renderer:this.renderer.status}],enableHdMenu:!1,loadMask:!1,cls:"without-dirty-red-grid syno-network-staticroutetab-gridpanel",selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:this.checkOnSelectionChanged,scope:this}}),store:new SYNO.SDS.AdminCenter.Network.StaticRouting.RuleStore({module:this.module,appWin:this.appWin,grid:this}),tbar:[{xtype:"syno_button",text:_T("common","create"),handler:this.onCreateRule,scope:this,itemId:"create"},{xtype:"syno_button",text:_T("common","delete"),handler:this.onDeleteRule,scope:this,itemId:"del"},{xtype:"syno_button",text:_T("network","route_table"),handler:this.onRouteTable,scope:this,itemId:"routingTable"},"->",{xtype:"syno_combobox",itemId:"ip_type_combobox",editable:!1,allowBlank:!1,store:this.getIPTypeStore(),value:"ipv4",listeners:{scope:this,beforeselect:this.onBeforeSelect,select:this.onTypeChange}}]},e);this.callParent([t])},onRowContextMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.showContextMenu(i)},onContainerContextMenu:function(e,t){e.getSelectionModel().hasSelection()&&this.showContextMenu(t)},showContextMenu:function(e){new SYNO.ux.Menu({autoDestroy:!0,items:[{text:_T("common","delete"),scope:this,handler:function(){for(var e=this.getSelectionModel(),t=e.getSelections(),i=this.getStore(),s=0;s<t.length;s++)i.remove(t[s]);0>=i.getCount()?this.getView().focusEl.focus():(e.selectFirstRow(),this.getView().focusRow(0))}}]}).showAt(e.getXY())},getButton:function(e){return this.getTopToolbar().getComponent(e)},getIPTypeStore:function(){return!0===_S("ha_not_support_ipv6")?[["ipv4","IPv4"]]:[["ipv4","IPv4"],["ipv6","IPv6"]]},enableButton:function(e,t){var i=this.getButton(e);Ext.isObject(i)?t?i.enable():i.disable():SYNO.Debug("enableButton failed: no button object of ",e)},disableAllButton:function(){Ext.each(["del"],(function(e){this.getButton(e).disable()}),this)},checkOnSelectionChanged:function(e){0<e.getCount()?this.enableButton("del",!0):this.enableButton("del",!1)},onActivate:function(){this.isDirty()||(this.ipTypeCombo.setValue("ipv4"),this.disableAllButton(),this.module.appWin.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Network.Router.Gateway.List",method:"get",params:{iptype:this.ipTypeCombo.getValue(),type:"all"},version:1,scope:this,callback:this.onLoadIfClass}))},onLoadIfClass:function(e,t,i){if(e){this.ifClass=[];var s=[];Ext.each(t.configs,(function(e){s[e.ifname]=e.class}),this);var n=Object.keys(s);n.sort((function(e,t){var i=/([A-Za-z_]*?)(bond)?(\d+)(\..*)?/,s="bond"==e.match(i)[2];return s!=("bond"==t.match(i)[2])?s?-1:1:parseInt(e.match(i)[3])-parseInt(t.match(i)[3])})),Ext.each(n,(function(e){this.ifClass[e]=s[e]}),this),this.getStore().load()}else this.module.appWin.clearStatus()},onDeactivate:function(){this.el.unmask()},onChangeConfirm:function(e){"yes"===e&&this.clearDirty()},onCreateRule:function(e,t){new SYNO.SDS.AdminCenter.Network.StaticRouting.AddRuleDialog({module:this.module,owner:this.module.appWin,ifClass:this.ifClass,rule_store:this.getStore(),selectModel:this.getSelectionModel(),ip_type:this.ipTypeCombo.getValue()}).open()},onDeleteRule:function(){var e=this.getSelectionModel().getSelections(),t=this.getStore(),i=0;for(i=0;i<e.length;i++)t.remove(e[i])},getApiSaveRules:function(){return[{api:"SYNO.Core.Network.Router.Static.Route",method:"set",version:1,params:{rules:this.getStore().getRules(),type:this.ipTypeCombo.getValue()}}]},onRouteTable:function(e,t){new SYNO.SDS.AdminCenter.Network.RoutingTable.Window({module:this.module,owner:this.module.appWin,ifClass:this.ifClass,ip_type:this.ipTypeCombo.getValue()}).open()},onBeforeSelect:function(e,t,i){return!this.isDirty()||(this.module.appWin.getMsgBox().confirmLostChangePromise({save:function(){this.applyChanges().then((t=>{this.module.appWin.clearStatus(),this.clearDirty(),e.setValue(e.getStore().getAt(i).get(e.valueField)),e.fireEvent("select",e)})).catch((e=>{this.module.appWin.clearStatus(),this.module.appWin.getMsgBox().alert("",_T("common","error_system"))}))},dontSave:function(){this.clearDirty(),e.setValue(e.getStore().getAt(i).get(e.valueField)),e.fireEvent("select",e)},cancel:Ext.emptyFn},this),!1)},isDirty:function(){return this.getStore().isDirty()},clearDirty:function(){this.getStore().clearDirty()},validate:function(){return!0},reset:function(){this.getStore().reset()},onTypeChange:function(e){this.disableAllButton(),this.module.appWin.setStatusBusy(null,_T("common","loading")),this.getStore().load({params:{type:e.getValue()},scope:this}),this.getColumnModel().setColumnHeader(2,"ipv4"===e.getValue()?_T("network","route_mask"):_T("network","route_prefix_length"))},processReturnData:function(e,t,i){!0===t.has_fail&&this.module.appWin.clearStatus(),"set"===e&&(this.clearDirty(),this.getStore().load())},applyChanges:function(){var e=this.owner.getForm().getValues("set"),t=this.owner.constructApplyParams(e);return t=t.concat(this.owner.getApiArray("get",!0)),t=this.owner.processParams("set",t),this.module.appWin.setStatusBusy(null,_T("common","saving")),this.owner.sendWebAPIPromise({compound:{stopwhenerror:!1,params:t}})}}),Ext.define("SYNO.SDS.AdminCenter.LoginPortal.Network.ConnectivityTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.DSMSettingsConfig={};var t={trackResetOnLoad:!0,border:!1,defaults:{labelWidth:272},items:this.getItems(),webapi:{api:"SYNO.Core.Web.DSM",methods:{get:"get",set:"set"},version:2},listeners:{scope:this,afterlayout:this.onAfterlayout}};this.callParent([Ext.apply(t,e)]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_max_connections",["max_connections"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_server_header",["server_header"])},getItems:function(){return[{xtype:"syno_checkbox",boxLabel:_T("service","enable_http2"),name:"enable_spdy"},{xtype:"syno_displayfield",indent:1,name:"enable_spdy_desc",value:_T("service","enable_http2_desc")},{xtype:"syno_checkbox",boxLabel:_T("service","enable_customized_max_http_connections"),name:"enable_max_connections"},{xtype:"syno_numberfield",name:"max_connections",width:240,indent:1,fieldLabel:_T("service","http_connections")},{xtype:"syno_checkbox",name:"enable_server_header",boxLabel:_T("service","enable_server_header")},{xtype:"syno_textfield",name:"server_header",width:240,fieldLabel:_T("service","server_header"),allowBlank:!1,emptyText:"nginx",indent:1},{xtype:"syno_checkbox",name:"enable_reuseport",boxLabel:_T("service","enable_reuseport")}]},loadDataAndSetFormValues:function(){this.owner.setStatusBusy(),this.sendWebAPI({api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version,scope:this,callback:function(e,t){this.owner.clearStatusBusy(),e&&this.setFormValues(t)}})},setFormValues:function(e){this.DSMSettingsConfig=e;let t={enable_spdy:!1,enable_max_connections:!1,max_connections:0,enable_server_header:!1,server_header:"nginx",remove_banner:!1,enable_reuseport:!1};t.enable_spdy=e.enable_spdy,t.enable_max_connections=e.enable_max_connections,t.max_connections=e.max_connections,t.enable_server_header=e.enable_server_header,t.server_header=e.server_header,t.enable_reuseport=e.enable_reuseport,this.getForm().setValues(t);let i=this.getForm().findField("max_connections"),s=this.getForm().findField("enable_max_connections");if(null===i||null===s)return;void 0!==e.max_connections?(i.setMinValue(e.max_connections_limit.lower),i.setMaxValue(e.max_connections_limit.upper)):(i.hide(),s.hide());let n=this.getForm().findField("enable_reuseport");e.support_reuseport||n.hide()},needWaitHttpdRestart:function(e,t){return e.enable_spdy!==t.enable_spdy||void 0!==e.enable_max_connections&&e.enable_max_connections!==t.enable_max_connections||e.enable_server_header!==t.enable_server_header||e.enable_reuseport!==t.enable_reuseport||(void 0!==t.max_connections&&e.max_connections!==t.max_connections||void 0!==t.server_header&&e.server_header!==t.server_header)},prepareSetDSMSettingParams:function(e){let t={};return t=JSON.parse(JSON.stringify(e)),delete t.remove_banner,t},processReturnData:function(e,t,i){const s=t.result.find((e=>e.api===this.webapi.api&&e.method===this.webapi.methods.set));if(s)if(s.success){const e=this.getForm().getValues(),t=this.prepareSetDSMSettingParams(e);if(this.needWaitHttpdRestart(this.DSMSettingsConfig,t)){SYNO.SDS.AdminCenter.Utils.WaitHttpdRestart()()}}else{let e=_T("common","error_system");if(s.error&&s.error.code&&(e=SYNO.API.getErrorString(s.error.code),3506===s.error.code))this.getForm().findField("server_header").markInvalid([e]);this.owner.setStatusError({text:e,clear:!0})}this.callParent([e,t,i])},onAfterlayout:function(){this.maxConnectionsTip||(this.maxConnectionsTip=SYNO.ux.AddTip(this.getForm().findField("max_connections").getEl(),_T("service","http_connections_hint")))}}),Ext.define("SYNO.SDS.AdminCenter.Network.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.glusterComputingOrStorage=!1,this.bondType="",this.app=e.app,this.callParent(arguments)},getPanel:function(){return this.panel||(this.panel=new SYNO.SDS.AdminCenter.Network.TabPanel({module:this,owner:this.appWin})),this.panel},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"GeneralTab":return"AdminCenter/connection_network_general.html";case"InterfaceTab":default:return"AdminCenter/connection_network_desc.html";case"TcTab":return"AdminCenter/connection_network_trafficcontrol.html";case"ConnectivityTab":return"AdminCenter/connection_network_connectivity.html"}},getWebAPIs:function(){return this.webAPIs||(this.webAPIs=[],this.webAPIs.push({api:"SYNO.Core.CMS.Info",method:"get",version:1,additional:["gluster_role"]}),this.webAPIs.push({api:"SYNO.Core.Network.OVS",method:"get",version:1}),Ext.each(this.getStore().getWebAPIs(),(function(e){this.webAPIs.push(Ext.apply({api:e.api,method:e.method,version:e.version},e.params))}),this)),this.webAPIs},confirmCallback:function(e){this.panel.StaticRoutingTab.onChangeConfirm(e)},activate:function(e){this.panel.resetAllForm(),this.startPolling(),this.panel.connectivityTab.loadDataAndSetFormValues(),"yes"===_D("supportTc")&&(this.panel.loadPortInfo(),this.panel.IFStore.loadInterface()),e&&e.tab&&this.panel.setActiveTab(e.tab)},deactivate:function(){if(this.stopPolling(),"yes"===_D("supportTc")){if(this.panel.getComponent("TcTab").isDirty())return!1;this.panel.portInfo_request&&Ext.Ajax.abort(this.panel.portInfo_request)}return!this.panel.generalTab.isDirty()&&(!this.panel.connectivityTab.isFormDirty()&&(!(_S("version")>=4966&&this.panel.StaticRoutingTab.isDirty())&&(SYNO.SDS.AdminCenter.Network.Bond.resetSMBInfo.call(this.panel.interfaceTab),!0)))},startPolling:function(){this.pollMainId||(this.pollMainId=this.appWin.pollReg({scope:this,webapi:{api:"SYNO.Entry.Request",version:1,method:"request",params:{stopwhenerror:!1,compound:this.getWebAPIs()}},interval:5,immediate:!0,status_callback:function(e,t,i,s){var n=!0,o={has_fail:!1,result:[]};Ext.each(t.result,(function(e,i,s){if("SYNO.Core.Network.OVS"!==e.api)if("SYNO.Core.CMS.Info"===e.api){if(!e.success){var a=_T("common","error_system");return t.error&&t.error.code&&(a=SYNO.API.getErrorString(t.error.code)),this.appWin.getMsgBox().alert("",a||_T("common","error_system")),void(this.glusterComputingOrStorage=!1)}1&e.data.additional.gluster_role||2&e.data.additional.gluster_role?this.glusterComputingOrStorage=!0:this.glusterComputingOrStorage=!1}else n=n&&e.success,o.result.push(e);else{if(!e.success)return;e.data.enable_ovs?this.bondType="ovs":this.bondType=""}}),this),o&&(o.has_fail=n,this.getStore().onLoad.call(this.getStore(),n,o,i.compound,s.params),o=void 0),this.panel.generalTab.loadFormNoMask()}}))},stopPolling:function(){this.pollMainId&&(this.appWin.pollUnreg(this.pollMainId),this.pollMainId=null)},getStore:function(){return this.store||(this.store=new SYNO.SDS.AdminCenter.Network.InterfaceStore({owner:this.appWin,module:this,callback:{afterload:function(){this.appWin&&!this.appWin.isVisible()||(_S("version")<4966&&this.panel.generalTab.afterLoad(),this.panel.interfaceTab.activated&&this.panel.interfaceTab.afterLoad())},scope:this}})),this.store},getGoToHAMsgBox:function(){var e=_T("mainmenu","leaf_control_panel"),t=_TT("SYNO.SDS.HA.Instance","ui","confirm_setting_net_on_ha_mgr");this.appWin.getMsgBox().confirm(e,t,null,{useHtml:!0}).then((e=>{"confirm"===e&&SYNO.SDS.AppLaunch("SYNO.SDS.HA.Instance",{fn:"SYNO.SDS.HA.Network.Main"})}),this)},getHAMsgBox:function(){var e=_T("mainmenu","leaf_control_panel"),t=_TT("SYNO.SDS.HA.Instance","ui","ha_not_support_setting");this.appWin.getMsgBox().alert(e,t)},getGlusterBox:function(){var e=_T("status","status_gluster"),t=_T("network","need_disjoin_gluster");this.appWin.getMsgBox().alert(e,t)},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t,this.panel.applyHandler()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.Network.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){var t=[];this.module=e.module,this.owner=e.owner,this.showOldUI=_S("version")<4966,this.IFStore=this.createIFStore(),this.portInfo=[],t.push(this.generalTab=new SYNO.SDS.AdminCenter.Network.GeneralTab({module:e.module,owner:this,itemId:"GeneralTab"})),t.push(this.interfaceTab=new SYNO.SDS.AdminCenter.Network.InterfaceTab({module:e.module,owner:this,itemId:"InterfaceTab"})),"yes"===_D("supportTc")&&(this.TcTab=new SYNO.SDS.AdminCenter.Network.TcTab({module:e.module,title:_T("firewall","firewall_tc"),owner:this,itemId:"TcTab",IFStore:this.IFStore}),t.push(this.TcTab)),this.showOldUI||(this.StaticRoutingTab=new SYNO.SDS.AdminCenter.Network.StaticRoutingTab({module:e.module,appWin:e.module.appWin,owner:this,itemId:"StaticRoutingTab"}),t.push(this.StaticRoutingTab)),t.push(this.connectivityTab=new SYNO.SDS.AdminCenter.LoginPortal.Network.ConnectivityTab({module:e.module,appWin:e.module.appWin,owner:this,itemId:"ConnectivityTab",title:_T("controlpanel","connectivity")}));var i=Ext.apply({activeTab:0,applyDirtyOnly:!0,deferredRender:!1,module:e.module,items:t},e);this.callParent([i])},applyHandler:function(e,t){this.showOldUI&&this.generalTab.isGatewayDirty()&&this.generalTab.isGatewayEmpty()?this.module.appWin.getMsgBox().confirm("",_T("common","error_nogate"),(function(e){if("yes"!==e)return!1;this.module.stopPolling(),this.applyAllForm()}),this):(this.module.stopPolling(),this.applyAllForm())},applyAllForm:function(){if(this.generalTab.isDirty()){var e=this.generalTab.getForm().getValues(!1,"set"),t=this.constructApplyParams(e),i=SYNO.ux.Utils.getApiParams({api:"SYNO.Core.Network",method:"IGNORE",version:2},t);this.setStatusBusy({text:_T("common","saving")}),SYNO.API.Request({compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.Network",method:"set",version:2,params:i},{api:"SYNO.Core.Network",method:"get",version:2,params:{}}]},scope:this,callback:function(e,t,i){this.clearStatusBusy(),e?(t.has_fail||this.self.superclass.applyAllForm.call(this),this.onApiSuccess("set",t,i)):this.onApiFailure("set",t,i)}})}else this.self.superclass.applyAllForm.call(this)},getFeasibilityCheckResult:function(e){var t=!0;return Ext.each(e,(function(e,i,s){if(!1===e.success&&4319===e.error.code)return t=!1,!1})),t},getAjaxCfg:function(e){return{encryption:["password"]}},onApiSuccess:function(e,t,i){if("set"===e)if(t.has_fail)if(!1===this.getFeasibilityCheckResult(t.result))this.module.confirmSaveLostReject&&this.module.confirmSaveLostReject(),this.setStatusError({text:_T("error","nochange_subject"),clear:!0});else{this.module.confirmSaveLostReject&&this.module.confirmSaveLostReject();var s=SYNO.API.getErrorString(t);this.setStatusError({text:s,clear:!0}),Ext.each(t.result,(function(e){if("SYNO.Core.Web.DSM"===e.api&&!e.success&&"set"===e.method){var t=this.getAllForms();return Ext.each(t,(function(e,t,i){if("ConnectivityTab"===e.itemId)return e.isDirty()&&this.setActiveByForm(e,t),!1}),this),!1}}),this)}else this.setStatusOK(),this.module.startPolling(),this.module.confirmSaveLostResolve&&this.module.confirmSaveLostResolve();this.processReturnData(e,t,i)},createIFStore:function(){return new SYNO.SDS.AdminCenter.Network.SimpleIFStore({module:this.module,owner:this})},loadPortInfo:function(){this.setStatusBusy({text:_T("common","loading")}),this.portInfo_request=this.sendWebAPI({api:"SYNO.Core.Service.PortInfo",method:"load",params:{target:["traffic_control"]},version:1,scope:this,callback:function(e,t,i){e?(SYNO.SDS.AdminCenter.Utils.Render.ServerPortsParsing(t,this.portInfo,!0),this.TcTab.GridPanel&&this.TcTab.GridPanel.getView&&this.TcTab.GridPanel.getView().refresh()):this.module.appWin.getMsgBox().alert(_T("firewall","firewall_tc"),_T("common","commfail")),this.clearStatusBusy()}})}}),Ext.define("SYNO.SDS.AdminCenter.Security.DSM.WhitelistDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t=Ext.apply({dialog:this},e),i={width:620,height:540,layout:"fit",title:_T("dsmsetting","allowurls"),items:[this.grid=new SYNO.SDS.AdminCenter.Security.DSM.WhitelistGrid(t)],buttons:[{text:_T("common","cancel"),btnStyle:"grey",scope:this,handler:this.close},{text:_T("common","ok"),btnStyle:"blue",scope:this,handler:this.onOkClick}],listeners:{beforeclose:this.onBeforeClose.createDelegate(this)}};return Ext.apply(i,e),i},onOkClick:function(){var e=this.module.whitelist,t=this.grid.store.collect("hostname").sort();if(this.isWhitelistChanged(e,t)){var i=Ext.applyIf({method:"set",params:{whitelist:t},callback:function(){var e=this.module.getForm().findField("whitelist");this.clearStatusBusy(),e.setValue(t),e.originalValue=e.getValue(),this.module.whitelist=t,this.module.ownerCt.restartHttpd=!0,this.close()},scope:this},this.module.embedAPI);this.setStatusBusy(),this.sendWebAPI(i)}else this.close()},isWhitelistChanged:function(e,t){if(e.length!==t.length)return!0;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!0;return!1},onBeforeClose:function(){var e=this.module.whitelist,t=this.grid.store.collect("hostname").sort();if(this.isWhitelistChanged(e,t))return this.confirmLostChangePromise({save:this.onOkClick,dontSave:function(){this.grid.store.loadData(e.map((e=>[e]))),this.close()},cancel:Ext.emptyFn},this),!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.DSM.WhitelistGrid",{extend:"SYNO.ux.EditorGridPanel",clicksToEdit:2,constructor:function(e){this.module=e.module,this.callParent([this.fillConfig(e)])},fillConfig:function(e){this.store=this.createStore(),this.actionAdd=new Ext.Action({text:_T("common","add"),itemId:"btn_add",handler:this.addUrl,scope:this}),this.actionDelete=new Ext.Action({text:_T("common","delete"),itemId:"btn_del",handler:this.deleteUrl,disabled:!0,scope:this}),this.readWhitelist(this.module.whitelist),this.store.loadData(this.whitelist),this.gridCtxMenu=new SYNO.ux.Menu(this.actionDelete);var t={border:!1,store:this.store,autoFlexcroll:!0,enableHdMenu:!1,tbar:{xtype:"syno_toolbar",defaultType:"syno_button",items:[this.actionAdd,this.actionDelete]},colModel:new Ext.grid.ColumnModel({columns:[{header:_T("service","service_host_name"),dataIndex:"hostname",editor:new Ext.grid.GridEditor({revertInvalid:!1,field:{xtype:"syno_textfield",vtype:"url"}}),allowBlank:!1}],defaults:{sortable:!0}}),selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:this.onSelectionChange,scope:this}}),listeners:{scope:this,rowcontextmenu:this.onClickCtxMenu,containercontextmenu:this.onKeyCtxMenu}};return Ext.apply(t,e),t},onClickCtxMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.gridCtxMenu.showAt(i.getXY())},onKeyCtxMenu:function(e,t){e.getSelectionModel().hasSelection()&&this.gridCtxMenu.showAt(t.getXY())},onSelectionChange:function(){0===this.getSelectionModel().getSelections().length?this.actionDelete.disable("delete"):this.actionDelete.enable("delete")},createStore:function(){var e=new Ext.data.ArrayStore({autoDestroy:!0,fields:["hostname"]});return this.addManagedComponent(e),e},addUrl:function(){var e=this.store.getCount(),t=new this.store.recordType;this.stopEditing(),this.store.insert(e,t),this.startEditing(e,0)},deleteUrl:function(){this.store.remove(this.getSelectionModel().getSelections())},readWhitelist:function(e){for(var t=[],i=0;i<e.length;++i)t.push([e[i]]);this.whitelist=t}}),Ext.define("SYNO.SDS.AdminCenter.Security.DSM.URLDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={layout:"fit",width:540,height:170,resizable:!1,title:_T("service","service_host_name"),items:[this.form=this.createForm()],buttons:[{text:_T("common","cancel"),btnStyle:"grey",scope:this,handler:this.close},{text:_T("common","ok"),btnStyle:"blue",scope:this,handler:this.onOkClick}]};return Ext.apply(t,e),t},createForm:function(){return new SYNO.ux.FormPanel({xtype:"syno_formpanel",items:[{xtype:"syno_textfield",maxlength:1e3,name:"url",width:490,emptyText:_T("download","download_empty_input_url"),allowBlank:!1,validator:this.validateURL.createDelegate(this),hideLabel:!0}]})},onOkClick:function(){var e=this.form.getForm();if(!e.isValid())return!1;var t=e.findField("url").getValue().replace(/\s/g,"");if(Ext.isEmpty(t))return!1;this.grid.store.add(new Ext.data.Record({hostname:t})),this.grid.actionDelete.setDisabled(0>=this.grid.store.getCount()),this.close()},validateURL:function(e){var t=e.replace(/\s/g,"");return!(!Ext.isString(t)||Ext.isEmpty(t))&&(!(-1!==e.indexOf(",")||!t.match(/^((https?|wss?):(\/\/)?)?((\*\.)?(-\.)?([^\s\/?\.#-*]+\.)+[^\s\/?\.#-*]+(\/[^\s*#\?]+)*)?(\/)?$/))||_T("smsnotify","invalid_url"))}}),Ext.define("SYNO.SDS.AdminCenter.Security.DSM.ProxyListDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),this.setStatusBusy(),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.DSM.Proxy",method:"get",version:1},scope:this,callback:function(e,t){this.clearStatusBusy(),e?(this.proxylist=t.proxylist.sort(),this.panel.store.loadData(this.proxylist.map((function(e){return[e]})))):this.panel.store.loadData([])}})},fillConfig:function(e){this.panel=new SYNO.SDS.AdminCenter.Security.DSM.ProxyListGrid(Ext.apply({dialog:this},e));var t={width:620,height:540,minWidth:620,minHeight:540,layout:"fit",title:_T("dsmsetting","trusted_proxies"),items:[this.panel],buttons:[{text:_T("common","cancel"),btnStyle:"grey",scope:this,handler:this.close},{text:_T("common","ok"),btnStyle:"blue",scope:this,handler:this.onOkClick}],listeners:{beforeclose:this.onBeforeClose.createDelegate(this)}};return Ext.apply(t,e),t},onOkClick:function(){var e=this.proxylist,t=this.panel.store.collect("cidr").sort();this.isProxyListChanged(e,t)?(this.setStatusBusy(),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.DSM.Proxy",method:"set",version:1,params:{proxylist:t}},scope:this,callback:function(e,i){if(this.clearStatusBusy(),e)this.proxylist=t,SYNO.SDS.AdminCenter.Utils.WaitHttpdRestart()(),this.panel.store.commitChanges(),this.close();else if(void 0!==i.errors){var s=this.panel.store.findExact("cidr",i.errors[0]);this.setStatusError({text:_T("vtype","bad_cidr"),clear:!0}),this.panel.startEditing(s,0)}else this.setStatusError()}})):this.close()},onBeforeClose:function(){var e=this.proxylist,t=this.panel.store.collect("cidr").sort();if(this.isProxyListChanged(e,t))return this.confirmLostChangePromise({save:this.onOkClick,dontSave:function(){this.panel.store.loadData(this.proxylist.map((e=>[e]))),this.close()},cancel:Ext.emptyFn},this),!1},isProxyListChanged:function(e,t){if(e.length!==t.length)return!0;for(var i=0;i<e.length;++i)if(e[i]!==t[i])return!0;return!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.DSM.ProxyListGrid",{extend:"SYNO.ux.EditorGridPanel",clicksToEdit:2,constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.store=this.createStore(),this.actionAdd=new Ext.Action({text:_T("common","add"),handler:this.addCIDR,scope:this}),this.actionDelete=new Ext.Action({text:_T("common","delete"),handler:this.deleteCIDR,disabled:!0,scope:this}),this.gridCtxMenu=new SYNO.ux.Menu({items:[this.actionDelete]});var t={border:!1,store:this.store,autoFlexcroll:!0,enableHdMenu:!1,enableColumnHide:!0,tbar:{xtype:"syno_toolbar",defaultType:"syno_button",items:[this.actionAdd,this.actionDelete]},colModel:new Ext.grid.ColumnModel({columns:[{header:_T("dsmsetting","cidr"),dataIndex:"cidr",editor:new Ext.grid.GridEditor({revertInvalid:!1,field:{xtype:"syno_textfield",maskRe:Ext.form.VTypes.cidrMask}}),allowBlank:!1}],defaults:{sortable:!0}}),selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:this.onSelectionChange,scope:this}}),listeners:{scope:this,rowcontextmenu:this.onClickCtxMenu,containercontextmenu:this.onKeyCtxMenu,validateedit:this.validator}};return Ext.apply(t,e),t},createStore:function(){var e=new Ext.data.ArrayStore({autoDestroy:!0,fields:["cidr"]});return this.addManagedComponent(e),e},addCIDR:function(){var e=this.store.getCount(),t=new this.store.recordType;this.stopEditing(),this.store.insert(e,t);var i=this.getSelectionModel();i.selectRow(e,i.isSelected(e)),this.startEditing(e,0)},deleteCIDR:function(){var e=this.getSelectionModel().getSelections();0!==e.length&&this.owner.getMsgBox().confirmDelete("",_T("app_port_alias","confirm_delete_rule")).then((t=>{"confirm"===t&&Ext.each(e,(function(e){this.store.remove(e)}),this)}))},onClickCtxMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.gridCtxMenu.showAt(i.getXY())},onSelectionChange:function(){0===this.getSelectionModel().getSelections().length?this.actionDelete.disable("delete"):this.actionDelete.enable("delete")},onKeyCtxMenu:function(e,t){e.getSelectionModel().hasSelection()&&this.gridCtxMenu.showAt(t.getXY())},validator:function(e){return!("cidr"===e.field&&0!==e.value.length&&!Ext.form.VTypes.cidr(e.value))||(e.grid.owner.getMsgBox().alert(this.title,Ext.form.VTypes.cidrText),!1)}}),Ext.define("SYNO.SDS.AdminCenter.Security.DSM.Form",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",(function(){this.createEnableGroup()}),this,{single:!0})},fillConfig:function(e){this.owner=e.owner,this.enable_mail=!0,this.dsmAPI={api:"SYNO.Core.Security.DSM",methods:{get:"get",set:"set"},version:5},this.embedAPI={api:"SYNO.Core.Security.DSM.Embed",methods:{get:"get",set:"set"},version:1};var t={title:_T("dsmsetting","session_legend"),autoFlexcroll:!0,trackResetOnLoad:!0,webapi:this.dsmAPI,items:this.getDSMSecurityItems()};return Ext.apply(t,e),t},createEnableGroup:function(){new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"skip_ip_checking",["skip_ip_checking_desc"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_block",["whitelist_desc"])},getDSMSecurityItems:function(){var e=[{xtype:"syno_checkbox",boxLabel:_T("dsmsetting","disable_session_srcip"),name:"skip_ip_checking"},{xtype:"syno_displayfield",indent:1,name:"skip_ip_checking_desc",value:_T("dsmsetting","session_security_desc")},{xtype:"syno_checkbox",boxLabel:_T("dsmsetting","dsm_token"),name:"enable_csrf_protection"},{xtype:"syno_checkbox",boxLabel:_T("dsmsetting","enable_csp_header"),name:"csp_header_option"},{webapi:this.embedAPI,xtype:"syno_checkbox",boxLabel:_T("dsmsetting","check_frame_options"),name:"enable_block",handler:function(e,t){Ext.getCmp(this.btnWhitelist).setDisabled(!t)},scope:this},{xtype:"syno_displayfield",indent:1,name:"whitelist_desc",value:_T("dsmsetting","frame_options_allow_url")},{id:this.btnWhitelist=Ext.id(),xtype:"syno_button",text:_T("dsmsetting","allowurls"),indent:1,disabled:!0,handler:this.showWhitelistDialog.createDelegate(this)},{webapi:this.embedAPI,name:"whitelist",xtype:"hidden"}];return(5==_S("majorversion")&&_S("minorversion")>=1||_S("majorversion")>=6)&&e.push({xtype:"syno_checkbox",boxLabel:_T("dsmsetting","restart_clean_session"),name:"restart_clean_session"}),[{xtype:"syno_fieldset",title:_T("common","general"),collapsible:!1,items:e},{xtype:"syno_fieldset",title:_T("controlpanel","login_settings_label"),collapsible:!1,items:[{xtype:"syno_displayfield",value:_T("dsmsetting","timeout_desc")},{xtype:"syno_numberfield",indent:1,fieldLabel:_T("dsmsetting","timeout_field"),name:"timeout",maxlength:5,minValue:1,maxValue:65535},{xtype:"syno_checkbox",boxLabel:_T("dsmsetting","allow_stay_signed_in"),name:"allow_stay_signed_in_option"},{xtype:"syno_checkbox",boxLabel:_T("dsmsetting","allow_trust_device_2fa"),name:"allow_trust_device_2fa_option"}]},{xtype:"syno_fieldset",title:_T("dsmsetting","trusted_proxies"),collapsible:!1,items:[{xtype:"syno_displayfield",name:"proxylist_desc",value:_T("dsmsetting","trusted_proxies_desc")},{xtype:"syno_button",text:_T("dsmsetting","trusted_proxies"),handler:this.showProxyListDialog.createDelegate(this)}]}]},showWhitelistDialog:function(){var e=new SYNO.SDS.AdminCenter.Security.DSM.WhitelistDialog({owner:this.module.appWin,module:this});this.addManagedComponent(e),e.show()},showProxyListDialog:function(){var e=new SYNO.SDS.AdminCenter.Security.DSM.ProxyListDialog({owner:this.module.appWin,module:this});this.addManagedComponent(e),e.show()},processParams:function(e,t){if("get"===e)return this.callParent(arguments);var i=Ext.applyIf({method:"set"},this.embedAPI);return Ext.each(t,(function(e){SYNO.ux.Utils.checkApiConsistency(e,i)&&(this.getForm().findField("enable_block").isDirty()&&(this.ownerCt.restartHttpd=!0),e.params.whitelist=this.whitelist)}),this),t},processReturnData:function(e,t,i){if(t&&Ext.isArray(t.result)){var s=Ext.applyIf({method:"get"},this.embedAPI);Ext.each(t.result,(function(e){if(SYNO.ux.Utils.checkApiConsistency(e,s))return this.ownerCt.restartHttpd=!1,this.whitelist=e.data.whitelist.sort(),!1}),this)}this.callParent(arguments)},isDirty:function(){return this.getForm().isDirty()}}),Ext.define("SYNO.SDS.AdminCenter.Security.DSM.OTPEnforceEditDialog",{extend:"SYNO.SDS.ModalWindow",DEFAULT_ROLES:[["local_user",_T("share","share_local_user")],["local_group",_T("share","share_local_group")]],DOMAIN_ROLES:[["domain_user",_T("share","share_domain_user")],["domain_group",_T("share","share_domain_group")]],LDAP_ROLES:[["ldap_user",_T("share","ldap_user")],["ldap_group",_T("share","ldap_group")]],pageSize:20,constructor:function(e){this.module=e.module,this.owner=e.owner,this.appWin=e.appWin,this.grid=this.createPanel();var t={width:750,height:420,minWidth:750,minHeight:420,closeAction:"onCancel",layout:"fit",title:_T("otp_enforcement","specific_usrgrp_title"),buttons:[{text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{text:_T("common","save"),itemId:"apply",btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.grid]};Ext.apply(t,e),this.callParent([t])},createPanel:function(e){this.store=this.createStore();var t=new SYNO.ux.EnableColumn({enableFastSelectAll:!0,header:_T("otp_enforcement","enforce_otp"),tooltip:_T("otp_enforcement","enforce_otp"),dataIndex:"is_enforced",width:100,align:"center"}),i=function(e,t){var i=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i)+'"',i},s={cm:new Ext.grid.ColumnModel([{id:"name",header:_T("user","user_account"),dataIndex:"name",renderer:i,width:80},{id:"desc",header:_T("user","user_fullname"),dataIndex:"desc",renderer:i,width:140},t]),ds:this.store,plugins:[t],autoExpandColumn:"name",enableColLock:!1,enableHdMenu:!1,cls:"without-dirty-red-grid",tbar:this.createTopToolbar(e),bbar:new SYNO.ux.PagingToolbar({store:this.store,pageSize:this.pageSize,displayInfo:!0}),listeners:{scope:this,afterrender:{fn:this.onAfterRender}}};return new SYNO.ux.GridPanel(s)},createStore:function(){return new SYNO.API.JsonStore({appWindow:this,autoDestroy:!0,api:"SYNO.Core.OTP.EnforcePolicy",method:"list",version:1,baseParams:{offset:0,limit:this.pageSize},fields:[{name:"id"},{name:"name"},{name:"desc"},{name:"is_enforced",type:"boolean"}],root:"data",idProperty:"name",remoteSort:!0,listeners:{scope:this,exception:{fn:this.onStoreException},beforeload:{fn:this.onBeforeLoad},load:{fn:this.onLoad}}})},onAfterRender:function(){this.getDomainLDAPInfo()},getDomainLDAPInfo:function(){var e=[{api:"SYNO.Core.Directory.LDAP",method:"get",version:1}];this.getKnownAPI("SYNO.Core.Directory.Domain")&&(e.push({api:"SYNO.Core.Directory.Domain",method:"get",version:1}),e.push({api:"SYNO.Core.Directory.Domain",method:"test_dc",version:1}),"yes"===_D("supportdomain")&&e.push({api:"SYNO.Core.Directory.Domain",method:"get_domain_list",version:2})),this.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},callback:function(e,t){this.clearStatusBusy(),this.loadDomainLDAPInfo(t)},scope:this})},loadDomainLDAPInfo:function(e){var t,i,s,n,o;if(t=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.LDAP","get","enable_client"),i=2702===SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.LDAP","get","error"),s=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","get","enable_domain"),n=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","test_dc","test_join_success"),o=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","get_domain_list","domain_list"),this.roleFilter.getStore().loadData(this.DEFAULT_ROLES),t&&i&&this.roleFilter.getStore().loadData(this.LDAP_ROLES,!0),s&&n&&o&&0<o.length){var a=[],r=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","get","manage_mode");this.roleFilter.getStore().loadData(this.DOMAIN_ROLES,!0),o.forEach((function(e){"object"==typeof e?e[1]?a.push(e):a.push([_T("directory_service","domainou_list_all_items"),e[1],e[2]]):a.push([e,e,e])})),this.domainFilter.getStore().loadData(a),this.domainFilter.getValue()||this.domainFilter.setValue(a[0][1]||""),this.store.baseParams.domain=this.domainFilter.getValue(),this.domainListLabel.setValue(String.format("{0}{1}",1===r?_T("directory_service","organizational_unit"):_T("helptoc","directory_service_domain"),_T("common","colon")))}this.roleFilter.setValue("local_user"),this.setDomainFilterVisible(!1),this.nameFilter.reset(),this.store.baseParams.type=this.roleFilter.getValue(),this.store.load()},onStoreException:function(e,t,i,s,n){this.clearStatusBusy(),this.getMsgBox().alert(this.title,SYNO.API.Erros.core[n.code]||_T("common","commfail"))},onBeforeLoad:function(e,t){if(this.setStatusBusy({text:_T("common","loading")}),this.isDirty())return this.clearStatusBusy(),this.getMsgBox().confirm(this.title,_T("share","share_save_chg_before_reload"),(function(e){"yes"===e?this.confirmSave(t):(this.store.rejectChanges(),this.store.load(t))}),this),!1},onLoad:function(){this.prevRole=void 0,this.clearStatusBusy()},isDirty:function(){return 0<this.store.getModifiedRecords().length},createTopToolbar:function(){return this.roleFilter=new SYNO.ux.ComboBox({itemId:"roleFilter",valueField:"role",displayField:"display",mode:"local",forceSelection:!0,store:{xtype:"arraystore",autoDestory:!0,fields:["role","display"]},listeners:{scope:this,beforeselect:{fn:this.onRoleSelect}}}),this.domainListLabel=new SYNO.ux.DisplayField({value:_T("helptoc","directory_service_domain")+_T("common","colon"),hidden:!0,itemId:"domainListLabel"}),this.domainFilter=new SYNO.ux.ComboBox({itemId:"domainFilter",valueField:"value",displayField:"domain",width:150,store:{xtype:"arraystore",autoDestory:!0,fields:["domain","value","comment"]},hidden:!0,tpl:'<tpl for="."><div ext:qtip="{comment}" class="x-combo-list-item">{domain}</div></tpl>',listeners:{scope:this,select:{fn:this.onDomainSelect}}}),this.nameFilter=new SYNO.ux.SearchField({iconStyle:"search",itemId:"search",emptyText:_T("share","share_filter_text"),width:180,store:this.store,pageSize:this.pageSize,menu:new SYNO.ux.Menu({cls:"syno-ux-check-menu",items:[{checked:!0,value:"all",text:_T("common","show_all")},{value:"enforced",text:_T("otp_enforcement","type_enforced")},{value:"unenforced",text:_T("otp_enforcement","type_unenforced")}],defaults:{group:"enforce_type",checked:!1},listeners:{scope:this,itemclick:this.onTypeFilterSelect}}),getMenu:function(){return this.menu}}),new SYNO.ux.Toolbar({items:[this.roleFilter,"->",this.domainListLabel,this.domainFilter,this.nameFilter]})},onRoleSelect:function(e,t){var i=t.data.role;this.prevRole=e.getValue(),this.store.baseParams.type=i,this.setDomainFilterVisible(0<=i.indexOf("domain")),this.store.load()},onDomainSelect:function(e,t){this.store.baseParams.domain=t.data.value,this.store.load()},onTypeFilterSelect:function(e){this.store.baseParams.enforce_type=e.value,this.store.load()},setDomainFilterVisible:function(e){this.domainListLabel.setVisible(e),this.domainFilter.setVisible(e)},onCancel:function(){var e=this;this.isDirty()?e.confirmLostChangePromise({cancel:Ext.emptyFn,save:function(){e.onApply()},dontSave:function(){e.close()}}):this.close()},getWebAPIParams:function(){var e=[];return this.store.getModifiedRecords().forEach((function(t){e.push({id:t.data.id,is_enforced:t.data.is_enforced})})),{api:"SYNO.Core.OTP.EnforcePolicy",method:"custom_set",version:1,params:{type:this.prevRole||this.roleFilter.getValue(),settings:e}}},confirmSave:function(e){this.setStatusBusy(),this.sendWebAPI(Ext.apply(this.getWebAPIParams(),{callback:function(t,i){this.clearStatusBusy(),t?(this.store.commitChanges(),this.store.load(e)):this.getMsgBox().alert(this.title,SYNO.API.Erros.core[i.code]||_T("common","commfail"))},scope:this}))},onApply:function(){this.isDirty()?(this.setStatusBusy(),this.sendWebAPI(Ext.apply(this.getWebAPIParams(),{callback:function(e,t){this.clearStatusBusy(),e?this.close():this.getMsgBox().alert(this.title,SYNO.API.Erros.core[t.code]||_T("common","commfail"))},scope:this}))):this.close()}}),Ext.define("SYNO.SDS.AdminCenter.Security.SigninPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance")&&SYNO.SDS.JSLoader.JSLoadFn("SYNO.SDS.SecureSignIn.Instance"),this.callParent([t]),this.mon(this,"afterlayout",(function(){this.createEnableGroup()}),this,{single:!0})},fillConfig:function(e){this.owner=e.owner,this.module=e.module;var t={title:_T("secure_signin","authentication"),autoFlexcroll:!0,trackResetOnLoad:!0,items:this.getSigninItems(),listeners:{activate:this.onActivate,deactivate:this.onDeactivate}};return Ext.apply(t,e),t},onActivate:function(){if(!_S("is_admin"))return;let e=this.form.findField("enable_otp_enforcement");const t=e.getValue();if(this.mon(this.form.findField("enable_otp_enforcement"),"check",this.Enforce2faCheck,this),t&&!SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance"))return void this.confirmSecureSignInService(e);const i=this.form.findField("otp_enforce_option"),s=i.getGroupValue();t?i.ownerCt.getComponent("otp_enforce_custom_setting").setDisabled("custom"!==s):i.ownerCt.getComponent("otp_enforce_custom_setting").setDisabled(!0)},onDeactivate:function(){this.mun(this.form.findField("enable_otp_enforcement"),"check",this.Enforce2faCheck,this)},createEnableGroup:function(){_S("is_admin")&&new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_otp_enforcement",["otp_enforce_option"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),this.SBEnableID,["untrust_try","untrust_minute","untrust_lock","trust_try","trust_minute","trust_lock"])},getSigninItems:function(){return _S("is_admin")?SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance")?[this.getOTPEnforceConfig(),this.getAMFAConfig(),this.getSmartBlockConfig()]:[this.getOTPEnforceConfig(),this.getSmartBlockConfig()]:[this.getSmartBlockConfig()]},Enforce2faCheck:function(e,t){if(t){if(!this.enable_mail)return void this.confirmMailService(e);if(!SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance"))return void this.confirmSecureSignInService(e);this.form.setValues({otp_enforce_option:"admin"})}else e.ownerCt.getComponent("otp_enforce_custom_setting").setDisabled(!0)},getOTPEnforceConfig:function(){return{xtype:"syno_fieldset",title:_T("personal_settings","otp_settings"),collapsible:!0,webapi:{api:"SYNO.Core.OTP.EnforcePolicy",version:1,methods:{get:"get",set:"set"}},items:[{xtype:"syno_checkbox",name:"enable_otp_enforcement",boxLabel:_T("otp_enforcement","enforce_option_desc")},{xtype:"syno_radio",indent:1,boxLabel:_T("common","admin_group_user"),name:"otp_enforce_option",inputValue:"admin"},{xtype:"syno_radio",indent:1,boxLabel:_T("mount","everyone"),name:"otp_enforce_option",inputValue:"user"},{xtype:"syno_radio",indent:1,boxLabel:_T("otp_enforcement","specific_usrgrp"),name:"otp_enforce_option",inputValue:"custom",listeners:{scope:this,check:function(e,t){e.ownerCt.getComponent("otp_enforce_custom_setting").setDisabled(!t)}}},{xtype:"syno_button",indent:2,itemId:"otp_enforce_custom_setting",text:_T("common","common_settings"),disabled:!0,handler:function(){new SYNO.SDS.AdminCenter.Security.DSM.OTPEnforceEditDialog({owner:this.module.appWin,module:this.module,appWin:this.module.appWin}).open()},scope:this},{xtype:"syno_displayfield",htmlEncode:!1,value:String.format('<span class="syno-ux-note">{0}{1} </span>',_T("common","note"),_T("common","colon"))+String.format(_T("otp_enforcement","note_set_up_otp"),'<a id="'+(this.set2fa_link=Ext.id())+'" class="link-font" style="cursor:pointer">'+_T("common","user_setting")+"</a>")}]}},getSmartBlockConfig:function(){return{xtype:"syno_fieldset",title:_T("tree","leaf_smartblock"),itemId:"fieldset_smartblock",cls:"smartblock_fieldset",webapi:{api:"SYNO.Core.SmartBlock",methods:{get:"get",set:"set"},version:1},collapsible:!0,collapsed:!0,labelWidth:300,items:[{xtype:"syno_displayfield",value:_T("smartblock","smartblock_desc")},{xtype:"syno_checkbox",name:"enabled",id:this.SBEnableID=Ext.id(),boxLabel:_T("smartblock","smartblock_enable"),disabled:!_S("is_admin"),listeners:{check:{scope:this,fn:this.onSmartBlockEnable}}},{xtype:"syno_fieldset",header:!1,itemId:"fieldset_account_protection",collapsible:!1,items:[{xtype:"syno_displayfield",indent:1,cls:"fieldset_subtitle",value:_T("smartblock","fieldset_untrust_title")},{xtype:"syno_displayfield",indent:1,value:_T("smartblock","smartblock_untrust_rule_desc")},{xtype:"syno_numberfield",name:"untrust_try",fieldLabel:_T("smartblock","smartblock_try"),disabled:!_S("is_admin"),vtype:"number",indent:1,minValue:1,maxlength:3},{xtype:"syno_numberfield",name:"untrust_minute",fieldLabel:_T("smartblock","smartblock_minute"),disabled:!_S("is_admin"),vtype:"number",indent:1,minValue:1,maxlength:3},{xtype:"syno_displayfield",value:_T("smartblock","smartblock_untrust_lock_desc"),indent:1},{xtype:"syno_numberfield",name:"untrust_lock",fieldLabel:_T("smartblock","smartblock_untrust_lock_minute"),disabled:!_S("is_admin"),vtype:"number",indent:1,maxlength:3},{xtype:"syno_button",text:_T("smartblock","smartblock_untrust_manage"),indent:1,handler:this.onSmartBlockUntrustManage,scope:this},{xtype:"syno_displayfield",indent:1,cls:"fieldset_subtitle",value:_T("smartblock","fieldset_trust_title")},{xtype:"syno_displayfield",indent:1,value:_T("smartblock","smartblock_trust_rule_desc")},{xtype:"syno_numberfield",name:"trust_try",fieldLabel:_T("smartblock","smartblock_try"),disabled:!_S("is_admin"),vtype:"number",indent:1,minValue:1,maxlength:3},{xtype:"syno_numberfield",name:"trust_minute",fieldLabel:_T("smartblock","smartblock_minute"),disabled:!_S("is_admin"),vtype:"number",indent:1,minValue:1,maxlength:3},{xtype:"syno_displayfield",value:_T("smartblock","smartblock_trust_lock_desc"),indent:1},{xtype:"syno_numberfield",name:"trust_lock",fieldLabel:_T("smartblock","smartblock_trust_lock_minute"),disabled:!_S("is_admin"),vtype:"number",indent:1,maxlength:3},{xtype:"syno_button",text:_T("smartblock","smartblock_trust_manage"),indent:1,handler:this.onSmartBlockTrustManage,scope:this}]}]}},getAMFAConfig:function(){return{xtype:"syno_fieldset",title:_T("secure_signin","amfa_title"),collapsible:!0,webapi:{api:"SYNO.SecureSignIn.AMFA.Policy",version:1,methods:{get:"get",set:"set"}},items:[{xtype:"syno_displayfield",htmlEncode:!1,value:_T("secure_signin","amfa_desc")},{xtype:"syno_checkbox",name:"enable_amfa",boxLabel:_T("secure_signin","amfa_enable")}]}},confirmMailService:function(e){this.module.appWin.getMsgBox().confirm(this.title,_T("otp_enforcement","enforce_mail_notification_service")).then((t=>{"confirm"===t?(this.getForm().reset(),this.module.app.startModule("SYNO.SDS.AdminCenter.Notification.Main")):e&&e.setValue(!1)}))},confirmSecureSignInService:function(e){this.module.appWin.getMsgBox().confirm(null,String.format(_T("secure_signin","abnormal_service_admin"),"","")).then((t=>{"confirm"===t?(this.getForm().reset(),SYNO.SDS.AppLaunch("SYNO.SDS.PkgManApp.Instance",{action:"open",packages:["SecureSignIn"]})):e&&e.setValue(!1)}))},checkOTPSetting:function(){if(!SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.SecureSignIn.Instance"))return;if(!this.form.findField("enable_otp_enforcement").getValue())return;let e=!1,t=this.form.findField("enable_otp_enforcement").isDirty();this.form.findFields("otp_enforce_option").forEach((t=>{e|=t.isDirty()})),(e||t)&&this.getOTPSetting().then((e=>{e||this.module.appWin.getMsgBox().confirm("",_T("otp_enforcement","query_setting_otp_desc"),{confirm:{text:_T("otp_enforcement","query_setting_otp_now")},cancel:{text:_T("otp_enforcement","query_setting_otp_later")}}).then((e=>{"confirm"==e&&this.launchOTPWizard()}))})).catch((e=>{SYNO.Debug("Get OTP failed",e)}))},getOTPSetting:function(){return synowebapi.promises.request({api:"SYNO.Core.OTP",version:2,method:"get_one"}).then((e=>e&&e.otp_set))},launchOTPWizard:function(){this.appWin.openWindow(SYNO.SDS.SecureSignIn.Register.TwoFactorWizard,{isOtp:!0})},processParams:function(e,t){return"get"===e?this.callParent(arguments):(Ext.each(t,(function(e){"SYNO.Core.OTP.EnforcePolicy"===e.api&&"set"===e.method&&!1===e.params.enable_otp_enforcement&&(e.params.otp_enforce_option="none")}),this),Ext.each(t,(function(e){"SYNO.SecureSignIn.AMFA.Policy"===e.api&&"set"===e.method&&(e.params.type=e.params.enable_amfa?"admin":"none",e.params.enable_amfa=void 0)}),this),t)},processReturnData:function(e,t,i){"set"===e&&this.checkOTPSetting(),this.callParent(arguments);var s=Ext.get(this.set2fa_link);s&&this.mon(s,"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.App.PersonalSettings.Instance")}),this),this.getMailSetting().then((()=>{var e;(e=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.OTP.EnforcePolicy","get"))&&this.otpDataHandler(e)})),this.processAMFAReturnData(t,i),this.processSmartBlockReturnData(t,i)},processAMFAReturnData:function(e,t){for(var i={api:"SYNO.SecureSignIn.AMFA.Policy",method:"get",version:1},s=0;s<e.result.length;s+=1){var n=e.result[s];if(!1!==SYNO.ux.Utils.checkApiConsistency(i,n)){n.data&&this.form.setValues({enable_amfa:"admin"===n.data.type});break}}},processSmartBlockReturnData:function(e,t){var i={api:"SYNO.Core.SmartBlock",method:"get",version:1};if(!1!==e.has_fail&&e.result instanceof Array)for(var s=0;s<e.result.length;s+=1){var n=e.result[s];if(!1!==SYNO.ux.Utils.checkApiConsistency(i,n)){if(!0===n.has_fail||!1===n.success)break;n.data&&this.onSmartBlockEnable(this,n.data.enabled);break}}},otpDataHandler:function(e){if(e.otp_enforce_option){var t=e.otp_enforce_option;"none"===t?this.form.setValues({enable_otp_enforcement:!1,otp_enforce_option:"admin"}):this.form.setValues({enable_otp_enforcement:!0,otp_enforce_option:t})}},onSmartBlockEnable:function(e,t){this.getComponent("fieldset_smartblock").getComponent("fieldset_account_protection").setDisabled(!t)},onSmartBlockUntrustManage:function(e,t){new SYNO.SDS.AdminCenter.Security.SmartBlock.UntrustManageDialog({module:this.module,owner:this.module.appWin}).open()},onSmartBlockTrustManage:function(e,t){new SYNO.SDS.AdminCenter.Security.SmartBlock.TrustManageDialog({module:this.module,owner:this.module.appWin}).open()},isDirty:function(){return this.getForm().isDirty()},getMailSetting:function(){return synowebapi.promises.request({compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.Notification.Mail.Conf",version:1,method:"get"},{api:"SYNO.Core.NormalUser",version:1,method:"get"}]}}).then((e=>{e.has_fail||(this.enable_mail=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Notification.Mail.Conf","get","enable_mail"),this.current_user_mail=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.NormalUser","get","email"))}))}}),Ext.define("SYNO.SDS.AdminCenter.Security.SmartBlock.UntrustManagePanel",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.parentDialog=e.parentDialog;var t=this.fillConfig(e);this.callParent([t]),this.mon(this.getSelectionModel(),"selectionchange",this.onSelectionChange,this)},fillConfig:function(e){this.actionUnlock=new Ext.Action({text:_T("smartblock","action_untrusted_unlock"),scope:this,disabled:!0,handler:this.onUnlock}),this.store=new SYNO.API.JsonStore({api:"SYNO.Core.SmartBlock.Untrusted",method:"list",version:1,listeners:{scope:this,exception:this.onException},appWindow:this.owner,root:"users",idProperty:"uid",totalProperty:"total",paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},baseParams:{offset:0,limit:50,sort_by:"time",sort_direction:"DESC"},id:"name",fields:[{name:"uid"},{name:"name",sortType:"asNaturalUCString"},{name:"time",type:"int"},{name:"ip",type:"string"},{name:"agent",type:"string"}],defaultSortable:!0});var t={ds:this.store,cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:[{header:_T("user","user_account"),headerHtmlEncode:!1,dataIndex:"name",renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Encode_And_AddTip,width:50},{header:_T("smartblock","untrusted_locked_time"),headerHtmlEncode:!1,dataIndex:"time",renderer:function(e,t,i){var s=SYNO.SDS.DateTimeFormatter(new Date(1e3*e),{type:"datetime"});return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(s)+'"',s},width:100},{header:_T("common","ip_addr"),headerHtmlEncode:!1,dataIndex:"ip",renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Encode_And_AddTip,width:70},{header:_T("smartblock","user_agent"),headerHtmlEncode:!1,dataIndex:"agent",renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Encode_And_AddTip,width:230}]}),loadMask:!0,autoExpandColumn:"name",enableDragDrop:!1,enableColumnMove:!1,enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1}),tbar:[this.actionBtn=new SYNO.ux.Button(this.actionUnlock)],bbar:{xtype:"syno_paging",store:this.store,displayButtons:!0,displayInfo:!0,pageSize:SYNO.SDS.AdminCenter.USER_PAGING_SIZE}};return Ext.apply(t,e),t},afterRender:function(){this.callParent(arguments),this.parentDialog.setStatusBusy({text:_T("common","loading")}),this.store.load(),this.parentDialog.clearStatusBusy()},onException:function(){this.owner.getMsgBox().alert(this.owner.title,_T("common","commfail")),this.store.loadData({},!1)},onUnlock:function(){var e=this.getSelectionModel().getSelections().map((function(e){return e.data.uid}));e.length<=0||this.sendWebAPI({api:"SYNO.Core.SmartBlock.Untrusted",version:1,method:"pardon",params:{users:e},scope:this,callback:this.onWebapiDone})},onWebapiDone:function(e,t,i){e||this.getMsgBox().alert("",SYNO.API.getErrorString(t.code)),this.store.load()},onClose:function(){this.parentDialog.close()},onSelectionChange:function(e){0<e.getCount()?this.setBtn(this.actionBtn,!0):this.setBtn(this.actionBtn,!1)},setBtn:function(e,t){t?e.enable():e.disable()}}),Ext.define("SYNO.SDS.AdminCenter.Security.SmartBlock.UntrustManageDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=new SYNO.SDS.AdminCenter.Security.SmartBlock.UntrustManagePanel({module:this.module,appWin:this.module.appWin,owner:this.owner,parentDialog:this});var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={layout:"fit",autoDestroy:!0,title:_T("smartblock","manage_untrust_title"),border:!1,width:800,height:600,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","close"),scope:this.panel,handler:this.panel.onClose}]};return Ext.apply(t,e),t}}),Ext.define("SYNO.SDS.AdminCenter.Security.SmartBlock.TrustManagePanel",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.parentDialog=e.parentDialog;var t=this.fillConfig(e);this.callParent([t]),this.mon(this.getSelectionModel(),"selectionchange",this.onSelectionChange,this)},fillConfig:function(e){this.actionUnlock=new Ext.Action({text:_T("smartblock","action_trusted_unlock"),scope:this,disabled:!0,handler:this.onUnlock}),this.store=new SYNO.API.JsonStore({api:"SYNO.Core.SmartBlock.Trusted",method:"list",version:1,listeners:{scope:this,exception:this.onException},appWindow:this.owner,root:"devices",idProperty:"id",totalProperty:"total",paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},baseParams:{offset:0,limit:50,sort_by:"time",sort_direction:"DESC"},id:"name",fields:[{name:"id",type:"string"},{name:"name",sortType:"asNaturalUCString"},{name:"time",type:"int"},{name:"ip",type:"string"},{name:"agent",type:"string"}],defaultSortable:!0});var t={title:_T("smartblock","manage_trust_locked_title"),ds:this.store,cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:[{header:_T("smartblock","client_id"),headerHtmlEncode:!1,dataIndex:"id",renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Encode_And_AddTip,width:50},{header:_T("smartblock","trusted_locked_time"),headerHtmlEncode:!1,dataIndex:"time",renderer:function(e,t,i){var s=SYNO.SDS.DateTimeFormatter(new Date(1e3*e),{type:"datetime"});return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(s)+'"',s},width:100},{header:_T("common","ip_addr"),headerHtmlEncode:!1,dataIndex:"ip",renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Encode_And_AddTip,width:70},{header:_T("smartblock","user_agent"),headerHtmlEncode:!1,dataIndex:"agent",renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Encode_And_AddTip,width:230}]}),loadMask:!0,autoExpandColumn:"name",enableDragDrop:!1,enableColumnMove:!1,enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1}),tbar:[this.actionBtn=new SYNO.ux.Button(this.actionUnlock)],bbar:{xtype:"syno_paging",store:this.store,displayButtons:!0,displayInfo:!0,pageSize:SYNO.SDS.AdminCenter.USER_PAGING_SIZE}};return Ext.apply(t,e),t},afterRender:function(){this.callParent(arguments),this.parentDialog.setStatusBusy({text:_T("common","loading")}),this.store.load(),this.parentDialog.clearStatusBusy()},onException:function(){this.owner.getMsgBox().alert(this.owner.title,_T("common","commfail")),this.store.loadData({},!1)},onUnlock:function(){var e=this.getSelectionModel().getSelections().map((function(e){return e.data.id}));e.length<=0||this.sendWebAPI({api:"SYNO.Core.SmartBlock.Trusted",version:1,method:"pardon",params:{devices:e},scope:this,callback:this.onWebapiDone})},onWebapiDone:function(e,t,i){e||this.getMsgBox().alert("",SYNO.API.getErrorString(t.code)),this.store.load()},onSelectionChange:function(e){0<e.getCount()?this.setBtn(this.actionBtn,!0):this.setBtn(this.actionBtn,!1)},setBtn:function(e,t){t?e.enable():e.disable()},onClose:function(){this.parentDialog.close()}}),Ext.define("SYNO.SDS.AdminCenter.Security.SmartBlock.TrustManageDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=new SYNO.SDS.AdminCenter.Security.SmartBlock.TrustManagePanel({module:this.module,appWin:this.module.appWin,owner:this.owner,parentDialog:this});var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={layout:"fit",autoDestroy:!0,title:_T("smartblock","manage_trust_title"),border:!1,width:800,height:600,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","close"),scope:this.panel,handler:this.panel.onClose}]};return Ext.apply(t,e),t}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwProfileManageDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.mode=e.mode,this.selectedRecord=e.selectedRecord;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t,i="",s=[];"clone"===e.mode&&(i=_T("firewall","clone_firewall_profile"),s.push({labelWidth:185,labelStyle:"padding-left:20px;",width:250,xtype:"syno_displayfield",fieldLabel:_T("firewall","profile_to_clone"),value:this.selectedRecord.get("profileName"),itemCls:"syno-firewall-profile-style-second"},{labelWidth:185,labelStyle:"padding-left:20px;",width:250,xtype:"syno_textfield",fieldLabel:_T("firewall","firewall_profile_new_name"),itemId:"new_profile_name",vtype:"username",vtypeText:_T("firewall","firewall_profile_name_format_error"),allowBlank:!1}),t=this.applyCloningProfile);var n={dsmStyle:"v5",layout:"form",title:i,border:!1,width:475,height:190,items:s,buttons:[{text:_T("common","cancel"),handler:function(){this.close()},scope:this},{btnStyle:"blue",text:_T("common","apply"),handler:t,scope:this,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""}],listeners:{beforeclose:this.onBeforeClose.createDelegate(this)}};return Ext.apply(n,e),n},applyCloningProfile:function(){var e=this.getComponent("new_profile_name"),t=this.selectedRecord.get("profileName"),i=e.getValue();e.isValid()?(this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"clone",params:{name:t,clone_name:i}},scope:this,callback:function(t,s){if(!t)return this.clearStatusBusy(),void this.getMsgBox().alert("",_T("firewall","fail_clone_profile"));this.owner.updateGridView(i),e.originalValue=i,this.clearStatusBusy(),this.close()}})):e.focus()},onBeforeClose:function(){var e=this.getComponent("new_profile_name");if(e.isDirty())return this.confirmLostChangePromise({save:this.applyCloningProfile,dontSave:function(){e.reset(),this.close()},cancel:Ext.emptyFn},this),!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwProfileRuleData",{constructor:function(e){this.owner=e.owner,this.window=e.window,this.data={},this.dirty=!1,this.adapterRuleStore=new Ext.data.JsonStore({servicePortInfo:[],root:"rules",pruneModifiedRecords:!0,fields:[{name:"enable",type:"bool"},"name","port_direction","port_group","ports","protocol","source_ip_group","source_ip","policy",{name:"log",type:"bool"}]})},loadData:function(e,t){if(Ext.isEmpty(e))return this.data={},this.clearDirty(),void this.adapterRuleStore.loadData({rules:[]});this.window.setStatusBusy(),this.owner.sendWebAPI({api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"get",params:{name:e},scope:this,callback:function(e,i){e?(this.data=i,this.clearDirty(),this.adapterRuleStore.loadData(this.data[t]),this.window.clearStatusBusy()):this.window.getMsgBox().alert("",_T("firewall","fail_load_profile"))}})},getData:function(){return this.data},dataToStore:function(e){void 0!==this.data[e]?this.adapterRuleStore.loadData(this.data[e]):this.adapterRuleStore.loadData({rules:[]})},storeToData:function(e){if(this.isDirty()){this.setDirty(),void 0===this.data[e]&&(this.data[e]={}),this.data[e].rules=[];var t=this.adapterRuleStore.getRange();Ext.each(t,(function(t){var i=t.data;this.data[e].rules.push(i)}),this)}},getAdapterPolicy:function(e){return void 0===this.data[e]?"allow":this.data[e].policy},setAdapterPolicy:function(e,t){void 0===this.data[e]&&(this.data[e]={policy:"allow",rules:[]}),t!==this.data[e].policy&&(this.data[e].policy=t,this.dirty=!0)},isDirty:function(){return this.dirty||1<=this.adapterRuleStore.getModifiedRecords().length},setDirty:function(){this.dirty=!0},clearDirty:function(){this.dirty=!1,this.adapterRuleStore.modified=[]},resetForm:function(){this.dirty=!1,this.adapterRuleStore.rejectChanges()}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwCustomPortsDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=this.createPanel(),this.form=this.panel.getForm();var t={width:560,height:330,title:_T("firewall","firewall_ports_self_defined"),layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onApply}]};Ext.apply(t,e),this.callParent([t]),this.DefineBehaviors()},createPanel:function(){var e={padding:"0",border:!1,items:[{xtype:"syno_combobox",name:"port_type",hiddenName:"port_type",fieldLabel:_T("firewall","firewall_port_type"),displayField:"display",labelWidth:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH+50,width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,valueField:"value",value:"destination",store:new Ext.data.ArrayStore({autoDestroy:!0,fields:["value","display"],data:[["source",_T("firewall","firewall_port_type_source")],["destination",_T("firewall","firewall_port_type_dest")]]})},{xtype:"syno_combobox",name:"protocol",labelWidth:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH+50,fieldLabel:_T("firewall","firewall_protocol"),fields:["value","display"],width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,displayField:"display",valueField:"value",value:"tcp",scope:this,store:new Ext.data.ArrayStore({autoDestroy:!0,fields:["value","display"],data:[["tcp",_T("firewall","firewall_protocol_tcp")],["udp",_T("firewall","firewall_protocol_udp")],["icmp",_T("firewall","firewall_protocol_icmp")],["igmp",_T("firewall","firewall_protocol_igmp")],["all",_T("firewall","firewall_ports_all")]]}),listeners:{scope:this,select:this.onCheckCustomPort}},{xtype:"syno_compositefield",hideLabel:!0,labelWidth:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH,fieldLabel:_T("firewall","firewall_ports")+_T("firewall","firewall_split_by_common"),itemId:"firewall_ports_container",defaultMargins:"0 0 0 0",items:[{xtype:"syno_radio",name:"self_port_choose",boxLabel:_T("firewall","firewall_ports")+_T("firewall","firewall_split_by_common")+_T("common","colon"),itemId:"firewall_ports",id:this.firewall_ports_id=Ext.id(),width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH+50,inputValue:"ports"},{xtype:"syno_textfield",name:"self_ports_value",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,validateOnBlur:!0,vtype:"fwports"}]},{xtype:"syno_radio",boxLabel:_T("firewall","firewall_ports_range"),name:"self_port_choose",width:2*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH,itemId:"firewall_ports_range",id:this.firewall_ports_range_id=Ext.id(),inputValue:"ports_range"},{xtype:"syno_numberfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,indent:1,labelWidth:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH+50,fieldLabel:_T("ftp","ftp_port_from"),validateOnBlur:!0,name:"self_ports_range_from",maxlength:5,vtype:"port"},{xtype:"syno_numberfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,indent:1,labelWidth:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH+50,fieldLabel:_T("ftp","ftp_port_to"),validateOnBlur:!0,name:"self_ports_range_to",maxlength:5,vtype:"port"}]};return new SYNO.ux.FormPanel(e)},DefineBehaviors:function(){this.enableRadioGroupDummy=new SYNO.ux.Utils.EnableRadioGroup(this.form,"self_port_choose",{ports_range:["self_ports_range_from","self_ports_range_to"],ports:["self_ports_value"]}),this.radioPortsRange=Ext.getCmp(this.firewall_ports_range_id),this.radioPorts=Ext.getCmp(this.firewall_ports_id),this.comboPortType=this.form.findField("port_type")},onCheckCustomPort:function(){"icmp"==this.form.findField("protocol").getValue()||"igmp"==this.form.findField("protocol").getValue()?(this.comboPortType.disable(),this.radioPorts.disable(),this.radioPortsRange.disable()):(this.comboPortType.enable(),this.radioPorts.enable(),this.radioPortsRange.enable())},onApply:function(){this.validateForm(this.form)&&(this.owner.setCustom(this.getValue()),this.close())},validateForm:function(e){var t=e.findField("self_port_choose").getGroupValue();if(!e.isValid())return!1;if("icmp"===e.findField("protocol").getValue()||"igmp"===e.findField("protocol").getValue())return!0;if("ports"==t){if(!SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["self_ports_value"])||!SYNO.SDS.AdminCenter.Utils.Validator.MarkPortsExceed(e,"self_ports_value","FW"))return!1}else if("ports_range"==t&&(SYNO.SDS.AdminCenter.Utils.Validator.ExchgLessThanField(e,"self_ports_range_from","self_ports_range_to"),!SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["self_ports_range_from","self_ports_range_to"])))return!1;return!0},getSelfPorts:function(){var e=this.form.findField("self_port_choose").getGroupValue(),t="";return"ports"==e?t=this.form.findField("self_ports_value").getValue():"ports_range"==e&&(t=String.format("{0}-{1}",this.form.findField("self_ports_range_from").getValue(),this.form.findField("self_ports_range_to").getValue())),t},getValue:function(){var e={protocol:"",ports:"",port_direction:""};return e.protocol=this.form.findField("protocol").getValue(),"icmp"===e.protocol&&"igmp"===e.protocol||(e.ports=this.getSelfPorts(),e.port_direction=this.comboPortType.getValue()),e},setValue:function(e,t,i){var s="",n="";e.indexOf("-")>0?(s=e.split("-")[0],n=e.split("-")[1],this.form.findField("self_port_choose").setValue("ports_range"),this.form.findField("self_ports_range_from").setValue(s),this.form.findField("self_ports_range_to").setValue(n)):(this.form.findField("self_port_choose").setValue("ports"),this.form.findField("self_ports_value").setValue(e)),"icmp"!=i&&"igmp"!=i||(t="destination"),this.form.findField("port_type").setValue(t),this.form.findField("protocol").setValue(i),this.onCheckCustomPort()}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwSrcIpDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=this.createPanel(),this.form=this.panel.getForm();var t={width:600,height:345,title:_T("firewall","firewall_source"),layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onApply}]};this.setDefault(),Ext.apply(t,e),this.callParent([t]),this.OnSourceRadioClick(this.form.findField("source"),!0)},createPanel:function(){var e={padding:"0",xtype:"syno_fieldset",title:_T("firewall","firewall_source"),itemId:"firewall_source",items:[{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_radio",name:"source",itemId:"nfs_fieldtitle_host",width:1.5*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH-6,boxLabel:_T("nfs","nfs_fieldtitle_host"),inputValue:"single",scope:this,checked:!0,handler:this.OnSourceRadioClick},{xtype:"syno_radio",name:"source",itemId:"firewall_source_network",width:1.5*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,boxLabel:_T("firewall","firewall_source_network"),inputValue:"subnet",scope:this,handler:this.OnSourceRadioClick}]},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.5*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_ipaddr"),name:"source_ip",itemId:"tcpip_ipaddr",vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)&&(this.nextSibling().validate(),!0)}},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.5*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_mask")+"/"+_T("tcpip","ipv6_prefixleng"),name:"source_subnet_mask",itemId:"tcpip_mask",maskRe:/[.0-9]/,invalidText:_JSLIBSTR("vtype","bad_mask"),allowBlank:!1,validator:function(e){var t=this.previousSibling().getValue();return Ext.form.VTypes.fwLoosev6ipVal.test(t)?e>=0&&e<=128||_JSLIBSTR("vtype","bad_ipv6prefixLeng"):!!Ext.form.VTypes.netmaskVal.test(e)}},{xtype:"syno_radio",boxLabel:_T("firewall","firewall_ip_range"),name:"source",width:1.5*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH,itemId:"firewall_source_range",inputValue:"range",scope:this,handler:this.OnSourceRadioClick},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.5*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("ftp","ftp_port_from"),name:"source_ip_begin",itemId:"tcpip_ipaddr_begin",vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)}},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.5*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("ftp","ftp_port_to"),name:"source_ip_end",itemId:"tcpip_ipaddr_end",vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)}}]};return new SYNO.ux.FormPanel(e)},onApply:function(){if(this.validateBlank(this.form))if(this.form.isValid()){var e=this.getSrc();this.setSource(e.source_ip,e.source_ip_group),this.owner.setSrc(e.source_ip,e.source_ip_group),this.close()}else this.setStatusError({text:_T("common","forminvalid"),clear:!0});else"range"===this.form.findField("source").getGroupValue()?this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_error_ip_range")):this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("common","forminvalid"))},getSrc:function(){var e,t=this.form.findField("source").getGroupValue();if("single"===t)e={source_ip:this.form.findField("source_ip").getValue(),source_ip_group:"ip"};else if("range"===t){e={source_ip:this.form.findField("source_ip_begin").getValue()+"-"+this.form.findField("source_ip_end").getValue(),source_ip_group:"iprange"}}else"subnet"===t&&(e={source_ip:String.format("{0}/{1}",this.form.findField("source_ip").getValue(),this.form.findField("source_subnet_mask").getValue()),source_ip_group:"netmask"});return e},onOpen:function(e,t){this.setStatusBusy(),this.setSource(e,t),this.clearStatusBusy(),this.callParent(arguments)},setDefault:function(){this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable()},setSource:function(e,t){var i="",s="",n="single",o="",a="",r="";"iprange"===t?(a=(o=e.split("-"))[0],r=o[1],n="range",this.form.findField("source_ip_begin").setValue(a),this.form.findField("source_ip_end").setValue(r)):"netmask"===t?(i=(o=e.split("/"))[0],s=o[1],n="subnet",this.form.findField("source_ip").setValue(i),this.form.findField("source_subnet_mask").setValue(s)):"ip"===t&&(this.form.findField("source_ip").setValue(e),n="single"),this.form.findField("source").setValue(n)},OnSourceRadioClick:function(e,t){if(e.checked)switch(e.value){case"single":default:this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable();break;case"subnet":this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").enable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable();break;case"range":this.form.findField("source_ip").disable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").enable(),this.form.findField("source_ip_end").enable()}},validateBlank:function(e){var t,i,s,n,o,a=!0,r=0,l=0,d="",c=e.findField("source").getGroupValue();if("single"==c)a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip"]);else if("subnet"==c)(a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip"]))&&(a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_subnet_mask"]));else if(SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip_begin"])&&SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip_end"]))if(i=e.findField("source_ip_begin").getValue().toString(),s=e.findField("source_ip_end").getValue().toString(),0<i.indexOf(".")&&0<s.indexOf(".")){if(d=/([0-9]+).([0-9]+).([0-9]+).([0-9]+)/,null===(n=i.match(d))||null===(o=s.match(d)))return!1;for(r=1;r<n.length;r++){if(parseInt(o[r],10)>parseInt(n[r],10)){a=!0;break}if(parseInt(o[r],10)<parseInt(n[r],10)){a=!1;break}a=!1}}else if(0<i.indexOf(":")&&0<s.indexOf(":")){if(0<i.indexOf("::")){for(l=i.match(/:/g).length,t="::",r=0;r<7-l;r++)t+=":";i=i.replace("::",t)}if(0<s.indexOf("::")){for(l=s.match(/:/g).length,t="::",r=0;r<7-l;r++)t+=":";s=s.replace("::",t)}if(d=/([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*)/,null===(n=i.match(d))||null===(o=s.match(d)))return!1;for(r=1;r<n.length;r++){if(""===n[r]&&(n[r]=0),""===o[r]&&(o[r]=0),parseInt(o[r],16)>parseInt(n[r],16)){a=!0;break}if(parseInt(o[r],16)<parseInt(n[r],16)){a=!1;break}a=!1}}else a=!1;else a=!1;return!!a}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwGeoipDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.grid=new SYNO.SDS.AdminCenter.Security.GeoipGrid({module:this.module,owner:this,father:this});var t={width:650,height:430,title:_T("common","location"),layout:"fit",items:[this.grid],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onApply}]};Ext.apply(t,e),this.callParent([t])},onActivate:function(){return this.callParent(arguments)},onApply:function(){var e=this.grid.getSrc(),t=this.validSrc(e);-1!=t?-2!=t?(this.owner.setSrc(e,"geoip"),this.close()):this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_over_set_countries")):this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_no_set_countries"))},setVal:function(e){this.grid.setVal(e)},validSrc:function(e){return null===e.match(/^([A-Z0-9]{2},)*[A-Z0-9]{2}$/)?-1:15<e.split(",").length?-2:0},openDetaiIpDialog:function(){new SYNO.SDS.AdminCenter.Security.FwGeoipDetailDialog({module:this.module,owner:this,grid:this.grid}).open()}}),Ext.define("SYNO.SDS.AdminCenter.Security.GeoipGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.father=e.father,this.enabledCountries=[],this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","selected"),dataIndex:"enabled",enableFastSelectAll:!0,menuDisabled:!0,sortable:!0,width:120,resizable:!0,align:"center",tooltip:_T("common","selected")}),this.store=new SYNO.API.JsonStore({api:"SYNO.Core.Security.Firewall.Geoip",method:"list",version:1,root:"countries",fields:["country_code","country_search_name"],appWindow:this.findAppWindow()||!1,sortInfo:{field:"country_code",direction:"ASC"},autoDestroy:!0,listeners:{scope:this,beforeload:this.onBeforeLoad,load:this.onLoad,exception:this.onException}});var t=new Ext.grid.ColumnModel([this.enableColumn,{id:"country_code",header:_T("dhcp_server","option_num"),dataIndex:"country_code",width:80,align:"center",renderer:function(e,t){return"EU"!==e&&"AQ"!==e&&"AP"!==e||(e=_T("firewall",e+"_other")),e}},{id:"country_name",header:_T("common","location"),dataIndex:"country_code",width:170,align:"center",renderer:function(e,t){if("EU"===e||"AQ"===e||"AP"===e){e=_T("Country",e),e=String.format(_T("firewall","firewall_ip_country_extra"),e,e)}else e=_T("Country",e);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e}}]),i=Ext.apply({ds:this.store,cm:t,loadMask:!1,viewConfig:{markDirty:!1},enableColLock:!0,enableColumnMove:!1,enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({}),plugins:[this.enableColumn],listeners:{rowdblclick:function(){this.father.openDetaiIpDialog()},scope:this},tbar:{items:["->",new SYNO.ux.TextFilter({iconStyle:"search",itemId:"search",localFilter:!0,localFilterField:"country_search_name",store:this.store,queryParam:"filter",pageSize:SYNO.SDS.AdminCenter.USER_PAGING_SIZE})]}},e);this.callParent([i])},contryShow:function(e,t){return e=_T("Country",e),t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e},getSrc:function(){var e=[];return this.getStore().query("enabled",!0).each((function(t){e.push(t.get("country_code"))})),e.join(",")},setVal:function(e){""===e?this.enabledCountries.length=0:this.enabledCountries=e.split(","),this.getStore().load()},onEnableCountries:function(e){for(var t,i=this.getStore(),s=i.getCount(),n=0;n<e.length;n++)for(var o=0;o<s;o++)if(t=i.getAt(o),e[n]==t.get("country_code")){t.set("enabled",!0);break}i.commitChanges()},setCountrySearchName:function(){var e,t=0,i=this.store.getCount();if(!(0>=i))for(t=0;t<i;t++)e=this.store.getAt(t),this.store.data.items[t].data.country_search_name=_T("Country",e.data.country_code)+e.data.country_code},onBeforeLoad:function(){this.owner.setStatusBusy()},onLoad:function(e){this.onEnableCountries(this.enabledCountries),this.setCountrySearchName(),this.owner.clearStatusBusy()},onException:function(){this.owner.clearStatusBusy()}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwGeoipDetailDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.country_code=e.grid.getSelectionModel().getSelected().get("country_code"),this.grid=new SYNO.SDS.AdminCenter.Security.FwGeoipDetailGrid({module:this.module,owner:this,country_code:this.country_code});var t={width:450,height:430,title:"EU"===this.country_code||"AQ"===this.country_code||"AP"===this.country_code?_T("firewall",this.country_code+"_other"):_T("Country",this.country_code),layout:"fit",items:[this.grid],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close}]};Ext.apply(t,e),this.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwGeoipDetailGrid",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.country_code=e.country_code,this.tbar=new Ext.Toolbar({defaultType:"syno_button",items:this.configToolBar()}),this.store=this.createStore();var t=Ext.apply({tbar:this.tbar,store:this.store,viewConfig:{markDirty:!1},columns:[{id:"ip_begin",header:_T("tcpip","tcpip_ipaddr")+" "+_T("ftp","ftp_port_from"),dataIndex:"ip_begin",width:80},{id:"ip_end",header:_T("tcpip","tcpip_ipaddr")+" "+_T("ftp","ftp_port_to"),dataIndex:"ip_end",width:180}],enableDragDrop:!1,enableColumnMove:!1,enableHdMenu:!1,autoExpandColumn:"ip_begin",monitorWindowResize:!0,listeners:{scope:this,afterrender:{fn:function(){this.loadStore(!1)}}},selModel:new Ext.grid.RowSelectionModel({})},e);this.callParent([t])},createStore:function(){return new SYNO.API.JsonStore({api:"SYNO.Core.Security.Firewall.Geoip",method:"get",appWindow:this.findAppWindow()||!1,baseParams:{},version:1,autoDestroy:!0,defaultSortable:!0,root:"country_ip_list",fields:["ip_begin","ip_end"],listeners:{scope:this,beforeload:this.onBeforeLoad,load:this.onLoad,exception:this.onException}})},onBeforeLoad:function(){this.owner.setStatusBusy()},onLoad:function(){this.owner.clearStatusBusy()},onException:function(){this.owner.clearStatusBusy()},loadStore:function(e){this.store.load({params:{country_code:this.country_code,is_ipv6:e}})},configToolBar:function(){var e=new Ext.data.ArrayStore({fields:["id","display"],data:[[0,"IPv4"],[1,"IPv6"]]});return[{xtype:"syno_combobox",id:this.IPTypeComboId=Ext.id(),displayField:"display",valueField:"id",value:0,store:e,listeners:{select:this.onIPTypeSelect,scope:this}}]},onIPTypeSelect:function(e,t,i){"IPv6"==t.get("display")?this.loadStore(!0):this.loadStore(!1)}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwRuleDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.portInfo=e.portInfo,this.mode=e.mode,this.FwLoadApiMaxVer=2,this.panel=this.createPanel(),this.form=this.panel.getForm();var t={dsmStyle:"v5",width:620,height:540,resizable:!1,title:_T("firewall","firewall_rule_add"),items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onUpdateRuleGrid}]};Ext.apply(t,e),this.callParent([t]),this.DefineBehaviors()},DefineBehaviors:function(){this.btnChoose=Ext.getCmp(this.btnChooseId),this.btnSelfDefine=Ext.getCmp(this.btnSelfDefineId),this.btnSrcDefine=Ext.getCmp(this.btnSrcDefineId),this.btnChoose.disable(),this.btnSelfDefine.disable(),this.btnSrcDefine.disable(),2==this.FwLoadApiMaxVer&&(this.btnGeoipDefine=Ext.getCmp(this.btnGeoipDefineId),this.btnGeoipDefine.disable())},createPanel:function(){var e={xtype:"syno_fieldset",title:_T("firewall","firewall_ports"),itemId:"firewall_ports",hideLabel:!0,items:[{xtype:"syno_radio",itemId:"firewall_ports_all",boxLabel:_T("firewall","firewall_ports_all"),name:"ports",inputValue:"all",checked:!0,scope:this,handler:this.onCheckPorts},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_radio",itemId:"firewall_ports_system",boxLabel:_T("firewall","firewall_ports_system"),name:"ports",width:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,inputValue:"service",scope:this,handler:this.onCheckPorts},{xtype:"syno_button",text:_T("common","choose"),scope:this,width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,id:this.btnChooseId=Ext.id(),handler:function(e,t){var i=new SYNO.SDS.AdminCenter.Utils.Dialog.ServPortsDialog({module:this.module,owner:this,serverPorts:this.portInfo});i.setVal(this.serviceChoose),i.open()}}]},{xtype:"syno_compositefield",itemId:"custom_ports_fieldset",hideLabel:!0,items:[{xtype:"syno_radio",boxLabel:_T("firewall","firewall_ports_self_defined"),name:"ports",width:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,inputValue:"custom",scope:this,handler:this.onCheckPorts},{xtype:"syno_button",id:this.btnSelfDefineId=Ext.id(),text:_T("firewall","firewall_ports_self_defined"),scope:this,width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,handler:function(e,t){var i=new SYNO.SDS.AdminCenter.Security.FwCustomPortsDialog({module:this.module,owner:this});i.setValue(this.customVal.ports,this.customVal.port_direction,this.customVal.protocol),i.open()}}]}]},t=[];t.push({xtype:"syno_radio",name:"source",itemId:"firewall_ports_all",boxLabel:_T("firewall","firewall_ports_all"),inputValue:"all",scope:this,checked:!0,handler:this.onCheckSrc},{xtype:"syno_compositefield",itemId:"specific_source_fieldset",hideLabel:!0,items:[{xtype:"syno_radio",name:"source",boxLabel:_T("firewall","firewall_specific_ip"),inputValue:"specific_source",width:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,scope:this,handler:this.onCheckSrc},{xtype:"syno_button",id:this.btnSrcDefineId=Ext.id(),text:_T("common","choose"),scope:this,width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,handler:function(e,t){new SYNO.SDS.AdminCenter.Security.FwSrcIpDialog({module:this.module,owner:this,GridStore:this.GridStore}).open(this.source_ip,this.source_ip_group)}}]}),2==this.FwLoadApiMaxVer&&t.push({xtype:"syno_compositefield",itemId:"geoip_source_fieldset",hideLabel:!0,items:[{xtype:"syno_radio",boxLabel:_T("common","location"),name:"source",width:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,inputValue:"geoip_source",scope:this,handler:this.onCheckSrc},{xtype:"syno_button",id:this.btnGeoipDefineId=Ext.id(),text:_T("common","choose"),scope:this,width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,handler:function(e,t){var i=new SYNO.SDS.AdminCenter.Security.FwGeoipDialog({module:this.module,owner:this});i.setVal(this.source_ip),i.open(this.mode)}}]});var i={padding:"0 0 0 0",border:!1,width:590,height:460,items:[e,{xtype:"syno_fieldset",title:_T("firewall","firewall_source"),itemId:"firewall_source",items:t},{xtype:"syno_fieldset",title:_T("firewall","firewall_allow"),itemId:"firewall_allow",items:[{xtype:"syno_compositefield",hideLabel:!0,defaults:{flex:1},items:[{xtype:"syno_radio",name:"allow",itemId:"firewall_policy_allow",boxLabel:_T("firewall","firewall_policy_allow"),inputValue:"allow",scope:this,checked:!0},{xtype:"syno_radio",name:"allow",itemId:"firewall_policy_drop",boxLabel:_T("firewall","firewall_policy_drop"),inputValue:"drop",scope:this},{xtype:"syno_displayfield"}]}]},{xtype:"syno_checkbox",hidden:"add"!==this.mode,boxLabel:_T("common","enabled"),name:"enable",checked:!0}]};return new SYNO.ux.FormPanel(i)},onOpen:function(){var e;this.setStatusBusy(),this.setDefault(),"add"===this.mode?this.setTitle(_T("firewall","firewall_rule_add")):"edit"===this.mode&&(this.setTitle(_T("firewall","firewall_rule_edit")),e=this.gridRules.getSelectionModel().getSelected(),this.setValue(e)),this.onCheckPorts(this.panel.getForm().findField("ports"),!0),this.clearStatusBusy(),this.callParent(arguments)},setDefault:function(){this.customVal={ports:"",port_direction:"destination",protocol:"tcp"},this.source_ip="",this.source_ip_group="",this.source_subnet_mask="",this.serviceChoose="",this.ruleRecord=new SYNO.SDS.AdminCenter.Security.Utils.FwRULERecord({enable:!0,name:"",port_direction:"",port_group:"",ports:"",protocol:"",source_ip_group:"",source_ip:"",policy:"",log:!1})},getRecordInForm:function(){var e=this.getPorts(),t=this.getAllow();return this.getSrc(),new SYNO.SDS.AdminCenter.Security.Utils.FwRULERecord({enable:this.form.findField("enable").getValue(),name:this.ruleRecord.get("name"),port_direction:e.port_direction,port_group:e.port_group,ports:e.ports,protocol:e.protocol,source_ip_group:this.source_ip_group,source_ip:this.source_ip,policy:t,log:this.ruleRecord.get("log")})},onUpdateRuleGrid:function(){var e,t,i=this.gridRules.profileData.adapterRuleStore;this.validateForm(this.form)&&(e=this.getRecordInForm(),"add"===this.mode?i.add(e):"edit"===this.mode&&((t=this.gridRules.getSelectionModel().getSelected()).set("enable",e.get("enable")),t.set("name",e.get("name")),t.set("port_direction",e.get("port_direction")),t.set("port_group",e.get("port_group")),t.set("ports",e.get("ports")),t.set("protocol",e.get("protocol")),t.set("source_ip",e.get("source_ip")),t.set("source_ip_group",e.get("source_ip_group")),t.set("policy",e.get("policy")),t.set("log",e.get("log"))),this.close())},setValue:function(e){this.ruleRecord=e,this.setPorts(e.get("port_group"),e.get("ports"),e.get("port_direction"),e.get("protocol")),this.setSrc(e.get("source_ip"),e.get("source_ip_group")),this.setAllow(e.get("policy")),this.form.findField("enable").setValue(e.get("enable"))},getAllow:function(){return this.form.findField("allow").getGroupValue()},setAllow:function(e){return this.form.findField("allow").setValue(e)},getSrc:function(){"all"===this.form.findField("source").getGroupValue()&&(this.source_ip_group="all",this.source_ip="all")},setSrc:function(e,t){var i="",s="";if("all"===t)this.source_ip="all",this.source_ip_group="all",s="all";else if("geoip"===t)this.source_ip=e,this.source_ip_group="geoip",s="geoip_source";else if("iprange"===t)this.source_ip=e,this.source_ip_group="iprange",s="specific_source";else if("netmask"===t){var n=e.split("/");n[0],i=n[1],this.source_ip=e,this.source_ip_group="netmask",this.source_subnet_mask=i,s="specific_source"}else this.source_ip=e,this.source_ip_group="ip",s="specific_source";this.form.findField("source").setValue(s)},setPorts:function(e,t,i,s){"service"===e||"reserved"===e?(this.serviceChoose=t,e="service"):"custom"===e&&(this.customVal={ports:t,port_direction:i,protocol:s}),this.form.findField("ports").setValue(e),this.setServicesProtocol(s)},getPorts:function(){var e=this.form.findField("ports").getGroupValue(),t={port_group:"",ports:"",port_direction:"",protocol:""},i="";return"all"===e?(t.ports="all",t.port_group="all",t.protocol="all"):"service"===e?(t.port_group="service",t.ports=this.getServices(),t.protocol=this.getServicesProtocol()):"custom"===e&&(i=this.getCustom(),t.port_group="custom",t.ports=i.ports,t.port_direction=i.port_direction,t.protocol=i.protocol),t},getServices:function(){return this.serviceChoose},setServices:function(e){this.serviceChoose=e},getServicesProtocol:function(){return this.servicesProtocol},setServicesProtocol:function(e){this.servicesProtocol=e},getCustom:function(){return"icmp"!==this.customVal.protocol&&"igmp"!==this.customVal.protocol||(this.customVal.ports="",this.customVal.port_direction=""),this.customVal},setCustom:function(e){this.customVal=e},onCheckPorts:function(e,t){e.checked&&("service"===e.value?this.btnChoose.enable():this.btnChoose.disable(),"custom"===e.value?this.btnSelfDefine.enable():this.btnSelfDefine.disable())},onCheckSrc:function(e,t){if(e.checked)switch(e.value){case"specific_source":this.btnSrcDefine.enable(),this.btnGeoipDefine.disable();break;case"geoip_source":this.btnSrcDefine.disable(),this.btnGeoipDefine.enable();break;default:this.btnSrcDefine.disable(),this.btnGeoipDefine.disable()}},validateBlank:function(e){var t=e.findField("ports").getGroupValue(),i=e.findField("source").getGroupValue();return"service"===t&&""===this.serviceChoose?(this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_no_choose_service")),!1):"custom"===t&&""===this.customVal.ports&&"icmp"!==this.customVal.protocol&&"igmp"!==this.customVal.protocol?(this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_no_set_ports")),!1):!("all"!==i&&""===this.source_ip||"specific_source"===i&&"geoip"===this.source_ip_group||"geoip_source"===i&&"geoip"!==this.source_ip_group)||(this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_no_set_ip")),!1)},validateForm:function(e){return!!e.isValid()&&!!this.validateBlank(e)}}),Ext.ns("SYNO.SDS.AdminCenter.Security.Utils"),SYNO.SDS.AdminCenter.Security.Utils.FW_MAX_RULE=100,SYNO.SDS.AdminCenter.Security.Utils.FW_MAX_PORTS_IN_A_RULE=15,SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH=200,SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH=200,SYNO.SDS.AdminCenter.Security.Utils.FwProfileNameRecord=Ext.data.Record.create({name:"id"},{name:"profileName"}),SYNO.SDS.AdminCenter.Security.Utils.FwRULERecord=Ext.data.Record.create({name:"enable"},{name:"name"},{name:"port_direction"},{name:"port_group"},{name:"ports"},{name:"protocol"},{name:"source_ip_group"},{name:"source_ip"},{name:"policy"},{name:"log"}),SYNO.SDS.AdminCenter.Security.Utils.Render_Source=function(e,t,i){var s=i.data.source_ip_group,n=[],o=[];if("all"===s)e=_T("firewall","firewall_ports_all");else if("geoip"===s){n=e.split(",");for(var a=0;a<n.length;++a)o.push(_T("Country",n[a]));e=o.join(",")}else e=e.replace("-"," "+_T("log","date_to")+" ");return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e},SYNO.SDS.AdminCenter.Security.Utils.Render_Allow=function(e,t){return e="allow"===e?_T("firewall","firewall_policy_allow"):_T("firewall","firewall_policy_drop"),t.attr='ext:qtip="'+e+'"',e},SYNO.SDS.AdminCenter.Security.Utils.Render_Ports=function(e,t,i){var s=i.data.ports,n=i.data.port_group,o="dest",a="-",r=[],l="",d=[];if("all"===n)a=_T("firewall","firewall_ports_all");else if("custom"===n)""!==i.data.port_direction&&(o=i.data.port_direction),""!==s&&(a="source"===o?String.format("{0} ({1})",s,_T("firewall","firewall_port_type_source")):s);else if("service"===n||"reserved"===n){r=s.split(",");for(var c=0;c<r.length;++c){l=(0,SYNO.SDS.AdminCenter.Utils.Render.FindServiceName)(r[c],i.store.servicePortInfo),d.push(l)}a=d.join(", ")}return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"',a},Ext.define("SYNO.SDS.AdminCenter.Security.FwProfileRuleEditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.fwFormPanel=e.fwFormPanel,this.fwOrigProfileName=e.fwOrigProfileName,this.fnRenameCallback=e.fnRenameCallback,this.fwProfileNamePanel=new SYNO.SDS.AdminCenter.Security.FwProfileNamePanel({owner:this,module:this.module,fwOrigProfileName:this.fwOrigProfileName}),this.fwRuleGridPanel=new SYNO.SDS.AdminCenter.Security.FwRuleGridPanel({owner:this,module:this.module,fwOrigProfileName:this.fwOrigProfileName});var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t=_T("firewall","firewall_profile_create");this.fwOrigProfileName&&(t=_T("firewall","edit_firewall_profile")+' "'+this.fwOrigProfileName+'"');var i={dsmStyle:"v5",layout:"border",title:t,border:!1,width:800,height:580,items:[{xtype:"syno_fieldset",region:"north",style:"padding: 0 12px;",items:[this.fwProfileNamePanel]},{xtype:"syno_fieldset",region:"center",layout:"fit",style:"padding: 0 20px;",bwrapStyle:"padding-left: 0; padding-right: 0; padding-bottom: 0",title:_T("firewall","firewall_rule"),items:[this.fwRuleGridPanel]}],buttons:[{btnStyle:"grey",text:_T("common","cancel"),handler:this.onCancelBtnClick,scope:this},{btnStyle:"blue",text:_T("common","ok"),handler:this.onApplyBtnClick,scope:this,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""}],listeners:{beforeclose:this.onBeforeClose.createDelegate(this)}};return Ext.apply(i,e),i},onApplyBtnClick:function(){if(this.fwProfileNamePanel.isValid())if(this.fwProfileNamePanel.isDirty()||this.fwRuleGridPanel.isDirty()){var e=void 0;e=this.fwOrigProfileName===this.fwFormPanel.activeProfile&&this.fwFormPanel.wasFwEnabled?this.saveAndApplyProfile.bind(this):this.saveProfile.bind(this),this.fwOrigProfileName?this.fwOrigProfileName!==this.fwProfileNamePanel.getName()?this.renameProfile(e):e():this.createProfile(e)}else this.close();else this.fwProfileNamePanel.focus()},onCancelBtnClick:function(){this.close()},onBeforeClose:function(){if(this.fwProfileNamePanel.isDirty()||this.fwRuleGridPanel.isDirty())return this.confirmLostChangePromise({save:this.onApplyBtnClick,dontSave:function(){this.resetForm(),this.close()},cancel:Ext.emptyFn},this),!1},getProfile:function(){var e=this.fwRuleGridPanel.getRules();return e.name=this.fwProfileNamePanel.getName(),e},createProfile:function(e){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"create",params:{name:this.fwProfileNamePanel.getName()}},scope:this,callback:function(t,i){if(!t)return this.clearStatusBusy(),void this.getMsgBox().alert("",_T("firewall","firewall_profile_create_fail"));this.fnRenameCallback(this.fwProfileNamePanel.getName(),void 0),e()}})},renameProfile:function(e){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"rename",params:{name:this.fwOrigProfileName,new_name:this.fwProfileNamePanel.getName()}},scope:this,callback:function(t,i){if(!t)return this.clearStatusBusy(),void this.getMsgBox().alert("",_T("firewall","firewall_profile_rename_fail"));this.fnRenameCallback(this.fwProfileNamePanel.getName(),this.fwOrigProfileName),e()}})},saveProfile:function(){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"set",params:{profile:this.getProfile(),profile_applying:!1}},scope:this,callback:function(e,t){if(!e)return this.clearStatusBusy(),void this.getMsgBox().alert("",_T("firewall","firewall_save_failed"));this.clearStatusBusy(),this.setStatusOK(),this.owner.getMsgBox().alert("",_T("firewall","firewall_save_success")),this.clearFormDirty(),this.close()}})},saveAndApplyProfile:function(){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"set",params:{profile:this.getProfile(),profile_applying:!0}},scope:this,callback:function(e,t){if(!e)return this.clearStatusBusy(),void this.getMsgBox().alert("",_T("firewall","firewall_save_failed"));this.applyProfile()}})},applyProfile:function(){this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"start",params:{name:this.fwProfileNamePanel.getName(),profile_applying:!0}},scope:this,callback:this.pollingApplyStatus})},pollingApplyStatus:function(e,t){if(!e)return this.clearStatusBusy(),void this.getMsgBox().alert("",_T("firewall","fail_apply_firewall_profile"));this.polling_id=this.pollReg({interval:1,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",method:"status",params:{task_id:t.task_id},version:1},status_callback:function(e,t,i,s){if(void 0!==t.success)return!0===e&&!0===t.success||(this.stopPollingTask(),!0===t.success)?void(!0===t.success&&(this.stopPollingTask(),this.clearStatusBusy(),this.setStatusOK(),this.owner.getMsgBox().alert("",_T("firewall","firewall_save_success")),this.clearFormDirty(),this.close())):(this.clearStatusBusy(),void this.getMsgBox().alert("",SYNO.API.getErrorString(t.error.code)))}})},clearFormDirty:function(){this.fwProfileNamePanel.clearDirty(),this.fwRuleGridPanel.clearDirty()},resetForm:function(){this.fwProfileNamePanel.resetForm(),this.fwRuleGridPanel.resetForm()},stopPollingTask:function(){null!==this.polling_id&&this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"stop"},scope:this,callback:function(e,t,i){this.pollUnreg(this.polling_id),this.polling_id=null}})}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwProfileNamePanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.fwOrigProfileName=e.fwOrigProfileName;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({trackResetOnLoad:!0,border:!1,items:[{xtype:"syno_textfield",itemId:"profile_name",labelWidth:150,fieldLabel:_T("firewall","firewall_profile_name"),width:200,vtype:"username",vtypeText:_T("firewall","firewall_profile_name_format_error"),allowBlank:!1,value:this.fwOrigProfileName}]},e)},focus:function(){this.getComponent("profile_name").focus()},getName:function(){return this.getComponent("profile_name").getValue()},isValid:function(){return this.getForm().isValid()},isDirty:function(){return this.getForm().isDirty()},clearDirty:function(){var e=this.getComponent("profile_name");e.originalValue=e.getValue()},resetForm:function(){this.getComponent("profile_name").reset()}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwRuleGridPanel",{extend:"SYNO.ux.DDGridPanel",constructor:function(e){this.module=e.module,this.owner=e.owner,this.fwOrigProfileName=e.fwOrigProfileName,this.FwPanel=e.owner,this.FwStatus=!1,this.oldSelectedAdapter="global",this.selectedAdapter="global",this.adapterPolicy="none",this.adapterComboID="",this.adapterNameStore=new Ext.data.ArrayStore({fields:["id","display"]}),this.profileData=new SYNO.SDS.AdminCenter.Security.FwProfileRuleData({owner:this,window:this.owner}),this.tbar=this.newTopToolBar(),this.bbar=this.newBottomToolBar(),this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enable",enableFastSelectAll:!0,menuDisabled:!0,sortable:!1,width:100,align:"center",tooltip:_T("common","enabled"),listeners:{selectall:{fn:this.updateButtonStatus,scope:this}}});var t=Ext.apply({tbar:this.tbar,viewConfig:{markDirty:!1,ddGroup:"FirewallRulesDD",emptyText:['<div class="syno-dataview">','<div class="empty-text-wrap">','<div class="empty-text-inner-wrap">','<div class="empty-text-icon"></div>','<div class="empty-text">',_T("common","no_item"),"</div>","</div>","</div>","</div>"].join("")},cls:"syno-firewall-gridpanel",plugins:[this.enableColumn],columns:[this.enableColumn,{id:"fw_ports",header:_T("firewall","firewall_ports"),dataIndex:"ports",width:150,tooltip:_T("firewall","firewall_ports"),renderer:SYNO.SDS.AdminCenter.Security.Utils.Render_Ports},{header:_T("firewall","firewall_protocol"),dataIndex:"protocol",width:100,tooltip:_T("firewall","firewall_protocol"),renderer:SYNO.SDS.AdminCenter.Utils.Render.Render_Protocol},{header:_T("firewall","firewall_source"),dataIndex:"source_ip",width:150,tooltip:_T("firewall","firewall_source"),renderer:SYNO.SDS.AdminCenter.Security.Utils.Render_Source},{header:_T("firewall","firewall_allow"),dataIndex:"policy",width:80,tooltip:_T("firewall","firewall_allow"),renderer:SYNO.SDS.AdminCenter.Security.Utils.Render_Allow}],enableDragDrop:!0,enableColumnMove:!1,enableHdMenu:!1,autoExpandColumn:"fw_ports",monitorWindowResize:!0,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:{fn:this.updateButtonStatus,buffer:50,scope:this}}}),listeners:{rowdblclick:function(){1===this.getSelectionModel().getCount()&&this.openRuleDialog("edit")},rowcontextmenu:this.onRowContextMenu,containercontextmenu:this.onContainerContextMenu,scope:this},store:this.profileData.adapterRuleStore},e);this.callParent([t])},onContainerContextMenu:function(e,t){e.getSelectionModel().hasSelection()&&this.showContextMenu(t)},onRowContextMenu:function(e,t,i){var s=e.getSelectionModel();s.suspendEvents(!1),s.selectRow(t,s.isSelected(t)),this.updateButtonStatus(),s.resumeEvents(),this.showContextMenu(i)},showContextMenu:function(e){var t=[],i=this.getSelectionModel().getCount();1===i&&t.push({text:_T("common","alt_edit"),scope:this,handler:function(e,t){this.openRuleDialog("edit")}},{text:_T("common","up"),scope:this,handler:function(){this.onMoveRow(!0)}},{text:_T("common","down"),scope:this,handler:function(){this.onMoveRow(!1)}}),1<=i&&t.push({text:_T("common","delete"),scope:this,handler:function(){var e=this.getSelectionModel(),t=e.getSelections(),i=this.profileData.adapterRuleStore,s=0;for(s=0;s<t.length;s++)i.remove(t[s]);0>=i.getCount()?this.getView().focusEl.focus():(e.selectFirstRow(),this.getView().focusRow(0))}});var s=new SYNO.ux.Menu({autoDestroy:!0,items:t});s.showAt(e.getXY()),e.preventDefault(),this.addManagedComponent(s)},initEvents:function(){this.callParent(arguments),this.mon(this.owner,"show",this.onShow,this),this.mon(this.profileData.adapterRuleStore,"load",this.updateGridView,this),this.mon(this.profileData.adapterRuleStore,"add",this.onUpdateRuleStore,this),this.mon(this.profileData.adapterRuleStore,"remove",this.onUpdateRuleStore,this),this.mon(this,"afterDrop",this.onUpdateRuleStore,this)},onMoveRow:function(e){var t=this.profileData.adapterRuleStore,i=this.getSelectionModel().getSelected(),s=t.indexOf(i),n=s+(e?-1:1);n<0||n>t.getCount()-1?this.getView().focusRow(s):(t.remove(i),t.insert(n,i),this.getSelectionModel().selectRecords([i]),this.getView().focusRow(n))},newTopToolBar:function(){return new Ext.Toolbar({defaultType:"syno_button",items:[{text:_T("common","create"),itemId:"create",tooltip:_T("common","create"),scope:this,handler:function(e,t){this.openRuleDialog("add")}},{text:_T("common","alt_edit"),itemId:"edit",tooltip:_T("common","alt_edit"),disabled:!0,scope:this,handler:function(e,t){1===this.getSelectionModel().getCount()&&this.openRuleDialog("edit")}},{text:_T("common","delete"),itemId:"delete",tooltip:_T("common","delete"),disabled:!0,scope:this,handler:function(){var e=this.getSelectionModel().getSelections(),t=0;for(t=0;t<e.length;t++)this.profileData.adapterRuleStore.remove(e[t])}},"->",{xtype:"syno_combobox",id:this.adapterComboID=Ext.id(),displayField:"display",valueField:"id",value:"global",store:this.adapterNameStore,listeners:{select:this.onAdapterSelect,scope:this}}]})},setTabNavigation:function(e){var t=!0===e?0:-1,i=this.getTopToolbar(),s=this.getBottomToolbar().getComponent("adapterBbar");i.getComponent("create").btnEl.set({tabIndex:t}),i.getComponent("edit").btnEl.set({tabIndex:t}),i.getComponent("edit").arrowBtnEl.set({tabIndex:t}),i.getComponent("setting").btnEl.set({tabIndex:t}),i.getComponent(this.profileComboID).getEl().set({tabIndex:t}),i.getComponent(this.adapterComboID).getEl().set({tabIndex:t}),s.getComponent("globalAdapterBbar").getEl().set({tabIndex:t}),s.getComponent("generalAdapterBbar").items.each((function(e){e.getEl().set({tabIndex:t})}))},updateButtonStatus:function(){var e=this.getSelectionModel().getCount();this.setButton("edit",1===e),this.setButton("delete",1<=e)},setButton:function(e,t){var i=this.getTopToolbar().getComponent(e);i&&i[t?"enable":"disable"]()},openRuleDialog:function(e){new SYNO.SDS.AdminCenter.Security.FwRuleDialog({owner:this.owner,module:this.module,portInfo:this.profileData.adapterRuleStore.servicePortInfo,gridRules:this,mode:e}).open()},onUpdateRuleStore:function(){this.profileData.setDirty(),this.updateButtonStatus(),this.updateGridView()},updateComboSelectValue:function(){Ext.getCmp(this.adapterComboID).setValue(this.selectedAdapter)},updateGridView:function(){var e=this.getView().el.query(".contentwrapper")[0];0===this.profileData.adapterRuleStore.getCount()?e.style.height="100%":(e.style.height="",this.getView().refresh())},onAdapterSelect:function(e,t,i){var s=t.get("id");if(s!==this.selectedAdapter){this.profileData.storeToData(this.selectedAdapter),this.profileData.setAdapterPolicy(this.selectedAdapter,this.getBbarPolicy()),this.selectedAdapter=s,this.profileData.dataToStore(s);var n=this.profileData.getAdapterPolicy(s);this.setBbarPolicy(n),this.updateBbarLayout(),this.updateButtonStatus()}},newBottomToolBar:function(){var e=new SYNO.SDS.AdminCenter.Security.FwRuleGridPageLessToolBar({store:this.profileData.adapterRuleStore,showRefreshBtn:!1}),t=new Ext.Panel({itemId:"adapterBbar",cls:"syno-footer",bwrapCfg:{border:!1},items:[{xtype:"syno_compositefield",itemId:"globalAdapterBbar",items:[{xtype:"syno_displayfield",cls:"syno-note-label",value:_T("common","note")+_T("common","colon")},{xtype:"syno_displayfield",value:_T("firewall","firewall_global_no_match_desc")}]},{xtype:"syno_compositefield",itemId:"generalAdapterBbar",hidden:!0,items:[{xtype:"syno_displayfield",value:_T("firewall","firewall_policy_remind")+_T("common","colon")},{xtype:"syno_radio",boxLabel:_T("firewall","firewall_no_match_allow"),name:"policy",id:this.adapterPolicyAllowRadioID=Ext.id(),inputValue:"allow",listeners:{check:{scope:this,fn:this.onPolicyRadioCheck}}},{xtype:"syno_radio",boxLabel:_T("firewall","firewall_no_match_drop"),id:this.adapterPolicyDropRadioID=Ext.id(),name:"policy",inputValue:"drop",listeners:{check:{scope:this,fn:this.onPolicyRadioCheck}}}]},{xtype:"syno_compositefield",items:[{xtype:"syno_displayfield",cls:"syno-note-label",value:_T("common","note")+_T("common","colon")},{xtype:"syno_displayfield",value:_T("firewall","firewall_drag_drop_hint")}]}]});return new Ext.Container({items:[e,t]})},setBbarPolicy:function(e){var t=this.getBottomToolbar().getComponent("adapterBbar");switch(e){case"allow":t.getComponent("generalAdapterBbar").setValue(!0),Ext.getCmp(this.adapterPolicyAllowRadioID).setValue(e);break;case"drop":t.getComponent("generalAdapterBbar").setValue(!0),Ext.getCmp(this.adapterPolicyDropRadioID).setValue(e);break;case"none":t.getComponent("generalAdapterBbar").setValue(!1)}},getBbarPolicy:function(){return this.getBottomToolbar().getComponent("adapterBbar").getComponent("generalAdapterBbar").getValue()?Ext.getCmp(this.adapterPolicyAllowRadioID).getValue()?"allow":Ext.getCmp(this.adapterPolicyDropRadioID).getValue()?"drop":void 0:"none"},updateBbarLayout:function(){var e=this.getBottomToolbar().getComponent("adapterBbar");"global"===Ext.getCmp(this.adapterComboID).getValue()?(e.getComponent("globalAdapterBbar").show(),e.getComponent("generalAdapterBbar").hide()):(e.getComponent("globalAdapterBbar").hide(),e.getComponent("generalAdapterBbar").show()),e.doLayout()},onPolicyRadioCheck:function(e,t){t&&this.profileData.setAdapterPolicy(this.selectedAdapter,e.inputValue)},onShow:function(){this.loadFwData()},loadFwData:function(){this.owner.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!0,params:[{api:"SYNO.Core.Network.Interface",version:1,method:"list"},{api:"SYNO.Core.Service.PortInfo",method:"load",version:1}]},scope:this,callback:function(e,t,i,s){e?(Ext.each(t.result,(function(e,t,i){if(e.success)if("SYNO.Core.Network.Interface"===e.api){var s=[];s.push(["global",_T("firewall","firewall_global_interface")]),Ext.each(e.data,(function(e){if(!0!==_S("ha_not_support_pppoe")||"pppoe"!==e.ifname){var t={};t.id=e.ifname,t.display=SYNO.SDS.Utils.Network.idToString.apply(this.module.appWin,[e.ifname,e.type]),s.push([t.id,t.display])}}),this),s.push(["vpn","VPN"]),this.adapterNameStore.loadData(s),Ext.getCmp(this.adapterComboID).setValue("global"),this.updateBbarLayout()}else"SYNO.Core.Service.PortInfo"===e.api&&SYNO.SDS.AdminCenter.Utils.Render.ServerPortsParsing(e.data,this.profileData.adapterRuleStore.servicePortInfo,!1)}),this),this.profileData.loadData(this.fwOrigProfileName,this.selectedAdapter),this.owner.clearStatusBusy()):this.getMsgBox().alert("",_T("common","commfail"))}})},getRules:function(){return this.profileData.storeToData(this.selectedAdapter),this.profileData.setAdapterPolicy(this.selectedAdapter,this.getBbarPolicy()),this.profileData.getData()},isDirty:function(){return this.profileData.isDirty()},clearDirty:function(){this.profileData.clearDirty()},resetForm:function(){this.profileData.resetForm()}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwRuleGridPageLessToolBar",{extend:"SYNO.ux.PageLessToolbar",constructor:function(){this.callParent(arguments)},bindStore:function(e,t){!t&&this.store&&(this.store.un("add",this.onDataChanged,this),this.store.un("remove",this.onDataChanged,this)),e&&(e=Ext.StoreMgr.lookup(e)).on({scope:this,add:this.onDataChanged,remove:this.onDataChanged}),this.callParent(arguments)},updateInfo:function(){Ext.isEmpty(this.displayItem)||this.displayItem.setText(`${this.store.getCount()} ${_JSLIBSTR("uicommon","items")}`)}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwProfileCombobox",{extend:"SYNO.ux.ComboBox",constructor:function(e){this.callParent([this.fillConfig(e)]),this.mon(this,"select",this.setOwnerValue,this)},fillConfig:function(e){return Ext.apply({mode:"local",listClass:"syno-firewall-profile-combobox syno-ux-combobox-list",htmlEncode:!0,valueField:"profileName",displayField:"profileNameDisplay",store:new SYNO.API.JsonStore({api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"list",autoLoad:!0,remoteSort:!1,appWindow:e.owner.findAppWindow(),root:"profile_names",fields:[{name:"profileName",convert:function(e,t){return t}},{name:"profileNameDisplay",convert:function(e,t){return t}}],sortInfo:{field:"profileNameDisplay",direction:"ASC"}})},e)},setOwnerValue:function(e,t){this.owner.selectedProfile=t.get("profileName")},openDialog:function(){new SYNO.SDS.AdminCenter.Security.FwProfileDialog({owner:this.owner.findAppWindow(),store:this.store,module:this.module,fwFormPanel:this.owner}).open()},initList:function(){this.callParent(arguments),this.view.getTemplateTarget().dom.style.padding="0 0 8px 0",this.createFooter()},createFooter:function(){this.footer=this.list.createChild({cls:"x-combo-list-ft"}),this.customTb=new SYNO.ux.Toolbar({cls:"syno-network-firewall-profile-footer",renderTo:this.footer,layout:"column",items:[this.text=new Ext.Toolbar.TextItem({html:_T("firewall","manage_firewall_profile"),cls:"x-combo-list-item",columnWidth:1,listeners:{scope:this,render:function(e){e.getEl().on("mouseover",(function(){e.addClass("x-combo-selected"),this.view.clearSelections()}),this),e.getEl().on("mouseout",(function(){e.removeClass("x-combo-selected")}),this),e.getEl().on("click",(function(){this.openDialog(),this.collapse()}),this)}}})]}),this.assetHeight+=this.customTb.getHeight(),this.restrictHeight()}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwProfileDialog",{extend:"SYNO.SDS.ModalWindow",title:_T("firewall","manage_firewall_profile"),constructor:function(e){this.callParent([this.fillConfig(e)]),this.mon(this,"afterlayout",this.updateToolbar,this,{single:!0})},fillConfig:function(e){return Ext.apply({layout:"fit",width:500,height:500,buttons:[{btnStyle:"grey",text:_T("common","close"),scope:this,handler:function(){""===this.fwFormPanel.selectedProfile&&(this.fwFormPanel.selectedProfile=this.fwFormPanel.activeProfile,this.fwFormPanel.profileCombo.setValue(this.fwFormPanel.activeProfile)),this.close()}.createDelegate(this)}],items:[this.gridPanel=new SYNO.ux.GridPanel({region:"center",enableHdMenu:!1,enableColumnMove:!1,store:e.store,colModel:new Ext.grid.ColumnModel({columns:[{sortable:!0,header:_T("firewall","firewall_profile"),dataIndex:"profileNameDisplay",renderer:function(e,t,i){return i.get("profileName")===this.fwFormPanel.activeProfile&&(e+=" ("+_T("firewall","firewall_active_profile_note")+")"),e}.createDelegate(this)}]}),listeners:{scope:this,viewready:function(e){var t=e.store.find("profileName",this.fwFormPanel.selectedProfile);e.getSelectionModel().selectRow(t),this.updateToolbar()},rowClick:function(e,t,i){i&&-1<t&&!i.hasModifier()&&e.getSelectionModel().selectRow(t),this.updateToolbar()},rowdblclick:function(){this.onEditRules()}},cls:"syno-firewall-profile-dialog-panel",tbar:new SYNO.ux.Toolbar({defaultType:"syno_button",items:[{itemId:"add",text:_T("common","create"),handler:this.onAddProfile,scope:this},{itemId:"edit",text:_T("common","alt_edit"),handler:this.onEditRules,scope:this},{itemId:"clone",text:_T("iscsilun","clone"),handler:this.onCloneProfile,scope:this},{itemId:"delete",text:_T("common","delete"),handler:this.onDeleteProfile,scope:this}]})})]},e)},updateToolbar:function(){var e=this.gridPanel.getSelectionModel().getSelections().length;this.gridPanel.getTopToolbar().getComponent("add").setDisabled(!1),this.gridPanel.getTopToolbar().getComponent("edit").setDisabled(1!==e),this.gridPanel.getTopToolbar().getComponent("clone").setDisabled(1!==e),this.gridPanel.getTopToolbar().getComponent("delete").setDisabled(1!==e)},onAddProfile:function(){new SYNO.SDS.AdminCenter.Security.FwProfileRuleEditDialog({owner:this,module:this.module,fwFormPanel:this.fwFormPanel,fwOrigProfileName:void 0,fnRenameCallback:this.updateGridView.bind(this)}).open()},onEditRules:function(){new SYNO.SDS.AdminCenter.Security.FwProfileRuleEditDialog({owner:this,module:this.module,fwFormPanel:this.fwFormPanel,fwOrigProfileName:this.getSelectedRecord().get("profileName"),fnRenameCallback:this.updateGridView.bind(this)}).open()},onCloneProfile:function(){new SYNO.SDS.AdminCenter.Security.FwProfileManageDialog({selectedRecord:this.getSelectedRecord(),owner:this,module:this.module,mode:"clone"}).open()},onDeleteProfile:function(){var e=this.getSelectedRecord();this.getMsgBox().confirmDelete(_T("firewall","firewall_profile_delete"),_T("firewall","firewall_profile_delete_check"),function(t){"yes"===t&&(this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile",version:1,method:"delete",params:{name:e.get("profileName")}},scope:this,callback:function(t,i){if(!t)return this.clearStatusBusy(),void this.getMsgBox().alert("",_T("firewall","firewall_profile_delete_fail"));this.updateGridView(void 0,e.get("profileName")),this.clearStatusBusy()}}))}.createDelegate(this))},updateGridView:function(e,t){this.mon(this.store,"load",(function(){if(Ext.isDefined(e)){var t=this.store.find("profileName",e);this.gridPanel.getSelectionModel().selectRow(t)}else this.gridPanel.getSelectionModel().clearSelections()}),this,{single:!0}),Ext.isDefined(t)&&(this.fwFormPanel.activeProfile===t&&(this.fwFormPanel.activeProfile=e),this.fwFormPanel.selectedProfile===t&&(e=Ext.isDefined(e)?e:"",this.fwFormPanel.selectedProfile=e,this.fwFormPanel.profileCombo.setValue(e))),this.store.reload()},getSelectedRecord:function(){return this.gridPanel.getSelectionModel().getSelected()}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwFormPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module,this.webapis=this.getWebapis(),this.formPanelItems=this.getFormPanelItems(),this.wasFwEnabled=!1,this.activeProfile="",this.selectedProfile="";var t=this.fillConfig(e);this.callParent([t]),this.profileCombo=Ext.getCmp(this.profileComboId)},fillConfig:function(e){var t={autoFlexcroll:!0,trackResetOnLoad:!0,items:this.getFormPanelItems()};return Ext.apply(t,e),t},getFormPanelItems:function(){return this.formPanelItems?this.formPanelItems:[{xtype:"syno_fieldset",title:_T("common","general"),collapsible:!1,items:[{xtype:"syno_checkbox",boxLabel:_T("firewall","firewall_enable"),name:"enable_firewall",scope:this,handler:this.updateComponentDisable},{xtype:"syno_checkbox",boxLabel:_T("firewall","firewall_enable_port_detect"),name:"enable_port_check",webapi:{api:"SYNO.Core.Security.Firewall.Conf",methods:{get:"get",set:"set"},version:"1"}},{xtype:"syno_displayfield",hideLabel:!0,indent:1,name:"enable_port_check_desc",value:_T("firewall","firewall_port_detect_desc")}]},{xtype:"syno_fieldset",title:_T("firewall","firewall_profile"),itemId:"firewall_profile_fieldset",collapsible:!1,indent:1,items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("firewall","config_firewall_profile_desc")},{xtype:"syno_compositefield",items:[new SYNO.SDS.AdminCenter.Security.FwProfileCombobox({fieldLabel:_T("firewall","firewall_profile"),owner:this,module:this.module,flex:1,name:"profile_name",id:this.profileComboId=Ext.id()}),{xtype:"syno_button",text:_T("firewall","edit_profile_rules"),id:this.editProfileRuleBtnId=Ext.id(),handler:this.onEditProfileRuleBtnClick,scope:this}]}]}]},onEditProfileRuleBtnClick:function(e,t){new SYNO.SDS.AdminCenter.Security.FwProfileRuleEditDialog({owner:this.module.appWin,module:this.module,fwFormPanel:this,fwOrigProfileName:this.selectedProfile,fnRenameCallback:this.updateCombobox.bind(this)}).open()},updateComponentDisable:function(){var e=this.isFwEnabled(),t=this.getForm();t.findField("enable_port_check").setDisabled(!e),t.findField("enable_port_check_desc").setDisabled(!e),this.getComponent("firewall_profile_fieldset").setDisabled(!e)},updateCombobox:function(e,t){this.profileCombo.store.reload(),Ext.isEmpty(t)||(this.activeProfile===t&&(this.activeProfile=e),this.selectedProfile===t&&(e=Ext.isDefined(e)?e:"",this.selectedProfile=e,this.profileCombo.setValue(e)))},needDisableFirewall:function(){return this.getForm().findField("enable_firewall").isDirty()&&!this.isFwEnabled()},needApplyProfile:function(){return this.getForm().findField("enable_firewall").isDirty()&&this.isFwEnabled()||this.isFwEnabled()&&this.isActiveProfileChanged()},isFwEnabled:function(){return this.getForm().getValues().enable_firewall},isActiveProfileChanged:function(){return this.activeProfile!==this.selectedProfile},disableFirewall:function(){this.owner.setStatusBusy(),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall",version:1,method:"set",params:{set_type:"disable"}},scope:this,callback:function(e,t){e?(this.profileCombo.setValue(this.selectedProfile),this.wasFwEnabled=!1,this.owner.clearStatusBusy(),this.owner.setStatusOK(),this.clearDirty()):this.module.appWin.getMsgBox().alert("",_T("firewall","fail_disable_firewall"))}})},applyProfile:function(){this.owner.setStatusBusy(),this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"start",params:{name:this.selectedProfile,profile_applying:!1}},scope:this,callback:this.pollingApplyStatus})},pollingApplyStatus:function(e,t){if(!e)return this.owner.clearStatusBusy(),void this.module.appWin.getMsgBox().alert("",_T("firewall","fail_apply_firewall_profile"));this.polling_id=this.pollReg({interval:1,immediate:!0,scope:this,webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",method:"status",params:{task_id:t.task_id},version:1},status_callback:function(e,t,i,s){if(void 0!==t.success)return!0===e&&!0===t.success||(this.stopPollingTask(),!0===t.success)?void(!0===t.success&&(this.stopPollingTask(),this.owner.clearStatusBusy(),this.owner.setStatusOK(),this.wasFwEnabled=!0,this.activeProfile=this.selectedProfile,this.profileCombo.setValue(this.selectedProfile),this.clearDirty())):(this.owner.clearStatusBusy(),this.owner.setStatusOK(),void this.module.appWin.getMsgBox().alert("",SYNO.API.getErrorString(t.error.code)))}})},stopPollingTask:function(){null!==this.polling_id&&this.sendWebAPI({webapi:{api:"SYNO.Core.Security.Firewall.Profile.Apply",version:1,method:"stop"},scope:this,callback:function(e,t,i){this.pollUnreg(this.polling_id),this.polling_id=null}})},processReturnData:function(e,t,i){for(var s=0;s<t.result.length;++s){var n=t.result[s];if(!n.success)return void this.module.appWin.getMsgBox().alert(_T("tree","leaf_firewall"),SYNO.API.getErrorString(n.error.code));"SYNO.Core.Security.Firewall"===n.api&&(this.wasFwEnabled=n.data.enable_firewall,this.activeProfile=n.data.profile_name,"get"===e&&(this.selectedProfile=this.activeProfile)),this.getForm().setValues(n.data)}this.profileCombo.setValue(this.selectedProfile),this.updateComponentDisable()},processSetParams:function(e){return e},processGetParams:function(e){return e.push(this.webapis.firewallGet),e},processParams:function(e,t){return"set"===e?this.processSetParams(t):"get"===e?this.processGetParams(t):t},getWebapis:function(){return this.webapis?this.webapis:{firewallGet:{api:"SYNO.Core.Security.Firewall",method:"get",version:1}}},clearDirty:function(){var e,t=this.getForm();(e=t.findField("enable_firewall")).originalValue=e.getValue(),(e=t.findField("enable_port_check")).originalValue=e.getValue(),(e=t.findField("profile_name")).originalValue=e.getValue()},isDirty:function(){return this.getForm().isDirty()}}),Ext.define("SYNO.SDS.AdminCenter.Security.AutoBlock.AddIPDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),new SYNO.ux.Utils.EnableRadioGroup(this.panel.getForm(),"expire_time",{forever:[],by_days:["expire_day"]})},fillConfig:function(e){var t;return this.owner=e.owner,this.appWin=e.appWin,this.ruleWin=e.ruleWin,this.panel=this.createPanel(e.launcher),t={width:450,height:"deny"===e.launcher?260:150,resizable:!1,title:_T("autoblock","create_ip"),buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),itemId:"cancel",scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","save"),itemId:"apply",scope:this,disabled:!0,handler:this.onSubmit}],layout:"fit",items:[this.panel]},Ext.apply(t,e),t},createPanel:function(e){var t=this,i={border:!1,baseParams:{type:e},padding:0,items:[{xtype:"syno_textfield",fieldLabel:_T("tcpip","tcpip_ipaddr"),allowBlank:!1,name:"source_ip",vtype:"fwLooseip",validationEvent:"keyup",validateOnBlur:!0,validator:function(e){var i=t.getFooterToolbar().get("apply");return t.clearStatus(),Ext.form.VTypes.fwLooseip(e)?(t.stopRemoteValidate||t.sendWebAPI({api:"SYNO.Core.Security.AutoBlock.Rules",method:"get",version:1,params:{ip:e},scope:t,callback:t.onRemoteValidateComplete}),!0):(i.disable(),!1)}},{xtype:"syno_displayfield",hidden:"allow"===e,value:_T("autoblock","autoblock_expire_time")+_T("common","colon")},{xtype:"syno_radio",hidden:"allow"===e,name:"expire_time",inputValue:"forever",boxLabel:_T("autoblock","forever"),checked:!0},{xtype:"syno_compositefield",hidden:"allow"===e,hideLabel:!0,items:[{xtype:"syno_radio",name:"expire_time",inputValue:"by_days",boxLabel:_T("autoblock","autoblock_expired_day")},{xtype:"box",width:10,hide:!0},{xtype:"syno_numberfield",name:"expire_day",vtype:"number",maxlength:3,minValue:1,disabled:!0}]}]};return new SYNO.ux.FormPanel(i)},onSubmit:function(){var e,t=[],i=0,s=this.panel.getForm(),n=s.getValues();if(this.stopRemoteValidate=!0,e=s.isValid(),this.stopRemoteValidate=!1,e){if("allow"===this.launcher)i=0;else if("forever"===n.expire_time)i=0;else{if("by_days"!==n.expire_time)return void this.setStatusError({text:_T("common","forminvalid"),clear:!0});i=s.findField("expire_day").getValue()}0>i?this.setStatusError({text:_T("common","forminvalid"),clear:!0}):(this.setStatusBusy({text:_T("common","msg_waiting")}),t.push(n.source_ip),this.sendWebAPICreate({type:this.launcher,block_days:i,overwrite:!0,ip:t}))}else this.setStatusError({text:_T("common","forminvalid"),clear:!0})},sendWebAPICreate:function(e){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({api:"SYNO.Core.Security.AutoBlock.Rules",method:"create",version:1,params:e,scope:this,callback:this.onCreateDone})},onCreateDone:function(e,t,i){this.clearStatusBusy(),e||this.getMsgBox().alert(_T("autoblock","create_ip"),_T("error","error_unknown")),this.close()},onRemoteValidateComplete:function(e,t,i){var s,n=i.ip,o=this.panel.getForm();e?o&&(s=o.findField("source_ip"))&&n===s.getValue()&&("deny"===t.type?this.setStatusError({text:String.format(_T("autoblock","ip_in_blockedlist"),n),clear:!1}):"allow"===t.type?this.setStatusError({text:String.format(_T("autoblock","ip_in_allowlist"),n),clear:!1}):this.setStatusOK({text:String.format(_T("autoblock","ip_is_validated"),n),clear:!1}),this.getFooterToolbar().get("apply").enable()):this.getMsgBox().alert(_T("autoblock","create_ip"),_T("common","commfail"),this.close,this)}}),Ext.define("SYNO.SDS.AdminCenter.Security.AutoBlock.UploadFileDialog",{extend:"SYNO.SDS.ModalWindow",store:null,btnUpload:null,constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.btnUpload=this.getFooterToolbar().getComponent("apply"),new SYNO.ux.Utils.EnableRadioGroup(this.panel.getForm(),"expire_time",{forever:[],by_days:["expire_day"]})},fillConfig:function(e){var t;return this.owner=e.owner,this.appWin=e.appWin,this.ruleWin=e.ruleWin,this.panel=this.createPanel(e),t={title:_T("autoblock","import_ip"),width:650,height:"deny"===e.launcher?577:483,resizable:!1,layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"apply",scope:this,disabled:!0,handler:this.onSubmit}]},Ext.apply(t,e),t},createPanel:function(e){var t,i=this;return this.grid=this.createPreviewGrid(e),this.grid.setAutoScroll(!0),this.fileField=new SYNO.ux.FileButton({scope:this,name:"upload_file",hiddenName:"upload_file",fieldLabel:_T("user","user_file"),value:"",listeners:{change:{fn:this.onImportFilePathChanged,scope:this}}}),t={border:!1,padding:0,fileUpload:!0,webapi:{api:"SYNO.Core.Security.AutoBlock.Rules",method:"allow"===e.launcher?"upload":"upload_deny_list",version:1},items:[{xtype:"syno_displayfield",hidden:"allow"===e.launcher,value:_T("autoblock","autoblock_expire_time")},{xtype:"syno_radio",indent:1,hidden:"allow"===e.launcher,name:"expire_time",inputValue:"forever",boxLabel:_T("autoblock","forever"),checked:!0},{xtype:"syno_compositefield",hideLabel:!0,hidden:"allow"===e.launcher,indent:1,items:[{xtype:"syno_radio",name:"expire_time",inputValue:"by_days",boxLabel:_T("autoblock","autoblock_expired_day")},{xtype:"box",width:10},{xtype:"syno_numberfield",name:"expire_day",vtype:"number",minValue:1,maxlength:3,disabled:!0}]},{xtype:"syno_checkbox",name:"overwrite",value:!1,boxLabel:_T("autoblock","check_overwrite")},i.fileField,i.grid],onApiSuccess:function(e,t,s){i.clearStatusBusy(),i.store.loadData(t)},onApiFailure:function(e,t,s){var n=t.errors,o=_T("error","error_invalid");switch(i.clearStatusBusy(),i.store.removeAll(),i.btnUpload.disable(),t.code){case 116:o=_T("common","error_demo");break;case 5103:o=Ext.isDefined(n)&&Ext.isDefined(n.err_line)?String.format(_T("autoblock","upload_format_failed"),n.err_line):_T("error","error_invalid");break;case 5105:o=_T("user","user_file_open_fail");break;default:o=_T("error","error_invalid")}i.getMsgBox().alert(_T("user","user_upload"),o)}},new SYNO.SDS.Utils.FormPanel(t)},createPreviewGrid:function(e){return this.store=new SYNO.API.JsonStore({root:"ip_info",totalProperty:"total",fields:[{name:"ip",mapping:"ip"}],listeners:{load:{scope:this,fn:this.onLoad}}}),new SYNO.ux.GridPanel({store:this.store,padding:0,columns:[{header:"deny"===e.launcher?_T("autoblock","autoblock_ip"):_T("autoblock","autoblock_allow_ip"),dataIndex:"ip",menuDisabled:!0}],height:270,enableHdMenu:!1,bodyStyle:"padding-top: 2px;",view:new SYNO.ux.FleXcroll.grid.BufferView({borderHeight:1,cacheSize:100,scrollDelay:!1,forceFit:!0})})},onLoad:function(){0<this.store.getCount()?this.btnUpload.enable():this.btnUpload.disable()},onImportFilePathChanged:function(e,t){if(void 0===t){if(!this.panel.getForm().isValid())return this.fileField.fileTextField.setValue(""),void this.setStatusError({text:_T("common","forminvalid"),clear:!0});if(Ext.isEmpty(this.fileField.getValue()))return this.store.removeAll(),void this.btnUpload.disable();this.setStatusBusy({text:_T("common","loading")}),this.panel.upload()}},onSubmit:function(){var e,t=[],i=0,s=this.panel.getForm(),n=s.getValues();if(this.stopRemoteValidate=!0,e=s.isValid(),this.stopRemoteValidate=!1,e){if("allow"===this.launcher)i=0;else if("forever"===n.expire_time)i=0;else{if("by_days"!==n.expire_time)return void this.setStatusError({text:_T("common","forminvalid"),clear:!0});i=s.findField("expire_day").getValue()}0>i?this.setStatusError({text:_T("common","forminvalid"),clear:!0}):(this.setStatusBusy({text:_T("common","msg_waiting")}),this.store.each((function(e){t.push(e.data.ip)})),0>t.length?this.close():this.sendWebAPICreate({type:this.launcher,block_days:i,overwrite:s.findField("overwrite").getValue(),ip:t}))}else this.setStatusError({text:_T("common","forminvalid"),clear:!0})},sendWebAPICreate:function(e){this.setStatusBusy({text:_T("common","saving")}),this.sendWebAPI({api:"SYNO.Core.Security.AutoBlock.Rules",method:"create",version:1,params:e,scope:this,callback:this.onCreateDone})},onCreateDone:function(e,t,i){this.clearStatusBusy(),e||this.getMsgBox().alert(_T("user","user_upload"),_T("common","commfail")),this.close()}}),Ext.define("SYNO.SDS.AdminCenter.Security.AutoBlock.AddWhiteListDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.appWin=e.appWin,this.ruleWin=e.ruleWin,this.panel=this.createPanel(),this.form=this.panel.getForm();var t={width:580,height:360,title:_T("autoblock","create_ip"),layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","save"),itemId:"ruleApply",scope:this,handler:this.onApply}]};this.setDefault(),Ext.apply(t,e),this.callParent([t]),this.OnSourceRadioClick(this.form.findField("source"),!0)},createPanel:function(){var e={xtype:"syno_fieldset",title:_T("autoblock","create_ip"),itemId:"whitelist_source",padding:0,items:[{xtype:"syno_compositefield",hideLabel:!0,defaults:{flex:1},items:[{xtype:"syno_radio",name:"source",itemId:"whitelist_singlehost",boxLabel:_T("nfs","nfs_fieldtitle_host"),inputValue:"single",scope:this,checked:!0,handler:this.OnSourceRadioClick},{xtype:"syno_radio",margins:"0 0 0 26px",name:"source",itemId:"whitelist_subnet",boxLabel:_T("firewall","firewall_source_network"),inputValue:"subnet",scope:this,handler:this.OnSourceRadioClick}]},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_ipaddr")+"/"+_T("dhcp_server","domain_name"),name:"source_ip",itemId:"whitelist_ip",indent:1,validator:function(e){return!(!Ext.form.VTypes.fwLooseip(e)&&!Ext.form.VTypes.hostname(e))&&(this.nextSibling().validate(),!0)}},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_mask")+"/"+_T("tcpip","ipv6_prefixleng"),name:"source_subnet_mask",itemId:"whitelist_mask",indent:1,maskRe:/[.0-9]/,invalidText:_JSLIBSTR("vtype","bad_mask"),allowBlank:!1,validator:function(e){var t=this.previousSibling().getValue();return Ext.form.VTypes.fwLoosev6ipVal.test(t)?e>=0&&e<=128||_JSLIBSTR("vtype","bad_ipv6prefixLeng"):!!Ext.form.VTypes.netmaskVal.test(e)||e>=0&&e<=32}},{xtype:"syno_displayfield",height:12},{xtype:"syno_radio",boxLabel:_T("firewall","firewall_ip_range"),name:"source",width:2*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH,itemId:"whitelist_source_range",inputValue:"range",scope:this,handler:this.OnSourceRadioClick},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("ftp","ftp_port_from"),name:"source_ip_begin",itemId:"whitelist_ip_begin",indent:1,vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)}},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("ftp","ftp_port_to"),name:"source_ip_end",itemId:"whitelist_ip_end",indent:1,vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)}}]};return new SYNO.ux.FormPanel(e)},onApply:function(){if(this.validateBlank(this.form))if(this.form.isValid()){var e={type:"allow",block_days:0,overwrite:!0,ip:[this.getSrc().source_ip]};this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Security.AutoBlock.Rules",method:"create",version:1,params:e,scope:this,callback:function(e,t,i){this.clearStatusBusy(),e||this.getMsgBox().alert(_T("autoblock","create_ip"),_T("error","error_unknown")),this.close()}})}else this.setStatusError({text:_T("common","forminvalid"),clear:!0});else"range"===this.form.findField("source").getGroupValue()?this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_error_ip_range")):this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("common","forminvalid"))},getSrc:function(){var e,t=this.form.findField("source").getGroupValue();if("single"===t)e={source_ip:this.form.findField("source_ip").getValue(),source_ip_group:"ip"};else if("range"===t){e={source_ip:this.form.findField("source_ip_begin").getValue()+"~"+this.form.findField("source_ip_end").getValue(),source_ip_group:"iprange"}}else"subnet"===t&&(e={source_ip:String.format("{0}/{1}",this.form.findField("source_ip").getValue(),this.form.findField("source_subnet_mask").getValue()),source_ip_group:"netmask"});return e},setDefault:function(){this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable()},setSource:function(e,t){var i="",s="",n="single",o="",a="",r="";"iprange"===t?(a=(o=e.split("~"))[0],r=o[1],n="range",this.form.findField("source_ip_begin").setValue(a),this.form.findField("source_ip_end").setValue(r)):"netmask"===t?(i=(o=e.split("/"))[0],s=o[1],n="subnet",this.form.findField("source_ip").setValue(i),this.form.findField("source_subnet_mask").setValue(s)):"ip"===t&&(this.form.findField("source_ip").setValue(e),n="single"),this.form.findField("source").setValue(n)},OnSourceRadioClick:function(e,t){if(e.checked)switch(e.value){case"single":default:this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable();break;case"subnet":this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").enable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable();break;case"range":this.form.findField("source_ip").disable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").enable(),this.form.findField("source_ip_end").enable()}},validateBlank:function(e){var t,i,s,n,o,a=!0,r=0,l=0,d="",c=e.findField("source").getGroupValue();if("single"==c)a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip"]);else if("subnet"==c)(a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip"]))&&(a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_subnet_mask"]));else if(SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip_begin"])&&SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip_end"]))if(i=e.findField("source_ip_begin").getValue().toString(),s=e.findField("source_ip_end").getValue().toString(),0<i.indexOf(".")&&0<s.indexOf(".")){if(d=/([0-9]+).([0-9]+).([0-9]+).([0-9]+)/,null===(n=i.match(d))||null===(o=s.match(d)))return!1;for(r=1;r<n.length;r++){if(parseInt(o[r],10)>parseInt(n[r],10)){a=!0;break}if(parseInt(o[r],10)<parseInt(n[r],10)){a=!1;break}a=!1}}else if(0<i.indexOf(":")&&0<s.indexOf(":")){if(0<i.indexOf("::")){for(l=i.match(/:/g).length,t="::",r=0;r<7-l;r++)t+=":";i=i.replace("::",t)}if(0<s.indexOf("::")){for(l=s.match(/:/g).length,t="::",r=0;r<7-l;r++)t+=":";s=s.replace("::",t)}if(d=/([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*)/,null===(n=i.match(d))||null===(o=s.match(d)))return!1;for(r=1;r<n.length;r++){if(""===n[r]&&(n[r]=0),""===o[r]&&(o[r]=0),parseInt(o[r],16)>parseInt(n[r],16)){a=!0;break}if(parseInt(o[r],16)<parseInt(n[r],16)){a=!1;break}a=!1}}else a=!1;else a=!1;return!!a}}),Ext.define("SYNO.SDS.AdminCenter.Security.Account.Application",{extend:"SYNO.SDS.AppInstance"}),Ext.define("SYNO.SDS.AdminCenter.Security.AccountPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.owner=e.owner;var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",(function(e,t){_S("is_admin")&&(new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"enable",["attempts","within_mins","enable_expire"]),new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"enable_expire",["expire_day"]))}),this,{single:!0}),this.extendFormReset()},fillConfig:function(e){var t=[this.fillAutoBlockConfig()];_S("is_admin")&&"yes"===_D("support_fw_security")&&t.push(this.fillDosConfig());var i={title:_T("tree","leaf_protection"),autoScroll:!0,items:t};return Ext.apply(i,e),i},extendFormReset:function(){var e=this,t=this.getForm();t.resetOrigin=t.reset,t.reset=function(){var t=this.resetOrigin();return _S("is_admin")&&"yes"===_D("support_fw_security")&&(Ext.apply(this.mapping_dos_protect_enable,this.mapping_dos_protect_enable_origin),Ext.getCmp(e.IFComboId).setValue(e.IFStore.data.items[0].id),e.updateDosCheckBox()),t}},getHelpParam:function(){return"AdminCenter/connection_security_protection.html"},processParams:function(e,t){return t=this.processDosParams(e,t)},processDosParams:function(e,t){for(var i={api:"SYNO.Core.Security.DoS",method:"get",version:2},s={api:"SYNO.Core.Security.DoS",method:"set",version:2},n=0;n<t.length;n++)!0===SYNO.ux.Utils.checkApiConsistency(i,t[n])&&(t[n].params={configs:this.getWebapiDosGetParams()}),!0===SYNO.ux.Utils.checkApiConsistency(s,t[n])&&(t[n].params={configs:this.getWebapiDosSetParams()});return t},getWebapiDosGetParams:function(){for(var e=this.getAllIfnames(),t=[],i=0;i<e.length;++i)t.push({adapter:e[i]});return t},getWebapiDosSetParams:function(){for(var e=this.getAllIfnames(),t=[],i=0;i<e.length;++i){var s=e[i];t.push({adapter:s,dos_protect_enable:this.mapping_dos_protect_enable[s]})}return t},processReturnData:function(e,t,i){!1===t.has_fail&&(this.processExpireDayGetParam(t,i),this.processDosReturnData(t,i)),this.callParent(arguments)},processExpireDayGetParam:function(e,t){var i=SYNO.SDS.AdminCenter.Security.AutoBlock.Util.getSuccessRespCompoundData({api:"SYNO.Core.Security.AutoBlock",method:"get",version:1},e);null!==i?(this.updateAutoBlockDescField(i.enable?0:-1),i.enable&&this.updateAutoBlockExpiredDescField(i.expire_day?0:-1),this.loadAutoBlockExpireDayGetParam(i)):SYNO.Debug("Error : processExpireDayGetParam")},processDosReturnData:function(e,t){var i=SYNO.SDS.AdminCenter.Security.AutoBlock.Util.getSuccessRespCompoundData({api:"SYNO.Core.Security.DoS",method:"get",version:2},e);if(null!==i){for(var s=0;s<i.length;s++){var n=i[s];this.mapping_dos_protect_enable[n.adapter]=n.dos_protect_enable}Ext.apply(this.mapping_dos_protect_enable_origin,this.mapping_dos_protect_enable),this.updateDosCheckBox()}},loadAutoBlockExpireDayGetParam:function(e){this.getForm().setValues({enable_expire:e.expire_day>0})},fillAutoBlockConfig:function(){return this.viewRule=new SYNO.ux.Button({xtype:"syno_button",text:_T("autoblock","autoblock_view_rules"),scope:this,handler:this.showAutoBlockRuleWindow}),{xtype:"syno_fieldset",title:_T("tree","leaf_autoblock"),itemId:"fieldset_autoblock",webapi:{api:"SYNO.Core.Security.AutoBlock",methods:{get:"get",set:"set"},version:1},collapsible:!0,items:[{xtype:"syno_displayfield",value:_T("autoblock","autoblock_desc")},{xtype:"syno_checkbox",name:"enable",disabled:!_S("is_admin"),boxLabel:_T("autoblock","autoblock_enable"),listeners:{check:{scope:this,fn:this.onAutoBlockEnable}}},{xtype:"syno_displayfield",indent:1,name:"autoblock_rule_desc",value:_T("autoblock","autoblock_rule_desc")},{xtype:"syno_numberfield",name:"attempts",fieldLabel:_T("autoblock","autoblock_attempts"),disabled:!_S("is_admin"),vtype:"number",cls:"syno-ux-numberfield",indent:1,minValue:1,maxlength:4},{xtype:"syno_numberfield",name:"within_mins",fieldLabel:_T("autoblock","autoblock_within_mins"),disabled:!_S("is_admin"),cls:"syno-ux-numberfield",vtype:"number",indent:1,minValue:1,maxlength:7},{xtype:"syno_checkbox",name:"enable_expire",boxLabel:_T("autoblock","autoblock_expired_enable"),disabled:!_S("is_admin"),indent:1,listeners:{check:{scope:this,fn:this.onAutoBlockEnableExpreDay}}},{xtype:"syno_displayfield",value:_T("autoblock","autoblock_expired_desc"),name:"autoblock_expired_desc",indent:1},{xtype:"syno_numberfield",name:"expire_day",fieldLabel:_T("autoblock","autoblock_expired_day"),disabled:!_S("is_admin"),cls:"syno-ux-numberfield",vtype:"number",indent:1,maxlength:3},{xtype:"syno_displayfield",height:10},{xtype:"syno_displayfield",value:_T("autoblock","autoblock_rules_desc")},this.viewRule]}},onAutoBlockEnable:function(e,t){this.updateAutoBlockDescField(t?0:-1)},onAutoBlockEnableExpreDay:function(e,t){this.updateAutoBlockExpiredDescField(t?0:-1)},updateAutoBlockExpiredDescField:function(e){this.form.findField("autoblock_expired_desc").el.dom.tabIndex=e},updateAutoBlockDescField:function(e){var t=this.form.findField("autoblock_rule_desc");0===e?this.viewRule.enable():this.viewRule.disable(),t.el.dom.tabIndex=e,-1===e&&this.updateAutoBlockExpiredDescField(-1)},showAutoBlockRuleWindow:function(e,t){new SYNO.SDS.AdminCenter.Security.AutoBlock.RuleWindow({appWin:this.module.appWin,owner:this.appWin}).show()},fillDosConfig:function(){return this.mapping_dos_protect_enable={},this.mapping_dos_protect_enable_origin={},{xtype:"syno_fieldset",title:_T("tree","leaf_dos"),itemId:"fieldset_dos",collapsible:!0,collapsed:!0,labelWidth:300,items:[{xtype:"syno_combobox",fieldLabel:_T("network","interface"),id:this.IFComboId=Ext.id(),displayField:"display",valueField:"id",labelStyle:"width:180px",isDirty:function(){return!1},store:this.IFStore=this.owner.IFStore,listeners:{select:this.onIFSelect,scope:this}},{xtype:"syno_displayfield",value:_T("firewall","firewall_dos_protect_enable_desc")},{xtype:"syno_checkbox",name:"dos_protect_enable",isDirty:function(){return!1},boxLabel:_T("firewall","firewall_dos_protect_enable"),listeners:{check:this.onDosCheck,scope:this}},{xtype:"syno_displayfield",hidden:!0,value:" "},{xtype:"syno_textfield",hidden:!0,name:"check_form_dirty",isDirty:this.isMappingRelationDirty.createDelegate(this),webapi:{api:"SYNO.Core.Security.DoS",methods:{get:"get",set:"set"},version:2}}]}},initEvents:function(){this.callParent(arguments),_S("is_admin")&&"yes"===_D("support_fw_security")&&this.initDosEvent()},initDosEvent:function(){this.mon(this.IFStore,"load",this.onIFAfterLoad,this)},onIFAfterLoad:function(e,t,i){Ext.getCmp(this.IFComboId).setValue(t[0].id)},onIFSelect:function(e,t,i){this.updateDosCheckBox()},onDosCheck:function(e,t,i){var s=Ext.getCmp(this.IFComboId).getValue();this.mapping_dos_protect_enable[s]=t},updateDosCheckBox:function(){var e=Ext.getCmp(this.IFComboId).getValue(),t=this.mapping_dos_protect_enable[e];this.getForm().findField("dos_protect_enable").setValue(t)},getAllIfnames:function(){var e=[];return Ext.each(this.IFStore.getRange(),(function(t){e.push(t.id)}),this),e},isMappingRelationDirty:function(){return Ext.encode(this.mapping_dos_protect_enable)!==Ext.encode(this.mapping_dos_protect_enable_origin)}}),Ext.define("SYNO.SDS.AdminCenter.Security.AutoBlock.RuleWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t,i;return this.blackListTab=new SYNO.SDS.AdminCenter.Security.AutoBlock.RuleList({appWin:e.appWin,ruleWin:this,itemId:"deny",title:_T("autoblock","autoblock_view_list"),columns:[{header:_T("autoblock","autoblock_ip"),id:"ip",dataIndex:"ip",width:160,sortable:!0,menuDisabled:!0,renderer:function(e,t,i){var s=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(s)+'"',s}},{header:_T("autoblock","autoblock_time"),dataIndex:"record_date",width:200,sortable:!0,menuDisabled:!0},{header:_T("autoblock","autoblock_expire_time_cap"),dataIndex:"expire_date",width:200,sortable:!0,menuDisabled:!0},{header:_T("common","country"),dataIndex:"place",width:200,sortable:!1,menuDisabled:!0,renderer:function(e,t,i){var s=Ext.util.Format.htmlEncode(e);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(s)+'"',s}}]}),this.whiteListTab=new SYNO.SDS.AdminCenter.Security.AutoBlock.RuleList({appWin:e.appWin,ruleWin:this,title:_T("autoblock","autoblock_white_list"),itemId:"allow",columns:[{header:_T("autoblock","autoblock_allow_ip"),id:"ip",dataIndex:"ip",sortable:!0,menuDisabled:!0}]}),i={xtype:"syno_tabpanel",activeTab:0,items:[this.whiteListTab,this.blackListTab]},t={ruleWin:this,title:_T("autoblock","autoblock_view_rules"),width:700,height:440,items:[i],layout:"fit",buttons:[{btnStyle:"grey",text:_T("common","close"),scope:this,handler:function(){this.close()}}]},Ext.apply(t,e),t},resetAllList:function(){this.blackListTab.dataReady=!1,this.whiteListTab.dataReady=!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.AutoBlock.RuleList",{extend:"SYNO.ux.GridPanel",pageSize:250,dataReady:!1,constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this.getSelectionModel(),"selectionchange",this.onSelectionChange,this)},fillConfig:function(e){this.appWin=e.appWin,this.ruleWin=e.ruleWin,this.store=new SYNO.API.JsonStore({api:"SYNO.Core.Security.AutoBlock.Rules",method:"list",version:1,baseParams:{offset:0,limit:this.pageSize,type:e.itemId},root:"ip_info",totalProperty:"total",fields:["ip",{name:"record_date",convert:function(e,t){var i=new Date(1e3*t.record_date);return SYNO.SDS.DateTimeFormatter(i,{type:"datetimesec"})}},{name:"expire_date",convert:function(e,t){if(0===t.expire_date)return _T("autoblock","forever");var i=new Date(1e3*t.expire_date);return SYNO.SDS.DateTimeFormatter(i,{type:"datetimesec"})}},{name:"place",convert:function(e,t){return t.is_public_ip?Ext.isEmpty(t.country)?_T("personal_settings","geoip_lookup_failed"):_T("Country",t.country):_T("personal_settings","private_ip")}}],scope:this,autoLoad:!1,remoteSort:!0,listeners:{load:{scope:this,fn:this.onStoreLoad},exception:{scope:this,fn:this.onStoreException}},appWindow:e.appWin}),this.createBtn=new SYNO.ux.SplitButton({itemId:"btn_create",text:_T("common","create"),scope:this,handler:this.launchAddIPDialog,menu:[{text:_T("autoblock","create_ip"),scope:this,handler:this.launchAddIPDialog},{text:_T("autoblock","import_ip"),scope:this,handler:this.launchFileDialog}]}),this.delBtn=new SYNO.ux.Button({itemId:"btn_del",text:_T("common","remove"),scope:this,handler:this.deleteItem,disabled:!0}),this.exportBtn=new SYNO.ux.Button({itemId:"btn_export",text:_T("autoblock","autoblock_export_ip_list"),scope:this,handler:this.exportIpList}),this.setBtn(this.createBtn,!0);var t={ds:this.store,loadMask:!0,height:300,enableHdMenu:!1,tbar:{items:[this.createBtn,this.delBtn,this.exportBtn,"->",{xtype:"syno_textfilter",itemId:"search",emptyText:_T("user","search_user"),enumAction:"load",queryAction:"load",store:this.store,pageSize:this.pageSize}]},bbar:{xtype:"syno_paging",pageSize:this.pageSize,displayInfo:!0,store:this.store,showRefreshBtn:!0},listeners:{activate:function(){var e=this;!1===e.dataReady&&e.store.reload(),e.dataReady=!0},scope:this}};return Ext.apply(t,e),t},onSelectionChange:function(e){0<e.getCount()?this.setBtn(this.delBtn,!0):this.setBtn(this.delBtn,!1)},deleteItem:function(){var e=this.getSelectionModel().getSelections(),t=[],i=0;for(i=0;i<e.length;i++)t.push(e[i].get("ip"));if(0>=t.length)return this.ruleWin.getMsgBox().alert(_T("tree","leaf_autoblock"),_T("error","error_rmvnone")),!1;this.ruleWin.getMsgBox().confirmDelete(_T("tree","leaf_autoblock"),_T("common","remove_cfrmrmv"),(function(e,i){"yes"===e&&this.sendWebAPIDelete({type:this.itemId,ip:t})}),this)},sendWebAPIDelete:function(e){this.ruleWin.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Security.AutoBlock.Rules",method:"delete",version:1,params:e,scope:this,callback:this.onDeleteDone})},onDeleteDone:function(e,t,i){this.ruleWin.clearStatusBusy(),e?this.store.load():SYNO.Debug("Error : onDeleteDone")},exportIpList:function(){synowebapi.download({api:"SYNO.Core.Security.AutoBlock.Rules",method:"download",version:1,params:{type:this.itemId}})},launchAddIPDialog:function(){var e;_S("demo_mode")?this.ruleWin.getMsgBox().alert(this.title,_JSLIBSTR("uicommon","error_demo")):((e="allow"===this.itemId?new SYNO.SDS.AdminCenter.Security.AutoBlock.AddWhiteListDialog({owner:this.ruleWin,appWin:this.appWin,ruleWin:this.ruleWin,launcher:this.itemId}):new SYNO.SDS.AdminCenter.Security.AutoBlock.AddIPDialog({owner:this.ruleWin,appWin:this.appWin,ruleWin:this.ruleWin,launcher:this.itemId})).open(),this.mon(e,"close",this.reloadAll,this,{single:!0}))},launchFileDialog:function(){var e;_S("demo_mode")?this.ruleWin.getMsgBox().alert(this.title,_JSLIBSTR("uicommon","error_demo")):((e=new SYNO.SDS.AdminCenter.Security.AutoBlock.UploadFileDialog({owner:this.ruleWin,appWin:this.appWin,ruleWin:this.ruleWin,launcher:this.itemId})).open(),this.mon(e,"close",this.reloadAll,this,{single:!0}))},reloadAll:function(){var e=this;e.ruleWin.resetAllList(),e.store.reload(),e.dataReady=!0},onStoreLoad:function(){0===this.store.getTotalCount()?this.setBtn(this.exportBtn,!1):this.setBtn(this.exportBtn,!0)},onStoreException:function(e,t,i,s,n,o){SYNO.Debug("Store exception: options:",e,t,i,s,n,o),this.ruleWin.clearStatusBusy()},setBtn:function(e,t){t?e.enable():e.disable()}}),SYNO.SDS.AdminCenter.Security.AutoBlock.Util={dateRender:function(e){var t=new Date(1e3*e);return 0===e?_T("autoblock","forever"):t.toLocaleString()},getSuccessRespCompoundData:function(e,t){if(!(t.result instanceof Array))return null;for(var i=0;i<t.result.length;i+=1){var s=t.result[i];if(!1!==SYNO.ux.Utils.checkApiConsistency(e,s)){if(!0===s.has_fail||!1===s.success)break;return s.data?s.data:null}}return null}},Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.AddCrtTypeStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t,i=this;i.certificates=e.certificates,i.certSelector=new SYNO.SDS.AdminCenter.Security.Certificate.CrtComboBox({hideLabel:!0,itemId:"certSelector",indent:1,tabIndex:-1,name:"certId",disabled:!0}),t={headline:_T("certificate","select_action"),items:[{xtype:"syno_radio",boxLabel:_T("certificate","add_new_certificate"),name:"addType",inputValue:"add",checked:!0},{xtype:"syno_displayfield",indent:1,tabIndex:-1,value:_T("certificate","create_crt_desc")},{xtype:"syno_compositefield",hideLabel:!0,items:[i.replaceCertRadio=new SYNO.ux.Radio({xtype:"syno_radio",boxLabel:_T("certificate","replace_certificate"),name:"addType",inputValue:"replace",listeners:{check:function(e,t){t?this.certSelector.enable():this.certSelector.disable()},scope:this}}),{xtype:"syno_displayfield",width:100,value:" ",tabIndex:-1}]},{xtype:"syno_displayfield",indent:1,tabIndex:-1,value:_T("certificate","replace_crt_desc")},i.certSelector]},Ext.apply(t,e),this.callParent([t])},activate:function(){var e=[];Ext.each(this.certificates,(function(t){t.user_deletable&&e.push(t)})),0!==e.length?(this.certSelector.getStore().loadData(e),this.certSelector.setValue(e[0].id)):this.replaceCertRadio.disable()},getNext:function(){return this.nextId}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.AddCrtMethodStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t={headline:_T("certificate","select_action"),items:[{xtype:"syno_textfield",fieldLabel:_T("certificate","description"),name:"desc",maxLength:64},{xtype:"syno_radio",boxLabel:_T("certificate","import_crt"),name:"addMethod",inputValue:"import",checked:!0},{xtype:"syno_displayfield",indent:1,tabIndex:-1,value:_T("certificate","import_crt_desc")},{xtype:"syno_radio",boxLabel:_T("certificate","create_self_signed_crt"),name:"addMethod",inputValue:"selfSigned",hidden:"yes"!==_D("support_self_sign_cert")},{xtype:"syno_displayfield",indent:1,tabIndex:-1,value:_T("certificate","create_self_signed_crt_desc"),hidden:"yes"!==_D("support_self_sign_cert")},{xtype:"syno_radio",boxLabel:_T("certificate","create_by_lets_encrypt"),name:"addMethod",inputValue:"letsEncrypt"},{xtype:"syno_displayfield",indent:1,tabIndex:-1,value:_T("certificate","create_by_lets_encrypt_desc")},{xtype:"syno_checkbox",boxLabel:_T("certificate","set_as_default_certificate"),name:"asDefault"},{xtype:"syno_displayfield",htmlEncode:!1,value:String.format('<font class="note-font">{0}</font>{1}',_T("common","note")+_T("common","colon"),_T("certificate","lets_encrypt_china_stable_hint")),hidden:"CN"!==_S("ip_country")}]};Ext.apply(t,e),this.callParent([t])},activate:function(){var e,t,i,s=this;if(""!==(t=s.owner.getReplacedCertId()))for(e=0;e<s.certificates.length;++e)if(t===s.certificates[e].id){i=s.certificates[e];break}s.getForm().findField("desc").setValue(i?i.desc:"")},getNext:function(){var e=this.getForm(),t=e.getValues();return!!e.isValid()&&("import"===t.addMethod?"importCrtStep":"selfSigned"===t.addMethod?"rootCrtInfoStep":"letsEncryptInfoStep")}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.ImportCrtStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t={headline:_T("certificate","import_crt_headline"),webapi:{api:"SYNO.Core.Certificate",method:"import",version:1},fileUpload:!0,trackResetOnLoad:!0,frame:!1,border:!1,height:200,items:[{xtype:"syno_displayfield",value:_T("service","service_ssl_key_desc")},{xtype:"syno_filebutton",fieldLabel:_T("service","service_ssl_key"),name:"key"},{xtype:"syno_filebutton",fieldLabel:_T("service","service_ssl_crt"),name:"cert"},{xtype:"syno_filebutton",fieldLabel:_T("service","service_ssl_inter_crt"),name:"inter_cert"},{xtype:"syno_displayfield",htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+': </span><span class="normal-font">'+_T("certificate","import_cert_format_tips")+"</span>"},{xtype:"syno_displayfield",htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+': </span><span class="normal-font">'+_T("certificate","import_key_format_tips")+"</span>"},{xtype:"hidden",name:"id",value:""},{xtype:"hidden",name:"desc",value:""},{xtype:"hidden",name:"as_default",value:""}]};Ext.apply(t,e),this.callParent([t])},initComponent:function(){var e=this;e.callParent(arguments),e.mon(e.getForm(),"actioncomplete",e.onFormSuccess,e),e.mon(e.getForm(),"actionfailed",e.onFormFailed,e)},checkState:function(){this.owner.getButton("next").setText(_T("common","ok"))},getNext:function(){var e=this,t=e.owner.getAddTypeValues(),i=e.owner.getAddMethodValues(),s=this.getForm(),n=function(e,t){s.findField(e).setValue(t)};return"replace"===t.addType&&n("id",t.certId),n("desc",i.desc),i.asDefault&&n("as_default",!0),e.owner.setStatusBusy({text:_T("common","msg_waiting"),iconCls:"x-mask-loading"}),this.getForm().doAction("apply"),!1},onFormSuccess:function(e,t){this.owner.clearStatusBusy();var i=this;t.result.data.restart_httpd?(i.owner.setStatusBusy({text:_T("service","restart_apache"),iconCls:"x-mask-loading"}),i.owner.checkProgress.defer(3e4,i)):i.owner.close()},onFormFailed:function(e,t){this.owner.clearStatusBusy(),this.owner.getMsgBox().alert(_T("tree","leaf_service"),SYNO.SDS.AdminCenter.Security.Certificate.Err2Msg(t.result.error.code))}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.RootCrtInfoStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module;var t=SYNO.SDS.AdminCenter.Security.Certificate.Util,i={headline:_T("certificate","create_root_crt"),isWizardMode:!0,labelWidth:250,synodefaults:{width:200}};Ext.apply(i,t.getCertFormItems(!0,!0)),Ext.apply(i,e),this.callParent([i])},getNext:function(){var e=this,t=e.owner.getStep(e.nextId),i=e.getForm();return!!i.isValid()&&(t.fillFields(i.getValues()),e.nextId)}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.CrtInfoStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.isSet=!1;var t=SYNO.SDS.AdminCenter.Security.Certificate.Util,i={headline:_T("certificate","create_crt"),isWizardMode:!0,labelWidth:250,synodefaults:{width:200}};Ext.apply(i,t.getCertFormItems(!1,!1)),Ext.apply(i,e),this.callParent([i])},fillFields:function(e){if(!this.isSet){for(var t in e)if(e.hasOwnProperty(t)){if("common_name"==t)continue;this.getForm().findField(t).setValue(e[t])}this.isSet=!0}},initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("alias").getEl(),_T("certificate","alias_tip"))}),this,{single:!0})},chompArray:function(e){for(var t=e.replace(/"/,"").split(/;/),i=0;i<t.length;i++)t[i]=t[i].replace(/^\s+|\s+$/,"");return t.join(";")},checkState:function(){this.owner.getButton("next").setText(_T("common","commit"))},getNext:function(){var e=this,t=this.getForm(),i=this.owner.getStep("rootCrtInfoStep").getForm().getValues(),s={},n={action:"crt"},o=!0;if(!t.isValid())return!1;for(var a in"replace"===e.owner.getAddTypeValues().addType&&(n.id=e.owner.getAddTypeValues().certId),e.owner.getAddMethodValues().asDefault&&(n.as_default=!0),n.desc=e.owner.getAddMethodValues().desc,i)if(i.hasOwnProperty(a)){if("key_length"==a)continue;if(i[a]!=t.getValues()[a]){o=!1;break}}if(o)return e.owner.getMsgBox().alert(_T("error","error_error"),_T("certificate","server_and_ca_same")),!1;for(a in i)i.hasOwnProperty(a)&&(s["ca_"+a]=i[a]);return Ext.apply(n,s),Ext.apply(n,t.getValues()),_T("certificate","empty_text_alias")==n.alias?n.alias="":n.alias=this.chompArray(n.alias),this.owner.setStatusBusy({text:_T("certificate","creating_crt"),iconCls:"x-mask-loading"}),this.owner.sendWebAPI({api:"SYNO.Core.Certificate.CRT",version:1,method:"create",params:n,scope:this,callback:function(t,i,s){if(e.owner.clearStatusBusy(),!t)return e.owner.getMsgBox().alert(_T("tree","leaf_notification"),_T("common","error_system")),!1;i.restart_httpd?(e.owner.setStatusBusy({text:_T("service","restart_apache"),iconCls:"x-mask-loading"}),e.owner.checkProgress.defer(3e4,this)):e.owner.close()}}),!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.LetsEncryptInfoStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t={headline:_T("certificate","lets_encrypt_headline"),items:[{xtype:"syno_textfield",vtype:"FQDN",fieldLabel:_T("dhcp_server","domain_name"),name:"domainName",maxlength:256,allowBlank:!1,emptyText:_T("certificate","empty_text_common_name")+" "},{xtype:"syno_combobox",fieldLabel:_T("common","email"),name:"email",maxlength:64,allowBlank:!1,emptyText:_T("certificate","empty_text_email")+" ",editable:!0,forceSelection:!1,typeAhead:!0,vtype:"email",displayField:"contact",valueField:"contact",store:this.store=new Ext.data.JsonStore({autoDestroy:!0,root:"email",idProperty:"contact",fields:["contact"]})},{xtype:"syno_textarea",fieldLabel:_T("certificate","alias"),maxlength:5120,emptyText:"*.example.com",name:"alias",maskRe:/[\-.*A-Za-z0-9;]/,regex:/^([\-.*A-Za-z0-9;]+)$/},{xtype:"syno_displayfield",htmlEncode:!1,value:_T("certificate","warn_acc_limit")}]};Ext.apply(t,e),this.callParent([t])},activate:function(){var e=this;e.owner.setStatusBusy({text:_T("common","loading"),iconCls:"x-mask-loading"}),e.sendWebAPI({webapi:{api:"SYNO.Core.Certificate.LetsEncrypt.Account",method:"list",version:1},scope:e,callback:function(t,i){e.owner.clearStatusBusy(),t&&e.store.loadData(i)}})},initEvents:function(){var e=this;e.callParent(arguments),e.mon(e,"afterlayout",(function(){SYNO.ux.AddTip(e.getForm().findField("alias").getEl(),_T("certificate","alias_tip"))}),e,{single:!0})},getNext:function(){var e=this,t={},i=e.getForm(),s=i.getValues(),n=e.owner.getAddTypeValues(),o=e.owner.getAddMethodValues();return!!i.isValid()&&("replace"===n.addType&&(t.id=n.certId),t.desc=o.desc,o.asDefault&&(t.as_default=!0),t.domain_name=s.domainName,0<s.alias.length&&(t.domain_name+=";"+s.alias),t.email=s.email,e.owner.setStatusBusy({text:_T("common","msg_waiting"),iconCls:"x-mask-loading"}),e.sendWebAPI({api:"SYNO.Core.Certificate.LetsEncrypt",method:"create",version:1,params:t,timeout:36e4,scope:this,callback:function(t,i){var s=_T("common","error_system");if(e.owner.clearStatusBusy(),!t)return s=Ext.isObject(i)&&504===i.status?String.format(_T("common","operations_error"),"Let's Encrypt"):SYNO.API.getErrorString(i),e.owner.getMsgBox().alert(_T("tree","leaf_notification"),s),!1;i.restart_httpd?(e.owner.setStatusBusy({text:_T("service","restart_apache"),iconCls:"x-mask-loading"}),e.owner.checkProgress.defer(3e4,this)):e.owner.close()}}),!1)}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.CsrActionStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t,i=this;i.owner=e.owner,i.module=e.module,i.crts=e.crts,i.signCrtSelector=new SYNO.SDS.AdminCenter.Security.Certificate.CrtComboBox({hideLabel:!0,indent:1,tabIndex:-1,itemId:"signCrtSelector",name:"signCrtId",disabled:!0}),t={headline:_T("certificate","select_action"),items:[{xtype:"syno_radio",boxLabel:_T("certificate","create_csr"),name:"action",inputValue:"genCsr",checked:!0},{xtype:"syno_displayfield",indent:1,tabIndex:-1,value:_T("certificate","create_csr_desc")},{xtype:"syno_compositefield",name:"signCsr_radio",hideLabel:!0,items:[i.signCsrRadio=new SYNO.ux.Radio({boxLabel:_T("certificate","sign_csr"),name:"action",inputValue:"signCsr",listeners:{check:function(e,t){t&&this.signCrtSelector.store.getTotalCount()>0?this.signCrtSelector.enable():this.signCrtSelector.disable()},scope:this}}),{xtype:"syno_displayfield",width:100,value:"",tabIndex:-1}]},{xtype:"syno_displayfield",indent:1,tabIndex:-1,value:_T("certificate","sign_csr_desc")},i.signCrtSelector]},Ext.apply(t,e),i.callParent([t])},activate:function(){var e,t=this,i=[];for(e=0;e<t.crts.length;e++)t.crts[e].self_signed_cacrt_info&&i.push(t.crts[e]);0===i.length?(t.signCrtSelector.disable(),t.form.findField("signCsr_radio").disable()):(t.signCrtSelector.getStore().loadData(i),t.signCrtSelector.setValue(i[0].id)),t.owner.getButton("next").setText(_T("common","alt_next"))},getNext:function(){var e,t=this,i=t.getForm().getValues();return"genCsr"===i.action?"csrInfoStep":"renew"===i.action?(t.crts.each((function(t){if(t.id===i.renewCrtId)return e=t,!1})),e&&e.subject&&e.subject.country?(t.genRenewCsr(i.renewCrtId),!1):"csrCountryStep"):"uploadCsrStep"},genRenewCsr:function(e){var t=this;t.owner.setStatusBusy({text:_T("certificate","creating_csr"),iconCls:"x-mask-loading"}),t.owner.sendWebAPI({api:"SYNO.Core.Certificate.CSR",method:"renew",version:"1",params:{id:e},callback:function(e,i,s){t.owner.clearStatusBusy(),e?t.owner.goNext("downloadCsrStep"):t.owner.getMsgBox().alert(_T("tree","leaf_notification"),_T("common","error_system"))}})}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.CsrCountryStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module,this.renewCrt=e.crt;var t=SYNO.SDS.AdminCenter.Security.Certificate.Util,i={headline:_T("certificate","input_csr_info"),isWizardMode:!0,labelWidth:250,synodefaults:{width:200}};Ext.apply(i,t.getCSRCountryFormItems()),Ext.apply(i,e),this.callParent([i])},getNext:function(){var e=this;return e.owner.setStatusBusy({text:_T("certificate","creating_csr"),iconCls:"x-mask-loading"}),e.owner.sendWebAPI({api:"SYNO.Core.Certificate.CSR",method:"renew",version:"1",params:{id:void 0!==e.renewCrt?e.renewCrt.id:e.owner.getStep("csrActionStep").getForm().getValues().renewCrtId,country:e.getForm().getValues().country},callback:function(t,i,s){e.owner.clearStatusBusy(),t?e.owner.goNext("downloadCsrStep"):e.owner.getMsgBox().alert(_T("tree","leaf_notification"),_T("common","error_system"))}}),!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.CsrInfoStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module;var t=SYNO.SDS.AdminCenter.Security.Certificate.Util,i={headline:_T("certificate","create_csr"),isWizardMode:!0,labelWidth:250,synodefaults:{width:200}};Ext.apply(i,t.getCertFormItems(!0,!1)),Ext.apply(i,e),this.callParent([i])},getNext:function(){var e=this,t=this.getForm();return!!t.isValid()&&(this.owner.setStatusBusy({text:_T("certificate","creating_csr"),iconCls:"x-mask-loading"}),this.owner.sendWebAPI({api:"SYNO.Core.Certificate.CSR",method:"create",version:"1",params:t.getValues(),callback:function(t,i,s){e.owner.clearStatusBusy(),t?e.owner.goNext("downloadCsrStep"):e.owner.getMsgBox().alert(_T("tree","leaf_notification"),_T("common","error_system"))}}),!1)}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.DownloadCsrStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.moduel;var t={headline:_T("certificate","create_csr_finish"),isWizardMode:!0,items:[{xtype:"syno_displayfield",name:"des",value:_T("certificate","click_download_button")},{xtype:"syno_displayfield",name:"des",value:_T("certificate","create_csr_finish_desc")}]};Ext.apply(t,e),this.callParent([t])},checkState:function(){this.owner.getButton("next").setText(_T("certificate","download"))},getNext:function(){return synowebapi.download({api:"SYNO.Core.Certificate",version:1,method:"export",params:{file:"csr_set"}}),this.owner.close(),!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.UploadCsrStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module;var t={webapi:{api:"SYNO.Core.Certificate.CSR",method:"sign",version:1},fileUpload:!0,labelWidth:250,headline:_T("certificate","sign_csr"),isWizardMode:!0,items:[{xtype:"syno_filebutton",fieldLabel:_T("certificate","csr"),name:"csr"},{xtype:"syno_textfield",fieldLabel:_T("certificate","validity_period"),vtype:"number",name:"days",allowBlank:!1,value:365,width:200},{xtype:"syno_textfield",fieldLabel:_T("certificate","alias"),maxlength:256,emptyText:_T("certificate","empty_text_alias")+" ",name:"alias",width:200,validator:function(e){return e.split(";").map((function(e){return e.trim()})).every(Ext.form.VTypes.FQDN3)}},{xtype:"hidden",name:"id",value:""}]};Ext.apply(t,e),this.callParent([t]),this.mon(this.getForm(),"actioncomplete",this.onFormSuccess,this),this.mon(this.getForm(),"actionfailed",this.onFormFailed,this),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("alias").getEl(),_T("certificate","alias_tip"))}),this,{single:!0})},activate:function(){var e=this.getForm(),t=this.owner.getStep("csrActionStep").getForm().getValues().signCrtId;e.findField("id").setValue(t)},onFormSuccess:function(e,t){this.owner.clearStatusBusy(),this.owner.goNext("downloadCrtStep")},onFormFailed:function(e,t){this.owner.clearStatusBusy(),this.owner.getMsgBox().alert(_T("tree","leaf_service"),SYNO.SDS.AdminCenter.Security.Certificate.Err2Msg(t.result.error.code))},getNext:function(){var e=this.getForm();if(!e.isValid())return!1;var t=e.findField("csr").getValue();return Ext.isEmpty(t)?(this.owner.getMsgBox().alert(_T("tree","leaf_service"),_T("certificate","no_csr_selected")),!1):(this.owner.setStatusBusy({text:_T("certificate","signing_csr"),iconCls:"x-mask-loading"}),this.getForm().doAction("apply"),!1)}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.DownloadCrtStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.moduel;var t={headline:_T("certificate","sign_csr_finish"),isWizardMode:!0,items:[{xtype:"syno_displayfield",name:"des",value:_T("certificate","click_download_button_crt")},{xtype:"syno_displayfield",name:"des",value:_T("certificate","sign_csr_finish_desc")}]};Ext.apply(t,e),this.callParent([t])},checkState:function(){this.owner.getButton("next").setText(_T("certificate","download"))},getNext:function(){return synowebapi.download({api:"SYNO.Core.Certificate",method:"export",version:1,params:{file:"signed_set"}}),this.owner.close(),!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.AddCrtWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){var t,i=this;i.owner=e.owner,i.module=e.module,t={title:_T("certificate","create_crt"),width:650,height:550,steps:[new SYNO.SDS.AdminCenter.Security.Certificate.AddCrtTypeStep({owner:i,module:i.module,certificates:e.certificates,itemId:"addCrtTypeStep",nextId:"addCrtMethodStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.AddCrtMethodStep({owner:i,module:i.module,certificates:e.certificates,itemId:"addCrtMethodStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.ImportCrtStep({owner:i,module:i.module,itemId:"importCrtStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.RootCrtInfoStep({owner:i,module:i.module,itemId:"rootCrtInfoStep",nextId:"crtInfoStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.CrtInfoStep({owner:i,module:i.module,itemId:"crtInfoStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.LetsEncryptInfoStep({owner:i,module:i.module,itemId:"letsEncryptInfoStep"})]},Ext.apply(t,e),i.callParent([t])},getAddTypeValues:function(){return this.getStep("addCrtTypeStep").getForm().getValues()},getAddMethodValues:function(){return this.getStep("addCrtMethodStep").getForm().getValues()},getReplacedCertId:function(){var e=this.getStep("addCrtTypeStep").getForm().getValues();return"add"===e.addType?"":e.certId},getAsDefault:function(){return this.getStep("addCrtMethodStep").getForm().getValues().asDefault},getDesc:function(){},checkProgress:function(){var e=this;"https:"===location.protocol&&location.reload(),e.register_id=e.pollReg({webapi:{api:"SYNO.Core.Certificate.CRT",method:"list",version:1},interval:3,immediate:!0,status_callback:function(t,i,s,n){(t||i.code)&&(i.code&&e.owner.getMsgBox().alert(_T("tree","leaf_service"),SYNO.SDS.AdminCenter.Security.Certificate.Err2Msg(i.code)),e.pollUnreg(e.register_id),e.owner.clearStatusBusy(),e.owner.close())}})}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t,i,s,n,o,a=this,r=[];for(a.owner=e.owner,a.module=e.module,a.cert=e.cert,t=0;t<a.cert.services.length;t++)n="",(s=a.cert.services[t]).display_name_i18n&&(2===(o=s.display_name_i18n.split(":")).length?n=0===_T(o[0],o[1]).length?_JSLIBSTR(o[0],o[1]):_T(o[0],o[1]):3===o.length&&(n=_TT(o[0],o[1],o[2]))),n=n||s.display_name,r.push(n);0===r.length&&r.push("-"),i={title:String.format("{0} - {1}",_T("common","alt_edit"),a.cert.commonName),width:550,height:a.cert.is_default?300:330,minWidth:550,minHeight:a.cert.is_default?300:330,autoFlexcroll:!0,items:a.formpanel=new SYNO.SDS.Utils.FormPanel({frame:!1,border:!1,autoHeight:!0,bodyStyle:{padding:0},items:[{xtype:"syno_textfield",fieldLabel:_T("certificate","description"),name:"desc",value:a.cert.desc,maxLength:64},{xtype:"syno_displayfield",fieldLabel:_T("certificate","issue_to"),value:a.cert.subject.common_name},{xtype:"syno_displayfield",fieldLabel:_T("certificate","issuer"),value:a.cert.issuer.common_name},{xtype:"syno_displayfield",fieldLabel:_T("certificate","used_by"),value:r.join(", ")},{xtype:"syno_checkbox",hidden:a.cert.is_default,boxLabel:_T("certificate","set_as_default_certificate"),name:"asDefault"}]}),buttons:[{btnStyle:"grey",text:_T("common","cancel"),handler:a.close,scope:a},{btnStyle:"blue",text:_T("common","apply"),handler:a.onApply,scope:a}],listeners:{beforeclose:a.onBeforeClose,scope:a}},Ext.apply(i,e),a.callParent([i])},onApply:function(){var e=this,t=this.formpanel.getForm(),i=t.getValues(),s={};if(!t.isValid())return!1;t.isDirty()?(i.asDefault&&(s.as_default=!0),s.desc=i.desc,s.id=e.cert.id,e.setStatusBusy(),e.sendWebAPI({api:"SYNO.Core.Certificate.CRT",method:"set",version:1,params:s,callback:function(t,i){var s=e.formpanel.getForm();Ext.each(s.items.items,(function(e){e.originalValue=e.getValue()})),e.close()}})):e.close()},onBeforeClose:function(){var e=this.formpanel.getForm();if(e.isDirty())return this.confirmLostChangePromise({save:this.onApply,dontSave:function(){e.reset(),this.close()},cancel:Ext.emptyFn},this),!1}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.CsrWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){var t,i=this,s=[];i.owner=e.owner,i.module=e.module,s="yes"!==_D("support_self_sign_cert")?[new SYNO.SDS.AdminCenter.Security.Certificate.CsrInfoStep({owner:i,module:i.module,itemId:"csrInfoStep",nextId:"downloadCsrStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.CsrCountryStep({owner:i,module:i.module,itemId:"csrCountryStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.DownloadCsrStep({owner:i,module:i.module,itemId:"downloadCsrStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.UploadCsrStep({owner:i,module:i.module,itemId:"uploadCsrStep",nextId:"downloadCrtStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.DownloadCrtStep({owner:i,module:i.module,itemId:"downloadCrtStep"})]:[new SYNO.SDS.AdminCenter.Security.Certificate.CsrActionStep({owner:i,module:i.module,itemId:"csrActionStep",crts:e.crts}),new SYNO.SDS.AdminCenter.Security.Certificate.CsrInfoStep({owner:i,module:i.module,itemId:"csrInfoStep",nextId:"downloadCsrStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.CsrCountryStep({owner:i,module:i.module,itemId:"csrCountryStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.DownloadCsrStep({owner:i,module:i.module,itemId:"downloadCsrStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.UploadCsrStep({owner:i,module:i.module,itemId:"uploadCsrStep",nextId:"downloadCrtStep"}),new SYNO.SDS.AdminCenter.Security.Certificate.DownloadCrtStep({owner:i,module:i.module,itemId:"downloadCrtStep"})],t={title:_T("certificate","create_crt"),width:650,height:550,steps:s},Ext.apply(t,e),i.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.MappingConfigPanel",{extend:"SYNO.ux.EditorGridPanel",constructor:function(e){var t,i=this,s=[];i.owner=e.owner,i.module=e.module,i.services={},i.certificates=e.certificates,i.prepareData(i.certificates,s,i.services),i.gridStore=new Ext.data.JsonStore({fields:["service","subscriber","serviceName","crtId","crtDesc","user_setable"],autoDestroy:!0}),i.gridStore.loadData(s);var n=new Ext.grid.ColumnModel({columns:[{header:_T("schedule","title_service"),dataIndex:"serviceName",width:200,sortable:!1},{header:_T("certificate","certificate"),dataIndex:"crtId",width:200,editor:i.crtEditor=new SYNO.SDS.AdminCenter.Security.Certificate.CrtComboBox({name:"crt",hideLabel:!0,editable:!1,mode:"local"}),listeners:{click:function(e,t,s){var n=i.gridStore.getAt(s),o=e.getCellEditor(s);!o.field.isExpanded()&&n.get("user_setable")&&o.field.onTriggerClick()},scope:this},renderer:function(e,t,i){if(!i.get("user_setable")){var s=t.css.split(" "),n=[];Ext.each(s,(function(e){"syno-ux-triggerfield"!==e&&n.push(e)})),t.css=n.join(" ")}return Ext.util.Format.htmlEncode(this.getEditor().store.getById(e).get("cn"))}}],isCellEditable:function(e,t){return!!i.gridStore.getAt(t).get("user_setable")&&Ext.grid.ColumnModel.prototype.isCellEditable.call(this,e,t)}});t={title:_T("common","configure"),layout:"fit",width:600,height:400,ds:i.gridStore,cm:n,clicksToEdit:1,enableColumnMove:!1,enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),listeners:{activate:this.onActivate,scope:this}},Ext.apply(t,e),i.callParent([t])},onActivate:function(){this.crtEditor.getStore().loadData(this.certificates)},prepareData:function(e,t,i){var s,n,o,a,r,l,d;for(s=0;s<e.length;s++)for(o=e[s],n=0;n<o.services.length;n++)l="",(a=o.services[n]).display_name_i18n&&(2===(r=a.display_name_i18n.split(":")).length?l=_T(r[0],r[1])||_JSLIBSTR(r[0],r[1]):3===r.length&&(l=_TT(r[0],r[1],r[2]))),l=l||a.display_name,d=void 0===a.user_setable||a.user_setable,t.push({service:a.service,serviceName:l,subscriber:a.subscriber,crtId:o.id,crtDesc:o.desc,user_setable:d}),i[a.subscriber+"_"+a.service]=a;t.sort((function(e,t){return e.serviceName<t.serviceName?-1:1}))}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.CrtComboBox",{extend:"SYNO.ux.MessageComboBox",constructor:function(e){var t={displayField:"cn",descriptionField:"displayDesc",valueField:"id",allowBlank:!1,store:new Ext.data.JsonStore({autoDestroy:!0,idProperty:"id",fields:["id","desc","is_default","key_types","subject",{name:"displayDesc",convert:function(e,t){var i=Ext.util.Format.htmlEncode(t.desc);return t.key_types&&"RSA"!=t.key_types&&(i=String.format("({1}) {0}",i,t.key_types)),t.is_default&&(i=String.format("({1}) {0}",i,_T("common","default"))),i}},{name:"cn",convert:function(e,t){return t.subject.common_name?t.subject.common_name:""}}]})};Ext.apply(t,e),this.callParent([t])},onSelect:function(e,t){this.callParent(arguments),this.fireEvent("blur",this)}}),SYNO.SDS.AdminCenter.Security.Certificate.Util={getCertFormItems:function(e,t){var i=[{xtype:"syno_combobox",fieldLabel:_T("certificate","key_length"),name:"key_length",editable:!1,allowBlank:!1,autoSelect:!0,forceSelection:!0,value:"2048",store:["4096","2048","1024","512"]},{xtype:"syno_textfield",fieldLabel:_T("certificate","common_name"),maxlength:64,name:"common_name",allowBlank:!1,maskRe:/[\-.A-Za-z0-9()_ *]/,regex:/^([\-.A-Za-z0-9()_ *]+)$/,emptyText:t?_T("certificate","empty_text_common_name_ca")+" ":_T("certificate","empty_text_common_name")+" "},{xtype:"syno_textfield",fieldLabel:_T("common","email"),maxlength:64,name:"email",allowBlank:!1,emptyText:_T("certificate","empty_text_email")+" ",maskRe:/[\-.A-Za-z0-9_@]/,regex:/^([\-.A-Za-z0-9_@]+)$/,vtype:"email"},{xtype:"syno_combobox",fieldLabel:_T("common","location"),maxlength:32,name:"country",allowBlank:!1,disableKeyFilter:!1,value:"TW",maskRe:/./,regex:/^.*$/,store:this.getCountry()},{xtype:"syno_textfield",fieldLabel:_T("certificate","state_or_provine"),maxlength:64,name:"state",emptyText:_T("certificate","empty_text_state")+" ",allowBlank:!1},{xtype:"syno_textfield",fieldLabel:_T("common","city"),maxlength:64,name:"city",allowBlank:!1,emptyText:_T("certificate","empty_text_city")+" "},{xtype:"syno_textfield",fieldLabel:_T("certificate","organizaton"),maxlength:64,name:"organization",allowBlank:!1,emptyText:_T("certificate","empty_text_organization")+" "},{xtype:"syno_textfield",fieldLabel:_T("certificate","department"),maxlength:64,name:"department",allowBlank:!1,emptyText:_T("certificate","empty_text_department")+" "}];return!0!==e&&(i=i.concat([this.getAliasConfig()])),{items:i,defaults:{invalidText:_T("certificate","invalid_value"),maskRe:/[\-.A-Za-z0-9()_ ]/,regex:/^([\-.A-Za-z0-9()_ ]+)$/}}},getCSRCountryFormItems:function(){return{items:[{xtype:"syno_combobox",fieldLabel:_T("common","location"),maxlength:32,name:"country",allowBlank:!1,disableKeyFilter:!1,value:"TW",maskRe:/./,regex:/^.*$/,store:this.getCountry()}],defaults:{invalidText:_T("certificate","invalid_value"),maskRe:/[\-.A-Za-z0-9()_ ]/,regex:/^([\-.A-Za-z0-9()_ ]+)$/}}},getAliasConfig:function(){return{xtype:"syno_textfield",fieldLabel:_T("certificate","alias"),maxlength:256,emptyText:_T("certificate","empty_text_alias")+" ",name:"alias",maskRe:/[\-.A-Za-z0-9;]/,regex:/^([\-.A-Za-z0-9;]+)$/}},getCountry:function(){var e=[];return Ext.each(["AD","AE","AF","AG","AI","AL","AM","AO","AQ","AR","AS","AT","AU","AW","AX","AZ","BA","BB","BD","BE","BF","BG","BH","BI","BJ","BL","BM","BN","BO","BQ","BR","BS","BT","BV","BW","BY","BZ","CA","CC","CD","CF","CG","CH","CI","CK","CL","CM","CN","CO","CR","CU","CV","CW","CX","CY","CZ","DE","DJ","DK","DM","DO","DZ","EC","EE","EG","EH","ER","ES","ET","FI","FJ","FK","FM","FO","FR","GA","GB","GD","GE","GF","GG","GH","GI","GL","GM","GN","GP","GQ","GR","GS","GT","GU","GW","GY","HK","HM","HN","HR","HT","HU","ID","IE","IL","IM","IN","IO","IQ","IR","IS","IT","JE","JM","JO","JP","KE","KG","KH","KI","KM","KN","KP","KR","KW","KY","KZ","LA","LB","LC","LI","LK","LR","LS","LT","LU","LV","LY","MA","MC","MD","ME","MF","MG","MH","MK","ML","MM","MN","MO","MP","MQ","MR","MS","MT","MU","MV","MW","MX","MY","MZ","NA","NC","NE","NF","NG","NI","NL","NO","NP","NR","NU","NZ","OM","PA","PE","PF","PG","PH","PK","PL","PM","PN","PR","PS","PT","PW","PY","QA","RE","RO","RS","RU","RW","SA","SB","SC","SD","SE","SG","SH","SI","SJ","SK","SL","SM","SN","SO","SR","SS","ST","SV","SX","SY","SZ","TC","TD","TF","TG","TH","TJ","TK","TL","TM","TN","TO","TR","TT","TV","TW","TZ","UA","UG","UM","US","UY","UZ","VA","VC","VE","VG","VI","VN","VU","WF","WS","YE","YT","ZA","ZM","ZW"],(function(t){e.push([t,"["+t+"] "+_T("Country",t)])})),e}},Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.Config.Dialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t,i=this;i.owner=e.owner,i.module=e.module,i.certificates=e.certificates,t={title:_T("common","common_settings"),layout:"fit",width:600,height:420,items:[new SYNO.SDS.AdminCenter.Security.Certificate.Config.TabPanel({itemId:"tab",owner:this,module:i.module,certificates:i.certificates})],buttons:[{btnStyle:"grey",text:_T("common","cancel"),handler:this.close,scope:this},{btnStyle:"blue",text:_T("common","apply"),handler:this.onApply,scope:this}],listeners:{beforeclose:this.onBeforeClose.createDelegate(this)}},Ext.apply(t,e),i.callParent([t]),this.tab=this.getComponent("tab")},onApply:function(){let e=this.tab.mappingPanel.gridStore;if(0!==e.getModifiedRecords().length){var t,i,s=[];for(t=0;t<e.getCount();t++)if((i=e.getAt(t)).dirty){var n=i.get("subscriber"),o=i.get("service");s.push({service:this.tab.mappingPanel.services[n+"_"+o],old_id:i.modified.crtId,id:i.get("crtId")})}var a=_T("certificate","notify_change_certificate");this.getMsgBox().confirm("",a,(function(t){"yes"===t&&(this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Certificate.Service",method:"set",version:1,params:{settings:s},callback:function(t,i){var s=_T("common","error_system");if(this.clearStatusBusy(),!t)return s=SYNO.API.getErrorString(i),this.getMsgBox().alert(_T("tree","leaf_notification"),s),!1;e.commitChanges(),i.restart_httpd?(this.setStatusBusy({text:_T("service","restart_apache")}),this.checkProgress.defer(3e4,this)):this.close()},scope:this}))}),this)}else this.close()},onBeforeClose:function(){const e=this.tab.mappingPanel.gridStore;if(0<e.getModifiedRecords().length)return this.confirmLostChangePromise({save:this.onApply,dontSave:function(){e.rejectChanges(),this.close()},cancel:Ext.emptyFn},this),!1},checkProgress:function(){var e=this;"https:"===location.protocol&&location.reload(),e.register_id=e.pollReg({webapi:{api:"SYNO.Core.Certificate.CRT",method:"list",version:1},interval:3,immediate:!0,status_callback:function(t,i,s,n){(t||i.code)&&(i.code&&e.getMsgBox().alert(_T("tree","leaf_service"),SYNO.SDS.AdminCenter.Security.Certificate.Err2Msg(i.code)),e.pollUnreg(e.register_id),e.clearStatusBusy(),e.close())}})}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.Config.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){var t,i=[];this.owner=e.owner,this.module=e.module,this.certificates=e.certificates,this.mappingPanel=new SYNO.SDS.AdminCenter.Security.Certificate.MappingConfigPanel({module:e.module,owner:this.owner,itemId:"mappingPanel",certificates:e.certificates}),i.push(this.mappingPanel),this.advancedPanel=new SYNO.SDS.AdminCenter.Security.Certificate.Config.AdvancedPanel({module:e.module,owner:this.owner,itemId:"advancedPanel"}),i.push(this.advancedPanel),t=Ext.apply({activeTab:0,applyDirtyOnly:!0,loadDirtyOnly:!0,items:i},e),this.callParent([t])}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.Config.AdvancedPanel",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t=Ext.apply({title:_T("common","advanced"),items:[{xtype:"syno_fieldset",title:_T("certificate","title_csr"),items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("certificate","create_csr_desc")},{xtype:"syno_button",text:_T("certificate","create_csr"),handler:this.onClickCreateCSR,scope:this}]},{xtype:"syno_fieldset",title:_T("certificate","title_reset"),items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("certificate","reset_cert_desc")},{xtype:"syno_button",text:_T("certificate","btn_reset"),handler:this.onClickReset,scope:this}]}]},e);this.callParent([t])},onClickCreateCSR:function(){this.sendWebAPI({webapi:{api:"SYNO.Core.Certificate.CRT",method:"list",version:1},callback:function(e,t){e&&new SYNO.SDS.AdminCenter.Security.Certificate.CsrWizard({owner:this.owner,module:this.module,crts:t.certificates}).open()},scope:this})},onClickReset:function(){var e=this;this.owner.getMsgBox().confirmDelete("",_T("certificate","confirm_reset"),(function(t){"yes"==t&&(e.owner.setStatusBusy(),e.sendWebAPI({webapi:{api:"SYNO.Core.Certificate",method:"reset",version:1,params:{}},scope:e,callback:function(t,i){var s=_T("common","error_system");if(e.owner.clearStatusBusy(),!t)return s=SYNO.API.getErrorString(i),e.owner.getMsgBox().alert(_T("tree","leaf_notification"),s),!1;i.restart_httpd&&(e.owner.setStatusBusy({text:_T("service","restart_apache")}),e.owner.checkProgress.defer(3e4,this.owner))}}))}),this,{yes:{text:Ext.MessageBox.buttonText.yes,btnStyle:"red"},no:{text:Ext.MessageBox.buttonText.no}})}}),Ext.namespace("SYNO.SDS.AdminCenter.Security.Certificate"),SYNO.SDS.AdminCenter.Security.Certificate.Err2Msg=function(e){return SYNO.API.getErrorString(e)},Ext.define("SYNO.SDS.AdminCenter.Security.CertificateTab",{extend:"SYNO.ux.Panel",itemId:"certificate",constructor:function(e){var t,i=this;i.owner=e.owner,i.appWin=e.appWin,i.store=i.getStore(),t=i.getConfig(e),Ext.apply(t,e),i.callParent([t])},initComponent:function(){var e=this;e.mon(e,"activate",e.onActivate,e),e.mon(e.store,"beforeload",(function(e,t){e.sort([{field:"is_default",direction:"DESC"},{field:"till_time",direction:"ASC"}],"ASC")}),e),e.callParent(arguments)},getConfig:function(e){var t,i=this;return i.createActions(),i.view=new SYNO.SDS.AdminCenter.Security.Certificate.ListView({owner:i,appWin:i.appWin,multiSelect:!1,singleSelect:!0,store:i.store,listeners:{selectionchange:i.onSelectChange,scope:i}}),i.view.mon(i.view,"containercontextmenu",i.onContainerContextMenu,i),i.view.mon(i.view,"contextmenu",i.onContextMenu,i),t={title:_T("certificate","certificate"),layout:"fit",tbar:new Ext.Toolbar({defaultType:"syno_button",style:{paddingBottom:"8px"},items:i.toolbar_actions}),items:i.view},Ext.apply(t,e),t},createActions:function(){this.actionItems=[new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",scope:this,handler:this.onEdit}),new Ext.Action({text:_T("common","delete"),itemId:"delete",scope:this,handler:this.onDelete}),new Ext.Action({text:_T("certificate","renew_crt"),itemId:"renew",scope:this,handler:this.onRenew}),new Ext.Action({text:_T("certificate","export_crt"),itemId:"export",scope:this,handler:this.onExport})];var e=new SYNO.ux.Button({itemId:"certificate",text:_T("common","add"),handler:this.onAddCrt,scope:this}),t=new SYNO.ux.Button({text:_T("common","action"),scope:this,itemId:"action",menu:{items:this.actionItems}}),i=new SYNO.ux.Button({itemId:"config",text:_T("common","common_settings"),handler:this.onConfig,scope:this});this.toolbar_actions=[e,t,i]},setActions:function(){this.toolbar_actions.forEach(function(e){this.setBtn(e,!0)}.bind(this)),this.actionItems.forEach(function(e){this.setBtn(e,!0)}.bind(this))},setBtn:function(e,t){t?e.enable():e.disable()},getStore:function(){var e=this;return new SYNO.API.JsonStore({appWindow:e.appWin,scope:e,api:"SYNO.Core.Certificate.CRT",method:"list",version:1,remoteSort:!1,totalProperty:"total",root:"certificates",idProperty:"id",defaultSortable:!0,fields:[{name:"iconCls",convert:e.iconClsRenderer},{name:"statusIconCls",convert:e.statusIconClsRenderer},{name:"displayDesc",convert:e.descRenderer},{name:"validDate",convert:e.validDateRenderer},{name:"cert_status",convert:e.certStatusRenderer},{name:"commonName",convert:e.commonNameRenderer},{name:"issuerDisplayName",convert:e.issuerRenderer},{name:"san",convert:e.sanRenderer},{name:"user",convert:e.userRenderer},{name:"warn",convert:function(t,i){return e.warnRenderer(t,i)}},{name:"till_time",convert:e.tillTimeRenderer},"id","desc","is_default","key_types","services","valid_from","valid_till","signature_algorithm","subject","issuer","renewable","user_deletable","self_signed_cacrt_info"],listeners:{load:{fn:function(){e.appWin.clearStatus(),0<e.store.getCount()&&0===e.view.getSelectedItemIds().length&&e.view.select(0,!0,!0),e.onSelectChange()}},exception:{fn:function(t,i,s,n,o,a){e.appWin.getMsgBox().alert("",SYNO.API.getErrorString(o.code),null,{useHtml:!0}),e.appWin.clearStatus()}}}})},iconClsRenderer:function(e,t){var i=new Date;return 0>=new Date(t.valid_till).getTime()-i.getTime()||t.is_broken?"cert-other-expire":"cert-other"},statusIconClsRenderer:function(e,t){var i=new Date;return 0>=new Date(t.valid_till).getTime()-i.getTime()||t.is_broken?"cert-expired":"cert-valid"},descRenderer:function(e,t){var i=Ext.util.Format.htmlEncode(t.desc);return t.key_types&&"RSA"!=t.key_types&&(i=String.format("({1}) {0}",i,t.key_types)),t.is_default&&(i=String.format("({1}) {0}",i,_T("certificate","def_crt"))),i},validDateRenderer:function(e,t){var i=new Date,s=new Date(t.valid_till),n=SYNO.SDS.DateTimeFormatter(s,{type:"date"});return 2592e6<s.getTime()-i.getTime()?'<font class="green-status">'+n+"</font>":0<s.getTime()-i.getTime()?'<font class="orange-status">'+n+"</font>":'<font class="red-status">'+_T("certificate","expired")+"</font>"},certStatusRenderer:function(e,t){return t.is_broken?' - <font class="red-status">'+_T("error","error_error")+"</font>":""},commonNameRenderer:function(e,t){return t.subject?t.subject.common_name:""},issuerRenderer:function(e,t){var i=t.issuer?t.issuer.common_name:"";return t.self_signed_cacrt_info&&(i=String.format("{0} ({1})",i,_T("certificate","self_signed_crt"))),i},sanRenderer:function(e,t){var i,s=[];for(i=0;i<t.subject.sub_alt_name.length;i++)s.push(t.subject.sub_alt_name[i]);return 0===s.length?"-":s.join(", ")},userRenderer:function(e,t){var i,s,n,o=[],a="";for(i=0;i<t.services.length;i++)a="",(n=t.services[i]).display_name_i18n&&(2===(s=n.display_name_i18n.split(":")).length?a=_T(s[0],s[1])?_T(s[0],s[1]):_JSLIBSTR(s[0],s[1]):3===s.length&&(a=_TT(s[0],s[1],s[2]))),a=a||n.display_name,o.push(a);return 0===o.length?"-":o.join(", ")},tillTimeRenderer:function(e,t){return new Date(t.valid_till).getTime()},warnRenderer:function(e,t){var i=this,s=Ext.id();return"sha1WithRSAEncryption"===t.signature_algorithm&&t.self_signed_cacrt_info&&_S("version")>5545?(i.mon(i.store,"load",(function(){var e=Ext.fly(s);i.mon(e,"click",i.recreateCRT,i)}),i,{single:!0}),_T("certificate","warning_sha1_crt")+" "+String.format('&nbsp<a class="link-font" id="{0}" href="#" crt_id={2}>{1}</a>',s,_T("certificate","fast_recreate_crt"),t.id)):""},recreateCRT:function(e,t){var i=this,s=new Ext.Element(t).getAttribute("crt_id");i.appWin.setStatusBusy(null,_T("certificate","creating_crt")),i.sendWebAPI({webapi:{api:"SYNO.Core.Certificate.CRT",method:"recreate",version:1,params:{id:s}},scope:i,callback:function(e,t){var s=_T("common","error_system");if(i.appWin.clearStatus(),!e)return s=SYNO.API.getErrorString(t),i.appWin.getMsgBox().alert(_T("tree","leaf_notification"),s),!1;t.restart_httpd?(i.appWin.setStatusBusy(null,_T("service","restart_apache")),i.checkProgress.defer(3e4,this)):i.store.load()}})},checkProgress:function(){var e=this;"https:"===location.protocol&&location.reload(),e.register_id=e.appWin.pollReg({webapi:{api:"SYNO.Core.Certificate.CRT",method:"list",version:1},interval:3,immediate:!0,status_callback:function(t,i,s,n){(t||i.code)&&(i.code&&e.appWin.getMsgBox().alert(_T("tree","leaf_service"),SYNO.SDS.AdminCenter.Security.Certificate.Err2Msg(i.code)),e.appWin.pollUnreg(e.register_id),e.store.load(),e.appWin.clearStatus())}})},onActivate:function(){this.appWin.setStatusBusy(),this.store.load()},onSelectChange:function(){var e=this.view.getSelectedRecords(),t=!0;this.setBtn(this.toolbar_actions[1].menu.getComponent("delete"),!1),0!==e.length&&(t=t&&!e[0].get("is_default")&&e[0].get("user_deletable"),this.setBtn(this.toolbar_actions[1].menu.getComponent("delete"),t))},onContainerContextMenu:function(e,t){var i=this,s=i.view.getSelectedIndexes(),n=i.view.getSelectedNodes();i.onContextMenu(e,s[0],n[0],t)},onContextMenu:function(e,t,i,s){var n,o=this,a=o.view.getSelectedRecords();n=new SYNO.ux.Menu({autoDestroy:!0,items:o.actionItems}),0!==a.length&&!a[0].get("is_default")&&a[0].get("user_deletable")||o.setBtn(n.getComponent("delete"),!1),n.showAt(s.getXY()),s.preventDefault()},loadCrts:function(e){e&&this.sendWebAPI({webapi:{api:"SYNO.Core.Certificate.CRT",method:"list",version:1},callback:function(t,i){t&&e(i.certificates)}})},onAddCrt:function(){var e,t=this;t.loadCrts((function(i){e=new SYNO.SDS.AdminCenter.Security.Certificate.AddCrtWizard({owner:t.appWin,module:t.module,certificates:i}),t.mon(e,"close",t.onActivate,t,{single:!0}),e.open()}))},onDelete:function(){var e=this,t=e.view.getSelectedItemIds();0!==t.length&&e.appWin.getMsgBox().confirmDelete(_T("certificate","certificate"),_T("certificate","confirm_del_crt")).then((i=>{"confirm"===i&&e.deleteCrt(t)}))},onEdit:function(){var e,t=this,i=t.view.getSelectedRecords();0!==i.length&&(e=new SYNO.SDS.AdminCenter.Security.Certificate.EditDialog({owner:t.appWin,module:t.module,cert:i[0].data}),t.mon(e,"close",t.onActivate,t,{single:!0}),e.open())},onConfig:function(){var e,t=this;t.sendWebAPI({webapi:{api:"SYNO.Core.Certificate.CRT",method:"list",version:1},scope:t,callback:function(i,s){e=new SYNO.SDS.AdminCenter.Security.Certificate.Config.Dialog({owner:t.appWin,module:t.module,certificates:i?s.certificates:[]}),t.mon(e,"close",t.onActivate,t,{single:!0}),e.open()}})},deleteCrt:function(e){var t=this;t.appWin.setStatusBusy(),t.sendWebAPI({webapi:{api:"SYNO.Core.Certificate.CRT",method:"delete",version:1,params:{ids:e}},scope:t,callback:function(e,i){var s=_T("common","error_system");if(t.appWin.clearStatus(),!e)return s=SYNO.API.getErrorString(i),t.appWin.getMsgBox().alert(_T("tree","leaf_notification"),s),!1;i.restart_httpd?(t.appWin.setStatusBusy(null,_T("service","restart_apache")),t.checkProgress.defer(3e4,this)):t.store.load()}})},onRenew:function(){var e=this.view.getSelectedRecords();if(0!==e.length){var t=e[0].data;t.renewable||t.self_signed_cacrt_info?this.module.appWin.getMsgBox().confirm("",_T("certificate","renew_letsencrypt_requirement"),{confirm:{text:_T("certificate","renew_crt")},cancel:{text:_T("common","cancel")}},{useHtml:!0}).then((e=>{"confirm"==e&&this.renewCertificate(t)})):this.module.appWin.getMsgBox().confirm("",_T("certificate","renew_crt_desc"),{confirm:{text:_T("certificate","renew_crt")},cancel:{text:_T("common","cancel")}}).then((e=>{"confirm"==e&&this.genRenewCsr(t.id)}))}},onExport:function(){var e=this.view.getSelectedRecords();0!==e.length&&synowebapi.download({api:"SYNO.Core.Certificate",version:1,method:"export",params:{id:e[0].data.id,file:"archive"}})},renewCertificate:function(e){this.appWin.setStatusBusy(null,_T("common","msg_waiting"));var t={"TrustAsia Technologies, Inc.":{api:"SYNO.Core.Certificate.Tencent",name:_T("service","service_ddns_provider_tencent_cloud")},"Let's Encrypt":{api:"SYNO.Core.Certificate.LetsEncrypt",name:"Let's Encrypt"}}[e.issuer.organization],i=t?t.api:"SYNO.Core.Certificate.CRT",s=t?t.name:_T("certificate","certificate");this.sendWebAPI({api:i,method:"renew",version:1,params:{id:e.id,force:!0},timeout:36e4,scope:this,callback:function(e,t){var i=_T("common","error_system");if(this.appWin.clearStatus(),!e)return i=Ext.isObject(t)&&504===t.status?String.format(_T("common","operations_error"),s):SYNO.API.getErrorString(t),this.appWin.getMsgBox().alert(_T("tree","leaf_notification"),i),!1;t.restart_httpd&&(this.appWin.setStatusBusy(null,_T("service","restart_apache")),this.checkProgress.defer(3e4,this))}})},genRenewCsr:function(e){this.appWin.setStatusBusy(null,_T("certificate","creating_csr")),SYNO.API.Request({api:"SYNO.Core.Certificate.CSR",method:"renew",version:"1",params:{id:e},callback:function(e,t,i){if(!e)return this.appWin.clearStatus(),void this.appWin.getMsgBox().alert(_T("tree","leaf_notification"),_T("common","error_system"));this.downloadCSR()},scope:this})},downloadCSR:function(){synowebapi.download({api:"SYNO.Core.Certificate",version:1,method:"export",params:{file:"csr_set"}}),this.appWin.clearStatus()}}),Ext.define("SYNO.SDS.AdminCenter.Security.Certificate.ListView",{extend:"SYNO.ux.ExpandableListView",constructor:function(e){var t;t={cls:"syno-certitficate-listview",innerTpl:this.getInnerTpl()},this.callParent([Ext.apply(t,e)])},createTpl:function(e){var t=this,i=e.toggleWrapCls||t.toggleWrapCls;return new Ext.XTemplate('<tpl for=".">','<div class="item-wrap {cls}" role="option" aria-expanded="false" id={[Ext.id()]} aria-label="{ariaInfo}">','<div class="item-summary">','<div class="item-icon {iconCls}"></div>','<div class="item-status-icon {statusIconCls}"></div>',"<div>",'<span class="item-title {titleCls}">{commonName}</span>','<span class=""> - {validDate}</span>','<span class="">{cert_status}</span>','<div class="item-status">{displayDesc}</div>',"</div>",t.innerTpl?'<div class="'+i+'"><div class="item-toggle-img"></div></div>':"","</div>",'<div class="item-detail" style="display:none">',t.innerTpl?t.innerTpl.html:"","</div>","</div>","</tpl>",'<div class="x-clear"></div>')},getInnerTpl:function(){return new Ext.XTemplate('<tpl for=".">',"<dl>",'<dt class="cert-prop cert-prop-name">',_T("certificate","issuer")+_T("common","colon"),"</dt>",'<dt class="cert-prop cert-prop-value">{issuerDisplayName}</dt>',"</dl>",'<div class="x-clear"></div>',"<dl>",'<dt class="cert-prop cert-prop-name">',_T("certificate","alias")+_T("common","colon"),"</dt>",'<dt class="cert-prop cert-prop-value">{san}</dt>',"</dl>",'<div class="x-clear"></div>',"<dl>",'<dt class="cert-prop cert-prop-name">',_T("certificate","used_by")+_T("common","colon"),"</dt>",'<dt class="cert-prop cert-prop-value">{user}</dt>',"</dl>",'<div class="x-clear"></div>',"<tpl if=\"warn != ''\">","<dl>",'<dt class="cert-prop cert-prop-name">',_T("common","recommend")+_T("common","colon"),"</dt>",'<dt class="cert-prop cert-prop-value">{warn}</dt>',"</dl>",'<div class="x-clear"></div>',"</tpl>","</tpl>")}}),Ext.define("SYNO.SDS.AdminCenter.Security.TLSService.MappingConfigDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t;this.owner=e.owner,this.module=e.module;var i=[];this.prepareData(e.services,i),this.gridStore=new Ext.data.JsonStore({fields:["service","serviceName","profile_level"],autoDestroy:!0}),this.gridStore.loadData(i),t={title:_T("tls_profile","customize_setting"),layout:"fit",width:600,height:400,items:new SYNO.ux.EditorGridPanel({ds:this.gridStore,clicksToEdit:1,enableColumnMove:!1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),columns:[{header:_T("tls_profile","services"),dataIndex:"serviceName",width:200,sortable:!1},{header:_T("tls_profile","profile_level"),dataIndex:"profile_level",width:200,editor:this.crtEditor=new SYNO.SDS.AdminCenter.Security.TLSService.TLSProfileComboBox({name:"profile-level",displayField:"profile_level_string",valueField:"profile_level",hideLabel:!0,editable:!1,mode:"local"}),renderer:function(e,t,i){return Ext.util.Format.htmlEncode(this.getEditor().store.getById(e).get("profile_level_string"))}}]}),buttons:[{btnStyle:"grey",text:_T("common","cancel"),handler:this.close,scope:this},{btnStyle:"blue",text:_T("common","apply"),handler:this.onSave,scope:this}],listeners:{beforeclose:this.onBeforeClose.createDelegate(this)}},Ext.apply(t,e),this.callParent([t])},onOpen:function(){var e={data:[{profile_level:0,profile_level_string:_T("tls_profile","default_profile")},{profile_level:1,profile_level_string:_T("tls_profile","modern")},{profile_level:2,profile_level_string:_T("tls_profile","intermediate")},{profile_level:3,profile_level_string:_T("tls_profile","old")}]};this.crtEditor.getStore().loadData(e),this.callParent(arguments)},onSave:async function(){for(var e=!1,t=0;t<this.gridStore.getCount();t++){var i=this.gridStore.getAt(t);i.dirty&&(1===i.get("profile_level")&&(e=!0))}if(e){var s=this;const e=Ext.id();var n=String.format(_T("tls_profile","notify_modern_level"),'<a id="'+e+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</a>"),o=0;o=setTimeout((function(){const t=Ext.get(e);void 0!==t&&(s.mon(t,"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_security_advanced.html"},!1)})),clearTimeout(o))}),200),s.module.appWin.getMsgBox().alert("",n,null,{useHtml:!0})}this.onApply()},onApply:function(){var e,t,i=[];for(e=0;e<this.gridStore.getCount();e++)(t=this.gridStore.getAt(e)).dirty&&i.push({service:t.get("service"),"current-level":t.get("profile_level")});0!==i.length?(this.setStatusBusy({text:_T("common","msg_waiting")}),this.sendWebAPI({api:"SYNO.Core.Web.Security.TLSProfile",method:"set",version:1,params:{services:i},scope:this,callback:function(e,t){var i=_T("common","error_system");if(this.clearStatusBusy(),!e)return i=SYNO.API.getErrorString(t),this.getMsgBox().alert(_T("tree","leaf_notification"),i),!1;this.gridStore.commitChanges(),this.close()}})):this.close()},onBeforeClose:function(){if(0<this.gridStore.getModifiedRecords().length)return this.confirmLostChangePromise({save:this.onSave,dontSave:function(){this.gridStore.rejectChanges(),this.close()},cancel:Ext.emptyFn},this),!1},prepareData:function(e,t){for(var i in e)if(e.hasOwnProperty(i)){var s,n=e[i],o="",a=n["current-level"];n["display-name-i18n"]?2===(s=n["display-name-i18n"].split(":")).length?o=0===_T(s[0],s[1]).length?_JSLIBSTR(s[0],s[1]):_T(s[0],s[1]):3===s.length&&(o=_TT(s[0],s[1],s[2])):o=n["display-name"],t.push({service:i,serviceName:o,profile_level:a})}t.sort((function(e,t){return e.serviceName<t.serviceName}))}}),Ext.define("SYNO.SDS.AdminCenter.Security.TLSService.TLSProfileComboBox",{extend:"SYNO.ux.ComboBox",constructor:function(e){var t;t={tpl:new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" style="height:26px"">','<div ext:qtip="{values.profile_level_string:htmlEncode}">{values.profile_level_string}</div>',"</div>","</tpl>"),store:new Ext.data.JsonStore({autoDestroy:!0,idProperty:"profile_level",root:"data",fields:["profile_level","profile_level_string"]})},Ext.apply(t,e),this.callParent([t])}}),Ext.namespace("SYNO.SDS.AdminCenter.Security.AdvancedTab"),Ext.define("SYNO.SDS.AdminCenter.Security.AdvancedTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.confirmSetMitigation=!1,this.mitigationModified=!1,this.rebootLaterChecked=!1,this.currentMitigationStatus=!1,this.callParent([t]),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("default-level").getEl(),_T("tls_profile","incompatible_client_for_modern"))}),this,{single:!0})},fillConfig:function(e){var t={title:_T("common","advanced"),forceLayout:!0,autoScroll:!0,items:[this.createHTTPCompressionItems(),this.createTLSProfileItems()]};return"yes"===_D("support_spectre_meltdown_mitigation","no")&&t.items.push(this.createSpecreMeltdownItems()),Ext.apply(t,e),t},createHTTPCompressionItems:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("http_compression","description")}),e.push({xtype:"syno_checkbox",name:"http_compression",boxLabel:_T("http_compression","enable"),"aria-label":_T("http_compression","enable")}),{xtype:"syno_fieldset",title:_T("http_compression","title"),collapsible:!1,webapi:{api:"SYNO.Core.Web.Security.HTTPCompression",methods:{get:"get",set:"set"},version:1},items:e}},createTLSProfileItems:function(){var e=[];return e.push({xtype:"syno_displayfield",htmlEncode:!1,value:String.format(_T("tls_profile","description"),'<a id="'+(this.string_description_id=Ext.id())+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</a>"),listeners:{afterrender:function(e){this.mon(Ext.get(this.string_description_id),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_security_advanced.html"},!1)}))},scope:this},reset:Ext.emptyFn}),e.push({xtype:"syno_radio",name:"default-level",inputValue:1,boxLabel:_T("tls_profile","modern"),"aria-label":_T("tls_profile","modern")+" "+_T("tls_profile","modern_desc"),handler:function(e,t){if(t&&this.owner.activeTab===this){var i=this;const e=Ext.id(),t=String.format(_T("tls_profile","notify_modern_level"),'<a id="'+e+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</a>");var s=0;s=setTimeout((function(){const t=Ext.get(e);void 0!==t&&(i.mon(t,"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_security_advanced.html"},!1)})),clearTimeout(s))}),200),i.appWin.getMsgBox().alert("",t,null,{useHtml:!0})}}.bind(this)}),e.push({xtype:"syno_displayfield",indent:1,value:_T("tls_profile","modern_desc"),tabIndex:-1}),e.push({xtype:"syno_radio",name:"default-level",inputValue:2,boxLabel:_T("tls_profile","intermediate"),"aria-label":_T("tls_profile","intermediate")+" "+_T("tls_profile","intermediate_desc")}),e.push({xtype:"syno_displayfield",indent:1,value:_T("tls_profile","intermediate_desc"),tabIndex:-1}),e.push({xtype:"syno_radio",name:"default-level",inputValue:3,boxLabel:_T("tls_profile","old"),"aria-label":_T("tls_profile","old")+" "+_T("tls_profile","old_desc")}),e.push({xtype:"syno_displayfield",indent:1,value:_T("tls_profile","old_desc"),tabIndex:-1}),e.push({xtype:"syno_button",text:_T("tls_profile","customize_setting"),scope:this,handler:this.onTLSAdvancedButtonClick}),{xtype:"syno_fieldset",title:_T("tls_profile","title"),collapsible:!1,webapi:{api:"SYNO.Core.Web.Security.TLSProfile",methods:{get:"get",set:"set"},version:1},items:e}},onTLSAdvancedButtonClick:function(){this.sendWebAPI({api:"SYNO.Core.Web.Security.TLSProfile",method:"get",version:1,scope:this,callback:function(e,t){var i=_T("common","error_system");if(this.appWin.clearStatusBusy(),!e)return i=SYNO.API.getErrorString(t),this.getMsgBox().alert(_T("tree","leaf_notification"),i),!1;new SYNO.SDS.AdminCenter.Security.TLSService.MappingConfigDialog({owner:this.appWin,module:this.module,services:t.services}).open()}})},createSpecreMeltdownItems:function(){var e,t,i,s,n=[],o='<a href="https://www.synology.com/support/security/Synology_SA_18_01" target="_blank">',a="</a>",r='<font class="note-font">',l="</font>";return"yes"===_D("support_spectre_meltdown_mitigation_full","no")?(e=_T("spectre_meltdown_mitigation","enable_for_LK4.4_model"),t=_T("spectre_meltdown_mitigation","enable_for_LK4.4_model"),i=_T("spectre_meltdown_mitigation","title_for_LK4.4"),s=String.format(_T("spectre_meltdown_mitigation","description_for_LK4.4_model"),r,l,o,a)):(e=_T("spectre_meltdown_mitigation","enable"),t=_T("spectre_meltdown_mitigation","enable"),i=_T("spectre_meltdown_mitigation","title"),s=String.format(_T("spectre_meltdown_mitigation","description_for_LK3.10_model"),r,l,o,a)),n.push({xtype:"syno_checkbox",name:"enable_spectre_meltdown_mitigation",boxLabel:e,"aria-label":t}),n.push({xtype:"syno_displayfield",value:s,htmlEncode:!1}),{xtype:"syno_fieldset",title:i,collapsible:!1,webapi:{api:!0===_S("ha_running")?"SYNO.SHA.Hardware.SpectreMeltdown":"SYNO.Core.Hardware.SpectreMeltdown",methods:{get:"get",set:"set"},version:1},items:n}},processParams:function(e,t){return"get"===e?this.callParent(arguments):(t.services={},t)},onBeforeRequest:function(e){if("get"===e)return!0;if("yes"===_D("support_spectre_meltdown_mitigation","no")){var t=this.getForm().findField("enable_spectre_meltdown_mitigation");if(!this.confirmSetMitigation&&t.isDirty()){SYNO.Debug("enable_spectre_meltdown_mitigation changed");var i=!0===_S("ha_running")?SYNO.SDS.HA.T("ui","confirm_reboot_cluster"):_T("spectre_meltdown_mitigation","confirm_reboot");return this.module.appWin.getMsgBox().confirm(this.title,i).then((e=>{"confirm"===e?(this.confirmSetMitigation=!0,this.module.panel.applyAllForm(),this.mitigationModified=!0,this.rebootLaterChecked=!1,this.currentMitigationStatus=t.getValue(),this.confirmSetMitigation=!1):t.reset()})),!1}}return!0},checkHA:function(e){var t=e.find((function(e){return!0===SYNO.ux.Utils.checkApiConsistency({api:"SYNO.SHA.Hardware.SpectreMeltdown",method:"set",version:1},e)}));if(t)if(t.data&&!1===t.data.success){if(Ext.isArray(t.data.errinfo)&&0!==t.data.errinfo.length)return this.owner.setStatusError({text:_T("error","error_invalid"),clear:!0}),void SYNO.SDS.HA.ShowErrMsg(this.owner,t.data.errinfo,_T("error","error_unknown"));this.owner.setStatusError({text:_T("error","error_unknown"),clear:!0})}else SYNO.SDS.HA.RebootHA(this);else this.owner.setStatusError({text:_T("error","error_unknown"),clear:!0})},processReturnData:function(e,t,i){var s=this.getForm(),n=s.findField("enable_spectre_meltdown_mitigation");i&&Ext.isArray(i.compound)&&s.loadRecords(t.result,i.compound),this.mitigationModified&&!this.rebootLaterChecked&&(SYNO.Debug("enable_spectre_meltdown_mitigation changed. Need to restart"),!0===_S("ha_hw_spectre_meltdown")?this.checkHA(t.result):"yes"===_D("support_dual_head")?SYNO.SDS.AppLaunch("SYNO.SDS.AHA.Instance",{action:"reboot_cluster"}):SYNO.SDS.System.RebootWithMsg(),this.rebootLaterChecked=!0),this.mitigationModified&&(n.setValue(this.currentMitigationStatus),n.originalValue=this.currentMitigationStatus)}}),Ext.namespace("SYNO.SDS.AdminCenter.Security.KMIP"),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.KmipEraseDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.parent=e.parent},fillConfig:function(e){var t={cls:"x-window-dlg",closable:!1,width:640,resizable:!1,draggable:!1,layout:"fit",elements:"body",padding:"24px 30px 0 30px",footerCfg:{style:"padding: 28px 30px 19px 30px;"},fbar:[{xtype:"syno_button",itemId:"cancel",text:_T("common","cancel"),scope:this,handler:function(){this.close()}},{xtype:"syno_button",itemId:"erase",text:_T("remote_key","dialog_erase_all_data_button"),scope:this,btnStyle:"red",handler:this.onClickErase}],items:[{xtype:"syno_formpanel",itemId:"deleteFormPanel",padding:"0px 0px 0px 0px",autoFlexcroll:!1,items:[{xtype:"syno_displayfield",name:"title",value:_T("remote_key","dialog_erase_all_data_title"),itemCls:"user-delete-message",htmlEncode:!1,style:{"padding-bottom":"12px","padding-top":"0px","font-size":"15px"}},{xtype:"syno_displayfield",value:_T("remote_key","dialog_erase_all_data_desc"),name:"dialog_erase_all_data_desc",style:{"padding-bottom":"0px","padding-top":"0px"}}]}]};return Ext.apply(t,e),t},onClickErase:function(){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.applyErase)},applyErase:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"erase_all_data",version:1,scope:this,params:{},callback:function(e,t,i){if(!e){this.clearStatusBusy();var s=_T("common","error_system");return t.result[1].error&&(s=SYNO.API.Errors.core[t.result[1].error.code]||_T("common","error_system")),this.getMsgBox().alert(this.title,s,(function(){this.close()}),this),this.setStatusError({text:s,clear:!0}),!1}return this.parent.getForm().findField("server_enable").setValue("false"),this.clearStatusBusy(),this.parent.appWin.getToastBox(_T("remote_key","erase_data_feedback")),this.owner.afterEraseDone(),this.close(),!0}})}}),Ext.namespace("SYNO.SDS.AdminCenter.Security.KMIP"),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.KmipManageWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.KmipInfo=e.KmipInfo,this.module=e.module,this.panel=this.createTabPanel();var t=Ext.apply({title:_T("remote_key","server_conn_of_client_title"),width:800,height:518,layout:"fit",resizable:!0,buttons:[{btnStyle:"grey",text:_T("common","close"),scope:this,handler:function(){this.close()}}],items:[this.panel]},e);this.callParent([t]),this.mon(this,"afterlayout",(function(){this.panel.strip.setVisibilityMode(Ext.Element.DISPLAY),this.panel.strip.setVisible(!1)}),this,{single:!0})},createTabPanel:function(){var e;return this.certificatePanel=new SYNO.SDS.AdminCenter.Security.KMIP.KmipCertificateTab({module:this.module,owner:this,itemId:"trustedCertTab"}),e={activeTab:0,plain:!0,defaults:{height:640},style:{paddingTop:"0px"},bodyStyle:{paddingTop:"0px"},useDefaultBtn:!1,items:[this.certificatePanel]},new SYNO.SDS.Utils.TabPanel(e)}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.KmipCertificateTab",{extend:"SYNO.ux.Panel",itemId:"certificate",constructor:function(e){var t,i=this;i.appWin=e.module.appWin,i.store=i.getStore(),t=i.getConfig(e),Ext.apply(t,e),i.callParent([t])},initComponent:function(){var e=this;e.mon(e,"activate",e.onActivate,e),e.mon(e.store,"beforeload",(function(e,t){e.sort([{field:"till_time",direction:"ASC"}],"ASC")}),e),e.callParent(arguments),e.setBtn(this.toolbar_actions[1],!1),e.setBtn(this.toolbar_actions[2],!1)},getConfig:function(e){var t,i=this;return i.createActions(),i.view=new SYNO.SDS.AdminCenter.Security.KMIP.ListView({owner:i,appWin:i.appWin,multiSelect:!1,singleSelect:!0,store:i.store,listeners:{selectionchange:i.onSelectChange,scope:i}}),t={title:_T("certificate","certificate"),layout:"fit",tbar:new Ext.Toolbar({defaultType:"syno_button",style:{paddingTop:"0px",paddingBottom:"8px"},items:i.toolbar_actions}),style:{paddingTop:"0px"},items:i.view},Ext.apply(t,e),t},createActions:function(){var e=new SYNO.ux.Button({itemId:"certificate",text:_T("common","add"),scope:this,handler:this.onAddCrt}),t=new SYNO.ux.Button({itemId:"edit",text:_T("common","alt_edit"),scope:this,handler:this.onEdit}),i=new SYNO.ux.Button({itemId:"delete",text:_T("common","delete"),scope:this,handler:this.onDelete});this.toolbar_actions=[e,t,i]},getStore:function(){var e=this;return new SYNO.API.JsonStore({appWindow:e.appWin,scope:e,api:"SYNO.Storage.CGI.KMIP",method:"list_cert",version:1,remoteSort:!1,totalProperty:"total",root:"certificates",idProperty:"id",defaultSortable:!0,fields:[{name:"iconCls",convert:e.iconClsRenderer},{name:"statusIconCls",convert:e.statusIconClsRenderer},{name:"displayDesc",convert:e.descRenderer},{name:"validDate",convert:e.validDateRenderer},{name:"cert_status",convert:e.certStatusRenderer},{name:"commonName",convert:e.commonNameRenderer},{name:"issuerDisplayName",convert:e.issuerRenderer},{name:"warn",convert:function(t,i){return e.warnRenderer(t,i)}},{name:"till_time",convert:e.tillTimeRenderer},{name:"san",convert:e.sanRenderer},"id","desc","cn","granted","has_import_ca","issuer","not_valid_after","subject_alt"],listeners:{exception:{fn:function(t,i,s,n,o,a){e.appWin.getMsgBox().alert("warning_msg",SYNO.API.getErrorString(o.code)),e.appWin.clearStatus()}}}})},iconClsRenderer:function(e,t){var i=new Date;return 0>=new Date(t.not_valid_after).getTime()-i.getTime()||t.is_broken||!t.granted?"cert-other-expire":"cert-other"},statusIconClsRenderer:function(e,t){var i=new Date;return 0>=new Date(t.valid_till).getTime()-i.getTime()||t.is_broken||!t.granted?"cert-expired":"cert-valid"},descRenderer:function(e,t){return Ext.util.Format.htmlEncode(t.desc)},validDateRenderer:function(e,t){var i=new Date,s=new Date(t.not_valid_after),n=SYNO.SDS.DateTimeFormatter(s,{type:"date"});return t.granted?2592e6<s.getTime()-i.getTime()?'<font class="green-status">'+n+"</font>":0<s.getTime()-i.getTime()?'<font class="orange-status">'+n+"</font>":'<font class="red-status">'+_T("certificate","expired")+"</font>":'<font class="red-status">'+_T("remote_key","revoked")+"</font>"},certStatusRenderer:function(e,t){return t.is_broken?' - <font class="red-status">'+_T("error","error_error")+"</font>":""},commonNameRenderer:function(e,t){return t.cn},issuerRenderer:function(e,t){return t.issuer},sanRenderer:function(e,t){var i,s=[];for(i=0;i<t.subject_alt.length;i++)s.push(t.subject_alt[i]);return 0===s.length?"-":s.join(", ")},userRenderer:function(e,t){return"-"},tillTimeRenderer:function(e,t){return new Date(t.not_valid_after).getTime()},warnRenderer:function(e,t){var i=new Date;return 0>=new Date(t.not_valid_after).getTime()-i.getTime()?_T("remote_key","suggestion_renew"):""},onActivate:function(){this.store.load()},loadCrts:function(e){e&&this.sendWebAPI({webapi:{api:"SYNO.Storage.CGI.KMIP",method:"list_cert",version:1},callback:function(t,i){t&&e(i.certificates)}})},onAddCrt:function(){new SYNO.SDS.AdminCenter.Security.KMIP.AddCertWindow({owner:this.owner,module:this.module,parent:this}).open()},onDelete:function(){var e=this,t=e.view.getSelectedItemIds(),i="",s=t[0];if(0!==t.length){Ext.each(e.store.data.items,(function(e){e.data.id==s&&(i=e.data.cn)}));var n=_T("remote_key","dialog_delete_cert_title");n=n.replace("%certificate_name%",i),this.id_to_delete=s,e.owner.getMsgBox().confirmDelete(n,_T("remote_key","dialog_delete_cert_desc"),(function(t){"yes"===t&&SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,e.deleteCrt)}),this)}},onEdit:function(){var e=this.view.getSelectedRecords();new SYNO.SDS.AdminCenter.Security.KMIP.EditCertWindow({owner:this.owner,module:this.module,parent:this,cert_id:this.view.getSelectedItemIds(),desc:e[0].data.desc,granted:e[0].data.granted}).open()},setBtn:function(e,t){t?e.enable():e.disable()},onSelectChange:function(){0===this.view.getSelectedRecords().length?(this.setBtn(this.toolbar_actions[1],!1),this.setBtn(this.toolbar_actions[2],!1)):(this.setBtn(this.toolbar_actions[1],!0),this.setBtn(this.toolbar_actions[2],!0))},deleteCrt:function(){var e=this;e.appWin.setStatusBusy(),e.sendWebAPI({webapi:{api:"SYNO.Storage.CGI.KMIP",method:"remove_cert",version:1,params:{cert_id:this.id_to_delete}},scope:e,callback:function(t,i){var s=_T("common","error_system");e.appWin.clearStatus(),t||(s=SYNO.API.getErrorString(i),e.appWin.getMsgBox().alert(_T("tree","leaf_notification"),s)),e.store.load()}})}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.ListView",{extend:"SYNO.ux.ExpandableListView",constructor:function(e){var t;t={cls:"syno-certitficate-listview",innerTpl:this.getInnerTpl()},this.callParent([Ext.apply(t,e)])},createTpl:function(e){var t=this,i=e.toggleWrapCls||t.toggleWrapCls;return new Ext.XTemplate('<tpl for=".">','<div class="item-wrap {cls}" role="option" aria-expanded="false" id={[Ext.id()]} aria-label="{ariaInfo}">','<div class="item-summary">','<div class="item-icon {iconCls}"></div>','<div class="item-status-icon {statusIconCls}"></div>',"<div>",'<span class="item-title {titleCls}">{commonName}</span>','<span class=""> - {validDate}</span>','<span class="">{cert_status}</span>','<div class="item-status">{displayDesc}</div>',"</div>",t.innerTpl?'<div class="'+i+'"><div class="item-toggle-img"></div></div>':"","</div>",'<div class="item-detail" style="display:none">',t.innerTpl?t.innerTpl.html:"","</div>","</div>","</tpl>",'<div class="x-clear"></div>')},getInnerTpl:function(){return new Ext.XTemplate('<tpl for=".">',"<dl>",'<dt class="cert-prop cert-prop-name">',_T("certificate","issuer")+_T("common","colon"),"</dt>",'<dt class="cert-prop cert-prop-value">{issuerDisplayName}</dt>',"</dl>",'<div class="x-clear"></div>',"<dl>",'<dt class="cert-prop cert-prop-name">',_T("certificate","alias")+_T("common","colon"),"</dt>",'<dt class="cert-prop cert-prop-value">{san}</dt>',"</dl>",'<div class="x-clear"></div>',"<tpl if=\"warn != ''\">","<dl>",'<dt class="cert-prop cert-prop-name">',_T("remote_key","suggestion")+_T("common","colon"),"</dt>",'<dt class="cert-prop cert-prop-value">{warn}</dt>',"</dl>",'<div class="x-clear"></div>',"</tpl>","</tpl>")}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.AddCertWindow",{extend:"SYNO.SDS.ModalWindow",mainFileButtonID:null,constructor:function(e){this.uploadInfo=null,this.parent=e.parent;var t=Ext.apply({title:_T("remote_key","add_client_cert_title"),resizable:!1,border:!1,closable:!0,width:700,height:266,useStatusBar:!0,padding:"16px 20px 0px 20px",cls:"kmip-setting-dialog",items:this.getItems(),layout:{type:"vbox",align:"stretch"},buttons:[{text:_T("common","cancel"),scope:this,handler:function(){this.close()}},{text:_T("common","add"),scope:this,btnStyle:"blue",handler:this.onSubmit}]},e);this.callParent([t]),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.MainUploadForm.form.findField("ca_file").getEl(),_T("remote_key","ca_tips"))}),this,{single:!0})},getItems:function(){var e=[];return this.MainUploadForm=this.createMainUploadForm(),e.push(this.MainUploadForm),e},createMainUploadForm:function(){var e=260;return new SYNO.SDS.Utils.FormPanel({itemId:"upload_main",fileUpload:!0,trackResetOnLoad:!0,frame:!1,border:!1,labelWidth:200,cls:"kmip-form",padding:"0px",webapi:{api:"SYNO.Storage.CGI.KMIP",method:"import_cert",version:1},items:[{xtype:"syno_filebutton",labelHtmlEncode:!1,fieldLabel:_T("remote_key","client_cert")+" <font class='red-status'> *</font>",id:this.mainFileButtonID=Ext.id(),name:"cert_file",textConfig:{width:244},style:"margin-right: 0px !important"},{xtype:"syno_textfield",fieldLabel:_T("remote_key","desc_optional"),name:"cert_desc",width:e},{xtype:"syno_combobox",labelHtmlEncode:!1,fieldLabel:_T("remote_key","cert_status"),name:"cert_grant_status",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["granted",_T("remote_key","status_grant")],["revoked",_T("remote_key","status_revoke")]]}),value:"granted",valueField:"value",displayField:"display",width:e},{xtype:"syno_filebutton",fieldLabel:_T("remote_key","ca_optional"),id:this.mainFileButtonID=Ext.id(),name:"ca_file",itemId:"ca_file",textConfig:{width:244}}],onApiSuccess:Ext.createDelegate(this.onMainUploadSuccess,this),onApiFailure:Ext.createDelegate(this.onUploadFailed,this)})},onSubmit:function(){var e=this.get("upload_main");this.setStatusBusy(),e.upload()},onMainUploadSuccess:function(e,t,i){var s=this,n=new Date,o=new Date(t.not_valid_after);s.clearStatusBusy(),7776e6>o.getTime()-n.getTime()?s.getMsgBox().alert("",_T("remote_key","warn_cert_exp_date"),(function(){s.parent.store.load(),s.close()})):(s.parent.store.load(),s.close())},onUploadFailed:function(e,t,i){var s=this;s.clearStatusBusy(),s.getMsgBox().alert(_T("remote_key","dialog_invalid_cert"),_T("remote_key","dialog_invalid_cert"),(function(){s.close()}))}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.EditCertWindow",{extend:"SYNO.SDS.ModalWindow",mainFileButtonID:null,constructor:function(e){this.uploadInfo=null,this.parent=e.parent,this.cert_id=e.cert_id,this.orgDesc=e.desc,this.orgGranted=e.granted;var t=Ext.apply({title:_T("remote_key","edit_client_cert_title"),resizable:!1,closable:!0,width:700,height:266,useStatusBar:!0,padding:"16px 20px 0px 20px",cls:"kmip-setting-dialog",items:this.getItems(),layout:{type:"vbox",align:"stretch"},buttons:[{text:_T("common","cancel"),scope:this,handler:function(){this.close()}},{text:_T("common","ok"),scope:this,btnStyle:"blue",handler:this.onSubmit}]},e);this.callParent([t]),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.MainUploadForm.form.findField("ca_file").getEl(),_T("remote_key","ca_tips"))}),this,{single:!0}),0==this.orgGranted&&(this.MainUploadForm.getForm().findField("cert_grant_status").setValue("revoked"),this.MainUploadForm.getForm().findField("cert_grant_status").originalValue="revoked")},getItems:function(){var e=[];return this.MainUploadForm=this.createMainUploadForm(),e.push(this.MainUploadForm),e},createMainUploadForm:function(){var e=260;return new SYNO.SDS.Utils.FormPanel({itemId:"upload_main",fileUpload:!0,trackResetOnLoad:!0,frame:!1,border:!1,padding:"0px",cls:"kmip-form",labelWidth:200,webapi:{api:"SYNO.Storage.CGI.KMIP",method:"renew_cert",version:1},items:[{xtype:"syno_filebutton",labelHtmlEncode:!1,fieldLabel:_T("remote_key","update_client_cert"),id:this.mainFileButtonID=Ext.id(),name:"cert_file",textConfig:{width:244}},{xtype:"syno_textfield",fieldLabel:_T("remote_key","desc_optional"),name:"cert_desc",width:e,value:this.orgDesc},{xtype:"syno_combobox",labelHtmlEncode:!1,fieldLabel:_T("remote_key","cert_status"),name:"cert_grant_status",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["granted",_T("remote_key","status_grant")],["revoked",_T("remote_key","status_revoke")]]}),value:"granted",valueField:"value",displayField:"display",width:e},{xtype:"syno_filebutton",fieldLabel:_T("remote_key","ca_optional"),id:this.mainFileButtonID=Ext.id(),name:"ca_file",itemId:"ca_file",textConfig:{width:244}},{xtype:"hidden",name:"cert_id",value:""}],onApiSuccess:Ext.createDelegate(this.onMainUploadSuccess,this),onApiFailure:Ext.createDelegate(this.onUploadFailed,this)})},onSubmit:function(){var e=this.get("upload_main"),t={};this.needUpload=!1,(e.getForm().findField("cert_file").isDirty()||e.getForm().findField("ca_file").isDirty())&&(this.needUpload=!0),(e.getForm().findField("cert_desc").isDirty()||e.getForm().findField("cert_grant_status").isDirty())&&(t.cert_grant_status=e.getForm().findField("cert_grant_status").getValue(),t.cert_desc=e.getForm().findField("cert_desc").getValue(),t.cert_id=this.cert_id[0],this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"set_cert",version:1,params:t,scope:this,callback:this.setCertCallback})),this.needUpload&&(this.setStatusBusy(),e.webapi={api:"SYNO.Storage.CGI.KMIP",method:"renew_cert",version:1,param:{cert_id:this.cert_id[0]}},e.upload())},setCertCallback:function(e,t,i){e&&!this.needUpload&&(this.parent.store.load(),this.close())},onMainUploadSuccess:function(e,t,i){var s=this;s.clearStatusBusy(),s.parent.store.load(),s.close()},onUploadFailed:function(e,t,i){var s=this;s.clearStatusBusy(),s.getMsgBox().alert(_T("remote_key","dialog_invalid_cert"),_T("remote_key","dialog_invalid_cert"),(function(){s.close()}))}}),Ext.namespace("SYNO.SDS.AdminCenter.Security.KmipTab"),Ext.define("SYNO.SDS.AdminCenter.Security.KmipTab",{extend:"SYNO.SDS.Utils.FormPanel",webapi:{api:"SYNO.Storage.CGI.KMIP",methods:{get:"get",set:"set"},version:1},constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),this.KmipInfo=null,this.clientWindowShowed=!1,this.serverWindowShowed=!1,this.mon(this.getForm().findField("client_enable"),"check",this.onUIChange,this),this.mon(this.getForm().findField("server_enable"),"check",this.onUIChange,this)},fillConfig:function(e){var t={title:_T("remote_key","kmip_tab_title"),forceLayout:!0,autoScroll:!0,items:[this.fillKmipClientConfig(),this.fillKmipServerConfig()]};return Ext.apply(t,e),t},showClientEditServerWindow:function(e,t){new SYNO.SDS.AdminCenter.Security.KMIP.ClientEditServerWindow({appWin:this.module.appWin,owner:this.appWin,module:this,KmipInfo:this.KmipInfo,trigger:"button"}).show()},showClientEditServerWindowByCheckEnable:function(){new SYNO.SDS.AdminCenter.Security.KMIP.ClientEditServerWindow({appWin:this.module.appWin,owner:this.appWin,module:this,KmipInfo:this.KmipInfo,trigger:"enable"}).show()},showServerEditWindow:function(e,t){new SYNO.SDS.AdminCenter.Security.KMIP.ServerEditWindow({appWin:this.module.appWin,owner:this.appWin,module:this,KmipInfo:this.KmipInfo,trigger:"button"}).show()},showServerEditWindowByCheckEnable:function(){new SYNO.SDS.AdminCenter.Security.KMIP.ServerEditWindow({appWin:this.module.appWin,owner:this.appWin,module:this,KmipInfo:this.KmipInfo,trigger:"enable"}).show()},fillKmipClientConfig:function(){return this.clientEditServer=new SYNO.ux.Button({xtype:"syno_button",text:_T("remote_key","client_edit_server_button"),scope:this,indent:1,handler:this.showClientEditServerWindow,name:"edit_server_button"}),this.clientTestConn=new SYNO.ux.Button({xtype:"syno_button",text:_T("remote_key","client_test_conn_button"),scope:this,handler:this.onClickTestConnBtn,name:"test_conn_button"}),{xtype:"syno_fieldset",title:_T("remote_key","client_section_title"),itemId:"fieldset_client",collapsible:!0,labelWidth:240,items:[{xtype:"syno_displayfield",id:this.clientDescId=Ext.id(),value:String.format(_T("remote_key","client_section_desc"),'<a id="'+(this.clientLearnMoreStrId=Ext.id())+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</a>"),htmlEncode:!1,listeners:{afterrender:function(e){this.mon(Ext.get(this.clientLearnMoreStrId),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_security_kmip.html"},!1)}))},scope:this}},{xtype:"syno_checkbox",name:"client_enable",itemId:"client_enable",boxLabel:_T("remote_key","client_enable")},{xtype:"syno_displayfield",htmlEncode:!1,value:"<b>"+_T("remote_key","client_conn_server")+"</b>",indent:1,name:"client_conn_server"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","client_conn_server_name"),indent:1,name:"client_conn_server_ip",itemId:"client_conn_server_ip"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","client_conn_server_port"),indent:1,name:"kmip_conn_server_port_text",itemId:"kmip_conn_server_port_text"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","description"),indent:1,name:"server_description",itemId:"server_description"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","client_server_cert_validation"),indent:1,name:"server_cert_validation",itemId:"server_cert_validation",isDirty:function(){return!1},value:"-"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","client_client_cert_validation"),indent:1,name:"client_cert_validation",itemId:"client_cert_validation",isDirty:function(){return!1},value:"-"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","client_last_conn_status"),indent:1,htmlEncode:!1,name:"client_last_conn_status",isDirty:function(){return!1},value:"-"},this.clientEditServer,this.clientTestConn]}},fillKmipServerConfig:function(){return this.serverEdit=new SYNO.ux.Button({xtype:"syno_button",text:_T("remote_key","synology_key_server_setting_button"),scope:this,indent:1,name:"key_server_setting_button",handler:this.showServerEditWindow}),{xtype:"syno_fieldset",title:_T("remote_key","server_section_title"),itemId:"fieldset_server",collapsible:!0,labelWidth:240,items:[{xtype:"syno_displayfield",id:this.serverDescId=Ext.id(),value:String.format(_T("remote_key","server_section_desc"),'<a id="'+(this.serverLearnMoreStrId=Ext.id())+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">',"</a>"),htmlEncode:!1,listeners:{afterrender:function(e){this.mon(Ext.get(this.serverLearnMoreStrId),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_security_kmip.html"},!1)}))},scope:this}},{xtype:"syno_checkbox",name:"server_enable",itemId:"server_enable",boxLabel:_T("remote_key","server_enable")},{xtype:"syno_displayfield",indent:1,hidden:!0,name:"kmip_server_modified",itemId:"kmip_server_modified",value:""},this.serverEdit]}},processReturnData:function(e,t,i){this.processGetData(t,i),this.callParent(arguments)},setFieldAndOriginalValues:function(e,t){e.originalValue=t,e.setValue(t)},processGetData:function(e,t){for(var i={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},s=0;s<e.result.length;s++)if(!1!==SYNO.ux.Utils.checkApiConsistency(i,e.result[s]))return!1!==e.result[s].success&&e.result[s].data?(this.KmipInfo=e.result[s].data,void this.processUIwithData(e.result[s].data)):void SYNO.Debug.warn("KMIP processGetData fail")},validDateConverter:function(e){var t=new Date(e);return SYNO.SDS.DateTimeFormatter(t,{type:"date"})},processUIwithData:function(e){var t=this.getForm();this.clientWindowShowed=!1,this.serverWindowShowed=!1,"both"===e.kmip_mode?(this.KmipInfo.server_enable=!0,this.KmipInfo.client_enable=!0):"client"===e.kmip_mode?(this.KmipInfo.server_enable=!1,this.KmipInfo.client_enable=!0):"server"===e.kmip_mode?(this.KmipInfo.server_enable=!0,this.KmipInfo.client_enable=!1):(this.KmipInfo.server_enable=!1,this.KmipInfo.client_enable=!1),this.setFieldAndOriginalValues(t.findField("kmip_server_modified"),"false"),this.setFieldAndOriginalValues(t.findField("server_enable"),this.KmipInfo.server_enable),this.setFieldAndOriginalValues(t.findField("client_enable"),this.KmipInfo.client_enable),this.setFieldAndOriginalValues(t.findField("client_last_conn_status"),"-"),""===e.kmip_server?(this.setFieldAndOriginalValues(t.findField("client_conn_server_ip"),"-"),this.setFieldAndOriginalValues(t.findField("kmip_conn_server_port_text"),"-")):(this.setFieldAndOriginalValues(t.findField("kmip_conn_server_port_text"),e.kmip_conn_server_port),this.setFieldAndOriginalValues(t.findField("client_conn_server_ip"),e.kmip_server)),""===e.kmip_conn_server_desc?this.setFieldAndOriginalValues(t.findField("server_description"),"-"):this.setFieldAndOriginalValues(t.findField("server_description"),e.kmip_conn_server_desc),"both"===this.KmipInfo.kmip_mode||"client"===this.KmipInfo.kmip_mode?(this.setFieldAndOriginalValues(t.findField("client_enable"),!0),null!==e.client_cert_info&&this.setFieldAndOriginalValues(t.findField("client_cert_validation"),this.validDateConverter(e.client_cert_info.not_valid_after)),null!==e.server_cert_info&&this.setFieldAndOriginalValues(t.findField("server_cert_validation"),this.validDateConverter(e.server_cert_info.not_valid_after)),this.processConnStatus(e)):(this.setFieldAndOriginalValues(t.findField("client_enable"),!1),this.setFieldAndOriginalValues(t.findField("client_cert_validation"),"-"),this.setFieldAndOriginalValues(t.findField("server_cert_validation"),"-")),this.onUIChange()},processParams:function(e,t){return"set"===e&&(t=this.processSetParams(t)),t},processSetParams:function(e){for(var t=0;t<e.length;t++)"SYNO.Storage.CGI.KMIP"===e[t].api&&"set"===e[t].method&&(!0===e[t].params.client_enable&&!0===e[t].params.server_enable?e[t].params.kmip_mode="both":!0===e[t].params.client_enable?e[t].params.kmip_mode="client":!0===e[t].params.server_enable?e[t].params.kmip_mode="server":e[t].params.kmip_mode="none",e[t].params.client_enable||e[t].params.server_enable?e[t].params.kmip_enabled="yes":e[t].params.kmip_enabled="no",""===e[t].params.kmip_db_loc&&(e[t].params.kmip_db_loc="/etc/pykmip/pykmip.db"),e[t].params.client_enable&&(e[t].params.kmip_server=this.KmipInfo.kmip_server,e[t].params.kmip_conn_server_port=this.KmipInfo.kmip_conn_server_port,e[t].params.kmip_conn_server_desc=this.KmipInfo.kmip_conn_server_desc),e[t].params.server_enable&&(e[t].params.kmip_db_loc=this.KmipInfo.kmip_db_loc,e[t].params.kmip_server_port=this.KmipInfo.kmip_server_port));return e},processConnStatus:function(e){var t=this.getForm(),i="-";this.conn_success=e.conn_success,e.conn_success?(i="<font class='green-status'>Success on "+e.conn_time+"</font>",this.conn_msg="Success on "+e.conn_time):(i="<font class='red-status'>Failed on "+e.conn_time+"</font>",this.conn_msg="Failed on "+e.conn_time),this.setFieldAndOriginalValues(t.findField("client_last_conn_status"),i)},onClickTestConnBtn:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"test_conn",version:1,scope:this,params:{},callback:function(e,t,i){e&&this.processConnStatus(t)}})},checkDisableClient:function(e,t,i){e&&"remote"===t.loc_type&&(new SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog({owner:this.module.appWin,messages:_T("remote_key","warn_stop_remote_key_client")}).open(),this.KmipInfo.client_enable=!0,this.setFieldAndOriginalValues(this.getForm().findField("client_enable"),!0));this.clearStatusBusy()},onUIChange:function(){var e=this.getForm();null!==this.KmipInfo&&(this.KmipInfo.client_enable=this.getForm().findField("client_enable").getValue(),this.KmipInfo.server_enable=this.getForm().findField("server_enable").getValue(),this.getForm().findField("client_enable").isDirty()&&!this.getForm().findField("client_enable").getValue()&&(this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Storage.CGI.EncryptionKeyVault",method:"get_info",version:1,scope:this,params:{},callback:this.checkDisableClient})),this.getForm().findField("client_enable").isDirty()&&1==this.getForm().findField("client_enable").getValue()&&!this.clientWindowShowed&&(this.clientWindowShowed=!0,this.showClientEditServerWindowByCheckEnable()),this.getForm().findField("server_enable").isDirty()&&this.getForm().findField("server_enable").getValue()&&!this.serverWindowShowed&&this.sendWebAPI({api:"SYNO.Core.Storage.Volume",method:"list",params:{limit:-1,offset:0,location:"internal",option:"include_cold_storage"},version:1,timeout:36e4,scope:this,callback:function(e,t,i){0===t.total?this.appWin.getMsgBox().confirm("",_T("remote_key","dialog_no_volume")).then((e=>{"confirm"===e&&SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance"),this.getForm().findField("server_enable").setValue(!1)})):(this.serverWindowShowed=!0,this.showServerEditWindowByCheckEnable())}}),this.KmipInfo.client_enable?(e.findField("client_conn_server").enable(),e.findField("client_conn_server_ip").enable(),e.findField("kmip_conn_server_port_text").enable(),e.findField("server_description").enable(),this.enableConnStatus(),e.findField("client_cert_validation").enable(),e.findField("server_cert_validation").enable(),this.clientEditServer.enable(),this.clientTestConn.enable()):("-"===this.getForm().findField("client_conn_server_ip").getValue()&&this.setFieldAndOriginalValues(e.findField("kmip_conn_server_port_text"),"-"),e.findField("client_conn_server").disable(),e.findField("client_conn_server_ip").disable(),e.findField("kmip_conn_server_port_text").disable(),e.findField("server_description").disable(),e.findField("client_cert_validation").disable(),e.findField("server_cert_validation").disable(),this.disableConnStatus(),this.clientEditServer.disable(),this.clientTestConn.disable()),this.KmipInfo.server_enable?this.serverEdit.enable():this.serverEdit.disable())},enableConnStatus:function(){var e,t=this.getForm();e=this.conn_success?"<font class='green-status'>"+this.conn_msg+"</font>":"<font class='red-status'>"+this.conn_msg+"</font>",this.setFieldAndOriginalValues(t.findField("client_last_conn_status"),e),t.findField("client_last_conn_status").enable()},disableConnStatus:function(){var e=this.getForm();this.setFieldAndOriginalValues(e.findField("client_last_conn_status"),this.conn_msg),e.findField("client_last_conn_status").disable()},checkClientSettingValid:function(){if(this.getForm().findField("client_enable").getValue()){if(null===this.KmipInfo.kmip_server||""===this.KmipInfo.kmip_server)return!1;if(null===this.KmipInfo.kmip_conn_server_port||""===this.KmipInfo.kmip_conn_server_port)return!1}return!0},checkServerSettingValid:function(){if(this.getForm().findField("server_enable").getValue()){if(null===this.KmipInfo.kmip_db_loc||""===this.KmipInfo.kmip_db_loc)return!1;if(null===this.KmipInfo.kmip_server_port||""===this.KmipInfo.kmip_server_port)return!1}return!0},onBeforeRequest:function(e){return this.webapi.methods.set!==e||(!!this.disabled||(!(!this.checkClientSettingValid()||!this.checkServerSettingValid())||(this.module.panel.setStatusError({text:_T("common","forminvalid"),clear:!0}),this.module.panel.setActiveTab("KmipTab"),!1)))}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.ClientEditServerWindow",{extend:"SYNO.SDS.ModalWindow",mainFileButtonID:null,constructor:function(e){this.KmipInfo=e.KmipInfo,this.module=e.module,this.form=this.createForm(),this.connStatus=!1,this.loopStatus=!1,this.tmpKmipInfo=null,this.trigger=e.trigger,this.hasClientCA=!1,this.orgKmipClientEnable=this.KmipInfo.client_enable,"enable"===this.trigger&&(this.orgKmipClientEnable=!1),this.orgKmipServer=this.KmipInfo.kmip_server,this.orgKmipPort=this.KmipInfo.kmip_conn_server_port,this.orgKmipDesc=this.KmipInfo.kmip_conn_server_desc;var t=Ext.apply({title:_T("remote_key","client_edit_server_button"),width:700,height:266,layout:"fit",resizable:!0,cls:"kmip-setting-dialog",buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:function(){this.rollbackClientSetting(),"enable"===this.trigger&&(this.module.clientWindowShowed=!1),this.close()}},{btnStyle:"blue",text:_T("common","next"),scope:this,handler:this.apply}],items:[this.form]},e);this.callParent([t]),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.form.getForm().findField("ca_file").getEl(),_T("remote_key","ca_tips"))}),this,{single:!0})},createForm:function(){var e=260,t={border:!1,trackResetOnLoad:!0,labelWidth:240,padding:"0px",cls:"kmip-form",fileUpload:!0,webapi:{api:"SYNO.Storage.CGI.KMIP",method:"import_server_ca",version:1},items:[{xtype:"syno_textfield",labelHtmlEncode:!1,fieldLabel:_T("remote_key","client_conn_server_name")+" <font class='red-status'> *</font>",name:"client_conn_server_ip",width:e,value:this.KmipInfo.kmip_server},{xtype:"syno_textfield",labelHtmlEncode:!1,fieldLabel:_T("remote_key","client_conn_server_port")+" <font class='red-status'> *</font>",name:"kmip_conn_server_port_text",itemId:"kmip_conn_server_port_text",width:e,value:this.KmipInfo.kmip_conn_server_port,allowBlank:!1},{xtype:"syno_textfield",fieldLabel:_T("remote_key","description"),name:"server_description",itemId:"server_description",width:e,value:this.KmipInfo.kmip_conn_server_desc},{xtype:"syno_filebutton",fieldLabel:_T("remote_key","ca_optional"),id:this.mainFileButtonID=Ext.id(),name:"ca_file",itemId:"ca_file",textConfig:{width:244}}],onApiSuccess:Ext.createDelegate(this.onMainUploadSuccess,this),onApiFailure:Ext.createDelegate(this.onUploadFailed,this)};return SYNO.LayoutConfig.fill(t),new SYNO.SDS.Utils.FormPanel(t)},onMainUploadSuccess:function(e,t,i){this.updateClientSetting()},onUploadFailed:function(e,t,i){var s=this;s.clearStatusBusy(),s.getMsgBox().alert(_T("remote_key","dialog_invalid_cert"),SYNO.API.getErrorString(t.code),(function(){s.close()}))},apply:function(){var e=this.form.getForm(),t=e.findField("ca_file").isDirty(),i=e.findField("client_conn_server_ip").getValue();if("127"===i.split(".")[0]||"localhost"===i||""===i)return e.findField("client_conn_server_ip").markInvalid(_T("common","error_badip")),!1;e.isValid()?e.isDirty()||this.module.getForm().findField("client_enable").isDirty()?(this.KmipInfo.kmip_server=e.findField("client_conn_server_ip").getValue(),this.KmipInfo.kmip_conn_server_port=e.findField("kmip_conn_server_port_text").getValue(),this.KmipInfo.kmip_conn_server_desc=e.findField("server_description").getValue(),this.module.getForm().findField("client_conn_server_ip").setValue(this.KmipInfo.kmip_server),this.module.getForm().findField("kmip_conn_server_port_text").setValue(this.KmipInfo.kmip_conn_server_port),""===this.KmipInfo.kmip_conn_server_desc?this.module.getForm().findField("server_description").setValue("-"):this.module.getForm().findField("server_description").setValue(this.KmipInfo.kmip_conn_server_desc),this.setStatusBusy(),t?(this.hasClientCA=!0,this.form.upload()):(this.hasClientCA=!1,this.updateClientSetting())):this.setStatusError({text:_T("error","nochange_subject"),clear:!0}):this.setStatusError({text:_T("common","forminvalid"),clear:!0})},updateClientSetting:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"set",version:1,scope:this,params:{client_enable:!0,kmip_enabled:"yes",kmip_conn_server_desc:this.KmipInfo.kmip_conn_server_desc,kmip_conn_server_port:this.KmipInfo.kmip_conn_server_port,kmip_mode:"client",kmip_server:this.KmipInfo.kmip_server,server_enable:!1,client_has_import_ca:this.hasClientCA},callback:function(e,t,i){e?this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"test_conn",version:1,scope:this,params:{},callback:this.checkTestConn}):(this.clearStatusBusy(),new SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog({owner:this,messages:_T("remote_key","dialog_error_conn_failed")}).open())}})},rollbackClientSetting:function(){var e="no",t="client";(this.KmipInfo.server_enable||this.orgKmipClientEnable)&&(e="yes"),t=this.KmipInfo.server_enable&&this.orgKmipClientEnable?"both":this.KmipInfo.server_enable?"server":this.orgKmipClientEnable?"client":"none",this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"set",version:1,scope:this,params:{client_enable:this.orgKmipClientEnable,kmip_enabled:e,kmip_conn_server_desc:this.orgKmipDesc,kmip_conn_server_port:this.orgKmipPort,kmip_mode:t,kmip_server:this.orgKmipServer,server_enable:this.KmipInfo.server_enable},callback:function(e,t,i){e||(this.clearStatusBusy(),new SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog({owner:this,messages:_T("remote_key","dialog_error_conn_failed")}).open())}}),this.KmipInfo.kmip_server=this.orgKmipServer,this.KmipInfo.kmip_conn_server_port=this.orgKmipPort,this.KmipInfo.kmip_conn_server_desc=this.orgKmipDesc,this.module.getForm().findField("client_conn_server_ip").setValue(this.KmipInfo.kmip_server),this.module.getForm().findField("kmip_conn_server_port_text").setValue(this.KmipInfo.kmip_conn_server_port),"server"!==t&&"none"!==t||(this.module.getForm().findField("client_enable").setValue(!1),this.module.getForm().findField("client_cert_validation").setValue("-"),this.module.getForm().findField("server_cert_validation").setValue("-"),this.module.getForm().findField("client_last_conn_status").setValue("-"))},checkTestConn:function(e,t,i){(this.connStatus=t.conn_success,!0!==t.conn_success)?(this.clearStatusBusy(),new SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog({owner:this,messages:_T("remote_key","dialog_error_conn_failed")}).open()):(this.lastSuccessTime=t.conn_time,this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"check_loop",version:1,scope:this,params:{},callback:this.checkLoop}))},checkLoop:function(e,t,i){this.loopStatus=t.is_loop;!0===t.is_loop?(this.clearStatusBusy(),new SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog({owner:this,messages:_T("remote_key","dialog_error_loop")}).open()):(new SYNO.SDS.AdminCenter.Security.KMIP.ClientTrustCertWindow({owner:this,width:640,height:300,parent:this}).open(),this.updateConnStatus(this.lastSuccessTime),this.clearStatusBusy())},updateConnStatus:function(e){var t=this.module.getForm(),i="<font class='green-status'>Success on "+e+"</font>";this.module.setFieldAndOriginalValues(t.findField("client_last_conn_status"),i)}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.ClientTrustCertWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.KmipInfo=e.KmipInfo,this.module=e.module,this.form=this.createForm(),this.parent=e.parent;var t=Ext.apply({title:_T("remote_key","dialog_trust_certification"),width:640,height:300,layout:"fit",resizable:!0,buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:function(){this.close()}},{btnStyle:"blue",text:_T("remote_key","trust"),scope:this,handler:this.trust}],items:[this.form]},e);this.callParent([t]),this.getServerCertInfo()},createForm:function(){var e={border:!1,trackResetOnLoad:!0,labelWidth:240,fileUpload:!0,padding:"0px",items:[{xtype:"syno_displayfield",fieldLabel:_T("remote_key","client_conn_server_name"),name:"client_conn_server_name"},{xtype:"syno_displayfield",fieldLabel:_T("certificate","issue_to"),name:"issue_to"},{xtype:"syno_displayfield",fieldLabel:_T("certificate","issuer"),name:"issuer"},{xtype:"syno_displayfield",fieldLabel:_T("certificate","alias"),name:"subject_alt_name"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","client_server_cert_validation"),name:"server_cert_validation"}]};return SYNO.LayoutConfig.fill(e),new SYNO.SDS.Utils.FormPanel(e)},validDateConverter:function(e){var t=new Date(e);return SYNO.SDS.DateTimeFormatter(t,{type:"date"})},trust:function(){this.parent.module.getForm().findField("client_cert_validation").setValue(this.validDateConverter(this.tmpKmipInfo.client_cert_info.not_valid_after)),this.parent.module.getForm().findField("server_cert_validation").setValue(this.validDateConverter(this.tmpKmipInfo.server_cert_info.not_valid_after)),this.parent.close(),this.close()},getServerCertInfo:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"get",version:1,scope:this,params:{},callback:function(e,t,i){if(e){var s=this.form.getForm();s.findField("client_conn_server_name").setValue(t.kmip_server),s.findField("issue_to").setValue(t.kmip_server),s.findField("issuer").setValue(t.server_cert_info.issuer),s.findField("subject_alt_name").setValue(t.server_cert_info.subject_alt),s.findField("server_cert_validation").setValue(t.server_cert_info.not_valid_after),this.tmpKmipInfo=t,this.clearStatusBusy()}else{this.clearStatusBusy(),new SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog({owner:this,messages:_T("remote_key","dialog_error_conn_failed")}).open()}}})}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.ServerEditWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.KmipInfo=e.KmipInfo,this.module=e.module,this.form=this.createForm(),this.trigger=e.trigger;var t=Ext.apply({title:_T("remote_key","synology_key_server_setting_title"),width:640,height:542,layout:"fit",resizable:!0,buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:function(){"enable"===this.trigger&&(this.module.getForm().findField("server_enable").setValue(!1),this.module.serverWindowShowed=!1),this.close()}},{btnStyle:"blue",text:_T("common","save"),scope:this,handler:this.apply}],items:[this.form]},e);this.callParent([t]),this.loadData(this.form)},createForm:function(){var e=new Ext.data.JsonStore({idProperty:"value",fields:["value","display","size_total_mb","vol_name","desc","tooltip","volume_quota_status"],data:[[0,0]]}),t=new SYNO.ux.Button({xtype:"syno_button",text:_T("remote_key","server_conn_of_client_button"),scope:this,handler:this.showManageWindow}),i=new SYNO.ux.Button({xtype:"syno_button",text:_T("remote_key","server_reset_button"),scope:this,btnStyle:"red",handler:this.eraseData}),s={border:!1,trackResetOnLoad:!0,labelWidth:200,items:[{xtype:"syno_fieldset",title:_T("common","general"),itemId:"fieldset_general",collapsible:!1,labelWidth:200,items:[{xtype:"syno_textfield",fieldLabel:_T("remote_key","server_port"),name:"server_port",value:this.KmipInfo.kmip_server_port,width:280},{xtype:"syno_share_combobox",name:"vol_path",fieldLabel:_T("remote_key","server_key_location"),store:e,displayField:"display",descriptionField:"desc",tooltip:"tooltip",valueField:"value",allowBlank:!0,width:280},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","server_kmip_version"),name:"server_kmip_version",itemId:"server_kmip_version"},{xtype:"syno_displayfield",fieldLabel:_T("remote_key","server_auth_version"),name:"server_auth_version",itemId:"server_auth_version"}]},{xtype:"syno_fieldset",title:_T("remote_key","server_conn_of_client_title"),itemId:"fieldset_conn_of_client",collapsible:!1,labelWidth:200,items:[{xtype:"syno_displayfield",value:_T("remote_key","server_conn_of_client_desc"),name:"server_conn_of_client_desc"},t]},{xtype:"syno_fieldset",title:_T("remote_key","server_reset_title"),itemId:"fieldset_reset",collapsible:!1,labelWidth:200,items:[{xtype:"syno_displayfield",value:_T("remote_key","server_reset_desc"),name:"server_reset_desc"},i]}]};return SYNO.LayoutConfig.fill(s),new SYNO.SDS.Utils.FormPanel(s)},loadData:function(e){var t=e.getForm();this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Storage.Volume",method:"list",params:{limit:-1,offset:0,location:"internal",option:"include_cold_storage"},version:1,timeout:36e4,scope:this,callback:function(e,i,s){if(!0===i.isTimeout||!0===i.has_fail){this.clearStatusBusy();var n=_T("common","error_system");return i.result[1].error&&(n=SYNO.API.Errors.core[i.result[1].error.code]||_T("common","error_system")),this.getMsgBox().alert(this.title,n,(function(){this.close()}),this),this.setStatusError({text:n,clear:!0}),!1}var o=SYNO.API.Response.GetValByAPI(i,"SYNO.Core.Storage.Volume","list","volumes"),a=t.findField("vol_path"),r=a.getStore();this.volumeFsMap={},this.volumeAttrMap={},this.dedupedVolume=[],this.encryptedVolume=[],this.hasWritableVol=!1;var l=[];if(Ext.each(o,(function(e,t,i){var s,n,o,a;(this.volumeFsMap[e.volume_path]=e.fs_type,this.volumeAttrMap[e.volume_path]=e.volume_attribute,!0===e.deduped&&this.dedupedVolume.push(e.volume_path),!0===e.is_encrypted&&this.encryptedVolume.push(e.volume_path),e.readonly)||(a="btrfs"===e.fs_type?"generic"===e.volume_attribute?String.format("{0}",_T("volume","volume_add_fs_btrfs_type")):String.format("{0}",_T("volume","volume_add_fs_btrfs_peta_type")):String.format("{0}",e.fs_type),s=String.format("{0}{1} {2}",SYNO.SDS.Utils.StorageUtils.VolumeNameRenderer(e),_T("common","colon"),a),n=String.format("{0}{1} {2}",_T("volume","volume_freesize"),_T("common","colon"),SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SizeRender(e.size_free_byte)),""!==e.description&&(o=Ext.util.Format.htmlEncode(e.description)),l.push([e.volume_path,s,e.size_total_byte/1024/1024,e.display_name,n,e.volume_id,o,e.volume_quota_status]),this.hasWritableVol=!0)}),this),0===l.length)return this.getMsgBox().confirm("",_T("remote_key","dialog_no_volume"),(function(e){"yes"===e?SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance"):"enable"===this.trigger&&(this.module.getForm().findField("server_enable").setValue(!1),this.module.serverWindowShowed=!1)}),this),this.clearStatusBusy(),this.close(),!0;l.sort((function(e,t){return e[5]-t[5]}));var d=[];return Ext.each(l,(function(e,t,i){d=d.concat({value:e[0],display:e[1],size_total_mb:e[2],vol_name:e[3],desc:Ext.util.Format.htmlEncode(e[4]),tooltip:e[6],volume_quota_status:e[7]})})),r.loadData(d),a.setValue(this.KmipInfo.kmip_db_loc),a.originalValue=a.getValue(),this.volList=l,this.clearStatusBusy(),!0}}),this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"get_version_info",version:1,scope:this,params:{},callback:function(e,i,s){e&&(t.findField("server_kmip_version").setValue(i.kmip_version),t.findField("server_auth_version").setValue(i.auth_version))}})},getVolNameByPath:function(e){var t="unknown";return Ext.each(this.volList,(function(i,s,n){i[0]===e&&(t=i[3])})),t},apply:function(){var e=this.form.getForm();if(e.isValid())if(e.isDirty()){var t=e.findField("vol_path").getValue(),i=this.getVolNameByPath(t);""!==t?(-1!==this.encryptedVolume.indexOf(t)?this.KmipInfo.kmip_db_loc!==t?this.getMsgBox().confirm("",_T("remote_key","dialog_select_enc_volume"),(function(e){"yes"===e&&(""!=this.KmipInfo.kmip_db_loc?this.confirmTransfer(i,t):this.applySetting(t))}),this):this.applySetting(t):this.KmipInfo.kmip_db_loc!==t&&""!=this.KmipInfo.kmip_db_loc?this.confirmTransfer(i,t):this.applySetting(t),this.KmipInfo.kmip_db_loc===t&&e.isDirty()&&(this.KmipInfo.kmip_server_port=e.findField("server_port").getValue(),this.module.getForm().findField("kmip_server_modified").setValue("true"))):e.findField("vol_path").markInvalid()}else this.close();else this.setStatusError({text:_T("common","forminvalid"),clear:!0})},eraseData:function(){new SYNO.SDS.AdminCenter.Security.KMIP.KmipEraseDialog({owner:this,width:480,height:195,parent:this.module}).open()},afterEraseDone:function(){this.close()},showManageWindow:function(){new SYNO.SDS.AdminCenter.Security.KMIP.KmipManageWindow({owner:this,module:this.module}).open()},confirmTransfer:function(e,t){var i=_T("remote_key","dialog_transfer_title"),s=_T("remote_key","dialog_transfer_desc");i=i.replace("{Volume}",e),s=s.replace("{Volume}",e),this.getMsgBox().confirm("",s,(function(e){"yes"===e&&(this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Storage.CGI.KMIP",method:"transfer_data",version:1,scope:this,params:{kmip_db_loc:t},callback:function(e,i,s){e?this.applySetting(t):(new SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog({owner:this.module.appWin,messages:_T("remote_key","dialog_error_conn_failed")}).open(),this.clearStatusBusy())}}))}),this)},applySetting:function(e){var t=this.form.getForm();this.KmipInfo.kmip_db_loc=e,this.KmipInfo.kmip_server_port=t.findField("server_port").getValue(),this.module.getForm().findField("kmip_server_modified").setValue("true"),this.clearStatusBusy(),this.close()}}),Ext.define("SYNO.SDS.AdminCenter.Security.KMIP.KmipErrorDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={padding:"24px 30px 0px",closable:!1,width:540,resizable:!1,draggable:!1,layout:"fit",elements:"body",cls:"x-window-dlg",autoHeight:!0,fbar:[{xtype:"syno_button",itemId:"ok",text:_T("common","ok"),scope:this,btnStyle:"blue",handler:function(){this.close()}}],items:[{padding:"0",xtype:"syno_formpanel",itemId:"deleteFormPanel",items:[{xtype:"syno_displayfield",padding:"0",value:e.messages,name:"dialog_message",htmlEncode:!1}]}]};return Ext.apply(t,e),t}}),Ext.define("SYNO.SDS.AdminCenter.Security.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.app=e.app,this.panel=new SYNO.SDS.AdminCenter.Security.TabPanel({module:this,appWin:e.appWin,app:e.app})},getPanel:function(){return this.panel},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"DSMTab":return"AdminCenter/connection_security_security.html";case"SigninTab":return"AdminCenter/connection_security_account.html";case"FirewallTab":return"AdminCenter/connection_security_firewall.html";case"AccountTab":return"AdminCenter/connection_security_protection.html";case"CertificateTab":return"AdminCenter/connection_certificate.html";case"AdvancedTab":return"AdminCenter/connection_security_advanced.html";default:return"AdminCenter/connection_security_desc.html"}},setActivateParams:function(e){e&&e.tab&&this.panel.setActiveTab(e.tab)},activate:function(e){this.setActivateParams(e),this.panel.loadInterface()},deactivate:function(){for(var e=this.panel.getAllForms(),t=0;t<e.length;t++)if(e[t].isDirty())return!1;return!_S("is_admin")||!this.panel.getComponent("FirewallTab").isDirty()},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t,this.panel.applyHandler()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.Security.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",FwGlobalLayoutVer:4920,FWGlobalIF:"global",constructor:function(e){var t,i=[];this.module=e.module,this.module.appWin=e.appWin,_S("is_admin")?(this.IFStore=this.createIFStore(),this.DSMForm=new SYNO.SDS.AdminCenter.Security.DSM.Form({module:e.module,owner:this,itemId:"DSMTab"}),i.push(this.DSMForm),this.SigninPanel=new SYNO.SDS.AdminCenter.Security.SigninPanel({module:e.module,owner:this,appWin:this.module.appWin,itemId:"SigninTab"}),i.push(this.SigninPanel),this.fwFormPanel=new SYNO.SDS.AdminCenter.Security.FwFormPanel({module:e.module,title:_T("tree","leaf_firewall"),owner:this,itemId:"FirewallTab"}),i.push(this.fwFormPanel),this.AccountPanel=new SYNO.SDS.AdminCenter.Security.AccountPanel({module:e.module,owner:this,appWin:this.module.appWin,itemId:"AccountTab"}),i.push(this.AccountPanel),this.CertificateTab=new SYNO.SDS.AdminCenter.Security.CertificateTab({module:e.module,owner:this,appWin:e.appWin,itemId:"CertificateTab"}),i.push(this.CertificateTab),this.AdvancedTab=new SYNO.SDS.AdminCenter.Security.AdvancedTab({module:e.module,owner:this,appWin:e.appWin,itemId:"AdvancedTab"}),i.push(this.AdvancedTab),this.checkSupportKmip()&&(this.KmipTab=new SYNO.SDS.AdminCenter.Security.KmipTab({module:e.module,owner:this,appWin:e.appWin,itemId:"KmipTab"}),i.push(this.KmipTab))):(this.SigninPanel=new SYNO.SDS.AdminCenter.Security.SigninPanel({module:e.module,owner:this,appWin:this.module.appWin,itemId:"SigninTab"}),i.push(this.SigninPanel),this.AccountPanel=new SYNO.SDS.AdminCenter.Security.AccountPanel({module:e.module,owner:this,appWin:this.module.appWin,itemId:"AccountTab"}),i.push(this.AccountPanel),e.buttons=null),t=Ext.apply({activeTab:0,applyDirtyOnly:!0,loadDirtyOnly:!0,items:i},e),this.callParent([t])},createIFStore:function(){return _S("version")>=this.FwGlobalLayoutVer?new SYNO.SDS.AdminCenter.Security.FwIFStore({module:this.module,owner:this.module.appWin}):new SYNO.SDS.AdminCenter.Network.SimpleIFStore({module:this.module,owner:this.module.appWin})},loadInterface:function(){_S("is_admin")?(this.mon(this.IFStore,"load",this.onIFAfterLoad,this),this.IFStore.loadInterface()):this.onIFAfterLoad()},onIFAfterLoad:function(e,t,i){this.loadAllForm()},onApiSuccess:function(e,t,i){if("set"===e)if(_S("is_admin")&&!t.has_fail)this.fwFormPanel.needApplyProfile()?this.fwFormPanel.applyProfile():this.fwFormPanel.needDisableFirewall()?this.fwFormPanel.disableFirewall():this.setStatusOK(),this.checkHttpdRestart(),this.module.confirmSaveLostResolve&&this.module.confirmSaveLostResolve();else{this.module.confirmSaveLostReject&&this.module.confirmSaveLostReject();var s=SYNO.API.getErrorString(t);this.setStatusError({text:s,clear:!0})}this.processReturnData(e,t,i)},checkHttpdRestart:function(){this.restartHttpd&&SYNO.SDS.AdminCenter.Utils.WaitHttpdRestart()()},checkSupportKmip:function(){return _S("ha_running")&&_S("is_hybrid_ha")?_S("ha_support_volume_encryption"):"yes"===_D("support_kmip","no")}}),Ext.define("SYNO.SDS.AdminCenter.Security.FwIFStore",{extend:"SYNO.SDS.AdminCenter.Network.SimpleIFStore",loadInterface:function(e){this.globalFwRecs=[];for(var t=[],i=0;i<this.apiGetIFArray.length;i++)t.push(this.apiGetIFArray[i].webapi);SYNO.API.Request({params:{},scope:this,compound:{stopwhenerror:!1,params:t},callback:this.loadIFStore})},loadIFStore:function(e,t,i){e?this.fillFwStore(t,i):this.module.appWin.getMsgBox().alert(_T("common","note"),_T("common","commfail"))},loadGlobalFwRules:function(){return this.globalFwRecs},fillFwStore:function(e,t){for(var i=0;i<e.result.length;i++)if("SYNO.Core.Security.Firewall.Rules"===t.compound[i].api){this.globalFwRecs=e.result[i].data,t.compound.splice(i,1);break}this.fillIFStore(e,t)}}),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.SNMPTab",{extend:"SYNO.SDS.Utils.FormPanel",utils:new SYNO.SDS.AdminCenter.WebAPIUtils,constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",this.enableCheckGroup,this,{single:!0}),this.mon(this,"afterlayout",this.addSnmpV1V2EnableTip,this,{single:!0}),this.mon(this,"afterlayout",this.addSnmpV1V2CommunityTip,this,{single:!0})},enableCheckGroup:function(){_S("ha_running")?new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_snmp",["enable_snmp_v1v2","enable_snmp_v3","info","device_name","node0_name","node1_name","location","contact"]):new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_snmp",["enable_snmp_v1v2","enable_snmp_v3","info","name","location","contact"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_snmp_v1v2",["rocommunity"]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_snmp_v3",["rouser","auth_type","password","enable_privacy"]),this.dummy4=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_privacy",["privacy_type","privacy_key"])},addSnmpV1V2EnableTip:function(){SYNO.ux.AddTip(this.form.findField("enable_snmp_v1v2").getEl(),_T("snmp","snmp_desc_v1_v2c_warning"))},addSnmpV1V2CommunityTip:function(){SYNO.ux.AddTip(this.form.findField("rocommunity").getEl(),_T("snmp","snmp_rocommunity_warning"))},fillConfig:function(e){var t={title:_T("tree","leaf_snmp"),autoScroll:!0,webapi:{api:"SYNO.Core.SNMP",methods:{get:"get",set:"set"},version:1},style:{paddingBottom:"6px"},labelWidth:190,items:this.getSNMPItems()};return Ext.apply(t,e),t},getSNMPItems:function(){var e=/^[0-9a-zA-Z~`!@#$%^&*()_\-\+\=\|\/\{\[\}\];:<>,.?]+$/,t=[{itemId:"desc",xtype:"syno_displayfield",hideLabel:!0,value:_T("snmp","snmp_desc")},{xtype:"syno_checkbox",name:"enable_snmp",boxLabel:_T("snmp","snmp_enable")},{xtype:"syno_checkbox",name:"enable_snmp_v1v2",boxLabel:_T("snmp","snmp_desc_v1_v2c"),indent:1},{xtype:"syno_textfield",name:"rocommunity",maxLength:64,indent:2,width:200,allowBlank:!1,maskRe:e,regex:e,fieldLabel:_T("snmp","snmp_rocommunity")},{xtype:"syno_checkbox",name:"enable_snmp_v3",boxLabel:_T("snmp","snmp_desc_v3"),indent:1},{xtype:"syno_textfield",name:"rouser",maxLength:64,allowBlank:!1,indent:2,width:200,maskRe:e,regex:e,fieldLabel:_T("common","username")},{xtype:"syno_combobox",fieldLabel:_T("snmp","snmp_protocol"),name:"auth_type",itemId:"auth_type",indent:2,width:200,store:new Ext.data.ArrayStore({fields:["value","display"],data:[["MD5","MD5"],["SHA","SHA"]]}),value:"MD5",valueField:"value",displayField:"display"},{xtype:"syno_textfield",name:"password",textType:"password",allowBlank:!1,maxLength:127,minLength:8,indent:2,width:200,maskRe:e,regex:e,fieldLabel:_T("common","password")},{xtype:"syno_checkbox",name:"enable_privacy",itemId:"enable_privacy",indent:2,boxLabel:_T("snmp","snmp_privacy")},{xtype:"syno_combobox",fieldLabel:_T("snmp","snmp_protocol"),name:"privacy_type",itemId:"privacy_type",indent:3,width:200,store:new Ext.data.ArrayStore({fields:["value","display"],data:[["DES","DES"],["AES","AES"]]}),value:"DES",valueField:"value",displayField:"display"},{xtype:"syno_textfield",name:"privacy_key",itemId:"privacy_key",textType:"password",allowBlank:!1,maxLength:127,minLength:8,indent:3,width:200,maskRe:e,regex:e,fieldLabel:_T("common","password")},{xtype:"syno_displayfield",name:"info",indent:1,value:_T("snmp","snmp_device_info")}];return _S("ha_running")?t.push({xtype:"syno_displayfield",name:"device_name",indent:2,value:_T("snmp","snmp_sysName")},{xtype:"syno_textfield",name:"node0_name",maxLength:255,indent:3,width:200,fieldLabel:_S("ha_snmp_show_hostname")?_S("ha_host0"):String.format(_T("volume","controller_i"),"A")},{xtype:"syno_textfield",name:"node1_name",maxLength:255,indent:3,width:200,fieldLabel:_S("ha_snmp_show_hostname")?_S("ha_host1"):String.format(_T("volume","controller_i"),"B")}):t.push({xtype:"syno_textfield",name:"name",maxLength:255,indent:2,width:200,fieldLabel:_T("snmp","snmp_sysName")}),t.push({xtype:"syno_textfield",name:"location",maxLength:255,indent:2,width:200,fieldLabel:_T("snmp","snmp_sysLocation")},{xtype:"syno_textfield",name:"contact",maxLength:255,indent:2,width:200,fieldLabel:_T("snmp","snmp_sysContact")},{xtype:"syno_displayfield",htmlEncode:!1,value:_T("snmp","MIB_desc")}),t},onBeforeRequest:function(e){return this.webapi.methods.set!==e||(this.getForm().isValid()?!!this.checkFormComplete(this.getForm())||(this.module.panel.setStatusError({text:_T("snmp","warnning_select_v1v2_or_v3"),clear:!0}),this.ownerCt.setActiveTab(this.itemId),!1):(this.module.panel.setStatusError({text:_T("common","forminvalid"),clear:!0}),this.ownerCt.setActiveTab(this.itemId),!1))},sendServiceEvent:function(e){for(var t={api:this.webapi.api,method:this.webapi.methods.set,version:this.webapi.version},i=this.getForm(),s=0;s<e.result.length;s++)if(!1!==SYNO.ux.Utils.checkApiConsistency(t,e.result[s])){this.snmpChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.SNMP",!i.findField("enable_snmp").getValue());break}!1===i.getValues().enable_snmp_v3&&(this.dummy4.enableField(this.getForm(),SYNO.ux.Utils.findFormField(this.getForm(),"privacy_type"),!1),this.dummy4.enableField(this.getForm(),SYNO.ux.Utils.findFormField(this.getForm(),"privacy_key"),!1))},checkFormComplete:function(e){var t=e.findField("enable_snmp").getValue(),i=e.findField("enable_snmp_v1v2").getValue(),s=e.findField("enable_snmp_v3").getValue();return!t||!(!i&&!s)},processSNMPGetData:function(e,t){var i=SYNO.API.Response.GetValByAPI(e,this.webapi.api,this.webapi.methods.get);void 0!==i?this.getForm().setValues(this.decaratorValueFromAPI(i)):SYNO.Debug("Error")},processReturnData:function(e,t,i){i.compound.find((function(e){return"SYNO.Core.SNMP"===e.api}))&&(this.processSNMPGetData(t,i),this.sendServiceEvent(t))},decaratorValueFromAPI:function(e){return e.password=e.enable_snmp_v3?"dummypasswd":"",e.privacy_key=e.enable_snmp_v3&&e.enable_privacy?"dummypasswd":"",e.enable_snmp&&e.enable_snmp_v3||(e.enable_privacy=!1),e},processSetSNMPData:function(e){var t=this.utils.getReqCompoundParam(e,this.webapi.api,this.webapi.methods.set);void 0!==t?t=this.decoratorValueToAPI(t):SYNO.Debug("Error")},processParams:function(e,t){return"set"==e&&(this.processSetSNMPData(t),this.snmpChange=this.getForm().findField("enable_snmp").isDirty()),t},decoratorValueToAPI:function(e){return!0===e.params.enable_snmp_v3&&("dummypasswd"==e.params.password&&delete e.params.password,"dummypasswd"==e.params.privacy_key&&delete e.params.privacy_key),e}}),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.SSHCrypto",{extend:"Object",statics:{type:["cipher","kex","mac"],level:["low","medium","high"],hw:["hw","nonhw"],compareCrypto:function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}},constructor:function(e){var t=0,i=0;this.cls=SYNO.SDS.AdminCenter.TerminalSNMP.SSHCrypto,this.map={},this.hash={},this.hwSupportForLevel={},this.nowLevel="custom",this.nowHw=!1,Ext.each(this.cls.type,(function(i){for(this[i]=e[i].sort(this.cls.compareCrypto),t=0;t<this[i].length;t++)this[i][t].selected=this[i][t].in_use}),this),Ext.each(this.cls.type,(function(e){this.map[e]={},Ext.each(this.cls.level,(function(t){this.map[e][t]={},Ext.each(this.cls.hw,(function(i){this.map[e][t][i]=[]}),this)}),this)}),this),Ext.each(this.cls.type,(function(e){Ext.each(this[e],(function(t){for(i=0;i<this.cls.level.length;i++)t.security_level>=i&&(t.hardware_support&&this.map[e][this.cls.level[i]].hw.push(t.name),this.map[e][this.cls.level[i]].nonhw.push(t.name))}),this)}),this),Ext.each(this.cls.level,(function(e){var t="",i=[];this.hwSupportForLevel[e]=this.hasHwSupportForLevel(e),this.hwSupportForLevel[e]&&(Ext.each(this.cls.type,(function(t){i=0<this.map[t][e].hw.length?i.concat(this.map[t][e].hw):i.concat(this.map[t][e].nonhw)}),this),t=i.join(","),this.hash[t]=[e,!0]),t=[].concat(this.map.cipher[e].nonhw,this.map.kex[e].nonhw,this.map.mac[e].nonhw).join(","),this.hash[t]=[e,!1]}),this),this.updateLevelAndHw()},hasHwSupportForLevel:function(e){return("high"===e||"medium"===e||"low"===e)&&0!==this.map.cipher[e].hw.length+this.map.kex[e].hw.length+this.map.mac[e].hw.length},hasHwSupport:function(){return this.hasHwSupportForLevel("low")},getCryptoName:function(e,t,i){return i&&0!==this.map[e][t].hw.length?this.map[e][t].hw:this.map[e][t].nonhw},selectCryptoByLevelAndHw:function(e,t){var i=0,s=[],n={};for(Ext.each(this.cls.type,(function(i){s=s.concat(this.getCryptoName(i,e,t))}),this),i=0;i<s.length;i++)n[s[i]]=1;Ext.each(this.cls.type,(function(e){Ext.each(this[e],(function(e){e.selected=e.name in n}),this)}),this),this.updateLevelAndHw()},getCryptoByLevelAndHw:function(e,t){var i=0,s={cipher:[],kex:[],mac:[]},n=[],o={};for(Ext.each(this.cls.type,(function(i){n=n.concat(this.getCryptoName(i,e,t))}),this),i=0;i<n.length;i++)o[n[i]]=1;return Ext.each(this.cls.type,(function(e){Ext.each(this[e],(function(t){var i={};Ext.apply(i,t),i.selected=t.name in o,s[e].push(i)}),this)}),this),s},selectCryptoByNames:function(e){var t={};Ext.each(e,(function(e){t[e]=1}),this),Ext.each(this.cls.type,(function(e){Ext.each(this[e],(function(e){e.selected=e.name in t}),this)}),this),this.updateLevelAndHw()},getCryptoLevelAndHw:function(e){var t,i=["custom",!1];return(t=e.join(","))in this.hash&&(i=this.hash[t]),i},updateLevelAndHw:function(){var e,t=0,i=[];Ext.each(this.cls.type,(function(e){for(t=0;t<this[e].length;t++)this[e][t].selected&&i.push(this[e][t].name)}),this),e=this.getCryptoLevelAndHw(i),this.nowLevel=e[0],this.nowHw=e[1]},isDirty:function(){var e=0,t=!1;return Ext.each(this.cls.type,(function(i){for(e=0;e<this[i].length;e++)if(this[i][e].in_use!=this[i][e].selected)return t=!0,!1}),this),t},getCryptoNameArray:function(){var e={cipher:[],kex:[],mac:[]};return Ext.each(this.cls.type,(function(t){Ext.each(this[t],(function(i){i.selected&&e[t].push(i.name)}),this)}),this),e}}),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.SSHCryptoDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.form=this.configForm(),this.bottomForm=this.bottomForm(),this.cipherGrid=this.configGrid("Cipher","0px 10.666px 0px 0px"),this.kexGrid=this.configGrid("KEX","0px 5.333px 0px 5.333px"),this.macGrid=this.configGrid("MAC","0px 0px 0px 10.666px");var t=Ext.apply({title:_T("terminal","ssh_crypto_level_customize"),autoDestroy:!0,resizable:!1,width:830,height:580,padding:"20px 20px 12px 20px",layout:{type:"vbox",pack:"start",align:"stretch"},items:[this.form,{xtype:"container",autoHeight:!0,layout:{type:"hbox",pack:"start",aligh:"stretch",padding:"0px",defaultMargins:{top:6,right:0,bottom:0,left:0}},items:[this.cipherGrid,this.kexGrid,this.macGrid]},this.bottomForm],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","save"),scope:this,handler:this.onApply}]},e);this.callParent([t]),this.mon(this,"show",this.load,this),this.on("afterlayout",(function(e,t){SYNO.ux.AddTip(this.bottomForm.getForm().findField("hw_acc_cipher_only").getEl(),_T("terminal","ssh_crypto_level_hw_acc_desc")),this.owner.crypto.hasHwSupport()&&this.bottomForm.getForm().findField("hw_acc_cipher_only").setVisible(!0)}),this,{single:!0})},load:function(){var e=this.owner.crypto.nowLevel,t=this.owner.crypto.nowHw;"custom"===e&&(e=_T("common","customize")),this.setValues({security_level:e,hw_acc_cipher_only:t}),this.loadCryptoToGrids(this.owner.crypto),this.updateHwAccBtn()},setValues:function(e){this.form.getForm().setValues(e),this.bottomForm.getForm().setValues(e)},getValues:function(){var e,t={};return e=this.form.getForm().getValues(),Ext.apply(t,e),Ext.apply(t,{hw_acc_cipher_only:this.bottomForm.getForm().findField("hw_acc_cipher_only").getValue()}),t},onApply:function(){var e=this.getCryptoFromGrids(),t=[this.cipherGrid,this.kexGrid,this.macGrid],i=!1;if(Ext.each(t,(function(e){var t=0;if(e.getStore().each((function(e){e.data.selected&&t++})),0===t)return i=!0,!1}),this),i)return this.setStatusError({text:_T("terminal","ssh_crypto_no_algorithm"),clear:!0}),!1;this.owner.crypto.selectCryptoByNames(e);var s=this.owner.panel.getForm().findField("security_level"),n=this.owner.crypto.nowLevel,o=this.owner.crypto.nowHw;s.setValue(n),this.owner.panel.getForm().findField("hw_acc_cipher_only").setValue(o),this.close()},getCryptoFromGrids:function(){var e=[this.cipherGrid,this.kexGrid,this.macGrid],t=[];return Ext.each(e,(function(e){e.getStore().each((function(e){e.data.selected&&t.push(e.data.name)}))}),this),t},loadCryptoToGrids:function(e){this.cipherGrid.getStore().loadData(e.cipher,!1),this.kexGrid.getStore().loadData(e.kex,!1),this.macGrid.getStore().loadData(e.mac,!1)},configForm:function(){var e=new Ext.data.ArrayStore({fields:["display","value"],data:[[_T("terminal","ssh_crypto_level_high"),"high"],[_T("terminal","ssh_crypto_level_medium"),"medium"],[_T("terminal","ssh_crypto_level_low"),"low"]]});return new SYNO.ux.FormPanel({autoHeight:!0,padding:0,items:[{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_displayfield",value:_T("terminal","ssh_crypto_level")+_T("common","colon")},{xtype:"syno_combobox",hideLabel:!0,displayField:"display",valueField:"value",name:"security_level",store:e,width:150,listeners:{select:this.reloadGrids,scope:this}}]}]})},bottomForm:function(){return new SYNO.ux.FormPanel({items:[{xtype:"syno_checkbox",boxLabel:_T("terminal","ssh_hw_acc_cipher_only"),name:"hw_acc_cipher_only",hidden:!0,handler:this.reloadGrids,scope:this}]})},updateHwAccBtn:function(){var e=this.getValues().security_level;this.owner.crypto.hasHwSupportForLevel(e)?this.bottomForm.getForm().findField("hw_acc_cipher_only").setDisabled(!1):(this.bottomForm.getForm().setValues({hw_acc_cipher_only:!1}),this.bottomForm.getForm().findField("hw_acc_cipher_only").setDisabled(!0))},reloadGrids:function(){if(!0===this.notUpdateGrid)return!0;this.notUpdateGrid=!0,this.updateHwAccBtn(),this.notUpdateGrid=!1;var e=this.getValues(),t=e.security_level,i=e.hw_acc_cipher_only,s=this.owner.crypto.getCryptoByLevelAndHw(t,i);return this.loadCryptoToGrids(s),!0},configGrid:function(e,t){var i=new Ext.data.JsonStore({fields:["name","hardware_support","security_level","selected","in_use"],listeners:{update:{fn:function(){var e=this.getCryptoFromGrids(),t=this.owner.crypto.getCryptoLevelAndHw(e),i=t[0],s=t[1];this.notUpdateGrid=!0,"custom"===i?this.setValues({security_level:_T("common","customize"),hw_acc_cipher_only:!1}):this.setValues({security_level:i,hw_acc_cipher_only:s}),this.updateHwAccBtn(),this.notUpdateGrid=!1},buffer:50},scope:this}}),s=new SYNO.ux.EnableColumn({header:"",dataIndex:"selected",align:"center",width:40});return new SYNO.ux.GridPanel({flex:1,height:425,padding:t,enableColumnMove:!1,enableColumnHide:!1,view:new SYNO.ux.FleXcroll.grid.GridView({borderHeight:1,cacheSize:100,scrollDelay:!1}),colModel:new Ext.grid.ColumnModel({columns:[s,{id:"name",header:e,dataIndex:"name",renderer:function(e,t,i,s,n,o){var a=Ext.util.Format.htmlDecode(e),r=Ext.util.Format.htmlEncode(a);return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(r)+'"',i.data.hardware_support&&(r='<font color="red">'+r+"</font>"),r}}],defaults:{sortable:!1,menuDisabled:!0}}),autoExpandColumn:"name",store:i,plugins:[s]})}}),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.SSHAdvSettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.panel=this.configForm(),this.customBtn=Ext.getCmp(this.customBtnId);var t=Ext.apply({title:_T("common","adv_setting"),autoDestroy:!0,width:500,height:430,layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","save"),scope:this,handler:this.onApply}]},e);this.callParent([t]),this.mon(this,"show",this.load,this),this.on("afterlayout",(function(e,t){SYNO.ux.AddTip(this.panel.getForm().findField("hw_acc_cipher_only").getEl(),_T("terminal","ssh_crypto_level_hw_acc_desc"));for(var i=SYNO.ux.Utils.getRadioGroup(this.panel.getForm(),"security_level"),s=0;s<i.length;s++){var n=i[s];n.mon(n,"check",this.onCheckLevel,this)}}),this,{single:!0})},onApply:function(){var e,t=this.panel.getForm().getValues().security_level,i=this.panel.getForm().findField("hw_acc_cipher_only").getValue(),s={};if("custom"==t||t==this.crypto.nowLevel&&i==this.crypto.nowHw||this.crypto.selectCryptoByLevelAndHw(t,i),!this.crypto.isDirty())return this.close(),!0;this.setStatusBusy({text:_T("common","loading")}),e=this.crypto.getCryptoNameArray(),s.ssh_cipher=e.cipher,s.ssh_kex=e.kex,s.ssh_mac=e.mac,this.sendWebAPI({api:"SYNO.Core.Terminal",method:"set",version:3,scope:this,params:s,callback:function(e,t,i){if(this.clearStatusBusy(),e)return this.close(),!0;this.setStatusError()}})},load:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.Terminal",method:"get",version:3,scope:this,callback:function(e,t,i){e?(this.afterLoad(t),this.clearStatusBusy()):this.clearStatusBusy()}})},afterLoad:function(e){this.crypto=new SYNO.SDS.AdminCenter.TerminalSNMP.SSHCrypto({cipher:e.ssh_cipher,kex:e.ssh_kex,mac:e.ssh_mac}),this.panel.getForm().setValues({security_level:this.crypto.nowLevel,hw_acc_cipher_only:this.crypto.nowHw}),this.crypto.hasHwSupport()&&this.panel.getForm().findField("hw_acc_cipher_only").setVisible(!0)},onCheckLevel:function(e,t){var i=e.getGroupValue(),s=this.panel.getForm().findField("hw_acc_cipher_only");this.customBtn.setDisabled("custom"!==i),"custom"!==i&&this.crypto.hasHwSupportForLevel(i)?s.setDisabled(!1):(this.panel.getForm().setValues({hw_acc_cipher_only:!1}),s.setDisabled(!0))},configForm:function(){return new SYNO.ux.FormPanel({padding:0,items:[{xtype:"syno_displayfield",value:_T("terminal","ssh_crypto_level_desc")},{xtype:"syno_radio",boxLabel:_T("terminal","ssh_crypto_level_high"),name:"security_level",value:"high"},{xtype:"syno_radio",boxLabel:_T("terminal","ssh_crypto_level_medium"),name:"security_level",value:"medium"},{xtype:"syno_radio",boxLabel:_T("terminal","ssh_crypto_level_low"),name:"security_level",value:"low"},{xtype:"syno_radio",boxLabel:_T("common","customize"),name:"security_level",value:"custom"},{xtype:"syno_button",text:_T("terminal","ssh_crypto_level_customize"),style:"margin-left: 29px",id:this.customBtnId=Ext.id(),name:"customize",handler:function(){new SYNO.SDS.AdminCenter.TerminalSNMP.SSHCryptoDialog({module:this.module,owner:this}).open()},scope:this},{xtype:"syno_checkbox",boxLabel:_T("terminal","ssh_hw_acc_cipher_only"),name:"hw_acc_cipher_only",hidden:!0}]})}}),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.TerminalTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.apiMaxVersion=SYNO.API.GetKnownAPI("SYNO.Core.Terminal").maxVersion,this.sshCipherTipAdded=!1,this.showDisclaimer=!0;var t=this.fillConfig(e);this.callParent([t]),"yes"===_D("supportssh")&&2<=this.apiMaxVersion&&this.on("afterlayout",(function(e,t){this.checkSSHPort=new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"enable_ssh",["ssh_port"]),3===this.apiMaxVersion&&e.mon(e.getForm().findField("enable_ssh"),"check",(function(e,t){this.getComponent("advBtnId").setDisabled(!t)}),this)}),this,{single:!0})},fillConfig:function(e){var t={title:_T("tree","leaf_terminal"),autoScroll:!0,webapi:{api:"SYNO.Core.Terminal",methods:{get:"get",set:"set"},version:1},items:[this.getTerminalItems()]};return t.webapi.version=this.apiMaxVersion,Ext.apply(t,e),t},getTerminalItems:function(){var e=[];return e.push({xtype:"syno_displayfield",htmlEncode:!1,value:String.format(_T("terminal","terminal_desc"),'<a id="'+Ext.id()+'" class="link-font" href="">'+_T("helptoc","terminal")+"</a>"),listeners:{render:function(e){var t=e.el.first("a");t&&this.mon(t,"click",(function(e){e.preventDefault(),SYNO.SDS.AdminCenter.TerminalSNMP.TerminalTab.Utils.onClickTerminalHelpUrl(this.module)}),this)},scope:this,buffer:80}}),e.push({xtype:"syno_checkbox",name:"enable_telnet",boxLabel:_T("terminal","telnet_enable")}),"yes"===_D("supportssh")&&(e.push({xtype:"syno_checkbox",name:"enable_ssh",boxLabel:_T("terminal","ssh_enable")}),2<=this.apiMaxVersion&&(e.push({xtype:"syno_numberfield",indent:1,name:"ssh_port",vtype:"port",maxlength:5,fieldLabel:_T("common","port")}),2==this.apiMaxVersion&&e.push({xtype:"syno_displayfield",hidden:!0,itemId:"ssh_hw_acc_cipher_only_desc",name:"ssh_hw_acc_cipher_only_desc",value:_T("terminal","ssh_hw_acc_cipher_only_desc")},{xtype:"syno_checkbox",hidden:!0,itemId:"ssh_hw_acc_cipher_only",name:"ssh_hw_acc_cipher_only",boxLabel:_T("terminal","ssh_hw_acc_cipher_only")}),3==this.apiMaxVersion&&e.push({xtype:"syno_button",indent:1,style:{marginBottom:"12px"},text:_T("common","adv_setting"),itemId:"advBtnId",handler:function(){new SYNO.SDS.AdminCenter.TerminalSNMP.SSHAdvSettingDialog({module:this.module,owner:this.module.appWin}).open()},scope:this}))),"yes"===_D("support_console_port")&&e.push({xtype:"syno_checkbox",name:"forbid_console",boxLabel:_T("terminal","forbid_console")}),e.push({xtype:"syno_displayfield",htmlEncode:!1,fieldLabel:"Note",hideLabel:!0,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+String.format(_T("terminal","terminal_security_suggest"),'<a id="'+Ext.id()+'" class="link-font" href="">'+_T("controlpanel","leaf_autoblock")+"</a>"),listeners:{render:function(e){var t=e.el.first("a");t&&this.mon(t,"click",(function(e){e.preventDefault(),SYNO.SDS.AdminCenter.TerminalSNMP.TerminalTab.Utils.onClickAutoblockUrl(this.module)}),this)},scope:this,buffer:80}}),e},processReturnData:function(e,t,i){for(var s={api:"SYNO.Core.Terminal",method:"get",version:2},n=0;n<t.result.length;n++)!0===SYNO.ux.Utils.checkApiConsistency(s,t.result[n])&&t.result[n].data.ssh_hw_acc_cipher_support&&(this.getComponent("ssh_hw_acc_cipher_only").setVisible(!0),this.getComponent("ssh_hw_acc_cipher_only_desc").setVisible(!0),this.sshCipherTipAdded||(SYNO.ux.AddTip(this.getForm().findField("ssh_hw_acc_cipher_only").getEl(),String.format(_T("terminal","ssh_hw_acc_cipher"),t.result[n].data.ssh_hw_acc_cipher_list)),this.sshCipherTipAdded=!0));if(this.getForm().loadRecords(t.result,i.compound),3===this.apiMaxVersion){var o=this.getForm().findField("enable_ssh").getValue();this.getComponent("advBtnId").setDisabled(!o)}this.sendServiceEvent(t)},onBeforeRequest:function(e){if(this.webapi.methods.set!==e)return!0;if(!this.getForm().isValid())return this.module.panel.setStatusError({text:_T("common","forminvalid"),clear:!0}),this.ownerCt.setActiveTab(this.itemId),!1;this.telnetChange=this.getForm().findField("enable_telnet").isDirty(),this.sshChange=this.getForm().findField("enable_ssh").isDirty();let t=this.getWarningMsg();return!this.showDisclaimer||""===t||(this.module.appWin.getMsgBox().alert(this.title,t,null,{useHtml:!0}).then((e=>{"confirm"===e&&(this.showDisclaimer=!1,this.module.panel.applyAllForm(),this.showDisclaimer=!0)})),!1)},sendServiceEvent:function(e){for(var t={api:this.webapi.api,method:this.webapi.methods.set,version:this.webapi.version},i=this.getForm(),s=0;s<e.result.length;s++)if(!1!==SYNO.ux.Utils.checkApiConsistency(t,e.result[s])){this.telnetChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.Terminal.TELNET",!i.findField("enable_telnet").getValue()),this.sshChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.Terminal.SSH",!i.findField("enable_ssh").getValue());break}},getWarningMsg:function(){let e=this.telnetChange&&this.getForm().findField("enable_telnet").getValue(),t=this.sshChange&&this.getForm().findField("enable_ssh").getValue();return e||t?e?_T("terminal","warning_title")+'<br><ul style="list-style:outside; margin-left:16px;"><li>'+_T("terminal","telnet_warning")+"</li><li>"+_T("terminal","terminal_disclaimer")+"</li></ul>":_T("terminal","terminal_disclaimer"):""},errorHandling:function(e){2403==e&&this.getForm().findField("ssh_port").markInvalid(SYNO.API.Erros.core[e]),this.module.appWin.getMsgBox().alert(this.title,_T("error","error_bad_field"))}}),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.TerminalTab.Utils",{statics:{onClickTerminalHelpUrl:function(e){e.appWin.onHelp()},onClickAutoblockUrl:function(e){e.app.startModule("SYNO.SDS.AdminCenter.Security.Main",{tab:"AccountTab"})}}}),Ext.ns("SYNO.SDS.AdminCenter.TerminalSNMP"),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.app=e.app,this.panel=new SYNO.SDS.AdminCenter.TerminalSNMP.TabPanel({module:this})},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"terminal":return"AdminCenter/system_terminal.html";case"snmp":return"AdminCenter/system_snmp.html";default:return"AdminCenter/system_terminal_snmp_desc.html"}},getPanel:function(){return this.panel},setActivateParams:function(e){e&&e.tab&&this.panel.setActiveTab(e.tab)},activate:function(e){this.setActivateParams(e),this.panel.loadAllForm()},deactivate:function(){for(var e=this.panel.getAllForms(),t=0;t<e.length;t++)if(e[t].isDirty())return!1;return!0},confirmLostChangeSave:function(){return this.getPanel().applyHandlerPromise()}}),Ext.define("SYNO.SDS.AdminCenter.TerminalSNMP.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",applyHandlerResolve:Ext.emptyFn,applyHandlerReject:Ext.emptyFn,constructor:function(e){var t;this.module=e.module,this.terminalTab=new SYNO.SDS.AdminCenter.TerminalSNMP.TerminalTab({itemId:"terminal",module:this.module}),t=Ext.apply({activeTab:0,items:[this.terminalTab,new SYNO.SDS.AdminCenter.TerminalSNMP.SNMPTab({itemId:"snmp",module:this.module})]},e),this.callParent([t])},processReturnData:function(e,t,i){if("get"!==e){var s=function(){this.applyHandlerResolve=Ext.emptyFn,this.applyHandlerReject=Ext.emptyFn}.bind(this);if(!0===t.has_fail)return this.errorHandling(t),this.applyHandlerReject(),void s();this.applyHandlerResolve(),s(),this.callParent(arguments)}else this.callParent(arguments)},getAjaxCfg:function(e){return"set"===e?{timeout:18e5}:{}},errorHandling:function(e){var t=SYNO.API.Response.GetFirstError(e),i=_T("common","commfail");if(2403==t.code)return this.terminalTab.errorHandling(t.code),void this.setActiveTab("terminal");SYNO.API.Erros.core[t.code]&&(i=SYNO.API.Erros.core[t.code]),this.module.appWin.getMsgBox().alert(this.title,i)},applyHandler:function(e,t){return this.applyHandlerResolve=Ext.emptyFn,this.applyHandlerReject=Ext.emptyFn,this.applyAllForm()},applyHandlerPromise:function(){var e=this;return new Promise((function(t,i){e.applyHandlerResolve=t,e.applyHandlerReject=i,e.applyAllForm()}))}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.GridView",{extend:"SYNO.ux.GridPanel",cls:"info-center-grid-view",pollingInterval:10,hideHeaders:!0,frame:!0,loadGridData:null,api:null,constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.store=this.createGroupingStore();var t=new Ext.grid.ColumnModel({defaults:{menuDisabled:!1,sortable:!1},columns:[{header:_T("status","header_item"),dataIndex:"name",renderer:this.nameRenderer.createDelegate(this)},{header:_T("status","header_value"),dataIndex:"value",renderer:this.selectableRenderer.createDelegate(this)},{header:"Category",dataIndex:"category",hidden:!0,groupRenderer:function(e,t,i){return i.data.category}}]});this.selModel=new Ext.grid.RowSelectionModel({singleSelect:!0});var i={colModel:t,selModel:this.selModel,store:this.store,listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactivate}};return i.view=new SYNO.ux.GroupingView({forceFit:!0,trackResetOnLoad:!1,showGroupName:!1}),Ext.apply(i,e),i},createGroupingStore:function(){var e=new Ext.data.ArrayReader({},[{name:"name"},{name:"value"},{name:"category"},{name:"subcategory"},{name:"devinfo"}]);return new Ext.data.GroupingStore({reader:e,data:[],groupField:"category",autoDestroy:!0,sortData:function(){}})},onActivate:function(){this.owner=this.module.appWin,void 0===this.pollingID&&(this.pollingID=this.owner.pollReg({interval:this.pollingInterval,immediate:!0,webapi:{api:"SYNO.Entry.Request",version:1,method:"request",params:{mode:"parallel",stopwhenerror:!1,compound:this.api}},status_callback:this.loadGridData,scope:this}))},onDeactivate:function(){void 0!==this.pollingID&&(this.owner.pollUnreg(this.pollingID),this.pollingID=void 0)},getSelectedRowIdx:function(){return this.store.indexOf(this.selModel.getSelected())},selectRow:function(e){this.selModel.selectRow(e)},nameRenderer:function(e,t,i){return'<div class="info-center-field-name">'+e+"</div>"},selectableRenderer:function(e,t,i){var s,n,o;return null===e&&(e="-"),e.match(/^</)?(s='<div class ="{0}">{1}</div>',o=String.format(s,SYNO.SDS.Utils.SelectableCLS,e)):(s='<div class ="{0}" ext:qtip="{2}">{1}</div>',n="USB"===i.data.subcategory?e+"<div>"+i.data.devinfo+"</div>":"editLink"===i.data.subcategory?i.data.devinfo:e,o=String.format(s,SYNO.SDS.Utils.SelectableCLS,e,n)),o}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.OverviewTab",{extend:"SYNO.SDS.AdminCenter.InfoCenter.GridView",title:_T("status","sysinfo_overview_tab"),api:[{api:"SYNO.Core.System",version:3,method:"info"},{api:"SYNO.Core.QuickConnect",version:2,method:"get"},{api:"SYNO.Core.Hardware.FanSpeed",version:1,method:"get"}],constructor:function(e){this.module=e.module,this.replaceWebapiIfXA();var t=this.fillConfig(e);this.callParent([t])},replaceWebapiIfXA:function(){if(this.supportXA()){this.api.push({api:"SYNO.SHA.Util",version:1,method:"send_remote_webapi",params:{remote_api:"SYNO.Core.System",remote_version:3,remote_method:"info"}})}},loadGridData:function(e,t,i,s){var n,o,a,r,l,d=[],c=[],h=[];let u={},p={},_={};const m=this.getSelectedRowIdx(),f=_T("home","home_info_title"),S=_T("controlpanel","leaf_hardware"),g=_T("status","status_time");if(!e)return void SYNO.Debug("[Polling] action Failed.");let y=this.processQuickConnectInfo(t);if(_=this.processFanInfo(t),this.supportXA()){if(this.checkXAActiveFailure(t))return void SYNO.Debug("[Polling] XA active webapi Failed");[u,p]=this.processXAInfo(t)}t=this.getActiveApi(t);let b=this.showServerName(t,d,f);this.supportXA()?d=d.concat(this.getXADataSection(_T("status","status_version"),u.firmware_ver,p.firmware_ver,f)):d.push([_T("status","status_version"),t.firmware_ver,f]);let v=this.showSynologyAccount(y,d,f),x=this.showQuickConnectId(y,d,f);if("yes"==_D("support_mtd_serial"))if(this.supportXA())d.push([_T("common","ds_serial"),String.format("{0} - {1}",t.serial,_T("common","chassis"))]),d=d.concat(this.getXADataSection("",u.origin_serial,p.origin_serial,S));else if(!0===_S("ha_running")){const e=String.format('<div class="syno-ha-serial"><div>{0}</div><div ext:wtip="{1}" class=" syno-ux-whitetip-icon"></div></div>',t.serial,_T("common","more_sn_detail_on_sha"));d.push([_T("common","cluster_serial"),e])}else d.push([_T("common","ds_serial"),t.serial]);if(Ext.isDefined(t.model_customized)?d.push([_T("common","ds_model"),t.model_customized]):d.push([_T("common","ds_model"),t.model]),Ext.isDefined(t.cpu_vendor)&&Ext.isDefined(t.cpu_family)&&Ext.isDefined(t.cpu_series)&&d.push([_T("status","cpu_model_name"),String.format("{0} {1} {2}",t.cpu_vendor,t.cpu_family,t.cpu_series)]),Ext.isDefined(t.cpu_clock_speed)&&(t.cpu_clock_speed<1e3?(l=Math.round(t.cpu_clock_speed),d.push([_T("status","cpu_clock_speed"),l+" MHz"])):(l=Math.round(t.cpu_clock_speed/10)/100,d.push([_T("status","cpu_clock_speed"),l+" GHz"]))),Ext.isDefined(t.cpu_num)&&d.push([_T("status","cpu_num"),t.cpu_num]),Ext.isDefined(t.cpu_cores)&&d.push([_T("status","cpu_cores"),t.cpu_cores]),Ext.isDefined(t.cpu1_core)&&d.push([_T("status","cpu1_core"),t.cpu1_core]),Ext.isDefined(t.cpu2_core)&&d.push([_T("status","cpu2_core"),t.cpu2_core]),Ext.isDefined(t.ram_size)&&(this.supportXA()?d=d.concat(this.getXADataSection(_T("status","ramsize"),u.ram_size,p.ram_size,S,this.processRamSize)):d.push([_T("status","ramsize"),this.processRamSize(t.ram_size)])),this.supportNvidiaGPU()){var w=_T("status","no_device_detected");d.push([_T("status","gpu"),t.gpu&&t.gpu.name||w],[_T("status","gpu_clock_rate"),t.gpu&&t.gpu.clock||w],[_T("status","gpu_total_memory"),t.gpu&&t.gpu.memory||w])}if(t.support_rp&&!SYNO.SDS.Utils.isInVirtualDSM()&&"yes"!==_D("dockerdsm")&&d.push([_T("system","power_supply")+"1",1===t.rp1?_T("volume","volume_status_normal"):'<font class="red-status" ext:qtip="'+_T("common","status_abnormal")+'">'+_T("common","status_abnormal")+"</font>"],[_T("system","power_supply")+"2",1===t.rp2?_T("volume","volume_status_normal"):'<font class="red-status" ext:qtip="'+_T("common","status_abnormal")+'">'+_T("common","status_abnormal")+"</font>"]),Ext.isDefined(t.support_esata)&&(this.support_esata=t.support_esata),t.eunit)for(n=0;n<t.eunit.length;n++)a=(o=t.eunit[n]).model?o.model:"Expansion Unit",d.push([a+_T("system","power_supply")+"1",1===o.rp1?_T("volume","volume_status_normal"):'<font class="red-status" ext:qtip="'+_T("common","status_abnormal")+'">'+_T("common","status_abnormal")+"</font>"],[a+_T("system","power_supply")+"2",1===o.rp2?_T("volume","volume_status_normal"):'<font class="red-status" ext:qtip="'+_T("common","status_abnormal")+'">'+_T("common","status_abnormal")+"</font>"]);if("yes"===_D("supportsystempwarning")&&null!==t.sys_tempwarn&&(this.supportXA()?d=d.concat(this.getXADataSection(_T("status","CPU_temperature"),{sys_temp:u.sys_temp,sys_tempwarn:u.sys_tempwarn},{sys_temp:p.sys_temp,sys_tempwarn:p.sys_tempwarn},S,this.getSysTemperature.bind(this))):Ext.isDefined(t.sys_temp)&&Ext.isDefined(t.sys_tempwarn)&&d.push([_T("status","CPU_temperature"),this.getSysTemperature({sys_temp:t.sys_temp,sys_tempwarn:t.sys_tempwarn})])),this.supportNvidiaGPU())if(t.gpu&&[t.gpu.temperature_c,t.gpu.tempwarn].every(Ext.isDefined)){var T=this.renderTempFromC(t.gpu.temperature_c),C=t.gpu.tempwarn?"syno-temperature-color-overheat":"syno-temperature-color-normal",D=t.gpu.tempwarn?_T("system","over_temperature"):_T("helpbrowser","font_normal"),N=String.format('<div {0} class="syno-sysinfo-temperature"><div {0} class="syno-temperature-dot {1}" ></div><div {0} class="syno-temperature-text {1}">{2}</div></div>','ext:qtip="'+T+'"',C,D);d.push([_T("status","gpu_thermal_status"),N])}else d.push([_T("status","gpu_thermal_status"),_T("status","no_device_detected")]);Ext.each(d,(function(e){2===e.length&&e.push(S)})),"yes"===_D("dockerdsm")||SYNO.SDS.Utils.isInVirtualDSM()||(c=this.formatExternalDeviceInfo(t,_));var k=d.concat(c);r=t.hasOwnProperty("time_zone_desc")?t.time_zone_desc:t.time_zone,"yes"===_D("support_sys_time")&&h.push([_T("time","ntp_server"),t.enabled_ntp?t.ntp_server:t.ntp_server+" "+_T("status","status_not_enabled"),g]),h.push([_T("status","status_timezone"),r,g]),h.push([_T("status","sys_time"),SYNO.SDS.DateTimeFormatter(Date.parseDate(t.time,"Y-n-j G:i:s"),{type:"datetimesec"}),g]),this.supportXA()?h=h.concat(this.getXADataSection(_T("status","uptime"),u.up_time,p.up_time,g,this.formatUpTime)):h.push([_T("status","uptime"),this.formatUpTime(t.up_time),g]),k=k.concat(h),this.store.loadData(k),_S("is_admin")&&(this.mon(Ext.get(b),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Network.Main"})}),this),this.mon(Ext.get(v),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.SynologyAccount.Main"})}),this),this.mon(Ext.get(x),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.PublicAccess.Main"})}),this)),this.selectRow(m)},C2F:function(e){return 9*e/5+32},renderTempFromC:function(e){var t=this.C2F(e);return String.format("{0} {1} / {2} {3}",Math.round(e),_T("status","celsius"),Math.round(t),_T("status","fahrenheit"))},supportNvidiaGPU:function(){return"yes"===_D("support_nvidia_gpu")},formatUpTime:function(e){if(!e)return null;var t="",i=e.indexOf(":",0),s=e.substring(0,i),n=e.indexOf(":",i+1),o=parseInt(e.substring(i+1,n),10),a=parseInt(e.substring(n+1,e.length),10),r=((s=parseInt(s,10))-s%24)/24;return s%=24,t=r?String.format("{0} {1} ",r,_T("status","status_day")):"",t+=s||""!==t?String.format("{0} {1} ",s,_T("status","status_hour")):"",t+=o||""!==t?String.format("{0} {1} ",o,_T("status","status_minute")):"",t+=a||""!==t?String.format("{0} {1}",a,_T("status","status_second")):""},formatExternalDeviceInfo:function(e,t){var i=[],s=_T("controlpanel","leaf_hardware"),n="";i=(i=(i=this.formatUSBInfo(e.usb_dev,s)).concat(this.formatESATAInfo(e.sata_dev,s))).concat(this.formatSDInfo(e.sd_dev,s)),e.external_pci_slot_info.sort((function(e,t){var i=parseInt(e.slot,10),s=parseInt(t.slot,10);return i>s?1:i<s?-1:0}));for(var o=0;o<e.external_pci_slot_info.length;o++){var a,r=e.external_pci_slot_info[o];a="yes"!==r.Occupied?[String.format("PCIe Slot {0}",r.slot),"-",s]:"yes"!=r.Recognized?[String.format("PCIe Slot {0}",r.slot),_T("common","occupied"),s]:[String.format("PCIe Slot {0}",r.slot),String.format("Synology {0}",r.cardName),s],i.push(a)}return"quietfan"===t.dual_fan_speed?n="rcfancontrol_quiet":"coolfan"===t.dual_fan_speed?n="rcfancontrol_cool":"fullfan"===t.dual_fan_speed&&(n="rcfancontrol_full"),i.unshift([_T("rcpower","rcfancontrol_desc"),_T("rcpower",n),s]),i},formatSDInfo:function(e,t){var i=[],s=Ext.util.Format.htmlEncode;if(("yes"==_D("sdcopy")||"yes"===_D("usbstation"))&&e)for(var n=0;n<e.length;n++){var o=e[n],a=o.producer?s(o.producer):_T("usb","usb_type_unknown"),r=[_T("tree","leaf_sdcard"),a,t];i.push(r)}return i},formatESATAInfo:function(e,t){var i=[],s=Ext.util.Format.htmlEncode;if(("no"!==this.support_esata||"yes"===_D("supportsas","no"))&&e)for(var n=0;n<e.length;n++){var o,a=e[n],r=a.id?" "+a.id:"",l=a.isEUnit?_T("volume","volume_disk_source_ebox")+r:_T("status","status_sata");if("normal"===a.status)o=[l,a.model?s(a.model):_T("usb","usb_type_unknown"),t];else o=[l,_T("usb","usb_st_fail"),t];i.push(o)}return i},formatUSBInfo:function(e,t){var i=[],s=Ext.util.Format.htmlEncode,n={printer:_T("tree","leaf_usbprint"),audio:_T("usb","usb_type_audio"),disk:_T("tree","leaf_usbdisk_header"),hub:_T("usb","usb_type_hub"),remote:_T("usb","usb_type_remote_control"),scard:_T("usb","usb_type_scard"),ups:_T("tree","leaf_ups"),other:_T("status","status_usb")};function o(e){for(var t="",i=0;i<e;i++)t+="&nbsp; &nbsp; &nbsp;";return t}for(var a=0;a<e.length;a++){var r=e[a],l=r.producer?s(r.producer):_T("usb","usb_type_unknown"),d=r.product?s(r.product):_T("usb","usb_type_unknown");if(r.cls in n){var c=[o(r.level)+n[r.cls],d+" - "+l,t,"USB","VID:"+r.vid+" PID:"+r.pid+" REV:"+r.rev];i.push(c)}}return i},getSysTemperatureTip:function(e){let t="";if("yes"==_D("supportsystemperature")){const i=String.format("{0} {1}",e,_T("status","celsius")),s=String.format("{0} {1}",this.C2F(e).toFixed(0),_T("status","fahrenheit"));t=String.format("{0} / {1}",i,s),t='ext:qtip="'+t+'"'}return t},getSysTemperature:function(e){if(void 0===e.sys_tempwarn||void 0===e.sys_temp)return null;const t=this.getSysTemperatureTip(e.sys_temp),i=e.sys_tempwarn?"syno-temperature-color-overheat":"syno-temperature-color-normal",s=e.sys_tempwarn?_T("system","over_temperature"):_T("helpbrowser","font_normal");return String.format('<span {0} class="syno-sysinfo-temperature"><span {0} class="syno-temperature-dot {1}" ></span><span {0} class="syno-temperature-text {1} ">{2}</span></span>',t,i,s)},processRamSize:function(e){if(!e)return null;let t=0;return 10240<=e?(t=Math.round(10*e/1024)/10,t+" "+_T("common","size_gb")):(t=e,t+" "+_T("common","size_mb"))},supportXA:function(){return"yes"===_D("support_xa")},checkXAActiveFailure:function(e){if(!this.supportXA())return!1;const t=(e=>{if(Ext.isObject(e)&&Ext.isBoolean(e.has_fail)&&e.has_fail&&Ext.isArray(e.result)){return e.result.find((e=>Ext.isObject(e)&&!e.success))}})(e);return!!t&&"SYNO.Core.System"===t.api},processFanInfo:function(e){return SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Hardware.FanSpeed","get")||{}},getActiveApi:function(e){return SYNO.API.Response.GetValByAPI(e,"SYNO.Core.System","info")},getXAPassiveApi:function(e){return SYNO.API.Response.GetValByAPI(e,"SYNO.SHA.Util","send_remote_webapi")||{}},processXAInfo:function(e){const t=this.getActiveApi(e),i=this.getXAPassiveApi(e);return 0===t.controller_location?[t,i]:[i,t]},processQuickConnectInfo:function(e){return SYNO.API.Response.GetValByAPI(e,"SYNO.Core.QuickConnect","get")},getXADataSection:function(e,t,i,s,n=(e=>e)){const o=(e,t)=>e?String.format("{0} - {1}",e,String.format(_T("volume","controller_i"),t)):String.format(_T("common","offline_controller_i"),t);return[[e,o(n(t),"A"),s],["",o(n(i),"B"),s]]},pushEditLink:function(e,t,i,s,n){let o=Ext.id(),a="";return a=_S("is_admin")?String.format('{0} (<a href="#" id="{1}" class="link-font info-center-list-edit-link">{2}</a>)',n,o,_T("common","alt_edit")):String.format("{0}",n),e.push([t,a,i,s,n]),o},showServerName:function(e,t,i){return this.pushEditLink(t,Ext.util.Format.htmlEncode(_T("tcpip","server_name")),i,"editLink",_S("hostname"))},showSynologyAccount:function(e,t,i){let s="-";return Ext.isObject(e)&&Ext.isString(e.myds_account)&&!Ext.isEmpty(e.myds_account)&&(s=e.myds_account),this.pushEditLink(t,_T("controlpanel","synology_account"),i,"editLink",s)},showQuickConnectId:function(e,t,i){let s="-";return Ext.isObject(e)&&Ext.isBoolean(e.enabled)&&!0===e.enabled&&Ext.isString(e.server_alias)&&!Ext.isEmpty(e.server_alias)&&(s=e.server_alias),this.pushEditLink(t,_T("welcome","welcome_quickcnt_id"),i,"editLink",s)}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.NetworkTab",{extend:"SYNO.SDS.AdminCenter.InfoCenter.GridView",title:_T("tree","leaf_lan"),api:[{api:"SYNO.Core.System",version:1,method:"info",type:"network"},{api:"SYNO.Core.DDNS.Record",version:1,method:"list"}],constructor:function(e){this.module=e.module,this.owner=e.owner;var t=this.fillConfig(e);this.callParent([t])},makeCompoundRequest:function(){this.api={compound:{stopwhenerror:!1,params:this.api}}},loadGridData:function(e,t,i){var s,n,o,a=this,r=this.getSelectedRowIdx(),l=(n=_T("status","status_empty_config"),o=[],{append:function(e,t){if(!s)throw Error("group name is not set");o.push([e,t||n,s])},start:function(e){s=e},getData:function(){return o}});if(!e)return void SYNO.Debug("[Polling] action Failed.");let d=this.getSystemApiVal(t);Ext.isArray(d.nif)?(l.start(_T("home","home_info_title")),l.append(_T("status","status_name"),d.hostname),l.append(_T("status","status_dns"),d.dns),l.append(_T("status","status_gateway"),d.gateway),l.append(d.enabled_samba&&d.enabled_domain?_T("network","wnds_domain"):_T("network","wnds_group"),d.enabled_samba?d.workgroup:void 0),l.append(_T("status","status_wins"),d.enabled_samba?d.wins:void 0),this.processDDNSInfo(t,l),Ext.each(d.nif,(function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.getStatus(e.status),i=SYNO.SDS.AdminCenter.Network.Utils.GetLinkStatus(e.speed,e.duplex,e.mtu),s=e.addr;e.use_dhcp?s+=` (${_T("network","ip_assign_dhcp")})`:s+=` (${_T("network","ip_assign_static")})`,l.start(SYNO.SDS.Utils.Network.idToString.apply(a,[e.id,e.type])),l.append(_T("tunnel","tunnel_status"),t),l.append(_T("status","status_addr"),e.mac),l.append(_T("status","status_ipaddr"),s),l.append(_T("status","status_mask"),e.mask),Ext.isArray(e.ipv6)&&!0!==_S("ha_not_support_ipv6")&&Ext.each(e.ipv6,(function(e){l.append(_T("status","status_ipv6addr"),String.format("{0}/{1}\t{2}:{3}",e.addr,e.prefix_len,_T("tcpip","ipv6_scope"),_T("tcpip","ipv6_scope_"+e.scope)))})),0<e.speed&&l.append(_T("tcpip","link_status"),i)})),this.store.loadData(l.getData()),this.selectRow(r)):SYNO.Debug("wrong response")},processDDNSInfo:function(e,t){let i=this.getDDNSApiVal(e);Ext.isObject(i)&&Ext.isArray(i.records)&&i.records.forEach((e=>{if(Ext.isObject(e)&&Ext.isBoolean(e.enable)&&!0===e.enable){let i=function(e){let t="<span>"+e.hostname+"</span>";"service_ddns_normal"===e.status&&(t='<span ext:qtip="'+("0.0.0.0"!==e.ip?e.ip:e.ipv6)+'">'+e.hostname+"</span>");return t}(e),s=SYNO.SDS.AdminCenter.PublicAccess.DDNSTransferStatus(this,e.status,this.provider);t.append(_T("service","service_ddns_legend"),i+" ("+s+")")}}))},getSystemApiVal:function(e){return SYNO.API.Response.GetValByAPI(e,"SYNO.Core.System","info")},getDDNSApiVal:function(e){return SYNO.API.Response.GetValByAPI(e,"SYNO.Core.DDNS.Record","list")}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.StorageTab",{extend:"Ext.Panel",title:_T("status","sysinfo_storage_tab"),padding:"0",isUSBStation:null,supportBuildinStorage:null,numPerPage:3,pageIndex:1,pollingInterval:30,constructor:function(e){this.module=e.module,this.isUSBStation="yes"===_D("usbstation","no"),this.supportBuildinStorage="yes"===_D("support_buildin_storage","no");var t=this.fillConfig(e);this.callParent([t])},needHDDField:function(){return!SYNO.SDS.Utils.isInVirtualDSM()&&"yes"!==_D("dockerdsm")},fillConfig:function(e){this.emptyPanel=new SYNO.ux.Panel({height:188}),this.isUSBStation?this.hddGridPanel=this.createHDDGrid_USBStation():this.hddGridPanel=this.createHDDGrid(),this.volGridPanel=this.createVolumeGrid(),this.volPrevId=Ext.id(void 0,"sysinfo_vol_prev_"),this.volNextId=Ext.id(void 0,"sysinfo_vol_next_"),this.volId=Ext.id(void 0,"sysinfo_vol_"),this.volChartId=Ext.id(void 0,"sysinfo_vol_chart_"),this.volNameId=Ext.id(void 0,"sysinfo_vol_name_"),this.volHlId=Ext.id(void 0,"sysinfo_vol_hl_"),this.volDescId=Ext.id(void 0,"sysinfo_vol_desc_"),this.volTextId=Ext.id(void 0,"sysinfo_vol_text_"),this.volField=new SYNO.ux.FieldSet({stateId:"SYNO.SDS.AdminCenter.InfoCenter.Main::storage::volume",title:_T("volume","volume_info"),collapsible:!1,cls:"syno-sysinfo-fieldset",style:{"margin-top":"8px"},items:[this.emptyPanel,this.volGridPanel]}),this.hddField=new SYNO.ux.FieldSet({stateId:"SYNO.SDS.AdminCenter.InfoCenter.Main::storage::hdd",title:this.isUSBStation?_T("tree","node_device"):_T("status","status_hdd"),collapsible:!1,cls:"syno-sysinfo-fieldset",items:this.hddGridPanel});var t={layout:"form",listeners:{scope:this,resize:this.onResize,activate:this.onActivate,deactivate:this.onDeactivate},items:[this.volField]};return this.needHDDField()&&t.items.push(this.hddField),Ext.apply(t,e),t},getMidHeight:function(){var e=this.module.appWin.getHeight()-155;return this.needHDDField()?e/2:e},onResize:function(){var e=this.getMidHeight();this.emptyPanel.hide(),this.volGridPanel.setHeight(e),this.hddGridPanel.isVisible()&&(this.volGridPanel.isVisible()?this.hddGridPanel.setHeight(e):this.hddGridPanel.setHeight(this.module.appWin.getHeight()-379)),this.doLayout()},onActivate:function(){this.owner=this.module.appWin,void 0===this.pollingID&&(this.pollingID=this.owner.pollReg({interval:this.pollingInterval,immediate:!0,webapi:{api:"SYNO.Core.System",version:1,method:"info",params:{type:"storage_v2"}},status_callback:this.loadStorageInfo,scope:this}))},onDeactivate:function(){void 0!==this.pollingID&&(this.owner.pollUnreg(this.pollingID),this.pollingID=void 0)},getHddSelectedRowIdx:function(){return this.hddStore.indexOf(this.hddSelModel.getSelected())},selectHddRow:function(e){this.hddSelModel.selectRow(e)},loadStorageInfo:function(e,t,i,s){var n,o,a,r,l,d=null,c=null,h=null,u=0;if(e){if(n=t,l=this.getHddSelectedRowIdx(),this.isUSBStation){for(d=[],o=0;n.devices&&o<n.devices.length;++o)if((c=n.devices[o]).partitions&&c.partitions.length>0)for(a=0;a<c.partitions.length;++a)d.push({status:c.partitions[a].status,total_size:1024*parseInt(c.partitions[a].total_size_mb,10)*1024,used_size:1024*parseInt(c.partitions[a].used_size_mb,10)*1024,name:c.partitions[a].share_name,volstr:c.partitions[a].share_name}),++u;else++u;h=this.formatHDDInfo_USBStation(n.devices)}else d=n.vol_info,h=this.formatHDDInfo(n.hdd_info);null!==d&&""!==d||(d=[]),this.supportBuildinStorage&&this.isUSBStation&&(d.unshift({status:n.vol_info[0].status,total_size:n.vol_info[0].total_size,used_size:n.vol_info[0].used_size,name:n.vol_info[0].name,volstr:_T("system","system_volume")}),++u),this.isUSBStation||(u=d.length),this.isDestroyed||(this.loadVolumes(d,u),this.hddGridPanel.isVisible()&&(r=this.hddGridPanel.view.getScrollState(),this.hddStore.loadData(h),this.hddGridPanel.view.setScroll(r.top,r.left)),this.selectHddRow(l))}else SYNO.Debug("[Polling] action Failed.")},formatHDDInfo:function(e){var t=!1,i=[],s=SYNO.SDS.Utils.StorageUtils;if(!e)return i;for(var n=0;n<e.length;n++){var o,a,r=e[n],l=(t="no_disk"==r.status||!r.status)?"-":r.model,d=[this.getDiskName(r.i18nNamingInfo),l,s.UiRenderHelper.DiskSummaryStatusRender(r.summary_status_category,r.summary_status_key,r.testing_progress)],c=s.SpaceIDParser(r.allocation_role).str;if(a=t?"-":s.UiRenderHelper.SizeRender(r.size_total),"no"!=_D("showdisktemperature")){let e=SYNO.SDS.Utils.StorageUtils.UiRenderHelper;o=!t&&e.DiskCanShowInfo(r.compatibility)?s.UiRenderHelper.DiskTemperatureRender(r.temp):"-",d.push(o)}"yes"===_D("supportsas","no")&&d.push(r.diskType);var h=1;"System"===r.disk_location&&(h=0),d.push(a,c,h,r.portType,r.num_id,r.container.order,r.pciSlot),i.push(d),i.sort(this.diskNameSort)}return i},getDiskName:function(e){return SYNO.SDS.Utils.StorageUtils.UiRenderHelper.DiskDisplayNameGet(e,!1)},diskNameSort:function(e,t){var i=e[e.length-3],s=t[t.length-3],n=e[e.length-2],o=t[t.length-2],a=e[e.length-4],r=t[t.length-4],l=e[e.length-1],d=t[t.length-1],c=e[e.length-5],h=t[t.length-5];return c>h?1:c<h||a.length>r.length?-1:a.length<r.length||l>d?1:l<d?-1:n>o?1:n<o?-1:i>s?1:i<s?-1:0},C2F:function(e){return 9*e/5+32},createHDDGrid_USBStation:function(){this.hddStore=new Ext.data.ArrayStore({fields:["device_display_name","producer","product","filesystem","status","sharedfolder"],autoDestroy:!0}),this.hddSelModel=new Ext.grid.RowSelectionModel({singleSelect:!0});var e=new Ext.grid.ColumnModel({defaults:{align:"center",useHtmlEncodeRender:!1,sortable:!1},columns:[{header:_T("common","name"),dataIndex:"device_display_name",width:.2,align:"left"},{header:_T("usb","usb_producer"),dataIndex:"producer",width:.2,align:"left"},{header:_T("usb","usb_devname"),dataIndex:"product",width:.2,align:"left"},{header:_T("usb","usb_FStype"),dataIndex:"filesystem",width:.1,align:"left"},{header:_T("usb","usb_status"),dataIndex:"status",width:.1,align:"left"},{header:_T("usb","usb_shname"),dataIndex:"sharedfolder",width:.2,align:"left"}]});return new SYNO.ux.GridPanel({store:this.hddStore,enableColumnHide:!1,enableColumnMove:!1,enableColumnResize:!0,enableHdMenu:!1,selModel:this.hddSelModel,colModel:e})},createHDDGrid:function(){var e=["diskno","model","status"];"no"!=_D("showdisktemperature")&&e.push("temp"),"yes"===_D("supportsas","no")&&e.push("diskType"),e.push("capacity","allocRole"),this.hddStore=new Ext.data.ArrayStore({fields:e,autoDestroy:!0}),this.hddSelModel=new Ext.grid.RowSelectionModel({singleSelect:!0});var t=[{header:_T("disk_info","disk_id_title"),align:"left",dataIndex:"diskno"},{header:_T("volume","volume_diskmodel"),align:"left",dataIndex:"model",tpl:String.format('<span class="{0}" ext:qtip="{model}">{model}</span>',SYNO.SDS.Utils.SelectableCLS)}];"no"!=_D("showdisktemperature")&&t.push({header:_T("status","temperature"),align:"left",dataIndex:"temp"}),"yes"===_D("supportsas","no")&&t.push({header:_T("volume","volume_disk"),align:"left",dataIndex:"diskType"}),t.push({header:_T("volume","volume_diskcapacity"),align:"left",dataIndex:"capacity"},{header:_T("volume","volume_diskstatus"),align:"left",dataIndex:"status"},{header:_T("disk_info","disk_field_allocation_role_title"),align:"left",dataIndex:"allocRole",tpl:'<span ext:qtip="{allocRole}">{allocRole}</span>'});var i=new Ext.grid.ColumnModel({defaults:{align:"center",useHtmlEncodeRender:!1,sortable:!1},columns:t});return new SYNO.ux.GridPanel({store:this.hddStore,enableColumnHide:!1,enableColumnMove:!1,enableColumnResize:!0,enableHdMenu:!1,selModel:this.hddSelModel,colModel:i})},createVolumeGrid:function(){var e=new Ext.data.ArrayStore({fields:["id","total","used","percent","desc"],autoDestroy:!0});return new SYNO.ux.GridPanel({store:e,enableColumnHide:!1,enableColumnMove:!1,enableColumnResize:!0,enableHdMenu:!1,hidden:!0,colModel:new Ext.grid.ColumnModel({defaults:{sortable:!1,align:"center",width:100},columns:[{header:_T("common","name"),align:"left",dataIndex:"id"},{header:_T("share","share_comment"),align:"left",dataIndex:"desc",renderer:function(e,t,i){return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(e)+'"',e||"-"}},{header:String.format("{0} (%)",_T("volume","volume_usedsize")),align:"left",dataIndex:"percent",width:130,css:"vertical-align: middle;",renderer:function(e,t,i,s,n,o){var a=0;a="-"===i.data.percent?"-":Math.ceil(i.data.percent);var r=new SYNO.SDS.Utils.PercentageBar({barWidth:120,barHeight:0,lineHeight:28,showValueText:!0});return new Ext.XTemplate("{progressBar}").apply({progressBar:r.fill(a)})}},{header:_T("volume","volume_usedsize"),align:"left",dataIndex:"used"},{header:_T("volume","volume_totalsize"),align:"left",dataIndex:"total",width:130}]})})},loadVolumes:function(e,t){var i;if(0===t)return this.showVolPanel("empty"),void this.emptyPanel.body.mask(_T("volume","volume_no_volumes"),"syno-ux-mask-info");e.sort(this.sortVolume),i=this.formatVolumeInfo(e,[]),this.showVolPanel("grid"),this.volIsChg(e,this.orgVolInfo)&&(this.volGridPanel.getStore().loadData(i),this.orgVolInfo=e)},sortVolume:function(e,t){var i,s;if(-1<e.name.indexOf("volume")&&-1===t.name.indexOf("volume"))return-1;if(-1===e.name.indexOf("volume")&&-1<t.name.indexOf("volume"))return 1;if(-1<e.name.indexOf("volume")&&-1<t.name.indexOf("volume"))return parseInt(e.name.replace("volume_",""),10)>parseInt(t.name.replace("volume_",""),10)?1:-1;for(i=e.name.replace("usbshare","").replace("-",""),s=t.name.replace("usbshare","").replace("-","");i.length<4;)i+="0";for(;s.length<4;)s+="0";return i>s?1:-1},formatVolumeInfo:function(e,t){var i,s,n,o,a,r,l,d,c,h=[],u=SYNO.SDS.Utils.StorageUtils;for(this.pageCount=Math.ceil(e.length/this.numPerPage),r=0;r<e.length;r++)i=e[r],parseInt(i.total_size)<=1&&parseInt(i.used_size)<=0?(n="-",o="-",a="-"):(d=u.UiRenderHelper.GetSizeUnit(i.total_size),c=u.UiRenderHelper.GetSizeUnit(i.used_size),n=d.size+" "+d.unit,o=c.size+" "+c.unit,a=Math.floor(100*i.used_size/i.total_size)),s=i.volstr||("0"===i.name?"-":u.SpaceIDParser(i.name).str),l=Ext.util.Format.htmlEncode(i.vol_desc),h.push([s,n,o,a,l]);return h},volIsChg:function(e,t){var i="",s="";return e&&(i=Ext.encode(e)),t&&(s=Ext.encode(t)),i!=s},showVolPanel:function(e){var t,i=!1;return this.onResize(),"grid"==e?(this.volGridPanel.isVisible()||(this.volGridPanel.show(),i=!0),t=this.volGridPanel):(this.volGridPanel.hide(),this.emptyPanel.show()),i&&this.doLayout(),t},setVolButtonStatus:function(e,t){var i=Ext.get(e);if(t){if(i.hasClass("sm-infocenter-vol-btn-enable"))return;i.addClass("sm-infocenter-vol-btn-enable"),i.setARIA({disabled:!1})}else i.removeClass("sm-infocenter-vol-btn-enable"),i.setARIA({disabled:!0})},formatPartitionInfo_USBStation:function(e){var t=[];return(t=[e.partition_title,e.producer,e.product]).push(SYNO.SDS.Utils.ExternalDevices.getFilesystem(e.filesystem)),t.push(SYNO.SDS.Utils.ExternalDevices.getStatus(e.status)),t.push(e.share_name?e.share_name:_T("usb","usb_notmounted")),t},formatHDDInfo_USBStation:function(e){var t,i,s,n,o=[];for(t=0;e&&t<e.length;t++)if((s=e[t]).partitions&&s.partitions.length>0)for(i=0;i<s.partitions.length;++i)n=this.formatPartitionInfo_USBStation(s.partitions[i]),o.push(n);else n=this.formatPartitionInfo_USBStation(s),o.push(n);return o}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.ServiceListTab",{extend:"SYNO.ux.GridPanel",errRetryCount:0,initEvents:function(){this.callParent([arguments]),this.mon(this,"activate",this.onActivate,this)},constructor:function(e){this.module=e.module,this.owner=e.owner,this.setAPIName(),this.apiCheckPortArray=this.createAPICheckPortArray(),this.apiEnumArray=this.createAPIEnumArray(),this.store=this.createStore(e);var t=this.fillConfig(e);this.callParent([t])},onActivate:function(){this.records||this.reloadAllInfo()},onLeave:function(){this.records=null,this.store.rejectChanges()},reloadAllInfo:function(){this.module.appWin.setStatusBusy(null,_T("common","loading")),this.store.removeAll(),this.loadNetIF()},fillConfig:function(e){const t=(e,t)=>{const i=Ext.util.Format.htmlEncode(t),s=Ext.util.Format.htmlEncode(e);return String.format('<div ext:qtip="{0}">{1}</div>',i,s)};var i=new Ext.grid.ColumnModel({defaults:{width:100,align:"left"},columns:[{header:_T("service","enabled_service"),width:80,dataIndex:"display_name",align:"left",menuDisabled:!0,renderer:function(e){return'<div ext:qtip="'+e+'">'+e+"</div>"}},{header:_T("routerconf","routerconf_header_ds_port"),dataIndex:"ds_port",align:"left",menuDisabled:!0,renderer:function(e,i,s){return""===s.data.fwInfo?t("-",_T("service","service_port_config_not_specify")):t(e,e)}},{header:_T("service","configured_router_port"),dataIndex:"router_port",align:"left",menuDisabled:!0,renderer:function(e,i,s){return""===s.data.fwInfo?t("-",_T("service","service_port_config_not_specify")):"-"===e||"router_not_configured"===e?t("-",_T("app_port_alias","not_configured")):t(e,e)}},{header:_T("service","service_allow_on_firewall"),dataIndex:"firewall",renderer:function(e,i,s){const n={true:_T("nfs","nfs_nonprivileged_port_allow"),false:_T("nfs","nfs_nonprivileged_port_deny"),gray:_T("service","service_partial_netif_allow")};return""===s.data.fwInfo?t("-",_T("service","service_port_config_not_specify")):t(n[e],s.data.fwDesc)},scope:this},{header:_T("mediaservice","type"),dataIndex:"service_type",hideable:!1,hidden:!0,renderer:function(e){return"internal_service"===e?_T("service","internal_service"):"packages"===e?_T("pkgmgr","title_packages"):void 0}}]}),s={title:_T("service","service_subject"),colModel:i,store:this.store,view:new SYNO.ux.GroupingView({showGroupName:!1,enableGroupingMenu:!1})};return Ext.apply(s,e),s},setAPIName:function(){this.GetRouterConfAPI={api:"SYNO.Core.PortForwarding.RouterConf",method:"get",version:1},this.ListServieAPI={api:"SYNO.Core.Service",method:"get",version:3,params:{additional:["active_status"]}},this.ListPackageAPI={api:"SYNO.Core.Package",method:"list",version:1,params:{additional:["status"]}},this.CheckFwRuleAPI={api:"SYNO.Core.Security.Firewall.Rules.Serv",method:"policy_check",version:1,params:{adapter:"",service_id:[]}},this.GetFwSecPortAPI={api:"SYNO.Core.Service.PortInfo",method:"load",version:1,params:{service_id:[]}},this.CheckPfRuleAPI={api:"SYNO.Core.PortForwarding.Rules.Serv",method:"check",version:1,params:{service_id:[]}},this.ListNetIFAPI={api:"SYNO.Core.Network.Interface",method:"list",version:1}},createAPICheckPortArray:function(){return[this.CheckFwRuleAPI,this.GetFwSecPortAPI,this.CheckPfRuleAPI]},createAPIEnumArray:function(){return[this.ListServieAPI,this.ListPackageAPI]},getNetAPIArray:function(){return[this.ListNetIFAPI,this.GetRouterConfAPI]},createStore:function(e){return new SYNO.SDS.AdminCenter.InfoCenter.ServiceList.Store},loadNetIF:function(){this.sendWebAPI({compound:{stopwhenerror:!1,params:this.getNetAPIArray(),mode:"parallel"},callback:this.loadNetIFCB,scope:this})},getModelIndex:function(e){var t=this.getColumnModel().columns,i=0;return Ext.each(t,(function(t){if(t.dataIndex===e)return i=t.id,!1}),this),i},loadNetIFCB:function(e,t,i){var s,n,o={};if(this.IFRecords=[],this.hidePfcolumn=!1,!e||t.has_fail)for(var a=t.result,r=0;r<a.length;r++)if(!a[r].success)return this.module.appWin.clearStatus(),void this.view.el.mask(SYNO.API.getErrorString(a[r].error.code),"syno-ux-mask-info");return this.view.el.unmask(),o.value="all",o.display=_T("service","service_all_interface"),this.IFRecords.push(o),void 0===(s=SYNO.API.Response.GetValByAPI(t,this.ListNetIFAPI.api,"list"))?(this.module.appWin.getMsgBox().alert(this.title,_T("common","commfail")),void this.module.appWin.clearStatus()):(this.updateIFRecord(s),void 0===(n=SYNO.API.Response.GetValByAPI(t,this.GetRouterConfAPI.api,this.GetRouterConfAPI.method))?(this.module.appWin.getMsgBox().alert(this.title,_T("common","commfail")),void this.module.appWin.clearStatus()):(""===n.router_model&&""===n.router_brand&&""===n.router_version&&(this.hidePfcolumn=!0),this.getColumnModel().setHidden(this.getModelIndex("router_port"),this.hidePfcolumn),void this.enumServ()))},updateIFRecord:function(e){var t=this;e.sort(SYNO.SDS.AdminCenter.Network.Utils.SortFunc),Ext.each(e,(function(e){var i={};i.value=e.ifname,i.type=e.type,i.display=SYNO.SDS.Utils.Network.idToString.apply(t,[e.ifname,e.type]),this.IFRecords.push(i)}),this)},enumServ:function(){this.module.appWin.setStatusBusy(),this.sendWebAPI({compound:{stopwhenerror:!1,mode:"parallel",params:this.apiEnumArray},callback:this.enumServCB,scope:this})},enumServCB:function(e,t,i){var s,n;return this.records=[],t&&503===t.status&&10>this.errRetryCount?(this.errRetryCount=this.errRetryCount+1,void this.enumServ.defer(3e3,this)):(this.errRetryCount=0,!e||t.has_fail?(this.module.appWin.getMsgBox().alert(this.title,SYNO.API.getErrorString(t.code)),void this.module.appWin.clearStatus()):void 0===(s=SYNO.API.Response.GetValByAPI(t,this.ListServieAPI.api,"get"))||void 0===(n=SYNO.API.Response.GetValByAPI(t,this.ListPackageAPI.api,"list"))?(this.module.appWin.getMsgBox().alert(this.title,_T("common","commfail")),void this.module.appWin.clearStatus()):(this.fillServRecord(s),this.fillPkgRecord(n),this.initializePortInfo(),this.loadPortInfo(),void this.module.appWin.clearStatus()))},fillServRecord:function(e){e.service&&(this.records=e.service,this.updateServInfo())},getDisplayNameByID:function(e){var t;return Ext.each(this.records,(function(i){e===i.service_id&&(t=i.display_name)}),this),t},i18nRenderer:function(e){if(!Ext.isString(e))return SYNO.Debug("not string format"),"";var t=e.split(":");return 1===t.length?t[0]:2===t.length?_T(t[0],t[1]):(SYNO.Debug("unexpected string format"),e)},updateServInfo:function(){Ext.each(this.records,(function(e){if(e.additional){var t=e.additional.active_status;e.status=t,e.enable=function(e,t){return"failed"===t?"gray":"static"===e?"active"===t:"enabled"===e}(e.enable_status,t),e.service_type="internal_service",e.display_name=this.i18nRenderer(e.display_name_section_key),"failed"===t&&(e.serv_desc=_T("pkgmgr","pkgmgr_pkg_broken"))}}),this),this.records=this.records.filter((e=>!0===e.enable))},fillPkgRecord:function(e){if(e.packages)for(var t=0;t<e.packages.length;t++){var i=this.transferPkgObj(e.packages[t]);i.enable&&this.records.push(i)}},transferPkgObj:function(e){var t={},i=e.additional.status;return t.service_type="packages",t.service_id=e.id,t.display_name=e.name,t.status=i,t.enable="running"===i,t.serv_desc="version_limit"===i?_T("pkgmgr","broken_version_desc"):_T("pkgmgr","broken_desc"),t},initializePortInfo:function(){Ext.each(this.records,(function(e){e.firewall="unknown",e.port_forward="unknown",e.router_port="router_not_configured"}),this)},loadPortInfo:function(){for(var e=[],t={},i=0;i<this.apiCheckPortArray.length;i++)(t=this.apiCheckPortArray[i]).api===this.CheckPfRuleAPI.api&&this.hidePfcolumn||(this.updateAPIParam(t),e.push(t));this.sendWebAPI({compound:{stopwhenerror:!1,params:e,mode:"parallel"},callback:this.loadPortInfoCB,scope:this})},updateAPIParam:function(e){e.params.service_id=this.getServiceId(),e.api===this.CheckFwRuleAPI.api&&(e.params.adapter=this.getFwTargetIF())},getServiceId:function(){var e=[];return Ext.each(this.records,(function(t){e.push(t.service_id)}),this),e},loadPortInfoCB:function(e,t,i){if(!e||t.has_fail)return this.module.appWin.getMsgBox().alert(this.title,SYNO.API.getErrorString(t.code)),void this.module.appWin.clearStatus();this.fillRecordByData(t)},alertChgPortServ:function(){var e=[],t=[];if(!0===this.setPortSuccess&&this.rgSetPfServID&&Ext.each(this.rgPfChgServID,(function(t){-1<this.rgSetPfServID.indexOf(t)&&e.push(t)}),this),Ext.each(e,(function(e){t.push(this.getDisplayNameByID(e))}),this),0<t.length){var i=_T("service","router_port_conflict_remap_alert")+"<br><br>"+_T("router_connection","pppoe_service_name")+": "+t.join(", ");this.module.appWin.getMsgBox().alert(this.title,i)}this.rgSetPfServID=[],this.setPortSuccess=!1},getFwSectionTable:function(e){return e.reduce(((e,{port_id:t,dst_port:i})=>Ext.apply(e,{[t]:i})),{})},fillRecordByData:function(e){this.fwPortInfo={},this.pfPortInfo={},this.rgPfChgServID=[];for(var t={},i=0;i<e.result.length;i++){if((t=e.result[i]).api===this.CheckFwRuleAPI.api&&Ext.each(t.data.service_policy,this.updateFwRec,this),t.api===this.GetFwSecPortAPI.api){const e=this.getFwSectionTable(t.data.port_info);this.updateDSPortField(e)}t.api===this.CheckPfRuleAPI.api&&(Ext.each(t.data.service_status,this.updatePfField,this),Ext.each(t.data.service_status,this.updateRouterPortField,this),this.alertChgPortServ())}this.orgFwPortInfo=this.cloneObj(this.fwPortInfo),this.orgPfPortInfo=this.cloneObj(this.pfPortInfo),this.updateFwDesc(),this.storeLoadRecords(),this.module.appWin.clearStatus()},cloneObj:function(e){return null===e||"object"!=typeof e?e:Ext.apply({},e)},updateFwRec:function(e){Ext.each(this.records,(function(t){if(t.service_id===e.service_id){switch(e.status){case"allow":t.firewall=!0;break;case"deny":t.firewall=!1;break;case"partial":t.firewall="gray";break;default:t.firewall="unknown"}t.fwInfo=e.interface_info}}),this),void 0!==e.interface_info&&Ext.each(e.interface_info,(function(e){this.updateFwPortInfo(e.port_info)}),this)},updateFwPortInfo:function(e){Ext.each(e,(function(e){!1!==this.fwPortInfo[e.port_id]&&(this.fwPortInfo[e.port_id]="allow"===e.status)}),this)},updateFwDesc:function(){Ext.each(this.records,(function(e){e.fwDesc="",void 0!==e.fwInfo&&Ext.each(e.fwInfo,(function(t){var i=t.adapter,s=t.status;e.fwDesc+=SYNO.SDS.Utils.Network.idToString.apply(this,[i,this.getIFTypeByName(i)])+": "+this.getFirewallStatus(s)+"<br>"}),this)}),this)},getIFTypeByName:function(e){var t;return Ext.each(this.IFRecords,(function(i){i.value===e&&(t=i.type)}),this),t},getFirewallStatus:function(e){return"allow"===e?_T("nfs","nfs_nonprivileged_port_allow"):"deny"===e?_T("nfs","nfs_nonprivileged_port_deny"):_T("service","service_partial_network_allow")},getServiceRouterPorts:function(e){var t=[],i=null,s=function(e,t,i){void 0!==t&&Ext.isArray(t)&&Ext.isArray(e)&&Ext.each(t,(function(t){0<=t[i]&&0>e.indexOf(t[i])&&e.push(t[i])}),this)};for(var n in e.port_info_detail)e.port_info_detail.hasOwnProperty(n)&&(s(t,(i=e.port_info_detail[n]).tcp,"router_port"),s(t,i.udp,"router_port"));return t.sort((function(e,t){return e-t}))},portsToStr:function(e){var t="",i=-1;return 0===e.length?"-":(t+=e[0],i=e[0],e.shift(),Ext.each(e,(function(e){return 1===Math.abs(e-i)?(i=e,"-"===t[t.length-1]||(t+="-"),!0):("-"===t[t.length-1]&&(t+=i),t+=", "+e,i=e,!0)})),"-"===t[t.length-1]&&(t+=i),t)},getServDSPorts:function(e,t){return[...new Set([].concat(...e.map((({port_id:e})=>t[e]))))].sort(((e,t)=>e-t))},updateDSPortField:function(e){Ext.each(this.records,(function(t){return Ext.isArray(t.fwInfo)&&Ext.isArray(t.fwInfo[0].port_info)?(t.ds_port=this.portsToStr(this.getServDSPorts(t.fwInfo[0].port_info,e)),!0):(t.ds_port="-",!0)}),this)},updateRouterPortField:function(e){void 0!==e.port_info_detail&&Ext.each(this.records,(function(t){return t.service_id!==e.service_id||(t.router_port=this.portsToStr(this.getServiceRouterPorts(e)),!1)}),this)},updatePfField:function(e){for(var t in e&&e.status_detail&&!0===e.status_detail.has_change_port&&this.rgPfChgServID.push(e.service_id),Ext.each(this.records,(function(t){if(t.service_id===e.service_id)switch(e.status){case"allow":t.port_forward=!0;break;case"deny":t.port_forward=!1;break;default:t.port_forward="unknown"}}),this),e.port_info)e.port_info.hasOwnProperty(t)&&(this.pfPortInfo[t]="allow"===e.port_info[t])},storeLoadRecords:function(){this.records&&this.store.loadData(this.records)},getFwTargetIF:function(){var e=[];return Ext.each(this.IFRecords,(function(t){"all"!==t.value&&e.push(t.value)}),this),e},getAPITaskID:function(e,t){for(var i=0;i<e.result.length;i++){var s=e.result[i];if(t===s.api)return s.data&&s.data.task_id?s.data.task_id:null}return null},rejectChanges:function(){this.getStore().rejectChanges()},isDirty:function(){return this.getStore().isDirty()}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.ServiceList.Store",{extend:"Ext.data.GroupingStore",constructor:function(e){var t=new Ext.data.JsonReader({fields:["service_type","display_name","service_id","ds_port","router_port","enable","firewall","port_forward","status","pf_rules","fwDesc","fwInfo","serv_desc"]}),i=Ext.apply({reader:t,groupField:"service_type",autoDestroy:!0,listeners:{load:this.onAfterLoad,scope:this},sortInfo:{field:"display_name",direction:"ASC"}},e);this.callParent([i])},onAfterLoad:function(){this.commitChanges()},isDirty:function(){return this.getModifiedRecords().length>0}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.DiagnosisTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={title:_T("user_data_collection","title"),autoScroll:!0,webapi:this.getWebApi(),items:[this.createDataCollectionItems(),this.createRegisterIPItems()]};return Ext.apply(t,e),t},createDataCollectionItems:function(){return{xtype:"syno_fieldset",title:_T("user_data_collection","data_collection"),collapsible:!1,items:[{xtype:"syno_displayfield",value:_T("user_data_collection","desc")},{xtype:"syno_checkbox",name:"enable",itemId:"enable",boxLabel:_T("user_data_collection","join"),scope:this},{xtype:"syno_displayfield",htmlEncode:!1,value:_T("user_data_collection","privacy_about_data_collection")}]}},createRegisterIPItems:function(){return{xtype:"syno_fieldset",title:_T("user_data_collection","share_network_location"),collapsible:!1,items:[{xtype:"syno_checkbox",name:"register_ip",itemId:"register_ip",htmlEncode:!1,boxLabel:_T("user_data_collection","enable_web_assistant"),scope:this,listeners:{render:{fn:function(e){var t;t=e,SYNO.ux.AddWhiteTipWithMsg(t,_T("user_data_collection","enable_web_assistant_tip"),436)},single:!0}}},{xtype:"syno_displayfield",htmlEncode:!1,value:_T("user_data_collection","privacy_about_share_network_location")}]}},isDirty:function(){return this.isFormDirty()},discardChange:function(){this.getForm().reset()},getAllForms:function(){return this.forms},getAppWin:function(){return this.ownerCt.module.appWin},processParams:function(e,t){return"get"===e?t:"set"===e?(t[0].params.compound[0].enable=!!t[0].params.enable,t[0].params.compound[1].service=[{action:t[0].params.register_ip?"start":"stop",service_id:"synoagentregisterd"}],delete t[0].params.register_ip,delete t[0].params.enable,t):t},processReturnData:function(e,t,i){let s=!1,n=_T("common","commfail");Ext.isDefined(t.result)&&Ext.isArray(t.result)&&Ext.each(t.result,(function(e){if(e.data.has_fail){s=!0;const t=SYNO.API.Response.GetFirstError(e.data);return t&&t.code&&(n=SYNO.API.getErrorString(t.code)),!1}if(!Ext.isDefined(e.data)||!Ext.isDefined(e.data.result)||!Ext.isArray(e.data.result))return!0;Ext.each(e.data.result,(function(t){if(!Ext.isDefined(t.method))return!1;"get"===t.method&&"SYNO.Core.DataCollect"===t.api&&Ext.isDefined(t.data.enable)&&(e.data.enable=t.data.enable),"get"===t.method&&"SYNO.Core.Service"===t.api&&Ext.isDefined(t.data.service)&&Ext.isArray(t.data.service)&&Ext.isDefined(t.data.service[0].enable_status)&&(e.data.register_ip="enabled"==t.data.service[0].enable_status)}))})),s&&this.getAppWin().getMsgBox().alert(_T("user_data_collection","data_collection"),n),this.callParent(arguments)},getWebApi:function(){return{api:"SYNO.Entry.Request",methods:{get:"request",set:"request"},version:1,params:{get:{stopwhenerror:!1,compound:[{api:"SYNO.Core.DataCollect",version:1,method:"get"},{api:"SYNO.Core.Service",version:2,method:"get",service_id:"synoagentregisterd"}]},set:{stopwhenerror:!1,compound:[{api:"SYNO.Core.DataCollect",version:1,method:"set"},{api:"SYNO.Core.Service",version:1,method:"control"}]}}}}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.appWin=e.appWin,this.callParent(arguments),this.panel=new SYNO.SDS.AdminCenter.InfoCenter.TabPanel({module:this})},getPanel:function(){return this.panel},getHelpParam:function(){return"AdminCenter/system_info_center.html"},setActivateParams:function(e){e&&e.tab&&this.panel.setActiveTab(e.tab)},activate:function(e){this.setActivateParams(e),this.panel.loadAllForm()},confirmCallback:function(e){"no"===e||this.panel.ServiceListTab.onLeave()},deactivate:function(){if(_S("is_admin")){if(this.panel.ServiceListTab.isDirty()||this.panel.DiagnosisTab.isDirty())return!1;this.panel.ServiceListTab.onLeave()}return!0},confirmLostChangeSave:function(){return new Promise(function(e,t){this.panel.applyAllForm({applyHandlerCallback:e})}.bind(this))},confirmLostChangeDontSave:function(){return new Promise(function(e,t){this.panel.DiagnosisTab.discardChange(),this.panel.ServiceListTab.onLeave(),e()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.InfoCenter.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){var t=Ext.apply({activeTab:0,module:e.module,items:this.getitems(e)},e);this.callParent([t])},getitems:function(e){var t=[new SYNO.SDS.AdminCenter.InfoCenter.OverviewTab({module:e.module,itemId:"overview"})];return"yes"!==_D("support_hyper_converged")&&t.push(new SYNO.SDS.AdminCenter.InfoCenter.NetworkTab({module:e.module,itemId:"network"}),new SYNO.SDS.AdminCenter.InfoCenter.StorageTab({module:e.module,itemId:"storage"})),_S("is_admin")&&t.push([this.ServiceListTab=new SYNO.SDS.AdminCenter.InfoCenter.ServiceListTab({module:e.module,itemId:"servicelisttab"}),this.DiagnosisTab=new SYNO.SDS.AdminCenter.InfoCenter.DiagnosisTab({module:e.module,itemId:"diagnosistab"})]),t},applyAllForm:function(e){this.applyAllFormOptions=e,this.applyPages={},this.callParent([e])},onApiSuccess:function(e,t,i){this.callParent([e,t,i]),this.checkAndNotify()},onApiFailure:function(e,t,i){this.callParent([e,t,i]),this.applyPages={},this.checkAndNotify()},checkAndNotify:function(){!0===this.checkIfAllApplyPollingDone()&&this.notifyAllApplyPollingDone()},checkIfAllApplyPollingDone:function(){if(this.applyPages){for(var e in this.applyPages)if(!0===this.applyPages[e])return!1;return!0}return!0},notifyAllApplyPollingDone:function(){this.applyAllFormOptions&&this.applyAllFormOptions.applyHandlerCallback&&this.applyAllFormOptions.applyHandlerCallback()}}),Ext.namespace("SYNO.SDS.AdminCenter.LoginPortal"),Ext.define("SYNO.SDS.AdminCenter.LoginPortal.Utils",{statics:{defaultInputWidth:120,getLocalAppDfValueMap:function(){var e,t={};e=SYNO.SDS.AdminCenter.LoginPortal.Utils.listAllowAltPortApp();for(var i=0;i<e.length;i++){var s={};s.alias=SYNO.SDS.Config.FnMap[e[i]].config.defaultAlias,s.http=SYNO.SDS.Config.FnMap[e[i]].config.defaultHttp,s.https=SYNO.SDS.Config.FnMap[e[i]].config.defaultHttps,t[e[i]]=s}return t},listAllowAltPortApp:function(){var e=SYNO.SDS.Config.FnMap,t=[];return Ext.iterate(e,(function(e,i,s){!i.config||"app"!==i.config.type&&"url"!==i.config.type||!0===i.config.allowAltPort&&t.push(e)})),t},fillRemoteAppDfValueMap:function(e){for(var t={},i=0;i<e.length;i++){var s=null;try{s=e[i].additional.default_setting}catch(e){continue}t[e[i].id]={alias:s.alias,http:s.http_port,https:s.https_port,fqdn:s.fqdn,hsts:s.hsts}}return t},isReservedPort:function(e,t,i){var s=!1;return Ext.iterate(e,(function(e,n,o){return e===t||(parseInt(n.http,10)===i||parseInt(n.https,10)===i?(s=!0,!1):void 0)}),this),s},isReservedAlias:function(e,t,i){var s=!1;return Ext.iterate(e,(function(e,n,o){return e===t||(n.alias===i?(s=!0,!1):void 0)}),this),s},getPortNameByServiceName:function(e){var t="";return"SYNO.SDS.App.FileStation3.Instance"===e?t="cfs":"SYNO.SDS.SurveillanceStation"===e&&(t="custsurveillance"),t},LinkMaker:function(e,t,i,s,n){var o=Ext.isEmpty(n)?null:parseInt(n,10);return function(n,a,r,l,d,c){if(!d)return null;var h,u,p;if(a)if(h=i?"http:":"https:",c){var _=Ext.isNumber(o)?String.format(":{0}",o):"";u=String.format("{0}//{1}{2}/{3}/",h,s,_,d)}else h=t?h:"http:",u=String.format("{0}//{1}/{2}/",h,s,d);else h=r?"http":"https",u=String.format("{0}://{1}:{2}",h,s,d);return p=l?u:d,n?!a&&!r&&!e||!a&&SYNO.SDS.QuickConnect.Utils.isInTunnel()?String.format('<span style="color:#404040 ">{0}</span>',p):String.format('<a href="{0}" target="_blank">{1}</a>',u,p):p}},FQDNLinkMaker:function(e,t,i){var s="https";Ext.form.VTypes.netbiosName(e)&&(s="http",navigator.platform.match(/^(Linux|Mac|iPad|iPod|iPhone)/i)&&(e+=".local"));var n=String.format("{0}://{1}",s,e);return t&&i?String.format('<a href="{0}" target="_blank">{0}</a>',n):i?String.format('<a href="{0}" target="_blank">{1}</a>',n,e):String.format('<span style="color:#404040 ">{0}</span>',n)},FQDNLinkMaker2:function(e){let t="https",i=e;return Ext.form.VTypes.netbiosName(i)&&(t="http",navigator.platform.match(/^(Linux|Mac|iPad|iPod|iPhone)/i)&&(i=`${i}.local`)),`${t}://${i}`}}}),Ext.namespace("SYNO.SDS.AdminCenter.Login"),Ext.define("SYNO.SDS.AdminCenter.Login.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.app=e.app},getVuePanel:function(){return SYNO.SDS.AdminCenter.LoginPortal.Main_vue},getHelpParam:function(){switch(this.getVueApp().tabKey){case"dsm":default:return"AdminCenter/system_login_portal_dsm.html";case"applications":return"AdminCenter/system_login_portal_applications.html";case"advanced":return"AdminCenter/system_login_portal_advanced.html"}},focus:function(e){this.getVueApp().load(e||{})},activate:function(e){this.getVueApp().load(e||{})},deactivate:function(){return!this.getVueApp().isDirty()},confirmLostChangeSave:function(){this.getVueApp().onApply()}}),Ext.define("SYNO.SDS.AdminCenter.Region.TimezoneStore",{extend:"Ext.data.JsonStore",constructor:function(e){this.module=e.module,this.owner=e.owner,this.hasLoaded=!1;var t=Ext.apply({fields:["value","offset","display"]},e);this.callParent([t])},loadTimezone:function(){if(!this.hasLoaded){var e=this;SYNO.API.RequestPromise({api:"SYNO.Core.Region.NTP",version:1,method:"listzone"}).then((function(t){e.loadData(t.zonedata),e.hasLoaded=!0}),(function(e){SYNO.Debug("failed to call WebAPI correctly with error: "),SYNO.Debug(e)}))}}}),Ext.ns("SYNO.SDS.AdminCenter.Region.Utils"),SYNO.SDS.AdminCenter.Region.Utils.trySendSyncAPI=function(e,t,i){var s=3,n=function(i){0>--s?t(!1,i||{}):SYNO.API.RequestPromise({api:"SYNO.Core.Region.NTP",method:"sync",version:1,params:{server:e}}).then((e=>t(!0,e))).catch((e=>n(e)))};n()},SYNO.SDS.AdminCenter.Region.Utils.trySendSyncAPIv2=function(e,t){var i=3,s=function(n){0>--i?t(!1,n||{}):SYNO.API.RequestPromise({api:"SYNO.Core.Region.NTP",method:"sync",version:2,params:{servers:e}}).then((e=>t(!0,e))).catch((e=>s(e)))};s()},SYNO.SDS.AdminCenter.Region.Utils.ntpUpdateSuccessMsg=function(e){return String.format(_T("time","ntp_update_success"),e)},SYNO.SDS.AdminCenter.Region.Utils.ntpUpdateFailedMsg=function(e,t){return String.format(_T("time","ntp_update_failed"),e,t)},SYNO.SDS.AdminCenter.Region.Utils.ntpUpdateProgressMsg=function(e,t){return String.format(_T("time","ntp_update_progress"),e,t)},Ext.ns("SYNO.SDS.AdminCenter.Region.NTP.Utils"),SYNO.SDS.AdminCenter.Region.NTP.Utils.NTPStatusErrorCode={INTERNAL:0,REQUEST_TIME_OUT:1,CONNECTION_REFUSED:2,NO_SYSPEER:3,NO_SYNC_LAST_5_TIMES:4,NO_ID_RETURNED:5},SYNO.SDS.AdminCenter.Region.NTP.Utils.getNTPStatusErrorString=function(e){const t=SYNO.SDS.AdminCenter.Region.NTP.Utils.NTPStatusErrorCode;switch(e){case t.REQUEST_TIME_OUT:return _T("time","ntp_status_time_out");case t.CONNECTION_REFUSED:return _T("time","ntp_status_connection_refused");case t.NO_SYSPEER:case t.NO_SYNC_LAST_5_TIMES:case t.NO_ID_RETURNED:return _T("time","ntp_status_network_issue");default:return _T("time","ntp_status_unknown_error")}},Ext.define("SYNO.SDS.AdminCenter.Region.NTPTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.tzStore=new SYNO.SDS.AdminCenter.Region.TimezoneStore({module:e.module,owner:e.appWin}),this.hideSysTime="yes"!==_D("support_sys_time"),this.ntpRetry=0,this.ntpStatusClass="",this.otpEnabled=!1,this.successGetOtpBeforeSet=!1,this.NTPApiTimestamp=0;var t=this.fillConfig(e);this.callParent([t]),this.mon(this,"afterlayout",(function(e,t){new SYNO.ux.Utils.EnableRadioGroup(e.getForm(),"enable_ntp",{manual:["date","hour","minute","second"],ntp:["server","ntp_status",this.updateBtnId]})}),this,{single:!0}),this.mon(this.tzStore,"load",this.onTZAfterLoad,this)},fillConfig:function(e){var t={itemId:"NTPTab",title:_T("tree","leaf_time"),autoScroll:!0,webapi:{api:"SYNO.Core.Region.NTP",methods:{get:"get",set:"set"},version:3},items:[{xtype:"syno_fieldset",collapsible:!1,title:_T("time","time_zone_and_format_title"),items:this.getNowItems()},{xtype:"syno_fieldset",collapsible:!1,title:_T("time","time_zone_title"),items:this.getTimezoneItems()},{xtype:"syno_fieldset",collapsible:!1,cls:"ntp-fieldset",title:_T("time","subtitle1"),hidden:this.hideSysTime,items:this.getTimeSettingItems()}]};return Ext.apply(t,e),t},initEvents:function(){this.tzStore.loadTimezone()},onTZAfterLoad:function(){Ext.getCmp(this.tzComboBoxId).reset()},getNowItems:function(){return[{xtype:"syno_displayfield",htmlEncode:!1,fieldLabel:_T("time","time_now"),name:"now"},{xtype:"syno_combobox",name:"date_format",width:300,id:this.dateFormatComboBoxId=Ext.id(),fieldLabel:_T("personal_settings","date_format"),displayField:"display",valueField:"value",store:SYNO.SDS.DateTimeUtils.CreateDateFormatStore()},{xtype:"syno_combobox",name:"time_format",width:300,id:this.timeFormatComboBoxId=Ext.id(),fieldLabel:_T("personal_settings","time_format"),displayField:"display",valueField:"value",store:SYNO.SDS.DateTimeUtils.CreateTimeFormatStore()}]},getTimezoneItems:function(){return[{xtype:"syno_combobox",name:"timezone",id:this.tzComboBoxId=Ext.id(),fieldLabel:_T("time","time_zone"),indent:0,width:300,displayField:"display",valueField:"value",tpl:'<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item" role="option" aria-label="{'+this.displayField+'}" id="{[Ext.id()]}">{display}</div></tpl>',store:this.tzStore}]},isIpsOrHostnames:function(e){return e.split(",").every(Ext.form.VTypes.iporhostname)},getTimeSettingItems:function(){var e=[];return e.push({xtype:"syno_radio",boxLabel:_T("time","time_manual"),"aria-label":_T("time","time_manual"),name:"enable_ntp",inputValue:"manual"},{xtype:"syno_datetimefield",isAllDay:!0,fieldLabel:_T("time","time_date"),name:"date",width:300,indent:1,allowBlank:!1,editable:!1,hideClearButton:!0,maxValue:new Date((new Date).getFullYear()+5,11,31),minValue:new Date((new Date).getFullYear()-5,0,1)},{xtype:"syno_compositefield",indent:1,width:300,fieldLabel:_T("time","time_time"),items:[{xtype:"syno_combobox",name:"hour",width:88,displayField:"display",valueField:"value","aria-label":_T("common","time_hour"),store:SYNO.SDS.Utils.createTimeItemStore("hour")},{xtype:"syno_displayfield",value:":",tabindex:"-1",width:6},{xtype:"syno_combobox",name:"minute",width:88,displayField:"display",valueField:"value","aria-label":_T("common","time_minute"),store:SYNO.SDS.Utils.createTimeItemStore("min")},{xtype:"syno_displayfield",value:":",tabindex:"-1",width:6},{xtype:"syno_combobox",name:"second",width:88,displayField:"display",valueField:"value","aria-label":_T("common","time_second"),store:SYNO.SDS.Utils.createTimeItemStore("sec")}]},{xtype:"syno_radio",boxLabel:_T("time","ntpdate_enable"),"aria-label":_T("time","ntpdate_enable"),name:"enable_ntp",inputValue:"ntp"},{xtype:"syno_combobox",name:"server",hiddenId:Ext.id(),width:300,indent:1,fieldLabel:_T("time","ntpdate_server"),store:this.getNTPServerStore(),displayField:"value",valueField:"value",validator:this.isIpsOrHostnames,allowBlank:!1,typeAhead:!0,editable:!0,selectOnFocus:!0,listeners:{scope:this,change:this.onChangeServer,select:this.onChangeServer}},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,cls:"",fieldLabel:_T("time","ntp_status"),name:"ntp_status",value:_T("time","ntp_status_checking"),isDirty:()=>!1,reset:Ext.emptyFn},{xtype:"syno_button",indent:1,id:this.updateBtnId=Ext.id(),text:_T("time","ntp_updatenow"),scope:this,handler:this.onUpdateNTPClick}),e},getNTPRadio(e){const t=e.findFields("enable_ntp");for(let e of t)if("ntp"===e.getInputValue())return e},getNTPServerStore:function(){return new Ext.data.SimpleStore({fields:["value"],data:[["time.google.com"],["pool.ntp.org"],["time.nist.gov"]]})},onChangeServer:function(e){Ext.getCmp(this.updateBtnId).enable()},onUpdateNTPClick:function(){_S("demo_mode")?this.appWin.getMsgBox().alert(this.title,_JSLIBSTR("uicommon","error_demo")):this.getForm().findField("server").isValid(!1)&&this.syncToNTPServer(function(){this.applyForm(),this.getNTPStatus()}.bind(this))},onBeforeRequest:function(e){if("set"!==e||!this.getForm().isDirty())return!0;if(!(this.successGetOtpBeforeSet||this.confirmedManualChangeTime||this.successSyncNTPBeforeSet||this.confirmedNTPChangeTime))return this.appWin.setStatusBusy(),synowebapi.promises.request({api:"SYNO.Core.OTP.Admin",version:1,method:"get_otp_status"}).then((e=>{this.otpEnabled=e.is_enabled})).catch((e=>{SYNO.Debug(e)})).finally((()=>{this.successGetOtpBeforeSet=!0,this.appWin.clearStatus(),this.module.panel.applyAllForm(),this.successGetOtpBeforeSet=!1})),!1;var t,i=this.getForm().getValues();if("manual"===i.enable_ntp&&0===this.module.panel.Retry&&!this.confirmedManualChangeTime&&!1===this.hideSysTime)return t=this.otpEnabled?String.format("{0}<br><br>{1}",_T("time","change_manual_time_setting_warning"),_T("time","logout_comfirm")):_T("time","logout_comfirm"),this.appWin.getMsgBox().confirm("",t).then((e=>{"confirm"===e&&(this.confirmedManualChangeTime=!0,this.module.panel.applyAllForm(),this.confirmedManualChangeTime=!1)})),!1;var s=this.getForm().findField("server"),n=this.getForm().findField("enable_ntp");return this.otpEnabled&&n.isDirty()&&!this.successSyncNTPBeforeSet&&!this.confirmedNTPChangeTime&&"ntp"===i.enable_ntp?(this.appWin.getMsgBox().confirm("",_T("time","ntpdate_enable_warning")).then((e=>{"confirm"===e&&(this.confirmedNTPChangeTime=!0,this.module.panel.applyAllForm(),this.confirmedNTPChangeTime=!1)})),!1):!("ntp"===i.enable_ntp&&0===this.module.panel.Retry&&!this.successSyncNTPBeforeSet&&(s.isDirty()||n.isDirty()))||(this.syncToNTPServer(function(){this.successSyncNTPBeforeSet=!0,this.module.panel.applyAllForm(),this.successSyncNTPBeforeSet=!1}.bind(this)),!1)},getNTPStatus:async function(){if(!this.isEnableNTP())return void this.setNTPStatus(_T("time","ntp_not_enable"),"");this.setNTPStatus(_T("time","ntp_status_checking"),"processing-status"),this.setNTPApiTimestamp();const e=this.NTPApiTimestamp,t=SYNO.SDS.AdminCenter.Region.NTP.Utils.NTPStatusErrorCode.INTERNAL,i=await synowebapi.promises.request({api:"SYNO.Core.Region.NTP",method:"status",version:1}).then((({ntp_status:e,ntp_status_error_code:i})=>e?void 0:i||t),(()=>t));if(e===this.NTPApiTimestamp)if(Ext.isDefined(i)){const e="https://kb.synology.com/DSM/tutorial/Troubleshooting_issues_syncing_with_NTP_server";this.setNTPStatus(`${String.format(SYNO.SDS.AdminCenter.Region.NTP.Utils.getNTPStatusErrorString(i),`<a class="link-font" href="${e}" target="_blank">`,"</a>")}`,"fail-status")}else this.setNTPStatus(_T("time","ntp_status_success"),"success-status")},setNTPStatus:function(e,t){this.isEnableNTP()||(e=_T("time","ntp_not_enable"),t="");const i=this.getForm().findField("ntp_status");i.setValue(e),i.removeClass(this.ntpStatusClass).addClass(t),this.ntpStatusClass=t},resetNTPStatus:function(){this.setNTPStatus(_T("time","ntp_status_checking"),"processing-status")},isEnableNTP:function(){const e=this.getNTPRadio(this.getForm());return!(!e||!e.getValue())},setNTPApiTimestamp:function(){this.NTPApiTimestamp=Date.now()},syncToNTPServer:function(e){const t=this.getForm().findField("server").getRawValue(),i=t.split(",");if(3<i.length)this.appWin.getMsgBox().alert(this.title,_T("time","over_3_ntp_servers"));else if(this.isIpsOrHostnames(t)){var s=_D("product"),n=SYNO.SDS.AdminCenter.Region.Utils.ntpUpdateSuccessMsg(t),o=SYNO.SDS.AdminCenter.Region.Utils.ntpUpdateFailedMsg(s,t),a=SYNO.SDS.AdminCenter.Region.Utils.ntpUpdateProgressMsg(s,t);this.appWin.setStatusBusy(null,a),this.SyncWithNtp=!0;var r=function(t,i){this.SyncWithNtp=!1,this.appWin.clearStatus(),t?(this.ownerCt.setStatusOK({text:n}),Ext.isFunction(e)&&e()):(this.ownerCt.setStatusError({text:_T("error","unable_to_perform_operation"),clear:!0}),this.appWin.getMsgBox().alert(this.title,o))}.bind(this);SYNO.SDS.AdminCenter.Region.Utils.trySendSyncAPIv2(i,r)}else this.appWin.getMsgBox().alert(this.title,_T("common","forminvalid"))},alertMessage:function(e){const t=SYNO.API.Response.GetFirstError(e);let i=_T("common","commfail");[5711,5712].includes(t.code)?i=this.getFeasibilityCheckMsg(t.errors):SYNO.API.Errors.core[t.code]&&(i=SYNO.API.Errors.core[t.code]),this.module.appWin.getMsgBox().alert(this.title,i)},processReturnData:function(e,t,i){if(t.has_fail&&this.alertMessage(t),i&&Ext.isArray(i.compound)){var s=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Region.NTP","get");if(s.date){var n=Date.parseDate(s.date,"Y/n/j");s.date=SYNO.SDS.DateTimeFormatter(n,{type:"date"})}this.getForm().loadRecords(t.result,i.compound)}this.getNTPStatus(),this.updateCurrentTime(),this.doLayout(),"set"!==e||!0===this.SyncWithNtp||t.has_fail||this.ownerCt.setStatusOK()},updateCurrentTime:function(){var e=new Date(this.getForm().findField("now").getValue());"Invalid Date"===e.toString()&&(e=new Date);var t=e.format(SYNO.SDS.DateTimeUtils.GetSystemDateFormat()+" "+SYNO.SDS.DateTimeUtils.GetSystemTimeFormat());this.getForm().setValues({now:t})},getFeasibilityCheckMsg:function(e){const t=_T("time","ntp_client_feasibility_check")+"<b> {0} </b>";try{const i=JSON.parse(e.error).reduce(((e,t)=>e+String.format("</br>{0}",SYNO.SDS.Utils.GetFeasibilityCheckMsg(t))),"");return String.format(t,i)}catch(e){return SYNO.Debug("Can't parse json"),_T("common","commfail")}}}),Ext.define("SYNO.SDS.AdminCenter.Region.LanguageTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={itemId:"LanguageTab",title:_T("tree","leaf_language"),autoScroll:!0,webapi:{api:"SYNO.Core.Region.Language",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_fieldset",collapsible:!1,title:_T("language","lang_display"),items:this.getLanguageItems()},{xtype:"syno_fieldset",collapsible:!1,title:_T("language","lang_email"),items:this.getMaillangItems()},{xtype:"syno_fieldset",collapsible:!1,title:_T("language","lang_codepage"),items:this.getCodepageItems()}]};return Ext.apply(t,e),t},getLanguageItems:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("language","lang_display_hint")}),e.push({xtype:"syno_combobox",name:"language",fieldLabel:_T("language","lang_display_field"),width:300,displayField:"display",valueField:"value",store:this.getLanguageStore(),listeners:{select:{scope:this,fn:function(){var e=this.getForm(),t=e.findField("codepage"),i=e.findField("maillang"),s=e.findField("language").getValue();"def"!=s&&(i.setValue(s),t.setValue(s))}}}}),e},getMaillangItems:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("language","lang_email_hint")}),e.push({xtype:"syno_combobox",name:"maillang",fieldLabel:_T("language","lang_email_field"),width:300,displayField:"display",valueField:"value",store:this.getMailLangStore()}),e},getCodepageItems:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("language","lang_codepage_hint")}),e.push({xtype:"syno_combobox",name:"codepage",fieldLabel:_T("language","lang_codepage"),width:300,displayField:"display",valueField:"value",store:this.getCodePageStore()}),e},getLanguageStore:function(){return new Ext.data.SimpleStore({fields:["value","display"],data:SYNO.SDS.Utils.getSupportedLanguage(1)})},getMailLangStore:function(){return new Ext.data.SimpleStore({fields:["value","display"],data:SYNO.SDS.Utils.getSupportedLanguage(0)})},getCodePageStore:function(){return new Ext.data.SimpleStore({fields:["value","display"],data:SYNO.SDS.Utils.getSupportedLanguageCodepage(0)})}}),Ext.define("SYNO.SDS.AdminCenter.Region.NTPServerTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t=SYNO.SDS.Utils.isInVirtualDSM()||"yes"===_D("dockerdsm")?_T("time","ntp_service_note_no_sha"):_T("time","ntp_service_note"),i={itemId:"NTPServerTab",title:_T("time","ntp_service"),autoScroll:!0,webapi:{api:"SYNO.Core.Region.NTP.Server",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_displayfield",value:_T("time","ntp_service_desc"),"aria-label":String.format("{0} {1}",_T("time","ntp_service_desc"),t)},{xtype:"syno_checkbox",name:"enable",boxLabel:_T("time","ntp_service_enable")},{xtype:"syno_displayfield",htmlEncode:!1,value:String.format('<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+t),tabindex:"-1"}]};return Ext.apply(i,e),i}}),Ext.define("SYNO.SDS.AdminCenter.Region.Main",{extend:"SYNO.SDS.AdminCenter.Module",appWin:null,constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.panel=new SYNO.SDS.AdminCenter.Region.TabPanel({module:this,appWin:this.appWin})},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"NTPTab":return"AdminCenter/system_time.html";case"LanguageTab":return"AdminCenter/system_language.html";case"NTPServerTab":return"AdminCenter/system_ntpservice.html";default:return"AdminCenter/system_region_desc.html"}},getPanel:function(){return this.panel},setActivateParams:function(e){e&&e.tab&&this.panel.setActiveTab(e.tab)},activate:function(e){return this.setActivateParams(e),this.panel.loadAllForm(),!0},deactivate:function(){for(var e=this.panel.getAllForms(),t=0;t<e.length;t++)if(e[t].isDirty())return!1;return!0},confirmLostChangeSave:function(){return this.getPanel().applyHandlerPromise()}}),Ext.define("SYNO.SDS.AdminCenter.Region.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",module:null,appWin:null,NTPForm:null,LanguageForm:null,NTPServerForm:null,Retry:0,applyHandlerResolve:Ext.emptyFn,applyHandlerReject:Ext.emptyFn,constructor:function(e){var t;this.module=e.module,this.appWin=e.appWin,this.tabList=[],this.NTPForm=new SYNO.SDS.AdminCenter.Region.NTPTab({module:this.module,appWin:this.appWin}),this.tabList.push(this.NTPForm),this.LanguageForm=new SYNO.SDS.AdminCenter.Region.LanguageTab({module:this.module,appWin:this.appWin}),this.tabList.push(this.LanguageForm),"no"!==_D("support_dual_head","no")||_S("ha_hide_ntp_setting")||"yes"===_D("support_hyper_converged")||(this.NTPServerForm=new SYNO.SDS.AdminCenter.Region.NTPServerTab({module:this.module,appWin:this.appWin}),this.tabList.push(this.NTPServerForm)),t=Ext.apply({activeTab:0,items:this.tabList,listeners:{deactivate:this.onDeactivate}},e),this.callParent([t])},processParams:function(e,t){if(this.callParent(arguments),"set"!==e)return t;var i={api:"SYNO.Core.Region.NTP",method:"set",version:3},s=this.NTPForm.getForm(),n=s.getValues(),o=!1;(s.findField("date").isDirty()||s.findField("hour").isDirty()||s.findField("second").isDirty()||s.findField("minute").isDirty())&&(o=!0),null!==this.NTPServerForm&&(this.ntpServerChange=this.NTPServerForm.getForm().findField("enable").isDirty());for(var a=0;a<t.length;a++)!0===SYNO.ux.Utils.checkApiConsistency(i,t[a])&&(t[a].params.change_time=o,"manual"===n.enable_ntp&&(t[a].params.date=new Date(n.date).dateFormat("Y/n/j"),this.NTPForm.setNTPApiTimestamp()));return t},onBeforeRequest:function(e){if("set"!==e)return this.callParent([e]);var t=this.NTPForm.getForm(),i=t.findField("date_format"),s=t.findField("time_format"),n=i&&i.isDirty(),o=s&&s.isDirty(),a=this.LanguageForm.getForm().findField("language");return(a&&a.isDirty()||n||o)&&(this.needConfirmRefresh=!0),this.callParent([e])},onApiSuccess:function(e,t,i){this.processReturnData(e,t,i),this.Retry=0,null!==this.NTPServerForm&&this.ntpServerChange&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.Region.NTP",!this.NTPServerForm.getForm().findField("enable").getValue()),this.needConfirmRefresh&&(this.needConfirmRefresh=!1,this.appWin.getMsgBox().confirm("",_T("personal_settings","refresh_confirm")).then((e=>{"confirm"===e&&(window.onbeforeunload=null,location.reload())})))},onApiFailure:function(){3>this.Retry++?this.module.panel.applyAllForm():this.Retry=0},onDeactivate:function(){this.NTPForm.resetNTPStatus()},processReturnData:function(e,t,i){t.has_fail?this.applyHandlerReject():this.applyHandlerResolve(),this.applyHandlerResolve=Ext.emptyFn,this.applyHandlerReject=Ext.emptyFn,this.callParent(arguments)},applyHandlerPromise:function(){var e=this;return new Promise((function(t,i){e.applyHandlerResolve=t,e.applyHandlerReject=i,e.applyHandler()}))}}),Ext.define("SYNO.SDS.AdminCenter.Notification.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.app=e.app},getVuePanel:function(){return SYNO.SDS.AdminCenter.Notification.Main_vue},getHelpParam:function(){switch(this.getVueApp().activeTabKey){case"mailSettingTab":return"AdminCenter/system_notification_email.html";case"pushSettingTab":return"AdminCenter/system_notification_pushservice.html";case"webhookSettingTab":return"AdminCenter/system_notification_webhook.html";case"ruleTab":return"AdminCenter/system_notification_rule.html";case"filterTab":return"AdminCenter/system_notification_filter.html";default:return"AdminCenter/system_notification_desc.html"}},activate:function(e){const t=e&&e.tab||"mailSettingTab";this.getVueApp().setActivatedKey(t)},deactivate:function(){return!this.getVueApp().isDirty()},confirmLostChangeSave:async function(){await this.getVueApp().onApply()},confirmLostChangeDontSave:async function(){await this.getVueApp().onReset()}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm.MemoryLayoutForm",{extend:"SYNO.ux.FieldSet",formType:"memory_layout",webapi:{api:"SYNO.Core.Hardware.MemoryLayout",methods:{get:"get",set:"set"},version:1},constructor:function(e){this.memoryLayoutOnUI=-1,this.confirmSetMemoryLayout=!1;var t=Ext.apply({labelWidth:250,title:_T("memory_layout","video_transcoding"),items:this.getItemList()},e);SYNO.LayoutConfig.fill(t),this.callParent([t])},getItemList:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("memory_layout","desc_for_monaco")}),e.push({xtype:"syno_radio",name:"memory_layout",inputValue:"1",boxLabel:_T("memory_layout","memory_layout_1way")}),e.push({xtype:"syno_radio",name:"memory_layout",inputValue:"3",boxLabel:_T("memory_layout","memory_layout_4k")}),e},onBeforeRequest:function(e){if(this.webapi.methods.set!==e)return!0;var t=this.parent.getForm().findField("memory_layout");return!(!this.confirmSetMemoryLayout&&this.memoryLayoutOnUI!=t.getGroupValue())||(SYNO.Debug("memory_layout changed"),this.module.appWin.getMsgBox().confirm(this.title,_T("memory_layout","video_transcoding_confirm"),(function(e){"yes"===e?(this.confirmSetMemoryLayout=!0,this.module.panel.applyAllForm(),this.confirmSetMemoryLayout=!1):t.setValue(this.memoryLayoutOnUI)}),this),!1)},processReturnData:function(e,t,i){for(var s={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},n=0;n<t.result.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(s,t.result[n])){if(!1===t.result[n].success||!t.result[n].data)return void this.module.appWin.getMsgBox().alert(_T("memory_layout","memory_layout"),_T("memory_layout","memory_layout")+": "+SYNO.API.getErrorString(t.result[n].error.code));break}var o=t.result[n].data.memory_layout;-1!==this.memoryLayoutOnUI&&this.memoryLayoutOnUI!==o&&(SYNO.Debug("memory layout changed. Need to restart"),SYNO.SDS.System.RebootWithMsg()),this.memoryLayoutOnUI=o}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm.ZramForm",{extend:"SYNO.ux.FieldSet",formType:"zram",webapi:{api:"SYNO.Core.Hardware.ZRAM",methods:{get:"get",set:"set"},version:1},constructor:function(e){this.enableZram=-1,this.confirmSetZram=!1,this.needReboot=!1;var t=Ext.apply({labelWidth:250,title:_T("zram","zram"),items:this.getItemList()},e);SYNO.LayoutConfig.fill(t),this.callParent([t]),this.getNeedRebootState()},getItemList:function(){var e=[];return e.push({xtype:"syno_checkbox",name:"enable_zram",boxLabel:_T("zram","zram_enable"),hideLabel:!0}),e.push({xtype:"syno_displayfield",name:"reboot_warning",id:this.needRebootWarnId=Ext.id(),value:"<font class='red-status'> "+_T("status","status_need_reboot")+" </font>",hidden:!this.needReboot,htmlEncode:!1}),e},onBeforeRequest:function(e){if(this.webapi.methods.set!==e)return!0;var t=this.parent.getForm().findField("enable_zram");if(!this.confirmSetZram&&this.enableZram!=t.getValue()){SYNO.Debug("enable_zram changed");var i=!0===_S("ha_running")?SYNO.SDS.HA.T("ui","confirm_reboot_cluster"):_T("zram","zram_confirm");return this.module.appWin.getMsgBox().confirm(this.title,i,(function(e){"yes"===e?(this.confirmSetZram=!0,this.module.panel.applyAllForm(),this.confirmSetZram=!1,this.setNeedRebootState()):t.setValue(this.enableZram)}),this),!1}return!0},processReturnData:function(e,t,i){for(var s={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},n=0;n<t.result.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(s,t.result[n])){if(!1===t.result[n].success||!t.result[n].data)return void this.module.appWin.getMsgBox().alert(_T("zram","zram"),_T("zram","zram")+": "+SYNO.API.getErrorString(t.result[n].error.code));break}var o=t.result[n].data.enable_zram?1:0;-1!=this.enableZram&&this.enableZram!=o&&(SYNO.Debug("zRam changed. Need to restart"),!0===_S("ha_running")?SYNO.SDS.HA.RebootHAWithAppWin(this,{appWin:this.module.appWin}):SYNO.SDS.System.RebootWithMsg(),Ext.getCmp(this.needRebootWarnId).show()),this.enableZram=o},getNeedRebootState:function(){this.sendWebAPI({api:"SYNO.Core.Hardware.NeedReboot",method:"get",params:{},version:1,callback:function(e,t,i,s){e?!0===t.need_reboot&&(this.needReboot=!0,Ext.getCmp(this.needRebootWarnId).show()):this.module.appWin.getMsgBox().alert("",SYNO.API.getErrorString(t.error.code))},scope:this})},setNeedRebootState:function(){SYNO.API.Request({api:"SYNO.Core.Hardware.NeedReboot",method:"set",params:{},version:1,callback:function(e,t,i,s){e||this.module.appWin.getMsgBox().alert("",SYNO.API.getErrorString(t.error.code))},scope:this})}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm.RecoveryForm",{extend:"SYNO.ux.FieldSet",formType:"recovery",webapi:{api:"SYNO.Core.Hardware.PowerRecovery",methods:{get:"get",set:"set"},version:1},constructor:function(e){var t;this.module=e.module,t=Ext.apply({labelWidth:250,collapsible:!_S("ha_running"),title:_S("ha_running")?String.format('<div ext:qtip="{0}">{1}</div>',_TT("SYNO.SDS.HA.Instance","ui","ha_not_support_setting"),_T("rcpower","rcpower_title")):_T("rcpower","rcpower_title"),items:this.getItemList()},e),SYNO.LayoutConfig.fill(t),this.callParent([t])},getItemList:function(){var e=[];if("yes"==_D("supportrcpower")&&e.push({xtype:"syno_checkbox",name:"rc_power_config",disabled:!0,id:this.rcPowerBlockcheckboxId=Ext.id(),boxLabel:_T("rcpower","rcpower_config")}),"yes"===_D("support_wol")&&"no"===_D("support_wol_but_not_enable_ui","no")){for(var t=parseInt(_D("maxlanport"),10)||1,i=1;i<=t;i++){var s=1===t?String.format(_T("network","wol_single_enable")):String.format(_T("network","wol_mulitple_enable"),SYNO.SDS.Utils.Network.idToString("eth"+(i-1)));e.push({xtype:"syno_checkbox",name:"wol"+i,boxLabel:s,disabled:_S("ha_running"),hideLabel:!0,hidden:!0,listeners:{scope:this,check:this.WOLChange}})}if("yes"===_D("support_oob_ctl")){var n=(parseInt(_D("oob_interface").replace("eth",""),10)||-1)+1;if(0!==n){var o=String.format(_T("network","wol_mulitple_enable"),SYNO.SDS.Utils.Network.idToString(_D("oob_interface")));e.push({xtype:"syno_checkbox",name:"wol"+n,boxLabel:o,disabled:_S("ha_running"),hideLabel:!0,hidden:!0,listeners:{scope:this,check:this.WOLChange}})}}}return"yes"===_D("supportrcpower")&&"yes"===_D("support_wol")&&"no"===_D("support_dual_head","no")&&e.push({xtype:"syno_displayfield",htmlEncode:!1,id:this.noteId=Ext.id(),value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("rcpower","wol_note")}),e},WOLChange:function(e,t,i,s){for(var n=parseInt(_D("maxlanport"),10)||1,o=!1,a=1;a<=n&&!0!==(o=this.parent.getForm().findField("wol"+a).getValue());a++);if("yes"===_D("support_oob_ctl")){var r=(parseInt(_D("oob_interface").replace("eth",""),10)||-1)+1;0!==r&&!1===o&&(o=this.parent.getForm().findField("wol"+r).getValue())}this.ownerCt.ownerCt.HibernationTab&&this.ownerCt.ownerCt.HibernationTab.updateAutoPoweroff("wol",o),"yes"===_D("supportrcpower")&&Ext.getCmp(this.rcPowerBlockcheckboxId).isValid()&&(0<this.ori_wol_enable_cnt_flag?this.ori_wol_enable_cnt_flag--:!0===t&&Ext.getCmp(this.rcPowerBlockcheckboxId).setValue(!0))},processReturnData:function(e,t,i){for(var s={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},n=0;n<t.result.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(s,t.result[n])){if(!1===t.result[n].success||!t.result[n].data)return void this.module.appWin.getMsgBox().alert(_T("rcpower","rcpower_title"),_T("rcpower","rcpower_title")+": "+SYNO.API.getErrorString(t.result[n].error.code));break}this.updateWol(t.result[n].success,t.result[n]),this.checkRCPowerBlock(t.result[n].success,t.result[n])},updateWol:function(e,t){if(e&&t&&t.data&&t.data.wol){var i=this.parent.getForm(),s=!1;this.ori_wol_enable_cnt_flag=0;for(var n=0;n<t.data.wol.length;n++){var o=t.data.wol[n].idx,a=t.data.wol[n].enable,r=i.findField("wol"+o);""!==_D("eth"+(o-1)+"_wol_options")&&(r.setVisible(!0),!0===a&&(s=!0),!0===a&&!1===r.getValue()&&this.ori_wol_enable_cnt_flag++)}this.parent.ownerCt.HibernationTab&&this.parent.ownerCt.HibernationTab.updateAutoPoweroff("wol",s)}},checkRCPowerBlock:function(e,t){e&&t&&t.data&&(t.data.rc_power_forbid||_S("ha_running")?Ext.getCmp(this.rcPowerBlockcheckboxId).disable():Ext.getCmp(this.rcPowerBlockcheckboxId).enable())}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm.FanSpeedForm",{extend:"SYNO.ux.FieldSet",formType:"fanspeed",webapi:{api:"SYNO.Core.Hardware.FanSpeed",methods:{get:"get",set:"set"},version:1},FAN_MODE_ENUM:{DUAL_MODE_HIGH:1,DUAL_MODE_LOW:2,DUAL_MODE_LOW_STOP:4,DUAL_MODE_FULL:8},constructor:function(e){var t;this.module=e.module,t=Ext.apply({labelWidth:250,title:_T("rcpower","rcfancontrol_desc"),items:this.getItemList()},e),SYNO.LayoutConfig.fill(t),this.callParent([t]),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(Ext.getCmp(this.cfanBtnId),_T("rcpower","rcfancontrol_mode_tip")),SYNO.ux.AddTip(Ext.getCmp(this.qfanBtnId),_T("rcpower","rcfancontrol_mode_tip"))}),this,{single:!0})},getItemList:function(){var e=[];return"yes"==_D("support_fan")&&(e.push({xtype:"syno_displayfield",indent:1,value:_T("rcpower","rcfancontrol_disk_temp_fail_desc"),id:this.allDiskTempFailDescId=Ext.id(),hidden:!0}),e.push({xtype:"syno_displayfield",indent:1,value:_T("rcpower","rcfancontrol_ext_nic_desc"),id:this.extNicDescId=Ext.id(),hidden:!0}),e.push({xtype:"syno_radio",name:"dual_fan_speed",id:this.hfanBtnId=Ext.id(),inputValue:"highfan",hidden:!0,boxLabel:_T("rcpower","rcfancontrol_high")}),e.push({xtype:"syno_radio",name:"dual_fan_speed",id:this.lfanBtnId=Ext.id(),inputValue:"lowfan",hidden:!0,boxLabel:_T("rcpower","rcfancontrol_low")}),e.push({xtype:"syno_radio",name:"dual_fan_speed",id:this.ffanBtnId=Ext.id(),inputValue:"fullfan",hidden:!0,boxLabel:_T("rcpower","rcfancontrol_full"),"aria-label":_T("rcpower","rcfancontrol_full")+" "+_T("rcpower","rcfancontrol_full_desc")}),e.push({xtype:"syno_displayfield",indent:1,value:_T("rcpower","rcfancontrol_full_desc"),id:this.ffanDescId=Ext.id(),hidden:!0,tabIndex:-1}),e.push({xtype:"syno_radio",name:"dual_fan_speed",id:this.cfanBtnId=Ext.id(),inputValue:"coolfan",hidden:!0,boxLabel:_T("rcpower","rcfancontrol_cool"),"aria-label":_T("rcpower","rcfancontrol_cool")+" "+_T("rcpower","rcfancontrol_cool_desc")}),e.push({xtype:"syno_displayfield",indent:1,value:_T("rcpower","rcfancontrol_cool_desc"),id:this.cfanDescId=Ext.id(),hidden:!0,tabIndex:-1}),e.push({xtype:"syno_radio",name:"dual_fan_speed",id:this.qfanBtnId=Ext.id(),inputValue:"quietfan",hidden:!0,boxLabel:_T("rcpower","rcfancontrol_quiet"),"aria-label":_T("rcpower","rcfancontrol_quiet")+" "+_T("rcpower","rcfancontrol_quiet_desc")}),e.push({xtype:"syno_displayfield",indent:1,value:_T("rcpower","rcfancontrol_quiet_desc"),id:this.qfanDescId=Ext.id(),hidden:!0,tabIndex:-1}),e.push({xtype:"syno_radio",name:"dual_fan_speed",id:this.qstopfanBtnId=Ext.id(),inputValue:"quietstopfan",hidden:!0,boxLabel:_T("rcpower","rcfancontrol_low_power"),"aria-label":_T("rcpower","rcfancontrol_low_power")+" "+_T("rcpower","rcfancontrol_low_power_desc")}),e.push({xtype:"syno_displayfield",indent:1,value:_T("rcpower","rcfancontrol_low_power_desc"),id:this.qstopfanDescId=Ext.id(),hidden:!0,tabIndex:-1})),e},processReturnData:function(e,t,i){for(var s={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},n=0;n<t.result.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(s,t.result[n])){if(!1===t.result[n].success||!t.result[n].data)return void this.module.appWin.getMsgBox().alert(_T("rcpower","rcfancontrol_desc"),_T("rcpower","rcfancontrol_desc")+": "+SYNO.API.getErrorString(t.result[n].error.code));break}this.updateFanSpeedControl(t.result[n].success,t.result[n])},updateFanSpeedControl:function(e,t){SYNO.Debug("support_fan: "+_D("support_fan")),"yes"===_D("support_fan")&&(Ext.getCmp(this.hfanBtnId).disable(),Ext.getCmp(this.lfanBtnId).disable(),Ext.getCmp(this.ffanBtnId).disable(),Ext.getCmp(this.cfanBtnId).disable(),Ext.getCmp(this.qfanBtnId).disable(),Ext.getCmp(this.qstopfanBtnId).disable(),SYNO.Debug("obj.data.cool_fan: "+t.data.cool_fan),"no"===t.data.cool_fan?(Ext.getCmp(this.hfanBtnId).setVisible(!0),Ext.getCmp(this.hfanBtnId).enable(),Ext.getCmp(this.lfanBtnId).setVisible(!0),Ext.getCmp(this.lfanBtnId).enable()):"single"===t.data.cool_fan?(this.FAN_MODE_ENUM.DUAL_MODE_FULL&t.data.fan_type&&(Ext.getCmp(this.ffanBtnId).setVisible(!0),Ext.getCmp(this.ffanBtnId).enable(),Ext.getCmp(this.ffanDescId).setVisible(!0)),this.FAN_MODE_ENUM.DUAL_MODE_LOW&t.data.fan_type&&(Ext.getCmp(this.qfanBtnId).setVisible(!0),Ext.getCmp(this.qfanBtnId).enable(),Ext.getCmp(this.qfanDescId).setVisible(!0))):(this.FAN_MODE_ENUM.DUAL_MODE_FULL&t.data.fan_type&&(Ext.getCmp(this.ffanBtnId).setVisible(!0),Ext.getCmp(this.ffanBtnId).enable(),Ext.getCmp(this.ffanDescId).setVisible(!0)),this.FAN_MODE_ENUM.DUAL_MODE_HIGH&t.data.fan_type&&(Ext.getCmp(this.cfanBtnId).setVisible(!0),Ext.getCmp(this.cfanBtnId).enable(),Ext.getCmp(this.cfanDescId).setVisible(!0)),this.FAN_MODE_ENUM.DUAL_MODE_LOW&t.data.fan_type&&(Ext.getCmp(this.qfanBtnId).setVisible(!0),Ext.getCmp(this.qfanBtnId).enable(),Ext.getCmp(this.qfanDescId).setVisible(!0)),this.FAN_MODE_ENUM.DUAL_MODE_LOW_STOP&t.data.fan_type&&(Ext.getCmp(this.qstopfanBtnId).setVisible(!0),Ext.getCmp(this.qstopfanBtnId).enable(),Ext.getCmp(this.qstopfanDescId).setVisible(!0)),"yes"===t.data.fan_support_adjust_by_ext_nic?(Ext.getCmp(this.extNicDescId).setVisible(!0),"high"===_D("support_fan_adjust_by_ext_nic")?(Ext.getCmp(this.qfanBtnId).disable(),Ext.getCmp(this.qstopfanBtnId).disable()):"full"===_D("support_fan_adjust_by_ext_nic")&&(Ext.getCmp(this.cfanBtnId).disable(),Ext.getCmp(this.qfanBtnId).disable(),Ext.getCmp(this.qstopfanBtnId).disable())):"yes"===t.data.all_disk_temp_fail&&"full"===_D("support_fan_adjust_by_all_disk_temp_fail")&&(Ext.getCmp(this.allDiskTempFailDescId).setVisible(!0),Ext.getCmp(this.cfanBtnId).disable(),Ext.getCmp(this.qfanBtnId).disable(),Ext.getCmp(this.qstopfanBtnId).disable())))}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm.BeepControlForm",{extend:"SYNO.ux.FieldSet",formType:"beepcontrol",webapi:{api:"SYNO.Core.Hardware.BeepControl",methods:{get:"get",set:"set"},version:1},constructor:function(e){var t;this.module=e.module,t=Ext.apply({labelWidth:250,title:_T("beep","beep_title"),items:this.getItemList()},e),SYNO.LayoutConfig.fill(t),this.callParent([t])},getItemList:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("rcpower","beep_desc")}),e.push({xtype:"syno_checkbox",name:"fan_fail",boxLabel:_T("beep","fan_fail"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"volume_crash",boxLabel:_T("beep","volume_crash"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"volume_or_cache_crash",boxLabel:_T("beep","volume_or_cache_crash"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"sas_link_fail",boxLabel:_T("beep","sas_link_fail"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"poweron_beep",boxLabel:_T("beep","poweron_beep"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"poweroff_beep",boxLabel:_T("beep","poweroff_beep"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"reset_beep",boxLabel:_T("beep","reset_beep"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"enc_module_fail",boxLabel:_T("beep","enc_module_fail"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"redundant_power_fail",boxLabel:_T("beep","redundant_power_fail"),hideLabel:!0}),e.push({xtype:"syno_checkbox",name:"eunit_redundant_power_fail",boxLabel:_T("beep","eunit_redundant_power_fail"),hideLabel:!0}),e.push({xtype:"syno_displayfield",htmlEncode:!1,id:this.beepReasonId=Ext.id(),value:_T("beep","beep_reason")+" "+_T("common","none"),disabled:!1}),e.push({xtype:"syno_button",id:this.btnBeepOffId=Ext.id(),text:_T("volume","volume_beepoff"),handler:this.onBeepOff,disabled:!0,scope:this}),e},processReturnData:function(e,t,i){for(var s={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},n=0;n<t.result.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(s,t.result[n])){if(!1===t.result[n].success||!t.result[n].data)return void this.module.appWin.getMsgBox().alert(_T("beep","beep_title"),_T("beep","beep_title")+": "+SYNO.API.getErrorString(t.result[n].error.code));break}this.updateBeepControl(t.result[n].success,t.result[n])},generateReasonString:function(e){for(var t,i="",s=new Array("reason_fan_fail","reason_volume_crash","reason_power_on","reason_power_off","reason_reset_btn","reason_sas_link_fail","reason_volume_or_cache_crash","enc_module_fail","reason_redundant_power_fail","reason_eunit_redundant_power_fail"),n=0;n<s.length;n++)-1!=e.search(s[n])&&(t=s[n],""!==i&&(i+=","),i+=_T("beep",t));return i},updateBeepReason:function(e){var t=_T("beep","beep_reason")+" ",i="",s=Ext.getCmp(this.btnBeepOffId);s.disable(),e.beep_reason&&(i+=this.generateReasonString(e.beep_reason)),""===i?i=_T("common","none"):(s.enable(),i='<span class="red-status">'+i+"</span>"),this.setBeepReason(t+i)},setBeepReason:function(e){var t=Ext.getCmp(this.beepReasonId);t.setValue(e),t.originalValue=t.getValue()},updateBeepControl:function(e,t){if(e&&t&&t.data){var i=function(e,t){SYNO.ux.Utils.displayFormField(e,t,!1),e.findField(t).disable()},s=this.parent.getForm(),n=t.data;n.support_fan_fail||i(s,"fan_fail"),n.support_volume_crash||i(s,"volume_crash"),n.support_volume_or_cache_crash||i(s,"volume_or_cache_crash"),n.support_sas_link_fail||i(s,"sas_link_fail"),n.support_poweron_beep||i(s,"poweron_beep"),n.support_poweroff_beep||i(s,"poweroff_beep"),n.support_reset_beep||i(s,"reset_beep"),n.support_enc_module_fail||i(s,"enc_module_fail"),n.support_redundant_power_fail||i(s,"redundant_power_fail"),n.support_eunit_redundant_power_fail||i(s,"eunit_redundant_power_fail"),this.updateBeepReason(t.data)}},onBeepOff:function(){var e=Ext.getCmp(this.btnBeepOffId);SYNO.API.Request({api:"SYNO.Core.Hardware.BeepControl",method:"stop_beep",params:{},version:1,callback:function(t,i,s,n){t?(e.disable(),this.setBeepReason(_T("beep","beep_reason")+" "+_T("common","none"))):this.module.appWin.getMsgBox().alert(_T("volume","volume_beepoff"),_T("volume","volume_beepoff")+": "+SYNO.API.getErrorString(i.code))},scope:this})}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm.LedBrightnessForm",{extend:"SYNO.ux.FieldSet",formType:"ledBrightness",webapi:{api:"SYNO.Core.Hardware.Led.Brightness",methods:{get:"get",set:"set"},version:1},constructor:function(e){var t;this.module=e.module,t=Ext.apply({title:_T("led_brightness","led_brightness_desc"),items:this.getItemList()},e),SYNO.LayoutConfig.fill(t),this.callParent([t]),this.sendWebAPI({api:"SYNO.Core.Hardware.Led.Brightness",method:"get_static_data",version:1,scope:this,callback:this.onSliderStaticDataRecieve})},getItemList:function(){return[{xtype:"syno_displayfield",value:_T("led_brightness","adjust_tip_desc")},{xtype:"syno_compositefield",hideLabel:!0,height:24,hidden:!0,hideMode:"visibility",id:this.compositeFieldId=Ext.id(),items:[{xtype:"syno_displayfield",hideLabel:!0,width:24,height:24,cls:"led-slider-icon-head"},{xtype:"syno_sliderfield",name:"led_brightness",width:295,increment:1,minValue:0,maxValue:7,useTips:!1,hideLabel:!0,hasCalibration:!0,id:this.sliderFieldId=Ext.id(),listeners:{scope:this,valuechange:this.onLedSliderValuechange,deactivate:this.updateLedBrightness,render:function(e){this.addListener("expand",(function(){var t=e.slider.innerEl.child(".x-slider-thumb");e.slider.halfThumb=(e.slider.vertical?t.getHeight():t.getWidth())/2,e.slider.afterRender();var i=e.slider.el.child(".syno-ux-slider-progress"),s=e.slider.translateValue(e.slider.getValue()||0)+e.slider.halfThumb;i.setWidth(s,!1)}))},afterrender:function(e){e.ledOffTip=new Ext.Tip({html:_T("led_brightness","slider_led_off")}),e.ledOnTip=new Ext.Tip({html:_T("led_brightness","slider_led_default")}),e.mon(e.slider.getEl(),{mouseenter:function(){e.isMouseInsideSlider=!0,e.updateTip()},mouseleave:function(){e.isMouseInsideSlider=!1,e.updateTip()}}),e.slider.addListener("dragstart",(function(){e.isSliderDraging=!0,e.updateTip()})),e.slider.addListener("dragend",(function(){e.isSliderDraging=!1,e.updateTip()})),e.slider.removeListener("change",e.onSliderValueChanged,e),e.slider.addListener("change",(function(){var t=e.slider.el.child(".syno-ux-slider-progress"),i=e.slider.translateValue(e.slider.getValue()||0)+e.slider.halfThumb;e.isSliderDraging||e.slider.thumbs[0].dragging?t.setWidth(i,!1):t.setWidth(i,!0)})),new Ext.dd.DragTracker({onStart:function(t){for(var i=!1,s=0;s<e.slider.thumbs.length;s++)i=i||t.target==e.slider.thumbs[s].el.dom;!1===i&&(this.isDrag=!0,e.slider.fireEvent("dragstart",e.slider,t,e.slider))},onDrag:function(t){if(this.isDrag){var i=e.slider.thumbs[0].index,s=e.slider.innerEl.translatePoints(this.getXY()),n=Ext.util.Format.round(e.slider.reverseValue(s.left),e.slider.decimalPrecision);e.slider.setValue(i,n,!1),e.slider.fireEvent("drag",e.slider,t,e.slider)}},onEnd:function(t){this.isDrag&&(this.isDrag=!1,e.slider.fireEvent("dragend",e.slider,t,e.slider))},tolerance:3,autoStart:300}).initEl(e.slider.getEl()),e.slider.thumbs[0].tracker.onDrag=function(t){var i=e.slider.thumbs[0],s=i.slider,n=i.index,o=i.getNewValue();if(i.constrain){var a=i.slider.thumbs[n+1],r=i.slider.thumbs[n-1];void 0!==r&&o<=r.value&&(o=r.value),void 0!==a&&o>=a.value&&(o=a.value)}e.slider.setValue(n,o,!1),s.fireEvent("drag",s,t,i)},this.ownerCt.addListener("deactivate",this.updateLedBrightness)}},updateTip:function(){this.isSliderDraging||this.isMouseInsideSlider?this.slider.minValue===this.getValue()?(this.ledOffTip.show(),this.ledOnTip.hide()):this.slider.maxValue===this.value?(this.ledOffTip.hide(),this.ledOnTip.show()):(this.ledOffTip.hide(),this.ledOnTip.hide()):(this.ledOffTip.hide(),this.ledOnTip.hide()),this.ledOffTip.isVisible()&&this.ledOffTip.setPosition([this.getPosition()[0]+8-this.ledOffTip.getWidth()/2,this.getPosition()[1]-25]),this.ledOnTip.isVisible()&&this.ledOnTip.setPosition([this.getPosition()[0]+this.getWidth()-7-this.ledOnTip.getWidth()/2,this.getPosition()[1]-25])}},{xtype:"syno_displayfield",hideLabel:!0,width:24,height:24,cls:"led-slider-icon-tail"}]},{xtype:"syno_displayfield",hideLabel:!0,width:400,height:16,id:this.sliderScaleId=Ext.id()},{xtype:"hidden",name:"schedule",id:this.ledScheduleFieldId=Ext.id()},{xtype:"syno_button",text:_T("led_brightness","set_schedule"),listeners:{scope:this,click:this.onLedBrightnessScheduleButtonClick}}]},onLedBrightnessScheduleButtonClick:function(){this.ledBrightnessScheduleDialog=new SYNO.SDS.AdminCenter.HardwareControl.LedBrightnessScheduleDialog({owner:this.module.appWin,module:this}),this.ledBrightnessScheduleDialog.setSchedule(Ext.getCmp(this.ledScheduleFieldId).getValue()),this.ledBrightnessScheduleDialog.on("close",this.onScheduleDialogClose,this),this.ledBrightnessScheduleDialog.open()},onScheduleDialogClose:function(e){!0===e.isApply&&Ext.getCmp(this.ledScheduleFieldId).setValue(e.getSchedule())},onLedSliderValuechange:function(e,t){this.sendWebAPI({api:"SYNO.Core.Hardware.Led.Brightness",method:"set_current_brightness",params:{led_brightness:t},version:1}),e.updateTip()},updateLedBrightness:function(){this.sendWebAPI({api:"SYNO.Core.Hardware.Led.Brightness",method:"update",version:1})},onSliderStaticDataRecieve:function(e,t,i){if(!1!==e){var s,n;switch(t.max-t.min+1){case 4:s=195,n="led-slider-scale-4";break;case 8:s=295,n="led-slider-scale-8";break;default:return void this.module.appWin.getMsgBox().alert("error","LED brightness scale isn't defined",null,this)}var o=Ext.getCmp(this.sliderFieldId);o.slider.setMinValue(t.min),o.slider.setMaxValue(t.max),o.setWidth(s),o.width=s,o.ownerCt.doLayout(),Ext.getCmp(this.sliderScaleId).getEl().addClass(n),Ext.getCmp(this.compositeFieldId).show()}}}),Ext.ns("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.mainPanelFieldSets=[],this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.settingFormList=[],_D("support_release_transcoding_memory")?this.settingFormList.push({id:"video_transcoding",name:"_video_transcoding_",api:"SYNO.Core.Hardware.VideoTranscoding"}):"synology_monaco_ds216play"===_D("unique")&&this.settingFormList.push({id:"memory_layout",name:"_memory_layout_",api:"SYNO.Core.Hardware.MemoryLayout"}),"yes"===_D("support_zram")&&"no"!==_D("disk_swap")&&this.settingFormList.push({id:"zram",name:_T("zram","zram"),api:"SYNO.Core.Hardware.ZRAM"}),"no"!==_D("support_dual_head","no")||"yes"!==_D("supportrcpower")&&"yes"!==_D("support_wol")||_S("ha_hide_hw_setting")||this.settingFormList.push({id:"recovery",name:_T("rcpower","rcpower_title"),api:"SYNO.Core.Hardware.PowerRecovery"}),"yes"===_D("support_buzzer")&&this.settingFormList.push({id:"beepcontrol",name:_T("beep","beep_title"),api:"SYNO.Core.Hardware.BeepControl"}),"yes"===_D("support_fan")&&this.settingFormList.push({id:"fanspeed",name:_T("rcpower","rcfancontrol_desc"),api:"SYNO.Core.Hardware.FanSpeed"}),"yes"===_D("support_led_brightness_adjustment")&&this.settingFormList.push({id:"ledBrightness",name:_T("led_brightness","led_brightness_desc"),api:"SYNO.Core.Hardware.Led.Brightness"});var t=0;for(t=0;t<this.settingFormList.length;t++){var i=this.getPanelClassName(this.settingFormList[t].id);SYNO.Debug("create form: "+this.settingFormList[t].id),this.mainPanelFieldSets.push(new i({itemId:this.settingFormList[t].id,api:this.settingFormList[t].api,module:this.module,stateId:String.format("{0}::{1}::{2}","SYNO.SDS.AdminCenter.HardwareControl.Main","general",this.settingFormList[t].id),collapsible:!0,parent:this})),SYNO.Debug("create form: "+this.settingFormList[t].id)}var s={title:_T("mediaservice","generic_setting"),autoScroll:!0,items:this.mainPanelFieldSets};return Ext.apply(s,e),s},setBeepWarn:function(){this.getComponent("beepcontrol").expand(),this.mon(this,"afterlayout",(function(){this.fleXcrollTo.defer(100,this,[this.getComponent("beepcontrol").el])}),this,{single:!0})},getPanelClassName:function(e){for(var t in SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm)if(Ext.isFunction(SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm[t])&&SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm[t].prototype&&SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm[t].prototype.formType===e)return SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm[t];return null},processReturnData:function(e,t,i){for(var s in this.mainPanelFieldSets)Ext.isFunction(this.mainPanelFieldSets[s].processReturnData)&&this.mainPanelFieldSets[s].processReturnData(e,t,i);this.callParent(arguments),this.doLayout()},getHelpParam:function(){return"AdminCenter/system_hardware_general.html"},onBeforeRequest:function(e){for(var t in this.mainPanelFieldSets)if(Ext.isFunction(this.mainPanelFieldSets[t].onBeforeRequest)&&!this.mainPanelFieldSets[t].onBeforeRequest(e))return!1;return!0}}),Ext.ns("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.LcmTab",{extend:"SYNO.SDS.Utils.FormPanel",initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_password",["password","password_confirm"])}),this,{single:!0})},constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={title:_T("lcm","lcm_title"),autoScroll:!0,itemId:"LcmTab",webapi:{api:"SYNO.Core.Hardware.LCM",methods:{get:"get",set:"set"},version:1},items:this.getItemList()};return Ext.apply(t,e),SYNO.LayoutConfig.fill(t)},getItemList:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("lcm","lcm_desc")}),e.push({xtype:"syno_checkbox",name:"enable_password",boxLabel:_T("lcm","lcm_password_enable")}),e.push({xtype:"syno_textfield",fieldLabel:_T("lcm","lcm_password"),textType:"password",name:"password",maxlength:8,vtype:"digit",allowBlank:!1,width:300}),e.push({xtype:"syno_textfield",fieldLabel:_T("lcm","lcm_password_confirm"),name:"password_confirm",textType:"password_confirm",confirmFor:"password",maxlength:8,vtype:"digit",allowBlank:!1,width:300}),e},onBeforeRequest:function(e){return this.webapi.methods.set!==e||(!!this.getForm().isValid()||(this.module.panel.setStatusError({text:_T("common","forminvalid"),clear:!0}),this.module.panel.setActiveTab("LcmTab"),!1))},getHelpParam:function(){return"AdminCenter/system_hardware_lcm.html"}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.ScheduleSummaryDialog",{extend:"SYNO.SDS.ModalWindow",grid:void 0,constructor:function(e){this.module=e.module,this.owner=e.owner,this.isSupportAutoPowerOn=e.supportAutoPowerOn,this.store=new Ext.data.JsonStore({autoDestroy:!0,fields:["date","on","off"],data:[]}),this.grid=new SYNO.ux.GridPanel({ds:this.store,cm:new Ext.grid.ColumnModel([{header:_T("time","time_date"),dataIndex:"date",width:150},{header:_T("system","poweron_opt"),dataIndex:"on",hidden:!this.isSupportAutoPowerOn,width:200},{header:_T("system","poweroff_opt"),dataIndex:"off",width:200}])});var t={width:650,height:380,title:_T("schedule","schedule_summary"),layout:"fit",items:[this.grid],buttons:[{text:_T("common","alt_close"),scope:this,handler:function(){this.close()}}]};Ext.apply(t,e),this.callParent([t])},loadTasks:function(e){var t=e.poweron_tasks,i=e.poweroff_tasks,s=0,n=0,o=[],a="",r=[{date:_T("schedule","schedule_sun"),on:"",on_array:[],off:"",off_array:[]},{date:_T("schedule","schedule_mon"),on:"",on_array:[],off:"",off_array:[]},{date:_T("schedule","schedule_tue"),on:"",on_array:[],off:"",off_array:[]},{date:_T("schedule","schedule_wed"),on:"",on_array:[],off:"",off_array:[]},{date:_T("schedule","schedule_thu"),on:"",on_array:[],off:"",off_array:[]},{date:_T("schedule","schedule_fri"),on:"",on_array:[],off:"",off_array:[]},{date:_T("schedule","schedule_sat"),on:"",on_array:[],off:"",off_array:[]}],l=function(e,t){var i=e.split(":"),s=t.split(":");return 60*parseInt(i[0],10)+parseInt(i[1],10)-(60*parseInt(s[0],10)+parseInt(s[1],10))};for(n=0;n<7;++n){for(s=0;s<t.length;++s)(o=t[s]).enabled&&(o.weekdays.search(n.toString())<0||(a=String.format("{0}:{1}",o.hour,this.module.convert2Digits(o.min)),r[n].on_array.indexOf(a)<0&&r[n].on_array.push(a)));for(s=0;s<i.length;++s)(o=i[s]).enabled&&(o.weekdays.search(n.toString())<0||(a=String.format("{0}:{1}",o.hour,this.module.convert2Digits(o.min)),r[n].off_array.indexOf(a)<0&&r[n].off_array.push(a)));r[n].on_array.sort(l),r[n].on=r[n].on_array.join(", "),r[n].off_array.sort(l),r[n].off=r[n].off_array.join(", ")}this.store.loadData(r)},onOpen:function(){var e=this.module.getSubmitData();this.loadTasks(e),this.callParent()}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.ScheduleTaskDialog",{extend:"SYNO.SDS.ModalWindow",record:void 0,mode:"add",constructor:function(e){this.module=e.module,this.owner=e.owner,this.isSupportAutoPowerOn=e.supportAutoPowerOn,this.panel=this.createPanel(e),this.form=this.panel.getForm();var t={width:500,height:350,autoFlexcroll:!0,resizable:!1,title:"edit"==e.mode?_T("rcpower","edit_task"):_T("rcpower","add_task"),items:[this.panel],buttons:[{text:_T("common","alt_cancel"),scope:this,btnStyle:"gray",handler:this.close},{text:_T("common","alt_apply"),itemId:"apply",scope:this,btnStyle:"blue",handler:this.onApply}]};Ext.apply(t,e),this.callParent([t])},createPanel:function(e){var t=[];t.push({xtype:"syno_radio",name:"action",itemId:"on",boxLabel:_T("system","poweron_opt"),inputValue:"on",hidden:!this.isSupportAutoPowerOn,listeners:{check:function(e,t){t&&this.changeNote("on")},scope:this}}),t.push({xtype:"syno_radio",name:"action",itemId:"off",boxLabel:_T("schedule","shutdown"),inputValue:"off",listeners:{check:function(e,t){t&&this.changeNote("off")},scope:this}}),t.push({xtype:"syno_schedulefield",name:"date",fieldLabel:_T("time","time_date"),allowBlank:!1,editable:!1,width:300,labelWidth:100}),t.push({xtype:"syno_compositefield",labelWidth:100,fieldLabel:_T("time","time_time"),items:[{xtype:"syno_combobox",name:"hour",width:142,displayField:"display",valueField:"value",store:SYNO.SDS.Utils.createTimeItemStore("hour"),"aria-label":_T("time","time_time")+" "+_T("time","time_hour")},{xtype:"syno_displayfield",value:":",width:6,tabIndex:-1},{xtype:"syno_combobox",name:"min",width:142,displayField:"display",valueField:"value",store:SYNO.SDS.Utils.createTimeItemStore("min"),"aria-label":_T("time","time_time")+" "+_T("time","time_minute")}]}),t.push({xtype:"syno_displayfield",id:this.noteId=Ext.id(),htmlEncode:!1,value:""}),t.push({xtype:"syno_checkbox",hidden:"add"!=e.mode,boxLabel:_T("common","enabled"),name:"enabled",checked:!0});var i={trackResetOnLoad:!0,border:!1,items:t};return SYNO.LayoutConfig.fill(i),new Ext.form.FormPanel(i)},getTaskValue:function(){return{action:this.form.findField("action").getGroupValue(),triggertime:String.format("{0}:{1}:{2}",this.form.findField("date").getValue(),this.form.findField("hour").getValue(),this.form.findField("min").getValue()),enabled:this.form.findField("enabled").getValue()}},setTaskValue:function(e){this.record=e;var t=e.get("triggertime").split(":");this.form.findField("date").setValue(t[0]),this.form.findField("hour").setValue(t[1]),this.form.findField("min").setValue(t[2]),this.form.findField("action").setValue(e.get("action"))},setDefault:function(){var e="on";this.form.findField("date").setValue("0,1,2,3,4,5,6"),this.form.findField("hour").setValue(0),this.form.findField("min").setValue(0),!0!==this.isSupportAutoPowerOn&&(e="off"),this.form.findField("action").setValue(e)},onOpen:function(){this.setStatusBusy();var e=this.module;this.setDefault(),"edit"==this.mode&&(this.record=e.getSelectionModel().getSelected(),this.setTaskValue(this.record)),this.clearStatusBusy(),this.callParent()},onApply:function(){var e=this.getTaskValue(),t=this.module,i=t.getStore().indexOf(this.record);-1==t.getStore().findBy((function(t,s){var n=t.get("triggertime").split(":"),o=e.triggertime.split(":"),a=[],r=[],l=0;if(n[1]!=o[1]||n[2]!=o[2])return!1;if(i==t.store.indexOf(t))return!1;for((a=n[0].split(","))[0]||(a[0]=n[0]),(r=o[0].split(","))[0]||(r[0]=o[0]),l=0;l<r.length;l++)if(-1<a.indexOf(r[l]))return!0;return!1}))?("add"==this.mode?t.getStore().loadData([[e.enabled,e.triggertime,e.action]],!0):"edit"==this.mode&&(this.record.set("triggertime",e.triggertime),this.record.set("action",e.action)),this.close()):this.setStatusError({text:_T("network","route_static_rule_error"),clear:!0})},changeNote:function(e){var t="";switch(e){case"on":"yes"===_D("supportrcpower")&&(t='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("rcpower","schpoweron_note"));break;case"off":t='<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("rcpower","schpoweroff_note");break;default:t=""}Ext.getCmp(this.noteId).setValue(t)}}),Ext.ns("SYNO.SDS.AdminCenter.HardwareControl"),SYNO.SDS.AdminCenter.HardwareControl.MAX_POWER_SCHEDULE_TASKS=200,Ext.define("SYNO.SDS.AdminCenter.HardwareControl.ScheduleTab",{extend:"SYNO.SDS.Utils.FormPanel",panel:null,constructor:function(e){var t,i=this;i.owner=e.owner,i.module=e.module,t=i.fillConfig(e),i.callParent([t]),i.getForm().items.items.push(i.panel)},fillConfig:function(e){this.panel=new SYNO.SDS.AdminCenter.HardwareControl.ScheduleTabGrid({module:this.module,formPanel:this});var t={title:_T("rcpower","power_schedule"),layout:"fit",style:{paddingLeft:"0px",paddingRight:"0px"},items:this.panel};return Ext.apply(t,e),t},isDirty:function(){return this.panel.isDirty()},getHelpParam:function(){return this.panel.getHelpParam()}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.ScheduleTabGrid",{extend:"SYNO.ux.EditorGridPanel",taskAddOrRemoved:!1,constructor:function(e){var t;this.formPanel=e.formPanel,this.module=e.module,this.taskData=null,t={autoScroll:!0,webapi:{api:"SYNO.Core.Hardware.PowerSchedule",methods:{get:"load",set:"save"},version:1}},this.isSupportAutoPowerOn="yes"===_D("support_auto_poweron"),Ext.apply(t,e),t=this.fillConfig(t),this.callParent([t]),this.mon(this.getSelectionModel(),"selectionchange",this.onChgButtonStatus,this,{buffer:50}),this.mon(this.getStore(),"update",this.onChgButtonStatus,this),this.mon(this.getStore(),"remove",(function(e,t,i){this.taskAddOrRemoved=!0,this.onChgButtonStatus()}),this),this.mon(this.getStore(),"add",(function(e,t,i){this.taskAddOrRemoved=!0,this.onChgButtonStatus()}),this),this.mon(this,"celldblclick",(function(e,t,i,s){this.openTaskDialog("edit")}),this)},fillConfig:function(e){var t=new Ext.data.ArrayStore({autoDestroy:!0,fields:["enabled","triggertime","action"],data:[]}),i={header:_T("common","enabled"),dataIndex:"enabled",width:80,menuDisabled:!0,align:"center"},s=new SYNO.ux.EnableColumn(i),n=new SYNO.ux.ComboBox({store:new Ext.data.ArrayStore({fields:["value","display"],data:[["on",_T("system","poweron_opt")],["off",_T("system","poweroff_opt")]]}),lazyRender:!0,mode:"local",displayField:"display",valueField:"value",triggerAction:"all",editable:!1}),o={ds:t,cm:new Ext.grid.ColumnModel([s,{width:150,header:_T("rcpower","trigger_time"),dataIndex:"triggertime",sortable:!0,scope:this,renderer:function(e,t){var i=e.split(":");return String.format("{0} {1}:{2}",function(e){var t="",i=[];return"0,1,2,3,4,5,6"==e?t=_T("schedule","schedule_daily"):"0,6"==e?t=_T("schedule","schedule_weekend"):"1,2,3,4,5"==e?t=_T("schedule","schedule_weekdays"):(i=(t=(t=(t=(t=(t=(t=(t=(t=e).replace("0",_T("schedule","schedule_sun"))).replace("1",_T("schedule","schedule_mon"))).replace("2",_T("schedule","schedule_tue"))).replace("3",_T("schedule","schedule_wed"))).replace("4",_T("schedule","schedule_thu"))).replace("5",_T("schedule","schedule_fri"))).replace("6",_T("schedule","schedule_sat"))).split(","),t=i.join(", ")),t}(i[0]),i[1],this.convert2Digits(i[2]))}},{header:_T("rcpower","action"),dataIndex:"action",sortable:!0,renderer:function(e,t){return"on"==e?_T("system","poweron_opt"):_T("system","poweroff_opt")},editable:this.isSupportAutoPowerOn,editor:n,scope:this,width:100}]),loadMask:!1,hideMode:"offsets",enableHdMenu:!1,cls:"without-dirty-red-grid sm-test-schedule-tctab hc-toolbar-without-border-bottom",selModel:new Ext.grid.RowSelectionModel({singleSelect:!1}),plugins:[s],tbar:this.configTopToolbar(),style:{paddingTop:"0px"},listeners:{cellclick:{delay:100,fn:function(e,t,i,s){2==i&&e.startEditing(t,2)}},rowcontextmenu:this.onRowCtxMenu,containercontextmenu:this.showCtxMenu,scope:this}};return SYNO.LayoutConfig.fill(Ext.apply(o,e))},configTopToolbar:function(){return this.actionCreate=new Ext.Action({text:_T("common","create"),itemId:"create",scope:this,handler:function(e,t){this.openTaskDialog("add")}}),this.actionEdit=new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",scope:this,handler:function(e,t){this.openTaskDialog("edit")}}),this.actionDel=new Ext.Action({text:_T("common","delete"),itemId:"delete",scope:this,handler:function(){for(var e=this.getSelectionModel().getSelections(),t=this.getStore(),i=0;i<e.length;i++)t.remove(e[i]);this.handlerChgTasks(t)}}),this.actionSummary=new Ext.Action({text:_T("schedule","schedule_summary"),itemId:"summary",scope:this,handler:this.openSummaryDialog}),{items:[new SYNO.ux.Button(this.actionCreate),new SYNO.ux.Button(this.actionEdit),new SYNO.ux.Button(this.actionDel),new SYNO.ux.Button(this.actionSummary)]}},onRowCtxMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.showCtxMenu(e,i)},showCtxMenu:function(e,t){var i=[];i.push(this.actionCreate),i.push(this.actionEdit),i.push(this.actionDel),i.push(this.actionSummary);var s=new SYNO.ux.Menu({autoDestroy:!0,items:i});this.onChgButtonStatus(),s.showAt(t.getXY())},processReturnData:function(e,t,i){for(var s={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},n={api:this.webapi.api,method:this.webapi.methods.set,version:this.webapi.version},o="get"===e?s:n,a=0;a<t.result.length;a++)if(!1!==SYNO.ux.Utils.checkApiConsistency(o,t.result[a])){if(!1===t.result[a].success||!t.result[a].data)return void this.module.appWin.getMsgBox().alert(_T("rcpower","power_schedule"),_T("rcpower","power_schedule")+": "+SYNO.API.getErrorString(t.result[a].error.code));"get"===e?(this.updatePowerSchedule(t.result[a].success,t.result[a]),this.onChgButtonStatus()):this.saveScheduleHandler(t.result[a].success,t.result[a]);break}},updatePowerSchedule:function(e,t){if(!e||!t||!t.data)return!1;var i="",s=0,n=this.getStore(),o=[];if(SYNO.Debug("obj.data.poweron_tasks: "+t.data.poweron_tasks.length),SYNO.Debug("obj.data.poweroff_tasks: "+t.data.poweroff_tasks.length),t.data.poweron_tasks)for(s=0;s<t.data.poweron_tasks.length;++s)i=String.format("{0}:{1}:{2}",t.data.poweron_tasks[s].weekdays,t.data.poweron_tasks[s].hour,t.data.poweron_tasks[s].min),o.push([t.data.poweron_tasks[s].enabled,i,"on"]);if(t.data.poweroff_tasks)for(s=0;s<t.data.poweroff_tasks.length;++s)i=String.format("{0}:{1}:{2}",t.data.poweroff_tasks[s].weekdays,t.data.poweroff_tasks[s].hour,t.data.poweroff_tasks[s].min),o.push([t.data.poweroff_tasks[s].enabled,i,"off"]);return n.loadData(o),this.taskData=o,this.taskAddOrRemoved=!1,this.handlerChgTasks(n),!0},onChgButtonStatus:function(){var e=this.getSelectionModel(),t=this.actionCreate,i=this.actionEdit,s=this.actionDel;this.getStore().getCount()<SYNO.SDS.AdminCenter.HardwareControl.MAX_POWER_SCHEDULE_TASKS?t.enable():t.disable(),1==e.getCount()?i.enable():i.disable(),e.getCount()>0?s.enable():s.disable()},isScheduleModified:function(){return"yes"===_D("support_power_schedule")&&!!(this.getStore().getModifiedRecords().length>0||this.taskAddOrRemoved)},handlerChgTasks:function(e){e.commitChanges(),e.fireEvent("update",e,e.getModifiedRecords(),Ext.data.Record.EDIT)},getSubmitData:function(){for(var e=this.getStore(),t=[],i=[],s=0;s<e.getCount();s++){var n=e.getAt(s),o={},a=n.get("triggertime").split(":");o.enabled=n.get("enabled"),o.weekdays=a[0],o.hour=parseInt(a[1],10),o.min=parseInt(a[2],10),"on"==n.get("action")?t.push(o):i.push(o)}return{poweron_tasks:t,poweroff_tasks:i}},openTaskDialog:function(e){new SYNO.SDS.AdminCenter.HardwareControl.ScheduleTaskDialog({owner:this.module.appWin,module:this,mode:e,supportAutoPowerOn:this.isSupportAutoPowerOn}).open()},convert2Digits:function(e){return e<10?"0"+e.toString():e.toString()},openSummaryDialog:function(){new SYNO.SDS.AdminCenter.HardwareControl.ScheduleSummaryDialog({owner:this.module.appWin,module:this,supportAutoPowerOn:this.isSupportAutoPowerOn}).open()},isDirty:function(){return this.isScheduleModified()},getSaveApiCfg:function(){if(!0===this.isScheduleModified()&&!_S("demo_mode"))return{api:"SYNO.Core.Hardware.PowerSchedule",method:"save",params:this.getSubmitData(),version:1}},saveScheduleHandler:function(e,t,i,s){var n=[],o=this.getStore();this.handlerChgTasks(o),this.taskAddOrRemoved=!1,this.onChgButtonStatus(),void 0===this.module.confirmSaveLostResolve&&void 0===this.module.confirmSaveLostReject&&this.module.getPanel().GeneralTab.loadForm(),o.data.items.forEach((function(e){n.push([e.data.enabled,e.data.triggertime,e.data.action])})),this.taskData=n},getHelpParam:function(){return"AdminCenter/system_hardware_schedule.html"},validate:function(){return!0},reset:function(){var e=this.getStore();null!==this.taskData&&(e.loadData(this.taskData),e.clearModified(e.getModifiedRecords()),this.taskAddOrRemoved=!1)}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.DCOutputTaskDialog",{extend:"SYNO.SDS.ModalWindow",DEFAULT_MODE:"edit",constructor:function(e){this.mode=e.mode||this.DEFAULT_MODE,this.panel=this.createPanel();var t=Ext.apply({title:"edit"==this.mode?_T("rcpower","edit_task"):_T("rcpower","add_task"),width:500,height:300,resizable:!1,items:[this.panel],buttons:[{text:_T("common","alt_apply"),btnStyle:"blue",scope:this,handler:this.onApply},{text:_T("common","alt_cancel"),btnStyle:"gray",scope:this,handler:this.onCancel}]},e);this.callParent([t])},createPanel:function(){var e=[];return Ext.each(["on","off","reset"],(function(t){e.push({xtype:"syno_radio",name:"action",itemId:t,boxLabel:_T("schedule","dcoutput_"+t)||t.toUpperCase(),inputValue:t})})),e.push({xtype:"syno_schedulefield",name:"weekdays",fieldLabel:_T("time","time_date"),allowBlank:!1,editable:!1,width:300,labelWidth:100}),e.push({xtype:"syno_compositefield",labelWidth:100,fieldLabel:_T("time","time_time"),items:[{xtype:"syno_combobox",name:"hour",width:142,displayField:"display",valueField:"value",store:SYNO.SDS.Utils.createTimeItemStore("hour")},{xtype:"syno_displayfield",value:":",width:6},{xtype:"syno_combobox",name:"minute",width:142,displayField:"display",valueField:"value",store:SYNO.SDS.Utils.createTimeItemStore("min")}]}),new Ext.form.FormPanel({trackResetOnLoad:!0,border:!1,items:e})},onOpen:function(e){this.task=e,this.changed=!1,this.panel.getForm().setValues({action:e.action,weekdays:e.weekdays.join(","),hour:e.hour,minute:e.minute}),this.callParent([])},onApply:function(){var e=this.panel.getForm();if("edit"!==this.mode||e.isDirty()){var t=[];Ext.each(e.findField("weekdays").getValue().split(","),(function(e){t.push(parseInt(e,10))})),Ext.apply(this.task,{action:e.findField("action").getGroupValue(),hour:e.findField("hour").getValue(),minute:e.findField("minute").getValue(),weekdays:t}),this.changed=!0,this.close()}else this.close()},onCancel:function(){this.panel.getForm().isDirty()?this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this):this.close()},getResultTask:function(){return this.changed?this.task:null}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.DCOutputTab",{extend:"SYNO.ux.GridPanel",DEFAULT_TASK:{task_name:"",enabled:!0,action:"on",hour:0,minute:0,weekdays:[0,1,2,3,4,5,6]},TASK_FIELDS:["task_id","task_name","enabled","action","hour","minute","weekdays"],constructor:function(e){this.createTasks=[],this.deleteTasks=[],this.module=e.module;var t=this.fillConfig();this.callParent([t]),this.mon(this,"celldblclick",(function(){this.openTaskDialog("edit")}),this),this.mon(this.store,"update",(function(){this.updateButtons()}),this),this.mon(this.getSelectionModel(),"selectionchange",(function(){this.updateButtons()}),this,{buffer:50}),this.mon(this,"keydown",(function(e){e.getKey()===e.DELETE&&this.deleteHandler()}),this)},getStore:function(){return Ext.isDefined(this.store)||(this.store=new SYNO.API.JsonStore({autoDestroy:!0,appWindow:this.findAppWindow(),api:"SYNO.Core.Hardware.DCOutput.Task",method:"load",version:1,root:"tasks",idProperty:"task_id",fields:this.TASK_FIELDS})),this.store},getColumnModel:function(){if(Ext.isDefined(this.colModel))return this.colModel;var e=function(e){return 10>e?"0"+e:e};return this.colModel=new Ext.grid.ColumnModel([new SYNO.ux.EnableColumn({header:_T("common","enabled"),width:80,align:"center",menuDisabled:!0,id:"enabled",dataIndex:"enabled"}),{header:_T("rcpower","trigger_time"),width:150,align:"center",menuDisabled:!0,renderer:function(t,i,s){return String.format("{0} {1}:{2}",(n=s.get("weekdays"),"0,1,2,3,4,5,6"===(o=n.sort().join(","))?_T("schedule","schedule_daily"):"0,6"===o?_T("schedule","schedule_weekend"):"1,2,3,4,5"===o?_T("schedule","schedule_weekdays"):o=(o=(o=(o=(o=(o=(o=o.replace("0",_T("schedule","schedule_sun"))).replace("1",_T("schedule","schedule_mon"))).replace("2",_T("schedule","schedule_tue"))).replace("3",_T("schedule","schedule_wed"))).replace("4",_T("schedule","schedule_thu"))).replace("5",_T("schedule","schedule_fri"))).replace("6",_T("schedule","schedule_sat"))),e(s.get("hour")),e(s.get("minute")));var n,o},scope:this},{header:_T("rcpower","action"),width:100,align:"center",sortable:!0,dataIndex:"action",renderer:function(e){return _T("schedule","dcoutput_"+e)||e.toUpperCase()},scope:this}]),this.colModel},fillConfig:function(){return SYNO.LayoutConfig.fill({title:_T("schedule","dcoutput_title")||"DC Output",autoScroll:!0,loadMask:!0,hideMode:"offsets",cls:"without-dirty-red-grid",ds:this.getStore(),cm:this.getColumnModel(),plugins:[this.getColumnModel().getColumnById("enabled")],selModel:new Ext.grid.RowSelectionModel({singleSelect:!1}),tbar:[{xtype:"syno_button",text:_T("common","create"),itemId:"create",scope:this,handler:function(e,t){this.openTaskDialog("create")}},{xtype:"syno_button",text:_T("common","alt_edit"),itemId:"edit",disabled:!0,scope:this,handler:function(e,t){this.openTaskDialog("edit")}},{xtype:"syno_button",text:_T("common","delete"),itemId:"delete",disabled:!0,scope:this,handler:function(e,t){this.deleteHandler()}},{xtype:"syno_button",disabled:!0,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","save"),itemId:"save",scope:this,handler:this.saveTasks}]})},deleteHandler:function(){Ext.each(this.getSelectionModel().getSelections(),(function(e){this.store.remove(e),this.updateEditStatus("delete",e.get("task_id"))}),this)},resetEditStatus:function(){this.nextTaskId=-1,this.createTasks=[],this.deleteTasks=[],this.store.commitChanges(),this.updateButtons()},updateEditStatus:function(e,t){if("create"===e)this.createTasks.push(t),this.nextTaskId=t-1;else if("delete"===e)if(0<t)this.deleteTasks.push(t);else{var i=this.createTasks.indexOf(t);-1!==i&&this.createTasks.splice(i,1)}this.updateButtons()},updateButtons:function(){var e=this.getSelectionModel(),t=this.getTopToolbar().getComponent("edit"),i=this.getTopToolbar().getComponent("delete"),s=this.getTopToolbar().getComponent("save");1===e.getCount()?t.enable():t.disable(),0<e.getCount()?i.enable():i.disable(),!_S("demo_mode")&&this.isScheduleModified()?s.enable():s.disable()},openTaskDialog:function(e){var t=this.getSelectionModel().getSelected(),i=new SYNO.SDS.AdminCenter.HardwareControl.DCOutputTaskDialog({owner:this.findAppWindow(),mode:e});i.mon(i,"close",(function(){var e=i.getResultTask();Ext.isObject(e)&&("edit"===i.mode?(t.set("action",e.action),t.set("hour",e.hour),t.set("minute",e.minute),t.set("weekdays",e.weekdays)):(this.store.loadData({tasks:[e]},!0),this.updateEditStatus("create",e.task_id)))}),this),i.open(Ext.copyTo({task_id:this.nextTaskId},"edit"===e?t.data:this.DEFAULT_TASK,this.TASK_FIELDS))},isScheduleModified:function(){var e=!1;return Ext.each(this.store.getModifiedRecords(),(function(t){if(t.get("task_id")>0)return e=!0,!1})),0<this.createTasks.length||0<this.deleteTasks.length||e},saveTasks:function(){if(this.isScheduleModified()){this.ownerCt.setStatusBusy({text:_T("common","saving")});var e=[];Ext.each(this.store.getModifiedRecords(),(function(t){if(t.get("task_id")<0)return!0;e.push(t.data)})),Ext.each(this.createTasks,(function(t){e.push(this.store.getById(t).data)}),this),this.sendWebAPI({compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.Hardware.DCOutput.Task",method:"update",version:1,params:{tasks:e}},{api:"SYNO.Core.Hardware.DCOutput.Task",method:"delete",version:1,params:{tasks:this.deleteTasks}}]},scope:this,callback:function(e,t){this.ownerCt.clearStatusBusy();var i=_T("common","error_system");if(e){if(!t.has_fail)return this.store.load(),void this.resetEditStatus();var s=SYNO.API.Response.GetFirstError(t);SYNO.API.Erros.core[s]&&(i=SYNO.API.Erros.core[s])}else;this.ownerCt.getMsgBox().alert(this.title,i),this.updateButtons()}})}}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.DCOutputDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.panel=new SYNO.SDS.AdminCenter.HardwareControl.DCOutputTab({module:e.module});var t=Ext.apply({title:_T("dcoutput","dcoutput_schedule_title"),width:560,height:500,minWidth:460,minHeight:400,layout:"fit",buttons:[{text:_T("common","alt_close"),scope:this,handler:this.beforeClose}],items:[this.panel]},e);this.callParent([t]),this.mon(this,"show",(function(){this.panel.resetEditStatus(),this.panel.getStore().load()}),this)},beforeClose:function(){this.panel.isScheduleModified()?this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this):this.close()}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.DCOutputForm",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.callParent([this.fillConfig()]),new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable",[this.btnSchedule])},fillConfig:function(){return SYNO.LayoutConfig.fill({title:_T("schedule","dcoutput_title"),autoScroll:!0,webapi:{api:"SYNO.Core.Hardware.DCOutput",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("dcoutput","dcoutput_desc")},{xtype:"syno_checkbox",name:"enable",boxLabel:_T("dcoutput","enable_dcoutput")},{xtype:"syno_button",name:"schedule",id:this.btnSchedule=Ext.id(),text:_T("dcoutput","schedule_dcoutput"),indent:1,scope:this,handler:this.openScheduleDialog},{xtype:"syno_displayfield",name:"status_on",htmlEncode:!1,value:_T("dcoutput","dcoutput_status_title")+': <font class="green-status">'+_T("dcoutput","dcoutput_status_on")+"</font>",hidden:!0},{xtype:"syno_displayfield",name:"status_off",htmlEncode:!1,value:_T("dcoutput","dcoutput_status_title")+': <font class="red-status">'+_T("dcoutput","dcoutput_status_off")+"</font>",hidden:!0}]})},processReturnData:function(e,t,i){var s={api:"SYNO.Core.Hardware.DCOutput",method:"get",version:1};Ext.each(t.result,(function(e){if(e.success&&SYNO.ux.Utils.checkApiConsistency(s,e)){var t=this.getForm();"on"===e.data.status?(t.findField("status_on").show(),t.findField("status_off").hide()):(t.findField("status_on").hide(),t.findField("status_off").show())}}),this),this.callParent(arguments)},openScheduleDialog:function(){new SYNO.SDS.AdminCenter.HardwareControl.DCOutputDialog({module:this.module,owner:this.findAppWindow()}).open()},getHelpParam:function(){return"AdminCenter/system_hardware_dc_output.html"}}),Ext.ns("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.HibernationTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),this.on("activate",(function(){_S("ha_running")&&this.el.mask(_TT("SYNO.SDS.HA.Instance","ui","ha_not_support_setting"),"syno-ux-mask-info")}),this),this.on("deactivate",(function(){_S("ha_running")&&this.el.unmask()}),this)},fillConfig:function(e){var t={title:0<=_D("unique").indexOf("qoriq")?_T("hibernation","hibernation_title"):_T("helptoc","power_hibernation"),autoScroll:!0,webapi:{api:"SYNO.Core.Hardware.Hibernation",methods:{get:"get",set:"set"},version:1},labelWidth:250,items:this.getItemList()};return Ext.apply(t,e),SYNO.LayoutConfig.fill(t)},getItemList:function(){var e=[];return this.getSATASleepCfg(e),e.push({xtype:"syno_checkbox",name:"eunit_deep_sleep",boxLabel:_T("hddsleep","eunit_deep_sleep_subject"),id:this.eunitDeepSleepBtnId=Ext.id(),disabled:!0,hideLabel:!0,hidden:!0}),e.push({xtype:"syno_displayfield",fieldLabel:_T("hddsleep","hddsleep_not_support"),value:"",id:this.incompatibleId=Ext.id(),hidden:!1}),e.push({xtype:"syno_displayfield",value:_T("hddsleep","usb_hddsleep_desc")}),e.push({xtype:"syno_combobox",name:"usb_idletime",id:this.usbIdleTimeComboId=Ext.id(),disabled:_S("ha_running"),fieldLabel:_T("time","time_time"),store:this.getUSBSleepStore(),displayField:"display",valueField:"value",width:200,listeners:{scope:this,select:this.onUSBIdleTimeSelect}}),e.push({xtype:"syno_displayfield",value:_T("hddsleep","hdd_wakeup_log_desc")}),e.push({xtype:"syno_checkbox",name:"enable_log",boxLabel:_T("hddsleep","hdd_wakeup_log_subject"),id:this.wakeUpLogCheckBoxId=Ext.id(),disabled:!0,hideLabel:!0}),this.getAutoPoweroffCfg(e),e},getSATASleepCfg:function(e){e.push({xtype:"syno_displayfield",value:_T("hddsleep","hddsleep_desc"),id:this.hddSleepDesc=Ext.id(),hidden:!0}),e.push({xtype:"syno_combobox",name:"internal_hd_idletime",id:this.hddIdleTimeComboId=Ext.id(),disabled:_S("ha_running"),fieldLabel:_T("time","time_time"),store:this.getHDDSleepStore(),displayField:"display",valueField:"value",width:200,hidden:!0,listeners:{scope:this,select:this.onHDDIdleTimeSelect}}),"yes"===_D("sata_deep_sleep_en")&&(e.push({xtype:"syno_checkbox",name:"sata_deep_sleep",boxLabel:0<=_D("unique").indexOf("qoriq")?_T("hibernation","hibernation_system_deepsleep_statement"):String.format(_T("hddsleep","sata_deep_sleep_subject"),_D("upnpmodelname")),id:this.sataDeepSleepBtnId=Ext.id(),disabled:!0,hideLabel:!0,hidden:!0,listeners:{scope:this,check:function(e,t){t?Ext.getCmp(this.ignoreNetbiosBroadcastCheckBoxId).enable():Ext.getCmp(this.ignoreNetbiosBroadcastCheckBoxId).disable()},enable:function(e){var t=Ext.getCmp(this.ignoreNetbiosBroadcastCheckBoxId);e.getValue()?t.enable():t.disable()},disable:function(){Ext.getCmp(this.ignoreNetbiosBroadcastCheckBoxId).disable()}}}),e.push({xtype:"syno_checkbox",name:"ignore_netbios_broadcast",boxLabel:_T("hibernation","hibernation_ignore_netbios_broadcast"),id:this.ignoreNetbiosBroadcastCheckBoxId=Ext.id(),disabled:!0,hideLabel:!0,hidden:!0}))},getAutoPoweroffCfg:function(e){this.isSupportAutoPoweroff()&&(e.push({xtype:"syno_displayfield",itemId:"autopoweroffNoteId",hideLabel:!0,htmlEncode:!1,value:String.format(_T("autopoweroff","autopoweroff_desc"),'<a id="'+Ext.id()+'" class="link-font" href="">'+_T("autopoweroff","str_autopoweroff_wol")+"</a>"),listeners:{render:function(e){var t=e.el.first("a");t&&this.mon(t,"click",(function(e){e.preventDefault(),SYNO.SDS.AdminCenter.HardwareControl.HibernationTab.Utils.onClickShareUrl(this.module)}),this)},scope:this,single:!0,buffer:80},reset:Ext.emptyFn}),e.push({xtype:"syno_checkbox",name:"auto_poweroff_enable",boxLabel:_T("autopoweroff","autopoweroff_service"),id:this.autoPoweroffCheckBoxId=Ext.id(),disabled:!0,hideLabel:!0,listeners:{scope:this,check:function(e,t){var i=Ext.getCmp(this.autoPoweroffComboBoxId);t?(i.enable(),i.setValue(10)):i.disable()}}}),e.push({xtype:"syno_combobox",name:"auto_poweroff_time",id:this.autoPoweroffComboBoxId=Ext.id(),disabled:!0,fieldLabel:_T("time","time_time"),store:this.getAutoPoweroffStore(),displayField:"display",valueField:"value",width:200}))},getHDDSleepStore:function(){return new Ext.data.SimpleStore({fields:["value","display"],data:[[0,_T("hddsleep","hddsleep_none")],[10,"10 "+_T("hddsleep","hddsleep_min")],[15,"15 "+_T("hddsleep","hddsleep_min")],[20,"20 "+_T("hddsleep","hddsleep_min")],[30,"30 "+_T("hddsleep","hddsleep_min")],[60,"1 "+_T("hddsleep","hddsleep_hour")],[120,"2 "+_T("hddsleep","hddsleep_hours")],[180,"3 "+_T("hddsleep","hddsleep_hours")],[240,"4 "+_T("hddsleep","hddsleep_hours")],[300,"5 "+_T("hddsleep","hddsleep_hours")]]})},getUSBSleepStore:function(){return new Ext.data.SimpleStore({fields:["value","display"],data:[[0,_T("hddsleep","hddsleep_none")],[10,"10 "+_T("hddsleep","hddsleep_min")],[15,"15 "+_T("hddsleep","hddsleep_min")],[20,"20 "+_T("hddsleep","hddsleep_min")],[30,"30 "+_T("hddsleep","hddsleep_min")],[60,"1 "+_T("hddsleep","hddsleep_hour")],[120,"2 "+_T("hddsleep","hddsleep_hours")],[180,"3 "+_T("hddsleep","hddsleep_hours")],[240,"4 "+_T("hddsleep","hddsleep_hours")],[300,"5 "+_T("hddsleep","hddsleep_hours")]]})},getAutoPoweroffStore:function(){return new Ext.data.SimpleStore({fields:["value","display"],data:[[10,"10 "+_T("hddsleep","hddsleep_min")],[15,"15 "+_T("hddsleep","hddsleep_min")],[20,"20 "+_T("hddsleep","hddsleep_min")],[30,"30 "+_T("hddsleep","hddsleep_min")],[60,"1 "+_T("hddsleep","hddsleep_hour")],[120,"2 "+_T("hddsleep","hddsleep_hours")],[180,"3 "+_T("hddsleep","hddsleep_hours")],[240,"4 "+_T("hddsleep","hddsleep_hours")],[300,"5 "+_T("hddsleep","hddsleep_hours")]]})},onHDDIdleTimeSelect:function(e,t,i){var s=t.get("value");"yes"!==this.enable_eunit_deep_sleep||_S("ha_running")||(0!==s&&this.support_eunit_deep_sleep&&"none"===this.eunit_dsleep_blacklist?Ext.getCmp(this.eunitDeepSleepBtnId).enable():(Ext.getCmp(this.eunitDeepSleepBtnId).disable(),Ext.getCmp(this.eunitDeepSleepBtnId).setValue(!1))),"yes"!==_D("sata_deep_sleep_en")||_S("ha_running")||"none"!==this.sata_dsleep_blacklist||(0!==s?Ext.getCmp(this.sataDeepSleepBtnId).enable():(Ext.getCmp(this.sataDeepSleepBtnId).disable(),Ext.getCmp(this.sataDeepSleepBtnId).setValue(!1))),0!==s||0!==Ext.getCmp(this.usbIdleTimeComboId).getValue()?Ext.getCmp(this.wakeUpLogCheckBoxId).enable():(Ext.getCmp(this.wakeUpLogCheckBoxId).disable(),Ext.getCmp(this.wakeUpLogCheckBoxId).setValue(!1)),0!==s?this.updateAutoPoweroff("internal_hibernation",!0):this.updateAutoPoweroff("internal_hibernation",!1)},onUSBIdleTimeSelect:function(e,t,i){0!==t.get("value")||0!==Ext.getCmp(this.hddIdleTimeComboId).getValue()?Ext.getCmp(this.wakeUpLogCheckBoxId).enable():(Ext.getCmp(this.wakeUpLogCheckBoxId).disable(),Ext.getCmp(this.wakeUpLogCheckBoxId).setValue(!1))},processReturnData:function(e,t,i){this.callParent(arguments);var s,n,o,a,r={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version};for(n=0;n<t.result.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(r,t.result[n])){if(!1===t.result[n].success||!t.result[n].data){var l=0<=_D("unique").indexOf("qoriq")?_T("hibernation","hibernation_title"):_T("helptoc","power_hibernation");return void this.module.appWin.getMsgBox().alert(l,l+": "+SYNO.API.getErrorString(t.result[n].error.code))}s=t.result[n].data;break}if(s){if(this.updateSATASleepCfg(t.result[n].success,t.result[n]),this.updateDeepSleepControl(t.result[n].success,t.result[n]),0===s.internal_hd_idletime&&0===s.usb_idletime?(Ext.getCmp(this.wakeUpLogCheckBoxId).disable(),Ext.getCmp(this.wakeUpLogCheckBoxId).setValue(!1)):Ext.getCmp(this.wakeUpLogCheckBoxId).enable(),!0===s.auto_poweroff_enable&&Ext.getCmp(this.autoPoweroffCheckBoxId).enable(),"none"!==s.hibernation_blacklist){for(Ext.getCmp(this.hddIdleTimeComboId).disable(),Ext.getCmp(this.hddIdleTimeComboId).setValue(_T("common","not_support")),Ext.getCmp(this.incompatibleId).setVisible(!0),a=(o=(o=s.hibernation_blacklist).substring(1)).split(", "),o="",n=0;n<a.length;n++)o+=0===n?String.format("{0} {1}",_T("volume","volume_disk"),a[n]):String.format(", {0} {1}",_T("volume","volume_disk"),a[n]);Ext.getCmp(this.incompatibleId).setValue(o),Ext.getCmp(this.incompatibleId).originalValue=Ext.getCmp(this.incompatibleId).getValue()}else Ext.getCmp(this.incompatibleId).setVisible(!1);0===s.internal_hd_idletime?this.updateAutoPoweroff("internal_hibernation",!1):this.updateAutoPoweroff("internal_hibernation",!0)}},updateSATASleepCfg:function(e,t){this.support_esata=t.data.support_esata,(0<parseInt(_D("maxdisks","0"),10)||"no"!==this.support_esata)&&(Ext.getCmp(this.hddSleepDesc).setVisible(!0),Ext.getCmp(this.hddIdleTimeComboId).setVisible(!0),"yes"===_D("sata_deep_sleep_en")&&(Ext.getCmp(this.sataDeepSleepBtnId).setVisible(!0),0>_D("unique").indexOf("qoriq")?Ext.getCmp(this.ignoreNetbiosBroadcastCheckBoxId).setVisible(!1):Ext.getCmp(this.ignoreNetbiosBroadcastCheckBoxId).setVisible(!0)))},updateDeepSleepControl:function(e,t){if(this.enable_eunit_deep_sleep=t.data.enable_eunit_deep_sleep,this.eunit_dsleep_blacklist=t.data.eunit_dsleep_blacklist,this.sata_dsleep_blacklist=t.data.sata_dsleep_blacklist,this.support_esata=t.data.support_esata,Ext.QuickTips.init(),"no"!==this.esataSupport)if("yes"===t.data.enable_eunit_deep_sleep){this.support_eunit_deep_sleep=t.data.support_eunit_deep_sleep,Ext.getCmp(this.eunitDeepSleepBtnId).setVisible(!0),t.data.support_eunit_deep_sleep&&t.data.internal_hd_idletime&&"none"===t.data.eunit_dsleep_blacklist?Ext.getCmp(this.eunitDeepSleepBtnId).enable():Ext.getCmp(this.eunitDeepSleepBtnId).disable();var i=Ext.getCmp(this.eunitDeepSleepBtnId).boxlabelEl;if("none"!==t.data.eunit_dsleep_blacklist){var s=String.format(_T("hddsleep","eunit_dsleep_disable_tip"),t.data.eunit_dsleep_blacklist);i&&i.dom.setAttribute("ext:qtip",s)}else if(t.data.support_eunit_deep_sleep)i&&i.dom.getAttribute("ext:qtip")&&i.dom.removeAttribute("ext:qtip");else if(i){var n="";n=t.data.support_eunit_switch_mode?_T("hddsleep","eunit_dsleep_manual_disable_tip"):_T("common","not_support"),i.dom.setAttribute("ext:qtip",n)}}else Ext.getCmp(this.eunitDeepSleepBtnId).setVisible(!1);if("yes"===_D("sata_deep_sleep_en")){var o=0<=_D("unique").indexOf("qoriq")?_T("hibernation","hibernation_system_deepsleep_statement").replace("_MODEL_",_D("upnpmodelname")):String.format(_T("hddsleep","sata_deep_sleep_subject"),_D("upnpmodelname")),a=Ext.getCmp(this.sataDeepSleepBtnId).boxlabelEl;if(a)if(a.update(o),"none"!==t.data.sata_dsleep_blacklist){var r=String.format(_T("hddsleep","sata_dsleep_disable_tip"),t.data.sata_dsleep_blacklist);a.dom.setAttribute("ext:qtip",r)}else a.dom.getAttribute("ext:qtip")&&a.dom.removeAttribute("ext:qtip");t.data.internal_hd_idletime&&"none"===t.data.sata_dsleep_blacklist?Ext.getCmp(this.sataDeepSleepBtnId).enable():Ext.getCmp(this.sataDeepSleepBtnId).disable()}},updateAutoPoweroff:function(e,t){this.isSupportAutoPoweroff()&&("internal_hibernation"===e?this.internal_hibernation_enable=t:"wol"===e&&(this.wol_enable=t),this.internal_hibernation_enable&&this.wol_enable?Ext.getCmp(this.autoPoweroffCheckBoxId).enable():(Ext.getCmp(this.autoPoweroffCheckBoxId).disable(),Ext.getCmp(this.autoPoweroffCheckBoxId).setValue(!1),Ext.getCmp(this.autoPoweroffComboBoxId).disable()))},getHelpParam:function(){return"AdminCenter/system_hardware_hibernation.html"},isSupportAutoPoweroff:function(){return 0>_D("unique").indexOf("qoriq")&&0<parseInt(_D("maxdisks","0"),10)&&"yes"===_D("support_wol")}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.HibernationTab.Utils",{statics:{onClickShareUrl:function(e){e.app.startModule("SYNO.SDS.AdminCenter.HardwareControl.Main",{tab:"generalTab"})}}}),Ext.ns("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.DetailsDialog",{extend:"SYNO.SDS.ModalWindow",title:_T("volume","volume_details"),constructor:function(e){this.store=e.store,this.owner=e.owner,this.callParent([Ext.apply(e,{plain:!0,layout:"fit",items:[{xtype:"syno_gridpanel",stripeRows:!0,columns:[{header:_T("status","header_item"),width:100,sortable:!1,dataIndex:"name"},{header:_T("status","header_value"),useHtmlEncodeRender:!1,width:220,sortable:!1,dataIndex:"value"}],store:this.store}],buttons:[{text:_T("common","close"),scope:this,handler:function(){this.close()}}]})])}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.ACLListDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.module=e.module,this.UPSInfo=e.UPSInfo,this.current_mode="",this.form=this.createForm();var t=Ext.apply({title:_T("ups","networkups_desc"),width:520,height:260,layout:"fit",resizable:!1,buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.cancel},{btnStyle:"blue",text:_T("common","apply"),scope:this,handler:this.apply}],items:[this.form]},e);this.callParent([t])},createForm:function(){var e=300,t={border:!1,trackResetOnLoad:!0,labelWidth:120,items:[{xtype:"syno_textfield",fieldLabel:_T("common","ip_addr")+" 1",name:"acl0",value:this.UPSInfo.ACL_list[0],vtype:"ip",width:e},{xtype:"syno_textfield",fieldLabel:_T("common","ip_addr")+" 2",name:"acl1",value:this.UPSInfo.ACL_list[1],vtype:"ip",width:e},{xtype:"syno_textfield",fieldLabel:_T("common","ip_addr")+" 3",name:"acl2",value:this.UPSInfo.ACL_list[2],vtype:"ip",width:e},{xtype:"syno_textfield",fieldLabel:_T("common","ip_addr")+" 4",name:"acl3",value:this.UPSInfo.ACL_list[3],vtype:"ip",width:e},{xtype:"syno_textfield",fieldLabel:_T("common","ip_addr")+" 5",name:"acl4",value:this.UPSInfo.ACL_list[4],vtype:"ip",width:e}]};return SYNO.LayoutConfig.fill(t),new SYNO.SDS.Utils.FormPanel(t)},apply:function(){var e=this.form.getForm(),t="",i=0;if(e.isValid()){for(i=0;i<5&&(t="acl"+i,""===e.findField(t).getValue());i++);if(5!=i)if(e.isDirty()){for(i=0;i<5;i++)t="acl"+i,this.UPSInfo.ACL_list[i]=e.findField(t).getValue();this.module.getForm().findField("ACL_modified").setValue("true"),this.close()}else this.close();else this.getMsgBox().alert(_T("tree","leaf_ups"),_T("common","error_emptyip"))}else this.setStatusError({text:_T("common","forminvalid"),clear:!0})},cancel:function(){this.form.getForm().isDirty()?this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),(function(e){"yes"===e&&this.close()}),this):this.close()}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.HAUPSTab",{extend:"Ext.Container",constructor:function(e){var t=[];t.push({xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","ui","active"),itemId:"active_title",style:{fontSize:"15px",paddingLeft:"8px",lineHeight:"24px",color:"#3C76FF",borderBottom:"1px dashed rgba(198,212,224,0.7)"}}),t.push(new SYNO.SDS.AdminCenter.HardwareControl.UPSTab(Ext.apply({webapi:{api:"SYNO.Core.ExternalDevice.UPS",methods:{get:"get",set:"set"},version:1},itemId:"active_form",owner:this},e))),_S("is_ha_empty_passive")||(t.push({xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","ui","passive"),itemId:"passive_title",style:{fontSize:"15px",paddingLeft:"8px",lineHeight:"24px",color:"#3C76FF",borderBottom:"1px dashed rgba(198,212,224,0.7)"}}),t.push(new SYNO.SDS.AdminCenter.HardwareControl.UPSTab(Ext.apply({webapi:{api:"SYNO.SHA.UPS",methods:{get:"get",set:"set"},version:1,remote_api:"SYNO.Core.ExternalDevice.UPS",remote_version:1},itemId:"passive_form",owner:this},e))));var i={title:_T("tree","leaf_ups"),itemId:"UpsTab",layout:"form",autoFlexcroll:!0,hideMode:"offset",items:t};Ext.apply(i,e),this.callParent([i]),this.mon(this.getComponent("active_form"),"afterlayout",this.switchLayout,this),_S("is_ha_empty_passive")||this.mon(this.getComponent("passive_form"),"afterlayout",this.switchLayout,this)},getUPSForms:function(){var e=[];return e.push(this.getComponent("active_form")),_S("is_ha_empty_passive")||e.push(this.getComponent("passive_form")),e},getApiArray:function(e){var t=[];return this.getUPSForms().forEach((function(i){var s={api:i.webapi.api,method:"get"===e?i.webapi.methods.get:i.webapi.methods.set,version:i.webapi.version};t.push(s)})),t.push({api:"SYNO.SHA.Panel.Overview",method:"load",version:1}),t},getAllForms:function(){var e=[];return e.push(this.getComponent("active_form").getForm()),_S("is_ha_empty_passive")||e.push(this.getComponent("passive_form").getForm()),e},processReturnData:function(e,t,i){for(var s=0;s<t.result.length;s++){if(!1!==SYNO.ux.Utils.checkApiConsistency({api:"SYNO.SHA.Panel.Overview",method:"load",version:1},t.result[s])){if(t.result[s].success){var n=String.format("{0} ({1})","active"===t.result[s].data.lnode.role?t.result[s].data.lnode.hostname:t.result[s].data.rnode.hostname,_TT("SYNO.SDS.HA.Instance","ui","active"));if(this.getComponent("active_title").setValue(n),!_S("is_ha_empty_passive")){var o="passive"===t.result[s].data.lnode.role?t.result[s].data.lnode:t.result[s].data.rnode;this.passive_hostname=o.hostname;var a="{0} ({1})";"offline"===o.state&&(a="{0} ({1})({2})");var r=String.format(a,o.hostname,_TT("SYNO.SDS.HA.Instance","ui","passive"),_TT("SYNO.SDS.HA.Instance","status","offline"));this.getComponent("passive_title").setValue(r)}}break}}this.getUPSForms().forEach((function(s){s.processReturnData(e,t,i)}))},processParams:function(e,t){var i=arguments;return this.getUPSForms().forEach((function(e){t=e.processParams(...i)})),t},onBeforeRequest:function(){var e=arguments;return this.getUPSForms().every((t=>t.onBeforeRequest(...e)))},switchLayout:function(){this.getUPSForms().forEach((function(e){e.updateFleXcroll();var t=e.getScrollTarget();t&&t.dom.fleXdata&&e.setHeight(t.dom.fleXdata.cntSize[1])})),this.updateFleXcroll()},isDirty:function(){return!1},isValid:function(){return!0},getValues:function(){return{}},reset:function(){},isHAUpsTabDirty:function(){return this.getUPSForms().some((e=>!!e.checkFormDirty&&e.isFormDirty()))}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.UPSTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){if(this.module=e.module,"yes"===_D("supportups")){this.verSupportSNMPV3=4936,this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),this.setEnableService=!1,this.update=!1,this.mode_field=this.getForm().findField("mode"),this.mon(this.getForm().findField("enable"),"check",this.switchLayout,this),this.mon(this.getForm().findField("ACL_enable"),"check",this.switchLayout,this),this.mon(this.getForm().findField("ups_set_safemode_until_lowbatt"),"check",this.switchLayout,this),this.mon(this.getForm().findField("ups_set_safemode_customize_time"),"check",this.switchLayout,this),this.mon(this.getForm().findField("ups_time_unit_list"),"select",this.clearWaittimeInvalid,this),_S("version")>this.verSupportSNMPV3&&(this.mon(this.getForm().findField("snmp_version"),"select",this.switchLayout,this),this.mon(this.getForm().findField("snmp_auth"),"check",this.setSNMPAuthPrivacy,this),this.mon(this.getForm().findField("snmp_privacy"),"check",this.setSNMPPrivacy,this)),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("mode").getEl(),_T("ups","ups_type_tips")),SYNO.ux.AddTip(this.getForm().findField("ups_safemode_waittime_label").getEl(),_T("ups","ups_safemode_tips")),SYNO.ux.AddTip(this.getForm().findField("shutdown_device").getEl(),_T("ups","ups_shutdown_tips")),SYNO.ux.Utils.setFormItemIndent(this.getForm().findField("ups_safemode_waittime_label"))}),this,{single:!0}),this.mode_field.addEvents("ups_type_reset"),this.mode_field.resetOrigin=this.mode_field.reset,this.mode_field.reset=function(){this.resetOrigin(),this.fireEvent("ups_type_reset",this)},this.mon(this.mode_field,"select",this.modeChange,this),this.mon(this.mode_field,"ups_type_reset",this.modeChange,this),this.snmp_ver_field=this.getForm().findField("snmp_version"),this.snmp_ver_field.resetOrigin=this.snmp_ver_field.reset,this.snmp_ver_field.reset=function(){this.resetOrigin(),this.fireEvent("snmp_version_reset",this)},this.mon(this.snmp_ver_field,"snmp_version_reset",this.switchLayout,this);var i={api:"SYNO.Core.ExternalDevice.UPS",version:1,method:"get"};"passive_form"===this.getItemId()&&(i={api:"SYNO.SHA.UPS",version:1,method:"get",params:{remote_api:"SYNO.Core.ExternalDevice.UPS",remote_method:"get",remote_version:1}}),this.UPSPollingConf={interval:5,immediate:!0,webapi:i,status_callback:function(e,t){var i=!1;if("passive_form"===this.getItemId()){if(!e){if(6601===t.code){if(this.disabled)return;SYNO.Debug(t);var s="{0} ({1})({2})",n=String.format(s,this.owner.passive_hostname,_TT("SYNO.SDS.HA.Instance","ui","passive"),_TT("SYNO.SDS.HA.Instance","status","offline"));return this.owner.getComponent("passive_title").setValue(n),void this.setDisabled(!0)}return}this.disabled&&(SYNO.Debug(t),s="{0} ({1})",n=String.format(s,this.owner.passive_hostname,_TT("SYNO.SDS.HA.Instance","ui","passive")),this.owner.getComponent("passive_title").setValue(n),this.setDisabled(!1),i=!0)}(i||this.UPSInfo.mode!=t.mode)&&(this.__processUPSGetInfo(t),this.switchLayout())},scope:this}}},pollingTaskStart:function(){void 0===this.UPSPollingID&&(this.UPSPollingID=this.module.appWin.pollReg(this.UPSPollingConf))},pollingTaskStop:function(){void 0!==this.UPSPollingID&&(this.module.appWin.pollUnreg(this.UPSPollingID),this.UPSPollingID=void 0)},setSNMPAuthPrivacy:function(){!1===this.getForm().findField("snmp_auth").getValue()?this.setCompEnable(["snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key"],!1):(this.setCompEnable(["snmp_auth_type","snmp_auth_key","snmp_privacy"],!0),this.setSNMPPrivacy())},setSNMPPrivacy:function(){!1===this.getForm().findField("snmp_privacy").getValue()?this.setCompEnable(["snmp_privacy_type","snmp_privacy_key"],!1):this.setCompEnable(["snmp_privacy_type","snmp_privacy_key"],!0)},clearWaittimeInvalid:function(){this.getForm().findField("ups_customized_waittime").clearInvalid()},modeChange:function(){this.disabled||(this.processWaitTimeItem(this.getForm().findField("mode").getValue()),this.switchLayout())},switchLayout:function(){if(!this.disabled){var e=this.update?this.getForm().findField("enable").getValue():this.UPSInfo.enable,t=this.update?this.getForm().findField("mode").getValue():this.UPSInfo.mode,i=this.UPSInfo.mode,s=this.update?this.getForm().findField("ACL_enable").getValue():this.UPSInfo.ACL_enable,n=this.getForm().findField("ups_set_safemode_customize_time").getValue();if(this.setFieldVisible(["networkups_choose_hint"],!1),this.setFieldVisible(["usbups_choose_hint"],!1),"USB"===t?(this.setFieldUsed(["ups_set_safemode_until_lowbatt","ups_set_safemode_customize_time","shutdown_device","ACL_enable","mode"],!0),this.setFieldUsed(["net_server_ip","snmp_server_ip","snmp_version","snmp_community","snmp_mib","ups_set_safemode_same_as_server"],!1),this.setFieldUsed(["snmp_user","snmp_auth","snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key"],!1),this.getForm().findField("mode").enable(),this.getComponent("ups_waittime").enable(),this.getComponent("ACL_list_btn").setVisible(!0)):"SNMP"===t?(this.setFieldUsed(["mode","ups_set_safemode_until_lowbatt","ups_set_safemode_customize_time","snmp_server_ip","snmp_version","snmp_community","snmp_mib","ACL_enable"],!0),this.setFieldUsed(["shutdown_device","net_server_ip","ups_set_safemode_same_as_server"],!1),this.getComponent("ups_waittime").enable(),this.getComponent("ACL_list_btn").setVisible(!0),"yes"===_D("support_xa","no")&&(this.setFieldAndOriginalValues(this.getForm().findField("shutdown_device"),!1),this.setFieldUsed(["ACL_enable"],!1),this.getComponent("ACL_list_btn").setVisible(!1)),_S("version")>this.verSupportSNMPV3&&("v3"===this.getForm().findField("snmp_version").getValue()?(this.setFieldUsed(["snmp_user","snmp_auth","snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key"],!0),this.setFieldUsed(["snmp_community"],!1),this.setSNMPAuthPrivacy()):(this.setFieldUsed(["snmp_user","snmp_auth","snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key"],!1),this.setFieldUsed(["snmp_community"],!0)),""===this.UPSInfo.snmp_auth_type&&this.getForm().findField("snmp_auth_type").setValue("MD5"),""===this.UPSInfo.snmp_privacy_type&&this.getForm().findField("snmp_privacy_type").setValue("DES"),this.doLayout())):"SLAVE"===t&&(this.setFieldUsed(["mode","ups_set_safemode_customize_time","net_server_ip","ups_set_safemode_same_as_server"],!0),this.setFieldUsed(["shutdown_device","ACL_enable","snmp_server_ip","snmp_version","snmp_community","snmp_mib"],!1),this.setFieldUsed(["snmp_user","snmp_auth","snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key","ups_set_safemode_until_lowbatt"],!1),this.getComponent("ups_waittime").enable(),this.getComponent("ACL_list_btn").setVisible(!1),"localhost"===this.getForm().findField("net_server_ip").getValue()&&this.getForm().findField("net_server_ip").setValue("")),n?this.getComponent("ups_waittime").enable():this.getComponent("ups_waittime").disable(),s&&"no"===_D("support_xa","no")?this.getComponent("ACL_list_btn").enable():this.getComponent("ACL_list_btn").disable(),!e)return this.setCompEnable(["mode","shutdown_device","net_server_ip","snmp_server_ip","snmp_version","snmp_community","snmp_mib","snmp_user","snmp_auth","snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key","ACL_list_btn","ACL_enable","ups_waittime","ups_set_safemode_until_lowbatt","ups_set_safemode_customize_time","ups_set_safemode_same_as_server"],!1),this.UPSInfo.usb_ups_connect?(this.setFieldVisible(["no_ups_message"],!1),this.setFieldVisible(["usb_ups_connect_msg"],!0)):(this.setFieldVisible(["no_ups_message"],!0),this.setFieldVisible(["usb_ups_connect_msg"],!1)),this.setFieldVisible(["networkups_noconn"],!1),void this.getComponent("device_info").setVisible(!1);"USB"==t||t==i&&this.UPSInfo.enable?(this.setFieldVisible(["no_ups_message"],!1),this.setFieldVisible(["usb_ups_connect_msg"],!1),void 0!==this.UPSInfo.manufacture&&""!==this.UPSInfo.manufacture?(this.setFieldVisible(["networkups_noconn"],!1),this.getComponent("device_info").setVisible(!0)):(this.setFieldVisible(["networkups_noconn"],!0),this.getComponent("device_info").setVisible(!1))):(this.UPSInfo.usb_ups_connect?(this.setFieldVisible(["no_ups_message"],!1),this.setFieldVisible(["usb_ups_connect_msg"],!0)):(this.setFieldVisible(["no_ups_message"],!0),this.setFieldVisible(["usb_ups_connect_msg"],!1)),this.setFieldVisible(["networkups_noconn"],!1),this.getComponent("device_info").setVisible(!1)),"USB"==t&&"USB"!=i?(this.setFieldVisible(["networkups_choose_hint"],!0),this.setFieldVisible(["networkups_noconn"],!1),this.getComponent("ups_waittime").disable(),this.getComponent("ups_set_safemode_until_lowbatt").disable(),this.getComponent("ups_set_safemode_customize_time").disable(),this.getComponent("ACL_enable").disable(),this.getComponent("shutdown_device").disable(),this.setCompEnable(["ups_waittime","ups_set_safemode_same_as_server","ups_set_safemode_until_lowbatt","ups_set_safemode_customize_time","ACL_enable","shutdown_device"],!1)):this.setFieldVisible(["networkups_choose_hint"],!1),"USB"!=t&&"USB"==i?(this.setFieldVisible(["usbups_choose_hint"],!0),this.setFieldVisible(["networkups_noconn"],!1),this.getComponent("ups_waittime").disable(),this.setCompEnable(["ups_waittime","ups_set_safemode_same_as_server","ups_set_safemode_until_lowbatt","ups_set_safemode_customize_time","shutdown_device","net_server_ip","snmp_server_ip","snmp_version","snmp_community","snmp_mib","snmp_user","snmp_auth","snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key","ACL_list_btn","ACL_enable"],!1),e&&this.setFieldVisible(["usb_ups_connect_msg"],!1)):this.setFieldVisible(["usbups_choose_hint"],!1),i!=t&&this.getComponent("device_info").setVisible(!1),this.doLayout()}},getHelpParam:function(){return"AdminCenter/system_hardware_ups.html"},setFieldUsed:function(e,t){this.setFieldVisible(e,t),this.setCompEnable(e,t)},setFieldVisible:function(e,t){for(var i=0;i<e.length;i++)this.getForm().findField(e[i]).setVisible(t)},setCompEnable:function(e,t){for(var i=0;i<e.length;i++)t?this.getComponent(e[i]).enable():this.getComponent(e[i]).disable()},fillConfig:function(e){var t={title:_T("tree","leaf_ups"),itemId:"UpsTab",autoScroll:!0,webapi:{api:"SYNO.Core.ExternalDevice.UPS",methods:{get:"get",set:"set"},encryption:["snmp_auth_key","snmp_privacy_key"],version:1},items:this.getUPSItems()};return Ext.apply(t,e),t},getUPSItems:function(){this.labelWidth=300,this.comboboxWidth=200,this.fieldWidth=200;var e=/^[0-9a-zA-Z~`!@#$%^&*()_\-\+\=\|\/\{\[\}\];:<>,.?]+$/;return[{xtype:"syno_displayfield",hideLabel:!0,value:_T("ups","ups_desc")},{xtype:"syno_checkbox",name:"enable",boxLabel:_T("ups","usb_ups_enable")},{xtype:"syno_combobox",fieldLabel:_T("ups","ups_type"),labelWidth:this.labelWidth,name:"mode",itemId:"mode",indent:1,width:this.comboboxWidth,store:this.getModeStore(),value:this.mode_select[0][0],valueField:"value",displayField:"display",tpl:'<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item">{display}</div></tpl>'},{xtype:"syno_displayfield",cls:"hc-ups-safemode-waittime-label",name:"ups_safemode_waittime_label",itemId:"ups_safemode_waittime_label",indent:1,hideLabel:!0,value:_T("ups","ups_wait_time_desc"),htmlEncode:!1,isDirty:function(){return!1}},{indent:1,xtype:"syno_radio",name:"ups_set_safemode_waittime",itemId:"ups_set_safemode_same_as_server",boxLabel:_T("ups","ups_safemode_same_as_server")},{indent:1,xtype:"syno_radio",name:"ups_set_safemode_waittime",itemId:"ups_set_safemode_until_lowbatt",boxLabel:_T("ups","ups_safemode_until_lowbatt")},{indent:1,xtype:"syno_radio",name:"ups_set_safemode_waittime",itemId:"ups_set_safemode_customize_time",boxLabel:_T("ups","ups_safemode_customize_time")},{indent:2,fieldLabel:"Custom Set Time",hideLabel:!0,xtype:"syno_compositefield",itemId:"ups_waittime",items:[{xtype:"syno_numberfield",width:80,allowBlank:!1,value:"0",name:"ups_customized_waittime"},{xtype:"syno_displayfield",width:3,hidden:!0,name:"delay_time"},{xtype:"syno_combobox",width:100,hiddenName:"ups_time_unit_list",valueField:"id",displayField:"display",value:1,store:new Ext.data.ArrayStore({fields:["id","display"],idProperty:"id",data:[[1,_T("status","status_second")],[60,_T("status","status_minute")],[3600,_T("status","status_hour")]]})}]},{xtype:"syno_textfield",vtype:"ip",fieldLabel:_T("ups","upsmon_server"),labelWidth:this.labelWidth,name:"net_server_ip",itemId:"net_server_ip",maxLength:64,indent:1,width:this.fieldWidth,allowBlank:!1,maskRe:e,regex:e},{xtype:"syno_textfield",vtype:"ip",fieldLabel:_T("ups","snmpups_ip"),labelWidth:this.labelWidth,name:"snmp_server_ip",itemId:"snmp_server_ip",maxLength:64,indent:1,width:this.fieldWidth,allowBlank:!1,maskRe:e,regex:e},{xtype:"syno_combobox",fieldLabel:"SNMP MIB",labelWidth:this.labelWidth,name:"snmp_mib",itemId:"snmp_mib",indent:1,hidden:_S("version")<4935,width:this.comboboxWidth,store:this.getSNMPMibStore(),value:this.snmp_mib_select[0][0],valueField:"value",displayField:"display"},{xtype:"syno_combobox",fieldLabel:_T("ups","snmpups_version"),labelWidth:this.labelWidth,name:"snmp_version",itemId:"snmp_version",indent:1,width:this.comboboxWidth,store:this.getSNMPVersionStore(),value:this.snmp_version_select[1][0],valueField:"value",displayField:"display"},{xtype:"syno_textfield",fieldLabel:_T("ups","snmpups_community"),labelWidth:this.labelWidth,name:"snmp_community",itemId:"snmp_community",maxLength:64,indent:1,width:this.fieldWidth,allowBlank:!1},{xtype:"syno_textfield",fieldLabel:_T("common","owner"),labelWidth:this.labelWidth,name:"snmp_user",itemId:"snmp_user",minLength:1,maxLength:64,indent:1,width:this.fieldWidth,allowBlank:!1},{xtype:"syno_checkbox",name:"snmp_auth",itemId:"snmp_auth",indent:1,boxLabel:_T("snmp","snmp_auth")},{xtype:"syno_combobox",fieldLabel:_T("snmp","snmp_protocol"),labelWidth:this.labelWidth,name:"snmp_auth_type",itemId:"snmp_auth_type",indent:2,width:this.comboboxWidth,store:new Ext.data.ArrayStore({fields:["value","display"],data:[["MD5","MD5"],["SHA","SHA"]]}),value:"MD5",valueField:"value",displayField:"display"},{xtype:"syno_textfield",fieldLabel:_T("common","password"),textType:"password",labelWidth:this.labelWidth,name:"snmp_auth_key",itemId:"snmp_auth_key",minLength:8,maxLength:64,indent:2,width:this.fieldWidth},{xtype:"syno_checkbox",name:"snmp_privacy",itemId:"snmp_privacy",indent:1,boxLabel:_T("snmp","snmp_privacy")},{xtype:"syno_combobox",fieldLabel:_T("snmp","snmp_protocol"),labelWidth:this.labelWidth,name:"snmp_privacy_type",itemId:"snmp_privacy_type",indent:2,width:this.comboboxWidth,store:new Ext.data.ArrayStore({fields:["value","display"],data:[["DES","DES"],["AES","AES"]]}),value:"DES",valueField:"value",displayField:"display"},{xtype:"syno_textfield",fieldLabel:_T("common","password"),textType:"password",labelWidth:this.labelWidth,name:"snmp_privacy_key",itemId:"snmp_privacy_key",minLength:8,maxLength:64,indent:2,width:this.fieldWidth},{xtype:"syno_checkbox",name:"shutdown_device",itemId:"shutdown_device",boxLabel:_T("ups","ups_safemode_shutdown"),indent:1},{xtype:"syno_checkbox",name:"ACL_enable",itemId:"ACL_enable",boxLabel:_T("ups","networkups_enable"),indent:1},{xtype:"syno_button",name:"ACL_list_btn",btnStyle:"default",itemId:"ACL_list_btn",autoWidth:!0,indent:2,id:this.ACLListBtnId=Ext.id(),disabled:!0,text:_T("ups","networkups_desc"),scope:this,handler:function(){new SYNO.SDS.AdminCenter.HardwareControl.ACLListDialog({owner:this.module.appWin,module:this,UPSInfo:this.UPSInfo}).show()}},{xtype:"syno_displayfield",htmlEncode:!1,name:"no_ups_message",value:_T("ups","usb_ups_status_title")+": <font class='red-status'>"+_T("ups","usb_noups")+"</font>",hidden:!0},{xtype:"syno_displayfield",htmlEncode:!1,name:"usb_ups_connect_msg",value:_T("ups","usb_ups_status_title")+": <font class='red-status'>"+_T("ups","usb_ups_connect")+"</font>",hidden:!0},{xtype:"syno_displayfield",htmlEncode:!1,name:"networkups_noconn",value:_T("ups","usb_ups_status_title")+": <font class='red-status'>"+_T("ups","networkups_noconn")+"</font>",hidden:!0},{xtype:"syno_displayfield",htmlEncode:!1,name:"networkups_choose_hint",value:_T("ups","usb_ups_status_title")+": <font class='red-status'>"+_T("ups","networkups_select_hint")+"</font>",hidden:!0},{xtype:"syno_displayfield",htmlEncode:!1,name:"usbups_choose_hint",value:_T("ups","usb_ups_status_title")+": <font class='red-status'>"+_T("ups","usbups_select_hint")+"</font>",hidden:!0},{xtype:"syno_displayfield",name:"next_line"},{xtype:"syno_displayfield",name:"ACL_modified",value:"",hidden:!0},{xtype:"syno_button",name:"device_info",btnStyle:"default",itemId:"device_info",id:this.deviceInfoBtnId=Ext.id(),autoWidth:!0,text:_T("ups","usb_ups_status_title"),scope:this,handler:this.onClickStatusButton}]},onClickStatusButton:function(){var e,t,i=[],s=new Ext.data.ArrayStore({fields:["name","value"]});e="usb_ups_status_online"==this.UPSInfo.status?_T("ups",this.UPSInfo.status):"usb_ups_status_unknown"===this.UPSInfo.status?_T("common","not_support"):"<font class='red-status'>"+_T("ups",this.UPSInfo.status)+"</font>",t=-1==this.UPSInfo.runtime?_T("status","status_not_available"):this.UPSInfo.runtime+" "+_T("time","time_second"),i.push([_T("ups","usb_ups_manufacture"),this.UPSInfo.manufacture]),i.push([_T("ups","usb_ups_model"),this.UPSInfo.model]),i.push([_T("usb","usb_status"),e]),-1==this.UPSInfo.charge?i.push([_T("ups","usb_ups_charge"),_T("common","not_support")]):i.push([_T("ups","usb_ups_charge"),this.UPSInfo.charge+"%"]),i.push([_T("ups","usb_ups_runtime"),t]),s.loadData(i),new SYNO.SDS.AdminCenter.HardwareControl.DetailsDialog({owner:this.module.appWin,store:s,width:500,height:260}).open()},getModeStore:function(){return"yes"===_D("support_xa","no")?this.mode_select=[["SNMP",_T("ups","networkups_type_snmp")],["SLAVE",_T("ups","networkups_type_syno")]]:this.mode_select=[["USB",_T("ups","usb_ups")],["SNMP",_T("ups","networkups_type_snmp")],["SLAVE",_T("ups","networkups_type_syno")]],new Ext.data.ArrayStore({fields:["value","display"],data:this.mode_select})},getSNMPVersionStore:function(){return this.snmp_version_select=[["v1","v1"],["v2c","v2c"],["v3","v3"]],new Ext.data.ArrayStore({fields:["value","display"],data:this.snmp_version_select})},getSNMPMibStore:function(){var e=["auto","ietf","mge","apcc","netvision","pw","aphel_genesisII","aphel_revelation","raritan","baytech","cpqpower","cyberpower"];this.snmp_mib_select=[];for(var t=0;t<e.length;t++)this.snmp_mib_select.push([e[t],e[t]]);return new Ext.data.ArrayStore({fields:["value","display"],data:this.snmp_mib_select})},checkWaittimeValid:function(){var e="",t=0,i=this.getForm().findField("ups_time_unit_list").getValue();if(this.getForm().findField("ups_set_safemode_customize_time").getValue()){if((t=this.getForm().findField("ups_customized_waittime").getValue()*i)>259200||t<0)return e=1===i?"0 - 259200":60===i?"0 - 4320":"0 - 72",this.getForm().findField("ups_customized_waittime").markInvalid(e),!1;this.getForm().findField("delay_time").setValue(t)}else this.getForm().findField("delay_time").setValue(-1);return!0},checkModeValid:function(){var e=this.getForm().findField("mode").getValue(),t=this.getForm().findField("enable").getValue();if(this.current_mode!=e&&t){if("USB"==this.current_mode&&"USB"!=e)return this.getForm().findField("mode").markInvalid(_T("ups","usbups_select_hint")),!1;if("USB"!=this.current_mode&&"USB"==e)return this.getForm().findField("mode").markInvalid(_T("ups","ups_disable_network_ups_hint")),!1}return!0},checkIpValid:function(){var e=this.getForm().findField("mode").getValue(),t="";return"USB"==e||(t="SNMP"==e?"snmp_server_ip":"net_server_ip","127"!=this.getForm().findField(t).getValue().split(".")[0]||(this.getForm().findField(t).markInvalid(_T("common","error_badip")),!1))},onBeforeRequest:function(e){return this.webapi.methods.set!==e||(!!this.disabled||(!!(this.getForm().isValid()&&this.checkWaittimeValid()&&this.checkModeValid()&&this.checkIpValid())||(this.module.panel.setStatusError({text:_T("common","forminvalid"),clear:!0}),this.module.panel.setActiveTab("UpsTab"),!1)))},onServiceAction:function(e){for(var t={api:this.webapi.api,method:this.webapi.methods.set,version:this.webapi.version},i=0;i<e.result.length;i++)if(!1!==SYNO.ux.Utils.checkApiConsistency(t,e.result[i])){if(!1===e.result[i].success)return SYNO.Debug("Ups onServiceAction fail"),void this.module.appWin.getMsgBox().alert(_T("tree","leaf_ups"),_T("tree","leaf_ups")+": "+SYNO.API.getErrorString(e.result[i].error.code));break}},setFieldAndOriginalValues:function(e,t){e.setValue(t),e.originalValue=e.getValue()},processUPSGetInfo:function(e,t){for(var i={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},s=0;s<e.result.length;s++)if(!1!==SYNO.ux.Utils.checkApiConsistency(i,e.result[s])){if(!1===e.result[s].success||!e.result[s].data)return e.result[s].error&&6601===e.result[s].error.code?(SYNO.Debug(e.result[s].error.errors),this.setDisabled(!0),this.setFieldUsed(["ups_set_safemode_until_lowbatt","ups_set_safemode_customize_time","ACL_enable","mode"],!0),this.setFieldUsed(["net_server_ip","snmp_server_ip","snmp_version","snmp_community","snmp_mib","shutdown_device","ups_set_safemode_same_as_server"],!1),this.setFieldUsed(["snmp_user","snmp_auth","snmp_auth_type","snmp_auth_key","snmp_privacy","snmp_privacy_type","snmp_privacy_key"],!1),this.getForm().findField("mode").enable(),this.getComponent("ups_waittime").enable(),void this.getComponent("ACL_list_btn").setVisible(!1)):(SYNO.Debug("UPS processUPSGetInfo fail"),void this.module.appWin.getMsgBox().alert(_T("tree","leaf_ups"),_T("tree","leaf_ups")+": "+SYNO.API.getErrorString(e.result[s].error.code)));this.setDisabled(!1);break}this.__processUPSGetInfo(e.result[s].data),this.getForm().loadRecords(e.result,t.compound)},__processUPSGetInfo:function(e){this.setEnableService&&"USB"!=e.mode&&""===e.manufacture&&this.module.appWin.getMsgBox().alert(_T("tree","leaf_ups"),_T("ups","networkups_noconn")),this.setEnableService=!1,this.UPSInfo=e,this.current_mode=this.UPSInfo.mode,""===this.UPSInfo.snmp_version&&(e.snmp_version="v2c"),""===this.UPSInfo.snmp_mib&&(e.snmp_mib=this.snmp_mib_select[0][0]),!0===this.UPSInfo.snmp_auth_key&&(e.snmp_auth_key="********"),!0===this.UPSInfo.snmp_privacy_key&&(e.snmp_privacy_key="********"),this.setFieldAndOriginalValues(this.getForm().findField("ACL_modified"),"false"),this.processWaitTimeItem(e.mode);var t=this.getForm().findField("ups_customized_waittime"),i=this.getForm().findField("ups_time_unit_list");if(this.getForm().findField("ups_set_safemode_customize_time").getValue()){var s=this.UPSInfo.delay_time;this.setFieldAndOriginalValues(t,s),this.setFieldAndOriginalValues(i,1),0<s&&0==s%60&&((s/=60)%60?(this.setFieldAndOriginalValues(t,s),this.setFieldAndOriginalValues(i,60)):(s/=60,this.setFieldAndOriginalValues(t,s),this.setFieldAndOriginalValues(i,3600)))}},processWaitTimeItem:function(e){this.disabled||(this.UPSInfo.delay_time>=0?(this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_customize_time"),!0),this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_until_lowbatt"),!1),this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_same_as_server"),!1)):(this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_customize_time"),!1),"SLAVE"===e?(this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_until_lowbatt"),!1),this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_same_as_server"),!0)):(this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_until_lowbatt"),!0),this.setFieldAndOriginalValues(this.getForm().findField("ups_set_safemode_same_as_server"),!1))))},processGetData:function(e,t){this.update=!1,this.processUPSGetInfo(e,t),this.update=!0,this.disabled||(this.onServiceAction(e),this.switchLayout())},processSetData:function(e){var t=e,i={api:this.webapi.api,method:this.webapi.methods.set,version:this.webapi.version};this.pollingTaskStop();for(var s=0;s<t.length;s++)if(!1!==SYNO.ux.Utils.checkApiConsistency(i,t[s])&&!this.disabled){this.getForm().isDirty()&&this.getForm().findField("enable").getValue()&&(this.setEnableService=!0),this.getForm().findField("enable").getValue()||(t[s].params.mode=this.UPSInfo.mode),"true"==this.getForm().findField("ACL_modified").getValue()&&(t[s].params.ACL_list=this.UPSInfo.ACL_list),t[s].params.delay_time=this.getForm().findField("delay_time").getValue(),t[s].params.snmp_auth_key_dirty=this.getForm().findField("snmp_auth_key").isDirty(),t[s].params.snmp_privacy_key_dirty=this.getForm().findField("snmp_privacy_key").isDirty();break}return t},processReturnData:function(e,t,i){this.pollingTaskStop(),this.processGetData(t,i),this.callParent(arguments),this.pollingTaskStart()},processParams:function(e,t){return"set"===e?(this.processSetData(t),_S("ha_running")&&"yes"!==_D("support_xa")&&"SYNO.SHA.UPS"===this.webapi.api&&this.processHAParams(e,t)):"get"===e&&_S("ha_running")&&"yes"!==_D("support_xa")&&"SYNO.SHA.UPS"===this.webapi.api&&this.processHAParams(e,t),t},processHAParams:function(e,t){for(var i=t,s={api:this.webapi.api,method:this.webapi.methods[e],version:this.webapi.version},n=0;n<t.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(s,t[n])){if(i[n].params){var o=t[n].params;i[n].params={},i[n].params.remote_params=o}else i[n].params={};i[n].params.remote_api=this.webapi.remote_api,i[n].params.remote_method=e,i[n].params.remote_version=this.webapi.remote_version}return i}}),Ext.ns("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.app=e.app,this.callParent()},getHelpParam:function(){return this.panel.getActiveTab().getHelpParam()},getPanel:function(){return Ext.isEmpty(this.panel)&&(this.panel=new SYNO.SDS.AdminCenter.HardwareControl.TabPanel({module:this})),this.panel},setActivateParams:function(e){e&&e.tab&&this.panel.setActiveTab(e.tab)},activate:function(e){return this.setActivateParams(e),this.panel.loadAllForm(),e&&e.beepWarn&&this.panel.GeneralTab.setBeepWarn(),!0},deactivate:function(){for(var e in this.panel.tabList)if(Ext.isFunction(this.panel.tabList[e].constructor)){if(Ext.isFunction(this.panel.tabList[e].getForm)&&this.panel.tabList[e].getForm().isDirty())return!1;if(Ext.isFunction(this.panel.tabList[e].isScheduleModified)&&this.panel.tabList[e].isScheduleModified())return!1;if(Ext.isFunction(this.panel.tabList[e].isHAUpsTabDirty)&&this.panel.tabList[e].isHAUpsTabDirty())return!1}return this.panel.pollingTask&&(this.panel.pollingTask.remove(),this.panel.pollingTask=null),!0},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t,this.panel.applyHandler()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(e){this.LcmTab=null,this.ScheduleTab=null,this.tabList=[],this.module=e.module,("yes"===_D("support_fan_adjust_dual_mode")||"yes"===_D("supportrcpower")||"yes"===_D("support_wol")&&"no"===_D("support_dual_head","no")||"yes"===_D("support_buzzer")||"yes"===_D("support_release_transcoding_memory"))&&(this.GeneralTab=new SYNO.SDS.AdminCenter.HardwareControl.GeneralTab({module:this.module,appWin:this.module.appWin,itemId:"generalTab"}),this.tabList.push(this.GeneralTab)),"yes"===_D("support_acm","no")&&(this.LcmTab=new SYNO.SDS.AdminCenter.HardwareControl.LcmTab({module:this.module}),this.tabList.push(this.LcmTab)),"yes"===_D("support_power_schedule")&&"yes"!==_D("support_hyper_converged")&&(this.ScheduleTab=new SYNO.SDS.AdminCenter.HardwareControl.ScheduleTab({module:this.module,owner:this,itemId:"scheduleTab"}),this.tabList.push(this.ScheduleTab)),"yes"===_D("support_disk_hibernation","yes")&&"yes"!==_D("support_hyper_converged")&&(this.HibernationTab=new SYNO.SDS.AdminCenter.HardwareControl.HibernationTab({module:this.module,itemId:"hibernationTab"}),_S("ha_hide_hw_setting")||this.tabList.push(this.HibernationTab)),"yes"===_D("supportups")&&(_S("ha_running")&&"yes"!==_D("support_xa")?this.UpsTab=new SYNO.SDS.AdminCenter.HardwareControl.HAUPSTab({module:this.module}):this.UpsTab=new SYNO.SDS.AdminCenter.HardwareControl.UPSTab({module:this.module}),this.tabList.push(this.UpsTab)),"yes"===_D("usbstation","no")&&(this.DCOutputForm=new SYNO.SDS.AdminCenter.HardwareControl.DCOutputForm({module:this.module,itemId:"dcOutputTab"}),this.tabList.push(this.DCOutputForm));var t=Ext.apply({activeTab:0,items:this.tabList},e);this.callParent([t])},getApiArray:function(e){var t=this.callParent(arguments),i={api:"SYNO.Core.Hardware.PowerSchedule",method:"load",version:1};return t.push(i),_S("ha_running")&&"yes"!==_D("support_xa")&&(t=t.concat(this.UpsTab.getApiArray(e))),t},getAllForms:function(){var e=this.callParent(arguments);return _S("ha_running")&&"yes"!==_D("support_xa")&&(e=e.concat(this.UpsTab.getAllForms())),e},applyAllForm:function(e){var t,i="set",s={};if(!1===this.onBeforeRequest(i))return!1;this.getAllForms().forEach((function(e){if(!this.applyDirtyOnly||e.isDirty()){var t=e.getValues(!1,"set");Ext.apply(s,t)}})),t=(t=this.constructApplyParams(s)).concat(this.getApiArray("get",!0)),t=this.processParams("get",t),t=this.processParams(i,t),this.sendAjaxRequest(i,t)},processReturnData:function(e,t,i){this.callParent(arguments),null!==this.ScheduleTab&&this.ScheduleTab.panel&&this.ScheduleTab.panel.processReturnData(e,t,i),_S("ha_running")&&"yes"!==_D("support_xa")&&this.UpsTab.processReturnData(e,t,i)},hasFootbarPanel:function(e){return e instanceof SYNO.SDS.AdminCenter.HardwareControl.HAUPSTab||this.callParent(arguments)},processParams:function(e,t){var i,s=this,n=s.callParent(arguments);return"set"===e?(null!==s.ScheduleTab&&s.ScheduleTab.panel&&void 0!==(i=s.ScheduleTab.panel.getSaveApiCfg())&&n.push(i),n):n},setErrorMsg:function(e){for(var t=_T("common","commfail"),i=0;i<e.length;i++)if(!1===e[i].success&&e[i].error&&e[i].error.code&&6601!==e[i].error.code&&SYNO.API.Errors.core[e[i].error.code]){t=SYNO.API.Errors.core[e[i].error.code];break}this.setStatusError({text:t,clear:!0})},checkOnlyHAPassiveOfflineError:function(e){return e.every((e=>e.success||e.error&&6601===e.error.code))},onApiSuccess:function(e,t,i){var s=this;"set"===e&&(!t.has_fail||this.checkOnlyHAPassiveOfflineError(t.result)?(s.module.confirmSaveLostResolve&&s.module.confirmSaveLostResolve(),s.setStatusOK()):(s.module.confirmSaveLostReject&&s.module.confirmSaveLostReject(),s.setErrorMsg(t.result))),s.processReturnData(e,t,i)}}),Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.EnterIPStep",{extend:"SYNO.SDS.Utils.FormPanel",originIP:null,constructor:function(e){var t=Ext.apply({headline:_T("usb","net_prntr_welcome"),border:!1,trackResetOnLoad:!0,items:[{xtype:"syno_displayfield",value:_T("usb","net_prntr_intro")},{xtype:"syno_displayfield",value:_T("usb","net_prntr_enter_ip")},{xtype:"syno_displayfield",height:30},{xtype:"syno_textfield",width:300,allowBlank:!1,fieldLabel:_T("common","ip_addr"),name:"ip",enableKeyEvents:!0,maxlength:15,vtype:"v4ip"},{name:"ip_dup",hidden:!0,xtype:"syno_textfield",enableKeyEvents:!0,maxlength:15,vtype:"v4ip"}]},e);this.callParent([t])},activate:function(){this.owner.getStep("np_conf").isSet=!1,this.originIP=this.getForm().findField("ip").getValue()},getNext:function(){var e;return this.getForm().isValid()?_S("demo_mode")?(this.owner.goNext(this.nextId),!1):(e=this.getForm().findField("ip").getValue(),this.originIP!=e?(this.owner.el.mask(_T("common","searching"),"x-mask-loading"),this.owner.sendWebAPI({api:"SYNO.Core.ExternalDevice.Printer.Network.Host",version:1,method:"get",params:{ip:e},scope:this,callback:function(e,t,i,s){if(!this.isDestroyed){var n;if(!e)return n=SYNO.API.getErrorString(t.code),void this.owner.getMsgBox().alert(_T("usb","net_prntr_wizard_title"),n);this.owner.conf=t,this.owner.goNext(this.nextId),this.owner.el.unmask()}}})):this.owner.goNext(this.nextId),!1):(this.owner.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1)}}),Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.NPConfStep",{extend:"SYNO.SDS.Utils.FormPanel",isSet:!1,constructor:function(e){var t=Ext.apply({headline:_T("usb","net_prntr_detail"),border:!1,trackResetOnLoad:!0,items:[{xtype:"syno_displayfield",value:_T("usb","net_prntr_enter_info")},{xtype:"syno_displayfield",height:15},{xtype:"syno_textfield",width:300,name:"cups_name",id:this.NameId=Ext.id(),fieldLabel:_T("usb","net_prntr_name"),maxlength:32,validationEvent:"blur",validator:function(){var e=!1,t=this.getValue();return""===t?_JSLIBSTR("extlang","fieldblank"):0<=t.search(/[^a-zA-Z0-9_]/)?_T("error","error_bad_field"):(this.ownerCt.owner.printerStore.each((function(i){t==i.get("cups_name")&&(e=!0)})),e?_T("usb","net_prntr_name_exist_error"):(this.clearInvalid(),!0))}},{xtype:"syno_combobox",width:300,name:"protocol",fieldLabel:_T("usb","net_prntr_ptl"),id:this.ProtocolId=Ext.id(),autoSelect:!0,allowBlank:!1,store:this.backendList=new Ext.data.ArrayStore({fields:["protocol_id","protocol_text"],data:[["lpd",_T("usb","net_prntr_lpr")],["ipp",_T("usb","net_prntr_ipp")],["socket",_T("usb","net_prntr_socket")],["bjnp",_T("usb","net_prntr_bjnp")]]}),displayField:"protocol_text",valueField:"protocol_id"},{xtype:"syno_textfield",width:300,name:"qname",id:this.QueueNameId=Ext.id(),fieldLabel:_T("usb","net_prntr_qname"),enableKeyEvents:!0,maxlength:32,validationEvent:"keyup",validator:function(){var e=this.getValue();return""===e?_JSLIBSTR("extlang","fieldblank"):0<=e.search("usbprinter")?_T("error","error_bad_field"):this.originalValue===e||""===this.originalValue||(0<=e.search(/[^a-zA-Z0-9_]/)?_T("error","error_bad_field"):(this.clearInvalid(),!0))}},{xtype:"syno_displayfield",width:300,name:"mfg",id:this.BrandId=Ext.id(),fieldLabel:_T("usb","usb_printer_brand")},{xtype:"syno_displayfield",width:300,name:"mdl",id:this.ModelId=Ext.id(),fieldLabel:_T("usb","net_prntr_mdl")},{xtype:"syno_textfield",name:"stringid",hidden:!0}]},e);this.callParent([t]),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("qname").getEl(),_T("usb","net_qname_tip"))}),this,{single:!0})},activate:function(){this.owner.mon(this.getForm().findField("protocol"),"select",(function(){"bjnp"===this.getForm().findField("protocol").getValue()||"socket"===this.getForm().findField("protocol").getValue()?(this.getForm().findField("qname").disable(),this.getForm().findField("qname").clearInvalid()):this.getForm().findField("qname").enable()}),this),!1===this.isSet&&(this.getForm().setValues(this.owner.conf),this.getForm().findField("protocol").fireEvent("select"),this.isSet=!0),""===this.getForm().findField("mfg").getValue()&&this.getForm().findField("mfg").setValue(_T("usb","info_not_found")),""===this.getForm().findField("mdl").getValue()&&this.getForm().findField("mdl").setValue(_T("usb","info_not_found"))},getNext:function(){return this.getForm().isValid()?_S("demo_mode")?(this.owner.goNext(this.nextId),!1):(this.getForm().findField("cups_name").clearInvalid(),this.supportOAuth?(this.owner.el.mask(_T("common","msg_waiting"),"x-mask-loading"),this.owner.sendWebAPI({api:"SYNO.Core.ExternalDevice.Printer.OAuth",version:1,method:"get",scope:this,callback:function(e,t,i,s){if(!this.isDestroyed){var n;if(!e)return n=SYNO.API.getErrorString(t.code),void this.owner.getMsgBox().alert(_T("usb","net_prntr_wizard_title"),n);this.owner.needLogin=0===t.account.length,this.owner.goNext(this.nextId),this.owner.el.unmask()}}})):this.owner.goNext(this.nextId),!1):(this.owner.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1)}}),Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.NPSettingStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module;var t=Ext.apply({headline:_T("usb","prntr_ap_gcp_setting"),border:!1,trackResetOnLoad:!0,items:[{xtype:"syno_displayfield",value:_T("usb","net_prntr_set_func")},{xtype:"syno_checkbox",name:"enable_airprint",boxLabel:_T("usb","usb_printer_airprint_enable")},{xtype:"syno_checkbox",name:"fit_to_page",boxLabel:_T("usb","fit_to_page")},{xtype:"syno_combobox",width:300,name:"driver_brand",fieldLabel:_T("usb","usb_printer_brand"),displayField:"value",autoSelect:!0,store:this.brandList=new Ext.data.ArrayStore({fields:["value"]}),listeners:{scope:this,select:function(e){var t=this.getForm().findField("driver_model");t.getStore().loadData(this.owner.module.driverList[e.getValue()]),t.setValue(t.getStore().getAt(0).get("value"))}}},{xtype:"syno_combobox",width:300,name:"driver_model",fieldLabel:_T("usb","usb_printer_driver"),displayField:"value",valueField:"value",autoSelect:!0,store:new Ext.data.ArrayStore({fields:["value"]})},{xtype:"syno_displayfield",name:"np_loading_status",value:_T("usb","usb_printer_driver_loading")}]},e);this.callParent([t])},activate:function(){this.mon(this,"afterlayout",(function(e,t){this.getForm().findField("driver_brand").disable(),this.getForm().findField("driver_model").disable(),this.getForm().findField("enable_airprint").on("check",this.CheckBrandDriver,this),this.CheckBrandDriver()}),this)},CheckBrandDriver:function(){this.getForm().findField("enable_airprint").getValue()?(this.getForm().findField("driver_brand").enable(),this.getForm().findField("driver_model").enable(),this.getForm().findField("fit_to_page").enable()):(this.getForm().findField("driver_brand").disable(),this.getForm().findField("driver_model").disable(),this.getForm().findField("fit_to_page").disable())},getNext:function(){return _S("demo_mode")?(this.owner.getMsgBox().alert(_T("usb","net_prntr_wizard_title"),_JSLIBSTR("uicommon","error_demo")),!1):(this.owner.onApply(),!1)},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments),this.owner.checkDriverList()},register:function(e,t){if(Ext.isIE||Ext.isIE11)window[t]=e;else{var i=this;this.receiveMessage=function(s){var n=s.browserEvent;if(n.origin===window.location.origin&&!/setImmediate/.test(n.data)){var o=JSON.parse(n.data);o.callback===t&&e.call(i,o)}},Ext.EventManager.addListener(window,"message",this.receiveMessage)}},unregister:function(){Ext.isIE||Ext.isIE11||Ext.EventManager.removeListener(window,"message",this.receiveMessage)},addPopupTimer:function(e){if(e.popup&&!e.popup.closed)var t=window.setInterval((function(){e.popup.closed&&(e.unregister(),window.clearInterval(t),t=null)}),1e3)},doClosePopup:function(){this.popup&&!this.popup.closed&&this.popup.close()}}),Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.AddNetPrinterWizardDialog",{extend:"SYNO.SDS.Wizard.ModalWindow",conf:null,blHasUsbshare:!1,loadDriverFailed:!1,mfgList:[],mdlList:[],constructor:function(e){this.owner=e.owner,this.module=e.module,this.blHasUsbshare=e.blHasUsbshare,this.loadDriverFailed=e.loadDriverFailed,this.printerStore=e.printerStore,this.supportOAuth=_S("version")>4995;var t=[this.IPFormPanel=new SYNO.SDS.AdminCenter.ExternalDevices.EnterIPStep({itemId:"np_ip",nextId:"np_conf"}),this.ConfFormPanel=new SYNO.SDS.AdminCenter.ExternalDevices.NPConfStep({itemId:"np_conf",nextId:"np_setting",supportOAuth:this.supportOAuth}),this.SettingFormPanel=new SYNO.SDS.AdminCenter.ExternalDevices.NPSettingStep({itemId:"np_setting",nextId:null,supportOAuth:this.supportOAuth,owner:this.appWin,module:this.module})],i=Ext.apply({title:_T("usb","net_prntr_wizard_title"),resizable:!1,width:760,height:580,steps:t,listeners:{beforeclose:this.onBeforeClose,scope:this}},e);this.IPForm=this.IPFormPanel.getForm(),this.ConfForm=this.ConfFormPanel.getForm(),this.SettingForm=this.SettingFormPanel.getForm(),this.callParent([i]),this.IPFormPanel.mon(this.IPForm.findField("ip"),"keyup",(function(){this.IPForm.findField("ip_dup").setValue(this.IPForm.findField("ip").getValue()),this.IPForm.findField("ip_dup").isValid()?this.getButton("next").enable():this.getButton("next").disable()}),this)},onBeforeClose:function(){this.SettingFormPanel.doClosePopup()},onApply:function(){var e=this.IPForm.getValues();e=Ext.apply(e,this.ConfForm.getValues()),e=Ext.apply(e,this.SettingForm.getValues()),(e=Ext.apply({google_cloud_print:{}},e)).mfg=this.ConfForm.findField("mfg").getValue(),e.mdl=this.ConfForm.findField("mdl").getValue(),void 0===e.qname&&(e.qname=""),e.google_cloud_print.enable=!1,delete e.enable_gcp,delete e.gcp_account,delete e.gcp_passwd,delete e.ip_dup,this.SettingForm.findField("enable_airprint").getValue()&&this.SettingForm.findField("fit_to_page").getValue()?e.fit_to_page=!0:e.fit_to_page=!1,this.setStatusBusy({text:_T("common","saving")}),SYNO.API.Request({api:"SYNO.Core.ExternalDevice.Printer.Network",version:1,method:"create",params:e,callback:function(e,t,i,s){if(!this.isDestroyed){var n;if(this.clearStatusBusy(),!e)return n=SYNO.API.getErrorString(t.code),void this.getMsgBox().alert(_T("usb","net_prntr_wizard_title"),n);SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.favor_lpr",!1),i.enable_airprint&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.airprint",!1),this.close()}},scope:this})},onOpen:function(){this.callParent(arguments),this.getButton("next").disable()},checkDriverList:function(){var e=null!==this.module.driverList,t=[],i=this.getStep("np_setting").getForm().findField("np_loading_status");this.loadDriverFailed&&i.setValue(_T("usb","usb_printer_driver_loading_fail")),i.originalValue=i.getValue(),SYNO.ux.Utils.displayFormField(this.getStep("np_setting").getForm(),"enable_airprint",e),SYNO.ux.Utils.displayFormField(this.getStep("np_setting").getForm(),"fit_to_page",e),SYNO.ux.Utils.displayFormField(this.getStep("np_setting").getForm(),"driver_brand",e),SYNO.ux.Utils.displayFormField(this.getStep("np_setting").getForm(),"driver_model",e),SYNO.ux.Utils.displayFormField(this.getStep("np_setting").getForm(),"np_loading_status",!e),e&&0===this.getStep("np_setting").brandList.getCount()&&(Ext.iterate(this.module.driverList,(function(e){t.push([e])}),this),this.getStep("np_setting").brandList.loadData(t),this.getStep("np_setting").getForm().findField("driver_brand")),e&&this.checkDriver()},checkDriver:function(){var e,t,i=null,s=null,n=!1,o=function(e,t){var i=e.split(" "),s=i.length-1,n=i[s].toLowerCase(),o=t.toLowerCase();for(0<=i[s].search(/(ser|printer)/i)&&0<s?n=i[--s].toLowerCase():!isNaN(i[s])&&0<s&&(n=i[--s].toLowerCase()+" "+n);0<=i[s].search(/(PS3|MFP|PLUS|XL|LF)/i)&&0<s;)n=i[--s].toLowerCase()+" "+n;return!(0>o.search(n))};e=this.getStep("np_conf").getForm().findField("mfg").getValue(),t=this.getStep("np_conf").getForm().findField("mdl").getValue(),null===(i=function(e,t){for(var i in e)if(i.toLowerCase()===t.toLowerCase())return i;return null}(this.module.driverList,e))?Ext.iterate(this.module.driverList,(function(e,a){return Ext.each(a,(function(a){return!o(t,a[0])||(s=a[0],i=e,n=!0,!1)}),this),!n}),this):Ext.each(this.module.driverList[i],(function(e){return!o(t,e[0])||(s=e[0],n=!0,!1)}),this);var a=this.getStep("np_setting").getForm().findField("driver_brand"),r=this.getStep("np_setting").getForm().findField("driver_model");null!==i?(a.findRecord("value",i)&&a.onSelect(a.findRecord("value",i)),a.originalValue=a.getValue(),n&&(r.setValue(s),r.originalValue=r.getValue())):a.onSelect(a.getStore().getAt(0))}}),Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.ShareGrid",{extend:"SYNO.ux.GridPanel",DEFAULT_ROLES:[["system",_T("share","share_system_user")],["local_user",_T("share","share_local_user")]],GROUP_ROLES:[["local_group",_T("share","share_local_group")]],DOMAIN_ROLES:[["domain_user",_T("share","share_domain_user")],["domain_group",_T("share","share_domain_group")]],LDAP_ROLES:[["ldap_user",_T("share","ldap_user")],["ldap_group",_T("share","ldap_group")]],constructor:function(e){this.pageSize=50,this.store=this.createStore(e);var t={header:_T("share","share_permission_readonly"),dataIndex:"is_readonly",disableSelectAll:!0,width:120};this.colRo=new SYNO.ux.EnableColumn(t),this.colRw=new SYNO.ux.EnableColumn({header:_T("share","share_permission_writable"),dataIndex:"is_writable",disableSelectAll:!0,width:120,id:"is_writable"}),this.colNa=new SYNO.ux.EnableColumn({header:_T("share","share_permission_none"),dataIndex:"is_deny",disableSelectAll:!0,width:120});var i=[{id:"name",header:_T("share","share_name"),dataIndex:"name",width:100,align:"left",renderer:function(e,t){return"ftp"===e.toLowerCase()?"Anonymous FTP/Presto/WebDAV":e}},this.colNa,this.colRw,this.colRo];e.colCu&&(this.colCu=e.colCu,i.push(this.colCu));var s=Ext.apply({title:_T("share","share_rights"),layout:"fit",cls:"without-dirty-red-grid",store:this.store,width:700,autoExpandMax:160,autoExpandMin:160,autoExpandColumn:"name",enableColumnMove:!1,enableHdMenu:!1,hideMode:"offsets",colModel:new Ext.grid.ColumnModel({defaults:{align:"center"},columns:i}),selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),plugins:[this.colRo,this.colRw,this.colNa],tbar:this.createTopToolbar(e),bbar:new SYNO.ux.PagingToolbar({store:this.store,pageSize:this.pageSize,displayInfo:!0})},e);this.callParent([s]),this.mon(this,"cellclick",this.onGridCellClick,this),this.mon(this,"afterlayout",(function(e,t){this.mon(this.getSelectionModel(),"spacepressed",this.onGridCellSpacePressed,this)}),this,{single:!0}),this.mon(this,"afterlayout",(function(e,t){e.getView().updateScroller()}),this)},joinRenderer:function(e,t,i,s,n,o){return i.data.is_readonly||i.data.is_writable||i.data.is_deny||i.data.is_custom?'<div class="syno-ex-check-icon"></div>':""},createStore:function(e){return new SYNO.API.JsonStore({autoDestroy:!0,remoteSort:!0,appWindow:e.owner,api:"SYNO.Core.ExternalDevice.DefaultPermission",method:"get",version:1,baseParams:{offset:0,limit:this.pageSize},listeners:{exception:{scope:this,fn:this.onStoreException},beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad}},root:"items",idProperty:"name",totalProperty:"total",fields:["name","is_writable","is_readonly","is_deny","is_custom","is_admin"]})},createTopToolbar:function(e){var t=new SYNO.ux.Toolbar({style:{"border-bottom":"none"},items:[{xtype:"syno_combobox",itemId:"roleFilter",valueField:"role",displayField:"display",store:{xtype:"arraystore",autoDestroy:!0,fields:["role","display"]},mode:"local",triggerAction:"all",editable:!1,forceSelection:!0,width:210,tpl:'<tpl for="."><div ext:qtip="{display}" class="x-combo-list-item">{display}</div></tpl>',listeners:{beforeselect:{scope:this,fn:this.onRoleFilterSelect}}},"->",{xtype:"syno_displayfield",value:_T("helptoc","directory_service_domain")+": ",hidden:!0,itemId:"domainListLabel"},{xtype:"syno_combobox",itemId:"domainFilter",valueField:"value",displayField:"domain",store:{xtype:"arraystore",autoDestroy:!0,fields:["domain","value","comment"]},hidden:!0,resizable:!0,mode:"local",triggerAction:"all",editable:!1,value:"",forceSelection:!0,tpl:'<tpl for="."><div ext:qtip="{comment}" class="x-combo-list-item">{domain}</div></tpl>',listeners:{beforeselect:{scope:this,fn:this.onDomainFilterSelect}}},this.nameFilter=new SYNO.ux.TextFilter({iconStyle:"filter",itemId:"search",emptyText:_T("share","share_filter_text"),store:this.store,queryParam:"substr",pageSize:this.pageSize})]});return this.roleFilter=t.getComponent("roleFilter"),this.domainFilter=t.getComponent("domainFilter"),this.domainListLabel=t.getComponent("domainListLabel"),t},showDomainFilter:function(e){this.domainListLabel.setVisible(e),this.domainFilter.setVisible(e)},onDomainFilterSelect:function(e,t){this.store.baseParams.domain=t.data.value,this.store.load({params:{offset:0}})},onGridCellSpacePressed:function(e,t){var i=e.grid,s=i.getStore().indexOf(e.getSelected()),n=e.getColIdx();0<=n&&this.onGridCellClick(i,s,n,t)},onGridCellClick:function(e,t,i,s){var n=e.getStore().getAt(t),o=e.getColumnModel().getDataIndex(i);(function(e){return"is_readonly"===e||"is_writable"===e||"is_deny"===e})(o)&&!0===n.get(o)&&function(e,t,i){"is_readonly"!==e&&(t.set("is_readonly",!1),i.colRo.checkSelectAll(i.getStore())),"is_writable"!==e&&(t.set("is_writable",!1),i.colRw.checkSelectAll(i.getStore())),"is_deny"!==e&&(t.set("is_deny",!1),i.colNa.checkSelectAll(i.getStore()))}(o,n,e)},isChanged:function(){return 0!==this.store.getModifiedRecords().length},getModifiedPermissions:function(){var e=this.getWebAPI(),t=[];return 1===e.length&&Ext.each(e[0].params.permissions,(function(e){t.push({is_readonly:e.is_readonly,is_deny:e.is_deny,is_writable:e.is_writable,is_custom:!!e.is_custom})})),t},onStoreException:function(e,t,i,s,n,o){this.owner.clearStatusBusy(),SYNO.Debug("Store exception: options:",e,t,i,s,n,o),this.owner.getMsgBox().alert(this.title,SYNO.API.Erros.core[n.code]||_T("common","commfail"))},onBeforeLoad:function(e,t){return this.owner.setStatusBusy({text:_T("common","loading")}),!this.isChanged()||(this.owner.clearStatusBusy(),this.owner.getMsgBox().confirm(this.title,_T("share","share_save_chg_before_reload"),(function(e){if("yes"===e){var i=this.getWebAPI();this.sendApplyRequest(i,t)}else this.store.rejectChanges(),this.store.load(t)}),this),!1)},onLoad:function(){this.prevRole=void 0,this.owner.clearStatusBusy(),this.getSelectionModel().selectFirstRow()},onException:function(e,t,i,s,n,o){this.owner.clearStatusBusy(),this.owner.getMsgBox().alert(this.title,SYNO.API.Erros.core[n.code]||_T("common","commfail"))},onRoleFilterSelect:function(e,t){var i=t.data.role;this.prevRole=e.getValue(),this.store.baseParams.user_group_type=i,"domain_user"===i||"domain_group"===i?this.showDomainFilter(!0):this.showDomainFilter(!1),this.store.load({params:{offset:0}})},loadPermissions:function(e){var t=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.LDAP","get","enable_client"),i=2702===SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.LDAP","get","error"),s=!1,n=!1,o=!1;this.getKnownAPI("SYNO.Core.Directory.Domain")&&(s=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","get","enable_domain"),n=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","test_dc","test_join_success"),o="yes"===_D("supportdomain")&&SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","get_domain_list","domain_list"));var a=this.roleFilter.getStore(),r=this.domainFilter.getStore(),l=[];a.loadData(this.DEFAULT_ROLES),a.loadData(this.GROUP_ROLES,!0),t&&i&&a.loadData(this.LDAP_ROLES,!0),s&&n&&0!==o.length&&(a.loadData(this.DOMAIN_ROLES,!0),Ext.each(o,(function(e){"object"==typeof e?e[1]?l.push(e):l.push([_T("directory_service","domainou_list_all_items"),e[1],e[2]]):l.push([e,e,e])}),this),r.loadData(l),this.domainFilter.getValue()||this.domainFilter.setValue(l[0][1]||""),this.store.baseParams.domain=this.domainFilter.getValue(),1===SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Directory.Domain","get","manage_mode")?this.domainListLabel.setValue(_T("directory_service","organizational_unit")+": "):this.domainListLabel.setValue(_T("helptoc","directory_service_domain")+": ")),this.showDomainFilter(!1),this.roleFilter.setValue("local_user"),this.nameFilter.reset(),this.store.baseParams.user_group_type=this.roleFilter.getValue(),this.store.load()},getOpenConfig:function(){var e=this.getSelectionModel().getSelected().get("name"),t="user",i=this.roleFilter.getValue();return("local_group"===i||"domain_group"===i||"ldap_group"===i||"http"===e)&&(t="group"),{userName:e.toLowerCase(),userType:t}},getWebAPI:function(){var e=[];Ext.each(this.store.getModifiedRecords(),(function(t){e.push({name:t.data.name,is_readonly:t.data.is_readonly,is_writable:t.data.is_writable,is_deny:t.data.is_deny,is_custom:t.data.is_custom})}),this);var t={user_group_type:this.prevRole||this.roleFilter.getValue(),permissions:e};return 0===e.length?void 0:{api:"SYNO.Core.ExternalDevice.DefaultPermission",method:"set",version:1,params:t}},sendApplyRequest:function(e,t){this.owner.setStatusBusy({text:_T("common","saving")}),this.owner.sendWebAPI(Ext.apply(e,{scope:this,callback:function(e,i){if(this.owner.clearStatusBusy(),e)return this.store.commitChanges(),void this.store.load(t);this.owner.getMsgBox().alert(this.title,SYNO.API.Erros.core[i.code]||_T("common","commfail"))}}))}}),Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.ExternalSettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e,t){this.option=t,this.defaulPermissionGrid=new SYNO.SDS.AdminCenter.ExternalDevices.ShareGrid({style:{padding:"4px 0px 0px 0px"},module:e.module,owner:this,cls:"external-sharegrid",padding:0,flex:1}),this.externalDefaultPermissionTab=new SYNO.SDS.Utils.FormPanel({module:e.module,owner:this,title:_T("externaldevice","externaldevice_default_permission"),itemId:"ExternalDefaultPermissionTab",layout:"vbox",layoutConfig:{align:"stretch"},items:[this.defaulPermissionGrid,{xtype:"panel",border:!1,items:[{xtype:"syno_displayfield",htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("externaldevice","externaldevice_default_permission_dialog_desc")}]}]}),this.externalAdvancedTab=new SYNO.SDS.AdminCenter.ExternalDevices.StorageSettingTab({module:e.module,owner:this,itemId:"StorageSettingTab"},t);var i=Ext.apply({width:800,height:570,minWidth:780,minHeight:370,layout:"fit",title:_T("externaldevice","externaldevice_global_settings"),items:[{xtype:"syno_tabpanel",padding:"0px 0px 0px 0px",plain:!0,itemId:"tab",activeTab:0,items:[this.externalDefaultPermissionTab,this.externalAdvancedTab]}],buttons:[{text:_T("common","cancel"),scope:this,handler:this.onCancel},{text:_T("common","apply"),scope:this,btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",handler:this.onApply}],listeners:{beforeclose:this.onBeforeClose.bind(this)},forceClose:!1},e);this.callParent([i]),this.loadDefaultPermission()},loadDefaultPermission:function(){var e=[{api:"SYNO.Core.Directory.LDAP",method:"get",version:1}];this.getKnownAPI("SYNO.Core.Directory.Domain")&&(e.push({api:"SYNO.Core.Directory.Domain",method:"get",version:1}),e.push({api:"SYNO.Core.Directory.Domain",method:"test_dc",version:1}),"yes"===_D("supportdomain")&&e.push({api:"SYNO.Core.Directory.Domain",method:"get_domain_list",version:2})),this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:e},scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),e&&!t.has_fail)this.defaulPermissionGrid.loadPermissions(t);else{var s=SYNO.API.Response.GetFirstError(t);this.getMsgBox().alert("share",SYNO.API.Erros.core[s.code]||_T("common","commfail"))}}})},isChanged:function(){return this.defaulPermissionGrid.isChanged()||this.externalAdvancedTab.getForm().isDirty()},onApply:function(){if(!this.isChanged())return this.forceClose=!0,void this.close();var e,t,i=this,s=this.defaulPermissionGrid.getWebAPI(),n=this.externalAdvancedTab.getWebAPI(),o=[];s&&o.push(s),n&&o.push(n);var a=this.externalAdvancedTab.getDirtyField();a.forbid_usb&&a.delalloc?this.option.needReboot?(t=_T("hddsleep","dcache_title"),e=_T("usb","apply_delalloc_warning")+"<br>",e+=_T("backup","are_you_sure_to_continue")):(t=_T("common","advanced"),e="1. "+_T("usb","forbid_confirm_reboot")+"<br>",e+="2. "+_T("usb","apply_delalloc_warning")+"<br>",e+=_T("backup","are_you_sure_to_continue")):a.forbid_usb?this.option.needReboot||(t=_T("common","advanced"),e=_T("usb","forbid_confirm_reboot")+"<br>",e+=_T("backup","are_you_sure_to_continue")):a.delalloc?(t=_T("hddsleep","dcache_title"),e=_T("usb","apply_delalloc_warning")+"<br>",e+=_T("backup","are_you_sure_to_continue")):(t=void 0,e=void 0),e?this.getMsgBox().confirm(t,e,(function(e){"yes"==e&&(Ext.getCmp(i.option.btnSettingId).disable(),Ext.getCmp(i.option.btnFormatId).disable(),Ext.getCmp(i.option.btnEjectId).disable(),i.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:o},scope:this,callback:this.onApplyCallback}))}),i):(n&&(Ext.getCmp(this.option.btnSettingId).disable(),Ext.getCmp(this.option.btnFormatId).disable(),Ext.getCmp(this.option.btnEjectId).disable()),this.sendWebAPI({params:{},compound:{stopwhenerror:!1,params:o},scope:this,callback:this.onApplyCallback}))},onApplyCallback:function(e,t,i){if(e&&!t.has_fail)return this.externalAdvancedTab.getDirtyField().forbid_usb&&(this.option.needReboot=!this.option.needReboot,this.option.needReboot&&SYNO.SDS.System.RebootWithMsg()),this.forceClose=!0,void this.close();var s=SYNO.API.Response.GetFirstError(t),n=SYNO.API.Erros.core[s.code]||_T("common","error_system");this.getMsgBox().alert("warning_msg",n)},onCancel:function(){this.close()},onBeforeClose:function(){var e=this;return!(!e.forceClose&&this.isChanged())||(e.confirmLostChangePromise({save:function(){e.onApply()},dontSave:function(){e.forceClose=!0,e.close()},cancel:Ext.emptyFn}),!1)}}),Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.StorageSettingTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e,t){var i=Ext.apply({border:!1,owner:this.appWin,title:_T("common","advanced"),webapi:{api:"SYNO.Core.ExternalDevice.Storage.Setting",version:1,method:"set"},items:[{xtype:"syno_checkbox",boxLabel:_T("usb","delalloc_opt"),name:"delalloc",checked:t.delalloc},{xtype:"syno_displayfield",value:_T("usb","delalloc_desc")}]},e);i.items.push(this.createUSBItems(t)),this.callParent([i])},createUSBItems:function(e){var t=[];return t.push({xtype:"syno_checkbox",boxLabel:_T("usb","forbid_usb"),name:"forbid_usb",checked:e.forbid_usb,hidden:"0"==_D("usbportnum")}),t.push({xtype:"syno_displayfield",value:_T("usb","forbid_usb_explain"),hidden:"0"==_D("usbportnum")}),t.push({xtype:"syno_displayfield",name:"reboot_warning",id:this.needRebootWarnId=Ext.id(),value:"<font class='red-status'> "+_T("status","status_need_reboot")+" </font>",hidden:"0"==_D("usbportnum")||!e.needReboot,htmlEncode:!1}),t.push({xtype:"syno_checkbox",boxLabel:_T("usb","usb_non_admin_eject"),name:"non_admin_eject",checked:e.non_admin_eject,hidden:"0"===_D("usbportnum")}),t.push({xtype:"syno_displayfield",value:_T("usb","usb_non_admin_eject_explain"),hidden:"0"===_D("usbportnum")}),t},getWebAPI:function(){var e={},t=this.getForm();return t.isDirty()?(e.delalloc=t.getValues().delalloc,e.forbid_usb=t.getValues().forbid_usb,e.non_admin_eject=t.getValues().non_admin_eject,{api:"SYNO.Core.ExternalDevice.Storage.Setting",method:"set",version:1,params:e}):void 0},getDirtyField:function(){return{non_admin_eject:!!this.getForm().findField("non_admin_eject").isDirty(),forbid_usb:!!this.getForm().findField("forbid_usb").isDirty(),delalloc:!!this.getForm().findField("delalloc").isDirty()}}}),SYNO.SDS.AdminCenter.ExternalDevices.EXT_FORMAT_MIN_MB_SIZE=100,SYNO.SDS.AdminCenter.ExternalDevices.FAT_FORMAT_MAX_MB_SIZE=2097152,SYNO.SDS.AdminCenter.ExternalDevices.onClickExfatPkg=function(){SYNO.SDS.AppLaunch("SYNO.SDS.PkgManApp.Instance",{action:"open",packages:["exFAT-Free"]})},Ext.define("SYNO.SDS.AdminCenter.ExternalDevices.Main",{extend:"SYNO.SDS.AdminCenter.Module",appWin:null,deviceStore:null,printerStore:null,deviceList:[],printerList:[],driverList:null,mfgList:[],mdlList:[],brandList:null,backendList:null,bonjourPrinterEnabled:!1,loadDriverFailed:!1,printerSetupDialog:null,printerForm:null,blHasUsbshare:!1,isUsbPrntr:!0,npWizard:null,hasVolume:!0,constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.isUsbStation="yes"===_D("usbstation"),this.exFATPkgRunning=!1,this.deviceStore=new SYNO.API.CompoundStore({compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.ExternalDevice.Storage.USB",version:1,method:"list",params:{additional:["all"]}},{api:"SYNO.Core.ExternalDevice.Storage.eSATA",version:1,method:"list",params:{additional:["all"]}}]},idProperty:"dev_id",fields:["title","status","cls","iconCls","dev_id","dev_title","total_size_mb","dev_type","formatable","producer","product","status","progress","partitions","share_name"],root:"devices",blReloadMask:!1,appWindow:this.appWin,listeners:{scope:this,beforeload:function(){this.gotoPkgManId&&(this.gotoPkgManId.forEach((function(e){var t=Ext.get(e);Ext.isObject(t)&&t.un("click",this.onClickExfatPkg,this)}),this),delete this.gotoPkgManId)},load:function(e){this.deviceStore.blReloadMask&&(this.appWin.clearStatus(),this.appWin.unmask(),this.deviceStore.blReloadMask=!1),this.gotoPkgManId&&this.gotoPkgManId.forEach((function(e,t){var i=Ext.get(e);Ext.isObject(i)&&i.on("click",this.onClickExfatPkg)}),this)}},onCompoundResponse:this.processDeviceStore(),reload_withmask:function(){this.deviceStore.blReloadMask=!0,this.appWin.setStatusBusy(null,_T("common","loading")),this.deviceStore.reload()}}),this.printerStore=new SYNO.API.JsonStore({api:"SYNO.Core.ExternalDevice.Printer",method:"list",version:1,baseParams:{additional:["all"]},idProperty:"printer_id",fields:["printer_id","cups_name","printer_mode","mfg","mdl","driver_brand","driver_model","enable_airprint","google_cloud_print","fit_to_page","printer_cmd_set","lockby","print_queue","ip","status","protocol","qname"],root:"printers",blReloadMask:!1,appWindow:this.appWin,listeners:{scope:this,load:function(e,t){this.processPrinterStore(t),this.printerStore.blReloadMask&&(this.appWin.clearStatus(),this.appWin.unmask(),this.printerStore.blReloadMask=!1)}},reload_withmask:function(){this.printerStore.blReloadMask=!0,this.appWin.setStatusBusy(null,_T("common","loading")),this.printerStore.reload()}}),this.backendList=new Ext.data.ArrayStore({fields:["protocol_id","protocol_text"],data:[["lpd",_T("usb","net_prntr_lpr")],["ipp",_T("usb","net_prntr_ipp")],["socket",_T("usb","net_prntr_socket")],["bjnp",_T("usb","net_prntr_bjnp")]]}),this.createPanel(),this.deviceView.mon(this.deviceView,"selectionchange",(function(e,t){var i=this.deviceView.getSelectedRecords();if(i&&i[0]){var s=this.panel.getActiveTab();if(!s)return;"deviceTab"===s.itemId&&(this.lastSelectedRecord=i[0],this.printerView.clearSelections())}this.dataViewSelectionChange(t)}),this),this.deviceView.mon(this.deviceStore,"beforeload",this.reloadExfatPkgStatus,this),this.printerView.mon(this.printerView,"selectionchange",(function(e,t){var i=this.printerView.getSelectedRecords();if(i&&i[0]){var s=this.panel.getActiveTab();if(!s)return;"printerTab"===s.itemId&&(this.lastSelectedRecord=i[0],this.deviceView.clearSelections())}this.dataViewSelectionChange(t)}),this),this.hasVolPollingConf={interval:5,immediate:!0,webapi:{api:"SYNO.Core.Storage.Volume",version:1,method:"list",params:{offset:0,limit:-1,location:this.isUsbStation?"external":"internal"}},status_callback:function(e,t,i,s){var n;e&&(t.code?this.appWin.getMsgBox().alert(this.title,_T("common","commfail"),(function(){this.deactivate()}),this):(this.blHasUsbshare=!1,this.deviceStore.reload(),this.printerStore.reload(),this.hasVolume=t.total>0,this.isUsbStation&&(n=this.panel.getComponent("printerTab"),this.hasVolume?n.el.unmask():n.el.mask(_T("volume","volume_share_noexternal"),"syno-ux-mask-info")),Ext.getCmp(this.btnAddNPId).enable()))},scope:this},this.BonjourSharingPollingConf={interval:5,immediate:!0,webapi:{api:"SYNO.Core.ExternalDevice.Printer.BonjourSharing",version:1,method:"get"},status_callback:function(e,t,i,s){e&&(this.bonjourPrinterEnabled=t.enable_bonjour_support)},scope:this},this.isUsbStation&&(this.SystemDBPollingConf={interval:5,immediate:!0,webapi:{api:"SYNO.Core.SystemDB",version:1,method:"get"},status_callback:function(e,t,i,s){e&&(this.systemdb_share=t.systemdb_shares)},scope:this}),this.extDevSettingPollingConf={interval:5,immediate:!0,webapi:{api:"SYNO.Core.ExternalDevice.Storage.Setting",version:1,method:"get"},status_callback:function(e,t,i,s){e&&(this.delalloc=t.delalloc,this.forbid_usb=t.forbid_usb,this.non_admin_eject=t.non_admin_eject,this.needReboot=t.needReboot,this.support_exfat_mkfs=t.support_exfat_mkfs,t.setting?Ext.getCmp(this.btnSettingId).disable():Ext.getCmp(this.btnSettingId).enable())},scope:this}},renderDeviceAriaInfo:function(e){var t=[];return t.push(e.get("title")),t.push(e.get("status")),t.push(_T("usb","usb_producer"),e.get("producer")),t.push(_T("usb","usb_productname"),e.get("product")),Ext.isArray(e.get("partitions"))&&e.get("partitions").forEach((function(e){t.push(_T("common","name"),e.partition_title),t.push(_T("tree","leaf_sharefolder"),e.share_name),t.push(_T("usb","usb_size"),e.usage),t.push(_T("usb","usb_FStype"),e.filesystem)})),t.join(" ")},processDeviceStore:function(){var e=this;return function(t,i){return 0>=i.totalRecords||i.records.forEach((function(t){var i=SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice(t.data.status);t.set("status",i),t.set("title",t.data.dev_title),"usbDisk"==t.get("dev_type")?(t.set("cls","usb-normal-status"),SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("corrupt")==t.get("status")?t.set("cls","usb-error-status"):SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating")!=t.get("status")&&SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("init")!=t.get("status")||t.set("cls","usb-format-status")):"sdCard"==t.get("dev_type")?(t.set("cls","sd-normal-status"),SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("corrupt")==t.get("status")?t.set("cls","sd-error-status"):SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating")!=t.get("status")&&SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("init")!=t.get("status")||t.set("cls","sd-format-status")):"eSataDisk"==t.get("dev_type")&&(t.set("cls","esata-normal-status"),SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("corrupt")==t.get("status")?t.set("cls","esata-error-status"):SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating")!=t.get("status")&&SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("init")!=t.get("status")||t.set("cls","esata-format-status")),void 0!==t.get("producer")&&""!==t.get("producer")||t.set("producer","-"),void 0!==t.get("product")&&""!==t.get("product")||t.set("product","-"),void 0!==t.get("partitions")&&Ext.isArray(t.get("partitions"))&&t.get("partitions").forEach((function(s){if(void 0===s.filesystem||""===s.filesystem)if("exfat"==s.dev_fstype&&"no"==_D("disable_exfat","no"))if(e.exFATPkgRunning)s.filesystem=_T("usb","usb_mount_fail");else{var n=Ext.id(),o="&lt;"+_T("usb","usb_install_exfat_link")+"&gt;";e.gotoPkgManId?e.gotoPkgManId.push(n):e.gotoPkgManId=[n],s.filesystem=String.format("<a class='link-font' id='{0}' ext:qtip='{1}'>{2}</a>",n,_T("usb","usb_exfat_not_supported"),o)}else s.filesystem=_T("usb","usb_fs_other");void 0!==s.share_name&&""!==s.share_name||(s.share_name=_T("usb","usb_notmounted")),void 0===s.used_size_mb?s.usage="-- / --":s.total_size_mb>1024?s.usage=Ext.util.Format.round(s.used_size_mb/1024,2)+"/"+Ext.util.Format.round(s.total_size_mb/1024,2)+" GB":s.usage=s.used_size_mb+"/"+s.total_size_mb+" MB","formating"===s.status&&t.set("status",s.partition_title+" "+i+" "+t.get("progress"))}),this),t.set("ariaInfo",e.renderDeviceAriaInfo(t))}),this),i}},reloadExfatPkgStatus:function(){var e=this;SYNO.API.Request({api:"SYNO.Core.Package",version:1,method:"get",params:{id:"exFAT-Free",additional:["status"]},scope:this,callback:function(t,i,s,n){t&&"running"===i.additional.status?e.exFATPkgRunning=i.additional.status:e.exFATPkgRunning=!1}})},onClickExfatPkg:function(e){e.preventDefault(),SYNO.SDS.AdminCenter.ExternalDevices.onClickExfatPkg()},renderPrinterAriaInfo:function(e){var t=[];return t.push(e.get("title")),t.push(e.get("status")),t.push(_T("common","name"),e.get("cups_name")),e.get("ip")&&(t.push(_T("status","status_ipaddr"),e.get("ip")),t.push(_T("usb","net_prntr_ptl"),e.get("protocol")),t.push(_T("usb","net_prntr_qname"),e.get("qname"))),t.push(_T("usb","usb_producer"),e.get("mfg")),t.push(_T("usb","usb_productname"),e.get("mdl")),t.push(_T("usb","usb_printer_command_set"),e.get("printer_cmd_set")),e.get("lockby")&&t.push(_T("usb","usb_printer_wait_queue"),e.get("print_queue")),t.join(" ")},processPrinterStore:function(e){0>=e.length||e.forEach((function(e){if(e.set("title",_T("usb","usb_printer_lpr")),e.set("iconCls","default"),e.set("cls","default"),"usbip"==e.get("printer_mode")){var t=SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbPrinter(e.data.lockby);e.set("title",_T("usb","usb_printer_usbip")),e.set("cls","usbip"),e.set("status",t)}else"netPrinter"==e.get("printer_mode")?"Offline"==e.get("status")?(e.set("cls","np-badstatus"),e.set("status",_T("usbbackup","usbbkp_offline"))):(e.set("cls","np-goodstatus"),e.set("status",_T("usbbackup","usbbkp_online"))):e.set("status",_T("bluetooth","bluetooth_connected"));e.set("ariaInfo",this.renderPrinterAriaInfo(e))}),this)},getHelpParam:function(){return"deviceTab"===this.panel.activeTab.itemId?"AdminCenter/system_externaldevice_devicelist.html":"printerTab"===this.panel.activeTab.itemId?"AdminCenter/system_externaldevice_printer.html":"AdminCenter/system_externaldevice_desc.html"},getPanel:function(){return this.panel},activate:function(e){return this.panel.loadAllForm(),e&&e.tab&&this.panel.setActiveTab(e.tab),SYNO.API.Request({api:"SYNO.Core.ExternalDevice.Printer.Driver",version:1,method:"list",scope:this,callback:function(e,t,i,s){if(!e)return this.loadDriverFailed=!0,this.checkPrinterDriverList(),void(null!==this.npWizard&&this.npWizard.checkDriverList());this.driverList=t,this.loadDriverFailed=!1,this.checkPrinterDriverList(),this.createDeviceId(),null!==this.npWizard&&this.npWizard.checkDriverList()}}),this.pollingTaskStart(),!0},pollingTaskStart:function(){void 0===this.hasVolPollingID&&(this.hasVolPollingID=this.appWin.pollReg(this.hasVolPollingConf)),void 0===this.BonjourSharingPollingID&&(this.BonjourSharingPollingID=this.appWin.pollReg(this.BonjourSharingPollingConf)),this.isUsbStation&&void 0===this.SystemDBPollingID&&(this.SystemDBPollingID=this.appWin.pollReg(this.SystemDBPollingConf)),void 0===this.extDevSettingPollingID&&(this.extDevSettingPollingID=this.appWin.pollReg(this.extDevSettingPollingConf))},pollingTaskStop:function(){void 0!==this.hasVolPollingID&&(this.appWin.pollUnreg(this.hasVolPollingID),this.hasVolPollingID=void 0),void 0!==this.BonjourSharingPollingID&&(this.appWin.pollUnreg(this.BonjourSharingPollingID),this.BonjourSharingPollingID=void 0),this.isUsbStation&&void 0!==this.SystemDBPollingID&&(this.appWin.pollUnreg(this.SystemDBPollingID),this.SystemDBPollingID=void 0),void 0!==this.extDevSettingPollingID&&(this.appWin.pollUnreg(this.extDevSettingPollingID),this.extDevSettingPollingID=void 0)},deactivate:function(){return this.pollingTaskStop(),this.printerForm=null,this.driverList=null,this.brandList=null,!0},createPanel:function(){var e=new SYNO.ux.Panel(this.createDeviceTabObj()),t=new SYNO.ux.Panel(this.createPrinterTabObj()),i=[];_D("unique");SYNO.SDS.Utils.isInVirtualDSM()||i.push(e),"yes"===_D("support_printer")&&i.push(t),this.panel=new SYNO.SDS.Utils.TabPanel({module:this,padding:"4px 0px 0px 0px",title:_T("controlpanel","devices_and_printers"),activeTab:0,items:i}),this.panel.mon(this.printerStore,"load",this.checkPrinterPort,this)},createDeviceViewTpl:function(e){var t='<dt class="ex-dev-info-title" style="width:30%">{0}</dt>',i='<dt class="ex-dev-info-value" style="width:70%">{0}</dt>',s=new Ext.XTemplate('<tpl for="partitions">',"<dl>",'<dt class="sm-disk-list-column" style="width:30%">{partition_title}</dt>','<dt class="sm-disk-list-column" style="width:20%">{share_name}</dt>','<dt class="sm-disk-list-column" style="width:25%">{usage}</dt>','<dt class="sm-disk-list-column" style="width:25%">{filesystem}</dt>',"</dl>",'<div class="x-clear"></div>',"</tpl>");return new Ext.XTemplate('<tpl for=".">',"<dl>",String.format(t,_T("usb","usb_producer")+_T("common","colon")),String.format(i,"{producer}"),"</dl>",'<div class="x-clear"></div>',"<dl>",String.format(t,_T("usb","usb_productname")+_T("common","colon")),String.format(i,"{product}"),"</dl>",'<div class="x-clear"></div>',"</tpl>",'<tpl if="values.partitions">','<div class="sm-disk-list">','<div class="sm-disk-list-header">',"<dl>",String.format('<dt class="sm-disk-list-column" style="width:30%">{0}</dt>',_T("common","name")),String.format('<dt class="sm-disk-list-column" style="width:20%">{0}</dt>',_T("tree","leaf_sharefolder")),String.format('<dt class="sm-disk-list-column" style="width:25%">{0}</dt>',_T("usb","usb_size")),String.format('<dt class="sm-disk-list-column" style="width:25%">{0}</dt>',_T("usb","usb_FStype")),"</dl>",'<div class="x-clear"></div>',"</div>",'<div class="sm-disk-list-body">',s.html,"</div>","</div>",'<div class="x-clear"></div>',"</tpl>")},createDeviceTabObj:function(){var e=[{xtype:"syno_button",text:_T("smart","smart_toolbar_smart_info"),id:this.btnInfoId=Ext.id(),disabled:!0,hidden:!1,scope:this,handler:this.onClickInfoBtn},{xtype:"syno_button",text:_T("smart","smart_toolbar_smart_test"),id:this.btnTestId=Ext.id(),disabled:!0,hidden:!1,scope:this,handler:this.onClickTestBtn},{xtype:"syno_button",text:_T("usb","usb_btnformat"),id:this.btnFormatId=Ext.id(),disabled:!0,scope:this,handler:this.onClickFormatBtn},{xtype:"syno_button",text:_T("usb","usb_eject"),id:this.btnEjectId=Ext.id(),disabled:!0,tooltip:String.format(_T("usb","usb_ejectnote"),_T("usb","usb_eject")),scope:this,handler:this.onClickEjectBtn},{xtype:"syno_button",text:_T("download","download_table_heading_setting"),id:this.btnSettingId=Ext.id(),disabled:!0,scope:this,handler:this.onClickSettingBtn}],t=new Ext.Toolbar({style:{"padding-bottom":"8px"},items:e});return this.deviceView=new SYNO.ux.ExpandableListView({useARIA:!0,store:this.deviceStore,innerTpl:this.createDeviceViewTpl(),trackResetOnLoad:!1,cls:"ex-dev-storage-listview"}),{itemId:"deviceTab",title:_T("tree","node_device"),trackResetOnLoad:!0,layout:"fit",hideMode:"offsets",tbar:t,items:[this.deviceView]}},createPrinterViewTpl:function(){var e='<dt class="ex-dev-info-title" style="width:30%">{0}</dt>',t='<dt class="ex-dev-info-value" style="width:70%">{0}</dt>';return new Ext.XTemplate("<tpl>","<dl>",String.format(e,_T("common","name")+_T("common","colon")),String.format(t,"{cups_name}"),'</dl><div class="x-clear"></div>','<tpl if="ip">',"<dl>",String.format(e,_T("status","status_ipaddr")+_T("common","colon")),String.format(t,"{ip}"),'</dl><div class="x-clear"></div>',"<dl>",String.format(e,_T("usb","net_prntr_ptl")+_T("common","colon")),String.format(t,"{protocol}"),'</dl><div class="x-clear"></div>',"<dl>",String.format(e,_T("usb","net_prntr_qname")+_T("common","colon")),String.format(t,"{qname}"),'</dl><div class="x-clear"></div>',"</tpl>","<dl>",String.format(e,_T("usb","usb_producer")+_T("common","colon")),String.format(t,"{mfg}"),'</dl><div class="x-clear"></div>',"<dl>",String.format(e,_T("usb","usb_productname")+_T("common","colon")),String.format(t,"{mdl}"),'</dl><div class="x-clear"></div>',"<dl>",String.format(e,_T("usb","usb_printer_command_set")+_T("common","colon")),String.format(t,"{printer_cmd_set}"),'</dl><div class="x-clear"></div>','<tpl if="lockby">',"<dl>",String.format(e,_T("usb","usb_printer_wait_queue")+_T("common","colon")),String.format(t,"{print_queue}"),'</dl><div class="x-clear"></div>',"</tpl>","</tpl>")},createPrinterTabObj:function(){var e=[{xtype:"syno_button",text:_T("usb","net_prntr_add"),id:this.btnAddNPId=Ext.id(),disabled:!0,scope:this,handler:this.onClickAddNPBtn},{xtype:"syno_button",text:_T("common","remove"),id:this.btnPEjectId=Ext.id(),disabled:!0,scope:this,handler:this.onClickEjectBtn}],t=[{text:_T("usb","usb_printer_usbip_setup"),id:this.btnSetupId=Ext.id(),disabled:!0,scope:this,handler:this.onClickSetupBtn},{text:_T("usb","usb_cleannote").replace("_CLEAN_",_T("usb","usb_clean")),id:this.printerCleanSpoolBtnId=Ext.id(),disabled:!0,scope:this,disableClearLastDom:!0,handler:this.printerCleanSpool},{text:_T("usb","usb_print_test_page"),id:this.printTestPageId=Ext.id(),disabled:!0,scope:this,disableClearLastDom:!0,handler:this.printTestPage},{text:_T("usb","usb_printer_usbip_release_lock"),id:this.btnPrinterReleaseLockId=Ext.id(),disabled:!0,scope:this,disableClearLastDom:!0,handler:this.printerReleaseLock}];"yes"!==_D("supportMFP")&&t.pop(),e.push(new Ext.Action({xtype:"syno_button",text:_T("usb","prntr_mgr"),scope:this,id:this.btnPrintmgrId=Ext.id(),disabled:!0,menu:new SYNO.ux.Menu({items:t})}));var i=new Ext.Toolbar({style:{"padding-bottom":"8px"},items:e,defaultType:"syno_button"});return this.printerView=new SYNO.ux.ExpandableListView({useARIA:!0,store:this.printerStore,innerTpl:this.createPrinterViewTpl(),cls:"ex-dev-printer-listview"}),{itemId:"printerTab",title:_T("usb","prntr_device"),trackResetOnLoad:!0,layout:"fit",hideMode:"offsets",tbar:i,listeners:{activate:function(e){this.printerView.refresh()},scope:this},items:[this.printerView]}},checkPrinterPort:function(){var e=!1,t=!1,i=!1;this.printerStore.each((function(s){switch(s.get("printer_mode")){case"usbip":e=!0;break;case"favor_lpr":case"netPrinter":t=!0}"on"===s.get("airprint_enabled")&&(i=!0)}),this),e&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.usbip",!1),t&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.favor_lpr",!1),i&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.airprint",!1)},dataViewSelectionChange:function(e){var t;if(Ext.getCmp(this.btnInfoId).disable(),Ext.getCmp(this.btnInfoId).hide(),Ext.getCmp(this.btnTestId).disable(),Ext.getCmp(this.btnTestId).hide(),Ext.getCmp(this.btnFormatId).disable(),Ext.getCmp(this.btnEjectId).disable(),Ext.getCmp(this.btnPEjectId).disable(),Ext.getCmp(this.printerCleanSpoolBtnId).disable(),Ext.getCmp(this.printTestPageId).disable(),Ext.getCmp(this.btnSetupId).disable(),Ext.getCmp(this.btnPrintmgrId).disable(),"yes"===_D("supportMFP")&&Ext.getCmp(this.btnPrinterReleaseLockId).disable(),!(e.length<=0)){"deviceTab"==this.panel.getActiveTab().itemId?t=this.lastSelectedRecord.get("dev_type"):"printerTab"==this.panel.getActiveTab().itemId&&(t=this.lastSelectedRecord.get("printer_mode"));var i=this.lastSelectedRecord.get("status");switch(t){case"usbDisk":case"sdCard":if(-1==i.indexOf(SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating"))&&i!==SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating")&&i!==SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("init")&&Ext.getCmp(this.btnEjectId).enable(),this.lastSelectedRecord.get("formatable"))switch(i){case SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("normal"):case SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("hddfail"):case SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("corrupt"):Ext.getCmp(this.btnFormatId).enable()}break;case"eSataDisk":Ext.getCmp(this.btnInfoId).show(),Ext.getCmp(this.btnTestId).show(),i==SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("normal")&&Ext.getCmp(this.btnFormatId).enable(),-1==i.indexOf(SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating"))&&i!=SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating")&&i!=SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("init")&&(Ext.getCmp(this.btnEjectId).enable(),Ext.getCmp(this.btnInfoId).enable(),Ext.getCmp(this.btnTestId).enable());break;case"usbip":case"lpr":case"favor_lpr":var s=this.lastSelectedRecord;Ext.getCmp(this.btnPEjectId).enable(),Ext.getCmp(this.btnSetupId).enable(),Ext.getCmp(this.btnPrintmgrId).enable(),"yes"===_D("supportMFP")&&"usbip"===this.lastSelectedRecord.get("printer_mode")?"Free"===s.get("lockby")?Ext.getCmp(this.btnPrinterReleaseLockId).disable():Ext.getCmp(this.btnPrinterReleaseLockId).enable():Ext.getCmp(this.printerCleanSpoolBtnId).enable(),""!==s.get("driver_model")&&s.get("enable_airprint")&&Ext.getCmp(this.printTestPageId).enable();break;case"netPrinter":var n=this.lastSelectedRecord;Ext.getCmp(this.btnPEjectId).enable(),Ext.getCmp(this.btnSetupId).enable(),Ext.getCmp(this.btnPrintmgrId).enable(),Ext.getCmp(this.printerCleanSpoolBtnId).enable(),""!==n.get("driver_model")&&n.get("enable_airprint")&&Ext.getCmp(this.printTestPageId).enable()}}},getFormatDataList:function(e){var t=[];return Ext.each(e.json.partitions,(function(e){var i=[];i.push(e.name_id,e.partition_title),t.push(i)}),this),t},onClickInfoBtn:function(){var e="/dev/"+this.lastSelectedRecord.get("dev_id"),t=this.lastSelectedRecord.get("dev_title");this.InfoFormPanel=new SYNO.SDS.StorageManager.SmartInfo({owner:this.appWin,appWin:this.appWin,style:"padding: 0px 20px;",height:450}),this.InfoDialog=new SYNO.SDS.ModalWindow({owner:this.appWin,dsmStyle:"v5",resizable:!1,width:700,height:510,hideLabel:!1,title:_T("smart","smart_toolbar_smart_info")+" "+t,buttons:[{text:_T("common","alt_close"),scope:this,handler:function(){this.InfoDialog.close()}}],items:this.InfoFormPanel}),this.InfoDialog.open(),SYNO.API.Request({api:"SYNO.Core.Storage.Disk",version:1,method:"get_smart_info",params:{device:e},callback:function(e,t,i,s){e?this.InfoFormPanel.getComponent("grid").getStore().loadData(t):this.appWin.getMsgBox().alert(_T("tree","node_device"),_T("common","error_system"))},scope:this})},onClickTestBtn:function(){var e="/dev/"+this.lastSelectedRecord.get("dev_id");this.TestDialog=new SYNO.SDS.StorageManager.Wizard.SmartTest({owner:this.appWin,device:e,blExternal:!0}),this.TestDialog.open()},onClickFormatBtn:function(){if(0!==this.deviceView.getSelectionCount()){this.pollingTaskStop();var e=this.lastSelectedRecord.get("dev_type"),t=this.lastSelectedRecord.get("dev_title"),i=this.getFormatDataList(this.lastSelectedRecord),s=_T("sata","sata_format_wizard_fs_type");"usbDisk"!=e&&"sdCard"!=e||(s=_T("usb","usb_format_wizard_fs_type"));var n={border:!1,owner:this.appWin,webapi:{methods:{set:"format"},version:1},items:[{xtype:"syno_fieldset",title:_T("externaldevice","externaldevice_format_option"),items:[{xtype:"syno_radio",name:"formatopt",inputValue:"entiredisk",boxLabel:_T("externaldevice","externaldevice_format_entire_disk"),checked:!0},{xtype:"syno_displayfield",indent:1,value:_T("externaldevice","externaldevice_format_entire_disk_desc")},{xtype:"syno_radio",name:"formatopt",inputValue:"selectpartition",boxLabel:_T("externaldevice","externaldevice_format_selected_partition"),disabled:i.length<2,checked:!1},{xtype:"syno_combobox",indent:1,width:250,hideLabel:!0,value:i.length?i[0][0]:"",name:"partitions",displayField:"display",valueField:"value",autoDestroy:!0,triggerAction:"all",editable:!1,mode:"local",disabled:!0,store:new Ext.data.ArrayStore({fields:["value","display"],data:i})}]},{xtype:"syno_fieldset",title:s,items:this.support_exfat_mkfs?[{xtype:"syno_radio",name:"filesystem",inputValue:"ext4",boxLabel:_T("volume","volume_ext4"),checked:!0},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,value:_T("volume","volume_ext4_desc")},{xtype:"syno_radio",name:"filesystem",inputValue:"fat",boxLabel:_T("usb","usb_fat32")},{xtype:"syno_radio",name:"filesystem",inputValue:"exfat",boxLabel:_T("usb","usb_exfat")},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("usb","usb_exfat_fat32_descr")}]:[{xtype:"syno_radio",name:"filesystem",inputValue:"ext4",boxLabel:_T("volume","volume_ext4"),checked:!0},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,value:_T("volume","volume_ext4_desc")},{xtype:"syno_radio",name:"filesystem",inputValue:"fat",boxLabel:_T("usb","usb_fat32")},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("usb","usb_fat32_descr")}]}]};this.formatFormPanel=new SYNO.SDS.Utils.FormPanel(n),this.formatDialog=new SYNO.SDS.ModalWindow({owner:this.appWin,layout:"fit",width:600,height:520,resizable:!1,hideLabel:!1,title:_T("usb","usb_btnformat")+" "+t,buttons:[{text:_T("common","cancel"),scope:this,handler:function(){this.formatDialog.close(),this.pollingTaskStart()}},{btnStyle:"blue",text:_T("common","ok"),scope:this,handler:this.formatHandler}],items:this.formatFormPanel,listeners:{scope:this,afterrender:function(){new SYNO.ux.Utils.EnableRadioGroup(this.formatFormPanel.getForm(),"formatopt",{entiredisk:[],selectpartition:["partitions"]})}}}),this.formatDialog.open()}},formatHandler:function(){var e=this.formatFormPanel.getForm(),t=this.lastSelectedRecord.get("share_name"),i=e.findField("partitions"),s="",n=this.lastSelectedRecord.get("dev_id"),o=this.lastSelectedRecord.get("dev_type"),a=this.lastSelectedRecord.get("dev_title"),r=0,l="";if(""===t||t==_T("usb","usb_inactive_disk")){if("selectpartition"===e.findField("formatopt").getGroupValue()){a=i.findRecord(i.valueField,i.getValue()).get(i.displayField);var d=i.store.find("display",a);r=this.lastSelectedRecord.json.partitions[d].total_size_mb}else r=this.lastSelectedRecord.get("total_size_mb");s=(s=String.format(_T("usb","usb_formatwarn_noshare"),a))+" "+_T("usb","format_disk_confirm")}else s=_T("volume","volume_adddisk_type_two_warning");var c=e.findField("filesystem").getGroupValue();("ext3"===c||"ext4"===c)&&r<SYNO.SDS.AdminCenter.ExternalDevices.EXT_FORMAT_MIN_MB_SIZE?(l=String.format(_T("usb","usb_format_size_warning"),a),this.formatDialog.getMsgBox().alert(_T("usb","usb_btnformat"),l)):"fat"===c&&r>SYNO.SDS.AdminCenter.ExternalDevices.FAT_FORMAT_MAX_MB_SIZE?(l=String.format(_T("usb","usb_format_fat_size_warning"),a),this.formatDialog.getMsgBox().alert(_T("usb","usb_btnformat"),l)):this.formatDialog.getMsgBox().confirm(_T("usb","usb_btnformat"),s,(function(t,s){if("yes"==t){var a,r=e.getValues();"entiredisk"===e.findField("formatopt").getGroupValue()?r.dev_id=n:r.dev_id=i.getValue(),a="usbDisk"==o||"sdCard"==o?"SYNO.Core.ExternalDevice.Storage.USB":"SYNO.Core.ExternalDevice.Storage.eSATA",e.webapi.api=a,e.doAction("apply",{method:"POST",params:r}),this.lastSelectedRecord.set("status",SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice("formating")),"usbDisk"==this.lastSelectedRecord.get("dev_type")?this.lastSelectedRecord.set("cls","usb-format-status"):"sdCard"==this.lastSelectedRecord.get("dev_type")?this.lastSelectedRecord.set("cls","sd-format-status"):"eSataDisk"==this.lastSelectedRecord.get("dev_type")&&this.lastSelectedRecord.set("cls","esata-format-status"),Ext.getCmp(this.btnFormatId).disable(),Ext.getCmp(this.btnEjectId).disable(),Ext.getCmp(this.btnInfoId).disable(),Ext.getCmp(this.btnTestId).disable(),this.pollingTaskStart(),this.formatDialog.close()}}),this)},onClickExternalDefaultPermission:function(){new SYNO.SDS.AdminCenter.ExternalDevices.ExternalDefaultPermissionDialog({owner:this.appWin,module:this.module}).loadPermissionData()},onClickEjectBtn:async function(){if(0===this.deviceView.getSelectionCount()&&0===this.printerView.getSelectionCount())return;var e=_T("usb","usb_ejectwarn");this.isUsbStation&&this.deviceView.getSelectedRecords().forEach((function(t){t.data.partitions.forEach((function(t){this.systemdb_share===t.share_name&&(e=_T("system","eject_sys_database_warning"))}),this)}),this);"confirm"===await this.appWin.getMsgBox().confirm(_T("tree","node_device"),e,null,{})&&(this.pollingTaskStop(),this.doEjectAction(),this.pollingTaskStart())},doEjectAction:function(){var e,t="SYNO.SDS.CMS.Application"===this.appWin.getOpenConfig("className"),i=!1,s=_T("tree","node_device"),n={method:"eject",version:1,params:{}};if("deviceTab"==this.panel.getActiveTab().itemId?e=this.lastSelectedRecord.get("dev_type"):"printerTab"==this.panel.getActiveTab().itemId&&(e=this.lastSelectedRecord.get("printer_mode")),"usbDisk"==e||"sdCard"==e?(n.api="SYNO.Core.ExternalDevice.Storage.USB",n.params.dev_id=this.lastSelectedRecord.get("dev_id")):"eSataDisk"==e?(n.api="SYNO.Core.ExternalDevice.Storage.eSATA",n.params.dev_id=this.lastSelectedRecord.get("dev_id")):"netPrinter"==e?(n.api="SYNO.Core.ExternalDevice.Printer.Network",n.params.printer_id=this.lastSelectedRecord.get("printer_id"),i=!0):(n.api="SYNO.Core.ExternalDevice.Printer.USB",n.params.printer_id=this.lastSelectedRecord.get("printer_id"),i=!0),i&&!1===this.hasVolume)return t?void this.appWin.getMsgBox().alert(s,_T("cms","cms_no_volumes")):void this.appWin.getMsgBox().alert(s,this.isUsbStation?_T("volume","volume_share_volumeno"):_T("error","volume_no_volumes"),(function(e){"ok"===e&&SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}),this);this.appWin.setStatusBusy(null,_T("common","loading")),SYNO.API.Request({api:n.api,version:n.version,method:n.method,params:n.params,timeout:36e5,scope:this,callback:function(e,t,i,n){var o;if(!e)return o=SYNO.API.getErrorString(t.code),this.appWin.getMsgBox().alert(s,o),void this.appWin.clearStatus();SYNO.SDS.StatusNotifier.fireEvent("externaldeviceactivity","ejectdevice"),"printerTab"===this.panel.getActiveTab().getItemId()?(this.printerView.deselect(this.lastSelectedRecord),this.printerStore.reload_withmask.call(this)):(this.deviceView.deselect(this.lastSelectedRecord),this.deviceStore.reload_withmask.call(this))}})},onClickSettingBtn:function(){this.pollingTaskStop(),this.settingDialog=new SYNO.SDS.AdminCenter.ExternalDevices.ExternalSettingDialog({owner:this.appWin,module:this.module},{delalloc:this.delalloc,forbid_usb:this.forbid_usb,non_admin_eject:this.non_admin_eject,needReboot:this.needReboot,support_exfat_mkfs:this.support_exfat_mkfs,btnSettingId:this.btnSettingId,btnFormatId:this.btnFormatId,btnEjectId:this.btnEjectId}),this.settingDialog.mon(this.settingDialog,"close",(function(){this.pollingTaskStart.defer(1e3,this)}),this,{single:!0}),this.settingDialog.open()},checkBonjourPrinter:function(e,t){t&&!this.bonjourPrinterEnabled&&this.appWin.getMsgBox().confirm(_T("usb","usb_printer_airprint"),String.format(_T("usb","usb_printer_airprint_notice"),_T("network","bonjourPrinter_subject")),(function(t){"no"===t&&e.setValue(!1)}),this)},fillPrinterItems:function(e){if(this.isUsbPrntr=!0,e.push({xtype:"syno_fieldset",title:_T("usb","prntr_ap_gcp_setting"),name:"airprint_field",items:[{xtype:"syno_checkbox",name:"enable_airprint",boxLabel:_T("usb","usb_printer_airprint_enable")},{xtype:"syno_checkbox",name:"fit_to_page",boxLabel:_T("usb","fit_to_page")},{xtype:"syno_combobox",name:"driver_brand",fieldLabel:_T("usb","usb_printer_brand"),displayField:"value",autoSelect:!0,width:250,store:this.brandList=new Ext.data.ArrayStore({fields:["value"]}),listeners:{scope:this,select:function(e){var t=this.printerForm.findField("driver_model");t.getStore().loadData(this.driverList[e.getValue()]),t.setValue(t.getStore().getAt(0).get("value"))}}},{xtype:"syno_combobox",name:"driver_model",fieldLabel:_T("usb","usb_printer_driver"),displayField:"value",valueField:"value",autoSelect:!0,width:250,store:new Ext.data.ArrayStore({fields:["value"]})},{xtype:"syno_displayfield",name:"loading_status",value:_T("usb","usb_printer_driver_loading")}]},{xtype:"syno_textfield",name:"printer_id",hidden:!0}),"netPrinter"==this.lastSelectedRecord.json.printer_mode)this.isUsbPrntr=!1,this.fillNetPrinterItems(e);else{if("yes"!=_D("supportMFP"))return;this.fillUsbPrinterItems(e)}},fillNetPrinterItems:function(e){e.unshift({xtype:"syno_fieldset",itemId:"ptl_setting",title:_T("usb","net_prntr_conf"),items:[{xtype:"syno_displayfield",name:"ip",width:250,fieldLabel:_T("common","ip_addr")},{xtype:"syno_textfield",name:"cups_name",id:this.NameId=Ext.id(),fieldLabel:_T("usb","net_prntr_name"),enableKeyEvents:!0,allowBlank:!1,maxlength:32,width:250,validationEvent:"keyup",validator:function(){return 0<=this.getValue().search(/[^a-zA-Z0-9_]/)?_T("error","error_bad_field"):(this.clearInvalid(),!0)}},{xtype:"syno_combobox",name:"protocol",width:250,fieldLabel:_T("usb","net_prntr_ptl"),autoSelect:!0,allowBlank:!1,store:this.backendList,displayField:"protocol_text",valueField:"protocol_id"},{xtype:"syno_textfield",allowBlank:!1,fieldLabel:_T("usb","net_prntr_qname"),name:"qname",width:250,enableKeyEvents:!0,maxlength:32,validationEvent:"keyup",validator:function(){var e=this.getValue();return 0<=e.search("usbprinter")?_T("error","error_bad_field"):this.originalValue===e||""===this.originalValue||(0<=e.search(/[^a-zA-Z0-9_]/)?_T("error","error_bad_field"):(this.clearInvalid(),!0))}}]})},fillUsbPrinterItems:function(e){e.unshift({xtype:"syno_fieldset",itemId:"mode_setting",title:_T("usb","usb_printer_mode"),items:[{xtype:"syno_radio",name:"printer_mode",inputValue:"favor_lpr",boxLabel:_T("usb","usb_printer_lpr_prefer_title")},{xtype:"syno_displayfield",indent:1,value:_T("usb","usb_printer_lpr_prefer_desc")},{xtype:"syno_radio",name:"printer_mode",inputValue:"usbip",boxLabel:_T("usb","usb_printer_usbip_prefer_title")},{xtype:"syno_displayfield",indent:1,value:_T("usb","usb_printer_usbip_prefer_desc")}]},{xtype:"syno_textfield",name:"cups_name",hidden:!0},{xtype:"syno_textfield",name:"mdl",hidden:!0},{xtype:"syno_textfield",name:"mfg",hidden:!0})},CheckBrandDriver:function(){this.printerForm.findField("enable_airprint").getValue()?(this.printerForm.findField("driver_brand").enable(),this.printerForm.findField("driver_model").enable(),this.printerForm.findField("fit_to_page").enable()):(this.printerForm.findField("driver_brand").disable(),this.printerForm.findField("driver_model").disable(),this.printerForm.findField("fit_to_page").disable())},onClickSetupBtn:function(){var e=null;if(0!==this.printerView.getSelectionCount())if(this.hasVolume){var t;this.pollingTaskStop();var i=[];this.fillPrinterItems(i),t={border:!1,trackResetOnLoad:!0,items:i},this.printerSetupDialog=new SYNO.SDS.ModalWindow({owner:this.appWin,layout:"fit",module:this,width:580,height:!1===this.isUsbPrntr||"yes"===_D("supportMFP")?580:520,resizable:!0,hideLabel:!1,title:_T("usb","usb_printer_usbip_setup"),savePrinterMode:function(){if(this.printerForm.isValid())if(this.printerForm.isDirty()){var t,i=e.getForm().getValues();(i=Ext.apply({google_cloud_print:{}},i)).google_cloud_print.enable=!1,delete i.enable_gcp,delete i.gcp_account,delete i.gcp_passwd,delete i.mfg,delete i.mdl,this.isUsbPrntr?t="SYNO.Core.ExternalDevice.Printer.USB":(t="SYNO.Core.ExternalDevice.Printer.Network",void 0===i.qname&&(i.qname="")),this.printerForm.findField("enable_airprint").getValue()&&this.printerForm.findField("fit_to_page").getValue()?i.fit_to_page=!0:i.fit_to_page=!1,this.printerSetupDialog.setStatusBusy({text:_T("common","saving")}),SYNO.API.Request({api:t,version:1,method:"set",scope:this,params:i,timeout:3e5,callback:function(e,t,i,s){var n;if(this.printerSetupDialog.clearStatusBusy(),this.printerSetupDialog.unmask(),!e)return n=SYNO.API.getErrorString(t.code),void this.printerSetupDialog.getMsgBox().alert(_T("tree","node_device"),n);this.printerSetupDialog.setStatusOK({text:_T("common","setting_applied")});var o=this.printerForm.getValues(),a=this.printerForm.findField("enable_airprint");if(this.printerForm.setValues(o),a.originalValue=a.getValue(),"SYNO.Core.ExternalDevice.Printer.Network"==s.params.api){var r="",l="";this.printerForm.findField("printer_id")&&(l=(r=this.printerForm.findField("printer_id").getValue()).substr(0,r.indexOf("-")+1),l+=this.printerForm.findField("cups_name").getValue(),this.printerForm.findField("printer_id").setValue(l))}switch(this.printerSetupDialog.blNeedReload=!0,s.params.printer_mode){case"usbip":SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.usbip",!1);break;case"favor_lpr":case"netPrinter":SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.favor_lpr",!1)}s.params.enable_airprint&&SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.ExternalDevices.airprint",!1)}})}else this.printerSetupDialog.setStatusError({text:_T("error","nochange_subject"),clear:!0});else this.printerSetupDialog.setStatusError({text:_T("common","forminvalid"),clear:!0})},buttons:[{text:_T("common","close"),scope:this,handler:this.onClose},{btnStyle:"blue",text:_T("common","save"),scope:this,handler:this.onSave}],items:e=new SYNO.SDS.Utils.FormPanel(t),listeners:{beforeclose:{scope:this,fn:this.checkNeedReload}}}),this.printerForm=e.getForm(),this.printerSetupDialog.blNeedReload=!1,this.panel.mon(e,"afterlayout",(function(e,t){this.afterLayout(e,t)}),this),this.printerSetupDialog.open()}else this.appWin.getMsgBox().alert(this.title,this.isUsbStation?_T("volume","volume_share_volumeno"):_T("error","volume_no_volumes"))},onSave:function(){this.printerSetupDialog.savePrinterMode.call(this)},checkNeedReload:function(){this.printerSetupDialog.blNeedReload&&(this.printerStore.reload_withmask.call(this),this.printerSetupDialog.blNeedReload=!1)},onClose:function(){var e=this;this.checkNeedReload(),this.printerForm.isDirty()?this.printerSetupDialog.confirmLostChangePromise({save:function(){e.onSave()},dontSave:function(){e.printerSetupDialog.close(),e.pollingTaskStart()},cancel:Ext.emptyFn}):(e.printerSetupDialog.close(),e.pollingTaskStart())},afterLayout:function(e,t){if(this.printerForm.findField("enable_airprint").on("check",this.CheckBrandDriver,this),"netPrinter"==this.lastSelectedRecord.json.printer_mode&&(this.panel.mon(this.printerForm.findField("protocol"),"select",(function(){"bjnp"===this.printerForm.findField("protocol").getValue()||"socket"===this.printerForm.findField("protocol").getValue()?(this.printerForm.findField("qname").disable(),this.printerForm.findField("qname").clearInvalid()):this.printerForm.findField("qname").enable()}),this),SYNO.ux.AddTip(this.printerForm.findField("qname").getEl(),_T("usb","net_qname_tip"))),0!==this.printerView.getSelectionCount()){var i=this.lastSelectedRecord.data;this.printerForm.setValues(i),"netPrinter"==this.lastSelectedRecord.json.printer_mode&&this.printerForm.findField("protocol").fireEvent("select")}this.panel.mon(this.printerForm.findField("enable_airprint"),"check",this.checkBonjourPrinter,this),this.checkPrinterDriverList(),this.CheckBrandDriver()},detectDriver:function(){var e,t,i,s=null,n=null,o=!1,a=function(e,t){var i=e.split(" "),s=i.length-1,n=i[s].toLowerCase(),o=t.toLowerCase();for(0<=i[s].search(/(ser|printer)/i)&&0<s?n=i[--s].toLowerCase():!isNaN(i[s])&&0<s&&(n=i[--s].toLowerCase()+" "+n);0<=i[s].search(/(PS3|MFP|PLUS|XL|LF)/i)&&0<s;)n=i[--s].toLowerCase()+" "+n;return!(0>o.search(n))};t=this.lastSelectedRecord.get("mfg"),i=this.lastSelectedRecord.get("mdl"),e=this.lastSelectedRecord.get("mdl"),""!==(n=this.lastSelectedRecord.get("driver_model"))?s=this.lastSelectedRecord.get("driver_brand"):""!==t&&""!==i&&(s=this.mfgList[t],n=this.mdlList[i]),s&&n?o=!0:null===(s=function(e,t){for(var i in e)if(i.toLowerCase()===t.toLowerCase())return i;return null}(this.driverList,this.lastSelectedRecord.get("driver_brand")))?Ext.iterate(this.driverList,(function(t,i){return Ext.each(i,(function(i){return!a(e,i[0])||(n=i[0],s=t,o=!0,!1)}),this),!o}),this):Ext.each(this.driverList[s],(function(t){return!a(e,t[0])||(n=t[0],o=!0,!1)}),this);var r=this.printerForm.findField("driver_brand"),l=this.printerForm.findField("driver_model");null!==s?(r.onSelect(r.findRecord("value",s)),r.originalValue=r.getValue(),o&&(l.setValue(n),l.originalValue=l.getValue())):r.onSelect(r.getStore().getAt(0))},checkPrinterDriverList:function(){if(null!==this.printerForm){var e=null!==this.driverList,t=[],i=this.printerForm.findField("loading_status");this.loadDriverFailed&&i.setValue(_T("usb","usb_printer_driver_loading_fail")),i.originalValue=i.getValue(),SYNO.ux.Utils.displayFormField(this.printerForm,"enable_airprint",e),SYNO.ux.Utils.displayFormField(this.printerForm,"fit_to_page",e),SYNO.ux.Utils.displayFormField(this.printerForm,"driver_brand",e),SYNO.ux.Utils.displayFormField(this.printerForm,"driver_model",e),SYNO.ux.Utils.displayFormField(this.printerForm,"loading_status",!e),e&&0===this.brandList.getCount()&&(Ext.iterate(this.driverList,(function(e){t.push([e])}),this),this.brandList.loadData(t)),e&&this.detectDriver()}},createDeviceId:function(){this.driverList&&Ext.iterate(this.driverList,(function(e,t){Ext.each(t,(function(t){if(""===t[3]||""===t[2])return!0;this.mfgList[t[2]]=e,this.mdlList[t[3]]=t[0]}),this)}),this)},printTestPage:function(){var e=this.appWin;this.hasVolume?(e.setStatusBusy({text:_T("common","msg_waiting")}),SYNO.API.Request({api:"SYNO.Core.ExternalDevice.Printer",version:1,method:"print_test",params:{printer_id:this.lastSelectedRecord.get("printer_id")},callback:function(t,i,s,n){e.clearStatusBusy(),t?e.setStatusOK({text:_T("common","completed")}):this.appWin.getMsgBox().alert(_T("tree","node_device"),_T("common","error_system"))},scope:this})):this.appWin.getMsgBox().alert(this.title,this.isUsbStation?_T("volume","volume_share_volumeno"):_T("error","volume_no_volumes"))},printerCleanSpool:function(){var e=this.appWin;e.setStatusBusy({text:_T("common","msg_waiting")}),SYNO.API.Request({api:"SYNO.Core.ExternalDevice.Printer",version:1,method:"clean",callback:function(t,i,s,n){e.clearStatusBusy(),t?e.setStatusOK({text:_T("common","completed")}):this.appWin.getMsgBox().alert(_T("tree","node_device"),_T("common","error_system"))},scope:this})},printerReleaseLock:function(){var e=this.appWin;this.appWin.getMsgBox().confirm(_T("usb","usb_printer_usbip_release_lock"),_T("usb","usb_printer_usbip_release_lock_warning"),(function(t,i){"yes"==t&&(e.setStatusBusy({text:_T("common","msg_waiting")}),SYNO.API.Request({api:"SYNO.Core.ExternalDevice.Printer.USB",version:1,method:"release_mfp",params:{printer_id:this.lastSelectedRecord.get("printer_id")},callback:function(t,i,s,n){e.clearStatusBusy(),t?(e.setStatusOK({text:_T("common","completed")}),Ext.getCmp(this.btnPrinterReleaseLockId).disable()):this.appWin.getMsgBox().alert(_T("tree","node_device"),_T("common","error_system"))},scope:this}))}),this)},onClickAddNPBtn:function(){var e="SYNO.SDS.CMS.Application"===this.appWin.getOpenConfig("className");if(!1===this.hasVolume)return e?void this.appWin.getMsgBox().alert(this.title,this.isUsbStation?_T("volume","volume_share_volumeno"):_T("cms","cms_no_volumes")):void this.appWin.getMsgBox().alert(_T("tree","node_device"),this.isUsbStation?_T("volume","volume_share_volumeno"):_T("error","volume_no_volumes"),(function(e){"ok"!==e||this.isUsbStation||SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}),this);this.npWizard=new SYNO.SDS.AdminCenter.ExternalDevices.AddNetPrinterWizardDialog({owner:this.appWin,module:this,blHasUsbshare:this.blHasUsbshare,loadDriverFailed:this.loadDriverFailed,printerStore:this.printerStore}),this.npWizard.mon(this.npWizard,"close",(function(){this.npWizard=null}),this,{single:!0}),this.npWizard.open()}}),SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbPrinter=function(e){return"Free"===e?_T("usb","usb_printer_usbip_free"):-1!=e.indexOf("CUPS")?_T("usb","usb_printer_lpr_printing"):String.format(_T("usb","usb_printer_usbip_lockby"),e)},SYNO.SDS.AdminCenter.ExternalDevices.getStatusForUsbDevice=function(e){switch(e.toLowerCase()){case"normal":return _T("usb","usb_st_normal");case"formating":return _T("usb","usb_st_format");case"hddfail":return _T("usb","usb_st_fail");case"corrupt":return _T("usb","usb_st_needfsck");case"init":return _T("usb","usb_st_init");case"fsck":return _T("usb","usb_st_fsck");case"usbbackup":return _T("usb","usb_st_backingup");default:return _T("bluetooth","bluetooth_connected")}},Ext.ns("SYNO.SDS.AdminCenter.Update"),Ext.define("SYNO.SDS.AdminCenter.Update.UploadDialog",{extend:"SYNO.SDS.ModalWindow",mainFileButtonID:null,passiveFileButtonID:null,constructor:function(e){this.uploadInfo=null,this.activePatchInfo=null,this.passivePatchInfo=null,this.owner=e.owner,this.mainModel=e.mainModel,this.passiveModel=e.passiveModel;var t=Ext.apply({dsmStyle:"v5",title:_T("update","update_dsm_manually"),resizable:!1,closable:!0,width:600,height:350,useStatusBar:!0,padding:"16px 20px 0px 20px",items:this.getItems(),layout:{type:"vbox",align:"stretch"},listeners:{show:this.updateFileTextField,scope:this},buttons:[{text:_T("common","cancel"),scope:this,handler:function(){this.close()}},{text:_T("common","apply"),scope:this,btnStyle:"blue",handler:this.onSubmit}]},e);this.callParent([t])},isHybridHA:function(){return!(!_S("ha_running")||!_S("is_hybrid_ha"))},updateFileTextField:function(){this.isHybridHA()&&(Ext.getCmp(this.mainFileButtonID).fileTextField.setValue(String.format(_T("update","patch_for_model"),this.mainModel)),Ext.getCmp(this.passiveFileButtonID).fileTextField.setValue(String.format(_T("update","patch_for_model"),this.passiveModel)))},getItems:function(){var e=[];return e.push(this.createMainUploadForm()),this.isHybridHA()&&e.push(this.createPassiveUploadForm()),e.push({xtype:"box",flex:1}),e.push({xtype:"syno_displayfield",htmlEncode:!1,value:_T("update","update_notice")}),e},createMainUploadForm:function(){return new SYNO.SDS.Utils.FormPanel({itemId:"upload_main",fileUpload:!0,html5upload:!0,trackResetOnLoad:!0,frame:!1,border:!1,padding:"0px",webapi:{api:"SYNO.Core.Upgrade.Patch",method:"upload",version:1},items:[{xtype:"syno_displayfield",value:_T("update","update_notice_manual")},{xtype:"textfield",name:"target",value:"active",hidden:!0},{xtype:"syno_filebutton",fieldLabel:this.isHybridHA()?_T("update","patch_for_active"):_T("itunes","itunes_path"),id:this.mainFileButtonID=Ext.id(),name:"file"}],onApiSuccess:Ext.createDelegate(this.onMainUploadSuccess,this),onApiFailure:Ext.createDelegate(this.onUploadFailed,this)})},createPassiveUploadForm:function(){return new SYNO.SDS.Utils.FormPanel({itemId:"upload_passive",fileUpload:!0,trackResetOnLoad:!0,frame:!1,border:!1,padding:"0px",webapi:{api:"SYNO.Core.Upgrade.Patch",method:"upload",version:1},items:[{xtype:"textfield",name:"target",value:"passive",hidden:!0},{xtype:"syno_filebutton",fieldLabel:_T("update","patch_for_passive"),id:this.passiveFileButtonID=Ext.id(),name:"file"}],onApiSuccess:Ext.createDelegate(this.onPassiveUploadSuccess,this),onApiFailure:Ext.createDelegate(this.onUploadFailed,this)})},onSubmit:function(){var e=this.get("upload_main"),t=this.get("upload_passive");this.validFileName(e.getForm().findField("file"))&&(Ext.isDefined(t)&&!this.validFileName(t.getForm().findField("file"))||(this.setStatusBusy({text:_T("update","update_uploading")}),e.upload()))},validFileName:function(e){if(!e)return!1;if(!e.isDirty())return this.getMsgBox().alert(_T("tree","leaf_update"),_T("error","error_nochoosefile")),!1;var t=e.getValue();return".pat"==t.substr(t.length-4,4)||(this.getMsgBox().alert(_T("tree","leaf_update"),_T("update","error_filename")),!1)},onMainUploadSuccess:function(e,t,i){var s=this,n=this.get("upload_passive");s.activePatchInfo=t,s.isHybridHA()?n.upload():(s.clearStatusBusy(),s.readyForUpgrade())},onPassiveUploadSuccess:function(e,t,i){var s=this;s.passivePatchInfo=t,s.clearStatusBusy(),s.readyForUpgrade()},getMergedInfo:function(){return this.activePatchInfo&&this.passivePatchInfo&&("dsm"===this.passivePatchInfo.upgradetype&&(this.activePatchInfo.reboot="now",this.activePatchInfo.restart_all=!1,this.activePatchInfo.restart_some=!1),"smallupdate"===this.passivePatchInfo.upgradetype&&(this.activePatchInfo.upgradetype="smallupdate")),this.activePatchInfo},onUploadFailed:function(e,t,i){var s=this;s.clearStatusBusy(),s.getMsgBox().alert(_T("tree","leaf_update"),SYNO.API.getErrorString(t.code),(function(){s.close()}))},readyForUpgrade:function(){var e=this;e.uploadInfo=e.getMergedInfo(),e.close()},getPathInfo:function(){return this.uploadInfo},isPatchReady:function(){return!Ext.isEmpty(this.uploadInfo)}}),Ext.ns("SYNO.SDS.AdminCenter.Update"),Ext.define("SYNO.SDS.AdminCenter.Update.NotificationSettingDisplayField",{extend:"SYNO.ux.DisplayField",xtype:"admincenter_update_notificationsettingdisplayfield",htmlEncode:!1,value:'<span class="note-font">'+_T("common","note")+": </span>"+String.format(_T("update","autoupdate_time_notify_notice"),'<a class="link-font" href="#">'+_T("controlpanel","leaf_notification")+"</a>"),initEvents:function(){this.callParent(arguments),this.addEvents("navigate_to_notification_page")},afterRender:function(){this.callParent(arguments);var e=this.el.first("a");this.mon(e,"click",(function(e){this.fireEvent("navigate_to_notification_page",this)}),this)}}),Ext.define("SYNO.SDS.AdminCenter.Update.Seperator",{extend:"SYNO.ux.CompositeField",xtype:"admincenter_update_seperator",width:16,items:[{xtype:"box",width:1},{xtype:"syno_displayfield",value:":"}]}),Ext.define("SYNO.SDS.AdminCenter.Update.ScheduleField",{extend:"SYNO.ux.CompositeField",xtype:"admincenter_update_schedulefield",items:[{xtype:"syno_panel",padding:0,items:[{xtype:"syno_schedulefield",ref:"../../weekDayField",width:295,allowBlank:!1,editable:!1},{xtype:"syno_panel",padding:"4px 0 0 0",layout:"hbox",items:[{xtype:"syno_combobox",ref:"../../../hourField",width:80,store:SYNO.SDS.Utils.createTimeItemStore("hour"),displayField:"display",valueField:"value"},{xtype:"admincenter_update_seperator"},{xtype:"syno_combobox",ref:"../../../minuteField",width:80,store:SYNO.SDS.Utils.createTimeItemStore("min"),displayField:"display",valueField:"value"}]}]}],setValue:function(e){this.weekDayField.setValue(e.week_day),this.hourField.setValue(e.hour),this.minuteField.setValue(e.minute)},getValue:function(){return{week_day:this.weekDayField.getValue(),hour:this.hourField.getValue(),minute:this.minuteField.getValue()}},isDirty:function(){return!!Ext.isDefined(this.originalValue)&&!(this.originalValue.week_day===this.weekDayField.getValue()&&this.originalValue.hour===this.hourField.getValue()&&this.originalValue.minute===this.minuteField.getValue())}}),Ext.define("SYNO.SDS.AdminCenter.Update.RadioGroup",{extend:"SYNO.ux.RadioGroup",xtype:"admincenter_update_radiogroup",isDirty:function(){return!!Ext.isDefined(this.originalValue)&&(null===this.originalValue&&null!==this.getValue()||(null!==this.originalValue||null!==this.getValue())&&this.originalValue.value!==this.getValue().value)}}),Ext.define("SYNO.SDS.AdminCenter.Update.SettingForm",{extend:"SYNO.ux.FormPanel",initComponent:function(){this.items=[{xtype:"syno_displayfield",value:_T("update","setting_option_type_desc")},{xtype:"admincenter_update_radiogroup",name:"updateBehaviour",columns:1,vertical:!0,items:[{name:"update_behaviour",inputValue:"autoInstallSecurity",boxLabel:String.format(_T("update","setting_option_type_auto_install_security"),"","")},{name:"update_behaviour",inputValue:"autoInstall",boxLabel:_T("update","setting_option_type_auto_install")},{name:"update_behaviour",inputValue:"notifyOnly",boxLabel:_T("update","setting_option_type_notify_me"),checked:!0}]},{xtype:"admincenter_update_schedulefield",name:"updateSchedule",cls:"schedule-field",fieldLabel:_T("update","setting_checking_schedule")}],this.callParent(arguments)},initEvents:function(){this.callParent(arguments),this.addEvents(["loadsuccess","savesuccess","loadfailed","savefailed"])},loadData:function(){this.getUpgradeSetting(function(e){this.applyUpgradeSetting(e),this.fireEvent("loadsuccess",this)}.bind(this),function(e){this.fireEvent("loadfailed",this,SYNO.API.getErrorString(e.status))}.bind(this))},saveData:function(){var e=this.form.getFieldValues(),t=e.updateBehaviour.value;switch(t){case"autoInstallSecurity":t="hotfix-security";break;case"notifyOnly":t="notify";break;case"autoInstall":t="hotfix"}this.setUpgradeSetting(t,e.updateSchedule,function(){this.fireEvent("savesuccess",this)}.bind(this),function(e){this.fireEvent("savefailed",this,SYNO.API.getErrorString(e.status))}.bind(this))},applyUpgradeSetting:function(e){var t="";switch(e.autoupdate_type){case"hotfix-security":t="autoInstallSecurity";break;case"hotfix":t="autoInstall";break;case"notify":t="notifyOnly";break;default:t=""}this.form.setValues({updateBehaviour:t,updateSchedule:e.schedule}),this.clearDirty()},getUpgradeSetting:function(e,t){this.sendWebAPI({api:"SYNO.Core.Upgrade.Setting",method:"get",version:4,callback:function(i,s,n){i?e(s,n):t(s,n)}})},setUpgradeSetting:function(e,t,i,s){var n={autoupdate_type:e,schedule:t};this.sendWebAPI({api:"SYNO.Core.Upgrade.Setting",method:"set",version:4,params:n,callback:function(e,t,n){e?i(t,n):s(t,n)}})},clearDirty:function(){this.items.each((function(e){e.originalValue=e.getValue()}))}}),Ext.define("SYNO.SDS.AdminCenter.Update.SettingDialog",{extend:"SYNO.SDS.ModalWindow",title:_T("update","update_adv_setting"),layout:"fit",resizable:!1,confirmedToClose:!1,constructor:function(e){var t=Ext.create({xtype:"container",items:[new SYNO.SDS.AdminCenter.Update.SettingForm({ref:"../formPanel",autoHeight:!0,padding:0}),{xtype:"admincenter_update_notificationsettingdisplayfield",ref:"../notificationDisplayField"}]}),i=Ext.apply({width:580,autoHeight:!0,padding:"16px 20px 12px 20px",closable:!0,buttons:[{xtype:"syno_button",btnStyle:"grey",text:_T("common","cancel"),handler:()=>this.cancelAndExit()},{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),handler:()=>this.saveAndExit()}],items:[t]},e);this.callParent([i])},initEvents:function(){this.callParent(arguments),this.addEvents(["navigate_to_notification_page","setting_save"]),this.mon(this.notificationDisplayField,"navigate_to_notification_page",(function(){const e=function(){this.fireEvent("navigate_to_notification_page",this),this.closeWithoutConfirm()}.bind(this);this.formPanel.form.isDirty()?this.confirmLostChangePromise({save:()=>{this.saveAndExit(!0)},dontSave:()=>{e()},cancel:Ext.emptyFn},this):e()}),this)},afterRender:function(){this.callParent(arguments),this.setStatusBusy({text:_T("common","loading")}),this.mon(this.formPanel,"loadsuccess",(function(){this.clearStatusBusy()}),this,{single:!0}),this.mon(this.formPanel,"loadfailed",(function(e,t){this.clearStatusBusy(),this.setStatusError({text:t})}),this,{single:!0}),this.formPanel.loadData()},saveAndExit:function(e=!1){this.setStatusBusy({text:_T("common","saving")}),this.mon(this.formPanel,"savesuccess",(function(){this.fireEvent("setting_save",this),e&&this.fireEvent("navigate_to_notification_page",this),this.closeWithoutConfirm()}),this,{single:!0}),this.mon(this.formPanel,"savefailed",(function(e,t){this.clearStatusBusy(),this.setStatusError({text:t})}),this,{single:!0}),this.formPanel.saveData()},cancelAndExit:function(){this.close()},closeWithoutConfirm:function(){this.confirmedToClose=!0,this.close()},onClose:function(){return!!this.confirmedToClose||(!this.formPanel.form.isDirty()||(this.confirmLostChangePromise({save:this.saveAndExit,dontSave:this.closeWithoutConfirm,cancel:Ext.emptyFn},this),!1))}}),Ext.ns("SYNO.SDS.AdminCenter.Update"),Ext.define("SYNO.SDS.AdminCenter.Update.VersionIcon",{extend:"Ext.BoxComponent",xtype:"admincenter_update_version_icon",cls:"update-promotion-version-icon",versionClass:null,versionMajor:null,versionMinor:null,afterRender:function(){this.callParent(arguments),this.setVersion(this.versionMajor,this.versionMinor)},setVersion:function(e,t){var i="v"+e+t;this.el&&(this.el.removeClass(this.versionClass),this.el.addClass(i)),this.versionMajor=e,this.versionMinor=t,this.versionClass=i}}),Ext.define("SYNO.SDS.AdminCenter.Update.PromotionButton",{extend:"Ext.BoxComponent",xtype:"admincenter_update_promotion_button",tooltipType:"qtip",cls:"try-it-button",text:"",initComponent:function(){this.callParent(arguments),this.setText(this.text),this.addEvents(["click"])},afterRender:function(){this.callParent(arguments),this.on({enable:function(){this.el.removeClass("disabled")}.bind(this),disable:function(){this.el.addClass("disabled")}.bind(this)}),this.mon(this.el,"click",function(){this.disabled||this.fireEvent("click",this)}.bind(this))},setText:function(e){this.text=e,this.html=e,this.el&&this.el.update(e)},clearTip:function(){this.btnEl=this.el,SYNO.ux.Button.prototype.clearTip.apply(this)},setTooltip:function(e,t){this.btnEl=this.el,SYNO.ux.Button.prototype.setTooltip.apply(this,[e,t])}}),Ext.define("SYNO.SDS.AdminCenter.Update.ClickableLink",{extend:"SYNO.ux.DisplayField",xtype:"admincenter_update_clickable_link",cls:"clickable-link",htmlEncode:!1,setLink:function(e){var t=String.format('<a href="{0}" target="_">{1}</a>',e,_T("update","update_dsm_whats_new_with_question_mark"));this.setValue(t)}}),Ext.define("SYNO.SDS.AdminCenter.Update.PromotionPanel",{extend:"SYNO.ux.Panel",xtype:"admincenter_update_promotion_panel",cls:"update-promotion",layout:{type:"hbox",align:"middle"},initComponent:function(){this.items=[{xtype:"syno_panel",cls:"icon-section",items:[{xtype:"admincenter_update_version_icon",ref:"../versionIcon"},{xtype:"admincenter_update_clickable_link",ref:"../whatsNewLink"}]},{xtype:"syno_panel",cls:"desc-section",flex:1,autoHeight:!0,items:[{xtype:"syno_displayfield",cls:"promotion-info",ref:"../promotionDescDisplayField"},{xtype:"syno_panel",cls:"action-n-status",layout:"hbox",items:[{xtype:"admincenter_update_promotion_button",ref:"../../actionButton",disabled:!0,hidden:!0},{xtype:"syno_displayfield",cls:"action-status",ref:"../../actionStatus"}]}]}],this.callParent(arguments)},doLayout:function(){this.callParent(arguments),this.callParent(arguments)},initEvents:function(){this.callParent(arguments),this.addEvents(["action_button_click"]);var e=this;e.on({resize:function(){e.doLayout()},afterlayout:function(){var t=e.items.getRange().map((function(e){return e.getHeight()})).reduce((function(e,t){return Math.max(e,t)}));e.suspendEvents(),e.setHeight(t),e.resumeEvents()}}),this.mon(this.actionButton,"click",function(){this.fireEvent("action_button_click",this)}.bind(this))},setState:function(e){switch(e.type){case SYNO.SDS.AdminCenter.Update.UpdateState.SYSTEM_BUSY:case SYNO.SDS.AdminCenter.Update.UpdateState.CHECKING:this.hide();break;case SYNO.SDS.AdminCenter.Update.UpdateState.WAIT_FOR_WEBAPI_RESPONSE:this.show(),this.updateVersion(e.version),this.actionButton.setVisible(!0),this.actionButton.disable();break;case SYNO.SDS.AdminCenter.Update.UpdateState.READY_TO_DOWNLOAD:case SYNO.SDS.AdminCenter.Update.UpdateState.THE_OTHER_ONE_IS_DOWNLOADED:this.show(),this.updateVersion(e.version),this.actionButton.enable(),this.actionButton.setVisible(!0),this.actionButton.setText(_T("update","update_btn_download")),this.actionStatus.setValue();break;case SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOADING:this.show(),this.updateVersion(e.version),this.actionButton.enable(),this.actionButton.setVisible(!0),this.actionButton.setText(_T("common","cancel")),this.actionStatus.setValue(this.progressString(e.progress));break;case SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOADED:this.show(),this.updateVersion(e.version),this.actionButton.enable(),this.actionButton.setVisible(!0),this.actionButton.setText(_T("backup","upgrade")),this.actionStatus.setValue();break;case SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOAD_FAILED:this.show(),this.updateVersion(e.version),this.actionButton.enable(),this.actionButton.setVisible(!0),this.actionButton.setText(_T("update","update_btn_retry")),this.actionStatus.setValue(_T("update","update_dsm_download_err"));break;case SYNO.SDS.AdminCenter.Update.UpdateState.UPGRADING:case SYNO.SDS.AdminCenter.Update.UpdateState.THE_OTHER_ONE_IS_DOWNLOADING:this.show(),this.updateVersion(e.version),this.actionButton.disable(),this.actionButton.setVisible(!0),this.actionButton.setText(_T("update","update_btn_download")),this.actionStatus.setValue();break;default:SYNO.Debug("Unhandled promotion state: "+e.type),this.hide()}if(_S("ha_running")&&_S("is_hybrid_ha")){this.actionButton.setText(_T("update","update_btn_download")),this.actionButton.setTooltip(_TT("SYNO.SDS.HA.Instance","upgrade","hybrid_ha_not_support_auto_download")),this.actionButton.disable();var t=SYNO.SDS.AdminCenter.Update.UpdateState;[t.DOWNLOADING,t.DOWNLOADED,t.DOWNLOAD_FAILED,t.THE_OTHER_ONE_IS_DOWNLOADING].includes(e.type)&&SYNO.Debug.error("Unexpected state type in Hybrid HA")}this.doLayout()},updateVersion:function(e){try{var t=e.match(/^(.*) (\d+)\.(\d+)(?:\.(\d+))?-(\d+)(?: [uU]pdate (\d+))?$/);if(null===t)return void SYNO.Debug("Invalid version string: "+e);var i=t[1],s=Number(t[2]),n=Number(t[3]),o=Number(t[4]),a=Number(t[5]),r=Number(t[6]);this.updateWhatsNewLink(a,r),this.versionIcon.setVersion(s,n);var l=i+" "+s+"."+n+(o?"."+o:""),d=String.format(_T("update","promotion_desc"),l);this.promotionDescDisplayField.setValue(d)}catch(t){SYNO.Debug("trying to show promotion panel but error happends"),SYNO.Debug(t),SYNO.Debug("version argument:"),SYNO.Debug(e)}},updateWhatsNewLink:function(e,t){var i={model:_D("upnpmodelname"),type:"promotion",update_version:e+(t?"-"+t:"")},s=_D("rss_server").replace("genRSS","whatsnew")+"?"+Ext.urlEncode(i);this.whatsNewLink.setLink(s)},progressString:function(e){return _T("update","update_dsm_downloading")+" ("+Math.round(e)+"%)"},handleWebAPIError:function(e,t){SYNO.Debug.warn("failed to call WebAPI correctly: "+t),SYNO.Debug.warn("error code:"),SYNO.Debug.warn(e)}}),Ext.ns("SYNO.SDS.AdminCenter.Update"),Ext.define("SYNO.SDS.AdminCenter.Update.DialogTitle",{extend:"Ext.BoxComponent",xtype:"syno_update_reset_dialog_title",cls:"syno-update-reset-dialog-title",value:null,initComponent:function(){this.html=this.value,this.callParent(arguments)}}),Ext.ns("SYNO.SDS.AdminCenter.Update"),SYNO.SDS.AdminCenter.Update.SECONDS_REBOOT=600,Ext.define("SYNO.SDS.AdminCenter.Update.Term.TermPanel",{extend:SYNO.ux.Panel,constructor:function(e){Ext.apply(this,e);var t={items:this.createItems(),itemId:"term_panel",cls:"syno-update-term-field",width:680};this.callParent([Ext.apply(t,e)]),this.relayEvents(this.getCheckBox(),["check"])},createItems:function(){return[{xtype:"box",cls:"syno-update-term-title",itemId:"syno-update-term-title",html:this.title},{xtype:"container",itemId:"syno-update-term-container",items:[{xtype:"box",cls:"syno-update-term-subtitle",html:this.subTitle,height:48},new SYNO.ux.Panel({xtype:"box",cls:"syno-update-term-content",itemId:"syno-update-term-content",autoFlexcroll:!0,items:[{xtype:"box",cls:"syno-update-term-content-inner",itemId:"syno-update-term-content-inner",html:this.termContent}],height:260}),{xtype:"syno_checkbox",itemId:"syno-update-term-check",height:28,boxLabel:this.checkBoxMsg}]}]},isAgree:function(){return this.getCheckBox().getValue()},getCheckBox:function(){return this.getComponent("syno-update-term-container").getComponent("syno-update-term-check")}}),Ext.define("SYNO.SDS.AdminCenter.Update.TermDialogBase",{extend:SYNO.SDS.ModalWindow,constructor:function(e){this.closeByPressingOK=!1,this.termPanel=e.termPanel;var t={width:720,height:500,resizable:!1,autoFlexcroll:!0,buttonAlign:"center",cls:"syno-update-term",itemId:"syno-update-term",items:[e.termPanel],title:_T("tree","leaf_update"),fbar:this.createFootBar()};this.callParent([Ext.apply(t,e)]),this.bindTermEvents()},createFootBar:function(){var e=new Ext.Toolbar({items:[{xtype:"syno_button",itemId:"agree-button",cls:"syno-update-term-btn",text:_T("common","ok"),btnStyle:"blue",scope:this,disabled:!0,handler:this.onClickOk}]});return this.btnOk=e.getComponent("agree-button"),e},bindTermEvents:function(){this.mon(this.termPanel,"check",(function(e,t){var i=!this.termPanel.isAgree();this.btnOk.setDisabled(i)}),this,{delay:10}),this.mon(this,"close",(function(){this.closeByPressingOK||this.onDisAgree()}),this)},onClickOk:function(){this.closeByPressingOK=!0,this.onAgree(),this.close()},onAgree:function(){SYNO.Debug.info("please override this function to handle agree event")},onDisAgree:function(){SYNO.Debug.info("please override this function to handle disagree event")}}),Ext.define("SYNO.SDS.AdminCenter.Update.TermOfServiceDialog",{extend:SYNO.SDS.AdminCenter.Update.TermDialogBase,constructor:function(e,t,i){var s={termPanel:new SYNO.SDS.AdminCenter.Update.Term.TermPanel({title:_T("update","termofservice_title"),subTitle:_T("update","termofservice_subtitle"),termContent:e.termContent,checkBoxMsg:_T("update","termofservice_confirm")})};this.onOk=t,this.onCancel=i,this.callParent([Ext.apply(s,e)])},onAgree:function(){Ext.isFunction(this.onOk)&&this.onOk()},onDisAgree:function(){Ext.isFunction(this.onCancel)&&this.onCancel()}}),Ext.define("SYNO.SDS.AdminCenter.Update.UpdateService",{statics:{startDownload:function(e,t,i){SYNO.API.Request({api:"SYNO.Core.Upgrade.Server.Download",method:"start",version:2,params:{target:e},callback:function(e,s,n){e?t(s):i(s)}})},cancelDownload:function(e,t){SYNO.API.Request({api:"SYNO.Core.Upgrade.Server.Download",method:"cancel",version:1,callback:function(i,s,n){i?e(s):t(s)}})}}}),Ext.define("SYNO.SDS.AdminCenter.Update.UpdateState",{statics:{CHECKING:"checking",NO_UPDATE:"no_update",WAIT_FOR_WEBAPI_RESPONSE:"wait_for_webapi_response",READY_TO_DOWNLOAD:"ready_to_download",DOWNLOADING:"downloading",DOWNLOADED:"downloaded",DOWNLOAD_FAILED:"download_failed",THE_OTHER_ONE_IS_DOWNLOADING:"other_is_downloading",THE_OTHER_ONE_IS_DOWNLOADED:"other_is_downloaded",UPGRADING:"upgrading",SYSTEM_BUSY:"systemBusy"}}),Ext.define("SYNO.SDS.AdminCenter.Update.UpdateStore",{extend:"Ext.Component",statics:{PROMOTION_PANEL:"promotion",UPDATE_PANEL:"update"},subscribe:function(e){this.mon(this,"update",e)},getUpdateState:function(){},getPromotionState:function(){if(!this.state||Ext.isEmpty(this.promotionVersion))return{type:SYNO.SDS.AdminCenter.Update.UpdateState.CHECKING};if(this.isWaitingForWebAPIResponse)return{type:SYNO.SDS.AdminCenter.Update.UpdateState.WAIT_FOR_WEBAPI_RESPONSE,version:this.promotionVersion};if("upgrading"===this.state)return{type:SYNO.SDS.AdminCenter.Update.UpdateState.UPGRADING};if("system_busy"===this.state)return{type:SYNO.SDS.AdminCenter.Update.UpdateState.SYSTEM_BUSY};switch(this.target){case SYNO.SDS.AdminCenter.Update.UpdateStore.PROMOTION_PANEL:return this.getState(this.promotionVersion);case SYNO.SDS.AdminCenter.Update.UpdateStore.UPDATE_PANEL:switch(this.state){case"downloading":return{type:SYNO.SDS.AdminCenter.Update.UpdateState.THE_OTHER_ONE_IS_DOWNLOADING,version:this.promotionVersion,otherVersion:this.updateVersion};case"ready_upgrade":case"downloaded":return{type:SYNO.SDS.AdminCenter.Update.UpdateState.THE_OTHER_ONE_IS_DOWNLOADED,version:this.promotionVersion,otherVersion:this.updateVersion}}}return this.promotionDownloadFailed?{type:SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOAD_FAILED,version:this.promotionVersion}:{type:SYNO.SDS.AdminCenter.Update.UpdateState.READY_TO_DOWNLOAD,version:this.promotionVersion}},updateStateWithTarget:function(e,t){return this.state=e,this.target=t,this.fireEvent("update",this),this},updateCurrentVersion:function(e){return this.currentVersion=e,this.fireEvent("update",this),this},updateUpdateVersion:function(e){return this.updateVersion=e,this.fireEvent("update",this),this},updatePromotionVersion:function(e){return this.promotionVersion=e,this.fireEvent("update",this),this},setDownloadFailed:function(e){switch(e){case SYNO.SDS.AdminCenter.Update.UpdateStore.UPDATE_PANEL:this.updateDownloadFailed=!0,this.promotionDownloadFailed=!1;break;case SYNO.SDS.AdminCenter.Update.UpdateStore.PROMOTION_PANEL:this.updateDownloadFailed=!1,this.promotionDownloadFailed=!0;break;default:return this}return this.fireEvent("update",this),this},clearDownloadFailed:function(e){switch(e){case SYNO.SDS.AdminCenter.Update.UpdateStore.UPDATE_PANEL:this.updateDownloadFailed=!1;break;case SYNO.SDS.AdminCenter.Update.UpdateStore.PROMOTION_PANEL:this.promotionDownloadFailed=!1;break;default:return this}return this.fireEvent("update",this),this},updateDownloadProgress:function(e){return this.progress=e,this.fireEvent("update",this),this},updatePatchInfo:function(e){return this.patchInfo=e,this.fireEvent("update",this),this},updateWaitForWebAPIResponse:function(e){return this.isWaitingForWebAPIResponse=e,this.fireEvent("update",this),this},getState:function(e){switch(this.state){case"none":default:return{type:SYNO.SDS.AdminCenter.Update.UpdateState.READY_TO_DOWNLOAD,version:e};case"downloading":return{type:SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOADING,progress:this.progress,version:e};case"ready_upgrade":return{type:SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOADED,patchInfo:this.patchInfo,version:e};case"upgrading":return{type:SYNO.SDS.AdminCenter.Update.UpdateState.UPGRADING,version:e}}},state:void 0,currentVersion:void 0,updateVersion:void 0,updateDownloadFailed:!1,promotionVersion:void 0,promotionDownloadFailed:!1,isWaitingForWebAPIResponse:!1,target:void 0,progress:0,patchInfo:void 0}),Ext.define("SYNO.SDS.AdminCenter.Update.UpdateTab",{extend:"SYNO.SDS.Utils.FormPanel",overallPollingInterval:2,mainModel:"DSM",passiveModel:"DSM",cls:"syno-update-reset-update-tab",updateStore:void 0,constructor:function(e){this.updateStore=new SYNO.SDS.AdminCenter.Update.UpdateStore,this.overAllStatus=null,this.lastDSMInfo=null,Ext.isDefined(SYNO.API.GetKnownAPI("SYNO.Virtualization.Cluster"))?this.sendWebAPI({api:"SYNO.Virtualization.Cluster",method:"check_exist",version:1,scope:this,callback:function(e,t,i){this.cluster_exist=!!e&&t.exist}}):this.cluster_exist=!1,this.module=e.module;var t=this.fillConfig(e);this.callParent([t]),this.setStatusBar(this.highlightText(_T("update","check_new_dsm"),"green"))},getDSMUpdateItems:function(e){var t=e?"../":"";return[{xtype:"syno_displayfield",value:_T("update","update_desc1")},{xtype:"syno_displayfield",cls:SYNO.SDS.Utils.SelectableCLS,fieldLabel:_T("common","ds_model"),name:"model"},{xtype:"syno_displayfield",cls:SYNO.SDS.Utils.SelectableCLS,fieldLabel:_T("update","update_version"),htmlEncode:!1,name:"firmware_ver"},{xtype:"syno_displayfield",fieldLabel:_T("tcpip","wimax_status"),ref:t+"statusBar",htmlEncode:!1,value:this.highlightText(_T("update","check_new_dsm"),"green")},{xtype:"syno_compositefield",width:575,items:[{xtype:"syno_button",text:_T("update","update_btn_download"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):_S("ha_running")&&_S("is_hybrid_ha")?_TT("SYNO.SDS.HA.Instance","upgrade","hybrid_ha_not_support_auto_download"):"",id:this._downloadBtnID,scope:this},{xtype:"syno_displayfield",id:this._downloadMsgID,htmlEncode:!1,value:""}]},{xtype:"box",height:"5px"},{xtype:"panel",cls:"function-buttons",layout:"column",border:!1,padding:0,itemId:"buttons",items:[{xtype:"syno_button",tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",disabled:_S("demo_mode"),text:_T("update","update_dsm_manually"),scope:this,ref:t+"../upload_btn",handler:this.openUploadDialog},{xtype:"box",height:"10px",width:"10px"},{xtype:"syno_button",text:_T("update","update_adv_setting"),scope:this,disabled:this.isHybridHA(),handler:this.preOpenSettingDialog,tooltip:this.isHybridHA()?_TT("SYNO.SDS.HA.Instance","upgrade","hybrid_ha_not_support_auto_download_and_install"):""}]},{xtype:"admincenter_update_promotion_panel",ref:t+"promotionPanel",hidden:!0}]},isHybridHA:function(){return!(!_S("ha_running")||!_S("is_hybrid_ha"))},getDSMUpdateItemsWithFieldSet:function(){return this.getDSMUpdateItems(!0)},getSASExpFWUpdateItems:function(){return[{xtype:"syno_displayfield",htmlEncode:!1,value:_T("update","exp_fw_ctrl_panel_update_desc")},{xtype:"syno_displayfield",fieldLabel:_T("tcpip","wimax_status"),htmlEncode:!1,itemId:"sas_exp_fw_staus",value:this.highlightText(_T("update","exp_fw_ctrl_panel_up_to_date_desc"),"green")},{xtype:"syno_displayfield",id:this._sasExpListDisplayId,htmlEncode:!1,hidden:!0,style:"margin-left: 185px",value:""},{xtype:"syno_button",id:this._sasExpFwUpdBtnId,text:"",hidden:!0,style:"margin-left: 185px",scope:this}]},supportExpansionUnitsUpdate:function(){return"yes"===_D("supportsas","no")&&"yes"!==_D("disable_sas_exp_fw_upd","no")},fillConfig:function(e){var t,i;this._downloadBtnID=Ext.id(),this._downloadMsgID=Ext.id(),this._sasExpListDisplayId=Ext.id(),this._sasExpFwUpdBtnId=Ext.id(),this.supportExpansionUnitsUpdate()?(t=_T("tree","leaf_3update"),i={xtype:"syno_fieldset",itemId:"dsm_upd_fieldset",title:_T("tree","leaf_update"),items:this.getDSMUpdateItemsWithFieldSet()}):(t=_T("tree","leaf_update"),i=this.getDSMUpdateItems());var s={title:t,itemId:"UpdateTab",autoScroll:!0,items:[i,{xtype:"syno_fieldset",itemId:"sas_exp_fw_upd_fieldset",title:_T("update","exp_fw_ctrl_panel_update_fieldset"),items:this.getSASExpFWUpdateItems(),hidden:!this.supportExpansionUnitsUpdate()}],listeners:{afterrender:function(){var t=e.module.appWin,i=[];t.setStatusBusy();const s=SYNO.API.GetKnownAPI("SYNO.Core.System");var n=s.maxVersion>=2?"firmware":"overview",o={api:"SYNO.Core.System",method:"info",version:s.maxVersion,params:{type:n},scope:this};i.push(o);var a={api:"SYNO.SHA.Panel.Overview",version:1,method:"load",scope:this};_S("ha_running")&&_S("is_hybrid_ha")&&i.push(a);var r={api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_update_list_get":"exp_fw_update_list_get",version:1,params:{},scope:this};this.supportExpansionUnitsUpdate()&&i.push(r);var l={api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_fail_get":"exp_fw_fail_get",version:1,params:{},scope:this};this.supportExpansionUnitsUpdate()&&i.push(l);var d={api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_update_status_get":"exp_fw_update_status_get",version:1,params:{},scope:this};this.supportExpansionUnitsUpdate()&&i.push(d);var c={api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_is_exp_connected":"is_exp_connected",version:1,params:{},scope:this};this.supportExpansionUnitsUpdate()&&i.push(c),this.sendWebAPI({compound:{stopwhenerror:!1,mode:"parallel",params:i},scope:this,callback:function(e,i,s,n){t.clearStatus(),e&&i&&i.result&&Ext.each(i.result,(function(e){if(e&&e.api&&e.success&&e.data)if(!0===SYNO.ux.Utils.checkApiConsistency(o,e)){var t=e.data;this.getForm().findField("model").setValue(Ext.isDefined(t.model_customized)?t.model_customized:t.model),this.updateStore.updateCurrentVersion(t.firmware_ver),this.enableCurrentVersionFieldTooltip(!1)}else if(!0===SYNO.ux.Utils.checkApiConsistency(a,e)){var i=e.data,s=String(i.lnode.model),n=String(i.rnode.model),h="active"===i.lnode.role;this.mainModel=h?s:n,this.passiveModel=h?n:s}else!0===SYNO.ux.Utils.checkApiConsistency(r,e)?0!==e.data.enclosures.length&&this.sasFwUpdNeedUpdateStatusRender(e.data.enclosures):!0===SYNO.ux.Utils.checkApiConsistency(l,e)?0!==e.data.enclosures.length&&this.sasFwUpdFailListStatusRender(e.data.enclosures):!0===SYNO.ux.Utils.checkApiConsistency(d,e)?!0!==e.data.finished&&this.startSASExpFwUpdPollingProgress(this):!0===SYNO.ux.Utils.checkApiConsistency(c,e)&&!0!==e.data.has_enc_exp&&(this.getForm().findField("sas_exp_fw_staus").setValue(_T("update","no_expansion_connected")),Ext.getCmp(this._sasExpListDisplayId).hide(),Ext.getCmp(this._sasExpFwUpdBtnId).hide())}),this)}})},scope:this}};return Ext.apply(s,e),s},handlePromotionButtonClick:function(e){var t=SYNO.SDS.AdminCenter.Update.UpdateService,i=e.getPromotionState(),s=function(){e.updateWaitForWebAPIResponse(!0),this.getDownloadBtn().disable(),this.getPatchUploadBtn().disable();var i="promotion";t.startDownload(i,function(){this.isDestroyed||this.startDownloadPolling("promotion")}.bind(this),function(){this.isDestroyed||(e.setDownloadFailed(i).updateWaitForWebAPIResponse(!1),this.updateOverallStatus())}.bind(this))}.bind(this);switch(i.type){case SYNO.SDS.AdminCenter.Update.UpdateState.READY_TO_DOWNLOAD:case SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOAD_FAILED:s();break;case SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOADED:this.precheckUpgrade("server",i.patchInfo);break;case SYNO.SDS.AdminCenter.Update.UpdateState.DOWNLOADING:this.updateStore.updateWaitForWebAPIResponse(!0),this.getDownloadBtn().disable(),this.getPatchUploadBtn().disable(),t.cancelDownload(function(){this.isDestroyed||this.updateOverallStatus()}.bind(this),function(t){SYNO.Debug("Canceling promotion download failed:"),SYNO.Debug(t),this.isDestroyed||(e.updateWaitForWebAPIResponse(!1),this.updateOverallStatus())}.bind(this));break;case SYNO.SDS.AdminCenter.Update.UpdateState.THE_OTHER_ONE_IS_DOWNLOADED:this.showReplaceConfirmMsgBox(e.promotionVersion,e.updateVersion,s);break;default:SYNO.Debug("state: "+i.type+" has no handler")}},initEvents:function(){var e=this;e.callParent(arguments),e.mon(e.ownerCt,"activate",e.startOverallStatusPolling,e),e.mon(e,"activate",e.startOverallStatusPolling,e),e.mon(e.ownerCt,"deactivate",e.stopOverallStatusPolling,e),e.mon(e,"deactivate",e.stopOverallStatusPolling,e),e.updateStore.subscribe((function(t){e.promotionPanel.setState(t.getPromotionState())})),e.mon(e.promotionPanel,{action_button_click:function(){e.handlePromotionButtonClick(e.updateStore)}})},checkGlusterUpgradable:function(e,t,i){var s=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.CMS.Info","get");if(s&&"no"===_D("gfssupportmanupdate","no")&&!0===s.joined&&s.additional&&0<s.additional.gluster_role){var n=_TT("SYNO.SDS.GlusterfsMgmt.Instance","cms","upgrade_dsm_cms_only");this.getForm().getEl().parent().mask(n,"syno-ux-mask-info")}},processParams:function(e,t){return t=(t=this.callParent(arguments)).concat([{api:"SYNO.Core.CMS.Info",method:"get",version:1,params:{additional:["gluster_role"]}}])},processReturnData:function(e,t,i){this.callParent(arguments),this.CheckLastDSMInfo(!1),this.checkGlusterUpgradable(e,t)},highlightText:function(e,t){return"green"===t||"red"===t||"blue"===t?String.format('<font class="{0}-status">{1}</font>',t,e):String.format('<font color="{0}">{1}</font>',t,e)},openUploadDialog:function(){var e=this,t=new SYNO.SDS.AdminCenter.Update.UploadDialog({owner:e.module.appWin,module:e.module,updateTab:e,mainModel:this.mainModel,passiveModel:this.passiveModel});e.mon(t,"close",(function(t){t.isPatchReady()&&e.precheckUpgrade("patch",t.getPathInfo())}),e,{single:!0}),t.open()},preOpenSettingDialog:async function(){this.sendWebAPI({api:"SYNO.Core.Upgrade.AutoUpgrade",method:"status",version:1,scope:this,callback:async function(e,t,i,s){e&&t&&t.autoupdate_status&&"preparing"===t.autoupdate_status&&await this.module.appWin.getMsgBox().confirm(_T("update","autoupdate_title"),_T("update","autoupdate_cancel_confirm_text")).then((e=>this.cancelAutoUpdate(e))),this.openSettingDialog()}})},cancelAutoUpdate:async function(e){if("confirm"!==e)return;let t=_T("update","autoupdate_cancel_failed");await SYNO.API.RequestPromise({api:"SYNO.Core.Upgrade.AutoUpgrade",method:"cancel",version:1}).then((()=>{t=_T("update","autoupdate_cancel_success")})).catch((e=>{t=SYNO.API.getErrorString(e.code)})),await this.findAppWindow().getMsgBox().alert(_T("update","autoupdate_title"),t)},openSettingDialog:function(){var e=new SYNO.SDS.AdminCenter.Update.SettingDialog({owner:this.module.appWin});this.mon(e,"navigate_to_notification_page",(function(){this.module.app.startModule("SYNO.SDS.AdminCenter.Notification.Main")}),this,{single:!0}),this.mon(e,"setting_save",(function(){this.cleanOverallStatus(),this.CheckLastDSMInfo(!0)}),this,{single:!0}),e.open()},CheckLastDSMInfo:function(e){var t=this;(Ext.isEmpty(t.lastDSMInfo)||e)&&(t.lastDSMInfo=null,t.setStatusBar(t.highlightText(_T("update","check_new_dsm"),"green")),t.dsmInfoReq=t.sendWebAPI({compound:{stopwhenerror:!0,params:[{api:"SYNO.Core.Upgrade.Server",method:"check",params:{user_reading:!0,need_auto_smallupdate:!0,need_promotion:!0},version:3},{api:"SYNO.Core.Upgrade.Server.Download",version:2,method:"progress",params:{need_download_target:!0}},{api:"SYNO.Core.Upgrade.Setting",version:1,method:"get"}]},scope:t,callback:function(e,i,s){if(!this.isDestroyed){if(!e||i.has_fail)return t.lastDSMInfo={check_success:!1},void t.updateFailStatus();var n=i.result[0].data.promotion,o=n&&n.version,a=i.result[0].data.update,r=i.result[1].data,l=i.result[2].data,d=a&&a.version;t.lastDSMInfo=a,t.lastDSMInfo.check_success=!0,t.lastDSMInfo.upgrade_type=l.upgrade_type,t.updateStore.updatePromotionVersion(o).updateUpdateVersion(d);var c=r.target;"failed"===r.status?t.updateStore.setDownloadFailed(c):t.updateStore.clearDownloadFailed(c),t.updateOverallStatus()}}}))},getStatusBar:function(){return this.statusBar},getDownloadBtn:function(){return Ext.getCmp(this._downloadBtnID)},getPatchUploadBtn:function(){return this.upload_btn},getDownloadMsgField:function(){return Ext.getCmp(this._downloadMsgID)},enableCurrentVersionFieldTooltip:function(e){var t=this.updateStore.currentVersion;if(t){var i=this.getForm().findField("firmware_ver"),s=String.format("{0} ({1})",t,this.getWhatsNew(t,_T("update","update_dsm_release_note")));if(e){i.setValue(s+"<span class=tooltip><span class=tooltip-anchor></span></span>");var n=i.el?i.el.query(".tooltip-anchor")[0]:null;n&&SYNO.ux.AddTip(n,_T("update","status_latest_version_desc"))}else i.setValue(s)}},setStatusBar:function(e,t,i){var s=this.getStatusBar();if(s.setValue(e+"<span class=tooltip><span class=tooltip-anchor></span></span>"),Ext.isDefined(i)){var n=s.el?s.el.query(".tooltip-anchor")[0]:null;n&&SYNO.ux.AddTip(n,i)}this.updateDownloadMsg(t),this.updateDownloadBtn(t),this.doLayout()},updateDownloadMsg:function(e){var t=this.getDownloadMsgField();e&&e.desc?t.setValue(e.desc):t.setValue("")},updateDownloadBtn:function(e){var t=this.getDownloadBtn();Ext.isDefined(e)?(t.show(),_S("ha_running")&&_S("is_hybrid_ha")||_S("demo_mode")?t.disable():t.enable(),t.setText(e.text),Ext.isEmpty(t.click_callback)||this.mun(t,"click",t.click_callback,this),t.click_callback=function(t){e.callback(t)}.bind(this),this.mon(t,"click",t.click_callback,this)):t.hide()},openConfirmDialog:function(e,t,i,s,n){let o=this,a=new SYNO.SDS.AdminCenter.Update.UpdateTab.ConfirmDialog({owner:o.module.appWin,module:o.module,displayMsg:t,leadingNote:i,checkType:e});o.mon(a,"close",(function(e){e.getIsNext()?s():o.cancelUpgrade(n)}),o,{single:!0}),o.module.appWin.openExtWindow(a)},ShowEulaBeforeUpgrade:function(e){const t=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.Upgrade.PreCheck","start");if(t&&t.eulacheck&&t.eulacheck_content){const e=this;return new Promise(((i,s)=>{new SYNO.SDS.AdminCenter.Update.TermOfServiceDialog({owner:e.module.appWin,termContent:t.eulacheck_content},i,s).show()}))}return Promise.resolve()},ShowWarningBeforeUpgrade:function(e,t,i,s,n){var o,a,r=this,l="",d="",c=_T("update","update_confirm_upgrade_none"),h=!1,u=!1,p=!1,_=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Upgrade","status"),m=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Upgrade.PreCheck","start"),f=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Upgrade","check_having_upgradeable_drives");if(_&&"hard"===_.check_type){const e=_.poweroff?_.poweroff.check_msg.map((e=>SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))):[],t=_.upgrade?_.upgrade.check_msg.map((e=>SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))):[];return SYNO.SDS.WindowMgr.getMsgBox(SYNO.SDS.SystemFeasibilityWindow,{actionStrs:[...e,...t],desc:_T("update","update_alert_hardcheck")}).alert(_T("update","update_alert_hardcheck_title")),void r.cancelUpgrade(i)}const S=this.cluster_exist?20:10;if("smallupdate"===s.upgradetype)if("now"===s.reboot||f)c=String.format(_T("update","update_confirm_upgrade_reboot_now"),S,2*S),u=!0;else if(s.restart_all)c=_T("update","update_confirm_upgrade_restart_all");else if(s.restart_some){let e=s.restart_servs||[],t=s.restart_pkgs||[];e=e.map((e=>_T(e.section,e.key)||e.key)),c=_T("update","update_confirm_upgrade_restart_some"),c+="<br/>"+e.concat(t).join(", ")}else c=_T("update","update_confirm_upgrade_none");else c=String.format(_T("update","update_confirm_upgrade"),S,2*S),u=!0;if(m){if(!(t&&t.result&&t.result.some((e=>e&&"SYNO.Core.Upgrade.PreCheck"===e.api&&"start"===e.method&&e.success))))return g=_T("tree","leaf_update"),y=SYNO.API.getErrorString(m.code),SYNO.SDS.WindowMgr.getMsgBox(void 0,{maskContainer:!1,width:480}).alert(g,y),void r.cancelUpgrade(i);if(m.precheck&&m.precheck_info){if(!0!==m.precheck_info.can_continue&&m.precheck_info.message)return l=m.precheck_info.message+"<br>",d=m.precheck_info.leading_note,void r.openConfirmDialog("hardCheckFailed",l,d,a,i);!0===m.precheck_info.can_continue&&m.precheck_info.message&&(h=!0,l=m.precheck_info.message+"<br>",d=m.precheck_info.leading_note)}}var g,y;const b=[];if(_&&"soft"===_.check_type){const e=_.poweroff?_.poweroff.check_msg.map((e=>SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))):[],t=_.upgrade?_.upgrade.check_msg.map((e=>SYNO.SDS.Utils.GetFeasibilityCheckMsg(e))):[];b.push(...e,...t)}if(_S("ha_running")){var v=SYNO.API.Response.GetValByAPI(t,"SYNO.SHA.Upgrade","need_show_progress_ui");if(p=v.success&&v.need_show_progress_ui,u&&p){var x=SYNO.API.Response.GetValByAPI(t,"SYNO.SHA.Upgrade","get_keep_role"),w=SYNO.API.Response.GetValByAPI(t,"SYNO.SHA.Panel.Overview","load"),T="unknown";w.success&&x.success&&!x.keep_role&&(T="passive"===w.lnode.role?w.lnode.hostname:w.rnode.hostname,c+=String.format('{0} <span class="note-font">{1}</span> : {2}',_.upgrade?"<br>":"<br><br>",_T("common","note"),String.format(_TT("SYNO.SDS.HA.Instance","upgrade","notice_role_change"),T)))}}o=function(e){"confirm"===e?r.performUpgrade(i,s):r.cancelUpgrade(i)},a=async function(){const e=await n.getMsgBox().confirm(_T("tree","leaf_update"),c);o(e)},0===b.length?h?r.openConfirmDialog("softCheckFailed",l,d,a,i):a():SYNO.SDS.WindowMgr.getMsgBox(SYNO.SDS.SystemFeasibilityWindow,{actionStrs:b,desc:_T("update","update_confirm_softcheck")}).confirm(_T("update","update_confirm_softcheck_title")).then((e=>{"confirm"===e?h?r.openConfirmDialog("softCheckFailed",l,d,a,i):a():r.cancelUpgrade(i)}))},startOverallStatusPolling:function(){var e=this;Ext.isEmpty(e.overallstatus_pollId)&&(e.overallstatus_pollId=this.pollReg({webapi:{api:"SYNO.Core.Upgrade",version:1,method:"basic_status"},interval:this.overallPollingInterval,immediate:!0,status_callback:function(t,i){if(!e.isDestroyed)if(t){if(e.updateStore.updateStateWithTarget(i.status,i.target).updatePatchInfo(i.patch_info),"promotion"===i.target)switch(i.status){case"downloading":i.status="promotion_is_downloading";break;case"ready_upgrade":i.status="promotion_is_downloaded"}e.overAllStatus&&(e.overAllStatus.status!==i.status||e.overAllStatus.target!==i.target)&&e.updateStore.updateWaitForWebAPIResponse(!1),e.overAllStatus=i,e.updateOverallStatus()}else e.updateFailStatus()}}))},stopOverallStatusPolling:function(){var e=this;Ext.isEmpty(e.overallstatus_pollId)||(e.pollUnreg(e.overallstatus_pollId),e.overallstatus_pollId=null)},cleanOverallStatus:function(){this.overAllStatus=null},updateOverallStatus:function(){var e=this,t=e.getUpdateVersion(),i=e.overAllStatus,s=e.getPatchUploadBtn(),n=e.getDownloadBtn();if(!Ext.isEmpty(i)){if(e.updateStore.isWaitingForWebAPIResponse)return s.disable(),void n.disable();switch(i.allow_upgrade&&!_S("demo_mode")?s.enable():s.disable(),SYNO.SDS.Utils.isInC2DSM()&&s.setVisible(!1),this.enableCurrentVersionFieldTooltip(!this.hasUpdate()),i.status){case"none":e.updateOverAllNone();break;case"downloading":null!==t&&e.startDownloadPolling("update",t);break;case"ready_upgrade":null!==t&&e.updateOverAllReadyUpgrade(t);break;case"upgrading":e.setStatusBar(e.highlightText(_T("update","dsm_busy_updating"),"red"));break;case"system_busy":e.updateOverAllSystemBusy(i);break;case"promotion_is_downloading":e.startDownloadPolling("promotion",t),e.updateOverAllNone(),n.disable(),s.disable();break;case"promotion_is_downloaded":if(e.updateOverAllNone(),n.enable(),s.enable(),null===t)break;e.setStatusBar(e.getDownloadStatusText("update_dsm_download",t),{text:_T("update","update_btn_download"),callback:function(i){var s=e.updateStore;s.promotionVersion?e.showReplaceConfirmMsgBox(s.updateVersion,s.promotionVersion,(function(){e.startDownload(i,t)})):e.startDownload(i,t)}},_T("update","status_update_available_desc"))}}},getUpdateVersion:function(){return Ext.isEmpty(this.lastDSMInfo)?null:Ext.isDefined(this.lastDSMInfo.autosmallupdate_version)?this.lastDSMInfo.autosmallupdate_version:Ext.isDefined(this.lastDSMInfo.version)?this.lastDSMInfo.version:null},renderRSSResult:function(e){switch(e){case"license_expired":this.setStatusBar(this.highlightText(_T("update","license_expire_err"),"red"));break;case"server_error":this.setStatusBar(this.highlightText(_T("update","check_new_dsm_err"),"red"));break;case"server_maintenance":this.setStatusBar(this.highlightText(_T("update","update_dsm_no_new_dsm"),"green"));break;case"internal_error":this.setStatusBar(this.highlightText(_T("update","internal_err"),"red"));break;default:this.setStatusBar(this.highlightText(_T("update","unknown_err"),"red"))}},updateOverAllNone:function(){var e=this,t=e.lastDSMInfo;Ext.isEmpty(t)||(!1!==t.check_success?"success"===t.rss_result?!1!==t.available?e.updateStore.updateDownloadFailed?e.setStatusBar(e.getDownloadStatusText("update_dsm_download",t.version),{text:_T("update","update_btn_retry"),callback:function(i){e.startDownload(i,t.version)},desc:_T("update","update_dsm_download_err")},_T("update","status_update_available_desc")):e.setStatusBar(e.getDownloadStatusText("update_dsm_download",t.version),{text:_T("update","update_btn_download"),callback:function(i){e.startDownload(i,t.version)}},_T("update","status_update_available_desc")):e.setStatusBar(e.highlightText(_T("update","update_dsm_no_new_dsm"),"green")):e.renderRSSResult(t.rss_result):e.updateFailStatus())},updateOverAllReadyUpgrade:function(e){var t=this;t.StopDownloadPolling(),t.setStatusBar(t.getDownloadStatusText("update_dsm_upgrade",e),{text:_T("update","update_btn_upgrade"),callback:function(){t.precheckUpgrade("server",t.overAllStatus.patch_info)}},_T("update","status_update_available_desc"))},updateOverAllSystemBusy:function(e){var t,i=this;"no enough volume space."===e.reason?(t="yes"===_D("supportraid","no")?String.format(_T("update","update_error_no_root"),'<a class="link-font" href="https://kb.synology.com/DSM/tutorial/DSM_update_insufficient_system_capacity_for_update" target="_blank">',"</a>"):String.format(_T("update","update_error_no_vol"),e.require_volume_size),i.setStatusBar(i.highlightText(t,"red"))):i.setStatusBar(i.highlightText(_T("error","error_system_busy"),"red"))},startDownload:function(e,t){var i=this,s=i.getPatchUploadBtn();e.disable(),s.disable(),i.updateStore.updateWaitForWebAPIResponse(!0),i.sendWebAPI({api:"SYNO.Core.Upgrade.Server.Download",method:"start",version:2,params:{target:"update",need_auto_smallupdate:!0},callback:function(e,s,n,o){i.isDestroyed||(e?i.startDownloadPolling("update",t):i.updateStore.setDownloadFailed("update"))}})},startDownloadPolling:function(e,t){var i=this;i.isDestroyed||Ext.isEmpty(i.download_pollId)&&(i.updateStore.updateDownloadProgress(0),i.download_pollId=this.pollReg({webapi:{api:"SYNO.Core.Upgrade.Server.Download",version:2,method:"progress",params:{need_download_target:!0}},interval:5,immediate:!0,status_callback:function(s,n){if(!i.isDestroyed){if(!s)return i.StopDownloadPolling(),void i.updateStore.setDownloadFailed(e);var o=n.status,a=n.target,r=n.percent;i.updateDownloadProgress(a,o,r,t)}}}))},StopDownloadPolling:function(){var e=this;Ext.isEmpty(e.download_pollId)||(e.pollUnreg(e.download_pollId),e.download_pollId=null)},updateDownloadProgress:function(e,t,i,s){switch("failed"===t?this.updateStore.setDownloadFailed(e):this.updateStore.clearDownloadFailed(e),t){case"downloading":this.updateStore.updateDownloadProgress(i),"update"===e&&this.updateDownloadingStatus(s,i);break;case"failed":this.StopDownloadPolling(),this.updateStore.updateWaitForWebAPIResponse(!1).setDownloadFailed(e),this.updateOverallStatus();break;case"finished":case"stopped":this.StopDownloadPolling();break;case"none":break;default:SYNO.Debug("Skip unknown download status: "+t)}},getDownloadStatusText:function(e,t){var i=String.format(_T("update",e),t);return String.format("{0} ({1})",this.highlightText(i,"green"),this.getWhatsNew(t,_T("update","update_dsm_release_note")))},getWhatsNew:function(e,t){var i,s,n,o=this.getForm();if(!e)return"";if(2>(s=e.split(" ")).length)return"";if(2>(i=s[1].split("-")).length)return"";n=i[1],4==s.length&&(n+="-"+s[3]);return function(e){var i={href:_SYNOINFODEF.rss_server.replace("genRSS","whatsnew")+"?"+Ext.urlEncode(e),target:"blank",text:t};return String.format("<a{0}{1}>{2}</a>",Ext.isDefined(i.href)?' href="'+i.href+'"':"",Ext.isDefined(i.target)?' target="_'+i.target+'"':"",i.text)}({model:o.findField("model").getValue(),update_version:n})},updateFailStatus:function(){this.setStatusBar(this.highlightText(_T("update","check_new_dsm_err"),"red"))},updateDownloadingStatus:function(e,t){if(null!==e){var i=this,s=String.format("{0} ({1}%)",_T("update","update_dsm_downloading"),t);i.setStatusBar(i.getDownloadStatusText("update_dsm_download",e),{text:_T("common","cancel"),callback:function(e){i.StopDownloadPolling(),e.disable(),i.sendWebAPI({api:"SYNO.Core.Upgrade.Server.Download",method:"cancel",version:1,params:{},callback:function(t,s,n,o){t?i.StopDownloadPolling():e.enable()}})},desc:this.highlightText(s,"#78828c")},_T("update","status_update_available_desc"))}},updateFailedStatus:function(e){this.StopDownloadPolling(),this.updateOverallStatus()},precheckUpgrade:function(e,t){var i=this,s=i.module.appWin,n=[];n.push({api:"SYNO.Core.Upgrade",version:1,method:"status",params:{feasibility_check:!0}}),n.push({api:"SYNO.Core.Upgrade",method:"check_having_upgradeable_drives",version:1,params:{upgrade_to:{base:t.buildnumber,nano:t.smallfixnumber}}}),"dsm"===t.upgradetype&&n.push({api:"SYNO.Core.Upgrade.PreCheck",method:"start",version:2,params:{lang:_S("lang"),type:e}}),_S("ha_running")&&(n.push({api:"SYNO.SHA.Upgrade",version:1,method:"get_keep_role"}),n.push({api:"SYNO.SHA.Upgrade",version:1,method:"need_show_progress_ui"}),n.push({api:"SYNO.SHA.Panel.Overview",version:1,method:"load"})),(async()=>{try{s.setStatusBusy(),i.stopOverallStatusPolling();const o=await synowebapi.promises.request({compound:{stopwhenerror:!1,mode:"parallel",params:n}}).finally((()=>{i.startOverallStatusPolling(),s.clearStatus()}));await i.ShowEulaBeforeUpgrade(o),i.ShowWarningBeforeUpgrade(!0,o,e,t,s)}catch(e){}})()},cancelUpgrade:function(e){SYNO.WebRTC&&SYNO.WebRTC.Resume(),SYNO.SDS.Desktop.hotkeyPlugin.setHotkeySuspended(!1),"patch"===e&&(this.sendWebAPI({api:"SYNO.Core.Upgrade.Patch",method:"clean",version:1}),_S("ha_running")&&this.sendWebAPI({api:"SYNO.SHA.Util",method:"send_remote_webapi",version:1,params:{remote_api:"SYNO.Core.Upgrade.Patch",remote_method:"clean",remote_version:1}}),this.Reload())},performUpgrade:function(e,t){SYNO.WebRTC&&SYNO.WebRTC.Pause(),SYNO.SDS.Desktop.hotkeyPlugin.setHotkeySuspended(!0);var i=this,s=i.module.appWin;i.module.appWin.setStatusBusy(),i.stopOverallStatusPolling(),SYNO.API.RequestPromise({api:"SYNO.Core.Upgrade",method:"start",version:1,params:{force:!0,type:e}}).then((()=>{SYNO.SDS.StatusNotifier.fireEvent("halt"),SYNO.SDS.AppLaunch("SYNO.SDS.App.DesktopProgress.Instance",{},!0,(e=>{e.$root.startHandlingUpdateProgress(t)}))}),(t=>{i.startOverallStatusPolling(),i.module.appWin.clearStatus(),i.cancelUpgrade(e),s.getMsgBox().alert(_T("tree","leaf_update"),SYNO.API.getErrorString(t.code))}))},Reload:function(){var e=this;e.overAllStatus=null,e.lastDSMInfo=null,e.module.activate(),e.startOverallStatusPolling()},sasFwUpdNeedUpdateStatusRender:function(e){this.getForm().findField("sas_exp_fw_staus").setValue(this.highlightText(_T("update","exp_fw_ctrl_panel_need_update_desc"),"green")),Ext.getCmp(this._sasExpListDisplayId).setValue(String.format(_T("update","exp_fw_ctrl_panel_update_model_desc"),e)),Ext.getCmp(this._sasExpListDisplayId).show(),Ext.getCmp(this._sasExpFwUpdBtnId).setText(_T("update","update_btn_upgrade")),Ext.getCmp(this._sasExpFwUpdBtnId).setHandler(this.sasFwUpdHandler,this),Ext.getCmp(this._sasExpFwUpdBtnId).show(),Ext.getCmp(this._sasExpFwUpdBtnId).enable()},sasFwUpdFailListStatusRender:function(e){this.getForm().findField("sas_exp_fw_staus").setValue(this.highlightText(_T("update","exp_fw_ctrl_panel_update_failed_desc"),"red")),Ext.getCmp(this._sasExpListDisplayId).setValue(String.format(_T("update","exp_fw_critical_update_failed_model_desc"),e)),Ext.getCmp(this._sasExpListDisplayId).show(),Ext.getCmp(this._sasExpFwUpdBtnId).setText(_T("support_center","support_form")),Ext.getCmp(this._sasExpFwUpdBtnId).setHandler(this.sasFwUpdFailHandler,this),Ext.getCmp(this._sasExpFwUpdBtnId).show(),Ext.getCmp(this._sasExpFwUpdBtnId).enable()},sasFwUpdIsUpToDateStatusRender:function(){this.getForm().findField("sas_exp_fw_staus").setValue(this.highlightText(_T("update","exp_fw_ctrl_panel_up_to_date_desc"),"green")),Ext.getCmp(this._sasExpListDisplayId).hide(),Ext.getCmp(this._sasExpFwUpdBtnId).hide()},sasFwUpdHandler:function(){var e=this;e.sendWebAPI({api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_update_list_get":"exp_fw_update_list_get",version:1,params:{},scope:e,callback:function(t,i){t&&0!==i.enclosures.length&&0!==i.update_sec&&(e.updateMins=Math.ceil(i.update_sec/60),e.module.appWin.getMsgBox().confirm("",String.format(_T("update","exp_fw_ctrl_panel_update_window_desc"),e.updateMins)).then((t=>{"confirm"===t&&(e.startSASExpFwUpdate(),e.module.appWin.setStatusBusy())})))}})},startSASExpFwUpdate:function(){this.sendWebAPI({api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_update":"exp_fw_update",version:1,params:{},scope:this,callback:function(e,t){this.module.appWin.clearStatus(),e?(SYNO.SDS.App.SASExpFwUpdateApp.SASFwUpdProgressBar.startFWUpdProgress(this.owner,this.updateMins),this.startSASExpFwUpdPollingProgress()):504==t.code?this.module.appWin.getMsgBox().alert("",_T("update","exp_fw_upd_already_in_progress")):this.module.appWin.getMsgBox().alert("",_T("common","error_system"))}})},startSASExpFwUpdPollingProgress:function(){var e=this;Ext.getCmp(e._sasExpFwUpdBtnId).disable(),e.SASExpFwUpdPollingId=e.pollReg({webapi:{api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_update_status_get":"exp_fw_update_status_get",version:1,params:{}},interval:5,immediate:!0,scope:e,status_callback:function(t,i,s,n){var o="",a=[];if(!t){e.pollUnreg(e.SASExpFwUpdPollingId),e.SASExpFwUpdPollingId=void 0;var r={api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_update_list_get":"exp_fw_update_list_get",version:1,params:{},scope:e};a.push(r);var l={api:"SYNO.Storage.CGI.Enclosure",method:_S("ha_running")?"sha_exp_fw_fail_get":"exp_fw_fail_get",version:1,params:{},scope:e};return a.push(l),e.sendWebAPI({compound:{stopwhenerror:!1,mode:"parallel",params:a},scope:e,callback:function(t,i,s,n){t&&i&&i.result&&Ext.each(i.result,(function(t){t&&t.api&&t.success&&t.data&&(!0===SYNO.ux.Utils.checkApiConsistency(r,t)?0!==t.data.enclosures.length&&e.sasFwUpdNeedUpdateStatusRender(t.data.enclosures):!0===SYNO.ux.Utils.checkApiConsistency(l,t)&&0!==t.data.enclosures.length&&e.sasFwUpdFailListStatusRender(t.data.enclosures))}),e)}}),!1}if(i.finished)return e.pollUnreg(e.SASExpFwUpdPollingId),e.SASExpFwUpdPollingId=void 0,e.sasFwUpdIsUpToDateStatusRender(),!1;o=String.format("{0}%",Math.floor(100*i.progress)),e.getForm().findField("sas_exp_fw_staus").setValue(e.highlightText(String.format("{0} ...({1})",_T("update","exp_fw_ctrl_panel_updating_desc"),o),"blue"))}})},sasFwUpdFailHandler:function(){SYNO.SDS.AppLaunch("SYNO.SDS.SupportForm.Application",{extra:{pkg_id:"SASExpFWUpdate"}})},showReplaceConfirmMsgBox:function(e,t,i){var s=function(e){return"<b>"+e+"</b>"},n=String.format(_T("update","download_replace_info"),s(e),s(t))+"<br>"+_T("update","download_replace_question");this.findAppWindow().getMsgBox().confirm("",n).then((e=>{"confirm"===e&&i()}))},hasUpdate:function(){return null!==this.getUpdateVersion()}}),Ext.define("SYNO.SDS.AdminCenter.Update.UpdateTab.ConfirmDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.isNext=!1;const{displayMsg:t,leadingNote:i,checkType:s}=e,n=[{xtype:"syno_displayfield",cls:"dialog-precheck-msg",htmlEncode:!1,value:t}],o=[];"softCheckFailed"===s?(n.push({xtype:"syno_checkbox",itemId:"confirmChechbox",htmlEncode:!1,boxLabel:String.format('<span class="red-status" style="word-break: break-word;">{0}</span>',_T("update","update_confirm_continue")),listeners:{check:{fn:function(e,t){this.getFooterToolbar().getComponent("nextBtn").setDisabled(!t)},scope:this}}}),o.push([{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:function(){this.isNext=!1,this.close()}},{xtype:"syno_button",text:_T("backup","addon_update"),itemId:"nextBtn",btnStyle:"blue",disabled:!0,tooltip:_T("update","please_click_checkbox_desc"),scope:this,handler:function(){this.isNext=!0,this.close()}}])):o.push({xtype:"syno_button",text:_T("common","ok"),itemId:"nextBtn",btnStyle:"blue",scope:this,handler:function(){this.isNext=!1,this.close()}}),this.displayFieldWithWrapper=new SYNO.ux.Panel({autoFlexcroll:!0,items:n});let a=Ext.apply({cls:"syno-admin-center-confirm-dialog x-window-dlg",closable:!1,draggable:!1,elements:"body",resizable:!1,width:600,autoHeight:!0,fbar:o,items:[{xtype:"syno_update_reset_dialog_title",value:_T("update","update_notice_title")},{xtype:"syno_displayfield",cls:"dialog-precheck-msg",htmlEncode:!1,value:i},this.displayFieldWithWrapper],listeners:{scope:this,afterrender:{fn:function(){const e=this.displayFieldWithWrapper.getHeight(),t=this.getHeight(),i=t-e;t>=480?this.displayFieldWithWrapper.setHeight(480-i):t<280?this.displayFieldWithWrapper.setHeight(280-i):this.displayFieldWithWrapper.setHeight(e)}}}},e);this.callParent([a])},getIsNext:function(){return this.isNext}}),Ext.define("SYNO.SDS.AdminCenter.Config.TypeStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t={fileUpload:!0,trackResetOnLoad:!0,frame:!1,webapi:{api:"SYNO.Backup.Config.Restore",method:"upload",version:1},items:[{xtype:"syno_displayfield",value:_T("confbackup","select_restore_config_source")},{xtype:"syno_radio",boxLabel:_T("confbackup","restore_from_synoaccount"),name:"restore_type",checked:!0,inputValue:"cloud"},{xtype:"syno_displayfield",value:_T("confbackup","restore_from_synoaccount_desc"),indent:1},{xtype:"syno_radio",boxLabel:_T("confbackup","restore_from_local_upload"),name:"restore_type",inputValue:"local"},{xtype:"syno_filebutton",fieldLabel:_T("itunes","itunes_path"),name:"dss_file",indent:1}],onApiSuccess:Ext.createDelegate(this.onUploadSuccess,this),onApiFailure:Ext.createDelegate(this.onUploadFailed,this)};Ext.apply(t,e),this.callParent([t])},activate:function(){this.isActivated||(new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"restore_type",{local:["dss_file"]}),this.isActivated=!0)},getNext:function(){var e=this.getForm();if(!e.isValid())return!1;if("local"===e.findField("restore_type").getGroupValue()){var t=e.findField("dss_file").getValue();if(Ext.isEmpty(t))return this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),_T("confbackup","please_select_dss")),!1;if(!this.validFileName(t))return!1;this.setStatusBusy({text:_T("confbackup","uploading")}),this.upload()}else"cloud"===e.findField("restore_type").getGroupValue()&&this.checkSynoAccountLogin();return!1},checkSynoAccountLogin:function(){if(this.myDSAccount)return void this.owner.goNext(this.nextId.cloud);const e={yes:{text:_T("common","login")},no:{text:_T("common","cancel")}};this.owner.getMsgBox().confirm("",_T("confbackup","login_synoaccount_enable_restore"),(function(e){if("yes"===e){this.owner.configTab.openSynoAccountLogin(this.owner,(function(e,t){this.owner.clearStatusBusy(),this.owner.updateGlobalEvent("syno_account",e),this.owner.goNext(this.nextId.cloud)}),this)}}),this,e)},validFileName:function(e){return".dss"===e.substr(e.length-4,4)||(this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),_T("confbackup","error_filename")),!1)},onUploadSuccess:function(e,t,i){this.owner.clearStatusBusy(),this.owner.updateGlobalEvent("dsm_task_id",t.dss_id),this.owner.updateGlobalEvent("dss_version",t.dss_version),this.owner.getStep(this.nextId.local).reload(),this.owner.goNext(this.nextId.local)},onUploadFailed:function(e,t,i){this.owner.clearStatusBusy(),this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(t))},observerUpdate:function(e,t){"syno_account"===e&&(this.myDSAccount=t)}}),Ext.define("SYNO.SDS.AdminCenter.Config.VersionlistPanel",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.owner=e.owner,this.module=e.module;var t={cls:"version-list-panel",store:this.getStore(),colModel:this.getColumnModel(),sm:new Ext.grid.RowSelectionModel({singleSelect:!0,listeners:{beforerowselect:function(e,t,i,s,n){return!s.get("error")}}}),enableHdMenu:!1,bbar:this.pagingBar=new SYNO.ux.PagingToolbar({store:this.getStore(),pageSize:100,displayInfo:!0,showRefreshBtn:!0}),viewConfig:{getRowClass:function(e,t,i,s){if(e.get("error"))return"versionstep-disabled-row"}}};Ext.apply(t,e),this.callParent([t])},getStore:function(){return this.store||(this.store=new SYNO.API.Store({api:"SYNO.Backup.Config.AutoBackup",version:1,method:"list",appWindow:this.module.appWin,autoLoad:!1,hasMultiSort:!0,multiSortInfo:{sorters:[{field:"error",direction:"ASC"},{field:"backup_time",direction:"DESC"}]},sortInfo:{field:"backup_time",direction:"DESC"},reader:new Ext.data.JsonReader({idProperty:"name",root:"versions",totalProperty:"total",fields:[{name:"name",mapping:"name"},{name:"host",mapping:"host"},{name:"model",mapping:"model"},{name:"serial",mapping:"serial"},{name:"dsm_version",mapping:"dsm_version"},{name:"checksum",mapping:"checksum"},{name:"backup_time",mapping:"backup_time",convert:function(e,t){return SYNO.SDS.DateTimeFormatter(new Date(e))}},{name:"error",mapping:"error",sortType:function(e){return e?1:0}}]}),baseParams:{offset:0,limit:100},listeners:{scope:this,beforeload:function(){this.owner.setStatusBusy()},load:function(e,t){this.owner.clearStatusBusy(),0===t.length?(this.bwrap.mask(_T("confbackup","no_dss_version"),"syno-ux-mask-info"),this.owner.getButton("next").disable()):(this.bwrap.unmask(),this.owner.getButton("next").enable(),this.getStore().multiSort(this.getStore().multiSortInfo.sorters))},exception:function(e,t,i,s,n,o){this.owner.clearStatusBusy(),this.getStore().removeAll(),this.owner.getButton("next").disable(),this.owner.getMsgBox().alert("",SYNO.SDS.ConfigBackup.getErrorString(n))}}})),this.store},getColumnModel:function(){var e=function(e,t,i,s,n,o){return i.get("error")?t.attr=String.format('ext:qtip="{0}"',SYNO.SDS.ConfigBackup.getErrorString(i.get("error"))):t.attr=String.format('ext:qtip="{0}"',e),e};return new Ext.grid.ColumnModel([{header:_T("tcpip","server_name"),tooltip:_T("tcpip","server_name"),dataIndex:"host",sortable:!0,renderer:function(e,t,i,s,n,o){return i.get("error")?t.attr=String.format('ext:qtip="{0}"',SYNO.SDS.ConfigBackup.getErrorString(i.get("error"))):t.attr=String.format('ext:qtip="{0}: {1}<br>{2}: {3}"',_T("tcpip","server_name"),e,_T("confbackup","model_name"),i.get("model")),e}},{header:_T("confbackup","serial_number"),tooltip:_T("confbackup","serial_number"),dataIndex:"serial",sortable:!0,renderer:e},{header:_T("localbkpwizard","localbkp_time"),tooltip:_T("localbkpwizard","localbkp_time"),dataIndex:"backup_time",sortable:!0,renderer:e},{header:_T("confbackup","dsm_version"),tooltip:_T("confbackup","dsm_version"),dataIndex:"dsm_version",sortable:!0,renderer:e}])}}),Ext.define("SYNO.SDS.AdminCenter.Config.VersionStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t={layout:"fit",items:[new SYNO.ux.Panel({height:320,itemId:"version_panel",cls:"version-list-panel-wrapper",items:[new SYNO.SDS.AdminCenter.Config.VersionlistPanel({height:320,itemId:"version_grid_panel",owner:e.owner,module:e.module})]})]};Ext.apply(t,e),this.callParent([t])},activate:function(){var e=this.getComponent("version_panel").getComponent("version_grid_panel").pagingBar;if(0===e.getWidth()){var t=this.getComponent("version_panel").getComponent("version_grid_panel").getWidth();e.container.setWidth(t),e.setWidth(t),this.doLayout()}this.getComponent("version_panel").getComponent("version_grid_panel").getStore().load()},getNext:function(){var e=this.getComponent("version_panel").getComponent("version_grid_panel").getSelectionModel().getSelected();return e?(this.owner.setStatusBusy(),this.sendWebAPI({api:"SYNO.Backup.Config.AutoBackup",method:"get_meta",version:1,params:{dss_name:e.get("name")},scope:this,callback:function(t,i,s,n){if(!t)return this.owner.clearStatusBusy(),void this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(i));"manual"===i.enc_type?(this.owner.clearStatusBusy(),this.owner.updateGlobalEvent("dss_name",e.get("name")),this.owner.updateGlobalEvent("checksum",e.get("checksum")),this.owner.goNext(this.nextId.manual)):"auto"===i.enc_type?this.sendWebAPI({api:"SYNO.Backup.Config.AutoBackup",method:"restore",version:1,params:{dss_name:e.get("name"),checksum:e.get("checksum")},scope:this,callback:function(e,t,i,s){this.owner.clearStatusBusy(),e?(this.owner.updateGlobalEvent("dsm_task_id",t.dsm_task_id),this.owner.updateGlobalEvent("dss_version",t.dss_version),this.owner.getStep(this.nextId.auto).reload(),this.owner.goNext(this.nextId.auto)):this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(t))}}):this.owner.clearStatusBusy()}}),!1):(this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),_T("confbackup","select_one_version")),!1)}}),Ext.define("SYNO.SDS.AdminCenter.Config.PasswordStep",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t={cls:"password-enckey-panel",fileUpload:!0,trackResetOnLoad:!0,frame:!1,webapi:{api:"SYNO.Backup.Config.AutoBackup",method:"upload_private_key",version:1,scope:this},items:[{xtype:"syno_displayfield",value:_T("confbackup","password_input_title")},{xtype:"container",layout:"column",hideLabel:!0,cls:"password-row",items:[{xtype:"syno_radio",name:"decrypt_method",inputValue:"password",boxLabel:_T("common","password"),width:200,checked:!0},{xtype:"syno_textfield",itemId:"pwd",textType:"password",allowBlank:!1,minLength:8,maxLength:64}]},{xtype:"container",layout:"column",hideLabel:!0,cls:"enckey-row",items:[{xtype:"syno_radio",name:"decrypt_method",inputValue:"prikey_file",boxLabel:_T("share","share_encryption_key"),width:200,check:!1},{xtype:"syno_filebutton",name:"private_key"}]}],onApiSuccess:Ext.createDelegate(this.onPrikeyUploadSuccess,this),onApiFailure:Ext.createDelegate(this.onPrikeyUploadFailed,this)};Ext.apply(t,e),this.callParent([t])},activate:function(){this.isActivated||(new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"decrypt_method",{password:["pwd"],prikey_file:["private_key"]}),this.isActivated=!0)},getNext:function(){var e=this.getForm();if(!e.isValid())return!1;if("prikey_file"===e.findField("decrypt_method").getGroupValue())return Ext.isEmpty(e.findField("private_key").getValue())?(this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),_T("confbackup","please_select_enckey")),!1):(this.upload(),!1);var t=e.findField("pwd").getValue();return this.owner.setStatusBusy(),this.sendWebAPI({api:"SYNO.Backup.Config.AutoBackup",method:"restore",version:1,params:{pwd:t,dss_name:this.dssName,checksum:this.checksum},encryption:["pwd"],scope:this,callback:function(t,i,s,n){if(this.owner.clearStatusBusy(),t)this.owner.updateGlobalEvent("dsm_task_id",i.dsm_task_id),this.owner.updateGlobalEvent("dss_version",i.dss_version),this.owner.getStep(this.nextId).reload(),this.owner.goNext(this.nextId);else{var o=i&&i.code;this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(i),(function(){SYNO.SDS.ConfigBackup.ERR_AUTOCONF_PASSWORD_INVALID===o&&e.findField("pwd").markInvalid(_T("confbackup","invalid_password"))}))}}}),!1},onPrikeyUploadSuccess:function(e,t,i){this.owner.setStatusBusy(),this.sendWebAPI({api:"SYNO.Backup.Config.AutoBackup",method:"restore",version:1,params:{prikey_session_id:t.prikey_session_id,dss_name:this.dssName,checksum:this.checksum},scope:this,callback:function(e,t,i,s){this.owner.clearStatusBusy(),e?(this.owner.updateGlobalEvent("dsm_task_id",t.dsm_task_id),this.owner.updateGlobalEvent("dss_version",t.dss_version),this.owner.getStep(this.nextId).reload(),this.owner.goNext(this.nextId)):this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(t))}})},onPrikeyUploadFailed:function(e,t,i){this.owner.clearStatusBusy(),this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.API.getErrorString(t.code))},observerUpdate:function(e,t){"dss_name"===e?this.dssName=t:"checksum"===e&&(this.checksum=t)}}),Ext.define("SYNO.SDS.AdminCenter.Config.RestoreDetailStep",{extend:"SYNO.ux.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module,this.checkBox=new SYNO.ux.Checkbox({boxLabel:_T("confbackup","bkp_overwrite"),itemCls:"overwrite-checkbox"});var t=Ext.apply({cls:"restore-detail-step",items:[this.createTreePanel(),this.checkBox]},e);this.callParent([t])},setDsmTaskId:function(e){this.dsmTaskId=e,this.treePanel.dss_id=e},getDsmTaskId:function(){return this.dsmTaskId},setDssVersion:function(e){this.treePanel.dss_version=e},reload:function(){this.treePanel.root.reload()},createTreePanel:function(){this.treePanel=new SYNO.SDS.ConfigBackup.Restore.ConfigTreePanel({dsm_version:_S("version"),loader:new SYNO.SDS.ConfigBackup.TreeLoader,rootVisible:!0,height:293});var e=new SYNO.SDS.ConfigBackup.TreeLoader({sendWebAPI:this.treePanel.sendWebAPI.createDelegate(this.treePanel),webapi:{api:"SYNO.Backup.Config.Restore",method:"list",version:2},parseWebApiResponse:function(e,t){return t.config_info_list},createNodeFn:this.treePanel.createConfigNodeFn,createNodeScope:this});e.on("beforeload",(function(e,t,i){this.owner.setStatusBusy(),e.baseParams.dss_id=this.getDsmTaskId(),e.baseParams.is_show_shared_folder=!0}),this),e.on("loadexception",(function(e,t,i){this.owner.clearStatusBusy(),this.owner.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(i),(function(){this.owner.close()}))}),this),e.on("load",(function(e,t,i){this.owner.clearStatusBusy()}),this);var t=_T("confbackup","confbkp_all"),i=new Ext.tree.AsyncTreeNode({expanded:!1,hidden:""===t,id:"config_root",allowDrop:!1,text:t,qtip:t,leaf:!1,checked:!1,loader:e,uiProvider:SYNO.SDS.ConfigBackup.TriTreeNodeUI});return this.treePanel.setRootNode(i),this.treePanel},isOverwrite:function(){return this.checkBox.getValue()},isRestoreConfig:function(){return this.treePanel.isRestoreConfig()},observerUpdate:function(e,t){"dsm_task_id"===e?this.setDsmTaskId(t):this.setDssVersion(t)}}),Ext.define("SYNO.SDS.AdminCenter.Config.WizardBaseWindow",{extend:"SYNO.SDS.Wizard.ModalWindow",goNext:function(e,t){null!==e?this.callParent(arguments):this.doWizardCommit()},doWizardCommit:function(){}}),Ext.define("SYNO.SDS.AdminCenter.Config.RestoreWizard",{extend:"SYNO.SDS.AdminCenter.Config.WizardBaseWindow",globalEvent:{},constructor:function(e){var t={width:600,height:500,cls:"confautobkp-restore-wizard",title:_T("confbackup","restore_configuration"),steps:[new SYNO.SDS.AdminCenter.Config.TypeStep({headline:_T("confbackup","select_restore_source"),itemId:"type_step",owner:this,module:e.module,nextId:{cloud:"version_step",local:"restore_detail_step"}}),new SYNO.SDS.AdminCenter.Config.VersionStep({headline:_T("confbackup","select_restore_config_version"),itemId:"version_step",owner:this,module:e.module,nextId:{auto:"restore_detail_step",manual:"password_step"}}),new SYNO.SDS.AdminCenter.Config.PasswordStep({headline:_T("confbackup","decrypt_dss_title"),itemId:"password_step",owner:this,module:e.module,nextId:"restore_detail_step"}),new SYNO.SDS.AdminCenter.Config.RestoreDetailStep({headline:_T("confbackup","select_restore_items"),itemId:"restore_detail_step",owner:this,module:e.module,nextId:null})]};Ext.apply(t,e),this.callParent([t])},initEvents:function(){this.callParent(arguments),this.createGlobalEvent(),this.subscribe("type_step","syno_account"),this.subscribe("password_step","dss_name"),this.subscribe("password_step","checksum"),this.subscribe("restore_detail_step","dss_version"),this.subscribe("restore_detail_step","dsm_task_id"),this.updateGlobalEvent("syno_account",this.myDSAccount)},createGlobalEvent:function(){this.globalEvent={dss_name:{subscribers:[]},checksum:{subscribers:[]},dsm_task_id:{subscribers:[]},dss_version:{subscribers:[]},syno_account:{subscribers:[]}}},updateGlobalEvent:function(e,t){this.globalEvent.hasOwnProperty(e)?("syno_account"===e&&this.fireEvent("synoaccount_update",[t]),this.publish(e,t)):SYNO.Debug(String.format("event {0} does not exist",e))},subscribe:function(e,t){this.globalEvent[t].subscribers.push(e)},publish:function(e,t){var i=this.globalEvent[e].subscribers;Ext.each(i,(function(i){this.getStep(i).observerUpdate(e,t)}),this)},doWizardCommit:function(){var e=this.getStep("restore_detail_step");if(e.isRestoreConfig()){var t=e.getDsmTaskId(),i=e.isOverwrite(),s=e.treePanel.getRestoreServiceList();e.treePanel.checkUGConflict(i,this.readyForImport.createDelegate(this,[t,i,s]),this,!0)}else this.getMsgBox().alert(_T("tree","leaf_bkp"),_T("confbackup","confbkp_no_service_select"))},readyForImport:function(e,t,i){this.restoreParams={dss_id:e,overwrite:t,category_or_service_ids:i},this.close()},getRestoreParam:function(){return this.restoreParams},isRestoreParamReady:function(){return void 0!==this.restoreParams},onClose:function(){if(!this.isRestoreParamReady()){var e=this.getStep("restore_detail_step").getDsmTaskId();e&&this.sendWebAPI({api:"SYNO.Backup.Config.Restore",method:"delete",version:1,params:{dss_id:e}})}this.callParent(arguments)}}),SYNO.SDS.AdminCenter.Config.SetDesktop=function(e){SYNO.SDS.UserSettings.setProperty("Desktop","restoreParams",Ext.apply({className:"SYNO.SDS.AdminCenter.Application",params:{fn:"SYNO.SDS.AdminCenter.Update_Reset.Main",tab:"ConfigTab",task_id:e}}))},SYNO.SDS.AdminCenter.Config.RedirectUrl=function(e){if(Array.isArray(e)&&0!==e.length){var t=function(e){var t=String.format("{0}//{1}",window.location.protocol,e),i=new XMLHttpRequest;i.open("GET",String.format("{0}:{1}/webman/pingpong.cgi?action=cors",t,window.location.port)),i.onload=()=>{window.onbeforeunload=null,window.location=t},i.timeout=5e3,i.send()};this.intervals=[];for(var i=0;i<e.length;i++)this.intervals.push(window.setInterval(t.bind(this,e[i]),5e3))}else SYNO.Debug("Bad parameters")},Ext.define("SYNO.SDS.AdminCenter.Config.ConfigTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={title:_T("tree","leaf_bkp"),cls:"syno-update-reset-config-tab",itemId:"ConfigTab",useDefaultBtn:!0,webapi:{api:"SYNO.Backup.Config.AutoBackup",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_fieldset",title:_T("confbackup","autoconfbkp_title"),itemId:"autobackup_field",collapsible:!0,labelWidth:256,items:[{xtype:"syno_displayfield",value:_T("confbackup","autoconfbkp_desc")},{xtype:"syno_checkbox",name:"enable",boxLabel:_T("confbackup","enable_autoconfbkp"),scope:this,checked:!1,onClick:function(){var e=this.scope,t=!this.checked;const i={confirm:{text:_T("common","login")},cancel:{text:_T("common","cancel")}};!0!==t||e.myDSAccount?this.disabled||this.readOnly||this.setValue(t):e.module.appWin.getMsgBox().confirm("",_T("confbackup","login_synoaccount_enable_autobkp"),i).then((t=>{if("confirm"===t){e.openSynoAccountLogin(e.module.appWin,(function(t){e.module.appWin.clearStatus(),e.myDSAccount=t.account,this.setValue(!0)}),this)}else this.setValue(!1)}))},listeners:{check:function(e,t){var i=t&&"manual"===this.getForm().findField("enc_method").getGroupValue();this.enablePasswordField(i),this.setInstantBkpBtnStatus()},scope:this}},{xtype:"syno_displayfield",fieldLabel:_T("confbackup","backup_status"),indent:1,name:"backup_time_status",htmlEncode:!1,listeners:{render(){this.label.setWidth(228)}},isDirty:function(){return!1},reset:function(){return this.value}},{xtype:"syno_radio",name:"enc_method",disabled:!0,value:"auto",boxLabel:_T("confbackup","auto_enc"),indent:1,checked:!0},{xtype:"syno_radio",name:"enc_method",disabled:!0,value:"manual",boxLabel:_T("confbackup","self_enc"),indent:1,listeners:{check:function(e,t){var i=this.getForm().findField("enable").getValue();this.enablePasswordField(t&&i),this.showPasswordField(t),this.setInstantBkpBtnStatus(e.isDirty())},scope:this}},{xtype:"syno_passwordfield",fieldLabel:_T("common","password"),validationEvent:"blur",updateWhenRender:!1,enableKeyEvents:!0,disabled:!0,name:"pwd",value:"",indent:2,hidden:!0,allowBlank:!1,maxLength:64,minLength:8,labelWidth:256,listeners:{beforeshow(e){e.isDirty()?e.showPasswordStrength():e.hidePasswordStrength()},password_strength_get:function(e){e[0].showPasswordStrength()},keyup:function(e){this.setInstantBkpBtnStatus()},scope:this}},{xtype:"syno_textfield",fieldLabel:_T("wizard","passwd_verifypw"),validationEvent:"blur",enableKeyEvents:!0,disabled:!0,name:"confirm_pwd",textType:"password_confirm",value:"",indent:2,confirmFor:"pwd",hidden:!0,allowBlank:!1,maxLength:64,minLength:8,labelWidth:256,listeners:{keyup:function(e){this.setInstantBkpBtnStatus()},scope:this}},{xtype:"syno_button",cls:"backup-now-btn",text:_T("confbackup","backup_now"),id:this.instantBkpBtn=Ext.id(),indent:1,disabled:!0,handler:this.autoExportConfig,scope:this}]},{xtype:"syno_fieldset",title:_T("confbackup","manually_export"),collapsible:!0,items:[{xtype:"syno_displayfield",value:_T("confbackup","manually_export_desc")},{xtype:"syno_button",tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",disabled:_S("demo_mode"),text:_T("confbackup","export_conf"),scope:this,handler:this.requestExportServiceList}]},{xtype:"syno_fieldset",title:_T("confbackup","restore_config"),collapsible:!0,items:[{xtype:"syno_displayfield",value:_T("confbackup","restore_config_desc")},{xtype:"syno_button",tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",disabled:_S("demo_mode"),text:_T("confbackup","import_conf"),scope:this,handler:this.openRestoreWizard}]}]};return Ext.apply(t,e),t},initEvents:function(){this.callParent(arguments),this.getForm().encryption=["pwd"],this.mon(this,"afterrender",(function(){new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable",["enc_method"])}),this);var e={api:"SYNO.Backup.Config.AutoBackup",version:1,method:"status"},t=function(t){this.sendWebAPI(Ext.apply(e,{scope:this,callback:function(e,t,i,s){if(e){this.status=t.last_status;var n=this.convertBackupTimeStatus(t.last_success_time,t.last_status,t.fail_reason_code,this.enable);this.getForm().findField("backup_time_status").setValue(n),this.addBackupStatusTip(t.last_success_time,t.last_check_time,t.last_status,this.enable),this.setInstantBkpBtnStatus()}}}))}.bind(this);SYNO.SDS.SocketInst.register(e,t,!0),this.mon(this,"beforedestroy",(function(){SYNO.SDS.SocketInst.unregister(e,t)}))},applyHandler:function(e,t){this.getForm().isValid()?this.callParent(arguments):this.setStatusError({text:_T("common","forminvalid"),clear:!0})},enablePasswordField:function(e){e?(this.getForm().findField("pwd").enable(),this.getForm().findField("confirm_pwd").enable()):(this.getForm().findField("pwd").disable(),this.getForm().findField("confirm_pwd").disable())},showPasswordField:function(e){e?(this.getForm().findField("pwd").show(),this.getForm().findField("confirm_pwd").show()):(this.getForm().findField("pwd").hide(),this.getForm().findField("confirm_pwd").hide()),this.doLayout()},convertBackupTimeStatus:function(e,t,i,s){let n="none",o=_T("confbackup","no_backup");switch(this.bkpStatusToUIStatus(t,e,s)){case"none":n="none",o=_T("confbackup","no_backup");break;case"backingup":n="backingup",o=_T("confbackup","backup_processing");break;case"success":{n="success";const t=_T("confbackup","backup_success");o=`${e&&SYNO.SDS.DateTimeFormatter(new Date(e),{type:"datetimesec"})} ${t}`;break}case"fail":n="fail";o=`${_T("confbackup","backup_fail")} (${SYNO.SDS.ConfigBackup.getErrorString(i)})`;break;case"last_backup":n="last_backup";o=`${_T("confbackup","backup_last_at")} ${e&&SYNO.SDS.DateTimeFormatter(new Date(e),{type:"datetimesec"})}`}return String.format('<span class="confautobkp-backup-status {0}">{1}</span>',n,o)},downloadEncKey:function(e){this.module.appWin.getMsgBox().alert("",_T("confbackup","automatically_download_privatekey"),(function(){synowebapi.download({api:"SYNO.Backup.Config.AutoBackup",version:1,method:"download_private_key",params:{prikey_session_id:e},callback:function(e,t,i,s){!1===i&&this.module.appWin.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(s))}.bind(this)})}),this)},setInstantBkpBtnStatus:function(e){var t=this.getForm(),i=Ext.getCmp(this.instantBkpBtn),s=t.findField("enable").getValue();if(i.setTooltip(""),s){if("backingup"===this.status)return i.setTooltip(_T("confbackup","backup_is_processing")),void i.disable();var n=void 0!==e?e:t.findField("enc_method").getValue()!==t.findField("enc_method").originalValue;t.findField("enable").isDirty()||(s&&"manual"===t.findField("enc_method").getGroupValue()?t.findField("pwd").getValue()!==t.findField("pwd").originalValue||t.findField("confirm_pwd").getValue()!==t.findField("confirm_pwd").originalValue:t.findField("pwd").isDirty()||t.findField("confirm_pwd").isDirty())||!0===n?(i.setTooltip(_T("confbackup","apply_before_backup")),i.disable()):i.enable()}else i.disable()},cancelHandler:function(){this.callParent(arguments),this.setInstantBkpBtnStatus()},bkpStatusToUIStatus:function(e,t,i){return!0===i||"backingup"===e?e:t?"last_backup":"none"},addBackupStatusTip:function(e,t,i,s){var n="",o=e&&SYNO.SDS.DateTimeFormatter(new Date(e),{type:"datetimesec"}),a=t&&SYNO.SDS.DateTimeFormatter(new Date(t),{type:"datetimesec"});switch(this.bkpStatusToUIStatus(i,e,s)){case"success":n=_T("confbackup","last_check_time")+": "+a;break;case"fail":o&&(n=_T("confbackup","last_successful_bkp_time")+": "+o),a&&(n=n?n+"<br>":n,n+=_T("confbackup","last_check_time")+": "+a)}n&&SYNO.ux.AddTip(this.getForm().findField("backup_time_status").getEl(),n)},processReturnData:function(e,t,i){if(!0===t.has_fail)return Ext.each(t.result,(function(e){if(!e.success)return this.module.appWin.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(e.error)),!1}),this),void this.callParent([e,t,i]);var s=null,n=null;Ext.each(t.result,(function(e){"SYNO.Backup.Config.AutoBackup"===e.api&&"get"===e.method&&(s=e.data.last_success_time,n=e.data.last_check_time,this.enable=e.data.enable,this.myDSAccount=e.data.myds_account,this.status=e.data.last_status,e.data.backup_time_status=this.convertBackupTimeStatus(e.data.last_success_time,e.data.last_status,e.data.fail_reason_code,e.data.enable),e.data.confirm_pwd=e.data.pwd),"SYNO.Backup.Config.AutoBackup"===e.api&&"set"===e.method&&(Ext.isEmpty(e.data.prikey_session_id)||this.downloadEncKey(e.data.prikey_session_id))}),this),this.callParent([e,t,i]),this.setInstantBkpBtnStatus(),this.addBackupStatusTip(s,n,this.status,this.enable)},processParams:function(e,t){return"set"===e&&Ext.each(t,(function(e){"SYNO.Backup.Config.AutoBackup"===e.api&&"set"===e.method&&(e.params.overwrite=!0,e.params.enc_method=this.getForm().findField("enc_method").getGroupValue(),delete e.params.confirm_pwd,e.params.enable&&"auto"!==e.params.enc_method&&this.getForm().findField("pwd").isDirty()||delete e.params.pwd)}),this),t},openSynoAccountLogin:async function(e,t,i){this.webLogin||(this.webLogin=await SYNO.SDS.SynologyAccount.WebLogin.create()),this.webLogin.loginUrl&&(this.webLogin.popLoginWeb(),this.webLogin.on("resolve",t.bind(i)),this.webLogin.on("reject",(function(t){SYNO.Debug("Login Failed",t),e.clearStatusBusy()})),this.webLogin.on("processing",(function(){e.setStatusBusy(null,_T("login","waiting"))})))},autoExportConfig:function(){this.sendWebAPI({api:"SYNO.Backup.Config.AutoBackup",method:"backup",version:1,params:{instant:!0},scope:this,callback:function(e,t,i,s){if(!e){if(SYNO.SDS.ConfigBackup.ERR_AUTOCONF_ACCOUNT_INVALID===t.code){this.myDSAccount="";const e={confirm:{text:_T("common","login")},cancel:{text:_T("common","cancel")}};return void this.module.appWin.getMsgBox().confirm("",_T("confbackup","login_synoaccount_enable_autobkp"),e).then((e=>{if("confirm"===e){const e=function(e){this.module.appWin.clearStatus(),this.myDSAccount=e.account,this.autoExportConfig()};this.openSynoAccountLogin(this.module.appWin,e,this)}}))}this.module.appWin.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(t))}}})},openRestoreWizard:function(e){if(!Ext.getCmp(this.wizardId)){var t=new SYNO.SDS.AdminCenter.Config.RestoreWizard({configTab:this,module:this.module,owner:this.module.appWin,myDSAccount:this.myDSAccount,id:this.wizardId=Ext.id()});this.mon(t,"synoaccount_update",(function(e){this.myDSAccount=e}),this),this.mon(t,"close",(function(e){e.isRestoreParamReady()&&(this.updateStatus("initializing"),this.sendWebAPI({api:"SYNO.Backup.Config.Restore",method:"start",version:1,params:e.getRestoreParam(),scope:this,callback:function(e,t,i,s){e?(this.preprocessNetwork(t.network,t.task_id),this.onStartImportPolling(t.task_id)):this.unmaskDesk(SYNO.SDS.ConfigBackup.getErrorString(t))}}))}),this,{single:!0}),t.open()}},requestExportServiceList:async function(){this.module.appWin.setStatusBusy();var e=!_S("ha_running");try{var t=await SYNO.API.RequestPromise({api:"SYNO.Core.Network.OVS",method:"get",version:1});e=e&&!t.enable_ovs}catch(e){}this.sendWebAPI({api:"SYNO.Backup.Config.Backup",method:"list",version:1,params:{},scope:this,callback:function(t,i,s,n){if(this.module.appWin.clearStatus(),t){var o=_T("confbackup","confbkp_bkp_item_desc")+"<br>",a=[],r=[];if(e)a=i.services;else{var l=["network_interface","static_route","tc","firewall","dos"];r=i.services.filter((e=>l.includes(e.id))),a=i.services.filter((e=>!l.includes(e.id)))}if(o+=this.getGroupedServicesText(a),0!=r.length){var d=[];Ext.each(r,(function(e){d.push(SYNO.SDS.ConfigBackup.converLanString(e.text))})),(this.isOVSRunning()||_S("ha_running"))&&(o+='<span class="syno-backup-note">'+_T("common","note")+_T("common","colon")+"</span> <span>"+_T("confbackup","confbkp_bkp_not_support_network_items")+_T("common","colon")+d.join(", ")+"</span>")}this.module.appWin.getMsgBox().confirm(_T("tree","leaf_bkp"),o,null,{useHtml:!0}).then((e=>{"confirm"===e&&this.exportConfig()}))}else this.module.appWin.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(i))}})},isOVSRunning:async function(){return(await SYNO.API.RequestPromise({api:"SYNO.Core.Network.OVS",method:"get",version:1})).enable_ovs},exportConfig:function(){this.module.appWin.setStatusBusy(null,_T("confbackup","bkp_export_prepare")),this.sendWebAPI({api:"SYNO.Backup.Config.Backup",method:"start",version:1,params:{},scope:this,callback:function(e,t,i,s){if(!e)return this.module.appWin.clearStatus(),void this.module.appWin.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(t));this.onStartExportPolling(t.task_id)}})},onStartExportPolling:function(e){this.exportPollingID=this.pollReg({webapi:{api:"SYNO.Backup.Config.Backup",method:"status",version:1,params:{task_id:e}},interval:1,immediate:!0,scope:this,status_callback:this.onExportPollingDone})},onExportPollingDone:function(e,t,i,s){if(!e)return this.module.appWin.clearStatus(),this.pollUnreg(this.exportPollingID),void this.module.appWin.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.ConfigBackup.getErrorString(t));t.finish&&(this.module.appWin.clearStatus(),this.pollUnreg(this.exportPollingID),synowebapi.download({api:"SYNO.Backup.Config.Backup",version:1,method:"download",params:{task_id:t.task_id}}))},unmaskDesk:async function(e){this.getDeskMsgBox().hide(),await this.module.appWin.getMsgBox().alert(_T("tree","leaf_bkp"),e,null,{useHtml:!0})},onStartImportPolling:function(e){this.importPollingID=this.pollReg({webapi:{api:"SYNO.Backup.Config.Restore",method:"status",version:1,params:{task_id:e}},interval:1,immediate:!0,scope:this,status_callback:this.onImportPollingDone})},preprocessNetwork:function(e,t){Ext.isObject(e)&&e.need_redirect&&Ext.form.VTypes.v4ip(window.location.hostname)&&Array.isArray(e.redirect_ips)&&0!==e.redirect_ips.length&&!e.redirect_ips.includes(window.location.hostname)&&(SYNO.SDS.AdminCenter.Config.SetDesktop.apply(this,[t]),this.onStartRedirectPolling(e.redirect_ips))},onStartRedirectPolling:function(e){this.webapiTask=this.addWebAPITask({url:"webman/pingpong.cgi",requestFormat:"raw",responseFormat:"raw",httpMethod:"GET",preventHalt:!0,interval:3e3,timeout:1e4,callback:t=>{t||(SYNO.SDS.AdminCenter.Config.RedirectUrl.apply(this,[e]),this.stopRedirectTask())}}),this.webapiTask.start()},stopRedirectTask(){this.webapiTask&&this.webapiTask.stop()},clearRedirectInterval(){Array.isArray(this.intervals)&&(this.intervals.forEach((function(e){window.clearInterval(e)})),delete this.intervals)},getServicesText:function(e){var t="";return Ext.each(e,(function(e){""!==t&&(t+=", "),t+=SYNO.SDS.ConfigBackup.converLanString(e.text)})),t},getGroupedServicesText:function(e){var t={};Ext.iterate(SYNO.SDS.ConfigBackup.ConfigurationField,(function(e,i){t[i]=[]})),Ext.each(e,(function(e){if(!t.hasOwnProperty(e.field))return!0;t[e.field].push(SYNO.SDS.ConfigBackup.converLanString(e.text))}));var i={};i[SYNO.SDS.ConfigBackup.ConfigurationField.FILE_SHARING]=0,i[SYNO.SDS.ConfigBackup.ConfigurationField.CONNECTIVITY]=1,i[SYNO.SDS.ConfigBackup.ConfigurationField.SYSTEM]=2,i[SYNO.SDS.ConfigBackup.ConfigurationField.SERVICE]=3;var s=[];return Ext.iterate(t,(function(e,t){s[i[e]]="<li><span>"+SYNO.SDS.ConfigBackup.getConfigurationFieldString(e)+_T("common","colon")+"</span><span>"+t.join(", ")+"</span></li>"})),s.join("")},getImportErrText:function(e){var t=SYNO.SDS.ConfigBackup.getErrorString(e);return SYNO.SDS.ConfigBackup.ERR_CONFIG_SERVICE_FAIL===e.code&&(t+=this.getServicesText(e.errors.failed_services)),e.errors&&!0===e.errors.detail_in_log&&(t+="<p><p>"+_T("confbackup","verify_log_center")),t},onImportPollingDone:async function(e,t,i,s){e?t.finish?(this.stopRedirectTask(),this.clearRedirectInterval(),this.pollUnreg(this.importPollingID),this.module.panel.loadAllForm(),await this.unmaskDesk(_T("confbackup","bkp_done")),this.refreshConfirmDialog()):this.updateStatus(t.status,t):(t.isAbort||t.errors)&&(this.stopRedirectTask(),this.clearRedirectInterval(),this.pollUnreg(this.importPollingID),this.unmaskDesk(this.getImportErrText(t)))},refreshConfirmDialog:function(){this.module.appWin.getMsgBox().confirm("",_T("personal_settings","refresh_confirm")).then((e=>{"confirm"===e&&(window.onbeforeunload=null,location.reload())}))},updateStatus:function(e,t){var i,s,n=0,o=this.getDeskMsgBox();if("initializing"===e)n=0,s=_T("confbackup","confbkp_st_init");else if("stopping_system_service"===e)s=_T("confbackup","confbkp_st_service_stop");else if("restoring_service"===e)s=SYNO.SDS.ConfigBackup.converLanString(t.current_service.text);else{if("starting_system_service"!==e)return;s=_T("confbackup","confbkp_st_service_start")}t&&(n=t.percentage),i=_T("confbackup","confbkp_footer_desc")+" "+s,o.isVisible()||o.show({progress:!0,maxWidth:300,title:_T("tree","leaf_bkp"),msg:i}),o.updateProgress(n/100,Math.floor(n)+"%",i)},getDeskMsgBox:function(){var e=this;return e.DeskmsgBox&&!e.DeskmsgBox.isDestroyed||(e.DeskmsgBox=new SYNO.SDS.MessageBoxV5({modal:!0,draggable:!1,renderTo:document.body})),e.DeskmsgBox.getWrapper()}}),Ext.define("SYNO.SDS.AdminCenter.Reset.ResetTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.canRetainPassword=!SYNO.SDS.Utils.isInVirtualDSM();var t=this.fillConfig(e);this.callParent([t]),this.canRetainPassword&&this.mon(this,"afterlayout",this.createEnableGroup,this,{single:!0})},fillConfig:function(e){var t={title:_T("helptoc","restoredefaults"),itemId:"ResetTab",useDefaultBtn:this.canRetainPassword,webapi:{api:"SYNO.Core.System.ResetButton",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_fieldset",title:_T("tree","leaf_default"),items:this.getFactoryReset()}]};return this.canRetainPassword&&t.items.push({xtype:"syno_fieldset",title:_T("default1","reset_button_setting"),items:this.getResetButtonSetting()}),Ext.apply(t,e),t},getFactoryReset:function(){var e=_S("ha_running")&&"yes"!==_D("support_xa")||_S("demo_mode");return[{xtype:"syno_displayfield",hideLabel:!0,value:_T("default1","default_opt2")},{xtype:"syno_button",text:_T("default1","default_btn_apply"),btnStyle:e?"grey":"red",disabled:e,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):_S("ha_running")?_TT("SYNO.SDS.HA.Instance","ui","ha_not_support_setting"):"",scope:this,handler:this.onClickResetBtn}]},getResetButtonSetting:function(){return[{xtype:"syno_checkbox",name:"retain_admin_pwd",boxLabel:_T("default1","retain_admin_pwd")},{xtype:"syno_displayfield",indent:1,name:"retain_admin_pwd_desc",value:_T("default1","retain_admin_pwd_desc")}]},createEnableGroup:function(){new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"retain_admin_pwd",["retain_admin_pwd_desc"])},onClickResetBtn:function(){new SYNO.SDS.AdminCenter.Reset.ResetTab.ConfirmDialog({owner:this.module.appWin,module:this.module}).show()}}),Ext.define("SYNO.SDS.AdminCenter.Reset.ResetTab.ConfirmDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.buttonCounter=0;var t=Ext.apply({cls:"syno-admin-center-confirm-dialog x-window-dlg",draggable:!1,elements:"body",header:!1,resizable:!1,width:480,minHeight:120,autoHeight:!0,padding:"24px 30px 0",fbar:[{xtype:"syno_button",text:_T("common","no"),scope:this,handler:this.onClickNo},{xtype:"syno_button",text:_T("default1","default_btn_apply"),itemId:"apply",btnStyle:"red",disabled:!0,scope:this,handler:this.onClickDelete}],items:[{xtype:"syno_update_reset_dialog_title",value:_T("tree","leaf_default")},{xtype:"syno_displayfield",cls:"dialog-msg",value:_T("default1","default_confirm")},{xtype:"syno_checkbox",cls:"dialog-checkbox",boxLabel:_T("default1","default_confirm_check"),listeners:{check:{fn:function(e,t){t?(this.buttonCounter=5,this.countDownButtonTask=new Ext.util.DelayedTask(this.countDownButtonEnable,this),this.countDownButtonEnable()):this.countDownButtonDisable()},scope:this}}}]},e);SYNO.SDS.AdminCenter.Reset.ResetTab.ConfirmDialog.superclass.constructor.call(this,t)},countDownButtonEnable:function(){var e=_T("default1","default_btn_apply"),t=this.getFooterToolbar().getComponent("apply");if(this.countDownButtonTask){if(0===this.buttonCounter)return t.setText(e),void t.setDisabled(!1);this.countDownButtonTask&&this.countDownButtonTask.delay(1e3),t.setText(e+" ("+this.buttonCounter+")"),this.buttonCounter--}},countDownButtonDisable:function(){var e=this.getFooterToolbar().getComponent("apply");this.countDownButtonTask&&delete this.countDownButtonTask,e.setText(_T("default1","default_btn_apply")),e.setDisabled(!0)},onClickDelete:function(){SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,this.sendResetRequest)},sendResetRequest:function(e){var t=this,i={};this.setStatusBusy(),t.sendWebAPI({api:"SYNO.Core.System",method:"reset",version:1,params:{force:e||!1},callback:function(e,s,n,o){this.clearStatusBusy(),e?t.IsCMSMode()?t.owner.getMsgBox().alert(_T("tree","leaf_default"),_JSLIBSTR("uicommon","system_reboot_timeout"),(function(){t.module.appWin.close()})):(SYNO.SDS.Desktop.getMsgBox().show({maxWidth:300,title:_D("product"),msg:_JSLIBSTR("uicommon","system_reboot_timeout"),canClose:!1}),SYNO.SDS.StatusNotifier.fireEvent("halt"),SYNO.SDS.SocketInst.disconnect(),synowebapi.promises.request({url:"webapi/entry.cgi?api=SYNO.API.Auth",requestFormat:"raw",responseFormat:"raw",method:"GET",params:{version:7,method:"logout"}}).finally((()=>{SYNO.API.Manager.setHalt(!0)}))):this.isFeasibilityFail(s,i)&&this.confirmFeasibilityFail(this,i,this.sendResetRequest,!0)},scope:this})},onClickNo:function(){this.countDownButtonDisable(),this.close()},IsCMSMode:function(){return void 0!==this.owner.getOpenConfig("cms_id")},isFeasibilityFail:function(e,t){return!!(e.errors&&e.errors.feasibility&&(t.soft=e.errors.feasibility.soft||[],t.hard=e.errors.feasibility.hard||[],t.soft.length>0||t.hard.length>0))},confirmFeasibilityFail:function(e,t,i){var s,n,o,a=[],r="{0}</br></br>{1}",l=e.getMsgBox||e.owner.getMsgBox;if(void 0===l)throw Error("Does not found 'getMsgBox'");0<t.hard.length?(t.hard.forEach((function(e){o=SYNO.SDS.Utils.GetFeasibilityCheckMsg(e),a.push(o)})),s=String.format(r,_T("volume","hard_check_fail"),a.join("</br>")),l.call(e).alert(e.title,s)):0<t.soft.length&&(t.soft.forEach((function(e){o=SYNO.SDS.Utils.GetFeasibilityCheckMsg(e),a.push(o)})),s=String.format(r,_T("volume","soft_check_fail"),a.join("</br>")),n=[].slice.call(arguments,this.confirmFeasibilityFail.length),l.call(e).confirm(e.title,s,(function(e){"yes"==e&&i.apply(this,n)}),e))}}),Ext.define("SYNO.SDS.AdminCenter.SystemRecovery.SystemRecoveryTab",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={title:_T("helptoc","system_recovery"),itemId:"SystemRecoveryTab",items:this.getRestoreItem()};return Ext.apply(t,e),t},getRestoreItem:function(){var e=_S("ha_running")&&"yes"!==_D("support_xa")||_S("demo_mode");return[{xtype:"syno_displayfield",hideLabel:!0,value:_T("system_recovery","description_with_hb")},{xtype:"syno_button",text:_T("system_recovery","restore_system"),btnStyle:e?"grey":"red",disabled:e,tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):_S("ha_running")?_TT("SYNO.SDS.HA.Instance","ui","ha_not_support_setting"):"",scope:this,handler:this.onClickRecovery}]},onClickRecovery:function(){this.setStatusBusy(),synowebapi.promises.request({api:"SYNO.Core.System",method:"reset_check",version:1,params:{type:"system_recovery"}}).then((()=>{this.openRecoveryDialog()})).catch((e=>{if(SYNO.Debug(e),e.errors&&e.errors.feasibility&&e.errors.feasibility.hard&&e.errors.feasibility.soft){if(e.errors.feasibility.hard.length>0){let t=[];e.errors.feasibility.hard.forEach((function(e){const i=SYNO.SDS.Utils.GetFeasibilityCheckMsg(e);t.push(i)}));const i=String.format("{0}</br></br>{1}",_T("volume","hard_check_fail"),t.join("</br>"));return void this.module.appWin.getMsgBox().alert("",i,void 0,{useHtml:!0})}if(e.errors.feasibility.soft.length>0){let t=[];e.errors.feasibility.soft.forEach((function(e){const i=SYNO.SDS.Utils.GetFeasibilityCheckMsg(e);t.push(i)}));const i=String.format("{0}</br></br>{1}",_T("volume","soft_check_fail"),t.join("</br>"));this.module.appWin.getMsgBox().confirm("",i,void 0,{useHtml:!0}).then((e=>{"confirm"===e&&this.openRecoveryDialog()}))}}else this.module.appWin.getMsgBox().alert("",SYNO.API.getErrorString(e.code),void 0,{useHtml:!0})})).finally((()=>{this.clearStatusBusy()}))},openRecoveryDialog:function(){new SYNO.SDS.AdminCenter.SystemRecovery.RecoveryDialog({owner:this.module.appWin,module:this.module}).open()}}),Ext.define("SYNO.SDS.AdminCenter.SystemRecovery.RecoveryDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.panel=this.createPanel(e);var t=Ext.apply({title:_T("system_recovery","restore_system"),height:266,width:600,closable:!0,buttons:[{xtype:"syno_button",btnStyle:"grey",text:_T("common","cancel"),handler:this.close,scope:this},{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),scope:this,handler:this.onSubmit}],items:[this.panel]},e);this.callParent([t])},createPanel:function(e){var t={height:156,padding:"0 0 0 0",items:[{xtype:"syno_displayfield",value:_T("system_recovery","select_desc")},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_radio",name:"recovery_type",itemId:"recover_vault",inputValue:"vault",checked:!0,boxLabel:_T("system_recovery","source_hbv")}]},{xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_radio",name:"recovery_type",itemId:"recover_c2",inputValue:"c2",boxLabel:_T("system_recovery","source_c2")}]},{xtype:"syno_radio",name:"recovery_type",itemId:"recover_brm",inputValue:"brm",boxLabel:_T("system_recovery","source_abb")}]};return Ext.apply(t,e),new SYNO.ux.FormPanel(t)},onSubmit:function(){this.onClickSystemRecoveryBtn(),this.close()},assureHyperBackupEDRunning:async function(){if(SYNO.SDS.Packages.isStart("SYNO.SDS.App.HyperBackup.ED.Restore.Instance"))return!0;try{return await synowebapi.promises.request({api:"SYNO.Core.Backup.ED",method:"ensure_package_installed_and_started",version:1}),await new Promise((e=>{SYNO.SDS.StatusNotifier.on("jsconfigLoaded",e)})),!0}catch(e){}return!1},startSystemRecovery:async function(e,t){if(this.findAppWindow().setStatusBusy(),"SYNO.SDS.App.HyperBackup.ED.Restore.Instance"==e&&!await this.assureHyperBackupEDRunning())return this.findAppWindow().getMsgBox().alert(_T("helptoc","system_recovery"),_T("error","error_invalid")),void this.findAppWindow().clearStatusBusy();this.findAppWindow().clearStatusBusy(),SYNO.SDS.AppLaunch(e,{entry:"admin_center",type:t})},onClickSystemRecoveryBtn:function(){var e="",t=this.panel.getForm().getValues();switch(t.recovery_type){case"brm":e="SYNO.SDS.App.BRM.Restore.Instance";break;case"c2":case"vault":e="SYNO.SDS.App.HyperBackup.ED.Restore.Instance"}if("brm"!=t.recovery_type||SYNO.SDS.Packages.getInfoByPkgId("BackupRestoreManager")){const i={confirm:{text:_T("system_recovery","default_btn_apply"),btnStyle:"red"},cancel:{text:_T("common","cancel")}};this.findAppWindow().getMsgBox().confirmDelete(_T("helptoc","system_recovery"),_T("system_recovery","default_confirm"),i).then((i=>{if("confirm"===i)return this.startSystemRecovery(e,t.recovery_type)}))}else this.findAppWindow().getMsgBox().confirm(_T("helptoc","system_recovery"),_T("system_recovery","desc_ask_install_brm_pkg"),null,{useHtml:!0}).then((e=>{"confirm"===e&&SYNO.SDS.AppLaunch("SYNO.SDS.PkgManApp.Instance",{action:"open",packages:["BackupRestoreManager"]})}))}}),Ext.ns("SYNO.SDS.AdminCenter.Update_Reset"),Ext.define("SYNO.SDS.AdminCenter.Update_Reset.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.app=e.app,this.panel=new SYNO.SDS.AdminCenter.Update_Reset.TabPanel({module:this})},getHelpParam:function(){switch(this.panel.getActiveTab().itemId){case"ResetTab":return"AdminCenter/system_restoredefaults.html";case"ConfigTab":return"AdminCenter/system_configbackup.html";case"UpdateTab":return"AdminCenter/system_dsmupdate.html";case"SystemRecoveryTab":return"AdminCenter/system_recovery.html";default:return"AdminCenter/system_update_reset_desc.html"}},getPanel:function(){return this.panel},setActivateParams:function(e){if(e&&e.tab){if(this.panel.setActiveTab(e.tab),"ConfigTab"===e.tab){var t=this.getPanel().getItem("ConfigTab");!0===e.is_login&&(t.myDSAccount="user"),!0===e.open_wizard&&t.openRestoreWizard(),e.task_id&&t.onStartImportPolling(e.task_id,!0)}if("SystemRecoveryTab"===e.tab){const t=this.getPanel().getItem("SystemRecoveryTab");e.open_recovery_dialog&&t.onClickRecovery()}}},focus:function(e){if(e&&e.tab){if("ConfigTab"===e.tab){this.panel.setActiveTab(e.tab);var t=this.getPanel().getItem("ConfigTab");!0===e.is_login&&(t.myDSAccount="user"),!0===e.open_wizard&&t.openRestoreWizard()}if("SystemRecoveryTab"===e.tab){const t=this.getPanel().getItem("SystemRecoveryTab");e.open_recovery_dialog&&t.onClickRecovery()}}},activate:function(e){this.setActivateParams(e),this.panel.loadAllForm()},deactivate:function(){return this.panel.getAllForms().filter((function(e){return"UpdateTab"!==e.itemId})).every((function(e){return!e.isDirty()}))},confirmLostChangeSave:function(){return this.getPanel().applyHandlerPromise()}}),Ext.define("SYNO.SDS.AdminCenter.Update_Reset.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",applyHandlerResolve:Ext.emptyFn,applyHandlerReject:Ext.emptyFn,constructor:function(e){this.module=e.module;var t=Ext.apply({activeTab:0,useDefaultBtn:!1,items:this.createTabItems()},e);this.callParent([t])},createTabItems(){let e=[new SYNO.SDS.AdminCenter.Update.UpdateTab({module:this.module})];return"yes"!==_D("support_hyper_converged")&&e.push(new SYNO.SDS.AdminCenter.Config.ConfigTab({module:this.module})),"yes"===_D("dockerdsm")||SYNO.SDS.Utils.isInC2DSM()||SYNO.SDS.Utils.isInAliDSM()||("yes"!==_D("support_hyper_converged")&&e.push(new SYNO.SDS.AdminCenter.Reset.ResetTab({module:this.module})),"yes"===_D("support_synorbd_vspace")&&e.push(new SYNO.SDS.AdminCenter.SystemRecovery.SystemRecoveryTab({module:this.module}))),e},processReturnData:function(e,t,i){t.has_fail?this.applyHandlerReject():this.applyHandlerResolve(),this.applyHandlerResolve=Ext.emptyFn,this.applyHandlerReject=Ext.emptyFn,this.callParent(arguments)},applyHandlerPromise:function(){var e=this;return new Promise((function(t,i){e.applyHandlerResolve=t,e.applyHandlerReject=i,e.applyHandler()}))}}),Ext.ns("SYNO.SDS.AdminCenter.ExtendWarranty"),Ext.define("SYNO.SDS.AdminCenter.ExtendWarranty.FieldSet",{extend:"SYNO.ux.FieldSet",labelWidth:220,saLink:[`<a href="${_D("ew20_website_url")}purchase/extended-warranty-plus" target="_blank">`,"</a>"],scLink:['<a href="https://sy.to/ewplus" target="_blank">',"</a>"],saRegisterLink:`${_D("ew20_website_url")}extended-warranty-plus/registration/`,ewInfoBase64:"",constructor:function(e){let t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){let t={collapsible:!1,cls:"ew-fieldset",hidden:!e.isSupportEW,title:_T("extend_warranty","synology_care"),items:this.getItems()};return Ext.apply(t,e),t},getEWStatus(e,t){const i=e=>{if(!e)return;return new Date(e).format(SYNO.SDS.DateTimeUtils.GetSystemDateFormat())},s=e=>{if(0==e.length)return;const t=String.format('<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>");return e.length>1?t+'<br><ul style="list-style-type: disc; list-style-position: outside; margin-left: 16px;">'+e.map((e=>"<li>"+e+"</li>")).join("")+"</ul>":t+e[0]},n=t?[this.saLinkFormat(_T("extend_warranty","check_expansion"))]:[];switch(e.status){case"registrable":return{status:"not_registered",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),btn:_T("extend_warranty","register_now"),serviceStatus:_T("extend_warranty","not_registered"),note:s([_T("extend_warranty","eligible_only_90_days"),this.saLinkFormat(_T("extend_warranty","cant_register_for_ew201")),...n])};case"review_in_progress":return{status:"not_registered",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),serviceStatus:_T("extend_warranty","not_registered"),detailDesc:this.saLinkFormat(_T("extend_warranty","being_verified_desc")),note:s([_T("extend_warranty","eligible_only_90_days"),this.saLinkFormat(_T("extend_warranty","cant_register_for_ew201")),...n])};case"payment_not_completed":return{status:"not_registered",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),btn:_T("extend_warranty","register_now"),serviceStatus:_T("extend_warranty","not_registered"),detailDesc:this.saLinkFormat(_T("extend_warranty","waiting_for_payment_desc")),note:s([_T("extend_warranty","eligible_only_90_days"),this.saLinkFormat(_T("extend_warranty","cant_register_for_ew201")),...n])};case"accepted":return{status:"not_registered",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),btn:_T("extend_warranty","register_now"),serviceStatus:_T("extend_warranty","not_registered"),detailDesc:this.saLinkFormat(_T("extend_warranty","verified_but_not_complete_desc")),note:s([_T("extend_warranty","eligible_only_90_days"),this.saLinkFormat(_T("extend_warranty","cant_register_for_ew201")),...n])};case"rejected":return{status:"not_registered",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),btn:_T("extend_warranty","register_again"),serviceStatus:_T("extend_warranty","not_registered"),detailDesc:this.scLinkFormat(_T("extend_warranty","exceed_period_desc")),note:s([_T("extend_warranty","eligible_only_90_days"),this.saLinkFormat(_T("extend_warranty","cant_register_for_ew201")),...n])};case"activated":return{status:"registered",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),serviceStatus:String.format('<span class="green-status">'+_T("extend_warranty","registered"),NaN),expiryDate:i(e.expired_at),location:e.drma_region?_T("Country",e.drma_region.toUpperCase()):void 0,note:s([...n])};case"out_of_warranty":return{status:"expired",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),serviceStatus:_T("extend_warranty","expired"),expiryDate:i(e.expired_at),note:s([...n])};case"ew10":return{status:"not_eligible",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),serviceStatus:_T("extend_warranty","not_eligible"),detailDesc:this.saLinkFormat(_T("extend_warranty","have_registered_ew201_desc")),note:s([...n])};case"phaseout_model":case"unsupported_model":return{status:"not_eligible",desc:this.scLinkFormat(_T("extend_warranty","register_sc_from_now")),serviceStatus:_T("extend_warranty","not_eligible"),detailDesc:this.scLinkFormat(_T("extend_warranty","doesnot_support")),note:s([...n])};default:return{status:"not_registered",desc:String.format(_T("extend_warranty","register_and_sign_in_desc"),...this.scLink,...this.saLink),btn:_T("extend_warranty","register_now"),serviceStatus:_T("extend_warranty","not_registered"),note:s([_T("extend_warranty","eligible_only_90_days"),this.saLinkFormat(_T("extend_warranty","cant_register_for_ew201")),...n])}}},getItems(){const e=this;return[{xtype:"syno_displayfield",htmlEncode:!1,ref:"ewDesc",value:this.scLinkFormat(_T("extend_warranty","register_sc_from_now"))},{xtype:"syno_button",btnStyle:"grey",hidden:!0,cls:"ew-button",handler:this.onRegisterNowBtnClick.bind(this),ref:"ewBtn"},{xtype:"syno_displayfield",htmlEncode:!1,fieldLabel:_T("extend_warranty","service_status"),labelWidth:this.labelWidth,ref:"ewServiceStatus",value:""},{xtype:"syno_displayfield",htmlEncode:!1,hidden:!0,fieldLabel:_T("extend_warranty","desc"),labelWidth:this.labelWidth,ref:"ewDetailDesc"},{xtype:"syno_displayfield",htmlEncode:!1,hidden:!0,fieldLabel:_T("extend_warranty","expiry_date"),labelWidth:this.labelWidth,ref:"ewExpiryDate"},{xtype:"syno_displayfield",htmlEncode:!1,hidden:!0,fieldLabel:_T("extend_warranty","service_location"),labelWidth:this.labelWidth,ref:"ewLocation",listeners:{show:function(){SYNO.ux.AddTip(this.getEl(),e.scLinkFormat(_T("extend_warranty","service_location_tooltip")))}}},{xtype:"syno_displayfield",htmlEncode:!1,hidden:!0,tabindex:"-1",ref:"ewNote"}]},loadData(e={},t=!1,i=""){const s=(e,t)=>{Ext.isFunction(e.setValue)?e.setValue(t):Ext.isFunction(e.setText)&&e.setText(t),e.setVisible(void 0!==t)},n=this.getEWStatus(e,t),o=_D("unique").split("_").pop();this.ewInfoBase64=btoa(JSON.stringify({sn:e.sn,model:o,userEmail:i})),s(this.ewDesc,n.desc),s(this.ewBtn,n.btn),s(this.ewServiceStatus,n.serviceStatus),s(this.ewDetailDesc,n.detailDesc),s(this.ewExpiryDate,n.expiryDate),s(this.ewLocation,n.location),s(this.ewNote,n.note)},saLinkFormat(e){return String.format(e,...this.saLink)},scLinkFormat(e){return String.format(e,...this.scLink)},onRegisterNowBtnClick(){window.open(this.saRegisterLink+`?ew=${this.ewInfoBase64}`,"_blank")}}),Ext.ns("SYNO.SDS.AdminCenter.SynologyAccount"),Ext.define("SYNO.SDS.AdminCenter.SynologyAccount.LogoutDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.panel=e.panel,this.reasons=e.reasons;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t="logout_confirm";this.reasons.length>1&&(t="logout_confirm_multiple");var i={autoHeight:!0,width:480,resizable:!1,draggable:!1,header:!1,cls:"x-window-dlg",elements:"body",padding:"24px 30px 0",fbar:["->",{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.close},{xtype:"syno_button",text:_T("common","logout"),btnStyle:"blue",scope:this,handler:this.confirmLogout}],items:[{xtype:"syno_displayfield",name:"title",cls:"account-logout-dialog-title",value:_T("myds","logout_confirm_title")},{xtype:"syno_displayfield",name:"message",cls:"account-logout-dialog-msg",value:_T("myds",t)},{xtype:"syno_displayfield",name:"reasons",cls:"account-logout-dialog-reasons",indent:1,htmlEncode:!1,value:"<ul>"+this.reasons.join("")+"</ul>"}]};return Ext.apply(i,e),i},confirmLogout:function(){this.panel.doLogout(!0),this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.SynologyAccount"),Ext.define("SYNO.SDS.AdminCenter.SynologyAccount.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.panel=new SYNO.SDS.AdminCenter.SynologyAccount.Panel({module:this})},getPanel:function(){return this.panel},getHelpParam:function(){return"AdminCenter/system_synology_account.html"},activate:function(){this.panel.onActivate()},setActivateParams:function(e){},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t}.bind(this))},deactivate:function(){return!this.panel.isDirty()&&(this.panel.webLogin&&this.panel.webLogin.cancel(),!0)}}),Ext.define("SYNO.SDS.AdminCenter.SynologyAccount.Panel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.appWin=this.module.appWin;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={title:_T("myds","myds_account"),itemId:"account",cls:"synology-account-panel",items:this.createItems()};return Ext.apply(t,e),t},createItems:function(){var e=[];return e.push({xtype:"syno_fieldset",collapsible:!1,title:_T("myds","myds_account"),items:[{xtype:"syno_displayfield",cls:"synology-account-desc",htmlEncode:!1,value:String.format(_T("myds","myds_desc"),'<a href="https://account.synology.com/" target="_blank">',"</a>")},{xtype:"container",cls:"synology-account-container",items:[{xtype:"syno_displayfield",cls:"synology-account-label",value:_T("myds","myds_account")+":"},this.displayAccount=new SYNO.ux.DisplayField({cls:"synology-account-mail",htmlEncode:!1,hidden:!0}),this.displayLoginOrSignUp=new SYNO.ux.DisplayField({cls:"synology-account-login-or-sign-up",hidden:!0,htmlEncode:!1,value:'<span class="link-font" tabindex="0" aria-level="2" aria-label="'+_T("myds","myds_account")+": "+_T("myds","login_or_register_myds_account")+'">'+_T("myds","login_or_register_myds_account")+"</span>",listeners:{scope:this,afterrender:function(e){e.el.on("click",this.onLoginClicked,this)}}}),{xtype:"syno_button",cls:"synology-account-logout-account-btn",hidden:!0,text:_T("common","logout"),scope:this,id:this.logoutAccountBtnId=Ext.id(),handler:this.onLogoutAccountClicked}]}]},new SYNO.SDS.AdminCenter.ExtendWarranty.FieldSet({ref:"extendWarranty",isSupportEW:this.isSupportEW()})),SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.SDS.ActiveInsight.Instance")&&SYNO.SDS.JSLoad("SYNO.SDS.ActiveInsight.Instance",function(){if(SYNO.SDS.ActiveInsight&&SYNO.SDS.ActiveInsight.ProxySetting){let e=new SYNO.SDS.VuePanel({vueClass:SYNO.SDS.ActiveInsight.ProxySetting,mountId:"active-insight-proxy-setting"});this.insert(1,e),this.doLayout()}}.bind(this)),e},processEWWebapiResp:function(e){const t=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.EW.Info","get");t&&t.info&&Ext.isBoolean(t.have_applied_eunit||!Ext.isString(t.mail))?this.extendWarranty.loadData(t.info,t.have_applied_eunit,t.mail):(this.appWin.getMsgBox().alert("",SYNO.API.getErrorString(t)),this.extendWarranty.loadData())},processMyDSCenterWebapiResp:function(e){const t=SYNO.API.Response.GetValByAPI(e,"SYNO.Core.MyDSCenter","query");t&&(t.is_logged_in?this.onLoggedIn(t):this.showLoginInfo())},reloadAll:function(){let e=[];e.push(this.genMyDSCenterWebapi()),this.isSupportEW()&&e.push(this.genEWWebapi()),0!==e.size&&(this.appWin.setStatusBusy(),this.sendWebAPI({api:"SYNO.Entry.Request",method:"request",version:2,params:{mode:"parallel",compound:e},scope:this,callback:function(e,t,i,s){this.appWin.clearStatus(),e?(this.processMyDSCenterWebapiResp(t),this.isSupportEW()&&this.processEWWebapiResp(t)):this.appWin.getMsgBox().alert("",SYNO.API.getErrorString(t))}}))},onActivate:function(){this.module.panel.clearStatusBusy(),this.reloadAll()},onLoggedIn:function(e){const t=e.account,i=e.activated;this.displayAccount.setValue('<span class="link-font" ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(t))+'">'+Ext.util.Format.htmlEncode(t)+"</span>"),this.displayAccount.show(),this.displayLoginOrSignUp.hide(),Ext.getCmp(this.logoutAccountBtnId).show(),i||(this.addUnactivatedTip(this.displayAccount.getEl(),_T("myds","not_activated_desc")),this.appWin.getMsgBox().alert("",_T("myds","not_activated_alert"))),this.appWin.clearStatus()},onLoggedFail:function(e){SYNO.Debug("Login Failed",e),this.appWin.clearStatus()},onLoggedProcessing:function(){this.appWin.setStatusBusy(null,_T("login","waiting"))},showLoginInfo:function(){this.displayAccount.hide(),this.displayLoginOrSignUp.show(),Ext.getCmp(this.logoutAccountBtnId).hide()},onLoginClicked:async function(){this.webLogin||(this.webLogin=await SYNO.SDS.SynologyAccount.WebLogin.create()),this.webLogin.loginUrl&&(this.webLogin.popLoginWeb(),this.webLogin.on("resolve",this.reloadAll.bind(this)),this.webLogin.on("reject",this.onLoggedFail.bind(this)),this.webLogin.on("processing",this.onLoggedProcessing.bind(this)))},showLogoutDialog:function(e){new SYNO.SDS.AdminCenter.SynologyAccount.LogoutDialog({owner:this.appWin,panel:this,reasons:e}).show()},onLogoutAccountClicked:function(){this.doLogout(!1)},doLogout:function(e){this.appWin.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.MyDSCenter.Logout",version:1,method:"pkce_logout",params:{force:!!e},scope:this,callback:async function(e,t,i){this.appWin.clearStatus();var s=[];if(e)this.reloadAll();else if(3014===t.code)try{Ext.each(t.errors.reasons,(function(e){var t=Ext.decode(e);s.push(String.format("<li>{0}</li>",Ext.util.Format.htmlEncode(String.format.apply(window,[SYNO.SDS.Utils.GetFeasibilityCheckMsg(t.task_i18n)].concat(t.args||[])))))})),"soft"===t.errors.check_type?this.showLogoutDialog(s):this.appWin.getMsgBox().alert("",_T("myds","logout_alert")+s.join(""))}catch(e){this.appWin.getMsgBox().alert("",SYNO.API.getErrorString(t))}else this.appWin.getMsgBox().alert("",SYNO.API.getErrorString(t))}})},addUnactivatedTip:function(e,t){var i=document.createElement("a"),s=document.createElement("img"),n="vertical-align: middle; position: relative; margin-left: 6px",o=Ext.getCmp(e.id),a=Ext.id(),r=SYNO.SDS.UIFeatures.test("isRetina")?SYNO.SDS.ThemeProvider.getPath("synoSDSjslib/images/2x/components/icon_error.png"):SYNO.SDS.ThemeProvider.getPath("synoSDSjslib/images/1x/components/icon_error.png");if(s.setAttribute("src",r),s.setAttribute("width","20px"),s.setAttribute("height","20px"),s.setAttribute("draggable","false"),o&&o.defaultTriggerWidth&&(n+=" left:"+o.defaultTriggerWidth+"px;"),s.setAttribute("style",n),s.setAttribute("ext:qtip",t),s.setAttribute("alt",t),s.setAttribute("id",a),i.appendChild(s),o instanceof SYNO.ux.DisplayField)e.appendChild(i);else if(o instanceof SYNO.ux.Button&&Ext.getDom(e).nextSibling){var l=e.dom.getAttribute("style")+" margin-right:0px !important;",d=Ext.getDom(e);d.setAttribute("style",l),i.setAttribute("style","margin-right:6px !important;"),d.parentNode.insertBefore(i,d.nextSibling)}else o instanceof SYNO.ux.TextArea?Ext.getDom(e).parentNode.parentNode.appendChild(i):Ext.getDom(e).parentNode.appendChild(i);return o&&o.el&&o.el.set({"aria-describedby":o.el.dom.getAttribute("aria-describedby")+" "+a}),i},isDirty:function(){return!1},cancelHandler:function(){},genEWWebapi:function(){return{api:"SYNO.Core.EW.Info",method:"get",version:1,params:{use_extended_cache:!1}}},genMyDSCenterWebapi:function(){return{api:"SYNO.Core.MyDSCenter",version:2,method:"query",params:{}}},isSupportEW:function(){const e="chs"===_S("lang")&&"Beijing"===_S("timezone");return"yes"===_D("support_ew_20")&&!e}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.PreviewGrid",{extend:"SYNO.ux.GridPanel",pageSize:20,constructor:function(e){this.groupingstore=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({root:"applications",fields:["name","isInternal"]}),totalProperty:"total",autoDestroy:!0,groupField:"isInternal",groupDir:"DESC"});var t=Ext.apply({header:!1,border:!1,padding:"6px 0px 0px 0px",ds:this.groupingstore,cm:new Ext.grid.ColumnModel([{id:"application",header:_T("user","user_application"),dataIndex:"name",width:200,scope:this},{header:_T("app_privilege","effective_permission"),id:"preview",dataIndex:"preview",align:"left",width:200,renderer:function(e){return"allow"===e?_T("app_privilege","allow_privilege"):"deny"===e?_T("app_privilege","deny_privilege"):"custom"===e?_T("app_privilege","grant_by_ip"):void 0}},{header:"Category",dataIndex:"isInternal",hidden:!0,groupRenderer:function(e,t,i){return i.data.isInternal?_T("service","internal_service"):_T("pkgmgr","title_packages")}}]),autoExpandColumn:"application",enableHdMenu:!1,listeners:{scope:this,activate:function(){this.loadAppRules()}},view:new SYNO.ux.GroupingView({showGroupName:!1,enableGroupingMenu:!1})},e);this.callParent([t])},loadAppRules:function(){this.module.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.AppPriv.App",method:"list",version:2,params:{offset:0,limit:this.pageSize},scope:this,callback:function(e,t){if(!e)return this.module.getMsgBox().alert(this.title,SYNO.API.getErrorString(t)),void this.module.clearStatusBusy();this.store.loadData(t),this.store.sort("name","ASC"),this.module.clearStatusBusy(),this.getSelectionModel().selectFirstRow()}})}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.PreviewDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.gridPanel=new SYNO.SDS.AdminCenter.AppRulePrivileges.PreviewGrid({module:this,itemId:"preview",autoScroll:!0,height:370});var t=this,i=[new SYNO.SDS.Share.ACLPrivilege.UserGrpCombo({initComponent:function(){Ext.apply(this,{tpl:'<tpl for="."><div class="x-combo-list-item acl-icon-combo-item '+this.iconClsPrefix+"{"+this.iconClsField+'}" id="{[Ext.id()]}" role="option" aria-label="{'+this.displayField+'}" ext:qtip={'+this.displayField+"}>{"+this.displayField+"}</div></tpl>"}),SYNO.SDS.Share.ACLPrivilege.IconCombo.superclass.initComponent.call(this)},fieldLabel:_T("acl_editor","user_or_group"),itemId:"cmb_owner",queryParam:"prefix",width:325,listWidth:325,store:new Ext.data.Store({autoDestroy:!0,proxy:new SYNO.API.Proxy({api:"SYNO.Core.ACL",method:"list_owners",version:1,appWindow:this}),reader:new Ext.data.JsonReader({root:"owners",totalProperty:"total",id:"value"},[{name:"name"},{name:"type"},{name:"value",convert:function(e,t){return t.type+":"+t.name}}]),paramNames:{start:"offset",limit:"limit"},remoteSort:!0,baseParams:{include_everyone:!1,include_owner:!1},pruneModifiedRecords:!0}),listeners:{select:function(){var e=t.form.getComponent("cmb_owner"),i=t.form.getComponent("tcpip_ipaddr");e&&!e.valueNotFound()&&e.getValue()&&""!==e.getValue()?i.enable():i.disable()}}}),{xtype:"syno_textfield",width:325,labelWidth:150,fieldLabel:_T("tcpip","tcpip_ipaddr")+_T("common","optional"),name:"source_ip",itemId:"tcpip_ipaddr",vtype:"fwLooseip",validationEvent:"keyup",disabled:!0,validator:function(e){return!(e&&!Ext.form.VTypes.fwLooseip(e))&&(t.doPreview(t.form.getComponent("cmb_owner")),!0)}},this.gridPanel],s=Ext.apply({width:600,height:500,minWidth:500,minHeight:400,layout:"fit",title:_T("acl_editor","permission_viewer"),items:[this.form=new SYNO.ux.FormPanel({border:!1,labelAlign:"left",padding:"0px",items:i,listeners:{afterlayout:function(){SYNO.ux.AddTip(this.form.findField("source_ip"),_T("app_privilege","tip_privilege_preview"))},single:!0}})],buttons:[{text:_T("common","close"),scope:this,handler:this.close}]},e);this.callParent([s]),this.gridPanel.loadAppRules(),this.mon(this.form.getComponent("cmb_owner"),"valueset",this.doPreview,this)},renderDefaultUser:function(e){var t,i=this.gridPanel.store.getCount(),s=e?"allow":"deny";for(t=0;t<i;t++){this.gridPanel.store.getAt(t).set("preview",s)}},doPreview:function(e){if(!e||e.valueNotFound()||!e.getValue()||""===e.getValue())return e.assertValue(),void this.setStatusError({text:_T("acl_editor","error_invalid_user_or_group"),clear:!0});var t=e.getValue(),i=t.split(":")[0],s=t.split(":")[1],n=this.form.getComponent("tcpip_ipaddr").getValue();if(!n||Ext.form.VTypes.fwLooseip(n))if("admin"!==s&&"SynologyCMS"!==s)if("guest"!==s){var o={};"user"===i?o.username=s:o.groups=[s],n&&(o.ip=n),this.body.mask(_T("common","loading"),"x-mask-loading"),this.sendWebAPI({api:"SYNO.Core.AppPriv.App",method:"preview",version:2,scope:this,params:o,callback:function(e,t,i){if(!this.isDestroyed){if(e)this.renderPriv(t.applications);else{this.form.getComponent("cmb_owner").reset();var s=_T("error","error_error_system");Ext.isDefined(t.code)&&(s=SYNO.API.getErrorString(t.code)),this.getMsgBox().alert(this.title,s)}this.body.unmask()}}})}else this.renderDefaultUser(!1);else this.renderDefaultUser(!0);else this.setStatusError({text:_JSLIBSTR("vtype","bad_ip"),clear:!0})},renderPriv:function(e){var t,i,s=this.gridPanel.store.getCount(),n=e.length;for(t=0;t<s;t++){var o=this.gridPanel.store.getAt(t),a=o.json.app_id;for(o.set("preview",null),i=0;i<n;i++)a===e[i].app_id&&o.set("preview",e[i].privilelge)}}}),Ext.namespace("SYNO.SDS.Share"),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.AddIPDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.panel=this.createPanel(),this.form=this.panel.getForm();var t={width:540,height:250,title:_T("firewall","firewall_source"),layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","save"),itemId:"ruleApply",scope:this,handler:this.onApply}]};this.setDefault(),Ext.apply(t,e),this.callParent([t]),this.OnSourceRadioClick(this.form.findField("source"),!0)},createPanel:function(){var e={xtype:"syno_fieldset",title:_T("firewall","firewall_source"),itemId:"rule_source",padding:"0px",items:[{xtype:"syno_compositefield",hideLabel:!0,defaultMargins:"0 28 0 0",items:[{xtype:"syno_radio",name:"source",itemId:"nfs_fieldtitle_host",boxLabel:_T("nfs","nfs_fieldtitle_host"),inputValue:"single",scope:this,checked:!0,handler:this.OnSourceRadioClick},{xtype:"syno_radio",name:"source",itemId:"firewall_source_network",boxLabel:_T("firewall","firewall_source_network"),inputValue:"subnet",scope:this,handler:this.OnSourceRadioClick}]},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_ipaddr"),name:"source_ip",itemId:"tcpip_ipaddr",vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)&&(this.nextSibling().validate(),!0)}},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_mask"),name:"source_subnet_mask",itemId:"tcpip_mask",maskRe:/[.0-9]/,invalidText:_JSLIBSTR("vtype","bad_mask"),allowBlank:!1,validator:function(e){var t=this.previousSibling().getValue();return Ext.form.VTypes.fwLoosev6ipVal.test(t)?e>=0&&e<=128||_JSLIBSTR("vtype","bad_ipv6prefixLeng"):!!Ext.form.VTypes.netmaskVal.test(e)}}]};return new SYNO.ux.FormPanel(e)},OnSourceRadioClick:function(e,t){if(!e.checked)return!1;switch(e.value){case"single":default:this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable();break;case"subnet":this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").enable()}},setDefault:function(){this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable()},onApply:function(){if(this.form.isValid()){var e,t=this.form.findField("source").getGroupValue();if("single"==t)e=this.form.findField("source_ip").getValue();else{if("subnet"!=t)return;e=String.format("{0}/{1}",this.form.findField("source_ip").getValue(),this.form.findField("source_subnet_mask").getValue())}this.module.ipList.push(e),this.module.store.loadData(this.module.ipList),this.close()}else this.setStatusError({text:_T("common","forminvalid"),clear:!0})}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.RuleList",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.appWin=e.appWin,this.ipList=e.ipList,this.store=new Ext.data.ArrayStore({model:"SYNO.SDS.AdminCenter.AppRulePrivileges.RuleModel",data:this.ipList,expandData:!0,fields:["ip"]}),this.addBtn=new SYNO.ux.Button({itemId:"btn_create",text:_T("autoblock","create_ip_cap"),scope:this,handler:this.launchAddIPDialog}),this.delBtn=new SYNO.ux.Button({itemId:"btn_del",text:_T("common","remove"),scope:this,handler:this.deleteItem,disabled:!0});var t={ds:this.store,loadMask:!0,height:300,enableHdMenu:!1,tbar:{items:[this.addBtn,this.delBtn]}};Ext.apply(t,e),this.callParent([t]),this.mon(this.getSelectionModel(),"selectionchange",this.onSelectionChange,this)},onSelectionChange:function(e){0<e.getCount()?this.delBtn.enable():this.delBtn.disable()},launchAddIPDialog:function(){new SYNO.SDS.AdminCenter.AppRulePrivileges.AddIPDialog({owner:this.appWin,module:this}).open()},deleteItem:function(){var e,t=this.getSelectionModel().getSelections();for(e=0;e<t.length;e++)this.ipList.remove(t[e].get("ip"));this.store.loadData(this.ipList)}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.RuleEditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.blackListTab=new SYNO.SDS.AdminCenter.AppRulePrivileges.RuleList({appWin:this,title:_T("autoblock","autoblock_view_list"),ipList:e.deny_ip.slice(0),columns:[{header:_T("autoblock","autoblock_ip"),id:"ip",dataIndex:"ip",sortable:!0,menuDisabled:!0}]}),this.whiteListTab=new SYNO.SDS.AdminCenter.AppRulePrivileges.RuleList({appWin:this,title:_T("autoblock","autoblock_white_list"),ipList:e.allow_ip.slice(0),columns:[{header:_T("autoblock","autoblock_allow_ip"),id:"ip",dataIndex:"ip",sortable:!0,menuDisabled:!0}]});var t={xtype:"syno_tabpanel",activeTab:0,items:[this.whiteListTab,this.blackListTab]},i={title:_T("autoblock","autoblock_view_rules"),width:600,height:440,items:[t],layout:"fit",buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:function(){this.close()}},{text:_T("common","save"),scope:this,btnStyle:"blue",handler:this.onSave}],listeners:{beforeclose:this.onBeforeClose,scope:this}};Ext.apply(i,e),this.callParent([i]),this.mon(this,"close",(function(){this.module.ownerGrid.loadRules()}),this)},onBeforeClose:function(){return Ext.encode(this.whiteListTab.ipList)===Ext.encode(this.allow_ip)&&Ext.encode(this.blackListTab.ipList)===Ext.encode(this.deny_ip)||(this.confirmLostChangePromise({dontSave:function(){this.allow_ip=this.whiteListTab.ipList,this.deny_ip=this.blackListTab.ipList,this.close()},cancel:function(){return!1},save:this.onSave},this),!1)},onSave:function(){var e,t=[],i={entity_name:this.entity_name,entity_type:this.entity_type,app_id:this.app_id};this.whiteListTab.ipList.length+this.blackListTab.ipList.length===0?e="delete":(e="set",i.allow_ip=this.whiteListTab.ipList,i.deny_ip=this.blackListTab.ipList),t.push(i),this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.AppPriv.Rule",version:1,method:e,params:{rules:t},scope:this,callback:this.onApplyDone})},onApplyDone:function(e,t,i){this.clearStatusBusy(),e?(this.allow_ip=this.whiteListTab.ipList,this.deny_ip=this.blackListTab.ipList,this.close()):this.getMsgBox().alert(this.title,_T("common","error_system"))}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.CustomColumn",{extend:"SYNO.ux.EnableColumn",constructor:function(e){var t=Ext.apply({header:_T("app_privilege","grant_by_ip"),name:void 0,app_id:void 0,ownerGrid:void 0,width:120,align:"center",renderer:function(e,t,i,s,n,o){var a=i.get("name");return!1===i.get("supportIP")?e="disabled":"user"!==i.get("entity_type")||"admin"!==a&&"SynologyCMS"!==a&&"guest"!==a||(e="disabled"),SYNO.SDS.Share.renderCheckBox.call(this,e,t,i)}},e);this.callParent([t])},onCellClick:function(e,t){if(this.isLockCustomSetting)this.owner.getMsgBox().alert(this.title,_T("user","lock_setting"));else{var i=e.store.getAt(t).get("entity_type"),s=e.store.getAt(t).get("entity_name");!1!==e.store.getAt(t).get("supportIP")&&("user"!==i||"admin"!==s&&"SynologyCMS"!==s&&"guest"!==s)&&(!Ext.isFunction(this.ownerGrid.isChanged)||Ext.isFunction(this.ownerGrid.getWebAPI),Ext.isFunction(this.ownerGrid.isChanged)&&Ext.isFunction(this.ownerGrid.getWebAPI)&&this.ownerGrid.isChanged()?this.owner.getMsgBox().confirm(this.owner.title,_T("share","share_save_chg_before_reload"),(function(i){if("yes"===i){this.owner.setStatusBusy({text:_T("common","saving")});this.owner.sendWebAPI({compound:{stopwhenerror:!0,params:this.ownerGrid.getWebAPI()},scope:this,callback:function(i,s,n,o){this.owner.clearStatusBusy(),i?(this.ownerGrid.getStore().commitChanges(),this.launchEditorDialog(e,t)):this.getMsgBox().alert(this.title,SYNO.API.Erros.core[s.code]||_T("common","commfail"))}})}}),this):this.launchEditorDialog(e,t))}},launchEditorDialog:function(e,t){var i=e.store.getAt(t),s=i.get("entity_name"),n=i.get("entity_type"),o=i.get("app_id"),a=[],r=[];if(!0===i.get("custom")){var l,d=e.getAppRules();for(l=0;l<d.length;l++)if(s===d[l].entity_name&&n===d[l].entity_type&&o==d[l].app_id){a=d[l].allow_ip,r=d[l].deny_ip;break}}new SYNO.SDS.AdminCenter.AppRulePrivileges.RuleEditDialog({owner:this.owner,module:this,entity_name:s,entity_type:n,app_id:o,allow_ip:a,deny_ip:r}).open()}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.FilterButton",{extend:"SYNO.ux.Button",constructor:function(e){var t="filter_",i="permission_type",s=[{checked:!0,group:i,itemId:"filter_all",text:_T("common","show_all")},{group:i,itemId:"filter_any",text:_T("share","share_permission_any")},{group:i,itemId:"filter_allow",text:_T("app_privilege","allow_privilege")},{group:i,itemId:"filter_deny",text:_T("app_privilege","deny_privilege")}];e.supportIP&&s.push({group:i,itemId:"filter_custom",text:_T("app_privilege","grant_by_ip")});var n=Ext.apply({currentFilter:"all",itemIdPrefix:t,tooltip:_T("common","filter_label_text"),iconCls:"syno-share-filter-btn",cls:"syno-share-filter-btn-no-marginright",menu:{cls:"syno-ux-check-menu",items:s,defaults:{checked:!1},listeners:{itemclick:this.onItemClick,scope:this}}},e);this.callParent([n])},onItemClick:function(e,t){this.currentFilter=e.itemId.substr(this.itemIdPrefix.length),this.fireEvent("filterChanged",this.currentFilter)},getMenuClass:function(){return""}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.DefaultPanel",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t={title:_T("iscsitrg","iscsitrg_masking_default"),items:[{name:"enable",xtype:"syno_checkbox",boxLabel:_T("app_privilege","grant_default_privilege")},{indent:1,xtype:"syno_displayfield",name:"desc",value:_T("app_privilege","grant_default_privilege_desc"),hideLabel:!0}]};Ext.apply(t,e),this.callParent([t])},initForm:function(e){var t;for(t=0;t<e.length;t++){var i=e[t];if("everyone"===i.entity_type&&"everyone"===i.entity_name)if(1===i.allow_ip.length&&"0.0.0.0"===i.allow_ip[0]&&0===i.deny_ip.length)this.getForm().setValues({enable:!0})}},isDirty:function(){return this.getForm().isDirty()},getWebAPI:function(){var e=[],t=[{entity_type:"everyone",entity_name:"everyone",app_id:this.owner.app_id,allow_ip:["0.0.0.0"]}];return!0===this.getForm().findField("enable").getValue()?e.push({api:"SYNO.Core.AppPriv.Rule",version:1,method:"set",params:{rules:t}}):e.push({api:"SYNO.Core.AppPriv.Rule",version:1,method:"delete",params:{rules:t}}),e},hasForbidDefaultDesktop:function(){return"SYNO.Desktop"===this.owner.app_id&&!1===this.getForm().findField("enable").getValue()}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.PrivGrid",{extend:"SYNO.ux.GridPanel",LOCAL_USER_ROLES:[["local_user",_T("share","share_local_user")]],LOCAL_GROUP_ROLES:[["local_group",_T("share","share_local_group")]],DOMAIN_USER_ROLES:[["domain_user",_T("share","share_domain_user")]],DOMAIN_GROUP_ROLES:[["domain_group",_T("share","share_domain_group")]],LDAP_USER_ROLES:[["ldap_user",_T("share","ldap_user")]],LDAP_GROUP_ROLES:[["ldap_group",_T("share","ldap_group")]],constructor:function(e){this.authType="local",this.pageSize=50,this.store=this.createStore(e),this.appWin=e.owner,this.app_id=e.owner.app_id,this.isStoreReady=!1,this.isNeedRender=!0;var t="user"===e.entity_type,i="group"===e.entity_type;this.allowCol=new SYNO.ux.EnableColumn({header:_T("app_privilege","allow_privilege"),dataIndex:"allow",disableSelectAll:!1,width:120,align:"center",id:"allow",isIgnore:function(e,i){var s=i.get("name");return t&&("admin"===s||"SynologyCMS"===s||"guest"===s)},renderer:function(e,i,s){var n=s.get("name");return!t||"admin"!==n&&"SynologyCMS"!==n&&"guest"!==n||(e="disabled"),SYNO.SDS.Share.renderCheckBox.call(this,e,i,s)}}),this.denyCol=new SYNO.ux.EnableColumn({header:_T("app_privilege","deny_privilege"),dataIndex:"deny",disableSelectAll:!1,width:120,align:"center",id:"deny",isIgnore:function(e,s){var n=s.get("name");return t&&("admin"===n||"SynologyCMS"===n||"guest"===n)||i&&("users"===n||"administrators"===n)&&"SYNO.Desktop"===s.get("app_id")},renderer:function(e,s,n){var o=n.get("name");return!t||"admin"!==o&&"SynologyCMS"!==o&&"guest"!==o||(e="disabled"),!i||"users"!==o&&"administrators"!==o||"SYNO.Desktop"!==n.get("app_id")||e||(e="disabled"),SYNO.SDS.Share.renderCheckBox.call(this,e,s,n)}}),this.advCol=new SYNO.SDS.AdminCenter.AppRulePrivileges.CustomColumn({module:e.module,owner:e.owner,ownerGrid:this,dataIndex:"custom",disableSelectAll:!0,width:120,id:"custom",hidden:!e.supportIP});var s=t?_T("controlpanel","leaf_user"):_T("controlpanel","leaf_group"),n=Ext.apply({module:this,title:s,header:!1,border:!1,height:404,width:750,viewConfig:{emptyText:['<div class="syno-dataview">','<div class="empty-text-wrap">','<div class="empty-text-inner-wrap" style="margin-top:40px">','<div class="empty-text-icon"></div>','<div class="empty-text">',_T("common","no_item"),"</div>","</div>","</div>","</div>"].join("")},ds:this.store,cm:new Ext.grid.ColumnModel({columns:[{id:"name",header:_T("common","name"),dataIndex:"name",width:100,scope:this},this.allowCol,this.denyCol,this.advCol]}),plugins:[this.allowCol,this.denyCol,this.advCol],autoExpandColumn:"name",enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),tbar:this.configTopToolbar(e),bbar:new SYNO.ux.PagingToolbar({store:this.store,pageSize:this.pageSize,displayInfo:!0})},e);this.callParent([n]),this.mon(this,"afterrender",this.definePrivGridBehaviors,this),this.mon(this.typeFilter,"filterChanged",this.onTypeFilterChange,this)},definePrivGridBehaviors:function(){this.mon(this,"cellclick",this.onGridCellClick,this),this.mon(this,"headerclick",(function(e,t,i){var s=e.getColumnModel(),n=s.getColumnId(t);this.onGridHeaderClick.call(this,s.getColumnById(n))}),this)},onTypeFilterChange:function(e){this.store.baseParams.filter_type=e,this.store.load({params:{offset:0}}),this.typeFilter.focus()},restorePermission:function(e,t){var i=e.getChanges();i.hasOwnProperty(t)&&e.set(t,!i[t])},onGridCellClick:function(e,t,i,s){var n=e.getStore().getAt(t),o=e.getColumnModel().getDataIndex(i);(function(e){return"allow"===e||"deny"===e})(o)&&(!0===n.get(o)?function(t,i){"allow"!==t&&(i.set("allow",!1),e.allowCol.checkSelectAll(e.getStore())),"deny"!==t&&(i.set("deny",!1),e.denyCol.checkSelectAll(e.getStore())),"custom"!==t&&i.set("custom",!1)}(o,n):this.restorePermission(n,"custom"))},onGridHeaderClick:function(e){e.box_el&&(e.box_el.hasClass("syno-ux-cb-checked")?("allow"!==e.dataIndex&&(this.allowCol.box_el.removeClass("syno-ux-cb-checked"),this.allowCol.onSelectAll()),"deny"!==e.dataIndex&&(this.denyCol.box_el.removeClass("syno-ux-cb-checked"),this.denyCol.onSelectAll()),this.getStore().each((function(e){e.set("custom",!1)}),this)):this.getStore().each((function(e){this.restorePermission(e,"custom")}),this))},createStore:function(e){var t,i;return"user"===e.entity_type?(t="users",i="user"):(t="groups",i="group"),new SYNO.API.JsonStore({autoDestroy:!0,remoteSort:!0,appWindow:e.owner,api:"SYNO.Core.AppPriv",method:"list",version:2,baseParams:{offset:0,limit:this.pageSize,type:this.authType,app_id:e.owner.app_id,filter_type:"all",rule_type:i},listeners:{exception:{scope:this,fn:this.onListUGException},beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad}},root:t,totalProperty:"total",fields:["name","allow","deny","custom"],defaultSortable:!0,scope:this})},onListUGException:function(e,t,i,s,n,o){this.owner.getMsgBox().alert(this.title,SYNO.API.getErrorString(n)),this===this.owner.get("tab").getActiveTab()&&this.owner.clearStatusBusy()},onBeforeLoad:function(e,t){if(this.isStoreReady=!1,this.isNeedRender=!0,!this.isChanged())return this===this.owner.get("tab").getActiveTab()&&this.appWin.setStatusBusy(),!0;const i=()=>{this.owner.sendWebAPI({compound:{stopwhenerror:!0,params:this.getWebAPI()},scope:this,callback:function(e,i,s,n){if(this.owner.clearStatusBusy(),!e||i.has_fail)return this.owner.getMsgBox().alert(this.title,_T("common","error_system")),!1;this.store.commitChanges(),this.store.load(t),this.loadRules()}})};return this.owner.getMsgBox().confirm(this.title,_T("share","share_save_chg_before_reload"),(function(e){if("yes"!==e)return this.store.rejectChanges(),void this.store.load(t);const s=this.hasForbidSelfGroupRule();if(s){const e=String.format(_T("app_privilege","warning_forbid_self_group"),s.get("entity_name"));this.owner.getMsgBox().confirm(this.title,e,(function(e){if("yes"!==e)return this.store.rejectChanges(),void this.store.load(t);i()}),this)}else i();return!0}),this),!1},onLoad:function(e,t,i){this.isStoreReady=!0,this.clearBusy()},clearBusy:function(){this.isStoreReady&&this.owner.isRuleReady&&this.isNeedRender&&this.renderPrivGrid(),this===this.owner.get("tab").getActiveTab()&&this.owner.clearStatusBusy()},renderPrivGrid:function(){var e,t,i=this.store.getCount(),s=this.owner.appRules;for(e=0;e<i;e++){var n=this.store.getAt(e),o=n.get("name");for(n.beginEdit(),n.set("entity_type",this.entity_type),n.set("entity_name",o),n.set("app_id",this.app_id),n.set("allow",!1),n.set("deny",!1),n.set("custom",!1),t=0;t<s.length;t++){var a=s[t];if(a.entity_type===this.entity_type&&a.entity_name===o){if(1===a.allow_ip.length&&"0.0.0.0"===a.allow_ip[0]&&0===a.deny_ip.length){n.set("allow",!0);break}if(0===a.allow_ip.length&&1===a.deny_ip.length&&"0.0.0.0"===a.deny_ip[0]){n.set("deny",!0);break}n.set("custom",!0);break}}n.endEdit()}this.allowCol.checkSelectAll(this.getStore()),this.denyCol.checkSelectAll(this.getStore()),this.store.commitChanges(),this.isNeedRender=!1},configTopToolbar:function(e){var t=new SYNO.ux.Toolbar({items:[{xtype:"syno_combobox",itemId:"roleFilter",valueField:"role",displayField:"display",store:{xtype:"arraystore",autoDestroy:!0,fields:["role","display"]},mode:"local",triggerAction:"all",editable:!1,forceSelection:!0,width:210,listeners:{beforeselect:{scope:this,fn:this.onRoleFilterSelect}}},"->",{xtype:"syno_displayfield",value:_T("helptoc","directory_service_domain")+": ",hidden:!0,itemId:"domainListLabel"},{xtype:"syno_combobox",itemId:"domainFilter",valueField:"value",displayField:"domain",store:{xtype:"arraystore",autoDestroy:!0,fields:["domain","value","comment"]},hidden:!0,resizable:!0,mode:"local",triggerAction:"all",editable:!1,value:"",forceSelection:!0,tpl:'<tpl for="."><div ext:qtip="{comment}" class="x-combo-list-item">{domain}</div></tpl>',listeners:{beforeselect:{scope:this,fn:this.onDomainFilterSelect}}},this.nameFilter=new SYNO.ux.TextFilter({conStyle:"filter",itemId:"search",queryAction:"list",enumAction:"list",emptyText:_T("user","search_user"),store:this.store,queryParam:"substr",pageSize:this.pageSize}),this.typeFilter=new SYNO.SDS.AdminCenter.AppRulePrivileges.FilterButton({style:"margin-left: 6px",supportIP:e.supportIP})]});return this.roleFilter=t.getComponent("roleFilter"),this.domainFilter=t.getComponent("domainFilter"),this.domainListLabel=t.getComponent("domainListLabel"),t},isSupport:function(e){var t,i=this.owner.grant_type;for(t=0;t<i.length;t++)if(e===i[t])return!0;return!1},onActivate:function(){var e="user"===this.entity_type,t=[];this.roleFilter.getStore().loadData(e?this.LOCAL_USER_ROLES:this.LOCAL_GROUP_ROLES),this.owner.enable_ldap&&this.owner.join_ldap&&this.isSupport("ldap")&&this.roleFilter.getStore().loadData(e?this.LDAP_USER_ROLES:this.LDAP_GROUP_ROLES,!0),this.owner.enable_domain&&this.owner.join_domain&&this.isSupport("domain")&&(this.roleFilter.getStore().loadData(e?this.DOMAIN_USER_ROLES:this.DOMAIN_GROUP_ROLES,!0),this.owner.domain_list.forEach((function(e){"object"==typeof e?e[1]?t.push(e):t.push([_T("directory_service","domainou_list_all_items"),e[1],e[2]]):t.push([e,e,e])})),this.domainFilter.getStore().loadData(t),this.domainFilter.getValue()||this.domainFilter.setValue(t[0][1]||""),this.store.baseParams.domain_name=this.domainFilter.getValue(),1===this.owner.manage_mode?this.domainListLabel.setValue(_T("directory_service","organizational_unit")+": "):this.domainListLabel.setValue(_T("helptoc","directory_service_domain")+": ")),this.showDomainFilter(!1),this.roleFilter.setValue(e?"local_user":"local_group"),this.store.load()},onRoleFilterSelect:function(e,t){var i=t.data.role.split("_")[0];this.prevRole=e.getValue(),"domain"===i?this.showDomainFilter(!0):this.showDomainFilter(!1),this.authType=this.store.baseParams.type=i,this.store.load({params:{offset:0}})},onDomainFilterSelect:function(e,t){this.store.baseParams.domain_name=t.data.value,this.store.load({params:{offset:0}})},showDomainFilter:function(e){this.domainListLabel.setVisible(e),this.domainFilter.setVisible(e)},isChanged:function(){return 0!==this.store.getModifiedRecords().length},getAppRules:function(){return this.owner.isRuleReady?this.owner.appRules:[]},loadRules:function(){this.isNeedRender=!0,this.owner.loadRules()},hasForbidSelfGroupRule:function(){return this.store.getModifiedRecords().find((e=>{const t=this.owner.callerGroups;return"SYNO.Desktop"===e.get("app_id")&&"group"===e.get("entity_type")&&t&&t.includes(e.get("entity_name"))&&!0===e.get("deny")}))},getWebAPI:function(){var e,t=[],i=[],s=this.store.getModifiedRecords(),n=s.length,o=[],a=function(e){return!e.get("allow")&&!e.get("deny")&&!e.get("custom")};if(0===n)return o;for(e=0;e<n;e++){var r=s[e],l={entity_type:r.get("entity_type"),entity_name:r.get("entity_name"),app_id:r.get("app_id")};a(r)?t.push(l):(r.get("allow")?l.allow_ip=["0.0.0.0"]:l.deny_ip=["0.0.0.0"],i.push(l))}return t.length>0&&o.push({api:"SYNO.Core.AppPriv.Rule",version:1,method:"delete",params:{rules:t}}),i.length>0&&o.push({api:"SYNO.Core.AppPriv.Rule",version:1,method:"set",params:{rules:i}}),o}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.appWin=e.appWin,this.app_id=e.app_id,this.isRuleReady=!1,this.isFirstTime=!0,this.userPanel=new SYNO.SDS.AdminCenter.AppRulePrivileges.PrivGrid({entity_type:"user",module:e.module,owner:this,itemId:"userprivgrid",supportIP:e.supportIP}),this.groupPanel=new SYNO.SDS.AdminCenter.AppRulePrivileges.PrivGrid({entity_type:"group",module:e.module,owner:this,itemId:"groupprivgrid",supportIP:e.supportIP}),this.defaultPanel=new SYNO.SDS.AdminCenter.AppRulePrivileges.DefaultPanel({module:e.module,owner:this,itemId:"defaultpanel"});var t=Ext.apply({width:800,height:470,minWidth:550,minHeight:370,layout:"fit",title:e.appName,closeAction:"onCancel",items:[{xtype:"syno_tabpanel",plain:!0,itemId:"tab",activeTab:0,items:[this.userPanel,this.groupPanel,this.defaultPanel]}],buttons:[{text:_T("common","cancel"),scope:this,handler:this.onCancel},{text:_T("common","save"),scope:this,btnStyle:"blue",handler:this.saveAppRulePriv}]},e);this.callParent([t]),e.supportIP||(this.groupPanel.disable(),this.defaultPanel.disable()),1===this.grant_type.length&&"local"===this.grant_type[0]&&this.defaultPanel.disable(),this.loadRules(),this.userPanel.onActivate(),this.groupPanel.onActivate()},loadRules:function(){let e=[];const t="SYNO.Desktop"===this.app_id,i={api:"SYNO.Core.AppPriv.Rule",version:1,method:"list",params:{app_id:this.app_id}},s={api:"SYNO.Core.User.Group",version:1,method:"get",params:{name:_S("user")}};e.push(i),t&&e.push(s),this.isRuleReady=!1,this.sendWebAPI({compound:{stopwhenerror:!0,params:e},scope:this,callback:function(e,n){let o=SYNO.API.Response.GetValByAPI(n,i.api,i.method),a=t?SYNO.API.Response.GetValByAPI(n,s.api,s.method):null;if(!e||n.has_fail){let e=SYNO.API.Errors.core[o.code]||a&&SYNO.API.Errors.core[a.code]||_T("common","error_system");return this.clearStatusBusy(),void this.getMsgBox().alert(this.title,e)}this.callerGroups=a?a.groups:null,this.appRules=o.rules,this.isRuleReady=!0,this.userPanel.clearBusy(),this.groupPanel.clearBusy(),this.isFirstTime&&(this.isFirstTime=!1,this.defaultPanel.initForm(o.rules))}})},isChanged:function(){return this.userPanel.isChanged()||this.groupPanel.isChanged()||this.defaultPanel.isDirty()},onCancel:function(){this.isChanged()?this.getMsgBox().confirm(this.title,_T("common","confirm_lostchange"),(function(e){"leftCustom"===e?this.close():"yes"===e&&this.saveAppRulePriv()}),this,{yes:_T("common","save"),cancel:!0,leftCustom:{text:_T("common","dont_save"),extraStyle:"syno-ux-button-dontsave"}}):this.close()},confirmPromise:async function(e){if(!e)return void Promise.resolve();const t=new Promise(((t,i)=>{this.getMsgBox().confirm(this.title,e,(e=>{"yes"===e?t():i()}),this)}));return await t},checkForbidSelfGroupLoginDSM:function(){return new Promise((e=>{if(!this.groupPanel.isChanged())return void e();const t=this.groupPanel.hasForbidSelfGroupRule();if(!t)return void e();e(String.format(_T("app_privilege","warning_forbid_self_group"),t.get("entity_name")))})).then((e=>this.confirmPromise(e)))},checkForbidDefaultDesktop:function(){return new Promise((e=>{if(!this.defaultPanel.isDirty())return void e();if(!this.defaultPanel.hasForbidDefaultDesktop())return void e();e(_T("app_privilege","warning_forbid_default_priv"))})).then((e=>this.confirmPromise(e)))},saveAppRulePriv:function(){const e=()=>{};this.isChanged()?"SYNO.Desktop"!==this.app_id?this.onSaveAppRulePriv():this.checkForbidSelfGroupLoginDSM().then((()=>this.checkForbidDefaultDesktop())).then((()=>this.onSaveAppRulePriv()),e):this.close()},onSaveAppRulePriv:function(){this.setStatusBusy();var e=[];this.userPanel.isChanged()&&(e=e.concat(this.userPanel.getWebAPI())),this.groupPanel.isChanged()&&(e=e.concat(this.groupPanel.getWebAPI())),this.defaultPanel.isDirty()&&(e=e.concat(this.defaultPanel.getWebAPI())),this.sendWebAPI({compound:{stopwhenerror:!0,params:e},scope:this,callback:this.saveAppRulePrivDone})},saveAppRulePrivDone:function(e,t,i,s){if(this.clearStatusBusy(),e&&!t.has_fail)this.module.loadAppRules(),this.close();else{var n=SYNO.API.Errors.core[t.code]||_T("common","error_system");if(3405===t.code){var o=Ext.id(),a=String.format(n,String.format('<a class="link-font" id="{0}" href="#">',o),"</a>");this.getMsgBox().alert(this.title,a),this.mon(Ext.fly(o),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.SupportForm.Application")}),this)}else this.getMsgBox().alert(this.title,n)}}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.AppGrid",{extend:"SYNO.ux.GridPanel",pageSize:20,constructor:function(e){this.actionEdit=new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",scope:this,handler:function(){var e=this.getSelectionModel().getSelected();e&&this.launchEditDialog(e)}});var t=new Ext.Action({text:_T("acl_editor","permission_viewer"),itemId:"preview",scope:this,handler:function(){this.launchPreviewDialog()}}),i=new Ext.Action({text:_T("iscsitrg","iscsitrg_masking_default"),itemId:"default",scope:this,hidden:!0,handler:function(){this.launchEditDefaultDialog()}});this.tbar=new Ext.Toolbar({defaultType:"syno_button",items:[this.actionEdit,t,i]}),this.groupingstore=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({root:"applications",fields:["name","app_id","grant_type","supportIP","grant_by_default","isInternal"]}),totalProperty:"total",autoDestroy:!0,groupField:"isInternal",groupDir:"DESC"}),this.gridCtxMenu=new SYNO.ux.Menu({items:[{text:_T("common","alt_edit"),scope:this,handler:function(){var e=this.getSelectionModel().getSelected();e&&this.launchEditDialog(e)}}]}),this.addManagedComponent(this.gridCtxMenu);var s=Ext.apply({title:"Privileges",header:!1,border:!1,ds:this.groupingstore,cm:new Ext.grid.ColumnModel([{id:"application",header:_T("user","user_application"),dataIndex:"name",menuDisabled:!0,scope:this},{header:_T("app_privilege","grant_default_privilege"),dataIndex:"grant_by_default",disableSelectAll:!1,align:"center",renderer:function(e){var t=!0===e?"syno-admincenter-media-index-enabled":"";return String.format('<div class="{0}" ></div>',t)}.createDelegate(this)},{header:"Category",dataIndex:"isInternal",hidden:!0,groupRenderer:function(e,t,i){return i.data.isInternal?_T("service","internal_service"):_T("pkgmgr","title_packages")}}]),autoExpandColumn:"application",enableHdMenu:!1,selModel:new Ext.grid.RowSelectionModel({singleSelect:!0}),listeners:{scope:this,rowdblclick:{scope:this,fn:function(e,t,i){var s=this.store.getAt(t);s&&this.launchEditDialog(s)}},rowcontextmenu:this.onClickContexMenu,containercontextmenu:this.onKeyContexMenu},view:new SYNO.ux.GroupingView({showGroupName:!1,enableGroupingMenu:!1})},e);this.callParent([s])},onKeyContexMenu:function(e,t){this.gridCtxMenu.showAt(t.getXY())},onClickContexMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.gridCtxMenu.showAt(i.getXY())},loadAppRules:function(){this.module.appWin.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.AppPriv.App",method:"list",version:3,params:{offset:0,limit:this.pageSize},scope:this,callback:function(e,t){if(!e)return this.module.appWin.getMsgBox().alert(this.title,SYNO.API.getErrorString(t)),void this.module.appWin.clearStatus();this.store.loadData(t),this.store.sort("name","ASC"),this.module.appWin.clearStatus(),this.getSelectionModel().selectFirstRow()}})},launchEditDialog:function(e){new SYNO.SDS.AdminCenter.AppRulePrivileges.EditDialog({owner:this.module.appWin,module:this,appName:e.get("name"),app_id:e.get("app_id"),grant_type:e.get("grant_type"),supportIP:e.get("supportIP"),enable_domain:this.module.enable_domain,enable_ldap:this.module.enable_ldap,join_domain:this.module.join_domain,join_ldap:this.module.join_ldap,domain_list:this.module.domain_list,manage_mode:this.module.manage_mode}).open()},launchPreviewDialog:function(){new SYNO.SDS.AdminCenter.AppRulePrivileges.PreviewDialog({owner:this.module.appWin,module:this}).open()},launchEditDefaultDialog:function(){new SYNO.SDS.AdminCenter.AppRulePrivileges.DefaultPrivDialog({owner:this.module.appWin,module:this}).open()}}),Ext.define("SYNO.SDS.AdminCenter.AppRulePrivileges.Main",{extend:"SYNO.SDS.AdminCenter.Module",enable_domain:!1,enable_ldap:!1,constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.panel=new SYNO.SDS.AdminCenter.AppRulePrivileges.AppGrid({module:this,title:_T("tree","leaf_appprivilege")})},loadTypeStatus:function(){var e=[];SYNO.API.GetKnownAPI("SYNO.Core.Directory.Domain")&&(e.push({api:"SYNO.Core.Directory.Domain",version:1,method:"get"}),e.push({api:"SYNO.Core.Directory.Domain",version:1,method:"test_dc"}),"yes"===_D("supportdomain")&&e.push({api:"SYNO.Core.Directory.Domain",method:"get_domain_list",version:2})),e.push({api:"SYNO.Core.Directory.LDAP",version:1,method:"get"}),SYNO.API.Request({compound:{stopwhenerror:!0,params:e},scope:this,callback:this.loadTypeStatusHandler})},loadTypeStatusHandler:function(e,t,i,s){this.appWin.isDestroyed||(e&&!t.has_fail?(this.enable_ldap=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.LDAP","get","enable_client"),this.join_ldap=2702===SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.LDAP","get","error"),SYNO.API.GetKnownAPI("SYNO.Core.Directory.Domain")&&(this.enable_domain=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","get","enable_domain"),this.join_domain=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","test_dc","test_join_success"),this.domain_list="yes"===_D("supportdomain")&&SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","get_domain_list","domain_list"),this.manage_mode="yes"===_D("supportdomain")&&SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Directory.Domain","get","manage_mode"))):this.appWin.getMsgBox().alert(this.title,_T("common","error_system")))},getPanel:function(){return this.panel},getHelpParam:function(){return"AdminCenter/application_appprivilege.html"},activate:function(){this.loadTypeStatus(),this.getPanel().loadAppRules()}}),Ext.define("SYNO.SDS.AdminCenter.MediaIndex.IndexFolderEditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.mode=e.mode,this.store=e.store,this.parent=e.parent,this.panel=this.createPanel(),this.form=this.panel.getForm(),this.defaultLabelWidth=100;var t=Ext.apply({module:e.module,cls:"syno-admincenter-media-index",defaultLabelWidth:this.defaultLabelWidth,title:"add"===this.mode?_T("mediaservice","index_folder_create"):_T("mediaservice","index_folder_edit"),width:640,autoHeight:!0,resizable:!1,padding:0,items:[this.panel],buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.close},{xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:this,disabled:"add"===this.mode,id:this.btnApplyId=Ext.id(),handler:"add"===this.mode?this.createHandler:this.editHandler}]},e);this.callParent([t]),this.btnApply=Ext.getCmp(this.btnApplyId),this.btnEditPath=Ext.getCmp(this.editPathBtnId),this.textFolderPath=Ext.getCmp(this.textFolderPathId),this.textName=Ext.getCmp(this.textNameId),this.checkPhoto=Ext.getCmp(this.checkPhotoId),this.checkMusic=Ext.getCmp(this.checkMusicId),this.checkVideo=Ext.getCmp(this.checkVideoId),"edit"===this.mode&&(this.origPath=this.parent.getSelectionModel().getSelected().get("path")),this.textFolderPath.getEl().on("mouseup",this.editPathBtnHandler,this),this.textFolderPath._window=this},onOpen:function(){if("edit"==this.mode){var e=this.panel.getForm(),t=this.parent.getSelectionModel().getSelected();e.setValues({name:t.get("name"),path:t.get("path"),photo:t.get("photo"),music:t.get("music"),video:t.get("video")}),e.clearInvalid()}this.show()},createPanel:function(){var e={trackResetOnLoad:!0,height:155,border:!1,padding:"16px 20px 0px 20px",items:[{xtype:"syno_fieldset",labelWidth:this.defaultLabelWidth,bwrapCfg:{padding:0},items:[{xtype:"syno_textfield",fieldLabel:_T("common","name"),name:"name",width:260,itemId:"name",id:this.textNameId=Ext.id(),maxlength:255,allowBlank:!1,blankText:_T("mediaservice","error_empty_rule_name")},{xtype:"syno_compositefield",items:[{xtype:"syno_textfield",fieldLabel:_T("common","folder"),width:260,name:"path",id:this.textFolderPathId=Ext.id(),readOnly:!0,allowBlank:!1,validateOnBlur:!1,validationEvent:!1,validator:this.validPath,blankText:_T("mediaservice","error_empty_path")},{xtype:"syno_button",id:this.editPathBtnId=Ext.id(),text:_T("common","choose"),scope:this,handler:this.editPathBtnHandler}]},{xtype:"syno_compositefield",fieldLabel:_T("mediaservice","index_folder_index_type"),width:300,items:[{xtype:"syno_checkbox",boxLabel:_T("mediaservice","class_photos"),width:100,name:"photo",id:this.checkPhotoId=Ext.id(),checked:!0},{xtype:"syno_checkbox",boxLabel:_T("mediaservice","class_music"),width:100,name:"music",id:this.checkMusicId=Ext.id(),checked:!0},{xtype:"syno_checkbox",boxLabel:_T("mediaservice","class_video"),width:100,name:"video",id:this.checkVideoId=Ext.id(),checked:!0}]}]}]};return new SYNO.ux.FormPanel(e)},createHandler:function(){var e=this.panel.getForm().findField("path"),t=this.panel.getForm().findField("name"),i=this.textFolderPath.getValue(),s=this.textName.getValue();if(e.isValid()&&t.isValid()){var n=new this.store.recordType({exist:!0,name:"",path:"",photo:"",music:"",video:"",default:!1});this.store.add(n),n.set("name",s),n.set("path",i),n.set("photo",this.checkPhoto.getValue()),n.set("music",this.checkMusic.getValue()),n.set("video",this.checkVideo.getValue()),this.close()}},editHandler:function(){var e=this.panel.getForm().findField("path"),t=this.panel.getForm().findField("name"),i=this.parent.getSelectionModel().getSelected();e.isValid()&&t.isValid()&&(i.set("name",this.textName.getValue()),i.set("path",this.textFolderPath.getValue()),i.set("photo",this.checkPhoto.getValue()),i.set("music",this.checkMusic.getValue()),i.set("video",this.checkVideo.getValue()),this.close())},editPathBtnHandler:function(){void 0===this.dialog&&(this.dialog=new SYNO.SDS.Utils.FileChooser.Chooser({parent:this,owner:this,closeOwnerWhenNoShare:!0,closeOwnerNumber:2,superuser:!0,needrw:!1,usage:{type:"chooseDir"},title:_T("mediaservice","select_folder"),folderToolbar:!0,treeFilter:function(e,t){return!t||"/home"!==t.spath&&"/homes"!==t.spath&&"remote"!==t.mountType},listeners:{scope:this,choose:function(e,t,i){if(this.textFolderPath.setValue(t.path),""===this.textName.getValue()){var s=t.path.split("/");this.textName.setValue(s[s.length-1])}e.close()},close:function(){delete this.dialog}}})),this.dialog.show()},validPath:function(){var e=this._window;return this.getValue()!==e.origPath&&-1!==e.store.findExact("path",this.getValue())?(e.btnApply.setDisabled(!0),_T("mediaservice","error_duplicate_path")):(e.btnApply.setDisabled(!1),!0)}}),SYNO.SDS.AdminCenter.MediaIndex.MAX_RULE=100,Ext.define("SYNO.SDS.AdminCenter.MediaIndex.DirPanel",{extend:"SYNO.ux.GridPanel",constructor:function(e){this.module=e.module,this.url="",this.store=this.createStore(),this.columnModel=this.createColumnModel(),this.isStoreUpdated=!1;var t=Ext.apply({module:e.module,title:_T("mediaservice","index_folder_title"),store:this.store,enableColumnMove:!1,enableHdMenu:!1,hideMode:"offsets",colModel:this.columnModel,selModel:new Ext.grid.RowSelectionModel({singleSelect:!1,listeners:{selectionchange:{fn:this.updateActionGroup,buffer:50,scope:this}}}),tbar:new Ext.Toolbar({defaultType:"syno_button",items:this.getActionGroup().getArray()}),listeners:{rowdblclick:function(){this.openIndexFolderEditDialog("edit")},rowcontextmenu:this.onRowContextMenu,containercontextmenu:this.onContainerContextMenu,scope:this}},e);this.callParent([t]),this.mon(this.store,"onBeforeLoad",this.onBeforeLoad,this)},isDirty:function(){return 0<this.store.getModifiedRecords().length||this.isStoreUpdated},clearDirty:function(){this.store.commitChanges(),this.isStoreUpdated=!1},getContextMenuItem:function(){var e=[];return Ext.each(["edit","delete"],(function(t){e.push(this.actionGroup.get(t))}),this),e},onRowContextMenu:function(e,t,i){var s=new SYNO.ux.Menu({autoDestroy:!0,items:this.getContextMenuItem()}),n=this.getSelectionModel();n.selectRow(t,n.isSelected(t)),s.showAt(i.getXY()),i.preventDefault()},onContainerContextMenu:function(e,t){var i=new SYNO.ux.Menu({items:this.getContextMenuItem()});this.getSelectionModel().hasSelection()&&i.showAt(t.getXY()),t.preventDefault()},getActionGroup:function(){if(this.actionGroup)return this.actionGroup;var e=new Ext.Action({text:_T("common","create"),itemId:"create",scope:this,handler:function(e,t){this.openIndexFolderEditDialog("add")}}),t=new Ext.Action({text:_T("common","alt_edit"),itemId:"edit",disabled:!0,scope:this,handler:function(e,t){this.openIndexFolderEditDialog("edit")}}),i=new Ext.Action({text:_T("common","delete"),itemId:"delete",disabled:!0,scope:this,handler:function(e,t){this.owner.getMsgBox().confirmDelete(_T("mediaservice","index_folder_title"),_T("common","remove_cfrmrmv"),(function(e,t){if("yes"!=e)return!1;var i=this.getSelectionModel().getSelections(),s=0;for(s=0;s<i.length;s++)this.store.remove(i[s])}),this)}});return this.actionGroup=new SYNO.ux.Utils.ActionGroup([e,t,i]),this.actionGroup},createStore:function(){var e=new Ext.data.ArrayStore({autoDestroy:!0,autoLoad:!1,idProperty:"path",fields:["exist","name","path","photo","music","video","default"],listeners:{update:this.updateActionGroup,add:function(){this.isStoreUpdated=!0,this.updateActionGroup()},remove:function(){this.isStoreUpdated=!0,this.updateActionGroup()},beforeload:this.onBeforeLoad,scope:this},load:function(){SYNO.API.Request({api:"SYNO.Core.MediaIndexing.IndexFolder",method:"get",version:"1",scope:this,callback:function(e,t,i){for(var s=[],n=0;n<t.folders.length;n++){s[n]=[],s[n][0]=t.folders[n].exist,s[n][1]=t.folders[n].name,s[n][2]=t.folders[n].path;for(var o=!1,a=!1,r=!1,l=0;l<t.folders[n].types.length;l++)"photo"==t.folders[n].types[l]?o=!0:"music"==t.folders[n].types[l]?r=!0:"video"==t.folders[n].types[l]&&(a=!0);s[n][3]=o,s[n][4]=r,s[n][5]=a,s[n][6]=t.folders[n].default}this.loadData(s,!1),this.parentGridPanel.onAfterLoad()}})}});return e.parentGridPanel=this,e},onBeforeLoad:function(e,t){this.owner.setStatusBusy()},onAfterLoad:function(e,t,i){this.owner.clearStatusBusy(),this.updateActionGroup()},createColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{scope:this,align:"center"},columns:[{id:"name",header:_T("common","name"),dataIndex:"name",sortable:!0,renderer:Ext.util.Format.htmlEncode,align:"left"},{id:"path",header:_T("common","folder"),dataIndex:"path",sortable:!0,width:200,align:"left",renderer:function(e,t,i,s,n,o){var a=Ext.util.Format.htmlEncode(e);return t.attr=String.format('ext:qtip="{0}"',i.data.exist?Ext.util.Format.htmlEncode(a):_T("mediaservice","error_folder_not_exist")),i.data.exist?a:'<span class="red-status">'+a+"</span>"}},{id:"photo",header:_T("mediaservice","class_photos"),dataIndex:"photo",renderer:this.indexTypeRenderer},{id:"music",header:_T("mediaservice","class_music"),dataIndex:"music",renderer:this.indexTypeRenderer},{id:"video",header:_T("mediaservice","class_video"),dataIndex:"video",renderer:this.indexTypeRenderer}]})},getColumnById:function(e){return this.getColumnModel().getColumnById(e)},indexTypeRenderer:function(e,t,i,s,n,o){var a,r;return r=this.getColumnById(t.id).header,a=e?"syno-admincenter-media-index-enabled":"",String.format('<div class="{0}" aria-label="{1}"></div>',a,Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(r+" "+_T("common","enabled"))))},updateActionGroup:function(){var e=this.getActionGroup(),t=this.getStore().getCount(),i=this.getSelectionModel().getCount();e.disableAll(),SYNO.SDS.AdminCenter.MediaIndex.MAX_RULE>t&&e.enable("create"),1===i&&e.enable("edit"),0<i&&e.enable("delete")},openIndexFolderEditDialog:function(e){new SYNO.SDS.AdminCenter.MediaIndex.IndexFolderEditDialog({owner:this.owner,module:this.module,store:this.store,parent:this,mode:e}).open()},saveHandler:function(e,t){this.isDirty()&&(this.owner.setStatusBusy({text:_T("common","saving")}),SYNO.API.Request({api:"SYNO.Core.MediaIndexing.IndexFolder",params:{folders:this.getJsonFolders()},method:"set",version:1,callback:function(e,t,i){this.owner.clearStatusBusy(),e?(this.clearDirty(),this.store.load(),this.owner.setStatusOK()):this.owner.setStatusError(SYNO.API.getErrorString(t.error.code)),this.updateActionGroup()},scope:this}))},getJsonFolders:function(){var e=["name","path","photo","music","video","default"],t=[];return this.store.each((function(i){var s={types:[]};Ext.each(e,(function(e){"photo"==e||"music"==e||"video"==e?!0===i.get(e)&&s.types.push(e):s[e]=i.get(e)})),t.push(s)})),t}}),Ext.define("SYNO.SDS.AdminCenter.MediaIndex.TimeField",{extend:"SYNO.ux.ComboBox",constructor:function(e){this.callParent([this.fillConfig(e)])},fillConfig:function(e){var t={tpl:this.getTpl(),displayField:"display",valueField:"value",triggerAction:"all",mode:"local",width:220,editable:!1};return Ext.apply(t,e),t},getTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item {[values.cls || ""]}" role="option" aria-label="{[this.getDisplayString(values.value)]}" id="{[Ext.id()]}">',"{[this.getDisplayString(values.value, true)]}","</div>","</tpl>",{getDisplayString:this.getDisplayString.createDelegate(this)})},getDisplayString:function(e,t){if(e<24)return String.leftPad(String(e),2,"0")+":00";var i=!0===t?String.format('<span style="padding-left: 6px"> {0} </span>',_T("convert_setting","tomorrow")):"  "+_T("convert_setting","tomorrow");return String.leftPad(String(e-24),2,"0")+":00"+i}}),Ext.define("SYNO.SDS.AdminCenter.MediaIndex.StartTimeField",{extend:"SYNO.SDS.AdminCenter.MediaIndex.TimeField",constructor:function(e){var t,i=[];for(t=0;t<24;++t)i.push([this.getDisplayString(t),t]);var s=new Ext.data.ArrayStore({fields:["display","value"],data:i});this.addManagedComponent(s);var n={store:s};Ext.apply(n,e),this.callParent([n])}}),Ext.define("SYNO.SDS.AdminCenter.MediaIndex.EndTimeField",{extend:"SYNO.SDS.AdminCenter.MediaIndex.TimeField",constructor:function(e){var t=new Ext.data.ArrayStore({fields:["display","value"]});this.addManagedComponent(t);var i={store:t};Ext.apply(i,e),this.callParent([i])},filterStoreWithStartTime:function(e){var t,i=this.getValue();i&&e>=i&&this.setValue(e+1);var s=[];for(t=e+1;t<e+24;++t)s.push([this.getDisplayString(t),t]);this.getStore().loadData(s)}}),Ext.define("SYNO.SDS.AdminCenter.MediaIndex.ServicePanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.mediaIndexingPackages=[],this.initPromises=[],this.has_index_folder=!1,this.is_reindexing=!1;var t=Ext.apply({module:e.module,cls:"syno-admincenter-media-index",itemId:"mediaIndex",useDefaultBtn:!0,header:!1,title:"",items:[this.getMediaIndexingCfg(),this.getConvertSettingsCfg()]},e);this.polling_id=null,this.callParent([t]),this.field_reindex_btn=Ext.getCmp(this.field_reindex_btn),this.field_reindex_msg=Ext.getCmp(this.field_reindex_msg),this.field_app_list=Ext.getCmp(this.field_app_list),this.thumbnail_quality_field=Ext.getCmp(this.thumbnail_quality_id),this.scheduler_enabled_field=Ext.getCmp(this.scheduler_enabled_id),this.week_name_field=Ext.getCmp(this.week_name_id),this.on("afterlayout",(function(e){this.checkEanbleScheduler=new SYNO.ux.Utils.EnableCheckGroup(e.getForm(),"scheduler_enabled",["week","start","end"])}))},setReIndexMsg:function(e){SYNO.ux.DisplayField.superclass.setValue.call(this.field_reindex_msg,e),this.field_reindex_msg.originalValue=this.field_reindex_msg.getValue()},generateReIndexingMsg:function(){return this.hasPackages()?(e=this.has_index_folder?this.is_reindexing?_T("mediaservice","media_data_reindexing"):_T("common","completed"):_T("mediaservice","index_folder_create"),String.format('<p class="blue-status">{0}</p>',e)):"-";var e},updateReIndexingMsg:function(){var e=this.generateReIndexingMsg();this.setReIndexMsg(e)},setReIndexingMsgARIA:function(){this.field_reindex_msg.getEl().setARIA({role:"status",live:"assertive",relevant:"all"}),SYNO.ux.Utils.DescribeGroup(this.field_app_list,this.field_reindex_msg)},getMediaIndexingCfg:function(){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.MediaIndex.Main::indexing::reindexing",collapsible:!0,title:_T("media_index_service","app_name"),items:[{xtype:"syno_displayfield",htmlEncode:!1,value:_T("media_index_service","description_index_service")},{xtype:"syno_displayfield",id:this.field_app_list=Ext.id(),fieldLabel:_T("media_index_service","application_list")},{xtype:"syno_displayfield",id:this.field_reindex_msg=Ext.id(),htmlEncode:!1,fieldLabel:_T("media_index_service","indexing_status")},{xtype:"syno_compositefield",id:this.compositefie_ld=Ext.id(),hideLabel:!0,items:[{xtype:"syno_button",text:_T("mediaservice","index_folder_title"),itemId:"indexing_folder_btn",name:"indexing_folder_btn",scope:this,handler:this.onClickIndexFolderBtn},{xtype:"syno_button",text:_T("service","service_photo_reindex"),id:this.field_reindex_btn=Ext.id(),name:"reindexing_btn",disabled:!0,scope:this,handler:this.onClickReindexBtn}]},{xtype:"syno_displayfield",htmlEncode:!1,value:this.getNoteMessage(_T("media_index_service","note"))}],listeners:{afterlayout:this.setReIndexingMsgARIA,single:!0,scope:this}}},getConvertSettingsCfg:function(){return{xtype:"syno_fieldset",stateId:"SYNO.SDS.AdminCenter.MediaIndex.Main::convert::video",collapsible:!0,title:_T("convert_setting","title"),items:[{xtype:"syno_displayfield",htmlEncode:!1,value:_T("convert_setting","description")},{xtype:"syno_combobox",name:"thumbnail_quality",id:this.thumbnail_quality_id=Ext.id(),webapi:{api:"SYNO.Core.MediaIndexing.ThumbnailQuality",methods:{get:"get",set:"set"},version:1},width:220,fieldLabel:_T("thumb_conv_options","thumb_quality"),value:"normal",displayField:"display",valueField:"value",store:new Ext.data.ArrayStore({fields:["value","display"],data:[["normal",_T("thumb_conv_options","normal_quality")],["high",_T("thumb_conv_options","high_quality")]]})},{xtype:"syno_checkbox",id:this.scheduler_enabled_id=Ext.id(),webapi:{api:"SYNO.Core.MediaIndexing.Scheduler",methods:{get:"get",set:"set"},version:1},boxLabel:_T("convert_setting","scheduler_enabled"),name:"scheduler_enabled"},{xtype:"syno_schedulefield",id:this.week_name_id=Ext.id(),webapi:{api:"SYNO.Core.MediaIndexing.Scheduler",methods:{get:"get",set:"set"},version:1},indent:1,fieldLabel:_T("convert_setting","frequency"),name:"week",allowBlank:!1,editable:!1,width:220},this.getStartTimeField(),this.getEndTimeField()]}},getStartTimeField:function(){return this.start_time_filed||(this.start_time_filed=new SYNO.SDS.AdminCenter.MediaIndex.StartTimeField({name:"start",fieldLabel:_T("convert_setting","start_time"),indent:1,webapi:{api:"SYNO.Core.MediaIndexing.Scheduler",methods:{get:"get",set:"set"},version:1},listeners:{select:function(e,t,i){this.getEndTimeField().filterStoreWithStartTime(t.get("value"))},scope:this}})),this.start_time_filed},getEndTimeField:function(){return this.end_time_filed||(this.end_time_filed=new SYNO.SDS.AdminCenter.MediaIndex.EndTimeField({name:"end",fieldLabel:_T("convert_setting","end_time"),indent:1,webapi:{api:"SYNO.Core.MediaIndexing.Scheduler",methods:{get:"get",set:"set"},version:1}})),this.end_time_filed},getNoteMessage:function(e){return'<span class="syno-ux-note">'+_T("common","note")+": </span>"+e},onClickIndexFolderBtn:function(){var e=this;Ext.isDefined(e.indexFolderGrid)||(e.indexFolderGrid=new SYNO.SDS.AdminCenter.MediaIndex.DirPanel({module:e.module}),this.mon(e.indexFolderGrid.getStore(),"load",this.sendIndexFolderWebapi,this)),Ext.isDefined(e.indexFolderDialog)||(e.indexFolderDialog=new SYNO.SDS.ModalWindow({owner:e.module.appWin,layout:"fit",width:680,resizable:!1,title:_T("mediaservice","index_folder_title"),buttons:[{text:_T("common","alt_close"),scope:this,handler:function(){if(this.indexFolderGrid.isDirty()){var e={dontSave:function(){this.indexFolderDialog.hide()},cancel:Ext.emptyFn,save:function(){this.indexFolderGrid.saveHandler(),this.indexFolderDialog.hide()}};this.indexFolderDialog.confirmLostChangePromise(e,this)}else this.indexFolderDialog.hide()}},{text:_T("common","save"),itemId:"save",btnStyle:"blue",scope:e,handler:function(){this.indexFolderGrid.saveHandler(),this.indexFolderDialog.hide()}}],items:[e.indexFolderGrid],listeners:{scope:this,show:function(){this.indexFolderGrid.owner=this.indexFolderDialog,this.indexFolderGrid.getStore().load()},hide:function(){this.indexFolderGrid.clearDirty()}}})),e.indexFolderDialog.mon(e.indexFolderDialog,"close",(function(){e.indexFolderDialog=void 0,e.indexFolderGrid=void 0})),e.indexFolderDialog.open()},onClickReindexBtn:function(){this.field_reindex_btn.disable(),SYNO.API.Request({params:{},compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.MediaIndexing",method:"reindex",version:1,params:{}}]},scope:this,callback:function(e,t,i){this.appWin.clearStatusBusy(),e?(this.is_reindexing=!0,this.updateReIndexingMsg()):this.onApiFailure("set",t,i)}})},isDirty:function(){return this.thumbnail_quality_field.isDirty()||this.scheduler_enabled_field.isDirty()||this.week_name_field.isDirty()||this.getStartTimeField().isDirty()||this.getEndTimeField().isDirty()},processReturnData:function(e,t,i){"get"===e&&this.processReturnDataGet(t),!1===t.has_fail&&Ext.each(t.result,(function(e){if(!0===e.success&&"SYNO.Core.MediaIndexing.Scheduler"===e.api&&"get"===e.method){var t=[];Ext.each(e.data.week,(function(e,i){e&&t.push(i)}),this);var i=e.data.start.hour;return Ext.apply(e.data,{week:t.join(","),start:i,end:i+e.data.duration,scheduler_enabled:"schedule"===e.data.mode}),this.getEndTimeField().filterStoreWithStartTime(i),!1}}),this),this.callParent(arguments)},processParams:function(e,t){return"set"===e?this.processSetParams(e,t):this.callParent(arguments)},processSetParams:function(e,t){const i={api:"SYNO.Core.MediaIndexing.Scheduler",method:"set",version:1};return t.forEach((e=>{SYNO.ux.Utils.checkApiConsistency(i,e)&&(e.params=this.getSchedulerSetParams(e.params))})),t},getSchedulerSetParams:function(e){if(e.scheduler_enabled){for(var t=[],i=0;i<7;i++)t.push(-1!==e.week.indexOf(i.toString()));return{week:t,start:{hour:e.start},duration:e.end-e.start,mode:"schedule"}}return{mode:"always"}},onApiSuccess:function(e,t){"set"===e&&(t.has_fail?this.module.confirmSaveLostReject&&this.module.confirmSaveLostReject():this.module.confirmSaveLostResolve&&this.module.confirmSaveLostResolve()),this.callParent(arguments)},processReturnDataGet:function(e){const t={api:"SYNO.Core.MediaIndexing.ThumbnailQuality",method:"get",version:1};Ext.each(e.result,(function(e,i){!0===e.success&&SYNO.ux.Utils.checkApiConsistency(e,t)&&this.processReturnDataThumbnailQuailtyGet(e.data)}),this)},processReturnDataThumbnailQuailtyGet:function(e){var t=e.packages;this.mediaIndexingPackages=t,this.updateFieldAppList(t),Promise.all(this.initPromises).then((([e,t])=>{let i=e.folders;this.has_index_folder=Ext.isArray(i)&&i.length>0,this.is_reindexing=t.reindexing})).then((()=>{this.updateReIndexingMsg(),this.field_reindex_btn.setDisabled(!this.hasPackages()||this.is_reindexing)})).catch((e=>{}))},updateFieldAppList:function(e){var t="";if(0===e.length)t=_T("mediaservice","no_media_pacakge");else{for(var i=[],s=0;s<e.length;++s)i[s]=e[s].name;t=i.join(", ")}this.field_app_list.setValue(t),this.field_app_list.originalValue=this.field_app_list.getValue()},hasPackages:function(){return!!(Ext.isArray(this.mediaIndexingPackages)&&this.mediaIndexingPackages.length>0)},polling_callback:function(e,t,i,s){this.appWin.clearStatusBusy(),e?(this.is_reindexing=t.reindexing,this.updateReIndexingMsg(),this.field_reindex_btn.setDisabled(!this.hasPackages()||t.reindexing)):(this.appWin.setStatusError({text:SYNO.API.getErrorString(t),clear:!1}),this.field_reindex_btn.enable())},prepareInitPromises:function(){let e=SYNO.API.RequestPromise({api:"SYNO.Core.MediaIndexing.IndexFolder",method:"get",version:1}),t=SYNO.API.RequestPromise({api:"SYNO.Core.MediaIndexing",method:"status",version:1});this.initPromises=[e,t]},stopPolling:function(){null!==this.polling_id&&(this.pollUnreg(this.polling_id),this.polling_id=null)},startPolling:function(){this.stopPolling(),this.polling_id=this.pollReg({interval:5,immediate:!1,scope:this,webapi:{api:"SYNO.Core.MediaIndexing",method:"status",version:1},status_callback:this.polling_callback})},sendIndexFolderWebapi:function(){SYNO.API.RequestPromise({api:"SYNO.Core.MediaIndexing.IndexFolder",method:"get",version:"1"}).then((e=>{this.has_index_folder=Ext.isArray(e.folders)&&e.folders.length>0,this.updateReIndexingMsg()})).catch((e=>{}))},destroy:function(){var e=this;e.callParent(arguments),Ext.isDefined(e.indexFolderDialog)&&e.indexFolderDialog.close(),e.stopPolling()}}),Ext.define("SYNO.SDS.AdminCenter.MediaIndex.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.callParent(arguments),this.appWin=e.appWin,this.panel=new SYNO.SDS.AdminCenter.MediaIndex.ServicePanel({module:this,appWin:this.appWin})},getPanel:function(){return this.panel},setActivateParams:function(e){},activate:function(e){this.panel.prepareInitPromises(),this.panel.loadForm(),this.panel.startPolling()},deactivate:function(){return this.panel.stopPolling(),!this.panel.isDirty()},confirmCallback:function(e){"no"===e&&this.panel.startPolling()},getHelpParam:function(){return"AdminCenter/application_mediaindexservice_general.html"},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t,this.panel.applyForm()}.bind(this))},confirmLostChangeCancel:function(){this.panel.startPolling()}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.EventEditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t=Ext.namespace(e.app_panel);this.blCreate=!e.task_name,this.EditPanelApp=new t({itemId:"appPanel",title:_T("schedule","task_settings"),owner:this,preloadConfig:e.preloadConfig,isCreateMode:this.blCreate}),this.EditPanelBasic=new SYNO.SDS.AdminCenter.TaskScheduler.EventEditPanelBasic({itemId:"basicPanel",owner:this,blCreate:this.blCreate});var i=[this.EditPanelBasic,this.EditPanelApp];this.tabPanel=new SYNO.ux.TabPanel({itemId:"tabPanel",deferredRender:!1,layoutOnTabChange:!0,activeTab:0,plain:!0,height:450,items:i});var s={title:e.task_name?_T("schedule","edit_task"):_T("schedule","create_task"),width:530,height:550,resizable:!1,items:this.tabPanel,buttons:[{xtype:"syno_button",btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.hClickCancel},{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),text:_T("common","apply"),scope:this,handler:this.applySetting}],listeners:{change_event:this.hChangeEvent,beforeclose:this.onBeforeClose,scope:this}};return Ext.apply(s,e),s},getInvalidTab:function(){return this.EditPanelBasic.getForm().isValid()?this.EditPanelApp.getForm().isValid()?null:this.EditPanelApp:this.EditPanelBasic},applySetting:function(){var e=this.getInvalidTab(),t=this.getComponent("tabPanel");if(null!==e)return t.setActiveTab(e.itemId),void this.setStatusError({text:_T("common","forminvalid"),clear:!0});var i=this.EditPanelBasic.getData(),s=this.EditPanelApp.getData();Ext.apply(i,s),i.operation_type=this.operation_type,i.operation=i[i.operation_type],delete i[i.operation_type],this.task_name&&this.task_name!=i.task_name&&(i.old_task_name=this.task_name);"0"!==Object.keys(i.owner)[0]?this.sendSaveWebAPI(i):this.getMsgBox().confirmDelete("",_T("schedule","msg_warning_before_save_task"),(function(e){"ok"===e&&SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this,(function(e){e&&e.SynoConfirmPWToken?i.SynoConfirmPWToken=e.SynoConfirmPWToken:i.SynoConfirmPWToken="",this.sendSaveWebAPI(i)}))}),this,{ok:{text:Ext.MessageBox.buttonText.ok,btnStyle:"red"},cancel:{text:Ext.MessageBox.buttonText.cancel}})},sendSaveWebAPI(e){const t="0"===Object.keys(e.owner)[0];this.setStatusBusy(),this.sendWebAPI({api:t?"SYNO.Core.EventScheduler.Root":"SYNO.Core.EventScheduler",method:this.task_name?"set":"create",version:1,params:e,callback:function(e,t,i){this.clearStatusBusy(),e?(this.doClose(),this.owner_grid.loadData()):t.errors&&"DUPLICATE_PRIMARY_KEY"==t.errors?(this.tabPanel.setActiveTab(this.EditPanelBasic),this.EditPanelBasic.getForm().findField("task_name").markInvalid(_T("schedule","msg_duplicate_name")),this.setStatusError({text:_T("common","forminvalid"),clear:!0})):this.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this)},scope:this})},onBeforeClose(){if(this.blCreate||!this.isDirty())return!0;let e={save:()=>{this.applySetting()},cancel:Ext.emptyFn,dontSave:()=>{this.doClose()}};return this.confirmLostChangePromise(e,this),!1},hClickCancel(){this.close()},isDirty:function(){return this.tabPanel.items.getRange().some((e=>Ext.isFunction(e.isDirty)&&e.isDirty()))},hChangeEvent:function(){var e=this.EditPanelBasic.getForm().findField("event").getValue();this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.EventScheduler",method:"list",version:1,params:{event:e},callback:function(e,t,i){if(this.clearStatusBusy(),e){t=t||[],this.EditPanelBasic.dependSb.clearValue(),this.EditPanelBasic.dependSb.setDisabled(Ext.isEmpty(t));for(var s=[],n=0;n<t.length;++n)s.push([t[n].task_name]);this.EditPanelBasic.relate_store.loadData(s)}else this.getMsgBox().alert("error","list tasks error",null,this)},scope:this})},onOpen:function(){this.loadTask(this.task_name),this.callParent()},loadTask:function(e){this.setStatusBusy();var t,i={api:"SYNO.Core.User",method:"list",params:{additional:["uid"]},version:1},s={api:"SYNO.Core.EventScheduler",method:"event_list",version:1},n={api:"SYNO.Core.EventScheduler",method:"list_relate",version:1,params:{task_name:e,relate_type:2}},o={api:"SYNO.Core.EventScheduler",method:"get",version:1,params:{task_name:e}};t=this.blCreate?[i,s,{api:"SYNO.Core.EventScheduler",method:"list",version:1,params:{event:"bootup"}}]:[i,s,n,o],this.sendWebAPI({compound:{stopwhenerror:!0,params:t},scope:this,callback:function(e,t,i){this.clearStatusBusy(),e&&!t.has_fail?this.loadSuccess(t.result):this.getMsgBox().alert(_T("schedule","load_task"),_T("schedule","load_task_error"),this.close,this)}})},loadSuccess:function(e){var t,i,s={},n=e[0],o=e[1],a=e[2];if(!this.blCreate){var r=e[3];for(i in Ext.apply(s,r.data),s[this.operation_type]=s.operation,s.owner)s.owner.hasOwnProperty(i)&&(s.owner=i)}var l=s.depend_on_task;for(s.depend_on_task=s.depend_on_task?l.substring(1,l.length-1).split("]["):[],s.depend_on_task_list=[],t=0;t<s.depend_on_task.length;++t)s.depend_on_task_list.push([s.depend_on_task[t]]);if(a.data)for(t=0;t<a.data.length;++t)s.depend_on_task_list.push([a.data[t].task_name]);if(s.users=[{uid:0,name:"root"}].concat(n.data.users),s.event_list=[],this.event_obj=o.data,o.data)for(i in o.data)o.data.hasOwnProperty(i)&&s.event_list.push([_T("schedule",i),i]);this.EditPanelBasic.setData(s),this.EditPanelApp.setData(s)}}),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.EventEditPanelBasic",{extend:"SYNO.ux.FormPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.mon(this.dependSb,"additem",this.updateScroller,this),this.mon(this.dependSb,"removeitem",this.updateScroller,this)},fillConfig:function(e){this.event_store=new Ext.data.SimpleStore({fields:["event_name_list","event_list"]}),this.relate_store=new Ext.data.SimpleStore({fields:["depend_on_task_list"]}),this.owner_store=new Ext.data.Store({reader:new Ext.data.JsonReader({root:"users"},["uid","name"])});var t={trackResetOnLoad:!0,title:_T("schedule","basic_info"),hideBorders:!0,autoFlexcroll:!0,items:[{xtype:"syno_fieldset",title:_T("vpnc","basic_setting"),items:[{xtype:"syno_textfield",vtype:"schedulertaskname",allowBlank:!1,emptyText:"Task name",fieldLabel:_T("localbkp","localbkp_bkpset_name"),name:"task_name",width:200,maxLength:128,itemId:"task_name"},this.ownerCb=new SYNO.ux.ComboBox({triggerAction:"all",width:200,fieldLabel:_T("common","owner"),name:"owner",editable:!1,allowBlank:!1,valueField:"uid",displayField:"name",mode:"local",valueNotFoundText:"",store:this.owner_store}),this.eventCb=new SYNO.ux.ComboBox({triggerAction:"all",width:200,fieldLabel:_T("schedule","event"),name:"event",editable:!1,valueField:"event_list",displayField:"event_name_list",allowBlank:!1,disabled:!e.blCreate,mode:"local",store:this.event_store,listeners:{select:function(e,t,i){this.owner.fireEvent("change_event",this)},scope:this}}),this.dependSb=new SYNO.ux.SuperBoxSelect({name:"depend_on_task",fieldLabel:_T("schedule","depend_on"),store:this.relate_store,mode:"local",width:200,editable:!1,htmlEncode:!0,displayField:"depend_on_task_list",valueField:"depend_on_task_list"}),{xtype:"syno_checkbox",hidden:!e.blCreate,boxLabel:_T("common","enabled"),name:"enable"}]}]};return Ext.apply(t,e),t},getData:function(){var e=this.getForm().getValues();e.enable="true"===e.enable,e.depend_on_task?Ext.isString(e.depend_on_task)?0!==e.depend_on_task.length&&(e.depend_on_task="["+e.depend_on_task+"]"):e.depend_on_task="["+e.depend_on_task.join("][")+"]":e.depend_on_task="",e.event=this.eventCb.getValue();var t=this.ownerCb.getValue(),i=this.ownerCb.findRecord("uid",t);return e.owner={},e.owner[t.toString()]=i.get("name"),e},setData:function(e){this.owner_store.loadData(e),this.relate_store.loadData(e.depend_on_task_list||[]),this.event_store.loadData(e.event_list),Ext.isDefined(e.enable)||(e.enable="true"),this.getForm().setValues(e),this.blCreate&&(this.ownerCb.setValue(this.getUserUid(e.users)),this.eventCb.setValue("bootup")),this.dependSb.setDisabled(Ext.isEmpty(e.depend_on_task_list))},getUserUid(e){const t=_S("user"),i=e.find((e=>e.name===t));return i&&Ext.isNumber(i.uid)?i.uid:0},isValid:function(){return this.getForm().isValid()},isDirty:function(){return this.getForm().isDirty()}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.ViewDetail",{extend:"SYNO.SDS.ModalWindow",textValue:"",constructor:function(e){let t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){let t={title:e.fieldLabel,cls:"syno-task-scheduler-status-detail",width:720,height:580,resizable:!1,items:[this.formPanel=new SYNO.ux.FormPanel({height:492,cls:"syno-task-scheduler-status-detail-formpanel",items:[{xtype:"syno_button",text:_T("schedule","copy_all"),scope:this,handler:this.hCopy},{xtype:"syno_textarea",cls:"syno-task-scheduler-status-detail-textarea",ref:"../textArea",hideLabel:!0,emptyText:_T("schedule","msg_no_data"),width:680,height:412,readOnly:!0,value:e.textValue}]})],buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","close"),scope:this,handler:this.hClose}]};return Ext.apply(t,e),t},hClose:function(){this.close()},hCopy:function(){this.textArea.el.dom.select(),document.execCommand("copy");new SYNO.SDS.ToastBox({text:_T("schedule","copy_to_clipboard"),owner:this,delay:2500}).show()}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.EventViewDialog",{extend:"SYNO.SDS.ModalWindow",DESC_HEIGHT:136,constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.result_store=new Ext.data.ArrayStore({fields:["result_id","start_time"],data:[]}),this.selectCb=new SYNO.ux.ComboBox({xtype:"syno_combobox",width:200,editable:!1,mode:"local",triggerAction:"all",fieldLabel:_T("schedule","select_result"),displayField:"start_time",valueField:"result_id",store:this.result_store,listeners:{scope:this,select:this.hSelect}});var t={title:_T("schedule","title_run_result"),width:530,height:622,resizable:!1,items:[this.form=new SYNO.ux.FormPanel({height:472,indent:1,items:[this.selectCb,{xtype:"syno_displayfield",fieldLabel:_T("schedule","exit_status"),name:"exit_code"},{xtype:"syno_displayfield",fieldLabel:_T("schedule","start_time"),name:"start_time"},{xtype:"syno_displayfield",fieldLabel:_T("schedule","stop_time"),name:"stop_time"},{xtype:"syno_displayfield",fieldLabel:_T("schedule","event"),name:"trigger_event"},{xtype:"syno_displayfield",cls:"syno-task-scheduler-status-desc",hidden:!e.enableSaveScriptLog,fieldLabel:_T("schedule","script"),value:_T("schedule","msg_no_data"),name:"script_in",ref:"../script_in",width:290,height:this.DESC_HEIGHT},{xtype:"syno_displayfield",cls:"syno-task-scheduler-status-desc",hidden:!e.enableSaveScriptLog,fieldLabel:_T("schedule","output"),value:_T("schedule","msg_no_data"),name:"script_out",ref:"../script_out",width:290,height:this.DESC_HEIGHT},{xtype:"syno_displayfield",hidden:e.enableSaveScriptLog,hideLabel:!0,htmlEncode:!1,style:{padding:"50px 0 0 0"},value:String.format('<span class="syno-ux-note">{0}{1}</span> {2}',_T("common","note"),_T("common","colon"),_T("schedule","set_script_output_dir"))}]})],buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),scope:this,handler:this.hClickOK}]};return Ext.apply(t,e),t},hClickOK:function(){this.close()},hSelect:function(e,t,i){this.loadResult(i)},onOpen:function(){this.loadResultList(this.task_name),this.callParent([arguments])},loadResultList:function(e){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.EventScheduler",method:"result_list",version:1,params:{task_name:e},scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),e)if(Ext.isArray(t)){t.reverse();for(var s=[],n=0;n<t.length;++n){var o=t[n].start_time;s.push([t[n].result_id,o]),0===n&&this.selectCb.setValue(o)}this.result_store.loadData(s),this.result_list=t,this.loadResult(0)}else this.getMsgBox().alert(_T("schedule","load_task"),_T("schedule","msg_has_not_run_yet"),this.close,this);else this.getMsgBox().alert(_T("schedule","load_task"),_T("schedule","load_task_error"),this.close,this)}})},trimScript:function(e){let t=e.el.dom;if(0==e.getValue().length)return void e.setValue(_T("schedule","msg_no_data"));if(t.scrollHeight<=this.DESC_HEIGHT)return;const i=t.innerHTML;let s=t.innerHTML.substr(0,480);for(;t.scrollHeight>this.DESC_HEIGHT;)s=s.substr(0,s.length-1),t.innerHTML=s+' ... <a class="link-font" href="">'+_T("schedule","view_details")+"</a>";let n=e.el.first("a");n&&this.mon(n,"click",(function(t){t.preventDefault();new SYNO.SDS.AdminCenter.TaskScheduler.ViewDetail({owner:this,textValue:i,title:e.fieldLabel}).open()}),this)},loadResult:function(e){var t=this.result_list[e];this.form.getForm().setValues(t);var i=_T("schedule",t.exit_info.exit_type),s=t.exit_info.exit_code;Ext.isDefined(t.exit_info.exit_code)?this.form.getForm().findField("exit_code").setValue(i+" ("+s+")"):this.form.getForm().findField("exit_code").setValue(i),this.form.getForm().findField("trigger_event").setValue(_T("schedule",t.trigger_event)||t.trigger_event||"Unknown"),this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.EventScheduler",method:"result_get_file",version:1,params:{task_name:t.task_name,result_id:t.result_id},scope:this,callback:function(e,t,i){this.clearStatusBusy(),e&&Ext.isDefined(t)&&(this.form.getForm().setValues(t),this.trimScript(this.script_in),this.trimScript(this.script_out))}})}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.ViewDialog",{extend:"SYNO.SDS.ModalWindow",DESC_HEIGHT:136,constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.result_store=new Ext.data.ArrayStore({fields:["exit_code","exit_type","start_time","stop_time","timestamp"],data:[]}),this.selectCb=new SYNO.ux.ComboBox({xtype:"syno_combobox",width:200,editable:!1,mode:"local",triggerAction:"all",fieldLabel:_T("schedule","select_result"),displayField:"start_time",valueField:"start_time",store:this.result_store,listeners:{scope:this,select:this.hSelect}});var t={title:_T("schedule","title_run_result"),width:530,height:622,resizable:!1,items:[this.form=new SYNO.ux.FormPanel({height:472,items:[this.selectCb,{xtype:"syno_displayfield",fieldLabel:_T("schedule","exit_status"),name:"exit_status"},{xtype:"syno_displayfield",fieldLabel:_T("schedule","start_time"),name:"start_time"},{xtype:"syno_displayfield",fieldLabel:_T("schedule","stop_time"),name:"stop_time"},{xtype:"syno_displayfield",cls:"syno-task-scheduler-status-desc",name:"script_in",ref:"../script_in",hidden:!e.enableSaveScriptLog,fieldLabel:_T("schedule","script"),value:_T("schedule","msg_no_data"),width:288,height:this.DESC_HEIGHT},{xtype:"syno_displayfield",cls:"syno-task-scheduler-status-desc",name:"script_out",ref:"../script_out",hidden:!e.enableSaveScriptLog,fieldLabel:_T("schedule","output"),value:_T("schedule","msg_no_data"),width:288,height:this.DESC_HEIGHT},{xtype:"syno_displayfield",hidden:e.enableSaveScriptLog,hideLabel:!0,htmlEncode:!1,style:{padding:"50px 0 0 0"},value:`<span class="syno-ux-note">${_T("common","note")}${_T("common","colon")}</span> ${_T("schedule","set_script_output_dir")}`}]})],buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),scope:this,handler:this.hClickOK}]};return Ext.apply(t,e),t},hClickOK:function(){this.close()},hSelect:async function(e,t,i){this.setStatusBusy();const s=await this.changeShownTask(this.task_id,t.data);this.clearStatusBusy(),s.msg&&this.showAlertMsgBox(s.msg,s.cb)},changeShownTask:async function(e,t){const{data:i,error:s}=await this.getTaskHistoryLog(e,t.timestamp);return this.refreshFormData({...t,...i}),s},onOpen:function(){this.loadTask(this.task_id),this.callParent([arguments])},showAlertMsgBox(e,t){this.getMsgBox().alert(_T("schedule","load_task"),e,t,this)},loadTask:async function(e){this.setStatusBusy();const t=await this.loadTaskInfo(e);this.clearStatusBusy(),t.msg&&this.showAlertMsgBox(t.msg,t.cb)},loadTaskInfo:async function(e){const{data:t,error:i}=await this.getTaskHistoryStatusList(e);if(i.msg)return i;this.result_store.loadData(t.map((e=>[e.exit_code,e.exit_type,e.start_time,e.stop_time,e.timestamp])));const s=this.result_store.getAt(0).data;return this.selectCb.setValue(s.start_time),await this.changeShownTask(e,s)},getTaskHistoryStatusList:async function(e){const t={data:[],error:{}};try{const i=await synowebapi.promises.request({api:"SYNO.Core.TaskScheduler",method:"get_history_status_list",version:1,params:{id:e}});0===i.length?t.error={msg:_T("schedule","msg_has_not_run_yet"),cb:this.close}:t.data=i}catch(e){t.error={msg:SYNO.SDS.TaskScheduler2.Utils.GetErrorMsgLoad(),cb:this.close}}return t},getTaskHistoryLog:async function(e,t){const i={data:{},error:{}};if(!this.enableSaveScriptLog)return i;try{i.data=await synowebapi.promises.request({api:"SYNO.Core.TaskScheduler",method:"get_history_log",version:1,params:{id:e,timestamp:t}})}catch(e){i.error={msg:_T("schedule","cannot_get_history_log")}}return i},trimScript:function(e){let t=e.el.dom;if(0==e.getValue().length)return void e.setValue(_T("schedule","msg_no_data"));if(t.scrollHeight<=this.DESC_HEIGHT)return;const i=t.innerHTML;let s=t.innerHTML.substr(0,480);for(;t.scrollHeight>this.DESC_HEIGHT;)s=s.substr(0,s.length-1),t.innerHTML=s+' ... <a class="link-font" href="">'+_T("schedule","view_details")+"</a>";let n=e.el.first("a");n&&this.mon(n,"click",(function(t){t.preventDefault();new SYNO.SDS.AdminCenter.TaskScheduler.ViewDetail({owner:this,textValue:i,title:e.fieldLabel}).open()}),this)},refreshFormData:function(e){this.form.getForm().setValues(e),this.trimScript(this.script_in),this.trimScript(this.script_out);var t=this.form.getForm().findField("exit_status");switch(e.exit_type){case"normal":t.setValue(_T("schedule","normal")+" ("+e.exit_code+")");break;case"error":t.setValue(_T("schedule","status_error"));break;case"stop":t.setValue(_T("schedule","status_stop"));break;case"by_signal":t.setValue(_T("schedule","by_signal")+" ("+e.exit_code+")");break;case"running":t.setValue(_T("schedule","status_running"));break;default:t.setValue(_T("schedule","status_unknown"))}}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.SettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t={title:_T("schedule","setting"),width:561,height:240,resizable:!1,items:[this.form=new SYNO.ux.FormPanel({height:200,padding:"0 0 0 0",items:[{xtype:"syno_checkbox",name:"path_enable",boxLabel:_T("schedule","enable_output_record"),value:!1,listeners:{scope:this,check:this.hCheck}},{xtype:"syno_compositefield",fieldLabel:_T("schedule","output_path"),name:"path_field",hideLabel:!1,indent:1,items:[{xtype:"syno_textfield",name:"path",width:150,readOnly:!0,allowBlank:!1,disabled:!0},this.chooseBtn=new SYNO.ux.Button({text:_T("schedule","select_folder"),handler:this.hChoose,disabled:!0,scope:this})]},{xtype:"syno_displayfield",htmlEncode:!1,value:String.format('<span class="syno-ux-note">{0}: </span>{1}',_T("common","note"),_T("schedule","msg_output_recording"))}]})],buttons:[{xtype:"syno_button",btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.close},{xtype:"syno_button",btnStyle:"blue",text:_T("common","ok"),scope:this,handler:this.hClickOK}]};return Ext.apply(t,e),t},hClickOK:function(){if(this.form.getForm().isValid()){var e=this.form.getForm().findField("path").getValue(),t=this.form.getForm().findField("path_enable").getValue();this.sendWebAPI({api:"SYNO.Core.EventScheduler",method:"config_set",version:1,params:{type:this.type,output_path:e,enable_output:t},scope:this,callback:function(t,i,s){this.clearStatusBusy(),t?Ext.isEmpty(this.output_path)||this.output_path==e?this.close():this.getMsgBox().alert(_T("schedule","task_scheduler"),_T("schedule","msg_output_path_changed"),this.close,this):this.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this)}})}else this.setStatusError({text:_T("common","forminvalid"),clear:!0})},hChoose:function(){new SYNO.SDS.Utils.FileChooser.Chooser({owner:this,usage:{type:"chooseDir"},superuser:!0,treeFilter:function(e,t){return!t||"/home"!==t.spath&&"/surveillance"!==t.spath&&"/homes"!==t.spath},title:_T("schedule","select_folder"),enumColdStorage:!0,folderToolbar:!0,listeners:{scope:this,choose:this.onChooserSelect}}).show()},onChooserSelect:function(e,t){var i=t.path.substr(1);this.form.getForm().findField("path").setValue(i),e.close()},onOpen:function(){this.loadConfig(),this.callParent([arguments])},loadConfig:function(e){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.EventScheduler",method:"config_get",version:1,params:{type:this.type},scope:this,callback:function(e,t,i){if(this.clearStatusBusy(),e){if(t){var s=this.form.getForm();this.output_path=t.output_path,s.findField("path").setValue(t.output_path),s.findField("path_enable").setValue(t.enable_output),t.enable_output&&Ext.isEmpty(t.output_path)&&s.findField("path").markInvalid()}}else this.getMsgBox().alert(_T("schedule","load_task"),_T("schedule","load_task_error"),this.close,this)}})},hCheck:function(e,t){this.form.getForm().findField("path").setDisabled(!t),this.chooseBtn.setDisabled(!t)}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.EnableDialog",{extend:"SYNO.SDS.ModalWindow",openResolve:Ext.emptyFn,constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t,i=[],s=[];for(t=0;t<e.tasks.length;++t)e.tasks[t].enable?i.push(e.tasks[t].task_name):s.push(e.tasks[t].task_name);const n=e=>e.map((e=>Ext.util.Format.htmlEncode(e))).join(",<br>"),o=n(i),a=n(s);var r={title:_T("schedule","title_dialog_save"),closable:!1,width:420,height:200,layout:"fit",cls:"syno-task-scheduler-enabledialog",items:[{xtype:"syno_formpanel",border:!1,items:[{xtype:"syno_displayfield",value:_T("schedule","msg_save_changes")},{xtype:"syno_displayfield",fieldLabel:_T("schedule","enable_tasks"),cls:"ellipsis-content",htmlEncode:!1,hidden:!o,value:o},{xtype:"syno_displayfield",fieldLabel:_T("schedule","disable_tasks"),cls:"ellipsis-content",htmlEncode:!1,hidden:!a,value:a}]}],buttons:[{xtype:"syno_button",btnStyle:"gray",text:_T("common","cancel"),scope:this,handler:function(){this.openResolve("cancel")}},{xtype:"syno_button",btnStyle:"blue",text:_T("common","save"),scope:this,handler:function(){this.openResolve("save")}}]};return Ext.apply(r,e)},openPromise:function(){var e=this;return e.open(),new Promise((function(t){e.openResolve=t})).finally((function(){e.openResolve=Ext.emptyFn,e.close()}))}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.CheckDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.disabledDependencies=[],this.callParent([t])},fillConfig:function(e){var t={title:_T("schedule","title_dialog_check"),closable:!1,width:420,height:300,layout:"fit",items:[{xtype:"syno_formpanel",border:!1,items:[this.message=new SYNO.ux.DisplayField({xtype:"syno_displayfield",htmlEncode:!1})]}],buttons:[{xtype:"syno_button",text:_T("common","discard"),scope:this,handler:this.close},{xtype:"syno_button",btnStyle:"blue",text:_T("schedule","enable_all_dependencies"),scope:this,handler:this.enableAllDependencies}]};return Ext.apply(t,e)},startChecking:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.EventScheduler",method:"list",version:1,params:{sort_by:"task_name",sort_direction:"asc"},callback:function(e,t,i){this.clearStatusBusy(),e?t&&this.checkDependency(t):this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),this.close,this)},scope:this})},enableAllDependencies:function(){var e=[];Ext.each(this.disabledDependencies,(function(t){e.push({api:"SYNO.Core.EventScheduler",method:"set_enable",version:1,params:{task_name:t,enable:!0}})})),this.setStatusBusy(),this.sendWebAPI({scope:this,compound:{params:e},callback:function(e,t,i){this.clearStatusBusy(),e&&!t.has_fail?(this.grid.loadData(),this.close()):this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),this.close,this)}})},checkDependency:function(e){var t,i=[],s={};for(t=0;t<e.length;++t)i.push({api:"SYNO.Core.EventScheduler",method:"list_relate",version:1,params:{task_name:e[t].task_name,relate_type:0}}),s[e[t].task_name]=e[t].enable;this.setStatusBusy(),this.sendWebAPI({scope:this,compound:{params:i},callback:function(t,i,n){if(this.clearStatusBusy(),t&&!i.has_fail){var o,a,r=_T("schedule","msg_will_not_run")+"<br>",l=!0;for(o=0;o<i.result.length;++o)if(Ext.isDefined(i.result[o].data)&&e[o].enable){var d,c=i.result[o].data,h=[],u=[];for(a=0;a<c.length;++a)d=c[a].task_name,-1===h.indexOf(d)&&h.push(d);for(h.sort(),a=0;a<h.length;++a)s[h[a]]||u.push(h[a]);0<u.length&&(l=!1,r+=Ext.util.Format.htmlEncode(e[o].task_name+" ("+u.join(", "))+")<br>",this.disabledDependencies=this.disabledDependencies.concat(u))}this.disabledDependencies=Ext.unique(this.disabledDependencies),l?Ext.isFunction(this.setGridStatusOK)&&this.setGridStatusOK():(this.message.setValue(r),this.open())}else this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),this.close,this)}})}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.DeleteDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t,i,s;for(this.task_names=[],this.related_task_names=[],t=0;t<e.tasks.length;++t){var n=e.tasks[t];if(this.task_names.push(n.task_name),n.is_event&&!Ext.isEmpty(n.related_tasks))for(i=0;i<n.related_tasks.length;++i)s=n.related_tasks[i],-1===this.related_task_names.indexOf(s)&&this.related_task_names.push(s)}var o={closable:!1,draggable:!1,header:!1,elements:"body",padding:"24px 30px 0px",cls:"syno-task-scheduler-deletedialog x-window-dlg",width:420,autoHeight:!0,layout:"fit",items:[{xtype:"syno_formpanel",padding:"0px 8px",border:!1,items:[{xtype:"syno_displayfield",cls:"ellipsis-content",value:this.taskListRender(this.task_names,this.related_task_names),scope:this,htmlEncode:!1},{xtype:"syno_displayfield",cls:"ellipsis-content",value:this.relatedTaskListRender(this.related_task_names),scope:this,hidden:0===this.related_task_names.length,htmlEncode:!1},this.confirmCb=new SYNO.ux.Checkbox({ctCls:"syno-task-scheduler-deletedialog-checkbox-relatedtasks",boxLabel:String.format('<span class="red-status">{0}</span>',_T("schedule","msg_delete_related_tasks")),hidden:0===this.related_task_names.length,htmlEncode:!1})]}],fbar:["->",{xtype:"syno_button",btnStyle:"gray",text:_T("common","cancel"),scope:this,handler:this.close},{xtype:"syno_button",btnStyle:"red",text:_T("common","delete"),width:120,scope:this,handler:this.onOK}]};return Ext.apply(o,e)},taskListRender:function(e,t){if(!Ext.isArray(e)||!Ext.isArray(t))return"";var i,s="",n="",o="";e.length>5?(n="count",o=e.length):n=1===e.length?"sing":"pl";var a=String.format("confirm_delete_task_{0}",n);return i=String.format(_T("schedule",a),o),(e.length<=5||t.length>0)&&(s=this.joinTasksString(e)),String.format("{0}<br>{1}",i,s)},relatedTaskListRender:function(e){return`${_T("schedule","related_tasks")}: <br>${this.joinTasksString(e)}`},joinTasksString:function(e){return e.map((e=>Ext.util.Format.htmlEncode(e))).join(",<br>")},onOK:function(){var e,t=this.confirmCb.getValue(),i=[],s=[],n=[];if(this.tasks.forEach((e=>{e.is_event?n.push(e.task_name):s.push({id:e.id,real_owner:e.real_owner})})),t)for(e=0;e<this.related_task_names.length;++e)-1===n.indexOf(this.related_task_names[e])&&n.push(this.related_task_names[e]);for(Ext.isEmpty(s)||i.push({api:"SYNO.Core.TaskScheduler",method:"delete",version:2,params:{tasks:s}}),e=0;e<n.length;++e)i.push({api:"SYNO.Core.EventScheduler",method:"delete",version:1,params:{task_name:n[e]}});this.setStatusBusy(),this.sendWebAPI({compound:{params:i},callback:function(e,t,i){this.clearStatusBusy(),e?(t.has_fail&&this.getMsgBox().alert(_T("schedule","task_scheduler"),SYNO.SDS.TaskScheduler2.Utils.GetErrorMsgDelete(),null,this),this.grid.loadData()):this.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this)},scope:this}),this.close()}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),SYNO.SDS.AdminCenter.TaskScheduler.CreateApps=function(e){const t="yes"===_D("support_buzzer","no")&&!SYNO.SDS.Utils.isInVirtualDSM()&&"yes"!==_D("dockerdsm","no")&&"yes"!==_D("support_hyper_converged");var i=[{app_key:"script",app_name:_T("common","command_line"),create_form:"SYNO.SDS.TaskScheduler2.Script.FormPanel",app:"SYNO.SDS.TaskScheduler2.Script",simple_edit_form:0,create_btn_text:_T("common","command_line")},{app_key:"recycle",app_name:_T("share","recycle_bin"),create_form:"SYNO.SDS.TaskScheduler2.Recycle.FormPanel",app:"SYNO.SDS.TaskScheduler2.Recycle",simple_edit_form:0,create_btn_text:_T("share","recycle_bin")},{app_key:"report",app_name:_T("report","schedule_report_name"),create_form:"",app:"SYNO.SDS.DataAnalysis",simple_edit_form:0},{app_key:"backup",app_name:_T("backup","backup_replication"),create_form:"",app:"SYNO.SDS.BackupApp.NetBackup",simple_edit_form:0},{app_key:"power",app_name:_T("schedule","power_on_off"),create_form:"",app:"SYNO.SDS.TaskScheduler.AutoPower",simple_edit_form:0},{app_key:"dsmupdate",app_name:_T("schedule","dsm_autoupdate_appname"),create_form:"",app:"SYNO.SDS.TaskScheduler.DSMAutoUpdate",simple_edit_form:0},{app_key:"custom",app_name:"",create_form:"",app:"",simple_edit_form:0},{app_key:"",app_name:"undefined",create_form:"",app:"",simple_edit_form:0}];return t&&i.push({app_key:"beep",app_name:_T("beep","beep_title"),create_form:"SYNO.SDS.TaskScheduler2.Beep.FormPanel",app:"SYNO.SDS.TaskScheduler2.Beep",simple_edit_form:1,create_btn_text:_T("beep","beep_title")}),i.push({app_key:"service",app_name:_T("service","service_subject"),create_form:"SYNO.SDS.TaskScheduler2.Service.FormPanel",app:"SYNO.SDS.TaskScheduler2.Service",simple_edit_form:0,create_btn_text:_T("service","service_subject")}),i.push({app_key:"event_script",app_name:_T("common","command_line"),create_form:"SYNO.SDS.TaskScheduler2.Script.FormPanel",app:"SYNO.SDS.EventScheduler",type:"script",create_btn_text:_T("common","command_line")}),i},Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),SYNO.SDS.AdminCenter.TaskScheduler.getAppInfo=function(e,t){var i;for(i=0;i<t.length;i++)if(e===t[i].app_key)return t[i];return null},Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.TaskForm",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t=Ext.apply({cls:"task-scheduler-form",layout:"fit",padding:"0px",useDefaultBtn:!0,listeners:{activate:{fn:function(){this.gridPanel.fireEvent("activate",this)},scope:this}},items:[this.gridPanel=new SYNO.SDS.AdminCenter.TaskScheduler.TaskPanel(Ext.apply(e,{form:this}))]},e);this.callParent([t])},onActivate:function(){this.gridPanel&&this.gridPanel.onActivate()},applyHandler:function(){this.applyHandlerPromise().catch(Ext.emptyFn)},applyHandlerPromise:function(){return this.gridPanel.hSave()},cancelHandler:function(){this.gridPanel.hReset()}}),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.TaskPanel",{extend:"SYNO.ux.EditorGridPanel",menuIsPop:!1,pageSize:50,constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.btnCreate=this.getAction("create"),this.btnEdit=this.getAction("edit"),this.btnDel=this.getAction("remove"),this.btnRun=this.getAction("run"),this.btnView=this.getAction("view"),this.btnSetting=this.getAction("setting"),this.mon(this.getSelectionModel(),"selectionchange",this.hSelectionChange,this),this.mon(this,"rowcontextmenu",this.onClickContextMenu,this),this.mon(this,"containercontextmenu",this.onKeyContextMenu,this),this.mon(this,"activate",this.onActivate,this),this.mon(this,"rowdblclick",this.onRowDbClick,this),this.checkCMS()},fillConfig:function(e){var t=this;this.owner=e.owner,this.appList=SYNO.SDS.AdminCenter.TaskScheduler.CreateApps(this.owner),this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enable",width:100,align:"center",enableFastSelectAll:!0}),this.columnModel=new Ext.grid.ColumnModel([this.enableColumn,{header:_T("localbkp","localbkp_bkpset_name"),dataIndex:"name",width:150,sortable:!0,renderer:function(e,t){return Ext.util.Format.htmlEncode(e)}},{header:_T("common","user_app"),dataIndex:"type",width:150,sortable:!0,renderer:function(e,i,s){return s.get("app_name")?s.get("app_name"):SYNO.SDS.AdminCenter.TaskScheduler.getAppInfo(e,t.appList).app_name}},{header:_T("common","action"),dataIndex:"action",width:150,id:"action",sortable:!0,renderer:function(e,t){var i=e.replace(/#(.*?):(.*?)#/g,(function(e,t,i){return _T(t,i)}));return t.attr='ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(i))+'"; ext:qwidth=auto',Ext.util.Format.htmlEncode(i)}},{header:_T("schedule","next_trigger_time"),dataIndex:"next_trigger_time",width:150,sortable:!0,renderer:function(e,t,i){if(0===i.get("type").indexOf("event"))return _T("schedule",e);var s=Date.parseDate(e,"Y-n-j G:i");return Ext.isDefined(s)?SYNO.SDS.DateTimeFormatter(s):e}},{header:_T("schedule","task_owner"),dataIndex:"owner",width:150,sortable:!0}]),this.taskStore=new SYNO.API.Store({api:"SYNO.Core.TaskScheduler",method:"list",version:3,appWindow:this,baseParams:{offset:0,limit:this.pageSize},reader:new Ext.data.JsonReader({root:"tasks",idProperty:"",totalProperty:"total"},["enable","owner","id","can_run","can_delete","can_edit","type","name","action","next_trigger_time","app_name","real_owner"]),sortInfo:{field:"next_trigger_time",direction:"asc"},remoteSort:!0,listeners:{scope:this,exception:function(){this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this)},beforeload:function(){this.setStatusBusy()},load:function(){this.remainToggleRec(),this.clearStatusBusy()}},pruneModifiedRecords:!0}),this.modifiedRecords=[],this.addManagedComponent(this.taskStore),[this.create_items,this.create_event_items]=this.constructCreateItems(this.appList),this.createActions();var i=[this.getAction("create"),this.getAction("edit"),this.getAction("run"),{xtype:"syno_button",text:_T("common","action"),scope:this,menu:[this.getAction("remove"),this.getAction("view")]},this.getAction("setting")];this.toolbar=new Ext.Toolbar({defaultType:"syno_button",items:i});var s=[this.getAction("edit"),this.getAction("remove"),this.getAction("run")];this.gridCtxMenu=new SYNO.ux.Menu({items:s}),this.addManagedComponent(this.gridCtxMenu);var n={title:_T("schedule","title_time_based"),header:!1,cm:this.columnModel,ds:this.taskStore,autoExpandColumn:"action",enableHdMenu:!1,height:404,tbar:this.toolbar,bbar:new SYNO.ux.PagingToolbar({store:this.taskStore,displayInfo:!0,pageSize:this.pageSize}),selModel:new Ext.grid.RowSelectionModel,plugins:[this.enableColumn]};return Ext.apply(n,e),n},actions:null,constructCreateItems:function(e){const t=e.filter((e=>{const t=Ext.isString(e.create_form)&&0!==e.create_form.length,i=SYNO.SDS.Utils.isInVirtualDSM()&&"beep"===e.app_key;return t&&!i})),i=e=>0===e.app_key.indexOf("event",0),s=e=>({text:e.create_btn_text,scope:this,handler:this.hCreate.createDelegate(this,[e])}),n=t.filter(i).map(s);return[t.filter((e=>!i(e))).map(s),n]},createActions:function(){var e=function(e,t,i,s,n){return new Ext.Action(Ext.apply({text:e,itemId:t,scope:s,handler:i,disabled:!0},n))};return this.actions={create:e(_T("common","create"),"create",void 0,this,{id:this.idCreateBtn=Ext.id(),menu:new SYNO.ux.Menu({items:[{text:_T("schedule","title_time_based"),hideOnClick:!1,menu:{xtype:"syno_menu",items:this.create_items}},{text:_T("schedule","title_event_based"),hideOnClick:!1,menu:{xtype:"syno_menu",items:this.create_event_items}}]}),disabled:!1}),edit:e(_T("common","alt_edit"),"edit",this.hEdit,this),remove:e(_T("common","delete"),"delete",this.hDelete,this),run:e(_T("common","run"),"run",this.hRun,this),view:e(_T("schedule","view"),"view",this.hView,this),setting:e(_T("schedule","setting"),"setting",this.hSetting,this,{disabled:!1})},this.actions},getAction:function(e){return e in this.actions?this.actions[e]:void SYNO.Debug("no this action: "+e)},onKeyContextMenu:function(e,t){this.gridCtxMenu.showAt(t.getXY())},onClickContextMenu:function(e,t,i){var s=e.getSelectionModel();s.isSelected(t)||s.selectRow(t),this.gridCtxMenu.showAt(i.getXY())},onRowDbClick:function(){var e=this.getSelectionModel(),t=e.getCount(),i=e.getSelections();1===t&&i[0].data.can_edit&&this.hEdit()},hSelectionChange:function(){var e,t=this.getSelectionModel(),i=t.getCount(),s=t.getSelections();this.btnRun.setDisabled(!(1===i&&s[0].data.can_run));var n=0;for(e=0;e<s.length;++e)if(s[e].data.can_delete){n=1;break}0===n||_S("demo_mode")?this.btnDel.disable():this.btnDel.enable(),1===i&&s[0].data.can_edit?this.btnEdit.enable():this.btnEdit.disable(),1!==i||"event_script"!=s[0].data.type&&"script"!=s[0].data.type?this.btnView.disable():this.btnView.enable()},onActivate:function(){this.loadData(!1),this.checkNotificationConfig(),this.checkLogSavingPath()},onLeave:function(){this.stopPollTask()},stopPollTask:function(){this.pollTaskId&&this.pollUnreg(this.pollTaskId)&&(this.pollTaskId=null)},isRecordModified:function(){return 0!==this.taskStore.getModifiedRecords().length},loadData:function(e=!0){e&&(this.modifiedRecords=this.store.getModifiedRecords()),this.taskStore.removeAll(),this.taskStore.load()},loadDataPromise:function(){var e=this;return new Promise((function(t){e.mon(e.taskStore,"load",t,this,{single:!0}),e.loadData()}))},checkNotificationConfig:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Notification.Mail.Conf",method:"get",version:1,callback:function(e,t,i){this.clearStatusBusy(),e&&t?this.show_check_notification=!t.enable_mail:this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this)},scope:this})},checkLogSavingPath:async function(){this.setStatusBusy();try{let e=await this.getScriptLogSavingPath();if(this.clearStatusBusy(),!e)return void this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this);e.enable_output&&Ext.isEmpty(e.output_path)&&this.owner.getMsgBox().confirm("",_T("schedule","msg_no_log_path")).then((e=>{"confirm"===e&&this.hSetting()}))}catch(e){this.clearStatusBusy(),this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this)}},getScriptLogSavingPath:function(){return SYNO.API.RequestPromise({api:"SYNO.Core.EventScheduler",method:"config_get",version:1,params:{type:"esynoscheduler"},scope:this})},isEnableSaveScriptLog:async function(){try{return!0===(await this.getScriptLogSavingPath()).enable_output}catch(e){return!1}},popEditDialog:function(e,t,i,s){const n=s||(-1===e?_S("user"):"");new SYNO.SDS.TaskScheduler2.EditDialog({owner:this.owner,app:t.app,appPanel:t.create_form,simple:t.simple_edit_form,owner_grid:this,task_id:e,real_owner:n,preloadConfig:Ext.apply({show_check_notification:this.show_check_notification},i),basic_limitation:{hide_enable:!!t.hide_enable&&t.hide_enable}}).open()},popEventEditDialog:function(e,t,i){new SYNO.SDS.AdminCenter.TaskScheduler.EventEditDialog({owner:this.owner,owner_grid:this,task_name:e,app_panel:t.create_form,operation_type:t.type,preloadConfig:Ext.apply({show_check_notification:this.show_check_notification},i),basic_limitation:{hide_enable:t.hide_enable||!1}}).open()},hCreate:async function(e){0===e.app_key.indexOf("event",0)?this.popEventEditDialog("",e,{}):this.popEditDialog(-1,e,{})},hEdit:function(){var e=this.getSelectionModel().getSelections(),t=SYNO.SDS.AdminCenter.TaskScheduler.getAppInfo(e[0].data.type,this.appList);0===e[0].data.type.indexOf("event")?this.popEventEditDialog(e[0].data.name,{create_form:t.create_form,type:t.type,hide_enable:!0}):this.popEditDialog(e[0].get("id"),{create_form:t.create_form,app:t.app,hide_enable:!0,simple_edit_form:t.simple_edit_form},{},e[0].get("real_owner"))},hReset:function(){this.taskStore&&this.taskStore.reader&&this.taskStore.reader.jsonData&&this.taskStore.loadData(this.taskStore.reader.jsonData)},applyTaskState:function(e){var t=e.filter((e=>!e.is_event)).map((e=>({id:e.id,real_owner:e.real_owner,enable:e.enable}))),i=e.filter((e=>e.is_event)).map((e=>({api:"SYNO.Core.EventScheduler",method:"set_enable",version:1,params:{task_name:e.task_name,enable:e.enable}})));return this.has_event_tasks=!Ext.isEmpty(i),i.push({api:"SYNO.Core.TaskScheduler",method:"set_enable",version:2,params:{status:t}}),SYNO.API.RequestPromise({compound:{params:i}})},getModifiedTasks:function(){return this.getStore().getModifiedRecords().map((function(e){var t=e.data;return{is_event:0===t.type.indexOf("event"),id:t.id,task_name:t.name,real_owner:t.real_owner,enable:t.enable}}))},onSaveConfirm:function(e){var t=this;return this.setStatusBusy({text:_T("common","saving")}),t.applyTaskState(e).finally((function(){t.clearStatusBusy()})).catch((function(){throw void t.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,t)})).then(t.loadDataPromise.bind(t)).then((function(){t.has_event_tasks?t.hCheck():t.setStatusOK()}))},hSave:function(){if(!this.isRecordModified())return this.setStatusError({text:_T("error","nochange_subject"),clear:!0}),Promise.resolve();if(this.taskStore.getModifiedRecords().some((function(e){return""===e.data.owner})))return this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("schedule","msg_empty_owner_for_enable"),this.close,this),Promise.reject();var e=this.getModifiedTasks(),t=new SYNO.SDS.AdminCenter.TaskScheduler.EnableDialog({owner:this.owner,tasks:e}),i=this;return t.openPromise().then((function(t){return"save"===t?i.onSaveConfirm(e):Promise.reject()}))},hCheck:function(){new SYNO.SDS.AdminCenter.TaskScheduler.CheckDialog({owner:this.owner,grid:this,setGridStatusOK:this.setStatusOK.bind(this)}).startChecking()},hDelete:function(){var e,t=this.getSelectionModel().getSelections(),i=[];for(e=0;e<t.length;++e){var s=t[e].data;0===s.type.indexOf("event")&&s.can_delete&&i.push({api:"SYNO.Core.EventScheduler",method:"list_relate",version:1,params:{task_name:t[e].data.name,relate_type:1}})}this.owner.setStatusBusy(),this.sendWebAPI({compound:{params:i},callback:function(e,t,i){if(this.owner.clearStatusBusy(),e){var s,n,o=this.getSelectionModel().getSelections(),a=[];for(s=0;s<t.result.length;++s){var r=[];if(Ext.isDefined(t.result[s].data))for(n=0;n<t.result[s].data.length;++n)r.push(t.result[s].data[n].task_name);a.push({is_event:!0,task_name:i.compound[s].params.task_name,related_tasks:r})}for(s=0;s<o.length;++s){var l=o[s].data;0!==l.type.indexOf("event")&&l.can_delete&&a.push({is_event:!1,task_name:l.name,real_owner:l.real_owner,id:l.id})}new SYNO.SDS.AdminCenter.TaskScheduler.DeleteDialog({owner:this.owner,grid:this,tasks:a}).open()}else this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),this.close,this)},scope:this})},hRun:function(){for(var e=this.getSelectionModel().getSelections(),t=[],i=0;i<e.length;++i){if(""===e[i].data.owner)return void this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("schedule","msg_empty_owner_for_run"),this.close,this);e[i].data.can_run&&t.push(e[i].data.name)}var s=_T("schedule","confirm_run_task")+"<br>"+t.join(", ");256<s.length&&(s=s.substring(0,255)+" ..."),this.owner.getMsgBox().confirm(_T("schedule","run_task"),s,null,{useHtml:!0}).then((e=>{"confirm"===e&&this.runTasks()}))},runTasks:function(){var e,t=this.getSelectionModel().getSelections(),i=[],s=[],n=[];for(e=0;e<t.length;++e){const n=t[e];n.get("can_run")&&(0===n.get("type").indexOf("event")?s.push(n.get("name")):i.push({id:n.get("id"),real_owner:n.get("real_owner")}))}if(Ext.isEmpty(i)||n.push({api:"SYNO.Core.TaskScheduler",method:"run",version:2,params:{tasks:i}}),!Ext.isEmpty(s))for(e=0;e<s.length;++e)n.push({api:"SYNO.Core.EventScheduler",method:"run",version:1,params:{task_name:s[e]}});this.owner.setStatusBusy(),this.sendWebAPI({compound:{params:n},callback:function(e,t,i){this.owner.clearStatusBusy(),e?(t.has_fail&&this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),SYNO.SDS.TaskScheduler2.Utils.GetErrorMsgRun(),null,this),this.loadData()):this.owner.getMsgBox().alert(_T("schedule","task_scheduler"),_T("common","commfail"),null,this)},scope:this})},hView:async function(){let e,t=this.getSelectionModel().getSelections(),i=await this.isEnableSaveScriptLog();e=0===t[0].data.type.indexOf("event")?new SYNO.SDS.AdminCenter.TaskScheduler.EventViewDialog({owner:this.owner,task_name:t[0].data.name,enableSaveScriptLog:i}):new SYNO.SDS.AdminCenter.TaskScheduler.ViewDialog({owner:this.owner,task_id:t[0].get("id"),enableSaveScriptLog:i}),e.open()},hSetting:function(){new SYNO.SDS.AdminCenter.TaskScheduler.SettingDialog({owner:this.owner,type:"esynoscheduler"}).open()},checkCMS:function(){this.sendWebAPI({api:"SYNO.Core.CMS.Info",method:"get",version:1,callback:function(e,t,i){if(e&&t.joined){var s=this.create_items.map((function(e){return e.text})),n=String.format(_T("schedule","cms_gpo_warn"),s.join(", "));this.owner.getMsgBox().alert(null,n)}},scope:this})},remainToggleRec(){this.modifiedRecords.forEach((e=>{let t=this.store.getRange().find((t=>t.get("id")==e.get("id")&&t.get("real_owner")==e.get("real_owner")));t&&t.set("enable",e.get("enable"))})),this.modifiedRecords=[]},setStatusOK:function(){this.form.setStatusOK(...arguments)},setStatusError:function(){this.form.setStatusError(...arguments)},setStatusBusy:function(){this.form.setStatusBusy(...arguments)},clearStatusBusy:function(){this.form.clearStatusBusy(...arguments)}}),Ext.namespace("SYNO.SDS.AdminCenter.TaskScheduler"),Ext.define("SYNO.SDS.AdminCenter.TaskScheduler.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(){this.callParent()},getHelpParam:function(){return"AdminCenter/system_taskscheduler.html"},getPanel:function(){return this.panel||(this.panel=new SYNO.SDS.AdminCenter.TaskScheduler.TaskForm({owner:this.appWin,module:this})),this.panel},setActivateParams:function(e){if(e&&!0===e.newRecycleBinPolicy){var t=SYNO.SDS.AdminCenter.TaskScheduler.CreateApps(this.appWin),i=SYNO.SDS.AdminCenter.TaskScheduler.getAppInfo("recycle",t),s={};e.share&&(s.share=e.share),this.panel.gridPanel.popEditDialog(-1,i,s)}},activate:function(e){this.setActivateParams(e),this.panel&&this.panel.onActivate()},deactivate:function(){return 0===this.panel.gridPanel.taskStore.getModifiedRecords().length},confirmLostChangeSave:function(){return this.getPanel().applyHandlerPromise()}}),Ext.ns("SYNO.SDS.AdminCenter.CMS"),Ext.define("SYNO.SDS.AdminCenter.CMS.Main",{extend:"SYNO.SDS.AdminCenter.Module",constructor:function(e){this.appWin=e.appWin,this.callParent(arguments),this.panel=new SYNO.SDS.AdminCenter.CMS.FormPanel({module:this})},deactivate:function(){return!this.panel.isDirty()},getPanel:function(){return this.panel},activate:function(){this.panel.loadForm(),this.panel.getInfo()},confirmLostChangeSave:function(){return new Promise(function(e,t){this.confirmSaveLostResolve=e,this.confirmSaveLostReject=t,this.panel.applyHandler()}.bind(this))}}),Ext.define("SYNO.SDS.AdminCenter.CMS.FormPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){var t,i=[],s=[],n=String.format('<span class="syno-ux-note note-font">{0} </span>',_T("common","note")+_T("common","colon"));this.module=e.module,this.delegateStore=new Ext.data.JsonStore({fields:["userNameCache","is_user","description"],autoLoad:!1}),this.delegateGrid=new SYNO.ux.GridPanel({enableHdMenu:!1,padding:"0px",store:this.delegateStore,columns:[{header:_T("cms","title_delegate_name"),dataIndex:"userNameCache",width:.22,renderer:function(e,t,i){return t.css=i.data.is_user?"acl-combo-item-user acl-icon-combo-icon":"acl-combo-item-group acl-icon-combo-icon",t.style="padding-left: 18px",e}},{header:_T("cms","title_delegate_type"),dataIndex:"is_user",width:.2,renderer:function(e){return e?"User":"Group"}},{header:_T("cms","description"),dataIndex:"description",width:.58,renderer:function(e){return e&&e.length?e:"-"}}]}),i.push({xtype:"syno_displayfield",itemId:"cms_server",fieldLabel:_T("cms","joined")}),s.push({xtype:"syno_displayfield",hideLabel:!0,value:_T("notification","cms_enable_desc")}),s.push({xtype:"syno_checkbox",name:"cms_enable",boxLabel:_T("notification","cms_enable"),listeners:{check:this.onCentrilizedNotificationEnableCheck,scope:this}}),this.templateStore=new Ext.data.JsonStore({autoDestroy:!0,root:"available_templates",fields:["template_id","name"],idProperty:"template_id"}),s.push({xtype:"syno_combobox",name:"template_id",indent:1,fieldLabel:_T("notification","rule_template"),disabled:!0,store:this.templateStore,displayField:"name",valueField:"template_id"}),s.push({xtype:"syno_displayfield",hideLabel:!0,name:"rule_note",indent:1,disabled:!0,htmlEncode:!1,value:n+String.format(_T("cms","centrailized_notification_rule_note"),'<a class="link-font" style="cursor:pointer">',"</a>"),listeners:{afterrender:function(e){const t=e.el.first("a");t&&(this.mon(t,"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Notification.Main",tab:"ruleTab"})}),this),e.originalValue=e.getValue())},scope:this}}),s.push({tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",xtype:"syno_button",text:_T("notification","cms_send_test"),synotype:"indent_no_label",indent:1,disabled:!0,id:this.CMSTestBtnId=Ext.id(),scope:this,handler:this.onClickTestMailBtn}),i.push({xtype:"syno_displayfield",itemId:"cms_desc",value:_T("cms","disjoint_desc")}),i.push({xtype:"syno_button",itemId:"cms_leave_btn",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("cms","leave_cms"),handler:function(e,t){this.setStatusBusy({mask:!0}),this.sendWebAPI({api:"SYNO.Core.CMS",version:2,method:"disjoin",params:{from:"SYNO.SDS.AdminCenter.Application"},callback:this.onDeleteServer,button:e,scope:this})},scope:this}),t={padding:"0px",module:e.module,border:!1,frame:!1,autoScroll:!0,header:!1,useDefaultBtn:!0,webapi:{api:"SYNO.Core.Notification.CMS.Conf",version:2,methods:{get:"get",set:"set"},params:{set:{template_id:1,cms_enable:!1}}},items:[{xtype:"syno_fieldset",title:_T("cms","joined"),collapsible:!1,items:i},{xtype:"syno_fieldset",title:_T("notification","cms_enable"),collapsible:!1,items:s},{xtype:"syno_fieldset",cls:"syno-admincenter-cms-delegatefieldset",title:_T("cms","title_tab_delegate"),collapsible:!1,items:[this.delegateGrid]}]},this.callParent([t])},getInfo:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.CMS.Info",version:1,method:"get",params:{additional:["server","delegate"]},callback:function(e,t){var i,s=null;this.clearStatusBusy(),this.body.unmask(),e?(s=this.getCMSDescComponent(),Ext.isEmpty(s)||Ext.isEmpty(t.additional)||Ext.isEmpty(t.additional.server)?this.body.mask(_T("common","error_system"),"syno-ux-mask-info"):(Ext.isEmpty(t.additional.server.host)?(this.serverHost="",i=_T("cms","disjointed"),this.body.mask(_T("cms","disjointed"),"syno-ux-mask-info")):(this.serverHost=t.additional.server.host||"",i=this.serverHost,i+=" (",Ext.isEmpty(t.additional.server.connect_status)||"fail"!==t.additional.server.connect_status?i+=_T("cms","status_connected"):i+=_T("cms","connect_failed"),i+=")"),s.setValue(i),s.originalValue=i,this.delegateStore.loadData(t.additional.delegate,!1),this.delegateGrid.setHeight(29+29*t.additional.delegate.length+2),this.doLayout())):this.body.mask(_T("common","error_system"),"syno-ux-mask-info")},scope:this})},getCMSDescComponent:function(){return void 0!==this.cmsDescCmp||(this.cmsDescCmp=null,this.findBy((function(e){"cms_server"===e.itemId&&(this.cmsDescCmp=e)}),this)),this.cmsDescCmp},processReturnData:function(e,t,i){var s=SYNO.API.Response.GetValByAPI(t,"SYNO.Core.Notification.CMS.Conf","get");this.templateStore.loadData(s),this.superclass().processReturnData.apply(this,[e,t,i]),t.has_fail?this.module.confirmSaveLostReject&&this.module.confirmSaveLostReject():this.module.confirmSaveLostResolve&&this.module.confirmSaveLostResolve()},onCentrilizedNotificationEnableCheck:function(e,t,i){this.form.findField("template_id").setDisabled(!t),this.form.findField("rule_note").setDisabled(!t),Ext.getCmp(this.CMSTestBtnId).setDisabled(!t)},onDeleteServer:function(e,t,i,s){var n;this.clearStatusBusy(),e?(Ext.isObject(s.button)&&s.button.setDisabled(!0),n=this.getCMSDescComponent(),Ext.isEmpty(n)||(n.setValue(_T("cms","disjointed")),n.originalValue=_T("cms","disjointed"),this.body.mask(_T("cms","disjointed"),"syno-ux-mask-info"))):1010===t.code?this.module.appWin.getMsgBox().alert("",String.format(_T("cms","computing_not_allow_disable"),t.errors.registered_shares)):this.setStatusError()},onClickTestMailBtn:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Notification.CMS",method:"send_test",version:1,scope:this,params:{},callback:function(e,t,i){var s=e?String.format(_T("notification","cms_test_notification_sent"),this.serverHost):_T("common","error_system");this.module.appWin.getMsgBox().alert(_T("notification","cms_send_test"),s),this.clearStatusBusy()}})},isDirty:function(){return this.getForm().isDirty()}}),function(){"use strict";var e={n:function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,{a:i}),i},d:function(t,i){for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}},t=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("v-app-instance",{attrs:{"syno-id":"SYNO.SDS.AdminCenter.Application","class-name":"SYNO.SDS.AdminCenter.Application"},on:{openparamchanged:e.onOpenParamChanged}},[i("v-page-list-app-window",{ref:"appWindow",staticClass:"syno-app-admin-center",attrs:{"syno-id":"SYNO.SDS.AdminCenter.Application",width:"1150",height:"652","min-width":"1020","min-height":"440",resizable:"","before-close":e.beforeClose,"help-params":e.helpParams,"show-modules":!e.isHomeScreen&&"auto","show-hamburger-icon":!e.isHomeScreen&&"auto","window-name":"SYNO.SDS.AdminCenter.Application"},on:{"window-resize":e.onResizeWindow},scopedSlots:e._u([{key:"module-list-toolbar-wrapper",fn:function(){return[i("v-toolbar",[i("v-button",{attrs:{"syno-id":"home-button",display:"icon"},on:{click:e.onClickHome},scopedSlots:e._u([{key:"icon",fn:function(){return[i("v-icon",{attrs:{name:"admin-center-home","svg-icon-set":"set01"}})]},proxy:!0}])}),e._v(" "),i("search-box")],1)]},proxy:!0},{key:"module-options",fn:function(){return e._l(e.validAppLists,(function(t){return i("v-module-list-section",{key:t.text,attrs:{display:e.getTitle(t)}},e._l(t.items,(function(t){return i("v-module-list-option",{key:t.fn,attrs:{value:t.fn,display:e.getTitle(t),icon:e.getIcon(t)},scopedSlots:e._u([{key:"icon-inner",fn:function(){return[i("badge",{attrs:{dot:"",value:e.badges[t.fn]}})]},proxy:!0}],null,!0)})})),1)}))},proxy:!0},{key:"default",fn:function(){return[e.isHomeScreen?i("home-screen",{on:{"click-module":e.onClickModule}}):i("page-screen",{ref:"page-screen"})]},proxy:!0}])})],1)};t._withStripped=!0;var i=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("v-space",{staticClass:"home-screen",attrs:{direction:"column","align-item":"start",spacing:"none"}},[i("div",{staticClass:"search-box-wrapper"},[i("search-box",{staticClass:"home-screen-search-box",attrs:{width:360}})],1),e._v(" "),i("v-scrollbar",{staticClass:"app-modules-scrollbar"},[i("v-space",{staticClass:"app-modules-wrapper",attrs:{direction:"column","align-item":"start",spacing:"none"}},e._l(e.validAppLists,(function(t){return i("v-fieldset",{key:t.text,staticClass:"app-module-fieldset",attrs:{collapsible:!1,title:e.getTitle(t)},nativeOn:{focus:function(i){return e.onFieldsetFocus(t)},keydown:[function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"right",39,t.key,["Right","ArrowRight"])||"button"in t&&2!==t.button?null:e.selectNext.apply(null,arguments)},function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"down",40,t.key,["Down","ArrowDown"])?null:e.selectNext.apply(null,arguments)},function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"left",37,t.key,["Left","ArrowLeft"])||"button"in t&&0!==t.button?null:e.selectPrev.apply(null,arguments)},function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"up",38,t.key,["Up","ArrowUp"])?null:e.selectPrev.apply(null,arguments)}]}},[i("v-space",{staticClass:"module-items-wrapper",attrs:{spacing:"none","justify-content":"start"}},e._l(t.items,(function(t){return i("div",{key:t.text,ref:"module-item-"+t.fn,refInFor:!0,staticClass:"module-item",attrs:{fn:t.fn,"aria-labelledby":t.fn,tabindex:"0"},on:{click:function(i){return e.onClickModuleIcon(t)},keypress:function(i){return!i.type.indexOf("key")&&e._k(i.keyCode,"enter",13,i.key,"Enter")?null:e.onClickModuleIcon(t)},keydown:[function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"right",39,t.key,["Right","ArrowRight"])||"button"in t&&2!==t.button?null:(t.stopPropagation(),e.selectNext.apply(null,arguments))},function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"down",40,t.key,["Down","ArrowDown"])?null:(t.stopPropagation(),e.selectNext.apply(null,arguments))},function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"left",37,t.key,["Left","ArrowLeft"])||"button"in t&&0!==t.button?null:(t.stopPropagation(),e.selectPrev.apply(null,arguments))},function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"up",38,t.key,["Up","ArrowUp"])?null:(t.stopPropagation(),e.selectPrev.apply(null,arguments))}],focus:function(i){return e.onModuleFocus(t.fn)}}},[i("v-icon",{staticClass:"module-item-icon",style:e.getIconStyle(t),attrs:{type:"bkg-img",size:[48,48]}},[i("transition",{attrs:{appear:"",name:"bounce"}},[i("badge",{attrs:{value:e.badges[t.fn]}})],1)],1),e._v(" "),i("div",{staticClass:"module-item-title",attrs:{id:t.fn}},[e._v("\n\t\t\t\t\t\t\t"+e._s(e.getTitle(t))+"\n\t\t\t\t\t\t")])],1)})),0)],1)})),1)],1)],1)};i._withStripped=!0;var s=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("v-single-select",{ref:"select",staticClass:"admin-center-search-box",attrs:{"syno-id":"admin-center-select-box",placeholder:e.$i18n("log","search"),search:e.onSearch,width:e.width,"max-height":374,"group-options":{result:{title:e.$i18n("common","search_results")}},"display-field":"title","value-field":"id","custom-dropdown-cls":"admin-center-search-box-dropdown",clearable:""},on:{select:e.onSelect},scopedSlots:e._u([{key:"inner-option",fn:function(t){var s=t.option;return[i("v-icon",{staticClass:"option-icon",style:e.getIconStyle(s),attrs:{size:[16,16],type:"bkg-img"}}),e._v(" "),i("div",{staticClass:"option-title"},[e._v(e._s(s.title))])]}}])})};s._withStripped=!0;var n=Vuex,o=e.n(n),a=window["syno-vue-components"],r={mounted(){this.$parent.$options.app?this.$options.app=this.$parent.$options.app:this.$options.app=function e(t){return t?"AdminCenterApp"==t.$options.name?t:e(t.$parent):null}(this.$parent),this.$parent.$options.appWindow?this.$options.appWindow=this.$parent.$options.appWindow:this.$options.appWindow=function e(t){return t?t.$refs.appWindow?t.$refs.appWindow:e(t.$parent):null}(this.$parent)}};function l(e,t,i,s,n,o,a,r){var l,d="function"==typeof e?e.options:e;if(t&&(d.render=t,d.staticRenderFns=i,d._compiled=!0),s&&(d.functional=!0),o&&(d._scopeId="data-v-"+o),a?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),n&&n.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(a)},d._ssrRegister=l):n&&(l=r?function(){n.call(this,this.$root.$options.shadowRoot)}:n),l)if(d.functional){d._injectStyles=l;var c=d.render;d.render=function(e,t){return l.call(t),c(e,t)}}else{var h=d.beforeCreate;d.beforeCreate=h?[].concat(h,l):[l]}return{exports:e,options:d}}var d=l({mixins:[r],props:{width:{type:Number,default:360}},computed:{...(0,n.mapGetters)(["validModules"])},methods:{getAppName:e=>SYNO.SDS.Utils.GetAppTitle(e.owner),doUISearch:async e=>(await synowebapi.promises.request({api:"SYNO.Core.UISearch",method:"uisearch",version:1,params:{lang:_S("lang"),type:"app",query:e}})).items,doSUSSearch:async e=>(await synowebapi.promises.request({api:"SYNO.Finder.AppIndexing.Search",method:"search",version:1,params:{keyword:e,search_weight_list:[{field:"SYNOMDWildcard",weight:1},{field:"keywords",weight:5},{field:"search_title",weight:10}],from:0,size:10,lang:_S("lang")}})).hits.map((e=>({...e,type:"app",desc:a.fn.formatString(e.desc,_D("product"))}))),parseHitItemFn(e){var t;const i=SYNO.SDS.Utils.ParseSearchID(e);return null!==(t=i.params)&&void 0!==t&&t.fn?i.params.fn:""},async onSearch(e){if(!e)return{};try{const t=SYNO.SDS.StatusNotifier.isAppEnabled("SYNO.Finder.Application");let i=await(t?this.doSUSSearch(e):this.doUISearch(e));const s=new Set(this.validModules.map((e=>e.fn)));return i=i.filter((e=>{const t=this.parseHitItemFn(e.id);return"SYNO.SDS.AdminCenter.Application"===e.owner&&s.has(t)})),{result:{options:i}}}catch(e){}},async onSelect(e){if("app"===e.type){var t;const s=SYNO.SDS.Utils.ParseSearchID(e.id);var i;null!==(t=s.params)&&void 0!==t&&t.fn&&(null===(i=this.$options.app)||void 0===i||i.startModule(s.params.fn,s.params))}this.$refs.select.clear()},getIconStyle(e){const t=SYNO.SDS.Utils.GetAppIcon(e.owner||SYNO.SDS.Utils.ParseSearchID(e.id).className,"TreeIcon");return{backgroundImage:"url(".concat(t,")")}}}},s,[],!1,null,null,null);d.options.__file="src/components/search-box.vue";var c=d.exports,h=function(){var e=this.$createElement,t=this._self._c||e;return this.hasBadge?t("div",{staticClass:"admin-center-tray-notify-badge",class:this.badgeClass},[this._v("\n\t"+this._s(this.dot?"":this.value)+"\n")]):this._e()};h._withStripped=!0;var u=l({props:{value:{type:Number,default:0},dot:{type:Boolean,default:!1}},computed:{hasBadge(){return this.value>0},badgeClass(){return{"is-dot":this.dot}}}},h,[],!1,null,null,null);u.options.__file="src/components/badge.vue";var p=u.exports;function _(e){return e.replace("icon-","").replace(/-/g,"_")}var m=l({components:{SearchBox:c,Badge:p},data:()=>({selectedFn:null,activeFieldset:null}),computed:{...(0,n.mapState)(["badges"]),...(0,n.mapGetters)(["validAppLists","validModules"])},watch:{validModules:{handler(e){this.$nextTick((()=>{const e=this.validModules.reduce(((e,t)=>{var i,s;const n=null===(i=this.$refs)||void 0===i||null===(s=i["module-item-".concat(t.fn)])||void 0===s?void 0:s[0];return n._markDrag||(n._markDrag=!0,e.push({dragData:{className:"SYNO.SDS.AdminCenter.Application",isModule:!0,moduleTitle:t.text,icon:"images/{1}/shortcut_icons/".concat(_(t.iconCls),"_64.png"),param:{fn:t.fn}},dom:n})),e}),[]);SYNO.SDS.Desktop.registerDragElements(e,"sds-launch-icon-dragging-proxy syno-sds-admin-center x-dd-drag-proxy")}))},immediate:!0}},mounted(){},methods:{getTitle:e=>SYNO.SDS.UIString.GetLocalizedString(e.text),getIconStyle(e){let t=SYNO.SDS.Config.FnMap["SYNO.SDS.AdminCenter.Application"].config.jsBaseURL;return e.iconCls?t+="/images/".concat(SYNO.SDS.UIFeatures.test("isRetina")?"2x":"1x","/home_icons/icn_").concat(_(e.iconCls),".png"):t+="/images/1x/tmp/construction.png",t+="?v=".concat(_S("version")),{backgroundImage:"url(".concat(t,")")}},onClickModuleIcon(e){this.$emit("click-module",e)},onModuleFocus(e){this.selectedFn=e,this.activeFieldset=null},onFieldsetFocus(e){this.selectedFn=null,this.activeFieldset=e},selectPrev(){this.select(-1)},selectNext(){this.select(1)},select(e){let t=-1;const i=[...this.$el.querySelectorAll(".module-item")],s=i.map((e=>e.getAttribute("fn")));if(this.selectedFn)t=s.indexOf(this.selectedFn),t>=0&&(t=(t+e+i.length)%i.length);else if(this.activeFieldset){var n;t=s.indexOf(null===(n=this.activeFieldset.items)||void 0===n?void 0:n[0].fn),e<0&&t>=0&&(t=(t+e+i.length)%i.length)}-1===t&&(t=0),i[t].focus()}}},i,[],!1,null,null,null);m.options.__file="src/home-screen.vue";var f=m.exports,S=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"page-screen"},e._l(e.validModules,(function(t){return i("v-page-list-module",{key:t.fn,attrs:{value:t.fn,"can-leave":e.canLeave,"confirm-save":e.onConfirmSave,"confirm-dont-save":e.onConfirmDontSave,"help-params":e.helpParams,"help-topic":e.helpTopic},on:{activated:function(i){return e.onActivate(t,i)},"module-focus":function(i){return e.onModuleFocus(t,i)}}},[i("page-module",{key:t.fn,ref:"pageModule",refInFor:!0,attrs:{module:t}})],1)})),1)};S._withStripped=!0;var g=function(){var e=this.$createElement,t=this._self._c||e;return t("div",{ref:"anchor",staticClass:"page-module"},[this.vueComp?t(this.vueComp,{ref:"vueComp",tag:"component"}):this._e()],1)};g._withStripped=!0;const y=new class{constructor(){this.pagesCache=Object.create(null)}set(e,t){this.pagesCache[e]=t}has(e){return Boolean(this.pagesCache[e])}get(e){return this.pagesCache[e]}clear(){this.pagesCache=Object.create(null)}};function b(e,t){return!/<([^>]*)>/.test(e)||null!=t&&t.useHtml||SYNO.Debug.error("message contains html: you need to specify useHtml: true"),e}const v=a.fn.isFunction;var x=l({mixins:[r],props:{module:{type:Object,default:()=>({})}},data:()=>({vueComp:void 0}),mounted(){this.appWin=this.wrapAppWin(this.$options.appWindow),this.page=y.has(this.module.fn)?this.createPageByCache(this.module.fn):this.createPage(this.module.fn),this.addPageCache({module:this.module,moduleInst:this.moduleInst,page:this.page,extPanel:this.extPanel}),this.appWin.activePage=this.page,this.selectFirstTab(0)},beforeDestroy(){this.extPanel&&(delete this.extPanel.el,this.extPanel.rendered=!1),delete this.page},methods:{addPageCache({module:e,page:t,extPanel:i,moduleInst:s}){y.set(e.fn,{page:t,extPanel:i,moduleInst:s})},selectFirstTab(e){this.page&&this.page instanceof Ext.TabPanel&&v(this.page.setActiveTab)&&this.page.setActiveTab(e)},canLeave(){var e,t,i,s;return!1!==(null===(e=this.moduleInst)||void 0===e||null===(t=e.deactivate)||void 0===t?void 0:t.call(e))&&(null===(i=this.page)||void 0===i||null===(s=i.fireEvent)||void 0===s||s.call(i,"deactivate"),!0)},deactivate(){var e,t,i,s;null===(e=this.moduleInst)||void 0===e||null===(t=e.deactivate)||void 0===t||t.call(e),null===(i=this.page)||void 0===i||null===(s=i.fireEvent)||void 0===s||s.call(i,"deactivate")},onActivate(e){var t,i;null===(t=this.moduleInst)||void 0===t||null===(i=t.activate)||void 0===i||i.call(t,e)},onModuleFocus(e){var t;null!=e&&e.tab&&v(this.page.setActiveTab)&&this.page.setActiveTab(e.tab),null===(t=this.moduleInst)||void 0===t||t.focus(e)},async onConfirmLostChangeSave(){var e;const t=await(null===(e=this.moduleInst)||void 0===e?void 0:e.confirmLostChangeSave());return this.deactivate(),t},async onConfirmLostChangeDontSave(){var e;const t=await(null===(e=this.moduleInst)||void 0===e?void 0:e.confirmLostChangeDontSave());return this.deactivate(),t},getHelpParam(){return this.moduleInst.getHelpParam()},getHelpTopic(){return this.moduleInst.getHelpTopic()},wrapAppWin(e){Object.defineProperty(e,"sendWebAPI",{value:e=>(SYNO.Debug.error("appWin.sendWebAPI is deprecated, please use SYNO.API.Request instead."),SYNO.API.Request(e)),configurable:!0}),Object.defineProperty(e,"sendWebAPIPromise",{value:e=>(SYNO.Debug.error("appWin.sendWebAPIPromise is deprecated, please use SYNO.API.RequestPromise instead."),SYNO.API.RequestPromise(e)),configurable:!0}),Object.defineProperty(e,"downloadWebAPI",{value:e=>(SYNO.Debug.error("appWin.downloadWebAPI is deprecated, please use synowebapi.download instead."),synowebapi.download(e.webapi)),configurable:!0}),Object.defineProperty(e,"clearStatusBusy",{value(){this.clearStatus()},configurable:!0}),Object.defineProperty(e,"setStatusError",{value(e){SYNO.Debug.error('appWin.setStatusError is deprecated (and not available in older version as well), please use appWin.getMsgBox().alert("", errorMsg || _T("common", "error_system")) instead.');let t=_T("common","error_system");return SYNO.SDS.isObject(e)&&e.text&&(t=e.text),this.getMsgBox().alert("",t)},configurable:!0});const t=e.setStatusBusy;Object.defineProperty(e,"setStatusBusy",{value:(e,i)=>SYNO.SDS.isObject(e)?(SYNO.Debug.error("appWin.setStatusBusy(config, opacity, delay) is deprecated, please use appWin.setStatusBusy(opacity: null will be default value - 0.4, text) instead."),void t(null,e.text)):t(e,i),configurable:!0}),Object.defineProperty(e,"setStatusOK",{value(){return SYNO.Debug.error("appWin.setStatusOK is deprecated (and not available in older version as well), please use appWin.clearStatus() instead."),this.clearStatus()},configurable:!0}),Object.defineProperty(e,"pollReg",{value:e=>SYNO.API.Request.Polling.Register(e),configurable:!0}),Object.defineProperty(e,"pollUnreg",{value:e=>SYNO.API.Request.Polling.Unregister(e),configurable:!0}),Object.defineProperty(e,"pollList",{value:e=>SYNO.API.Request.Polling.List(e),configurable:!0}),Object.defineProperty(e,"_S",{value:e=>(SYNO.Debug.error("appWin._S is deprecated, please use _S instead."),_S(e)),configurable:!0}),Object.defineProperty(e,"_D",{value:e=>(SYNO.Debug.error("appWin._D is deprecated, please use _D instead."),_D(e)),configurable:!0}),Object.defineProperty(e,"getKnownAPI",{value:e=>(SYNO.Debug.error("appWin.getKnownAPI is deprecated, please use SYNO.API.GetKnownAPI instead."),SYNO.API.GetKnownAPI(e)),configurable:!0});const i=e.getMsgBox;return Object.defineProperty(e,"getMsgBox",{value(e){const t=i();return{...t,confirmDelete(e,i,s,n){if(SYNO.SDS.isFunction(s))return SYNO.Debug.error("AdminCenter appWin confirmDelete callback is deprecated, use promise and take the result"),t.confirmDelete(e,i,null,{useHtml:!0}).then((e=>{s.apply(n,["confirm"===e?"yes":"cancel"])}));const o=n;return b(i,o),t.confirmDelete(e,i,s,Object.assign(null!=o?o:{},{useHtml:!0}))},confirm(e,i,s,n){if(SYNO.SDS.isFunction(s))return SYNO.Debug.error("AdminCenter appWin confirm callback is deprecated, use promise and take the result"),t.confirm(e,i,null,{useHtml:!0}).then((e=>{s.apply(n,["confirm"===e?"yes":"cancel"])}));const o=n;return b(i,o),t.confirm(e,i,s,Object.assign(null!=o?o:{},{useHtml:!0}))},alert(e,i,s,n){if(SYNO.SDS.isFunction(s))return t.alert(e,i,null,{useHtml:!0}).then((e=>{SYNO.Debug.error("AdminCenter appWin alert callback is deprecated, use promise and take the result"),s.apply(n,["confirm"===e?"yes":"cancel"])}));const o=n;return b(i,o),t.alert(e,i,s,Object.assign(o||{},{useHtml:!0}))},updateProgress:(e,i,s)=>(SYNO.Debug.error('AdminCenter appWin updateProgress is deprecated, use progress("Title", percent, "Description", "unit") instead'),t.progress(s,Math.round(100*e),"","%"))}},configurable:!0}),e},createPageByCache(e){const t=y.get(e);var i,s;return this.moduleInst=null==t?void 0:t.moduleInst,this.extPanel=null==t?void 0:t.extPanel,this.extPanel?(this.extPanel.cls="admin-center-page-container",this.extPanel.render(this.$refs.anchor)):this.mountVuePanel(this.moduleInst,null===(i=(s=this.moduleInst).getVuePanel)||void 0===i?void 0:i.call(s)),t.page.itemId=e,null==t?void 0:t.page},createPage(e){let t;const i=Ext.getClassByName(e);return this.moduleInst=new i({app:this.$options.app,appWin:this.appWin,jsConfig:this.$options.appWindow.getInstance().getJsConfig()}),t=this.moduleInst instanceof SYNO.SDS.AdminCenter.Module?this.mountModule(this.moduleInst,e):this.moduleInst,t.itemId=e,t},mountModule(e,t){var i,s;e.appWin=this.appWin;let n=null===(i=e.getPanel)||void 0===i?void 0:i.call(e);const o=null===(s=e.getVuePanel)||void 0===s?void 0:s.call(e);return n?this.mountExtPanel(n):o?(n=o,this.mountVuePanel(e,n)):SYNO.Debug.error("".concat(t," implements SYNO.SDS.AdminCenter.Module but not a panel given, not vue and extjs panel")),n},doLayout(){var e;null===(e=this.extPanel)||void 0===e||e.doLayout()},mountExtPanel(e){return this.extPanel=new Ext.Panel({renderTo:this.$refs.anchor,cls:"admin-center-page-container",bwrapCssClass:"".concat("admin-center-page-container","-bwrap"),bodyCssClass:"".concat("admin-center-page-container","-body"),layout:"fit",app:this.$options.app,padding:"16px 16px 0 16px",tools:!1,header:!1,title:!1,vueOwnerCt:this.appWin,module:{appWin:this.appWin,app:this.$options.app},items:[e]}),e},mountVuePanel(e,t){this.vueComp=t,e.getVueApp=()=>{var e;return null===(e=this.$refs)||void 0===e?void 0:e.vueComp}}}},g,[],!1,null,null,null);x.options.__file="src/components/page-module.vue";var w=l({components:{PageModule:x.exports},mixins:[r],computed:{...(0,n.mapGetters)(["validModules"])},mounted(){this.pages=Object.create(null),this.currentPage=null},methods:{onModuleFocus(e,t){var i,s;null===(i=this.$refs.pageModule)||void 0===i||null===(s=i[0])||void 0===s||s.onModuleFocus(t)},doLayout(){var e,t;return null===(e=this.$refs.pageModule)||void 0===e||null===(t=e[0])||void 0===t?void 0:t.doLayout()},async onActivate(e,t){var i,s;await this.$nextTick(),null===(i=this.$refs.pageModule)||void 0===i||null===(s=i[0])||void 0===s||s.onActivate(t)},helpParams(){var e,t;return null===(e=this.$refs.pageModule)||void 0===e||null===(t=e[0])||void 0===t?void 0:t.getHelpParam()},helpTopic(){var e,t;return null===(e=this.$refs.pageModule)||void 0===e||null===(t=e[0])||void 0===t?void 0:t.getHelpTopic()},canLeave(){var e,t;return null===(e=this.$refs.pageModule)||void 0===e||null===(t=e[0])||void 0===t?void 0:t.canLeave()},onConfirmSave(){var e,t;return null===(e=this.$refs.pageModule)||void 0===e||null===(t=e[0])||void 0===t?void 0:t.onConfirmLostChangeSave()},onConfirmDontSave(){var e,t;return null===(e=this.$refs.pageModule)||void 0===e||null===(t=e[0])||void 0===t?void 0:t.onConfirmLostChangeDontSave()}}},S,[],!1,null,null,null);w.options.__file="src/page-screen.vue";var T=w.exports,C=function(e,t){var i=t._c;return i("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:t.props.width,height:t.props.height}},[i("path",{attrs:{"fill-rule":"evenodd",d:"M12.3178536,5.26176181 L20.0696741,11.645614 C20.1549391,11.7158322 20.167137,11.8418764 20.0969187,11.9271415 C20.058927,11.9732742 20.0022955,12 19.9425326,12 L18,12 L18,18.5 C18,18.7761424 17.7761424,19 17.5,19 L6.5,19 C6.22385763,19 6,18.7761424 6,18.5 L6,12 L4.05746736,12 C3.94701041,12 3.85746736,11.9104569 3.85746736,11.8 C3.85746736,11.7402371 3.88419313,11.6836057 3.93032591,11.645614 L11.6821464,5.26176181 C11.8667743,5.1097153 12.1332257,5.1097153 12.3178536,5.26176181 Z M13.5,13 L10.5,13 C10.2545401,13 10.0503916,13.1768752 10.0080557,13.4101244 L10,13.5 L10,17.5 C10,17.7454599 10.1768752,17.9496084 10.4101244,17.9919443 L10.5,18 L13.5,18 C13.7454599,18 13.9496084,17.8231248 13.9919443,17.5898756 L14,17.5 L14,13.5 C14,13.2545401 13.8231248,13.0503916 13.5898756,13.0080557 L13.5,13 Z"}})])};C._withStripped=!0;var D=l({name:"vIconHome",props:{width:{type:[Number,String],default:24},height:{type:[Number,String],default:24}}},C,[],!0,null,null,null);D.options.__file="images/svg/home.svg";var N=D.exports;const k=a.element.on;Vue.prototype.$iconManager.register("admin-center-home",N);const A="home",O="page";var P=l({name:"AdminCenterApp",components:{HomeScreen:f,PageScreen:T,SearchBox:c,Badge:p},mixins:[],data:()=>({screen:A}),computed:{...(0,n.mapState)(["badges"]),...(0,n.mapGetters)(["validAppLists"]),isHomeScreen(){return this.screen===A},isPageScreen(){return this.screen===O}},watch:{async isPageScreen(){var e;await this.$nextTick(),null===(e=this.$refs.appWindow)||void 0===e||e.focusModules()}},created(){const e=SYNO.SDS.Config.FnMap["SYNO.SDS.AdminCenter.Application"].config;this.fetchDefer=Promise.all([this.fetchCMSInfo(),this.fetchModules({config:e}),this.fetchBadges()]),SYNO.SDS.StatusNotifier.on("badgenumget",this.onUpdateBadgeNum,this)},beforeDestroy(){var e,t;y.clear(),SYNO.SDS.StatusNotifier.un("badgenumget",this.onUpdateBadgeNum,this),null===(e=(t=this.$options).unloadDisposedFn)||void 0===e||e.call(t),_S("is_admin")&&this.backup()},mounted(){_S("is_admin")&&(this.viewBadge(),this.$options.unloadDisposedFn=k(window,"beforeunload",this.onBeforeUnload),SYNO.SDS.StatusNotifier.on("halt",(()=>{var e,t;null===(e=(t=this.$options).unloadDisposedFn)||void 0===e||e.call(t)})))},methods:{...(0,n.mapActions)(["fetchCMSInfo","fetchModules","fetchBadges","viewBadge"]),onBeforeUnload(){this.backup()},onUpdateBadgeNum(){this.fetchBadges()},async onClickHome(){var e,t,i;if(!1===(null===(e=this.$refs["page-screen"])||void 0===e||null===(t=e.canLeave)||void 0===t?void 0:t.call(e))&&!1===await this.$refs.appWindow.showConfirmLostChangedDialog())return!1;y.clear(),this.screen=A,null===(i=this.$refs.appWindow)||void 0===i||i.selectModule(null)},backup(){SYNO.API.RequestPromise({api:"SYNO.Backup.Config.AutoBackup",method:"backup",version:1,params:{instant:!1}})},getTitle:e=>SYNO.SDS.UIString.GetLocalizedString(e.text),getIcon:e=>({type:"bkg-img",name:e.iconCls}),onOpenParamChanged(e,t){t.fn&&this.fetchDefer.then((()=>{this.startModule(t.fn,t)}))},onClickModule(e){this.startModule(e.fn)},setStatusBusy(){this.$refs.appWindow.setStatusBusy()},clearStatusBusy(){this.$refs.appWindow.clearStatus()},async startModule(e,t={}){var i;this.screen=O,await this.$nextTick(),null===(i=this.$refs.appWindow)||void 0===i||i.selectModule(e,t)},async onResizeWindow(){var e;await this.$nextTick(),null===(e=this.$refs["page-screen"])||void 0===e||e.doLayout()}}},t,[],!1,null,null,null);P.options.__file="src/App.vue";var E=P.exports;class F{constructor({config:e,moduleUrl:t="modules/modules.json"}={}){this.moduleUrl="".concat(e.jsBaseURL,"/").concat(t)}async load(){try{var e;const t=await synowebapi.promises.request({url:this.moduleUrl,params:{v:_S("version")},requestMethod:"GET",requestFormat:"raw",responseFormat:"raw"});return null!==(e=null==t?void 0:t.listItems)&&void 0!==e?e:[]}catch(e){return SYNO.Debug.error(e),[]}}}const I=a.fn.isArray,Y=a.fn.isString;function B(e,t="or"){return e["or"===t?"some":"every"]((e=>{const t=e.fn;let i=!1;if(Y(t)){const s=_S(e.key);"greater"===t?i=s>e.value:"less"===t?i=s<e.value:"equal"===t?i=s==e.value:"and"===t&&(i=B(e.value,"and"))}else i=_D(e.key,e.defaultValue||"no")===e.value;return i}))}const M=new(o().Store)({state:{appLists:[],badges:{},isCMSJoined:!1},mutations:{UPDATE_APP_LISTS(e,t){e.appLists=t},UPDATE_BADGES(e,t){e.badges=t},IS_CMS_JOINED(e,t){e.isCMSJoined=t}},actions:{async fetchBadges({commit:e}){var t,i,s;let n={};null===(t=SYNO.SDS.PollingTask)||void 0===t||null===(i=t.BadgeInfo)||void 0===i||null===(s=i.eachFnOfApp)||void 0===s||s.call(i,"SYNO.SDS.AdminCenter.Application",(e=>{var t,i,s;n[e]=null===(t=SYNO.SDS.PollingTask)||void 0===t||null===(i=t.BadgeInfo)||void 0===i||null===(s=i.getInfoOfFn)||void 0===s?void 0:s.call(i,"SYNO.SDS.AdminCenter.Application",e)})),e("UPDATE_BADGES",n)},viewBadge:async({dispatch:e})=>(await synowebapi.promises.request({api:"SYNO.Core.AppNotify",method:"view",version:1,params:{app:"SYNO.SDS.AdminCenter.Application"}}),e("fetchBadges")),async fetchCMSInfo({commit:e}){if(_S("is_admin"))try{e("IS_CMS_JOINED",(await synowebapi.promises.request({api:"SYNO.Core.CMS.Info",version:1,method:"get"})).joined)}catch(t){e("IS_CMS_JOINED",!1),SYNO.Debug.error(t)}else e("IS_CMS_JOINED",!1)},async fetchModules({commit:e},{config:t,moduleUrl:i}){const s=new F({config:t,moduleUrl:i});e("UPDATE_APP_LISTS",await s.load())}},getters:{validAppLists:e=>e.appLists.reduce(((t,i)=>{const s=i.items.filter((e=>!(!1===SYNO.SDS.AppPrivilege[e.fn]||!1===SYNO.SDS.ServiceStatus[e.fn]||!SYNO.SDS.ActionPrivilege||!SYNO.SDS.ActionPrivilege.isUserHasPrivilege(e.fn)))).filter((t=>function(e){const t=e.enable,i=e.disable;let s=!1;return I(t)&&(s=!!B(t)),I(i)&&(s=!B(i)),I(t)||I(i)||(s=!e.hidden),s}(t)||"SYNO.SDS.AdminCenter.CMS.Main"==t.fn&&e.isCMSJoined));return s.length>0&&t.push({...i,items:s}),t}),[]),validModules:(e,t)=>t.validAppLists.reduce(((e,t)=>e.concat(t.items)),[])}});var R;SYNO.SDS.AdminCenter.Application=(R=E,Vue.extend(R).extend({store:M}))}(),Ext.define("SYNO.SDS.AdminCenter.Network.OobAutoBlock.Window",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.denyListTab=new SYNO.SDS.AdminCenter.Network.OOBAutoBlock.RuleList({ruleWin:this,columns:[{header:_T("oob","oob_autoblock_ip"),dataIndex:"ip",width:160,sortable:!1,menuDisabled:!0},{header:_T("oob","oob_autoblock_time"),dataIndex:"record_date",width:200,sortable:!1,menuDisabled:!0}]});var t={ruleWin:this,title:_T("oob","oob_block_list_title"),width:500,height:440,items:this.denyListTab,layout:"fit",buttons:[{btnStyle:"grey",text:_T("common","close"),scope:this,handler:function(){this.close()}}]};return Ext.apply(t,e),t}}),Ext.define("SYNO.SDS.AdminCenter.Network.OOBAutoBlock.RuleList",{extend:"SYNO.ux.GridPanel",constructor:function(e){var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){this.ruleWin=e.ruleWin,this.store=new SYNO.API.JsonStore({api:"SYNO.Core.Hardware.OOBManagement",method:"list_blocked_ipv4",version:1,baseParams:{offset:0,limit:512},root:"ip_info",totalProperty:"total",fields:["ip",{name:"record_date",convert:function(e,t){var i=new Date(1e3*t.record_date);return SYNO.SDS.DateTimeFormatter(i,{type:"datetimesec"})}}],appWindow:e.ruleWin,scope:this,autoLoad:!0,remoteSort:!0,listeners:{load:{scope:this,fn:this.onStoreLoad},exception:{scope:this,fn:this.onStoreException}}}),this.ipFilter=new SYNO.ux.TextFilter({iconStyle:"filter",emptyText:_T("common","filter_label_text"),localFilter:!0,localFilterField:"ip",tabIndex:-1,store:this.store}),this.delBtn=new SYNO.ux.Button({text:_T("oob","oob_autoblock_clear_btn"),scope:this,handler:this.onClickClearBlockIp});var t={ds:this.store,loadMask:!0,height:300,enableHdMenu:!1,tbar:{items:[this.delBtn,"->",this.ipFilter]},bbar:{xtype:"syno_paging",pageSize:512,displayInfo:!0,store:this.store,showRefreshBtn:!0}};return Ext.apply(t,e),t},onStoreLoad:function(){0===this.store.getTotalCount()?this.delBtn.disable():this.delBtn.enable()},onStoreException:function(e,t,i,s,n,o){SYNO.Debug("Store exception: options:",e,t,i,s,n,o),this.ruleWin.clearStatusBusy()},onClickClearBlockIp:function(e,t){this.showMsgBox(_T("oob","oob_block_clear_notice"),_T("oob","oob_confirm_clear_all"),"red",(function(e){"yes"===e&&SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this.ruleWin,this.confirmedClearBlockIpClbk)}))},confirmedClearBlockIpClbk:function(){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Hardware.OOBManagement",method:"exec",version:1,params:{oob_ifname:this.ifname,command:"oob.blocklist.clear"},scope:this,callback:function(e,t,i){this.denyListTab.store.reload(),this.clearStatusBusy()}})},showMsgBox:function(e,t,i,s){this.gMsgBox&&!this.gMsgBox.isDestroyed||(this.gMsgBox=new SYNO.SDS.MessageBoxV5({owner:this.ruleWin,draggable:!1})),this.gMsgBox.confirmDelete(_T("oob","oob_warning_title"),e,s,this,{yes:{text:t,btnStyle:i},no:{text:_T("oob","oob_cancel")}})}}),Ext.define("SYNO.SDS.AdminCenter.Network.TcSrcIpDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner,this.panel=this.createPanel(),this.form=this.panel.getForm();var t={width:680,height:380,title:_T("firewall","firewall_source"),layout:"fit",items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","alt_cancel"),scope:this,handler:this.close},{btnStyle:"blue",text:_T("common","alt_apply"),itemId:"ruleApply",scope:this,handler:this.onApply}]};this.setDefault(),Ext.apply(t,e),this.callParent([t]),this.OnSourceRadioClick(this.form.findField("source"),!0)},createPanel:function(){var e={xtype:"syno_fieldset",title:_T("firewall","firewall_source"),itemId:"firewall_source",items:[{xtype:"syno_displayfield"},{xtype:"syno_compositefield",hideLabel:!0,defaults:{flex:1},items:[{xtype:"syno_radio",name:"source",itemId:"nfs_fieldtitle_host",boxLabel:_T("nfs","nfs_fieldtitle_host"),inputValue:"single",scope:this,checked:!0,handler:this.OnSourceRadioClick},{xtype:"syno_radio",name:"source",itemId:"firewall_source_network",boxLabel:_T("firewall","firewall_source_network"),inputValue:"subnet",scope:this,handler:this.OnSourceRadioClick}]},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_ipaddr"),name:"source_ip",itemId:"tcpip_ipaddr",vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)&&(this.nextSibling().validate(),!0)}},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("tcpip","tcpip_mask")+"/"+_T("tcpip","ipv6_prefixleng"),name:"source_subnet_mask",itemId:"tcpip_mask",maskRe:/[.0-9]/,invalidText:_JSLIBSTR("vtype","bad_mask"),allowBlank:!1,validator:function(e){var t=this.previousSibling().getValue();return Ext.form.VTypes.fwLoosev6ipVal.test(t)?e>=0&&e<=128||_JSLIBSTR("vtype","bad_ipv6prefixLeng"):!!Ext.form.VTypes.netmaskVal.test(e)}},{xtype:"syno_displayfield"},{xtype:"syno_radio",boxLabel:_T("firewall","firewall_ip_range"),name:"source",width:2*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_LABEL_WIDTH,itemId:"firewall_source_range",inputValue:"range",scope:this,handler:this.OnSourceRadioClick},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("ftp","ftp_port_from"),name:"source_ip_begin",itemId:"tcpip_ipaddr_begin",vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)}},{xtype:"syno_textfield",width:SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,labelWidth:1.7*SYNO.SDS.AdminCenter.Security.Utils.FW_DEFAULT_INPUT_WIDTH,fieldLabel:_T("ftp","ftp_port_to"),name:"source_ip_end",itemId:"tcpip_ipaddr_end",vtype:"fwLooseip",validator:function(e){return!!Ext.form.VTypes.fwLooseip(e)}}]};return new SYNO.ux.FormPanel(e)},onApply:function(){this.validateBlank(this.form)?this.form.isValid()?(this.setSource(this.getSrc()),this.owner.setSrc(this.getSrc()),this.close()):this.setStatusError({text:_T("common","forminvalid"),clear:!0}):"range"===this.form.findField("source").getGroupValue()?this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("firewall","firewall_error_ip_range")):this.getMsgBox().alert(_T("tree","leaf_firewall"),_T("common","forminvalid"))},getSrc:function(){var e,t=this.form.findField("source").getGroupValue();if("single"===t)e=this.form.findField("source_ip").getValue();else if("range"===t){e=this.form.findField("source_ip_begin").getValue()+"-"+this.form.findField("source_ip_end").getValue()}else"subnet"===t&&(e=String.format("{0}/{1}",this.form.findField("source_ip").getValue(),this.form.findField("source_subnet_mask").getValue()));return e},onOpen:function(e){this.setStatusBusy(),e&&""!==e?this.setSource(e):this.form.findField("source").setValue("single"),this.clearStatusBusy(),this.callParent(arguments)},setDefault:function(){this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable()},setSource:function(e){var t="",i="",s="",n="",o="";if(0<=e.indexOf("GEOIP:")||0<=e.indexOf("all"))s="single";else if(0<e.indexOf("-"))n=e.split("-")[0],o=e.split("-")[1],s="range",this.form.findField("source_ip_begin").setValue(n),this.form.findField("source_ip_end").setValue(o);else if(e.indexOf("/")>0){var a=e.split("/");t=a[0],i=a[1],s="subnet",this.form.findField("source_ip").setValue(t),this.form.findField("source_subnet_mask").setValue(i)}else this.form.findField("source_ip").setValue(e),s="single";this.form.findField("source").setValue(s)},OnSourceRadioClick:function(e,t){if(e.checked)switch(e.value){case"single":default:this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable();break;case"subnet":this.form.findField("source_ip").enable(),this.form.findField("source_subnet_mask").enable(),this.form.findField("source_ip_begin").disable(),this.form.findField("source_ip_end").disable();break;case"range":this.form.findField("source_ip").disable(),this.form.findField("source_subnet_mask").disable(),this.form.findField("source_ip_begin").enable(),this.form.findField("source_ip_end").enable()}},validateBlank:function(e){var t,i,s,n,o,a=!0,r=0,l=0,d="",c=e.findField("source").getGroupValue();if("single"==c)a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip"]);else if("subnet"==c)(a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip"]))&&(a=SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_subnet_mask"]));else if(SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip_begin"])&&SYNO.SDS.AdminCenter.Utils.Validator.MarkBlankField(e,["source_ip_end"]))if(i=e.findField("source_ip_begin").getValue().toString(),s=e.findField("source_ip_end").getValue().toString(),0<i.indexOf(".")&&0<s.indexOf(".")){if(d=/([0-9]+).([0-9]+).([0-9]+).([0-9]+)/,null===(n=i.match(d))||null===(o=s.match(d)))return!1;for(r=1;r<n.length;r++){if(parseInt(o[r],10)>parseInt(n[r],10)){a=!0;break}if(parseInt(o[r],10)<parseInt(n[r],10)){a=!1;break}a=!1}}else if(0<i.indexOf(":")&&0<s.indexOf(":")){if(0<i.indexOf("::")){for(l=i.match(/:/g).length,t="::",r=0;r<7-l;r++)t+=":";i=i.replace("::",t)}if(0<s.indexOf("::")){for(l=s.match(/:/g).length,t="::",r=0;r<7-l;r++)t+=":";s=s.replace("::",t)}if(d=/([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*):([0-9A-Fa-f]*)/,null===(n=i.match(d))||null===(o=s.match(d)))return!1;for(r=1;r<n.length;r++){if(""===n[r]&&(n[r]=0),""===o[r]&&(o[r]=0),parseInt(o[r],16)>parseInt(n[r],16)){a=!0;break}if(parseInt(o[r],16)<parseInt(n[r],16)){a=!1;break}a=!1}}else a=!1;else a=!1;return!!a}}),Ext.define("SYNO.SDS.AdminCenter.Network.OvsSetting.BondChangeWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(e){this.owner=e.owner,this.module=e.module,this.enable_ovs=e.enable_ovs,this.resp=e.resp,this.callParent([this.fillConfig(e)]),this.addListener("destroy",this.module.startPolling,this.module)},fillConfig:function(e){return Ext.apply({title:_T("network","linkaggr_modified"),resizable:!1,width:700,height:550,steps:[this.bondMode=new SYNO.SDS.AdminCenter.Network.OvsSetting.BondMode({owner:this,win:this,enable_ovs:this.enable_ovs,resp:this.resp})]},e)},onOpen:function(){SYNO.SDS.AdminCenter.Network.OvsSetting.BondChangeWizard.superclass.onOpen.apply(this,arguments)},onApply:function(){for(var e=this.getSelectMode(),t=0;t<e.length;t++)if(Ext.isEmpty(e[t].mode))return void this.setStatusError({text:_T("ovs","ovs_linkaggr_change_mode_empty"),clear:!0});this.setStatusBusy({text:_T("common","saving")}),this.SendAPI(e)},SendAPI:function(e){!0!==_S("ha_handle_set_ovs")?(this.sendWebAPI({api:"SYNO.Core.Network.OVS",method:"set",version:1,params:{if_list:e,enable:this.enable_ovs},scope:this}),SYNO.SDS.AdminCenter.Network.Utils.Redirect.apply(this,[!1,!1,[""],"","",null,12e4]),this.close()):SYNO.SDS.HA.SetOVS(this,!1,{if_list:e,enable:this.enable_ovs})},getSelectMode:function(){for(var e=[],t=0;t<this.resp.length;t++)e.push({ifname:this.resp[t].ifname,mode:this.bondMode.getForm().findField("combobox_"+this.resp[t].ifname).getValue()});return e}}),Ext.define("SYNO.SDS.AdminCenter.Network.OvsSetting.BondMode",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.module=e.module,this.enable_ovs=e.enable_ovs,this.resp=e.resp,this.owner=e.owner;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){var t=this,i={headline:t.enable_ovs?_T("ovs","ovs_linkaggr_change_mode_enable"):_T("ovs","ovs_linkaggr_change_mode_disable"),border:!1,items:SYNO.SDS.AdminCenter.Network.OvsSetting.BondModeConfig(t.enable_ovs,t.resp),getNext:function(){return this.win.onApply(),!1}};return Ext.apply(i,e),i}}),SYNO.SDS.AdminCenter.Network.OvsSetting.BondModeConfig=function(e,t){var i=[];i.push({xtype:"syno_compositefield",hideLabel:!0,items:[{xtype:"syno_displayfield",width:80,height:36,value:_T("network","route_interface")},{xtype:"syno_displayfield",width:250,height:36,value:_T("network","linkaggr_mode_now")},{xtype:"syno_displayfield",width:270,height:36,value:_T("network","linkaggr_mode_future")}]}),Ext.each(t,(function(t,s){i.push({xtype:"syno_compositefield",hideLabel:!0,name:"field_"+t.ifname,items:[{xtype:"syno_displayfield",width:80,value:SYNO.SDS.Utils.Network.idToString(t.ifname)},{xtype:"syno_displayfield",width:250,value:SYNO.SDS.AdminCenter.Network.Utils.GetBondModeStr(!e,t.mode)},{xtype:"syno_combobox",width:270,valueField:"value",displayField:"display",autoDestroy:!0,allowBlank:!1,lazyRender:!0,triggerAction:"all",name:"combobox_"+t.ifname,store:new Ext.data.SimpleStore({fields:["value","display"],data:e?[["balance-slb",_T("ovs","ovs_linkaggr_mode_slb")],["balance-tcp",_T("ovs","ovs_linkaggr_mode_tcp")],["ovs-active-backup",_T("ovs","ovs_linkaggr_mode_failover")]]:[["802.3ad",_T("network","linkaggr_mode_8023ad")],["balance-alb",_T("network","linkaggr_mode_alb")],["balance-xor",_T("network","linkaggr_mode_xor")],["active-backup",_T("network","linkaggr_mode_failover")]]})}]})})),i.push({xtype:"syno_displayfield",height:10});var s="<b>"+(e?_T("ovs","ovs_linkaggr_mode_tcp"):_T("network","linkaggr_mode_8023ad"))+"</b>",n=String.format(_T("ovs","ovs_linkaggr_note"),s);return i.push({xtype:"syno_displayfield",value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+n,name:"linkaggr_note",htmlEncode:!1}),SYNO.LayoutConfig.fill(i),i},Ext.define("SYNO.SDS.AdminCenter.Network.SetupOOBAccountDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.passwordChecker=e.passwordChecker,this.panel=this.configForm(e);var t=Ext.apply({width:450,height:300,layout:"fit",border:!1,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("oob","oob_cancel"),scope:this,handler:this.onDiscard},{btnStyle:"blue",text:_T("oob","oob_save"),scope:this,handler:this.onApply}]},e);this.callParent([t]),this.panel.mon(this.panel.getForm().findField("oob_username"),"blur",(function(){this.isValid()&&this.clearInvalid()}),this.panel.getForm().findField("oob_password")),this.panel.mon(this.panel.getForm().findField("oob_password"),"blur",(function(){this.isValid()&&this.clearInvalid()}),this.panel.getForm().findField("oob_confirmpassword"))},onApply:function(){var e=this.getFormUsername(),t=this.getFormPassword();!0===this.panel.getForm().isValid()&&(this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Hardware.OOBManagement",method:"update",version:1,params:{oob_username:e,oob_password:t,oob_ifname:this.hostConfig.oob_ifname},encryption:["oob_password","oob_username","ifname"],scope:this,callback:this.applyDone}))},applyDone:function(e,t,i){var s=this.getFormUsername();!0===e?(this.hostConfig.oob_username=s,this.ownerPanel.getForm().findField("oob_username").setValue(s),Ext.getCmp(this.ownerPanel.btnUsernameEdit).show()):this.ownerPanel.getForm().findField("oob_shell_enable").setValue(!1),this.ownerPanel.doLayout(),this.clearStatusBusy(),this.close()},onDiscard:function(){this.close()},onClose:function(){""===this.hostConfig.oob_username&&this.ownerPanel.getForm().findField("oob_shell_enable").setValue(this.hostConfig.oob_shell_enable),this.ownerPanel.doLayout()},onOpen:function(){!0!==this.hostConfig.oob_shell_enable&&""==this.hostConfig.oob_username||this.panel.getForm().setValues({oob_username:this.hostConfig.oob_username,oob_password:"",oob_confirmpassword:""}),this.panel.getForm().findField("oob_password").startValidate=!0,this.callParent(arguments)},configForm:function(e){var t=new SYNO.ux.FormPanel({items:[{xtype:"syno_displayfield",value:_T("oob","oob_setup_account_desc")},{xtype:"syno_displayfield",name:"description",hidden:!0,value:""},{xtype:"syno_textfield",fieldLabel:_T("oob","oob_setup_username")+' <font class="red-status">'+_T("common","star")+"</font>","aria-label":_T("oob","oob_setup_username"),name:"oob_username",disabled:!1,allowBlank:!1,blankText:_T("oob","oob_error_noname"),validateOnBlur:!0,validationDelay:250,validationEvent:"keyup",maxLength:30,width:200,labelHtmlEncode:!1,vtype:"username"},{xtype:"syno_compositefield",fieldLabel:_T("oob","oob_setup_password")+' <font class="red-status">'+_T("common","star")+"</font>",width:500,cls:"password-composite-field",labelHtmlEncode:!1,items:[{xtype:"syno_passwordfield","aria-label":_T("oob","oob_setup_password"),maxLength:64,width:200,name:"oob_password",updateWhenRender:!1,startValidate:!1,validator:this.passwordChecker?this.passwordChecker.isStrongValidator.createDelegate(this.passwordChecker):Ext.emptyFn,listeners:{afterrender:function(){this.hidePasswordStrength()},password_strength_get:function(){this.showPasswordStrength()}}}]},{xtype:"syno_textfield",textType:"password_confirm",fieldLabel:_T("oob","oob_setup_confirmpassword")+' <font class="red-status">'+_T("common","star")+"</font>","aria-label":_T("oob","oob_setup_confirmpassword"),maxLength:127,name:"oob_confirmpassword",width:200,labelHtmlEncode:!1,confirmFor:"oob_password",validator:function(e){return e===this.ownerCt.getForm().findField(this.confirmFor).getValue()||_T("oob","oob_error_repeat_password")}}]});return this.passwordChecker&&this.passwordChecker.initPasswordChecker({getForm:function(){return t.getForm()},getUserAcc:"oob_username",getUserDesc:"description",getPasswd:"oob_password",getPasswdConfirm:"oob_confirmpassword",getStartValidate:function(){var e;return null===(e=this.getForm().findField("oob_password"))||void 0===e?void 0:e.startValidate}}),t},getFormUsername:function(){return this.panel.getForm().findField("oob_username").getValue()},getFormPassword:function(){return this.panel.getForm().findField("oob_password").getValue()}}),Ext.define("SYNO.SDS.AdminCenter.Network.OvsSettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner;var t=this.fillConfig(e);this.callParent([t])},fillConfig:function(e){return Ext.apply({title:_T("ovs","ovs_setting"),width:500,height:"yes"===_D("support_oob_ctl")?230:200,layout:"fit",resizable:!1,buttons:[{xtype:"syno_button",text:_T("common","alt_cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","alt_apply"),btnStyle:"blue",scope:this,handler:this.onApply}],items:[this.createOvsSetting()]},e)},createOvsSetting:function(){return{xtype:"syno_formpanel",border:!1,itemId:"ovssetting_form",padding:"0px",items:[{xtype:"syno_checkbox",boxLabel:_T("network","enable_ovs"),name:"enable_ovs"},{xtype:"syno_displayfield",indent:1,value:_T("network","enable_ovs_desc")},{xtype:"syno_displayfield",indent:1,htmlEncode:!1,hidden:"yes"!==_D("support_oob_ctl"),value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("oob","oob_ovs_not_support_note")},{xtype:"syno_displayfield",itemId:"feasibility_field",indent:1,htmlEncode:!1,hidden:!0}]}},onActivate:function(){this.callParent(arguments);var e=[];e.push({api:"SYNO.Core.Network.OVS",method:"get",version:1}),e.push({api:"SYNO.Core.Network.OVS",method:"check",version:1}),this.sendWebAPI({compound:{stopwhenerror:!1,params:e},callback:function(e,t,i,s){Ext.each(t.result,(function(e,t,i){var s=this.getComponent("ovssetting_form").getForm().findField("enable_ovs"),n=s.el.parent().down(".syno-ux-whitetip-icon");if("SYNO.Core.Network.OVS"===e.api&&"get"===e.method)s.setValue(e.data.enable_ovs),s.originalValue=e.data.enable_ovs;else if("SYNO.Core.Network.OVS"===e.api&&"check"===e.method)if(e.error&&4319===e.error.code&&e.error.errors.hard){var o="",a=0;for(a=0;a<e.error.errors.hard.length;++a)0<a&&(o+="<br>"),o+=SYNO.SDS.Utils.GetFeasibilityCheckMsg(e.error.errors.hard[a]);s.disable(),n||SYNO.ux.AddTip(s,o),this.doLayout()}else n&&n.remove()}),this)},scope:this})},onApply:function(){var e=this.getComponent("ovssetting_form").getForm().findField("enable_ovs");e.isDirty()?this.sendWebAPI({api:"SYNO.Core.Network.Bond",method:"list",version:1,callback:function(t,i){var s=e.getValue();!0!==t||Ext.isEmpty(i)?!0!==_S("ha_handle_set_ovs")?(this.sendWebAPI({api:"SYNO.Core.Network.OVS",method:"set",version:1,params:{enable:!!s},scope:this}),SYNO.SDS.AdminCenter.Network.Utils.Redirect.apply(this,[!1,!1,[""],"","",null,15e3])):SYNO.SDS.HA.SetOVS(this,!0,{enable:!!s}):SYNO.SDS.AdminCenter.Network.OvsSetting.onChangeBondMode.apply(this,[s,i])},scope:this}):this.close()},onCancel:function(){this.close()}}),Ext.ns("SYNO.SDS.AdminCenter.Network.OvsSetting"),SYNO.SDS.AdminCenter.Network.OvsSetting.onChangeBondMode=function(e,t){this.module.stopPolling();var i=new SYNO.SDS.AdminCenter.Network.OvsSetting.BondChangeWizard({owner:this,module:this.module,enable_ovs:e,resp:t});i.addListener("destroy",(function(){this.module.startPolling()}),this),i.open()},Ext.define("SYNO.SDS.AdminCenter.Network.AuthTab",{extend:"SYNO.ux.FormPanel",constructor:function(e){this.owner=e.owner,this.module=e.module,this.parentPanel=e.parentPanel,this.callParent([this.fillConfig(e)]),this.getCmpsAsMembers(),this.user_cert_update_time="",this.key_update_time="",this.ca_cert_update_time=""},fillConfig:function(e){var t={title:_T("network","auth_8021x"),trackResetOnLoad:!0,xtype:"syno_fieldset",height:450,items:[{xtype:"syno_checkbox",boxLabel:_T("network","auth_enable"),name:"enable",indent:0,disabled:!1,checked:!1},{xtype:"syno_compositefield",name:"eap_composite",indent:1,items:[{xtype:"syno_combobox",fieldLabel:_T("network","auth_eap"),name:"eap",editable:!1,width:150,allowBlank:!1,valueField:"value",displayField:"display",store:new Ext.data.SimpleStore({fields:["value","display"],data:[["auto","Auto"],["peap","PEAP"],["ttls","TTLS"],["tls","TLS"]]}),listeners:{scope:this,disable:this.disableGroup,enable:function(e){this.setGroup(e.value)},select:function(e,t,i){this.setGroup(t.data.value)}}},{xtype:"syno_button",text:_T("routerconf","routerconf_test_conn"),id:this.testConBtnId=Ext.id(),autoWidth:!0,handler:this.testBtn,scope:this}]},{xtype:"syno_combobox",fieldLabel:_T("network","auth_phase2"),name:"phase2",indent:1,editable:!1,hidden:!1,width:150,allowBlank:!1,valueField:"value",displayField:"display",value:"mschapv2",store:new Ext.data.SimpleStore({fields:["value","display"],data:[["mschapv2","MS-CHAP v2"],["gtc","GTC"]]})},{xtype:"syno_textfield",fieldLabel:_T("network","user_account"),name:"identity",indent:1,width:150,allowBlank:!1,hidden:!1},{xtype:"syno_displayfield",fieldLabel:_T("network","auth_user_cert"),name:"user_cert",value:"",id:this.field_user_cert=Ext.id(),indent:1,htmlEncode:!1,width:450},{xtype:"syno_displayfield",fieldLabel:_T("network","auth_private_key"),name:"key",value:"",id:this.field_key=Ext.id(),indent:1,htmlEncode:!1,width:450},{xtype:"syno_textfield",textType:"password",fieldLabel:_T("network","user_pass"),name:"password",indent:1,width:150,allowBlank:!1,hidden:!1},{xtype:"syno_textfield",textType:"password",fieldLabel:_T("network","auth_private_key_passwd"),name:"key_password",indent:1,width:150,allowBlank:!1,hidden:!1},{xtype:"syno_displayfield",fieldLabel:_T("network","auth_ca_cert"),name:"ca_cert",value:"",id:this.field_ca_cert=Ext.id(),htmlEncode:!1,indent:1,width:450},{xtype:"syno_textfield",fieldLabel:_T("network","auth_anonymous"),name:"anonymous_identity",indent:1,width:150,allowBlank:!0,hidden:!1},{xtype:"syno_displayfield",fieldLabel:_T("common","status"),htmlEncode:!1,name:"auth_status",indent:1},{xtype:"syno_displayfield",htmlEncode:!1,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("network","auth_note")}]};return Ext.apply(t,e),t},getCmpsAsMembers:function(){for(var e=["field_ca_cert","field_user_cert","field_key","testConBtnId"],t=0;t<e.length;++t)this[e[t]]=Ext.getCmp(this[e[t]])},fillContent:function(e){var t=this.getConfig(e);""===t.eap&&(t.eap="auto"),t.enable||this.disableGroup(),this.setGroup(t.eap),this.getForm().setValues(t),this.checkGroupEnable=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable",["eap"]),this.getForm().clearInvalid()},transferStatus:function(e){return"authenticated"==e?'<font class="green-status">'+_T("mail","mail_authentication_success")+"</font>":"authenticating"==e?_T("network","auth_processing"):"unauthenticated"==e?'<font class="red-status">'+_T("service","service_ddns_status_auth_failed")+"</font>":""===e?_T("common","disabled"):_T("service","service_ddns_error_unknown")},isDirty:function(){return this.getForm().isDirty()},isValid:function(){return this.getForm().isValid()},getWebAPISetData:function(){return{api:"SYNO.Core.Network.Authentication",version:1,method:"set",encryption:["password","key_password"],params:this.prepareWebAPISetData()}},getWebAPIGetData:function(){return{api:"SYNO.Core.Network.Authentication",version:1,method:"get",params:{ifname:this.win.ifname}}},prepareWebAPISetData:function(){var e=this.getForm();return{enable:e.findField("enable").getValue(),ifname:this.win.ifname,identity:e.findField("identity").getValue(),anonymous_identity:e.findField("anonymous_identity").getValue(),password:e.findField("password").getValue(),key_password:e.findField("key_password").getValue(),eap:e.findField("eap").getValue(),phase2:e.findField("phase2").getValue()}},getConfig:function(e){var t=SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix("SYNO.Core.Network.Authentication"),i={};return i.enable=e[t+"enable"],i.identity=e[t+"identity"],i.anonymous_identity=e[t+"anonymous_identity"],i.password=e[t+"password"],i.key_password=e[t+"key_password"],i.eap=e[t+"eap"],i.phase2=e[t+"phase2"],i.auth_status=this.transferStatus(e[t+"status"]),this.updateField(this.field_ca_cert,"ca_cert",e[t+"ca_cert_update_time"]),this.updateField(this.field_user_cert,"user_cert",e[t+"user_cert_update_time"]),this.updateField(this.field_key,"key",e[t+"key_update_time"]),i},disableGroup:function(){for(var e=["phase2","identity","password","user_cert","key","key_password","ca_cert","anonymous_identity"],t=0;t<e.length;t++){var i=this.getForm().findField(e[t]);i&&(i.disable(),i.getEl()&&i.getEl().down("a")&&i.getEl().down("a").set({tabIndex:-1}))}this.testConBtnId.setDisabled(!0)},setGroup:function(e){var t=[];switch(this.hideAll(),e){case"auto":t=["identity","password"];break;case"peap":case"ttls":t=["phase2","identity","password","ca_cert","anonymous_identity"],""===this.getForm().findField("phase2").getValue()&&this.getForm().findField("phase2").setValue("mschapv2");break;case"tls":t=["identity","user_cert","key","key_password","ca_cert"];break;case"fast":t=["identity","password","anonymous_identity"]}this.showGroup(t),this.testConBtnId.setDisabled(!1),this.doLayout()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},showGroup:function(e){if(!this.isArray(e))return!1;for(var t,i=0;i<e.length;i++)(t=this.getForm().findField(e[i]))&&(t.show(),t.enable(),t.getEl()&&t.getEl().down("a")&&t.getEl().down("a").set({tabIndex:0}))},hideGroup:function(e){if(!this.isArray(e))return!1;for(var t,i=0;i<e.length;i++)(t=this.getForm().findField(e[i]))&&(t.hide(),t.disable())},hideAll:function(){this.hideGroup(["phase2","identity","password","user_cert","key","key_password","ca_cert","anonymous_identity"]),this.testConBtnId.setDisabled(!0)},testBtn:function(){var e=this.prepareWebAPISetData();this.parentPanel.win.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Network.Authentication",version:1,method:"test",encryption:["password","key_password"],params:e,scope:this,callback:function(e,t,i){this.parentPanel.win.clearStatusBusy(),e?this.getForm().findField("auth_status").setValue(this.transferStatus(t)):this.parentPanel.win.setStatusError({text:SYNO.API.getErrorString(t.code),clear:!0})}})},updateField:function(e,t,i){var s=t+"_update_time",n=Ext.id();void 0!==i&&i.length>0?(this[s]=i,e.setValue(_T("network","auth_import_notify").replace("{0}",i)+' (<a class="link-font" style="cursor: pointer;" id="'+n+'">'+_T("common","remove")+"</a>)")):(this[s]="",e.setValue('<a class="link-font" style="cursor: pointer;" id="'+n+'">'+_T("network","auth_import_file")+"</a>")),Ext.get(n).addListener("click",(function(){this.onClickUploadOrDelete(t)}),this),Ext.get(n).addKeyListener(Ext.EventObject.ENTER,(function(){this.onClickUploadOrDelete(t)}),this),e.originalValue=e.getValue()},onClickUploadOrDelete:function(e){var t;("ca_cert"===e?t=this.ca_cert_update_time:"user_cert"===e?t=this.user_cert_update_time:"key"===e&&(t=this.key_update_time),void 0!==t&&t.length>0)?(this.parentPanel.win.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.Network.Authentication.Cert",version:1,method:"delete",params:{ifname:this.win.ifname,upload_type:e},scope:this,callback:function(t,i,s){this.parentPanel.win.clearStatusBusy(),t?"ca_cert"===e?this.updateField(this.field_ca_cert,e):"user_cert"===e?this.updateField(this.field_user_cert,e):"key"===e&&this.updateField(this.field_key,e):this.parentPanel.win.setStatusError({text:SYNO.API.getErrorString(i.code),clear:!0})}})):new SYNO.SDS.AdminCenter.Network.AuthTab.UploadWin({owner:this.findWindow(),ifname:this.win.ifname,parentPanel:this,uploadType:e}).open()}}),Ext.define("SYNO.SDS.AdminCenter.Network.AuthTab.UploadWin",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.ifname=e.ifname,this.parentPanel=e.parentPanel,this.uploadType=e.uploadType,this.callParent([this.fillConfig(e)])},fillConfig:function(e){this.uploadForm=new SYNO.SDS.AdminCenter.Network.AuthTab.UploadForm({owner:this,ifname:this.ifname,uploadType:this.uploadType});var t={title:_T("network","auth_import_file"),resizable:!1,width:550,height:160,buttons:[{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.onCancel},{xtype:"syno_button",text:_T("common","apply"),btnStyle:"blue",scope:this,handler:this.uploadCert}],items:[this.uploadForm]};return Ext.apply(t,e),t},uploadCert:function(){this.uploadForm.uploadCert()},onCancel:function(){this.close()},updateTime:function(){this.sendWebAPI({api:"SYNO.Core.Network.Authentication",version:1,method:"get",params:{ifname:this.ifname},scope:this,callback:function(e,t,i){"ca_cert"===this.uploadType?this.parentPanel.updateField(this.parentPanel.field_ca_cert,this.uploadType,t[this.uploadType+"_update_time"]):"user_cert"===this.uploadType?this.parentPanel.updateField(this.parentPanel.field_user_cert,this.uploadType,t[this.uploadType+"_update_time"]):"key"===this.uploadType&&this.parentPanel.updateField(this.parentPanel.field_key,this.uploadType,t[this.uploadType+"_update_time"])}})}}),Ext.define("SYNO.SDS.AdminCenter.Network.AuthTab.UploadForm",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(e){this.owner=e.owner,this.ifname=e.ifname,this.uploadType=e.uploadType,this.callParent([this.fillConfig(e)]),this.setGroup(this.uploadType)},fillConfig:function(e){var t={fileUpload:!0,trackResetOnLoad:!0,frame:!1,border:!1,items:[{xtype:"syno_textfield",hidden:!0,name:"ifname",value:this.ifname},{xtype:"syno_textfield",hidden:!0,name:"upload_type",value:this.uploadType},{xtype:"syno_filebutton",fieldLabel:_T("network","auth_ca_cert"),name:"ca_cert"},{xtype:"syno_filebutton",fieldLabel:_T("network","auth_user_cert"),name:"user_cert"},{xtype:"syno_filebutton",fieldLabel:_T("network","auth_private_key"),name:"key"},{xtype:"syno_filebutton",fieldLabel:_T("network","auth_pac"),name:"pac"}],webapi:{api:"SYNO.Core.Network.Authentication.Cert",method:"upload",version:1}};return Ext.apply(t,e),t},onApiSuccess:function(){this.owner.clearStatusBusy(),this.owner.updateTime(),this.owner.close()},onApiFailure:function(e,t){this.owner.clearStatusBusy();var i=SYNO.API.getErrorString(t.code);this.owner.setStatusError({text:i,clear:!0})},uploadCert:function(){this.getForm().isDirty()?(this.owner.setStatusBusy(),this.upload()):this.owner.setStatusError({text:_T("error","error_nochoosefile"),clear:!0})},setGroup:function(e){var t=this.getForm();this.hideAll(),t.findField(e).show(),t.findField(e).enable()},hideAll:function(){for(var e,t=["ca_cert","user_cert","key","pac"],i=0;i<t.length;i++)(e=this.getForm().findField(t[i]))&&(e.hide(),e.disable())}}),Ext.define("SYNO.SDS.AdminCenter.Network.OobTab",{extend:"SYNO.ux.FormPanel",id:"oobTabId",hostConfig:null,forceSetDirty:!1,constructor:function(e){this.callParent([this.fillConfig(e)])},initEvents:function(){this.callParent(arguments),this.mon(this,"afterlayout",(function(){SYNO.ux.AddTip(this.getForm().findField("oob_shell_enable").getEl(),_T("oob","oob_enable_tip"))}),this,{single:!0})},fillConfig:function(e){return Ext.apply({title:_T("oob","oob_tab_label"),cls:"syno-network-oobtab-cls",trackResetOnLoad:!0,items:[{xtype:"syno_displayfield",htmlEncode:!1,value:_T("oob","oob_desc")+' <a id="'+(this.LearnMoreStrId=Ext.id())+'" class="link-font" tabindex="0" role="link" style="cursor:pointer">'+_T("common","learn_more")+"</a>",listeners:{afterrender:function(e){this.mon(Ext.get(this.LearnMoreStrId),"click",(function(){SYNO.SDS.AppLaunch("SYNO.SDS.HelpBrowser.Application",{topic:"SYNO.SDS.AdminCenter.Application:AdminCenter/connection_network_oob_management.html"},!1)}))},scope:this}},{xtype:"syno_checkbox",name:"oob_shell_enable",boxLabel:_T("oob","oob_enable_checkbox_desc"),id:this.oobShellEnableCheckBoxId=Ext.id(),scope:this,handler:this.onShellEnableChangeHandler},{xtype:"syno_compositefield",name:"oob_username_comp",indent:1,items:[{xtype:"syno_displayfield",fieldLabel:_T("oob","oob_account"),name:"oob_username",value:"-"},{xtype:"syno_button",name:"oob_username_edit_button",text:_T("oob","oob_edit"),id:this.btnUsernameEdit=Ext.id(),hidden:!0,scope:this,handler:this.onClickEditHandler}]},{xtype:"syno_displayfield",name:"oob_network_settings_subtitle",indent:1,cls:"syno-oobtab-inline-block-title",hideLabel:!0,value:_T("oob","oob_network_settings_subtitle")},{xtype:"syno_displayfield",name:"oob_network_settings_desc",indent:1,value:_T("oob","oob_network_settings_desc")},{xtype:"syno_displayfield",fieldLabel:_T("tcpip","tcpip_ipaddr"),name:"oob_ipv4",indent:1},{xtype:"syno_numberfield",indent:1,name:"oob_port",vtype:"port",maxlength:5,maxValue:65535,minValue:1,fieldLabel:_T("oob","oob_port")},{xtype:"syno_displayfield",name:"oob_autoblock_subtitle",indent:1,cls:"syno-oobtab-inline-block-title",hideLabel:!0,value:_T("oob","oob_autoblock_subtitle")},{xtype:"syno_displayfield",name:"oob_autoblock_desc",indent:1,value:_T("oob","oob_autoblock_desc")},{xtype:"syno_button",indent:1,text:_T("oob","oob_autoblock_clear_button_label"),id:this.oobAutoblockClearButtonId=Ext.id(),scope:this,handler:this.onClickClearBlockIp},{cls:"syno-oobtab-inline-fieldset",xtype:"syno_fieldset",itemId:"reset_title",title:_T("oob","oob_reset_title"),items:[{xtype:"syno_displayfield",value:_T("oob","oob_reset_desc")},{xtype:"syno_button",text:_T("oob","oob_reset_button_label"),scope:this,handler:this.onClickReset}]}]},e)},fillContent:function(e){var t=this.getConfig(e,SYNO.SDS.AdminCenter.Network.Utils.apiToPrefix(this.getWebAPIName()));this.hostConfig=t,this.getForm().setValues(t),this.setGroup(),this.forceSetDirty=!1},isDirty:function(){return this.getForm().isDirty()||this.forceSetDirty},isValid:function(){return this.getForm().isValid()},getWebAPISetData:function(){var e=this.getPanelConfig(),t=[{api:this.getWebAPIName(),version:1,method:"set",params:Ext.apply({},e)}];return this.forceSetDirty=!1,t},getPanelConfig:function(){var e=this.getForm(),t={};return t.oob_port=e.findField("oob_port").getValue(),t.oob_shell_enable=e.findField("oob_shell_enable").getValue(),t.oob_username=e.findField("oob_username").getValue(),t.oob_ifname=this.win.ifname,t},getWebAPIGetData:function(){return[{api:this.getWebAPIName(),version:1,method:"get",params:{}}]},setGroup:function(){var e=this.getForm();this.oobEnableCheckGroup=new SYNO.ux.Utils.EnableCheckGroup(e,"oob_shell_enable",["oob_username_comp","oob_network_settings_subtitle","oob_network_settings_desc","oob_ipv4","oob_port",this.oobAutoblockClearButtonId,"oob_autoblock_subtitle","oob_autoblock_desc"])},getConfig:function(e,t){var i={},s=this.getDefaultConfig();return i.oob_dhcp=e[t+"oob_dhcp"],i.oob_ifname=e[t+"oob_ifname"],i.oob_ipv4=e[t+"oob_ipv4"],i.oob_port=e[t+"oob_port"],i.oob_shell_enable=e[t+"oob_shell_enable"],i.oob_username=e[t+"oob_username"],i.oob_config_sts="fetched","boolean"==typeof i.oob_dhcp&&"string"==typeof i.oob_ifname&&"string"==typeof i.oob_ipv4&&"number"==typeof i.oob_port&&"boolean"==typeof i.oob_shell_enable&&"string"==typeof i.oob_username&&i.oob_ifname===this.win.ifname?i:s},getDefaultConfig:function(){return{oob_dhcp:!1,oob_ifname:this.win.ifname,oob_ipv4:"",oob_port:0,oob_shell_enable:!1,oob_username:"",oob_config_sts:"default"}},getWebAPIName:function(){return"SYNO.Core.Hardware.OOBManagement"},onClickEditHandler:function(e,t){var i=new SYNO.SDS.Utils.CheckStrongPassword,s=new SYNO.SDS.AdminCenter.Network.SetupOOBAccountDialog({title:e?_T("oob","oob_edit_account_title"):_T("oob","oob_setup_account_title"),owner:this.parentPanel.win,ownerPanel:this,hostConfig:this.hostConfig,passwordChecker:i});this.sendWebAPI({api:"SYNO.Core.User.PasswordPolicy",version:1,method:"get",scope:this,callback:function(e,t,n){e?(this.applyPasswordPolicy(i,t.strong_password),s.open()):SYNO.Debug("failed to get policy")}})},applyPasswordPolicy:function(e,t){Object.keys(t).length>0?(t.strong_password_enable=!0,e.passwordPolicy=Ext.apply({},t)):(t.strong_password_enable=!1,e.passwordPolicy=Ext.apply({},t))},onShellEnableChangeHandler:function(e,t){!0===t?!1===this.hostConfig.oob_shell_enable&&""===this.hostConfig.oob_username?this.onClickEditHandler():(this.getForm().findField("oob_username").enable(),Ext.getCmp(this.btnUsernameEdit).show()):(this.getForm().findField("oob_username").disable(),Ext.getCmp(this.btnUsernameEdit).hide())},showMsgBox:function(e,t,i,s,n){this.gMsgBox&&!this.gMsgBox.isDestroyed||(this.gMsgBox=new SYNO.SDS.MessageBoxV5({owner:this.parentPanel.win,draggable:!1})),this.gMsgBox.confirmDelete(e,t,n,this,{yes:{text:i,btnStyle:s},no:{text:_T("oob","oob_cancel")}},{useMessageTitle:!0})},onClickClearBlockIp:function(e,t){new SYNO.SDS.AdminCenter.Network.OobAutoBlock.Window({owner:this.parentPanel.win,ifname:this.win.ifname}).show()},onClickReset:function(e,t){this.showMsgBox(_T("oob","oob_reset_operation"),_T("oob","oob_reset_operation_desc"),_T("oob","oob_confirm_reset"),"red",(function(e){"yes"===e&&SYNO.SDS.Utils.PasswordConfirmDialog.openDialog(this.parentPanel.win,this.confirmedResetClbk)}))},confirmedResetClbk:function(){this.setStatusBusy({text:_T("common","applying"),clear:!1}),this.sendWebAPI({api:this.tabpanel.oobPanel.getWebAPIName(),method:"exec",version:1,params:{oob_ifname:this.ifname,command:"oob.reset"},scope:this.tabpanel.oobPanel,callback:function(e,t,i){this.onResetComplete()}})},onResetComplete:function(){this.sendWebAPI({api:this.getWebAPIName(),method:"get",version:1,params:{},scope:this,callback:function(e,t,i){this.hostConfig=this.getConfig(t,""),this.getForm().setValues(this.hostConfig),this.parentPanel.win.clearStatusBusy()}})},updateOobEnable:function(e){!0===e?Ext.getCmp(this.oobShellEnableCheckBoxId).enable():(Ext.getCmp(this.oobShellEnableCheckBoxId).setValue(!1),Ext.getCmp(this.oobShellEnableCheckBoxId).disable(),this.forceSetDirty=!0)}}),Ext.ns("SYNO.SDS.AdminCenter.Share"),Ext.define("SYNO.SDS.AdminCenter.Share.ConfirmDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){var t=this.fillConfig(e);this.callParent([t]),this.callback=e.callback},fillConfig:function(e){var t={cls:"x-window-dlg",padding:"24px 30px 0 30px",closable:!1,width:640,resizable:!1,draggable:!1,layout:"fit",elements:"body",autoHeight:!0,fbar:["->",{xtype:"syno_button",itemId:"cancel",text:_T("common","cancel"),scope:this,handler:this.onClickCancel},{xtype:"syno_button",text:_T("common","continue"),itemId:"continue",btnStyle:"red",disabled:!0,scope:this,handler:this.onClickContinue}],items:[{xtype:"syno_formpanel",itemId:"confirmFormPanel",padding:"0px",autoHeight:!0,items:[{xtype:"syno_displayfield",name:"message",htmlEncode:!1,value:e.confirm_message},{xtype:"syno_checkbox",boxLabel:e.checkbox_message,htmlEncode:!1,name:"confirm",listeners:{check:{scope:this,fn:this.onCheckboxCheck}}}]}]};return Ext.apply(t,e),t},onCheckboxCheck:function(e,t){this.getFooterToolbar().getComponent("continue").setDisabled(!t)},onClickCancel:function(){this.callback&&this.callback("cancel"),this.close()},onClickContinue:function(){this.callback&&this.callback("continue"),this.close()}}),Ext.namespace("SYNO.SDS.AdminCenter.FileService.AFP"),Ext.define("SYNO.SDS.AdminCenter.FileService.AFP.AdvancedSettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.panel=this.configForm();var t=Ext.apply({title:_T("common","adv_setting"),autoDestroy:!0,width:450,height:200,layout:"fit",border:!1,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.close},{btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","save"),scope:this,handler:this.apply}]},e);this.callParent([t]),this.mon(this,"show",this.load,this)},load:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({api:"SYNO.Core.FileServ.AFP",method:"get",version:1,scope:this,callback:function(e,t,i){this.clearStatusBusy(),e&&this.panel.getForm().setValues(t)}})},configForm:function(){var e={border:!1,trackResetOnLoad:!0,height:75,width:250,labelWidth:250,items:[{xtype:"syno_checkbox",name:"enable_umask",itemId:"enable_umask",boxLabel:_T("common","apply_default_umask")},{xtype:"syno_checkbox",name:"enable_afp",hidden:!0}]};return _S("version")>=5545&&e.items.push({xtype:"syno_checkbox",name:"enable_disconnect_quick",itemId:"enable_disconnect_quick",boxLabel:_T("network","apple_quick_disconnect")}),SYNO.LayoutConfig.fill(e),new SYNO.SDS.Utils.FormPanel(e)},apply:function(){var e=this.panel.getForm(),t=e.getValues();return e.isValid()?e.isDirty()?(!0===t.enable_afp?this.confirmSubmit(t):this.submit(t),!0):(this.close(),!1):(this.setStatusError({text:_T("common","forminvalid"),clear:!0}),!1)},confirmSubmit:function(e){this.getMsgBox().confirm(_T("tree","leaf_winmacnfs"),_T("network","service_restart_warning")+" "+_T("common","ask_cont"),(function(t,i,s){"yes"==t&&this.submit(e)}),this)},submit:function(e){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.FileServ.AFP",method:"set",version:1,scope:this,params:e,callback:function(e,t,i){if(this.clearStatusBusy(),e)return this.close(),!0;this.setStatusError()}})}}),Ext.ns("SYNO.SDS.AdminCenter.FileService.Util"),SYNO.SDS.AdminCenter.FileService.Util.getFailRespCompoundParam=function(e,t){if(!1===t.has_fail)return null;if(!(t.result instanceof Array))return null;for(var i=0;i<t.result.length;i++){var s=t.result[i];if(e==s.api&&!1===s.success)return s.error}return null},Ext.namespace("SYNO.SDS.AdminCenter.FileService.Bonjour"),Ext.define("SYNO.SDS.AdminCenter.FileService.Bonjour.TimeMachineDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.panel=this.createShareGridPanel();var t=Ext.apply({title:_T("network","network_time_machine"),autoDestroy:!0,width:450,autoHeight:!0,layout:"fit",border:!1,items:[this.panel],buttons:[{btnStyle:"grey",text:_T("common","cancel"),scope:this,handler:this.close},{btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","save"),scope:this,handler:this.apply}]},e);this.callParent([t]),this.mon(this,"show",this.load,this)},load:function(){this.setStatusBusy({text:_T("common","loading")}),this.sendWebAPI({scope:this,params:{},compound:{stopwhenerror:!1,params:[{api:"SYNO.Core.Share",method:"list",version:1,params:{additional:["is_service_share","is_force_readonly"],shareType:["dec","local","usb","sata","cluster","c2"]}},{api:"SYNO.Core.FileServ.ServiceDiscovery",method:"get",version:1}]},callback:function(e,t,i){this.clearStatusBusy(),e&&this.afterLoad(t)}})},afterLoad:function(e){var t=[],i=[],s={api:"SYNO.Core.Share",method:"list",version:1},n={api:"SYNO.Core.FileServ.ServiceDiscovery",method:"get",version:1};Ext.each(e.result,(function(e,o){!0===SYNO.ux.Utils.checkApiConsistency(s,e)?t=e.data.shares:!0===SYNO.ux.Utils.checkApiConsistency(n,e)&&(i=e.data.time_machine_shares)}),this),this.loadShareToStore(t,i)},apply:function(){var e,t=[];return this.panel.store.each((function(e){e.data.enabled&&t.push(e.data.name)})),e={time_machine_shares:t},this.submit(e),!0},submit:function(e){this.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.FileServ.ServiceDiscovery",method:"set",version:1,scope:this,params:e,callback:function(e,t,i){if(this.clearStatusBusy(),e)return this.close(),!0;this.setStatusError()}})},createShareColumns:function(){return[new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enabled",menuDisabled:!0,sortable:!0,width:50,align:"center",tooltip:_T("common","enabled")}),{header:_T("helptoc","share"),dataIndex:"name",width:100,scope:this}]},createShareGridPanel:function(){var e=this.createShareColumns(),t=e[0],i=new Ext.data.JsonStore({idProperty:"name",root:"shares",fields:["enabled","name"],totalProperty:"total"});return new SYNO.ux.GridPanel({border:!1,enableHdMenu:!1,autoScroll:!0,height:425,width:250,plugins:[t],columns:e,store:i})},loadShareToStore:function(e,t){var i={shares:[],total:0};Ext.each(e,(function(e,s){!0!==e.is_force_readonly&&!1===e.is_service_share&&(0>t.indexOf(e.name)?e.enabled=!1:e.enabled=!0,i.shares.push(e),i.total+=1)}),this),this.panel.store.loadData(i,!1)}}),Ext.namespace("SYNO.SDS.AdminCenter.HardwareControl"),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.LedBrightnessScheduleDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.module=e.module,this.owner=e.owner;var t={resizable:!1,title:_T("led_brightness","set_schedule"),items:[this.dialogPanel=this.createPanel()],width:680,height:400,buttons:[{text:_T("common","alt_cancel"),scope:this,btnStyle:"gray",handler:this.close},{text:_T("common","alt_apply"),itemId:"apply",scope:this,btnStyle:"blue",handler:this.onApply}]};Ext.apply(t,e),this.callParent([t])},createPanel:function(){return new Ext.form.FormPanel({trackResetOnLoad:!0,border:!1,items:[{xtype:"syno_displayfield",value:_T("led_brightness","schedule_tip_desc")},this.ledSchedule=new SYNO.ux.ScheduleTable({name:"schedule_table",buttons:[{label:_T("led_brightness","schedule_led_default")},{label:_T("led_brightness","schedule_led_adjust")},{label:_T("led_brightness","slider_led_off")}]})]})},onOpen:function(){this.callParent()},onApply:function(){this.isApply=!0,this.close()},getSchedule:function(){return this.ledSchedule.getSchedule()},setSchedule:function(e){this.ledSchedule.setSchedule(e)}}),Ext.define("SYNO.SDS.AdminCenter.HardwareControl.GeneralSettingForm.VideoTranscodingForm",{extend:"SYNO.ux.FieldSet",formType:"video_transcoding",webapi:{api:"SYNO.Core.Hardware.VideoTranscoding",methods:{get:"get",set:"set"},version:1},constructor:function(e){this.enableOnUI=null,this.confirmSetEnable=!1;var t=Ext.apply({labelWidth:250,title:_T("memory_layout","video_transcoding"),items:this.getItemList()},e);SYNO.LayoutConfig.fill(t),this.callParent([t])},getItemList:function(){var e=[];return e.push({xtype:"syno_displayfield",value:_T("memory_layout","desc_for_rtd1296")}),e.push({xtype:"syno_checkbox",name:"enable_video_transcoding",boxLabel:_T("memory_layout","enable_video_transcoding")}),e},onBeforeRequest:function(e){if(this.webapi.methods.set!==e)return!0;var t=this.parent.getForm().findField("enable_video_transcoding");return!(!this.confirmSetEnable&&this.enableOnUI!=t.getValue())||(SYNO.Debug("enable_video_transcoding changed"),this.module.appWin.getMsgBox().confirm(this.title,_T("memory_layout","video_transcoding_confirm"),(function(e){"yes"===e?(this.confirmSetEnable=!0,this.module.panel.applyAllForm(),this.confirmSetEnable=!1):t.setValue(this.enableOnUI)}),this),!1)},processReturnData:function(e,t,i){for(var s={api:this.webapi.api,method:this.webapi.methods.get,version:this.webapi.version},n=0;n<t.result.length;n++)if(!1!==SYNO.ux.Utils.checkApiConsistency(s,t.result[n])){if(!1===t.result[n].success||!t.result[n].data)return void this.module.appWin.getMsgBox().alert(_T("memory_layout","video_transcoding"),_T("memory_layout","enable_video_transcoding")+": "+SYNO.API.getErrorString(t.result[n].error.code));break}var o=t.result[n].data.enable_video_transcoding;null!==this.enableOnUI&&this.enableOnUI!==o&&(SYNO.Debug("setting changed. Need to restart"),SYNO.SDS.System.RebootWithMsg()),this.enableOnUI=o}}),Ext.namespace("SYNO.SDS.App.SynologyAccountNotify"),SYNO.SDS.App.SynologyAccountNotify.Instance=Ext.extend(SYNO.SDS.AppInstance,{onOpen:function(e){this.sendWebAPI({api:"SYNO.Core.MyDSCenter",version:2,method:"query",params:{},scope:this,callback:function(e,t,i){e&&t.is_logged_in&&!t.activated&&SYNO.SDS.SystemTray.notifyMsg(_T("myds","myds_account"),_T("myds","myds_account"),String.format(_T("myds","not_activated_desc"),'<a target="_blank" href="https://account.synology.com">',"</a>"),0,!1)}})}}),Ext.define("SYNO.SDS.AdminCenter.User.UserInviteDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(e){this.owner=e.owner,this.ori_name=e.ori_name;var t=this.createPanel();this.panelForm=t.getForm();var i={title:_T("user","resend_invitation_mail"),width:600,height:270,resizable:!1,layout:"fit",buttons:[{text:_T("common","cancel"),handler:this.close,scope:this},{text:_T("common","send"),btnStyle:"blue",handler:this.onApply,scope:this}],items:[t]};Ext.apply(i,e),this.callParent([i])},createPanel:function(){for(var e=[],t=0;t<24;++t)e.push([t+1,String.leftPad(String(t+1),2,"0")]);var i=new Ext.data.ArrayStore({fields:["value","display"],data:e}),s={labelWidth:170,padding:0,cls:"change-passwd-panel",items:[{xtype:"syno_displayfield",hideLabel:!0,value:_T("user","password_reset_link_expire_description")},{xtype:"syno_compositefield",name:"password_reset_link_expire",fieldLabel:_T("user","valid_duration"),style:"margin-bottom: 25px;",items:[{xtype:"syno_combobox",name:"email_expire_hour",store:i,displayField:"display",valueField:"value",value:e[e.length-1][0],width:90},{xtype:"syno_displayfield",name:"hour_time_description",value:_T("common","time_hours"),width:50}]},{xtype:"syno_displayfield",hideLabel:!0,style:"margin-top: 35px;",htmlEncode:!1,value:`<span class="syno-ux-note">${_T("common","note")+_T("common","colon")}</span>${_T("user","previous_password_reset_link_invalid_description")}`}]};return new SYNO.SDS.Utils.FormPanel(s)},onApply:function(){var e=this;e.setStatusBusy(),this.sendWebAPI({api:"SYNO.Core.User",method:"invite",version:1,params:{name:e.ori_name,expire_hour:this.panelForm.findField("email_expire_hour").getValue()},callback:function(t,i){e.clearStatusBusy(),t?(e.owner.getToastBox(_T("user","invitation_mail_sent_notification")),e.close()):e.getMsgBox().alert(e.title,SYNO.API.getErrorString(i))}})}});
